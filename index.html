<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Garden Focus üå±</title>
    
    
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#4caf50">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="https://www.iconpacks.net/icons/2/free-tree-icon-1578-thumb.png">


<style>
    /* =========================================
   MODAIS BRASILEIROS CUSTOMIZADOS (NOVO)
   ========================================= */
#statusCoop {
    position: fixed;
    top: 15px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(255, 255, 255, 0.95);
    padding: 8px 15px;
    border-radius: 50px;
    display: none;
    align-items: center;
    gap: 10px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    z-index: 99999;
    border: 2px solid #4CAF50;
    font-family: 'Segoe UI', sans-serif;
    font-size: 14px;
    font-weight: 600;
    color: #333;
    backdrop-filter: blur(5px);
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from { transform: translate(-50%, -50px); opacity: 0; }
    to { transform: translate(-50%, 0); opacity: 1; }
}

#statusCoop .indicador {
    width: 10px;
    height: 10px;
    background: #4CAF50;
    border-radius: 50%;
    box-shadow: 0 0 8px #4CAF50;
}

#statusCoop .btn-desconectar {
    background: #ff4757;
    color: white;
    border: none;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 11px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.2s;
}

#statusCoop .btn-desconectar:hover {
    background: #ff2e43;
    transform: scale(1.05);
}

#custom-modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.85); /* Fundo bem escuro para foco */
    z-index: 1000000; /* Acima de tudo */
    display: none; align-items: center; justify-content: center;
    backdrop-filter: blur(5px);
    opacity: 0; transition: opacity 0.3s ease;
}

.custom-modal-box {
    background: var(--bg-card, #ffffff);
    padding: 30px; 
    border-radius: 25px;
    width: 85%; max-width: 380px;
    text-align: center;
    box-shadow: 0 20px 60px rgba(0,0,0,0.6);
    border: 4px solid var(--primary-color, #4CAF50);
    transform: translateY(20px) scale(0.9); 
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    font-family: 'Segoe UI', sans-serif;
    position: relative;
    overflow: hidden;
}

/* Efeito de brilho no topo */
.custom-modal-box::before {
    content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 6px;
    background: rgba(255,255,255,0.5);
}

.custom-modal-icon {
    font-size: 50px; margin-bottom: 15px; display: block;
    animation: bounceIn 0.6s;
}

.custom-modal-title { 
    font-size: 1.6em; font-weight: 800; margin-bottom: 12px; 
    color: var(--primary-color, #4CAF50); text-transform: uppercase; letter-spacing: 0.5px;
}

.custom-modal-msg { 
    font-size: 1.1em; margin-bottom: 25px; color: var(--text-color, #444); 
    line-height: 1.5; font-weight: 500;
}

.custom-modal-actions { 
    display: flex; gap: 12px; justify-content: center; 
}

.custom-modal-btn {
    flex: 1; padding: 14px; border: none; border-radius: 50px;
    font-weight: bold; cursor: pointer; font-size: 1em;
    transition: transform 0.2s, filter 0.2s;
    text-transform: uppercase;
    box-shadow: 0 4px 0 rgba(0,0,0,0.1);
}
.custom-modal-btn:active { transform: translateY(2px); box-shadow: none; }

/* Bot√µes Espec√≠ficos */
.btn-modal-confirm { background: var(--primary-color, #4CAF50); color: white; }
.btn-modal-cancel { background: #e0e0e0; color: #555; }
.btn-modal-danger { background: #ff4757; color: white; border: 2px solid #ff2e43; }

/* --- ADAPTA√á√ÉO AOS TEMAS DO JOGO --- */

/* MODO ESCURO */
body.dark-mode .custom-modal-box { 
    background: #2d2d2d; border-color: #66bb6a; color: white; 
}
body.dark-mode .custom-modal-msg { color: #ddd; }
body.dark-mode .btn-modal-cancel { background: #555; color: #fff; }

/* MODO MEDIEVAL */
body.medieval-mode .custom-modal-box { 
    background: #f4e4bc; border: 6px double #8b4513; border-radius: 5px;
    font-family: 'Georgia', serif; 
    box-shadow: 0 20px 50px rgba(0,0,0,0.8);
}
body.medieval-mode .custom-modal-title { color: #5d4037; }

/* MODO CANDYFORNIA */
body.candyfornia-mode .custom-modal-box {
    background: #fff0f5; border: 4px dashed #ff85a2; border-radius: 35px;
}
body.candyfornia-mode .custom-modal-title { color: #ff6bad; }
body.candyfornia-mode .btn-modal-confirm { background: #ff85a2; }

@keyframes bounceIn {
    0% { transform: scale(0); } 50% { transform: scale(1.2); } 100% { transform: scale(1); }
}

    /* Estilo para a Mochila no Menu de Romance */
.romance-backpack {
    background: rgba(255, 255, 255, 0.9);
    border: 2px solid #ffd700;
    border-radius: 12px;
    padding: 5px 10px;
    position: absolute;
    top: 10px;
    left: 10px;
    font-size: 14px;
    font-weight: bold;
    color: #555;
    display: flex;
    align-items: center;
    gap: 5px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

/* Bot√£o Especial de Pedido de Namoro */
.btn-namoro {
    background: linear-gradient(45deg, #d63384, #ff4757) !important;
    color: #ffffff !important;
    border: 2px solid #fff !important;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    font-weight: 900 !important;
    animation: pulse 2s infinite;
     }

@keyframes pulse {
    0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.7); }
    70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(255, 71, 87, 0); }
    100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 71, 87, 0); }
}

    body {
  font-family: 'Noto Color Emoji', sans-serif;
  overflow-x: hidden;
  overflow-y: auto; /* Permitir rolagem global */
  min-height: 100vh;
  width: 100vw;
  margin: 0;
  padding: 0;
}

    /* =========================
   SISTEMA DE ROMANCE
   ========================= */
/* =========================
   ATUALIZA√á√ÉO: SISTEMA DE ROMANCE
   ========================= */

.romance-card {
    background: linear-gradient(135deg, #fff, #f0f8ff);
    border: 3px solid #ff9ebb;
    border-radius:  50px !important;
    padding: 25px;
    width: 90%;
    max-width: 400px; /* Aumentado levemente */
    text-align: center;
    box-shadow: 0 15px 50px rgba(255, 158, 187, 0.4);
    position: relative;
    font-family: 'Segoe UI', sans-serif;
    display: flex;
    flex-direction: column;
    gap: 10px;
    max-height: 85vh; /* Garante que cabe na tela */
    overflow-y: auto; /* Permite rolagem se o texto for muito grande em telas pequenas */
}

/* NOVO: Caixa de Di√°logo */
.romance-dialogue-box {
    background: rgba(255, 255, 255, 0.8);
    border: 2px dashed #4cc9f0; /* Azul tema marinho */
    border-radius: 15px;
    padding: 15px;
    margin: 5px 0 15px 0;
    min-height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-style: italic;
    color: #003566;
    font-size: 14px;
    line-height: 1.4;
    box-shadow: inset 0 0 15px rgba(76, 201, 240, 0.1);
    position: relative;
}

.romance-dialogue-box::after {
    content: '';
    position: absolute;
    top: -10px;
    left: 50%;
    transform: translateX(-50%);
    border-width: 0 10px 10px 10px;
    border-style: solid;
    border-color: transparent transparent #4cc9f0 transparent;
    display: block;
    width: 0;
}

/* Ajustes nos elementos existentes para ficarem compactos */
.romance-avatar {
    font-size: 60px;
    margin-bottom: 5px;
    animation: floatHeart 3s infinite ease-in-out;
    filter: drop-shadow(0 5px 5px rgba(0,0,0,0.2));
}

.romance-hearts {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin: 5px 0 10px 0;
}

/* Overlay do Menu */
#romanceOverlay {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 29, 61, 0.85);
    z-index: 20000;
    display: none;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(5px);
    animation: romanceFadeIn 0.3s ease;
}






.heart-slot {
    font-size: 24px;
    color: #e0e0e0;
    transition: all 0.3s;
}

.heart-slot.filled {
    color: #ff4757;
    transform: scale(1.1);
    filter: drop-shadow(0 0 5px rgba(255, 71, 87, 0.5));
}

.romance-actions {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
}

.btn-romance {
    background: white;
    border: 2px solid #ff9ebb;
    color: #ff4757;
    padding: 12px;
    border-radius:   50px !important;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
     }

.btn-romance:hover {
    background: #fff0f5;
    transform: translateY(-2px);
}

.btn-casar {
    grid-column: span 2;
    background: linear-gradient(135deg, #ff9ebb, #ff4757);
    color: white;
    border: none;
    margin-top: 10px;
     }

/* Bolha M√°gica (Visual do Parceiro em Terra) */
.bolha-magica {
    position: absolute;
    width: 90%; height: 90%;
    top: 0; left: 0;
    border-radius: 50%;
    background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.8), rgba(135,206,250,0.4));
    box-shadow: inset 0 0 10px rgba(255,255,255,0.8), 0 0 10px rgba(135,206,250,0.5);
    animation: bubbleFloat 4s infinite ease-in-out;
    pointer-events: none;
    z-index: 18; /* Acima do ch√£o, abaixo do pet */
}

@keyframes bubbleFloat {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-8px); }
}

@keyframes romanceFadeIn {
    from { opacity: 0; transform: scale(0.9); }
    to { opacity: 1; transform: scale(1); }
}

    .guia-escolha-popup {
    background: var(--bg-panel, #ffffff);
    border-radius: 20px;
    padding: 30px;
    max-width: 400px;
    width: 90%;
    text-align: center;
    box-shadow: 0 15px 45px rgba(0, 0, 0, 0.2);
    color: var(--text-main, #333);
}

.guia-confirma-popup {
    background: var(--bg-panel, #ffffff);
    border-radius: 20px;
    padding: 30px;
    max-width: 400px;
    width: 90%;
    text-align: center;
    box-shadow: 0 15px 45px rgba(0, 0, 0, 0.2);
    color: var(--text-main, #333);
}

.guia-confirma-popup button {
    background: var(--primary, #4CAF50);
    color: white;
    border: none;
    padding: 12px 35px;
    border-radius:     50px !important;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
}

.guia-confirma-popup button:hover {
    background: var(--accent, #FF9800);
    transform: translateY(-2px);
}
   /* Cora√ß√£o Simples e Pequeno */
.heart-simple {
    position: absolute;
    font-size: 1px; /* Tamanho pequeno fixo */
    pointer-events: none;
    z-index: 1000;
    /* Alinhamento b√°sico para o 3D */
    transform: translate(-50%, -50%) rotateZ(-45deg) rotateX(-90deg);
    animation: heartUpSimple 4s forwards linear;
}

@keyframes heartUpSimple {
    0% { 
        transform: translate(-50%, -50%) rotateZ(-45deg) rotateX(-90deg) translateY(0);
        opacity: 0; 
    }
    10% { opacity: 1; }
    100% { 
        transform: translate(-50%, -50%) rotateZ(-45deg) rotateX(-90deg) translateY(-150px);
        opacity: 0; 
    }
}

/* Toast Base - Adapta-se ao Normal e Noturno automaticamente */
.pet-toast-moderno {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--bg-card, #ffffff);
    color: var(--text-color, #333);
    padding: 15px 25px;
    border-radius: 20px;
    z-index: 1000000;
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    border: 2px solid var(--primary-color);
    min-width: 280px;
    overflow: hidden;
    animation: toastEntrada 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
}

.toast-content {
    display: flex;
    align-items: center;
    gap: 12px;
}

.toast-icon { font-size: 24px; }

.toast-text {
    display: flex;
    flex-direction: column;
    text-align: left;
}

.toast-text strong { font-size: 14px; color: var(--primary-color); }
.toast-text span { font-size: 13px; opacity: 0.9; }

/* Barrinha de Progresso */
.toast-progress {
    position: absolute;
    bottom: 0;
    left: 0;
    height: 4px;
    background: var(--primary-color);
    width: 100%;
    animation: toastBarra 6s linear forwards;
}

/* --- ADAPTA√á√ïES POR TEMA --- */

/* MODO MEDIEVAL (E Noturno Medieval) */
body.medieval-mode .pet-toast-moderno {
    border-radius: 0;
    border: 4px double var(--primary-color);
    background: #f4e4bc; /* Papel antigo */
    color: #5d4037;
    font-family: 'Georgia', serif;
}
body.dark-mode.medieval-mode .pet-toast-moderno {
    background: #3e2723;
    color: #d7ccc8;
}

/* MODO CANDYFORNIA (E Noturno Candy) */
body.candyfornia-mode .pet-toast-moderno {
    border-radius: 30px;
    border-style: dashed;
    background: #fff0f5;
    color: #ff6bad;
}
body.dark-mode.candyfornia-mode .pet-toast-moderno {
    background: #4a1e36;
    color: #ffb7d5;
}

/* Anima√ß√µes */
@keyframes toastEntrada {
    from { opacity: 0; transform: translateX(-50%) translateY(-100px); }
    to { opacity: 1; transform: translateX(-50%) translateY(0); }
}

@keyframes toastBarra {
    from { width: 100%; }
    to { width: 0%; }
}

.pet-toast-moderno.saindo {
    animation: toastSaida 0.5s forwards ease-in;
}

@keyframes toastSaida {
    to { opacity: 0; transform: translateX(-50%) translateY(-100px); }
}

  /* --- BASE DO MODAL (ESTILO NORMAL) --- */
.pet-name-popup {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: var(--bg-card, #ffffff) !important;
    padding: 25px;
    border-radius: 24px;
    box-shadow: 0 15px 50px rgba(0,0,0,0.4);
    z-index: 100000;
    text-align: center;
    width: 280px;
    border: 5px solid var(--primary-color, #4CAF50);
    color: var(--text-color, #333) !important;
    animation: popupAparecer 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

/* INPUT: Sempre vis√≠vel independente do tema */
/* O INPUT: Centraliza√ß√£o Absoluta e For√ßa de Contraste */
.pet-name-popup input#tempPetName {
    display: block !important;
    width: 90% !important;        /* Ocupa quase toda a largura interna */
    max-width: 240px !important;  /* Limite para n√£o esticar demais */
    margin: 15px auto !important; /* AUTO nas laterais centraliza o elemento */
    padding: 12px 0 !important;   /* Padding vertical apenas */
    border: 2px solid var(--primary-color, #4CAF50) !important;
    border-radius: 12px !important;
    text-align: center !important; /* Centraliza o texto digitado */
    font-size: 18px !important;
    background-color: #ffffff !important;
    color: #1a1a1a !important; 
    outline: none !important;
    box-sizing: border-box !important; /* Garante que o padding n√£o aumente a largura */
}


.pet-name-popup .btn-container {
    display: flex;
    gap: 10px;
    margin-top: 10px;
}

.pet-name-popup button {
    flex: 1;
    background-color: var(--primary-color, #4CAF50) !important;
    color: #ffffff !important;
    border: none;
    padding: 14px;
    border-radius:     50px !important;
    cursor: pointer;
    font-weight: bold;
    text-transform: uppercase;
    transition: transform 0.1s;
}

.pet-name-popup button:active { transform: scale(0.95); }
.pet-name-popup button.cancelar { background-color: #888 !important; }

/* --- VERS√ÉO MODO NOTURNO (DARK MODE) --- */
body.dark-mode .pet-toast-moderno,
body.dark-mode .pet-name-popup {
    background: #2d2d2d !important;
    color: #ffffff !important;
    box-shadow: 0 15px 50px rgba(0,0,0,0.8);
}

/* --- VERS√ÉO MEDIEVAL --- */
body.medieval-mode .pet-name-popup {
    border-radius: 0px !important;
    border: 6px double #8b4513 !important;
    background: #f4e4bc !important; /* Papel pergaminho */
    background-image: radial-gradient(#ead29d 1px, transparent 1px) !important;
    background-size: 20px 20px !important;
}
body.medieval-mode .pet-name-popup h3 {
    font-family: 'Georgia', serif;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: #5d4037 !important;
}
body.medieval-mode .pet-name-popup button {
    border-radius:     50px !important;
    background: #5d4037 !important;
    border: 1px solid #3e2723 !important;
}

/* --- VERS√ÉO CANDYFORNIA --- */
body.candyfornia-mode .pet-name-popup {
    border-radius: 40px !important;
    border: 5px dashed #ff85a2 !important;
    background: #fff0f5 !important;
}
body.candyfornia-mode .pet-name-popup h3 {
    color: #ff6bad !important;
    font-style: italic;
}
body.candyfornia-mode .pet-name-popup input#tempPetName {
    border-color: #ffb7d5 !important;
}
body.candyfornia-mode .pet-name-popup button {
    border-radius:     50px !important;
    background: #ff85a2 !important;
}

/* --- VERS√ÉO NATAL --- */
body.natal-mode .pet-name-popup {
    border: 5px solid #e74c3c !important;
    background: #ffffff !important;
    /* Adiciona uma borda interna verde */
    outline: 3px solid #27ae60 !important;
    outline-offset: -10px !important;
}
body.natal-mode .pet-name-popup h3 {
    color: #e74c3c !important;
}
body.natal-mode .pet-name-popup button {
    background: #e74c3c !important;
}
body.natal-mode .pet-name-popup button.cancelar {
    background: #27ae60 !important;
}

/* ANIMA√á√ÉO */
@keyframes popupAparecer {
    from { transform: translate(-50%, -50%) scale(0.7); opacity: 0; }
    to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
}


    .loja-secao-titulo {
    grid-column: 1 / -1; /* Ocupa a largura toda do grid */
    text-align: left;
    font-weight: bold;
    font-size: 1.2rem;
    margin: 15px 0 10px 5px;
    color: var(--primary-color);
    border-bottom: 2px solid #eee;
    padding-bottom: 5px;
}

    /* =========================
   ADICIONAR: ESTILOS DOS PETS
   ========================= */

.pet-3d {
    /* Diminu√≠do de 0.7 para 0.5 (50% do tamanho da c√©lula) */
    font-size: calc(var(--cell-3d-size) * 0.5); 
    
    pointer-events: none;
    display: block;
    user-select: none;
    position: absolute;
    left: 50%;
    top: 50%;
    
    /* O translateY controla a altura. 
       Ajustado para -0.3 para o pet menor ficar encostado no ch√£o */
    transform: translate(-50%, -50%) rotateZ(-45deg) rotateX(-90deg) translateY(calc(var(--cell-3d-size) * -0.3)) scaleY(1);
    
    z-index: 15;
    transition: all 0.5s ease;
    animation: petBounce 1s infinite alternate;
}

.pet-3d.pausado {
    animation-play-state: paused;
}

.btn-carinho-flutuante {
    position: absolute; /* Mudado para absolute para respeitar a rolagem do container pai */
    z-index: 900; /* Abaixo da aba esquerda (1000) */
    background: white;
    border: 1px solid var(--primary);
    border-radius:   50px !important;
    padding: 3px 6px;
    font-size: 9px;
    font-weight: bold;
    color: var(--primary);
    cursor: pointer;
    box-shadow: 0 3px 8px rgba(0,0,0,0.15);
    white-space: nowrap;
    pointer-events: auto;
    transform: translate(-50%, -100%);
    animation: floatBtnGlobal 2s infinite ease-in-out;
    transition: background 0.2s, color 0.2s, transform 0.2s, opacity 0.3s ease-out;
     }

.btn-carinho-flutuante.fade-out {
    opacity: 0;
    pointer-events: none;
}

.btn-carinho-flutuante:hover {
    background: var(--primary);
    color: white;
    transform: translate(-50%, -110%) scale(1.1);
}

@keyframes floatBtnGlobal {
    0%, 100% { transform: translate(-50%, -100%); }
    50% { transform: translate(-50%, -105%); }
}

/* Ajuste na anima√ß√£o para o pulo ser proporcional ao tamanho menor */
@keyframes petBounce {
    0% { 
        transform: translate(-50%, -50%) rotateZ(-45deg) rotateX(-90deg) translateY(calc(var(--cell-3d-size) * -0.3)) scaleY(1); 
    }
    100% { 
        transform: translate(-50%, -50%) rotateZ(-45deg) rotateX(-90deg) translateY(calc(var(--cell-3d-size) * -0.35)) scaleY(1.05); 
    }
}


@keyframes petBounce {
    0% { transform: rotateZ(-45deg) rotateX(-90deg) translateY(calc(var(--cell-3d-size) * -0.46)) scaleY(1); }
    100% { transform: rotateZ(-45deg) rotateX(-90deg) translateY(calc(var(--cell-3d-size) * -0.56)) scaleY(1.05); }
}

/* Ajuste para quando o pet estiver se movendo (opcional, para suavidade) */
.cell-3d.has-pet {
    cursor: not-allowed; /* Mostra que n√£o pode plantar aqui */
}

   /* =========================
   AJUSTE ‚Äì PAINEL INTELIGENTE
   CANDYFORNIA + DARK MODE
   ========================= */

body.dark-mode.candyfornia-mode #painelInteligencia {
    background: linear-gradient(
        135deg,
        rgba(90, 58, 74, 0.85),
        rgba(60, 36, 50, 0.85)
    ) !important;

    border: 1px solid rgba(255, 133, 162, 0.35) !important;
    color: #f4cbe0 !important;

    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.45);
}

/* Texto principal */
body.dark-mode.candyfornia-mode #painelInteligencia strong {
    color: #ffd6e9 !important;
}

/* Texto secund√°rio */
body.dark-mode.candyfornia-mode #painelInteligencia small {
    color: #e0a9c6 !important;
    opacity: 0.9;
}

/* Probabilidade ALTA */
body.dark-mode.candyfornia-mode #painelInteligencia .probabilidade-alta {
    color: #9be7c4 !important; /* verde menta suave */
}

/* Probabilidade M√âDIA */
body.dark-mode.candyfornia-mode #painelInteligencia .probabilidade-media {
    color: #ffd166 !important; /* amarelo pastel elegante */
}

/* Probabilidade BAIXA */
body.dark-mode.candyfornia-mode #painelInteligencia .probabilidade-baixa {
    color: #ff9aa2 !important; /* rosa coral suave */
}

/* Hover discreto (sem flash) */
body.dark-mode.candyfornia-mode #painelInteligencia:hover {
    transform: translateY(-1px);
    box-shadow: 0 8px 22px rgba(0, 0, 0, 0.55);
}

    /* Estilo do bot√£o bulldoze */
#btnBulldoze {
    background: #ff9800 !important;
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 20px;
    padding: 10px;
    cursor: pointer;
    transition: all 0.2s;
}

#btnBulldoze:hover {
    background: #f57c00 !important;
    transform: translateY(-2px);
}

#btnBulldoze:active {
    transform: translateY(0);
}

/* Anima√ß√£o do tornado 2D */
.tornado-2d {
    position: absolute;
    font-size: 30px;
    z-index: 10;
    pointer-events: none;
    animation: tornadoMove 0.5s linear forwards;
}

@keyframes tornadoMove {
    0% { transform: translateY(0) rotate(0deg); opacity: 0.5; }
    50% { transform: translateY(-20px) rotate(180deg); opacity: 1; }
    100% { transform: translateY(-40px) rotate(360deg); opacity: 0; }
}

/* Anima√ß√£o do tornado 3D */
.tornado-3d {
    position: absolute;
    font-size: calc(var(--cell-3d-size) * 0.6);
    z-index: 20;
    pointer-events: none;
    transform: rotateZ(-45deg) rotateX(-90deg) translateY(calc(var(--cell-3d-size) * -0.46)) scaleY(1);
    animation: tornadoMove3D 0.5s linear forwards;
}

@keyframes tornadoMove3D {
    0% { transform: rotateZ(-45deg) translateY(calc(var(--cell-3d-size) * -0.46)) scaleY(1) rotate(0deg); opacity: 0.5; }
    50% { transform: rotateZ(-45deg) rotateX(-90deg) translateY(calc(var(--cell-3d-size) * -0.56)) scaleY(1.2); opacity: 1; }
    100% { transform: rotateZ(-45deg) rotateX(-90deg) translateY(calc(var(--cell-3d-size) * -0.66)) scaleY(1.4); opacity: 0; }
}
    /* Estilos para Metas */
#btnMetasToggle.ativo {
    border-radius: 18px 18px 0 0;
    box-shadow: none;
    background: #ff9800 !important;
}

#metasContainer {
    background: var(--bg-panel);
    border-radius: 0 0 18px 18px;
    border: 1px solid #ff9800;
    border-top: none;
    padding: 12px;
    display: none;
    flex-direction: column;
    margin-top: -12px;
    max-height: 400px;
    overflow-y: auto;
    box-shadow: 0 10px 20px rgba(0,0,0,0.1);
}

#metasContainer.ativo {
    display: flex;
    animation: expandDown 0.3s ease-out;
}

#metaMotivo, #metaTempo {
    border-radius: 8px;
    border: 1px solid rgba(0,0,0,0.1);
    background: var(--bg-panel);
    color: var(--text-main);
    padding: 5px;
    font-size: 11px;
}
/* =========================
   VARI√ÅVEIS E TEMAS
   ========================= */
:root {
    --bg-body: #f0f7f2;
    --bg-panel: white;
    --text-main: #333;
    --text-secondary: #666;
    --primary: #4caf50;
    --accent: #ffd54f;
    --plot-empty: #daeedb;
    --shadow: rgba(0,0,0,0.05);
    /* VARI√ÅVEIS 3D */
    --grid-color: #8cc63f;
    --grid-border: #7db336;
    --side-color: #8d6e63;
    --bottom-color: #5d4037;
    --cell-3d-size: 75px;
    --scale-3d: 1; /* Nova vari√°vel para escala */
}

body.natal-mode {
    --bg-body: #fdfdfd;
    --bg-panel: #ffffff;
    --text-main: #2c3e50;
    --primary: #c62828;
    --accent: #ffd700;
    --plot-empty: #f5f5f5;
    /* 3D NATAL */
    --grid-color: #e8f5e9;
    --grid-border: #c8e6c9;
    --side-color: #d7ccc8;
    --bottom-color: #bcaaa4;
}

body.medieval-mode {
    --bg-body: #3e2723;
    --bg-panel: #5d4037;
    --text-main: #fff8e1;
    --text-secondary: #ffccbc;
    --primary: #8d6e63;
    --accent: #ffb74d;
    --plot-empty: #4e342e;
    --shadow: rgba(0,0,0,0.4);
    /* 3D MEDIEVAL */
    --grid-color: #5d4037;
    --grid-border: #4e342e;
    --side-color: #3e2723;
    --bottom-color: #2d1a1a;
    background-image: url('https://www.transparenttextures.com/patterns/wood-pattern.png');
}

body.dark-mode {
    --bg-body: #1a1d1a;
    --bg-panel: #2d322d;
    --text-main: #e0e0e0;
    --text-secondary: #aaa;
    --primary: #81c784;
    --accent: #ffd54f;
    --plot-empty: #3d453d;
    --shadow: rgba(0,0,0,0.3);
    /* 3D DARK MODE - mant√©m cores do modo claro */
    --grid-color: #8cc63f;
    --grid-border: #7db336;
    --side-color: #8d6e63;
    --bottom-color: #5d4037;
}

body.dark-mode.natal-mode {
    --bg-body: #1a0f0f;
    --bg-panel: #2d1a1a;
    --text-main: #f8f8f8;
    --primary: #e53935;
    --accent: #ffb300;
    --plot-empty: #3d2525;
    /* 3D DARK NATAL - mant√©m cores do modo claro natal */
    --grid-color: #e8f5e9;
    --grid-border: #c8e6c9;
    --side-color: #d7ccc8;
    --bottom-color: #bcaaa4;
}

body.dark-mode.medieval-mode {
    --bg-body: #1a0f0a;
    --bg-panel: #2d1a15;
    --text-main: #f8f8f8;
    --text-secondary: #ffccbc;
    --primary: #8d6e63;
    --accent: #ffb74d;
    --plot-empty: #3d2520;
    --shadow: rgba(0,0,0,0.5);
    /* 3D MEDIEVAL NOTURNO - mant√©m cores do modo medieval claro */
    --grid-color: #5d4037;
    --grid-border: #4e342e;
    --side-color: #3e2723;
    --bottom-color: #2d1a1a;
    background-image: url('https://www.transparenttextures.com/patterns/wood-pattern.png');
}

/* NOVO: Modo Candyfornia - Mundo de Doces Fofo */
body.candyfornia-mode {
    --bg-body: #fff5f7; /* Rosa muito clarinho */
    --bg-panel: #ffffff; /* Branco puro */
    --text-main: #8a4b76; /* Roxo rosado suave */
    --text-secondary: #c97aa0; /* Rosa m√©dio */
    --primary: #ff85a2; /* Rosa fofo */
    --accent: #ffd166; /* Amarelo pastel */
    --plot-empty: #ffe8f0; /* Rosa muito clarinho */
    --shadow: rgba(255, 133, 162, 0.1);
    /* 3D CANDYFORNIA */
    --grid-color: #ffccd5; /* Rosa beb√™ */
    --grid-border: #ffb3c6; /* Rosa mais forte */
    --side-color: #ffafcc; /* Rosa algod√£o doce */
    --bottom-color: #ff8fab; /* Rosa m√©dio */
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="10" cy="10" r="3" fill="%23ffafcc" opacity="0.6"/><circle cx="30" cy="25" r="4" fill="%23ffd166" opacity="0.6"/><circle cx="70" cy="15" r="3" fill="%23ff8fab" opacity="0.6"/><circle cx="85" cy="40" r="3" fill="%23ffafcc" opacity="0.6"/><circle cx="20" cy="60" r="4" fill="%23ffd166" opacity="0.6"/><circle cx="50" cy="80" r="3" fill="%23ff8fab" opacity="0.6"/></svg>');
}

body.dark-mode.candyfornia-mode {
    --bg-body: #3a2432; /* Roxo escuro rosado */
    --bg-panel: #4a2e3f; /* Roxo m√©dio */
    --text-main: #ffcce0; /* Rosa claro */
    --text-secondary: #ff99c8; /* Rosa m√©dio */
    --primary: #ff85a2; /* Rosa fofo (mesmo do modo claro) */
    --accent: #ffd166; /* Amarelo pastel (mesmo) */
    --plot-empty: #5a3a4a; /* Roxo escuro */
    --shadow: rgba(255, 133, 162, 0.2);
    /* 3D CANDYFORNIA NOTURNO */
    --grid-color: #ff8fab; /* Rosa */
    --grid-border: #ff7096; /* Rosa mais forte */
    --side-color: #ffafcc; /* Rosa claro */
    --bottom-color: #e75480; /* Rosa escuro */
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="10" cy="10" r="3" fill="%23ff7096" opacity="0.3"/><circle cx="30" cy="25" r="4" fill="%23ffd166" opacity="0.3"/><circle cx="70" cy="15" r="3" fill="%23ff85a2" opacity="0.3"/><circle cx="85" cy="40" r="3" fill="%23ff7096" opacity="0.3"/><circle cx="20" cy="60" r="4" fill="%23ffd166" opacity="0.3"/><circle cx="50" cy="80" r="3" fill="%23ff85a2" opacity="0.3"/></svg>');
}

/* NOVO: Modo Eurosummer - Ver√£o Italiano Pastel (Old Money Riviera) */
body.eurosummer-mode {
    --bg-body: #f8f9fa; /* Branco Gelo Suave */
    --bg-panel: #ffffff; 
    --text-main: #001d3d; /* Azul Marinho Profundo (Quase Preto para Moedas) */
    --text-secondary: #2c3e50; /* Azul Acinzentado Escuro */
    --primary: #a2d2ff; /* Azul Beb√™ Pastel */
    --accent: #fefae0; /* Creme / Areia Suave */
    --plot-empty: #f1f3f5; /* Cinza muito claro */
    --shadow: rgba(162, 210, 255, 0.15);
    /* 3D EUROSUMMER - RIVIERA PASTEL */
    --grid-color: #e9ecef; /* Cinza Suave */
    --grid-border: #dee2e6; /* Cinza M√©dio */
    --side-color: #f8edeb; /* Rosa Areia P√°lido */
    --bottom-color: #fae1dd; /* Rosa P√°lido Profundo */
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="15" cy="15" r="1.5" fill="%23a2d2ff" opacity="0.2"/><circle cx="45" cy="30" r="2" fill="%23fefae0" opacity="0.3"/><circle cx="75" cy="20" r="1.5" fill="%23a2d2ff" opacity="0.2"/><circle cx="90" cy="50" r="1.5" fill="%23fefae0" opacity="0.3"/><circle cx="25" cy="70" r="2" fill="%23a2d2ff" opacity="0.2"/><circle cx="60" cy="85" r="1.5" fill="%23fefae0" opacity="0.3"/></svg>');
}

body.dark-mode.eurosummer-mode {
    --bg-body: #1a202c; /* Azul Escuro Mate */
    --bg-panel: #2d3748; 
    --text-main: #f8f9fa; 
    --text-secondary: #a2d2ff; 
    --primary: #a2d2ff; 
    --accent: #4a5568; 
    --plot-empty: #171923; 
    --shadow: rgba(0, 0, 0, 0.4);
    /* 3D EUROSUMMER NOTURNO SUAVE - Quase igual ao claro */
    --grid-color: #ced4da; 
    --grid-border: #adb5bd; 
    --side-color: #e9ecef; 
    --bottom-color: #dee2e6; 
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="15" cy="15" r="1.5" fill="%23a2d2ff" opacity="0.1"/><circle cx="45" cy="30" r="2" fill="%23edf2f7" opacity="0.1"/><circle cx="75" cy="20" r="1.5" fill="%23a2d2ff" opacity="0.1"/><circle cx="90" cy="50" r="1.5" fill="%23edf2f7" opacity="0.1"/><circle cx="25" cy="70" r="2" fill="%23a2d2ff" opacity="0.1"/><circle cx="60" cy="85" r="1.5" fill="%23edf2f7" opacity="0.1"/></svg>');
}

/* CORRE√á√ÉO: Estilo espec√≠fico para modo Candyfornia 3D */
body.candyfornia-mode .cell-3d {
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 40 40"><path d="M5 35 L10 30 L15 35 Z" fill="%23ffb3c6" opacity="0.7"/><path d="M25 15 L30 10 L35 15 Z" fill="%23ffb3c6" opacity="0.7"/><circle cx="20" cy="20" r="4" fill="%23ffd166" opacity="0.5"/></svg>');
}

/* Estilo espec√≠fico para modo Eurosummer 3D */
body.eurosummer-mode .cell-3d {
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 40 40"><path d="M5 35 L10 30 L15 35 Z" fill="%23d4a574" opacity="0.6"/><path d="M25 15 L30 10 L35 15 Z" fill="%23d4a574" opacity="0.6"/><circle cx="20" cy="20" r="3" fill="%23ffd700" opacity="0.4"/></svg>');
}

/* NOVO: Modo Fundo do Mar - Mundo Subaqu√°tico */
body.fundo-mar-mode {
    --bg-body: #001d3d; /* Azul Escuro Profundo */
    --bg-panel: #003566; 
    --text-main: #ffffff; 
    --text-secondary: #4cc9f0; /* Ciano */
    --primary: #4cc9f0; /* Ciano Brilhante */
    --accent: #00b4d8; /* Azul Aqu√°tico */
    --plot-empty: #002847; 
    --shadow: rgba(76, 201, 240, 0.2);
    --grid-color: #003566; 
    --grid-border: #4cc9f0; 
    --side-color: #002847; 
    --bottom-color: #001d3d; 
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="15" cy="15" r="2" fill="%234cc9f0" opacity="0.3"/><circle cx="45" cy="30" r="2.5" fill="%2300b4d8" opacity="0.2"/><circle cx="75" cy="20" r="2" fill="%234cc9f0" opacity="0.3"/><circle cx="90" cy="50" r="2" fill="%2300b4d8" opacity="0.2"/><circle cx="25" cy="70" r="2.5" fill="%234cc9f0" opacity="0.3"/><circle cx="60" cy="85" r="2" fill="%2300b4d8" opacity="0.2"/></svg>');
}

body.dark-mode.fundo-mar-mode {
    --bg-body: #000814; 
    --bg-panel: #001d3d; 
    --text-main: #caf0f8; 
    --text-secondary: #90e0ef; 
    --primary: #00b4d8; 
    --accent: #0077b6; 
    --plot-empty: #001427; 
    --shadow: rgba(0, 180, 216, 0.3);
    --grid-color: #001d3d; 
    --grid-border: #00b4d8; 
    --side-color: #001427; 
    --bottom-color: #000814; 
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="15" cy="15" r="2" fill="%2300b4d8" opacity="0.2"/><circle cx="45" cy="30" r="2.5" fill="%230077b6" opacity="0.15"/><circle cx="75" cy="20" r="2" fill="%2300b4d8" opacity="0.2"/><circle cx="90" cy="50" r="2" fill="%230077b6" opacity="0.15"/><circle cx="25" cy="70" r="2.5" fill="%2300b4d8" opacity="0.2"/><circle cx="60" cy="85" r="2" fill="%230077b6" opacity="0.15"/></svg>');
}

/* Estilo espec√≠fico para modo Fundo do Mar 3D */
body.fundo-mar-mode .cell-3d {
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 40 40"><circle cx="10" cy="10" r="3" fill="%234cc9f0" opacity="0.4"/><circle cx="30" cy="25" r="2" fill="%2300b4d8" opacity="0.3"/><circle cx="20" cy="35" r="2.5" fill="%234cc9f0" opacity="0.4"/></svg>');
}

/* BOT√ïES LATERAIS PARA MODO FUNDO DO MAR */
body.fundo-mar-mode #containerMoedas {
    color: #4cc9f0 !important;
}

body.fundo-mar-mode #abaEsquerda h1, 
body.fundo-mar-mode #abaEsquerda h3,
body.fundo-mar-mode #abaEsquerda div {
    color: #ffffff !important;
}

body.fundo-mar-mode #abaEsquerda button {
    background: #003566 !important;
    color: #4cc9f0 !important;
    border: 1px solid #4cc9f0 !important;
}

body.fundo-mar-mode #abaEsquerda button:hover {
    background: #004080 !important;
    color: #00b4d8 !important;
    transform: translateY(-2px);
}

body.fundo-mar-mode .painel-controle button {
    background: #4cc9f0 !important;
    color: #001d3d !important;
    border: none !important;
     }

body.fundo-mar-mode .painel-controle button:hover {
    background: #00b4d8 !important;
}

body.fundo-mar-mode .painel-controle button.secundario {
    background: #003566 !important;
    color: #4cc9f0 !important;
    border: 1px solid #4cc9f0 !important;
}

/* BOT√ïES LATERAIS PARA MODO EUROSUMMER - RIVIERA PASTEL */
body.eurosummer-mode #containerMoedas {
    color: #001d3d !important; /* Azul Marinho Profundo para Moedas */
}

body.eurosummer-mode #abaEsquerda h1, 
body.eurosummer-mode #abaEsquerda h3,
body.eurosummer-mode #abaEsquerda div {
    color: #001d3d !important; /* For√ßar cor escura em todo o texto da aba esquerda */
}

body.eurosummer-mode #abaEsquerda button {
    background: #ffffff !important;
    color: #546e7a !important;
    border: 1px solid #a2d2ff !important;
}

body.eurosummer-mode #abaEsquerda button:hover {
    background: #f8f9fa !important;
    color: #a2d2ff !important;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(162, 210, 255, 0.2);
}

body.eurosummer-mode .painel-controle button {
    background: #a2d2ff !important;
    color: #ffffff !important;
    border: none !important;
    box-shadow: 0 2px 5px rgba(162, 210, 255, 0.3);
     }

body.eurosummer-mode .painel-controle button:hover {
    background: #90c2ef !important;
}

body.eurosummer-mode .painel-controle button.secundario {
    background: #ffffff !important;
    color: #546e7a !important;
    border: 1px solid #a2d2ff !important;
}

/* BOT√ïES LATERAIS ESPECIAIS PARA MODO CANDYFORNIA */
body.candyfornia-mode #abaEsquerda button {
    background: linear-gradient(135deg, #ff9ebb, #ff85a2);
    color: white;
    border: none;
    box-shadow: 0 3px 10px rgba(255, 133, 162, 0.3);
    transition: all 0.3s ease;
}

body.candyfornia-mode #abaEsquerda button:hover {
    background: linear-gradient(135deg, #ff85a2, #ff6b8b);
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(255, 133, 162, 0.4);
}

body.candyfornia-mode #abaEsquerda button:active {
    transform: translateY(0);
    box-shadow: 0 2px 5px rgba(255, 133, 162, 0.3);
}

/* BOT√ïES ESPEC√çFICOS DO MENU */
body.candyfornia-mode #btnTodoToggle {
    background: linear-gradient(135deg, #a2e1db, #8bd3cc) !important;
    color: #333 !important;
}

body.candyfornia-mode #btnMetasToggle {
    background: linear-gradient(135deg, #ffd166, #ffc145) !important;
    color: #333 !important;
}

body.candyfornia-mode #btnTrocarSom {
    background: linear-gradient(135deg, #c97aa0, #b5698f) !important;
    color: white !important;
}

/* BOT√ïES DE CONFIGURA√á√ÉO (OPCIONAL - se quiser mais consistente) */
body.candyfornia-mode .config-card h4 {
    color: #8a4b76;
}

body.candyfornia-mode .ios-switch.on {
    background-color: #ff85a2 !important;
}

/* BOT√ïES DO PAINEL DE CONTROLE (TIMER) */
body.candyfornia-mode .painel-controle button {
    background: linear-gradient(135deg, #ff85a2, #ff6b8b);
    color: white;
     }

body.candyfornia-mode .painel-controle button.secundario {
    background: #ffe8f0 !important;
    color: #8a4b76 !important;
    border: 1px solid #ffb3c6 !important;
}

body.candyfornia-mode .painel-controle button.cancelar {
    background: linear-gradient(135deg, #ff6b6b, #ff5252) !important;
    color: white !important;
}

/* BOT√ïES DE MODAL */
body.candyfornia-mode .modal-prateleira .item {
    background: #ffe8f0;
    border: 2px solid #ffccd5;
}

body.candyfornia-mode .modal-prateleira .item:hover {
    background: #ffccd5;
    border-color: #ff85a2;
}

body.candyfornia-mode .modal-prateleira .item.selecionado {
    background: #ffccd5;
    border-color: #ff85a2;
    box-shadow: 0 0 10px rgba(255, 133, 162, 0.5);
}

/* BOT√ïES DA LOJA */
body.candyfornia-mode .item-loja button {
    background: linear-gradient(135deg, #ffd166, #ffc145) !important;
    color: #333 !important;
    font-weight: bold;
     }

/* BOT√ïES DO DASHBOARD */
body.candyfornia-mode .dashboard-periodo button {
    background: #ffe8f0;
    color: #8a4b76;
    border: 1px solid #ffb3c6;
}

body.candyfornia-mode .dashboard-periodo button.active {
    background: linear-gradient(135deg, #ff85a2, #ff6b8b);
    color: white;
    border: none;
}

/* BOT√ïES ESPECIAIS */
body.candyfornia-mode #streakBadge {
    background: linear-gradient(135deg, #ffd166, #ffc145);
    color: #333;
    box-shadow: 0 3px 8px rgba(255, 209, 102, 0.3);
}

body.candyfornia-mode #luckyPlantTag {
    background: linear-gradient(135deg, #a2e1db, #8bd3cc);
    color: #333;
}


/* BOT√ïES SUPERIORES (MENU E TEMA) */
body.candyfornia-mode #abrirMenuBtn {
    background: linear-gradient(135deg, #ff85a2, #ff6b8b);
    color: white;
    box-shadow: 0 3px 8px rgba(255, 133, 162, 0.3);
}

body.candyfornia-mode #btnTema {
    background: #ffffff;
    color: #8a4b76;
    border: 1px solid #ffb3c6;
    box-shadow: 0 3px 8px rgba(255, 133, 162, 0.2);
}

body.candyfornia-mode #btnTema:hover {
    background: #ffe8f0;
}

/* BOT√ïES DO DEEP FOCUS */
body.candyfornia-mode .deep-focus-controls button {
    background: rgba(255, 133, 162, 0.2);
    color: #8a4b76;
    border: 1px solid #ffb3c6;
}

body.candyfornia-mode .deep-focus-controls button:hover {
    background: rgba(255, 133, 162, 0.3);
}

/* TODO LIST E METAS */
body.candyfornia-mode .todo-item {
    background: #ffe8f0;
    border-color: #ffccd5;
}

body.candyfornia-mode .todo-item input[type="checkbox"]:checked + span {
    color: #ff85a2;
}

/* PLOTS NO JARDIM */
body.candyfornia-mode .plot {
    background: #ffe8f0;
    border: 1px solid #ffccd5;
}

body.candyfornia-mode .plot:hover {
    background: #ffccd5;
    border-color: #ff85a2;
}

body.candyfornia-mode .plot.alvo {
    outline-color: #ff85a2;
}

/* C√âLULAS 3D */
body.candyfornia-mode .cell-3d {
    border: 1px solid #ffb3c6;
}

body.candyfornia-mode .cell-3d:hover {
    background-color: #ffccd5;
    border-color: #ff85a2;
}

/* BOT√ïES LATERAIS ROSINHAS - VERS√ÉO SIMPLES */
body.candyfornia-mode #abaEsquerda button {
    background: #ff9ebb;
    color: white;
    border: none;
    box-shadow: 0 3px 8px rgba(255, 158, 187, 0.3);
}

body.candyfornia-mode #abaEsquerda button:hover {
    background: #ff85a2;
    transform: translateY(-2px);
    box-shadow: 0 5px 12px rgba(255, 133, 162, 0.4);
}

/* BOT√ïES ESPECIAIS DO MENU */
body.candyfornia-mode #btnTodoToggle {
    background: #a2e1db !important;
    color: #333 !important;
}

body.candyfornia-mode #btnMetasToggle {
    background: #ffd166 !important;
    color: #333 !important;
}

body.candyfornia-mode #btnTrocarSom {
    background: #c97aa0 !important;
    color: white !important;
}

/* CORRE√á√ÉO ESPEC√çFICA PARA BOT√ïES LATERAIS NO MODO CANDYFORNIA */

/* 1. BOT√ïES DO MENU LATERAL - SOBRESCREVER TODOS OS ESTILOS */
body.candyfornia-mode #abaEsquerda button:not(#btnTodoToggle):not(#btnMetasToggle):not(#btnTrocarSom) {
    background: linear-gradient(135deg, #ff9ebb, #ff85a2) !important;
    color: white !important;
    border: none !important;
    box-shadow: 0 3px 10px rgba(255, 133, 162, 0.3) !important;
}

body.candyfornia-mode #abaEsquerda button:not(#btnTodoToggle):not(#btnMetasToggle):not(#btnTrocarSom):hover {
    background: linear-gradient(135deg, #ff85a2, #ff6b8b) !important;
    transform: translateY(-3px) !important;
    box-shadow: 0 5px 15px rgba(255, 133, 162, 0.4) !important;
}

/* 2. BOT√ïES ESPEC√çFICOS COM CORES DIFERENTES */
body.candyfornia-mode #btnTodoToggle {
    background: linear-gradient(135deg, #a2e1db, #8bd3cc) !important;
    color: #333 !important;
    border: none !important;
}

body.candyfornia-mode #btnMetasToggle {
    background: linear-gradient(135deg, #ffd166, #ffc145) !important;
    color: #333 !important;
    border: none !important;
}

body.candyfornia-mode #btnTrocarSom {
    background: linear-gradient(135deg, #c97aa0, #b5698f) !important;
    color: white !important;
    border: none !important;
}

/* 3. REMOVER BORDAS E FUNDOS HERDADOS */
body.candyfornia-mode #abaEsquerda button.secundario {
    background: linear-gradient(135deg, #ff9ebb, #ff85a2) !important;
    color: white !important;
    border: none !important;
}

/* 4. SE OS BOT√ïES AINDA N√ÉO FICAREM ROSAS, ADICIONE ESTE BLOCO MAIS ESPEC√çFICO */
body.candyfornia-mode #abaEsquerda button[onclick*="abrirLoja"],
body.candyfornia-mode #abaEsquerda button[onclick*="abrirDashboard"],
body.candyfornia-mode #abaEsquerda button[onclick*="abrirEstante"],
body.candyfornia-mode #abaEsquerda button[onclick*="abrirConfig"] {
    background: linear-gradient(135deg, #ff9ebb, #ff85a2) !important;
    color: white !important;
    border: none !important;
    box-shadow: 0 3px 10px rgba(255, 133, 162, 0.3) !important;
}

/* 5. BOT√ïES QUANDO ATIVOS/EXPANDIDOS */
body.candyfornia-mode #btnTodoToggle.ativo {
    background: linear-gradient(135deg, #8bd3cc, #74c5be) !important;
}

body.candyfornia-mode #btnMetasToggle.ativo {
    background: linear-gradient(135deg, #ffc145, #ffb52d) !important;
}


/* =========================
   PAINEL DE INTELIG√äNCIA NO MODO CANDYFORNIA
   ========================= */

/* Cor de fundo e borda azul para o painel */
body.candyfornia-mode #painelInteligencia {
    background: linear-gradient(135deg, rgba(162, 225, 219, 0.25), rgba(135, 206, 250, 0.2)) !important;
    border: 1px solid #a2e1db !important;
    color: #2c5282 !important;
    box-shadow: 0 3px 10px rgba(162, 225, 219, 0.25);
    transition: all 0.3s ease;
    width: fit-content;
    border-radius: 50px;
}

body.candyfornia-mode #painelInteligencia.expandido {
    border-radius: 20px;
}

/* Efeito hover suave */
body.candyfornia-mode #painelInteligencia:hover {
    background: linear-gradient(135deg, rgba(162, 225, 219, 0.35), rgba(135, 206, 250, 0.3)) !important;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(162, 225, 219, 0.35);
}

/* Cores din√¢micas baseadas na probabilidade - ALTA (acima de 70%) */
body.candyfornia-mode #painelInteligencia[style*="border-color:#4caf50"],
body.candyfornia-mode #painelInteligencia[style*="color:#4caf50"] {
    background: linear-gradient(135deg, rgba(102, 204, 255, 0.25), rgba(102, 255, 204, 0.2)) !important;
    border: 1px solid #66ccff !important;
    color: #0066cc !important;
    box-shadow: 0 3px 10px rgba(102, 204, 255, 0.25);
}

/* Cores din√¢micas - M√âDIA (40-70%) */
body.candyfornia-mode #painelInteligencia[style*="border-color:#ffb74d"],
body.candyfornia-mode #painelInteligencia[style*="color:#ffb74d"] {
    background: linear-gradient(135deg, rgba(255, 204, 102, 0.25), rgba(255, 229, 153, 0.2)) !important;
    border: 1px solid #ffcc66 !important;
    color: #cc9900 !important;
    box-shadow: 0 3px 10px rgba(255, 204, 102, 0.25);
}

/* Cores din√¢micas - BAIXA (abaixo de 40%) */
body.candyfornia-mode #painelInteligencia[style*="border-color:#e57373"],
body.candyfornia-mode #painelInteligencia[style*="color:#e57373"] {
    background: linear-gradient(135deg, rgba(255, 153, 153, 0.25), rgba(255, 204, 204, 0.2)) !important;
    border: 1px solid #ff9999 !important;
    color: #cc6666 !important;
    box-shadow: 0 3px 10px rgba(255, 153, 153, 0.25);
}

/* Estilo do texto dentro do painel */
body.candyfornia-mode #painelInteligencia strong {
    color: #2c5282;
    font-weight: 700;
}

body.candyfornia-mode #painelInteligencia small {
    color: #4a5568;
    opacity: 0.9;
}

/* Cor espec√≠fica para a tag de probabilidade */
body.candyfornia-mode #painelInteligencia .probabilidade-alta {
    color: #0066cc !important;
}

body.candyfornia-mode #painelInteligencia .probabilidade-media {
    color: #cc9900 !important;
}

body.candyfornia-mode #painelInteligencia .probabilidade-baixa {
    color: #cc6666 !important;
}

/* Anima√ß√£o sutil para quando o painel √© atualizado */
@keyframes candyfornia-painel-pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.02); }
    100% { transform: scale(1); }
}

body.candyfornia-mode #painelInteligencia.atualizado {
    animation: candyfornia-painel-pulse 0.5s ease;
}

/* Responsividade para mobile no modo Candyfornia */
@media (max-width: 899px) {
    body.candyfornia-mode #painelInteligencia {
        margin: 8px auto;
        padding: 8px 16px;
        font-size: 10px;
        border-radius: 50px;
    }
    
    body.candyfornia-mode #painelInteligencia.expandido {
        border-radius: 20px;
        padding: 12px;
    }
    
    body.candyfornia-mode #painelInteligencia strong {
        font-size: 11px;
    }
}

/* Efeito de brilho para destaque */
body.candyfornia-mode #painelInteligencia.destaque {
    position: relative;
    overflow: hidden;
}

body.candyfornia-mode #painelInteligencia.destaque::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(
        45deg,
        transparent,
        rgba(255, 255, 255, 0.1),
        transparent
    );
    transform: rotate(45deg);
    animation: candyfornia-brilho 3s infinite;
}

@keyframes candyfornia-brilho {
    0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
    100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
}



/* NOVO: Estilos para modo 10x10 */
body.grid-10x10 #jardim {
    grid-template-columns: repeat(10, 35px) !important;
    grid-template-rows: repeat(10, 35px) !important;
    gap: 5px !important;
    width: fit-content !important;
    margin-left: auto !important;
    margin-right: auto !important;
}

body.grid-10x10 .plot {
    width: 35px !important;
    height: 35px !important;
    border-radius: 8px !important;
    font-size: 18px !important;
}


/* Ajustes para 3D 10x10 */
body.grid-10x10 .cell-3d {
    width: 40px !important;
    height: 40px !important;
}

/* Ajuste de altura para 3D 10x10 */
body.grid-10x10 #jardim3D {
    height: 500px !important;
}

/* Ajustes responsivos para mobile 10x10 */
@media (max-width: 899px) {
    body.grid-10x10 #jardim {
        grid-template-columns: repeat(10, 28px) !important;
        grid-template-rows: repeat(10, 28px) !important;
        gap: 3px !important;
        width: fit-content !important;
        margin-left: auto !important;
        margin-right: auto !important;
    }
    
    body.grid-10x10 .plot {
        width: 28px !important;
        height: 28px !important;
        font-size: 14px !important;
    }
    
    body.grid-10x10 #jardim3D {
        height: 400px !important;
    }
    
    body.grid-10x10 .cell-3d {
        width: 32px !important;
        height: 32px !important;
    }
    
    body.grid-10x10 .emoji-3d {
        transform: rotateZ(-45deg) rotateX(-90deg) translateY(calc(var(--cell-3d-size) * -0.46)) scaleY(1) !important;
    }
}

/* Desktop 10x10 */
@media (min-width: 900px) {
    body.grid-10x10 #jardim {
        grid-template-columns: repeat(10, 40px) !important;
        grid-template-rows: repeat(10, 40px) !important;
        gap: 8px !important;
        width: fit-content !important;
        margin-left: auto !important;
        margin-right: auto !important;
    }
    
    body.grid-10x10 .plot {
        width: 40px !important;
        height: 40px !important;
        font-size: 20px !important;
    }
    
    body.grid-10x10 #jardim3D {
        height: 550px !important;
    }
    
    body.grid-10x10 .cell-3d {
        width: 45px !important;
        height: 45px !important;
    }
    
    body.grid-10x10 .emoji-3d {
        transform: rotateZ(-45deg) rotateX(-90deg) translateY(calc(var(--cell-3d-size) * -0.46)) scaleY(1) !important;
    }
}





body { 
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
    background: var(--bg-body); 
    margin: 0; 
    color: var(--text-main); 
    transition: all 0.3s; 
    overflow-x: hidden; 
    -webkit-tap-highlight-color: transparent; 
}

/* =========================
   PADRONIZA√á√ÉO VISUAL (Bot√µes, Modais, Hovers)
   ========================= */
button, select, input[type="checkbox"], input[type="text"], input[type="number"] {
    min-height: 44px;
    min-width: 44px;
    border-radius:  50px;
    border: 1px solid rgba(0,0,0,0.1);
    font-family: inherit;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

button {
    border-radius: 50px !important;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 10px 20px;
    font-weight: 600;
    letter-spacing: 0.3px;
    background: var(--primary);
    color: white;
    border: none;
    box-shadow: 0 2px 4px var(--shadow);
}

button:hover {
    filter: brightness(1.1);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px var(--shadow);
}

button:active {
    transform: translateY(0);
    filter: brightness(0.95);
}

button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none !important;
    box-shadow: none !important;
}

button.cancelar, button[style*="background:#e57373"], button[style*="background:#c62828"] {
    background: #ff5252 !important;
    color: white !important;
}

button.secundario, button[style*="background:#999"], button[style*="background:#eee"] {
    background: rgba(0,0,0,0.05) !important;
    color: var(--text-main) !important;
    border: 1px solid rgba(0,0,0,0.1) !important;
}

body.dark-mode button.secundario, 
body.dark-mode button[style*="background:#999"], 
body.dark-mode button[style*="background:#eee"] {
    background: rgba(255,255,255,0.1) !important;
    color: #eee !important;
}

button:focus, 
select:focus, 
input:focus {
    outline: 3px solid rgba(76, 175, 80, 0.4);
    outline-offset: 1px;
}

@media (prefers-reduced-motion: reduce) {
    * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
}

body.deep-focus-active #abaEsquerda, 
body.deep-focus-active #abrirMenuBtn, 
body.deep-focus-active #btnTema, 
body.deep-focus-active #paleta-container, 
body.deep-focus-active h1, 
body.deep-focus-active .xp-container, 
body.deep-focus-active .painel-controle > div:not(#timer):not(.deep-focus-controls), 
body.deep-focus-active #jardim,
body.deep-focus-active #jardim3D,
body.deep-focus-active #painelMotivo,
body.deep-focus-active #streakBadge,
body.deep-focus-active #btnToggle3D,
body.deep-focus-active #btnCorreioEurosummer {
    display: none !important;
}
body.deep-focus-active #conteudo { margin: 0; padding: 0; height: 100vh; display: flex; align-items: center; justify-content: center; }
body.deep-focus-active .painel-controle { background: transparent; box-shadow: none; border: none; width: 100%; max-width: none; padding: 0; }
body.deep-focus-active #timer { font-size: 25vw; margin: 0; line-height: 1; }
body.deep-focus-active #plantaFocoProfundo { font-size: 35vw; margin-bottom: 5vh; }

#bgCanvas { 
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%; 
    pointer-events: none; 
    z-index: 1; 
    display: block;
}

.presente-fall {
    position: fixed; top: -50px; font-size: 32px; z-index: 9999;
    pointer-events: none; animation: fall linear forwards;
}
@keyframes fall { to { transform: translateY(110vh) rotate(360deg); } }

.estrela-conquista {
    position: fixed;
    color: var(--accent);
    text-shadow: 0 0 8px var(--accent);
    z-index: 5;
    pointer-events: none;
    animation: brilharEstrela 3s infinite ease-in-out;
}
@keyframes brilharEstrela { 0%, 100% { opacity: 0.3; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.1); } }

@keyframes zoomInModal {
    from { opacity: 0; transform: scale(0.8); }
    to { opacity: 1; transform: scale(1); }
}

@keyframes zoomOutModal {
    from { opacity: 1; transform: scale(1); }
    to { opacity: 0; transform: scale(0.8); }
}

.modal-anim-in { animation: zoomInModal 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
.modal-anim-out { animation: zoomOutModal 0.2s ease-in forwards; }

#estanteOverlay, #configOverlay, #debugOverlay, #lojaOverlay, #modalPlantaOverlay, #modalLivroInput, #dashboardOverlay, #firstTimeOverlay, #manualFocusOverlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.6); z-index: 40000; display: none;
    align-items: center; justify-content: center; backdrop-filter: blur(8px);
    transition: all 0.3s ease;
}

#customAlertOverlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.8); z-index: 100000; display: none;
    align-items: center; justify-content: center; backdrop-filter: blur(10px);
    transition: all 0.3s ease;
}

#estanteContent, #configContent, #debugContent, #lojaContent, #modalPlantaContent, #modalLivroInput > div, #customAlertBox, #dashboardContent, #firstTimeContent, #manualFocusContent {
    background: var(--bg-panel); width: 95%; max-width: 500px; max-height: 85vh;
    border-radius: 28px; padding: 30px; overflow-y: auto; position: relative;
    box-shadow: 0 20px 50px rgba(0,0,0,0.3);
    border: 1px solid rgba(255,255,255,0.1);
}

.close-btn {
    position: absolute;
    top: 15px;
    right: 15px;
    background: none;
    border: none;
    font-size: 28px; /* Um pouco maior para melhor toque */
    color: var(--text-secondary);
    cursor: pointer;
    line-height: 1;
    padding: 5px;
    transition: color 0.2s;
    z-index: 3001;
}
.close-btn:hover {
    color: var(--primary);
}

@media (max-width: 600px) {
    #estanteContent {
        max-width: 270px; /* Aumentado para 270px para evitar sobreposi√ß√£o (12 * 18px + 2 * 15px padding + margens) */
        padding: 15px;
    }
}

.dashboard-container {
    margin-top: 15px;
}

.dia-semana {
    display: flex;
    align-items: center;
    margin-bottom: 12px;
    gap: 12px;
}

.dia-label {
    width: 20px;
    font-weight: bold;
    font-size: 13px;
    color: var(--text-secondary);
}

.dia-barra-container {
    flex: 1;
    background: var(--bg-body);
    border-radius: 8px;
    height: 20px;
    overflow: hidden;
    position: relative;
}

.dia-barra {
    height: 100%;
    background: linear-gradient(90deg, var(--primary), #66bb6a);
    border-radius: 8px 0 0 8px;
    min-width: 8px;
    transition: width 1s ease-out;
    position: relative;
}

.dia-barra.hoje {
    background: linear-gradient(90deg, var(--accent), #ffca28);
}

.dia-valor {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 12px;
    font-weight: bold;
    color: var(--text-main);
    z-index: 2;
}

.dia-meta {
    position: absolute;
    top: 0;
    width: 2px;
    height: 100%;
    background: rgba(255, 0, 0, 0.3);
}

.dashboard-resumo {
    display: flex;
    justify-content: space-between;
    background: var(--bg-body);
    padding: 15px;
    border-radius: 15px;
    margin-top: 20px;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 10px;
}

.resumo-item {
    text-align: center;
    flex: 1;
    min-width: 80px;
}

.resumo-valor {
    font-size: 24px;
    font-weight: bold;
    color: var(--primary);
}

.resumo-label {
    font-size: 11px;
    color: var(--text-secondary);
    margin-top: 5px;
}

.resumo-valor.meta {
    color: var(--accent);
}

.resumo-valor.total {
    color: #2196f3;
}

.resumo-valor.streak {
    color: #ff5722;
}

.moedas-display-loja {
    background: var(--plot-empty);
    padding: 15px;
    border-radius: 15px;
    font-size: 20px;
    font-weight: bold;
    color: #b8860b;
    margin-bottom: 20px;
}
.loja-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
}
.item-loja {
    background: var(--bg-body);
    padding: 15px;
    border-radius: 15px;
    border: 1px solid var(--shadow);
    text-align: center;
}
.item-loja button { width: 100%; margin-top: 10px; background: #daa520;
     }

.madeira-shelf {
    background: #795548; 
    padding: 10px; 
    border-radius: 0;
    box-shadow: inset 0 0 15px rgba(0,0,0,0.3); 
    margin: 0; 
    position: relative;
}

#listaLivros .madeira-shelf:last-child {
    border-radius: 0 0 8px 8px;
}

.prateleira-interna {
    background: #5d4037; 
    min-height: 80px; 
    display: flex; 
    align-items: flex-end;
    gap: 0; 
    padding: 0 8px; 
    border-bottom: 8px solid #3e2723;
    flex-wrap: wrap;
    justify-content: flex-start;
    width: 100%;
    box-sizing: border-box;
}

.livro {
    width: 24px; 
    border-radius: 2px 2px 0 0; 
    cursor: pointer;
    transition: transform 0.2s; 
    border-left: 2px solid rgba(255,255,255,0.1);
    box-shadow: 1px 0 3px rgba(0,0,0,0.2); 
    display: flex; 
    justify-content: center;
    position: relative;
    flex-shrink: 0;
    margin-right: -1px;
}
.livro:hover { transform: translateY(-5px); filter: brightness(1.1); }
.livro-titulo { 
    writing-mode: vertical-rl; 
    font-size: 7px; 
    color: white; 
    padding: 3px 0px;
    overflow: hidden; 
    text-overflow: ellipsis; 
    white-space: nowrap; 
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.star-rating { font-size: 28px; margin: 10px 0; display: flex; justify-content: center; gap: 5px; cursor: pointer; }
.star-rating .star { color: #ccc; }
.star-rating .star.active { color: var(--accent); }

.modal-prateleira {
    display: flex !important;
    flex-wrap: wrap !important;
    justify-content: center;
    gap: 8px;
    padding: 15px 5px;
    background: rgba(0,0,0,0.05);
    border-radius: 15px;
    border-bottom: 4px solid #8d6e63;
    margin-bottom: 15px;
}

.item {
    font-size: 24px;
    width: 42px;
    height: 42px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg-panel);
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s;
    border: 2px solid transparent;
    box-shadow: 0 2px 5px var(--shadow);
    flex-shrink: 0;
}

.item:hover { transform: translateY(-3px); }

@keyframes aproximarSuave {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

.item.selecionado {
    border-color: var(--primary);
    background: var(--plot-empty);
    animation: aproximarSuave 1.5s infinite ease-in-out;
    z-index: 5;
}

#abaEsquerda { 
    position: fixed; 
    top: 70px; 
    left: -300px; 
    width: 280px; 
    max-height: calc(100vh - 100px); 
    background: var(--bg-panel);
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    padding: 15px; 
    box-sizing: border-box; 
    overflow-y: auto; 
    border-radius: 18px;
    transition: left 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
    z-index: 10000;
    display: flex;
    flex-direction: column;
    gap: 12px;
}

#abaEsquerda.aberto { left: 15px; }

/* Estilos para os grupos de bot√µes */
#abaEsquerda > div[style*="flex-direction: column"] {
    animation: slideInUp 0.5s ease-out;
}

@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Melhorias no scrollbar */
#abaEsquerda::-webkit-scrollbar {
    width: 6px;
}

#abaEsquerda::-webkit-scrollbar-track {
    background: transparent;
}

#abaEsquerda::-webkit-scrollbar-thumb {
    background: rgba(76, 175, 80, 0.3);
    border-radius: 3px;
}

#abaEsquerda::-webkit-scrollbar-thumb:hover {
    background: rgba(76, 175, 80, 0.5);
}
/* --- NOVO ESTILO: GRID DE 2 COLUNAS NO MENU --- */
.menu-grid-group {
    display: grid;
    grid-template-columns: 1fr 1fr; /* Cria 2 colunas iguais */
    gap: 10px;
    align-items: start;
    margin-bottom: 15px;
}

/* T√≠tulos das se√ß√µes ocupam a largura total */
.menu-grid-group h4 {
    grid-column: 1 / -1; /* Ocupa de ponta a ponta */
    width: 100%;
    margin: 5px 0 5px 0 !important;
}

/* Pain√©is que abrem (Tarefas/Metas) ocupam a largura total */
.menu-grid-group .todo-container {
    grid-column: 1 / -1;
    width: 100%;
    box-sizing: border-box;
    margin-top: 5px !important;
}

/* Bot√µes dentro do grid */
.menu-grid-group > button {
    height: 100%; /* Garante altura igual */
    margin: 0 !important;
    min-height: 50px; /* Altura m√≠nima para clique f√°cil */
    font-size: 13px !important; /* Fonte levemente menor para caber */
    padding: 5px 8px !important;
    line-height: 1.2;
    display: flex;
    flex-direction: column; /* √çcone em cima do texto (opcional, remove se preferir lado a lado) */
    align-items: center;
    justify-content: center;
    gap: 5px;
}


/* Lista de Tarefas Integrada ao Bot√£o */
.todo-container {
    background: var(--bg-panel);
    border-radius: 12px;
    border: 1px solid rgba(76, 175, 80, 0.2);
    padding: 12px;
    display: none;
    flex-direction: column;
    margin-top: 0;
    max-height: 300px;
    overflow-y: auto;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

.todo-container.ativo {
    display: flex;
    animation: expandDown 0.3s ease-out;
}

@keyframes expandDown {
    from { transform: translateY(-10px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.todo-item {
    display: flex;
    align-items: flex-start; /* Alinha ao topo para quando o texto quebrar linha */
    gap: 8px;
    padding: 8px 0;
    border-bottom: 1px solid rgba(0,0,0,0.05);
}

.todo-item span {
    flex: 1;
    font-size: 11px;
    line-height: 1.4;
    word-break: break-word; /* Quebra palavras longas se necess√°rio */
    white-space: normal;    /* Permite quebra de linha normal */
    padding-top: 2px;       /* Ajuste fino para alinhar com o checkbox */
}

.todo-item input[type="checkbox"] {
    min-width: 16px;
    min-height: 16px;
}

.todo-item button {
    min-width: 24px;
    min-height: 24px;
    padding: 0;
    background: #ff5252;
    font-size: 10px;
    border-radius:     50px !important;
}

#btnTodoToggle.ativo {
    box-shadow: 0 6px 16px rgba(76, 175, 80, 0.4) !important;
}
#abrirMenuBtn { 
    position: fixed; 
    top: 15px; 
    left: 15px; 
    z-index: 900; 
    background: var(--accent); 
    color: #333; 
    border-radius: 12px; 
    border: none; 
    width: 45px; 
    height: 45px; 
    cursor: pointer; 
    font-weight: bold;
    font-size: 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

#abrirMenuBtn:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 16px rgba(0,0,0,0.2);
}
#btnTema { 
    position: fixed; top: 15px; right: 15px; z-index: 900; 
    background: var(--bg-panel); color: var(--text-main); border: 1px solid var(--primary);
    border-radius: 50px; padding: 10px 15px; cursor: pointer; font-weight: bold;
}
#btnCorreioEurosummer { 
    position: fixed; top: 70px; right: 15px; z-index: 900; 
    background: var(--bg-panel); color: var(--text-main); border-radius: 50px; 
    border: 1px solid var(--primary); padding: 8px 12px; cursor: pointer; font-size: 18px;
    transition: all 0.3s;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    width: 45px; height: 45px; display: flex; align-items: center; justify-content: center;
}
#btnCorreioEurosummer:hover { transform: scale(1.1); background: var(--primary); color: white; }

#btnMetasFundoMar { 
    position: fixed; top: 70px; right: 15px; z-index: 900; 
    background: #003566; color: #4cc9f0; border-radius: 50px; 
    border: 1px solid #4cc9f0; padding: 8px 12px; cursor: pointer; font-size: 18px;
    transition: all 0.3s;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    width: 45px; height: 45px; display: flex; align-items: center; justify-content: center;
}
#btnMetasFundoMar:hover { transform: scale(1.1); background: #4cc9f0; color: #001d3d; }

#btnCorreioFundoMar { 
    position: fixed; top: 125px; right: 15px; z-index: 900; 
    background: #003566; color: #4cc9f0; border-radius: 50px; 
    border: 1px solid #4cc9f0; padding: 8px 12px; cursor: pointer; font-size: 18px;
    transition: all 0.3s;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    width: 45px; height: 45px; display: flex; align-items: center; justify-content: center;
}
#btnCorreioFundoMar:hover { transform: scale(1.1); background: #4cc9f0; color: #001d3d; }

#painelMetasFundoMar {
    position: fixed;
    top: 180px;
    right: 15px;
    width: 260px;
    height: 350px;
    background: #003566;
    border: 2px solid #4cc9f0;
    border-radius: 15px;
    z-index: 10000; /* Aumentado para garantir que fique no topo */
    box-shadow: 0 10px 30px rgba(0,0,0,0.4);
    padding: 12px;
    color: white;
    animation: slideInRight 0.3s ease;
    display: flex;
    flex-direction: column;
    box-sizing: border-box;
    overflow: hidden; /* O painel n√£o rola, apenas a lista */
}

@keyframes slideInRight {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

.metas-fundo-mar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    border-bottom: 1px solid rgba(76, 201, 240, 0.3);
    padding-bottom: 8px;
    flex-shrink: 0;
}
#listaMetasFundoMar {
    overflow-y: auto !important;
    overflow-x: hidden !important;
    flex: 1;
    padding-right: 5px;
    margin-top: 5px;
    height: calc(100% - 40px); /* For√ßa uma altura calculada */
    display: block;
    scrollbar-width: thin;
    scrollbar-color: #4cc9f0 rgba(0, 53, 102, 0.3);
}
#listaMetasFundoMar::-webkit-scrollbar {
    width: 6px;
}
#listaMetasFundoMar::-webkit-scrollbar-track {
    background: rgba(0, 53, 102, 0.3);
    border-radius: 10px;
}
#listaMetasFundoMar::-webkit-scrollbar-thumb {
    background: #4cc9f0;
    border-radius: 10px;
}

.metas-fundo-mar-header h3 { margin: 0; font-size: 16px; color: #4cc9f0; }
.metas-fundo-mar-header button { background: transparent; border: none; color: #4cc9f0; cursor: pointer; font-size: 18px;
}

.meta-item-fundo {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 8px;
    padding: 8px;
    background: rgba(0, 29, 61, 0.5);
    border-radius: 8px;
    font-size: 13px;
    transition: all 0.2s;
}
.meta-item-fundo.bloqueada {
    filter: blur(3px);
    opacity: 0.5;
    pointer-events: none;
    user-select: none;
}
.meta-item-fundo.proxima {
    filter: none;
    opacity: 1;
    border: 1px dashed #4cc9f0;
}

.meta-item-fundo.concluida {
    opacity: 0.6;
    border-left: 3px solid #4cc9f0;
    background: rgba(76, 201, 240, 0.1);
}

.meta-item-fundo .meta-emoji { font-size: 20px; }
.meta-item-fundo .meta-info { flex: 1; }
.meta-item-fundo .meta-status { font-size: 16px; }




#conteudo { 
    margin-left:0; 
    padding: 10px 20px; 
    text-align:center; 
    transition: margin-left 0.3s; 
    position: relative; 
    z-index: 20; 
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    background: transparent;
    min-height: 100vh; /* Mudado de height para min-height */
    width: 100vw;
    box-sizing: border-box;
    justify-content: flex-start;
    overflow: visible; /* Deixar o body controlar a rolagem */
}

/* DESKTOP: MAIOR GRID E PLOTS GRUDADOS */
@media(min-width: 900px) {
    /* Removido: #abaEsquerda { left: 0; } para manter o menu oculto */
    /* Removido: #conteudo { margin-left: 210px; } para manter o conte√∫do centralizado */
    /* Removido: #abrirMenuBtn { display: none; } para manter o bot√£o vis√≠vel */
    
    .painel-controle { order: 3; } /* Bot√µes para baixo */
    #jardim { 
        order: 2; /* Mapa para cima */
        margin-top: 5px;
    }
    #jardim3D { 
        order: 2; /* Mapa 3D para cima */
        max-width: 480px; /* Limitar a largura √† altura fixa (480px) para evitar achatamento */
        margin: 20px auto; /* Centralizar */
    }
    #painelMotivo { order: 5; }
    
    /* DESKTOP: HOVER EFFECT PARA SELE√á√ÉO */
    .plot:hover {
        transform: scale(1.05);
        transition: transform 0.2s;
        outline: 2px solid var(--primary);
        outline-offset: 2px;
    }
    
    
}

/* ========================= 
   BARRA DE NAVEGA√á√ÉO INFERIOR (P√çLULA)
   ========================= */
#bottomNavBar {
    display: none !important;
}

.bottom-nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 45px;
    height: 45px;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    color: var(--text-main);
    text-decoration: none;
    border: none;
    background: transparent;
    font-size: 20px;
    border-radius: 15px;
    padding: 0;
    flex-shrink: 0;
    position: relative;
}

.bottom-nav-item:hover {
    background: rgba(76, 175, 80, 0.1);
    transform: translateY(-5px);
    color: var(--primary);
}

.bottom-nav-item.active {
    color: var(--primary);
    background: rgba(76, 175, 80, 0.15);
}

.bottom-nav-item::after {
    content: attr(title);
    position: absolute;
    bottom: -25px;
    font-size: 10px;
    font-weight: bold;
    opacity: 0;
    transition: opacity 0.3s;
    white-space: nowrap;
    color: var(--primary);
}

.bottom-nav-item:hover::after {
    opacity: 1;
}

/* Foto de Perfil no Centro - EXPANDIDA */
#bottomNavPhotoContainer {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    overflow: hidden;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border: 2px solid var(--primary); /* Borda reduzida de 4px para 2px */
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg-panel);
    position: relative;
    z-index: 950;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    flex-shrink: 0;
    margin: 0 5px;
}

#bottomNavPhotoContainer:hover {
    transform: scale(1.1) translateY(-5px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
}

#bottomNavPhoto {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 50%;
}

#bottomNavPhotoPlaceholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 40px;
    border-radius: 50%;
}

#bottomNavPhoto:hover {
    filter: brightness(1.1);
}

/* Ajustar padding inferior do conte√∫do para n√£o ficar atr√°s da barra */
@media(max-width: 899px) {
    #conteudo { padding-top: 10px; padding-bottom: 70px; justify-content: center; gap: 5px; }
    #jardim, #jardim3D { order: 2; margin-bottom: 5px; }
    .painel-controle { order: 3; width: 95%; padding: 8px; margin-bottom: 0; }
    #bottomNavBar { 
        width: 90%; 
        max-width: 360px;
        bottom: 8px; 
        height: 50px;
        gap: 5px;
        padding: 0 10px;
    }
    .bottom-nav-item { font-size: 16px; width: 32px; height: 32px; }
    #bottomNavPhotoContainer { width: 55px; height: 55px; margin: 0 2px; }
    #bottomNavPhotoPlaceholder { font-size: 26px; }
    .bottom-nav-item::after { display: none; } 
    
    #timer { font-size: 38px; margin: 5px 0; }
    #jardim { grid-template-columns: repeat(5, 45px); gap: 5px; }
    .plot { width: 45px; height: 45px; font-size: 22px; border-radius: 10px; }
    
    /* MOBILE: HOVER SIMPLIFICADO */
    .plot:active {
        transform: scale(0.95);
    }
}

/* Ajustes extras para telas extremamente estreitas */
@media (max-width: 380px) {
    #bottomNavBar {
        gap: 3px;
        padding: 0 8px;
        height: 45px;
    }
    .bottom-nav-item {
        width: 28px;
        height: 28px;
        font-size: 14px;
    }
    #bottomNavPhotoContainer {
        width: 45px;
        height: 45px;
    }
    .painel-controle {
        padding: 5px;
    }
    #timer {
        font-size: 32px;
    }
    #jardim { grid-template-columns: repeat(5, 38px); gap: 4px; }
    .plot { width: 38px; height: 38px; font-size: 18px; }
}

/* NOVO: HOVER PARA GRID 2D EM TODOS OS DISPOSITIVOS */
.plot:hover {
    transform: scale(1.03);
    transition: transform 0.2s;
    outline: 2px solid var(--primary);
    outline-offset: 2px;
}

.painel-controle { 
    background: var(--bg-panel); 
    display: inline-block; 
    padding: 20px; 
    border-radius: 25px; 
    box-shadow: 0 10px 30px var(--shadow); 
    margin-bottom: 10px; 
    width: 95%; 
    max-width: 450px; 
    box-sizing: border-box;
    position: relative;
    z-index: 2;
}

body.dark-mode .painel-controle,
body.medieval-mode .painel-controle {
    border: 1px solid rgba(255, 255, 255, 0.1);
}

#painelInteligencia {
    background: rgba(255, 255, 255, 0.9);
    margin: 10px auto;
    padding: 8px 16px;
    border-radius: 50px;
    font-size: 12px;
    width: fit-content;
    max-width: 300px;
    border: 2px solid var(--primary);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    animation: fadeInPainel 0.5s ease-out;
    cursor: pointer;
    overflow: hidden;
    white-space: nowrap;
    user-select: none;
}

#painelInteligencia.expandido {
    border-radius: 20px;
    padding: 15px;
    white-space: normal;
}

@keyframes fadeInPainel {
    from {
        opacity: 0;
        transform: translateY(-5px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

#painelInteligencia:hover {
    box-shadow: 0 6px 16px rgba(0,0,0,0.15);
    transform: translateY(-2px);
}

#painelInteligencia strong {
    display: block;
    font-size: 14px;
    font-weight: 700;
    transition: all 0.3s;
}

#painelInteligencia.expandido strong {
    font-size: 18px;
    margin-bottom: 4px;
}

#painelInteligencia .detalhes-intel {
    max-height: 0;
    opacity: 0;
    overflow: hidden;
    transition: all 0.4s ease;
    text-align: center;
}

#painelInteligencia.expandido .detalhes-intel {
    max-height: 200px;
    opacity: 1;
    margin-top: 8px;
}

#painelInteligencia small {
    display: block;
    opacity: 0.85;
}

#painelInteligencia div[style*="margin-top"] {
    display: flex;
    justify-content: space-around;
    font-size: 10px;
    opacity: 0.75;
    padding-top: 6px;
    border-top: 1px solid rgba(0,0,0,0.1);
}

#timer { font-size: 60px; margin: 10px 0; font-weight: bold; font-family: 'Courier New', monospace; color: var(--text-main); text-align: center; }

/* Estilos de bot√µes legados removidos para usar a nova padroniza√ß√£o */

#jardim { 
    display:grid; 
    grid-template-columns:repeat(5, 55px); 
    gap:10px; 
    justify-content:center; 
    margin-top:20px; 
    transition: transform 1.2s ease-in-out;
    position: relative;
    z-index: 2;
    margin-bottom: 20px;
}
.plot { 
    width:55px; 
    height:55px; 
    background: var(--plot-empty); 
    border-radius: 14px; 
    font-size: 28px; 
    display:flex; 
    align-items:center; 
    justify-content:center; 
    cursor:pointer; 
    position: relative; 
    z-index: 2;
    transition: transform 0.2s;
}
.plot.alvo { 
    outline:3px dashed var(--primary); 
    animation: pulsar 1.5s infinite, aproximarSuave 1.5s infinite ease-in-out; 
}

/* NOVO: Estilo para fantasma da planta pr√©-selecionada */
.plot-emoji-fantasma {
    opacity: 0.5;
    filter: grayscale(1);
}

@keyframes spawn {
    0% { transform: scale(0); }
    70% { transform: scale(1.2); }
    100% { transform: scale(1); }
}
.plant-spawn { animation: spawn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

@keyframes crescer {
    0% { transform: scale(0.5); opacity: 0.7; }
    50% { transform: scale(1.1); opacity: 1; }
    100% { transform: scale(1); opacity: 1; }
}
.crescendo { animation: crescer 0.5s ease-out forwards; }

@keyframes gardenZoomOut {
    0% { transform: scale(1); opacity: 1; }
    40% { transform: scale(0.6); opacity: 0.7; }
    80% { transform: scale(0); opacity: 0; }
    100% { transform: scale(1); opacity: 1; }
}
.zoom-out-effect { animation: gardenZoomOut 2.5s ease-in-out forwards; }

.lucky-plant-tag { 
    font-size: 11px; 
    background: var(--accent); 
    padding: 2px 8px; 
    border-radius: 20px; 
    display: inline-block; 
    margin-bottom: 10px; 
    font-weight: bold; 
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    position: relative;
    z-index: 2;
}
.lucky-glow { filter: drop-shadow(0 0 5px var(--accent)); animation: glowPulse 2s infinite ease-in-out; }

@keyframes glowPulse { 0%, 100% { filter: drop-shadow(0 0 2px var(--accent)); } 50% { filter: drop-shadow(0 0 8px var(--accent)); } }

#modalPlantaContent h3 { margin-top: 0; }
.btn-fechar-modal { position: absolute; top: 15px; right: 15px; font-size: 20px; cursor: pointer; color: var(--text-secondary); }

.color-picker { 
    display: flex; 
    justify-content: center; 
    gap: 10px; 
    margin: 15px 0; 
    flex-wrap: wrap; /* Permite que as cores quebrem linha se forem muitas */
    padding: 5px;
}

.color-swatch { 
    width: 32px; 
    height: 32px; 
    border-radius: 50%; 
    cursor: pointer; 
    border: 3px solid rgba(0,0,0,0.1); /* Borda sutil para cores claras */
    transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.color-swatch:hover {
    transform: scale(1.15);
}

.color-swatch.active { 
    border-color: var(--text-color, #333) !important; 
    transform: scale(1.2);
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}

/* Ajuste para Modo Noturno: borda ativa branca */
body.dark-mode .color-swatch.active {
    border-color: #ffffff !important;
}

.todo-item { display: flex; align-items: center; justify-content: space-between; margin-bottom: 5px; background: rgba(0,0,0,0.03); padding: 5px 10px; border-radius: 8px; font-size: 13px; }
.semana-card { background: var(--bg-body); padding: 15px; border-radius: 15px; margin-bottom: 12px; border-left: 5px solid var(--primary); text-align: left; box-shadow: 0 4px 6px var(--shadow); }
.mini-grind { display: block; margin: 8px 0; font-size: 18px; line-height: 1.4; word-break: break-all; }

.toggle-container { display: flex; align-items: center; justify-content: space-between; background: rgba(0,0,0,0.03); padding: 10px 15px; border-radius: 15px; margin-bottom: 10px; font-size: 14px; }

.secao-estilo {
    background: rgba(0,0,0,0.05);
    border: 1px solid var(--shadow);
    padding: 15px;
    border-radius: 20px;
    margin-bottom: 15px;
    text-align: left;
}
.secao-estilo h4 { margin: 0 0 10px 5px; font-size: 14px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; }

/* Dashboard Unificado */
.dashboard-periodo {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-bottom: 20px;
}

.dashboard-periodo button {
    background: var(--bg-body);
    color: var(--text-main);
    border: 1px solid var(--primary);
}

.dashboard-periodo button.active {
    background: var(--primary);
    color: white;
}

.dashboard-periodo-content {
    display: none;
}

.dashboard-periodo-content.active {
    display: block;
}

/* NOVO: Estilos para a se√ß√£o "Mais usado" no dashboard */
.mais-usado-section {
    background: var(--bg-panel);
    padding: 20px;
    border-radius: 20px;
    margin-top: 25px;
    border-left: 5px solid var(--accent);
    box-shadow: 0 4px 12px var(--shadow);
}

.mais-usado-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 15px;
    color: var(--primary);
    font-size: 16px;
    font-weight: bold;
}

.mais-usado-content {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    justify-content: space-between;
}

.mais-usado-item {
    flex: 1;
    min-width: 140px;
    text-align: center;
    padding: 15px;
    background: var(--bg-body);
    border-radius: 15px;
    border: 1px solid var(--shadow);
}

.mais-usado-emoji {
    font-size: 36px;
    margin-bottom: 10px;
    display: block;
}

.mais-usado-motivo {
    font-size: 13px;
    color: var(--text-main);
    line-height: 1.4;
    word-break: break-word;
}

.mais-usado-label {
    font-size: 11px;
    color: var(--text-secondary);
    margin-top: 5px;
    display: block;
}

/* NOVO ESTILO: CONFIGURA√á√ïES EM GRID */
.config-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin-bottom: 20px;
}

.config-card {
    background: var(--bg-body);
    border-radius: 16px;
    padding: 18px;
    text-align: center;
    border: 1px solid var(--shadow);
    transition: all 0.2s;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100px;
}

.config-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 15px var(--shadow);
}

.config-card h4 {
    margin: 0 0 10px 0;
    font-size: 14px;
    color: var(--text-main);
}

/* NOVO: Estilo de Switch Arredondado (iOS-style) */
.ios-switch-container {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%; /* Para centralizar no config-card */
    margin-top: 10px; /* Espa√ßamento */
}

.ios-switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 30px;
    background-color: var(--text-secondary); /* Cor de fundo para OFF */
    border-radius: 15px;
    cursor: pointer;
    transition: background-color 0.3s;
}

.ios-switch.on {
    background-color: var(--primary); /* Cor de fundo para ON */
}

.ios-switch-thumb {
    position: absolute;
    top: 2px;
    left: 2px;
    width: 26px;
    height: 26px;
    background-color: white;
    border-radius: 50%;
    transition: transform 0.3s;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
}

.ios-switch.on .ios-switch-thumb {
    transform: translateX(20px);
}

/* Removendo estilos de bot√£o que n√£o ser√£o mais usados */
.config-card button {
    display: none;
}



/* ESTILO DO T√çTULO */
h1 {
    font-family: 'Georgia', 'Times New Roman', serif;
    font-weight: 700;
    font-size: 2.5rem;
    margin-bottom: 5px;
    color: var(--primary);
    letter-spacing: 0.5px;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    cursor: pointer;
    position: relative;
    z-index: 2;
}

/* ESTILO DO BADGE DE STREAK (VERS√ÉO P√çLULA ULTRA COMPACTA) */
#streakBadge {
    background: linear-gradient(90deg, #ff5722, #ff9800);
    color: white;
    padding: 4px 12px;
    border-radius: 50px;
    font-size: 12px;
    line-height: 1;
    min-width: fit-content;
    font-weight: 800;
    display: inline-flex !important;
    align-items: center;
    justify-content: center;
    gap: 4px;
    box-shadow: 0 2px 8px rgba(255, 87, 34, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.2);
    cursor: pointer;
    transition: all 0.2s ease;
    position: fixed;
    top: 15px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10000;
}

#streakBadgeSide {
    background: linear-gradient(90deg, #ff5722, #ff9800);
    color: white;
    padding: 6px 15px;
    border-radius: 50px;
    font-size: 13px;
    font-weight: 800;
    display: none;
    align-items: center;
    justify-content: center;
    gap: 5px;
    margin: 10px auto;
    width: fit-content;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(255, 87, 34, 0.3);
}

#streakBadge:hover {
    transform: scale(0.85);
}

/* Ajuste do √≠cone de fogo para n√£o empurrar a p√≠lula */
#streakBadge span {
    font-size: 9px;
}

#streakBadge:hover {
    transform: scale(0.85);
    box-shadow: 0 4px 10px rgba(255, 87, 34, 0.4);
}

/* Ajuste espec√≠fico para o √≠cone/texto dentro dele se necess√°rio */
#streakBadge span {
    font-size: 9px; /* N√∫mero do streak levemente maior que o texto */
}

/* ESTILOS PARA FOTO DE PERFIL */
#profilePhotoContainer {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    overflow: hidden;
    margin: 0 auto 10px;
    background: var(--bg-panel);
    border: 3px solid var(--primary);
    cursor: pointer;
    transition: all 0.3s;
    position: relative;
    box-shadow: 0 4px 12px var(--shadow);
}

#profilePhotoContainer:hover {
    transform: scale(1.05);
    border-color: var(--accent);
}

#profilePhoto {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: none;
}

#profilePhotoPlaceholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 35px;
    background: linear-gradient(135deg, var(--primary), var(--accent));
    color: white;
}

#profilePhotoLabel {
    text-align: center;
    font-size: 11px;
    color: var(--text-secondary);
    margin-bottom: 15px;
    cursor: pointer;
    transition: color 0.3s;
}

#profilePhotoLabel:hover {
    color: var(--primary);
}

#profilePhotoInput {
    display: none;
}

/* NOVO: Estilos para estante com m√∫ltiplos andares */
.prateleira-interna {
    display: flex;
    align-items: flex-end;
    justify-content: flex-start;
    flex-wrap: wrap;
    gap: 0;
}

.livro {
    position: relative;
    flex-shrink: 0;
    transition: all 0.3s ease;
    border-radius: 2px 2px 0 0;
    cursor: pointer;
    overflow: hidden;
    margin-right: -1px;
}

.livro:hover {
    transform: translateY(-5px);
    filter: brightness(1.1);
}

.livro-titulo {
    writing-mode: vertical-rl;
    text-orientation: mixed;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 3px 0px;
}

@media (max-width: 600px) {
    .livro {
        width: 18px !important;
    }
    
    .livro-titulo {
        font-size: 6px !important;
    }
}

/* NOVO: Bot√£o de ajuda na estante */
.help-btn {
    position: absolute;
    top: 15px;
    right: 15px;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--primary);
    color: white;
    border: none;
    font-size: 18px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
}

.help-btn:hover {
    background: var(--accent);
    color: #333;
    transform: scale(1.1);
}



/* Estilos para o popup de primeiro uso */
.first-time-step {
    text-align: center;
}

.first-time-step h3 {
    color: var(--primary);
    margin-bottom: 15px;
}

.first-time-step p {
    margin-bottom: 15px;
    line-height: 1.6;
}

.first-time-step ul {
    text-align: left;
    margin: 15px 0;
    padding-left: 20px;
}

.first-time-step li {
    margin-bottom: 8px;
    line-height: 1.5;
}

.first-time-emoji {
    font-size: 40px;
    margin: 15px 0;
    display: block;
}

.first-time-buttons {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-top: 10px;
}

/* =========================
   TUTORIAL INTERATIVO (SIMPLIFICADO)
   ========================= */
#tutorialOverlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 9999;
    display: none;
    justify-content: center;
    align-items: center;
    background: rgba(0, 0, 0, 0.85);
}

#tutorialOverlay.active {
    display: flex;
}

.tutorial-card {
    background: var(--bg-panel);
    border-radius: 24px;
    padding: 30px;
    max-width: 380px;
    width: 90%;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
    animation: tutorialSlideIn 0.4s ease-out;
    text-align: center;
}

@keyframes tutorialSlideIn {
    from { opacity: 0; transform: scale(0.9) translateY(20px); }
    to { opacity: 1; transform: scale(1) translateY(0); }
}

.tutorial-icon {
    font-size: 50px;
    margin-bottom: 15px;
}

.tutorial-title {
    font-size: 20px;
    font-weight: bold;
    color: var(--primary);
    margin-bottom: 15px;
}

.tutorial-text {
    font-size: 15px;
    color: var(--text-main);
    line-height: 1.6;
    margin-bottom: 20px;
}

.tutorial-location {
    background: var(--plot-empty);
    border-radius: 12px;
    padding: 12px 15px;
    margin-bottom: 20px;
    font-size: 13px;
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.tutorial-location strong {
    color: var(--primary);
}

.tutorial-progress {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin-bottom: 20px;
}

.tutorial-progress-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: var(--plot-empty);
    transition: all 0.3s;
}

.tutorial-progress-dot.active {
    background: var(--primary);
    transform: scale(1.3);
}

.tutorial-progress-dot.completed {
    background: var(--accent);
}

.tutorial-buttons {
    display: flex;
    gap: 12px;
    justify-content: center;
    margin-bottom: 15px;
}

.tutorial-btn {
    padding: 12px 24px;
    border-radius:  50px !important;
    border: none;
    font-size: 14px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.2s;
    min-width: 100px;
}

.tutorial-btn-primary {
    background: var(--primary);
    color: white;
}

.tutorial-btn-primary:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
}

.tutorial-btn-secondary {
    background: var(--bg-body);
    color: var(--text-main);
    border: 1px solid var(--shadow);
}

.tutorial-btn-secondary:hover {
    background: var(--plot-empty);
}

.tutorial-btn-skip {
    background: transparent;
    color: var(--text-secondary);
    font-size: 12px;
    padding: 8px 15px;
    width: 100%;
}

.tutorial-btn-skip:hover {
    color: var(--text-main);
}

.tutorial-step-counter {
    font-size: 12px;
    color: var(--text-secondary);
}

/* Estilos para o modal de in√≠cio de foco */
#startFocusModalOverlay {
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%;
    background: rgba(0,0,0,0.8); 
    z-index: 4000; 
    display: none;
    align-items: center; 
    justify-content: center; 
    backdrop-filter: blur(5px);
}

#startFocusModalContent {
    background: var(--bg-panel); 
    width: 95%; 
    max-width: 400px;
    border-radius: 25px; 
    padding: 25px; 
    text-align: center;
    position: relative;
}

.dont-show-again {
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 15px 0;
    gap: 8px;
    font-size: 14px;
    color: var(--text-secondary);
}

.dont-show-again input[type="checkbox"] {
    min-height: 20px;
    min-width: 20px;
    height: 20px;
    width: 20px;
    margin: 0;
    cursor: pointer;
}

.dont-show-again label {
    font-size: 14px;
    cursor: pointer;
    user-select: none;
}

/* =========================
   ESTILOS 3D ISOM√âTRICO - RESPONSIVO
   ========================= */
#jardim3D {
    display: none;
    position: relative;
    margin-top: 5px;
    width: 100%;
    height: auto;
    min-height: 300px; /* Reduzido para caber em telas menores */
    max-height: 50vh; /* Reduzido para dar espa√ßo ao painel */
    overflow: visible;
}

.scene-3d {
    perspective: 1200px;
    perspective-origin: 50% 50%;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    transform-origin: center center;
}

.grid-container-3d {
    display: grid;
    grid-template-columns: repeat(5, var(--cell-3d-size));
    grid-template-rows: repeat(5, var(--cell-3d-size));
    gap: 2px;
    transform: rotateX(60deg) rotateZ(45deg) scale(var(--scale-3d, 1)); /* Adicionado scale para ajuste */
    transform-style: preserve-3d;
    position: relative;
    background-color: var(--grid-border);
    padding: 2px;
    transition: all 0.5s ease;
    transform-origin: center center; /* Origem da transforma√ß√£o no centro */
    will-change: transform; /* Otimiza√ß√£o para performance */
}

.cell-3d {
    width: var(--cell-3d-size);
    height: var(--cell-3d-size);
    background-color: var(--grid-color);
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 40 40"><path d="M5 35 L10 30 L15 35 Z" fill="%237db336" opacity="0.7"/><path d="M25 15 L30 10 L35 15 Z" fill="%237db336" opacity="0.7"/></svg>');
    background-size: 40px 40px;
    background-repeat: repeat;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background 0.2s, transform 0.2s;
    position: relative;
    user-select: none;
    transform-style: preserve-3d;
    overflow: visible; /* Garante que o bot√£o de carinho n√£o seja cortado */
}

.cell-3d:hover {
    background-color: color-mix(in srgb, var(--grid-color) 80%, white);
    transform: translateZ(10px);
}

.cell-3d.alvo {
    outline: 3px dashed var(--primary);
    outline-offset: -3px;
    animation: pulsar 1.5s infinite, aproximarSuave 1.5s infinite ease-in-out;
    z-index: 5;
}

/* Profundidade do bloco (terra) */
.grid-container-3d::before {
    content: '';
    position: absolute;
    top: 100%;
    left: 0;
    width: 100%;
    height: 20px;
    background: var(--side-color);
    transform-origin: top;
    transform: rotateX(-90deg);
}

.grid-container-3d::after {
    content: '';
    position: absolute;
    top: 0;
    left: 100%;
    width: 20px;
    height: 100%;
    background: var(--bottom-color);
    transform-origin: left;
    transform: rotateY(90deg);
}

/* Emojis 3D - TAMANHO AJUSTADO PROPORCIONALMENTE */
.emoji-3d {
    font-size: calc(var(--cell-3d-size) * 0.79); /* Tamanho responsivo e proporcional */
    pointer-events: none;
    display: block;
    user-select: none;
    position: absolute;
    transform: rotateZ(-45deg) rotateX(-90deg) translateY(calc(var(--cell-3d-size) * -0.46)) scaleY(1);
    filter: none;
    z-index: 10;
    transition: all 0.3s ease;
}

.emoji-3d.plant-spawn {
    animation: spawn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.emoji-3d.lucky-glow {
    filter: drop-shadow(0 0 5px var(--accent));
    animation: glowPulse 2s infinite ease-in-out;
}

.emoji-3d.crescendo {
    animation: crescer 0.5s ease-out forwards;
}

.emoji-3d.fantasma {
    opacity: 0.3;
    filter: grayscale(1) drop-shadow(0 1px 1px rgba(0,0,0,0.2));
}

/* CORRE√á√ÉO: Estilo espec√≠fico para modo Natal - apenas altera background-image */
body.natal-mode .cell-3d {
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 40 40"><path d="M5 35 L10 30 L15 35 Z" fill="%23cccccc" opacity="0.7"/><path d="M25 15 L30 10 L35 15 Z" fill="%23cccccc" opacity="0.7"/></svg>');
}

/* Ajustes para grid 10x10 no 3D */
body.grid-10x10 #jardim3D {
    min-height: 400px;
    max-height: 85vh;
}

body.grid-10x10 .grid-container-3d {
    grid-template-columns: repeat(10, var(--cell-3d-size));
    grid-template-rows: repeat(10, var(--cell-3d-size));
    transform: rotateX(60deg) rotateZ(45deg) scale(calc(var(--scale-3d, 1) * 0.9)); /* Escala menor para 10x10 */
}

/* Responsividade 3D - MOBILE PRIORITY */
@media (max-width: 899px) {
    :root {
        --cell-3d-size: 12vw; /* Usando viewport width para ser responsivo */
    }
    
    #jardim3D {
        height: 70vw; /* Altura proporcional √† largura */
        max-height: 70vh;
        min-height: 250px;
    }
    
    .grid-container-3d {
        transform: rotateX(60deg) rotateZ(45deg) scale(0.9); /* Escala menor em mobile */
    }
    
    /* Grid 10x10 em mobile */
    body.grid-10x10 #jardim3D {
        height: 85vw;
        max-height: 80vh;
    }
    
    body.grid-10x10 .grid-container-3d {
        transform: rotateX(60deg) rotateZ(45deg) scale(0.8) !important;
    }
}

/* Responsividade 3D - TABLET */
@media (min-width: 600px) and (max-width: 899px) {
    :root {
        --cell-3d-size: 14vw;
    }
    
    #jardim3D {
        height: 65vw;
        max-height: 65vh;
    }
    
    .grid-container-3d {
        transform: rotateX(60deg) rotateZ(45deg) scale(1);
    }
    
    body.grid-10x10 #jardim3D {
        height: 80vw;
    }
}

/* Responsividade 3D - DESKTOP */
@media (min-width: 900px) {
    :root {
        --cell-3d-size: 16vw; /* Ajustado para responsivo */
    }
    
    #jardim3D {
        height: 60vw;
        max-height: 620px;
        max-width: 800px;
        margin: 20px auto;
    }
    
    .grid-container-3d {
        transform: rotateX(60deg) rotateZ(45deg) scale(1.1);
    }
    
    /* Grid 10x10 em desktop */
    body.grid-10x10 #jardim3D {
        height: 65vw;
        max-height: 550px;
    }
    
    body.grid-10x10 .grid-container-3d {
        transform: rotateX(60deg) rotateZ(45deg) scale(1) !important;
    }
}

/* Ajustes para telas muito pequenas (celulares antigos) */
@media (max-width: 360px) {
    :root {
        --cell-3d-size: 14vw;
    }
    
    #jardim3D {
        height: 75vw;
        max-height: 75vh;
    }
    
    .grid-container-3d {
        transform: rotateX(60deg) rotateZ(45deg) scale(0.8);
    }
    
    body.grid-10x10 #jardim3D {
        height: 90vw;
    }
}

/* Ajustes para orienta√ß√£o paisagem (landscape) */
@media (max-height: 600px) and (orientation: landscape) {
    #jardim3D {
        height: 50vh !important;
        max-height: 50vh !important;
    }
    
    .grid-container-3d {
        transform: rotateX(60deg) rotateZ(45deg) scale(0.8) !important;
    }
    
    body.grid-10x10 #jardim3D {
        height: 60vh !important;
    }
}

/* Classe para for√ßar redimensionamento quando necess√°rio */
.grid-container-3d.ajustado {
    transform: rotateX(60deg) rotateZ(45deg) scale(var(--scale-3d, 1)) !important;
}

/* Bot√£o de altern√¢ncia 3D */
#btnToggle3D:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0,0,0,0.3);
}
/* Estilo para bot√µes desabilitados */
.ios-switch.disabled {
    opacity: 0.5;
    cursor: not-allowed;
    pointer-events: none;
}

.ios-switch.disabled .ios-switch-thumb {
    background-color: #cccccc;
}

.ios-switch.disabled.on {
    background-color: #cccccc;
}
/* =========================
   ESTILOS DO INVENT√ÅRIO
   ========================= */
#inventarioOverlay {
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%;
    background: rgba(0,0,0,0.6); 
    z-index: 3000; 
    display: none;
    align-items: center; 
    justify-content: center; 
    backdrop-filter: blur(8px);
    transition: all 0.3s ease;
}

#inventarioContent {
    background: var(--bg-panel); 
    width: 95%; 
    max-width: 500px; 
    max-height: 85vh;
    border-radius: 28px; 
    padding: 30px; 
    overflow-y: auto; 
    position: relative;
    box-shadow: 0 20px 50px rgba(0,0,0,0.3);
    border: 1px solid rgba(255,255,255,0.1);
}

/* CORRE√á√ÉO: Invent√°rio acima de tudo (Menu √© 10000, Avisos s√£o 20000) */
#inventarioOverlay {
    z-index: 25000 !important; 
}

/* Ajuste para o conte√∫do do invent√°rio */
#inventarioContent {
    z-index: 25001 !important;
    max-height: 80vh; /* Garante que cabe na tela */
    display: flex;
    flex-direction: column;
}

#listaInventario {
    overflow-y: auto;
    padding-bottom: 20px;
    flex: 1; /* Ocupa o espa√ßo restante */
}

/* Garante que o input de venda n√£o fique espremido */
.controle-venda-container {
    display: flex; 
    gap: 8px; 
    align-items: center; 
    justify-content: center;
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid rgba(0,0,0,0.05);
}
/* Estilo para o Contador de Dias Consecutivos */
.streak-display {
    position: fixed; /* Garante que fique fixo na tela */
    top: 15px;       /* Dist√¢ncia do topo */
    left: 50%;       /* Posiciona no meio horizontal */
    transform: translateX(-50%); /* Centraliza perfeitamente */
    z-index: 10000;  /* Garante que fique acima do cen√°rio e modais */
    
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    
    background: rgba(255, 255, 255, 0.95);
    padding: 8px 20px;
    border-radius: 30px;
    border: 2px solid #ff7f50; /* Cor de destaque (fogo/laranja) */
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    font-weight: bold;
    color: #333;
    font-size: 16px;
    pointer-events: none; /* Permite clicar atrav√©s dele se necess√°rio */
    white-space: nowrap; /* Impede que o texto quebre em telas pequenas */
}

/* √çcone de fogo animado */
.streak-icon {
    font-size: 1.2em;
    animation: pulseFire 1.5s infinite alternate;
}

@keyframes pulseFire {
    from { transform: scale(1); filter: brightness(100%); }
    to { transform: scale(1.2); filter: brightness(120%); }
}

/* Ajuste espec√≠fico para Telas Muito Pequenas (iPhone SE, Galaxy Fold fechado) */
@media (max-width: 350px) {
    .streak-display {
        font-size: 13px;
        padding: 5px 12px;
        top: 10px;
    }
}
/* --- CORRE√á√ÉO: DIAS CONSECUTIVOS NO TOPO FIXO --- */
/* VERS√ÉO "GORDINHA" DO CONTADOR */
#streakBadge {
    position: fixed !important;
    top: 15px !important;
    left: 50% !important;
    transform: translateX(-50%) !important;
    z-index: 10000 !important;

    /* Visual mais robusto (gordinho) */
    background: linear-gradient(135deg, #ff5722, #ff9800);
    color: white;
    padding: 10px 22px !important;    /* Mais estofado nas laterais e altura */
    border-radius: 50px !important;   /* Totalmente arredondado */
    font-size: 14px !important;       /* Fonte levemente maior */
    font-weight: 900 !important;       /* M√°ximo peso da fonte (negrito pesado) */
    
    display: inline-flex;
    align-items: center;
    gap: 8px;
    
    /* Sombra mais forte para parecer que flutua */
    box-shadow: 0 6px 20px rgba(255, 87, 34, 0.4) !important;
    border: 2px solid rgba(255, 255, 255, 0.4) !important;
    
    text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
    letter-spacing: 0.5px;
}

/* √çcone de fogo um pouco maior */
#streakBadge span {
    font-size: 1.2em;
}

#streakBadge:hover {
    transform: translateX(-50%) scale(1.05) !important; /* Efeito de zoom mantendo o centro */
}

/* Ajuste fino para telas MUITO pequenas (tipo Galaxy Fold fechado ou Z Flip Cover Screen) */
@media (max-width: 380px) {
    #streakBadge {
        font-size: 10px !important;
        padding: 4px 10px !important;
        top: 10px !important;
    }
    .painel-controle {
        padding: 8px 5px !important;
        width: 98% !important;
        margin-top: 5px !important;
    }
    #timer {
        font-size: 32px !important;
        margin: 2px 0 !important;
    }
    #mainButtons button {
        font-size: 11px !important;
        padding: 8px 4px !important;
    }
    #tempoEscolhido, #motivoEscolhido {
        font-size: 11px !important;
        min-width: 65px !important;
        padding: 2px !important;
    }
    /* Ajuste para telas quadradas ou curtas (Z Flip Cover Screen) */
    @media (max-height: 500px) or (max-aspect-ratio: 1/1) {
        #conteudo {
            padding-top: 60px !important;
            padding-bottom: 100px !important; /* Espa√ßo extra no final para garantir scroll */
            height: auto !important;
            min-height: 100vh !important;
            overflow: visible !important;
        }
        #jardim {
            margin: 10px auto !important;
            grid-template-columns: repeat(5, 45px) !important;
            gap: 8px !important;
        }
        #jardim .plot {
            width: 45px !important;
            height: 45px !important;
            font-size: 22px !important;
        }
        .painel-controle {
            margin-top: 15px !important;
            margin-bottom: 30px !important;
            width: 95% !important;
            max-width: 350px !important;
        }
        #timer {
            font-size: 40px !important;
        }
    }
}
/* Container principal para o efeito */
.grid-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: #000; /* Fundo preto profundo */
    overflow: hidden;
    z-index: -1; /* Fica atr√°s de toda a interface do jogo */
}

/* Cria a perspectiva 3D */
.grid-perspective {
    position: absolute;
    width: 100%;
    height: 200%;
    bottom: 0;
    perspective: 500px;
}

/* As linhas do grid */
.grid-lines {
    position: absolute;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    background-image: 
        linear-gradient(to right, rgba(0, 255, 255, 0.3) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(0, 255, 255, 0.3) 1px, transparent 1px);
    background-size: 50px 50px; /* Tamanho dos quadrados */
    transform: rotateX(60deg);
    transform-origin: center bottom;
    animation: moveGrid 2s linear infinite; /* Faz o grid andar */
}

/* Efeito de brilho/n√©on nas linhas */
.grid-lines::after {
    content: "";
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    box-shadow: inset 0px 0px 100px 50px rgba(0, 0, 0, 0.9); /* Suaviza as bordas */
}

/* Overlay para criar o gradiente de horizonte (roxo/azul) */
.grid-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(to bottom, 
        rgba(0, 0, 0, 1) 0%, 
        rgba(0, 0, 0, 0.5) 50%, 
        rgba(75, 0, 130, 0.2) 100%);
    pointer-events: none;
}

/* Anima√ß√£o para dar movimento ao grid */
@keyframes moveGrid {
    from { background-position: 0 0; }
    to { background-position: 0 50px; }
}
/* ============================================================
   REESTRUTURA√á√ÉO MOBILE DEFINITIVA (GARDEN FOCUS)
   ============================================================ */

@media (max-width: 899px) {
    /* 1. FOR√áAR ORDEM E FLUXO (GRID ACIMA DE TUDO) */
    #conteudo {
        display: flex !important;
        flex-direction: column !important;
        height: auto !important;
        min-height: 100vh !important;
        padding-top: 60px !important; /* Espa√ßo reduzido para Streak e Bot√µes */
        padding-bottom: 80px !important;
        justify-content: flex-start !important;
        align-items: center !important;
        gap: 0 !important; /* Controle manual de margens */
    }

    /* Move o Jardim para o topo absoluto dentro do container */
    #jardim, #jardim3D { 
        order: -1 !important; 
        margin: 10px auto 20px auto !important;
    }

    /* 2. AMPLIA√á√ÉO F√çSICA DO GRID (Aumenta o tamanho real) */
    /* Grid Normal (5x5) */
    #jardim {
        grid-template-columns: repeat(5, 65px) !important; /* Aumentado de 45px para 65px */
        gap: 12px !important;
    }
    #jardim .plot {
        width: 65px !important;
        height: 65px !important;
        font-size: 32px !important;
        border-radius: 15px !important;
    }

    /* Grid Denso (10x10) - Amplia√ß√£o M√°xima para Mobile */
    body.grid-10x10 #jardim {
        grid-template-columns: repeat(10, 32px) !important; /* Aumentado de 28px para 32px */
        gap: 3px !important;
        width: fit-content !important;
    }
    body.grid-10x10 .plot {
        width: 32px !important;
        height: 32px !important;
        font-size: 18px !important;
        border-radius: 6px !important;
    }

    /* 3. CORRE√á√ÉO DO PAINEL INTELIGENTE E CONTROLES */
    .painel-controle {
        order: 1 !important;
        width: 98% !important;
        max-width: 400px !important;
        padding: 10px 5px !important;
        margin: 0 auto !important;
        box-sizing: border-box !important;
    }

    #timer {
        font-size: 45px !important;
        margin: 5px 0 !important;
    }

    #mainButtons button {
        padding: 10px 5px !important;
        font-size: 13px !important;
    }

    #painelInteligencia {
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
        font-size: 12px !important;
        padding: 8px !important;
        white-space: normal !important;
        height: auto !important;
        margin-bottom: 10px !important;
    }

    /* 4. CORRE√á√ÉO DO STREAK E BOT√ïES DE TOPO */
    #streakBadge {
        display: inline-flex !important;
    }
    #streakBadgeSide {
        display: none !important;
    }

    /* 5. ELIMINAR ESPA√áO VAGO */
    #painelMotivo {
        order: 2 !important;
        margin-top: 10px !important;
    }
}

/* 6. MODO PAISAGEM (LANDSCAPE) - ROLAGEM OBRIGAT√ìRIA */
@media (max-height: 500px) {
    body, html { overflow: auto !important; height: auto !important; }
    #conteudo { height: auto !important; display: flex !important; }
}

/* 7. GARANTIA DE CAMADAS (Z-INDEX) */
#estanteOverlay, #configOverlay, #lojaOverlay, #romanceOverlay, #customAlertOverlay {
    z-index: 40000 !important;
}

/* Efeito de Zoom ao Tocar (Feedback) */
.plot:active {
    transform: scale(1.15) !important;
    z-index: 50 !important;
}
/* LIVRO SIMPLES NO CANTO */
.livro-clicavel {
    position: fixed;
    bottom: 20px;
    right: 20px;
    font-size: 40px;
    cursor: pointer;
    z-index: 9999;
    background: #5d4037;
    padding: 10px;
    border-radius: 10px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.5);
}

/* ABA ESQUERDA - √ÅREA DE ESCREVER */
.bloco-diario-input {
    background: rgba(0,0,0,0.2);
    padding: 10px;
    border-radius: 8px;
    margin: 10px 0;
}

.bloco-diario-input textarea {
    width: 100%;
    height: 60px;
    margin: 5px 0;
    border-radius: 5px;
    border: none;
    padding: 5px;
}

/* MODAL DO DI√ÅRIO */
.modal-diario {
    display: none;
    position: fixed;
    top:0; left:0; width:100%; height:100%;
    background: rgba(0,0,0,0.9);
    z-index: 10000;
    color: #333;
    justify-content: center;
    align-items: center;
}

.caderno-folha {
    background: #fff;
    width: 90%;
    max-width: 400px;
    height: 70vh;
    padding: 20px;
    border-radius: 5px;
    overflow-y: auto;
}
/* =========================
   CAMADA DA ESTRADA (CORRE√á√ÉO)
   ========================= */
.path-layer {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-size: cover;
    background-repeat: no-repeat;
    pointer-events: none; /* Deixa clicar atrav√©s da estrada */
    z-index: 1; /* Fica logo acima do ch√£o, mas abaixo de pets/itens */
    transform-style: preserve-3d;
}

/* Removemos a borda e o fundo espec√≠fico da c√©lula base quando √© caminho, 
   para garantir que o estilo do tema (grama/cor) prevale√ßa */
.cell-3d.is-path {
    border-color: rgba(0,0,0,0.05); 
}


</style>
</head>
<body id="mainBody">



<canvas id="bgCanvas"></canvas>
<div id="starsContainer"></div>




<!-- Novo overlay para primeiro uso -->
<div id="firstTimeOverlay" style="display: none;">
    <div id="firstTimeContent">
        <button style="border-radius: 50px !important;" class="close-btn" onclick="pularPrimeiroUso()">√ó</button>
        <div id="firstTimeStep2" class="first-time-step" style="display: block;">
            <div class="first-time-emoji">üë§</div>
            <h3>Como gostaria de ser chamado?</h3>
            <p>Digite seu nome abaixo para personalizar sua experi√™ncia:</p>
            
            <input type="text" id="firstTimeNameInput" placeholder="Seu nome..." style="width: 90%; padding: 12px; border-radius: 10px; border: 2px solid var(--primary); font-size: 16px; margin: 15px 0;">
            
            <div class="first-time-buttons">
                <button style="border-radius: 50px !important;" onclick="finalizarPrimeiroUso()">Come√ßar a focar!</button>
            </div>
        </div>
    </div>
</div>

<!-- TUTORIAL INTERATIVO (SIMPLIFICADO) -->
<div id="tutorialOverlay" style="display: none;">
    <div class="tutorial-card" id="tutorialCard">
        <div class="tutorial-icon" id="tutorialIcon">üå±</div>
        <div class="tutorial-title" id="tutorialTitle">Bem-vindo!</div>
        <div class="tutorial-text" id="tutorialText">Texto do tutorial</div>
        <div class="tutorial-location" id="tutorialLocation" style="display: none;">
            üìç <span id="tutorialLocationText">Localiza√ß√£o</span>
        </div>
        <div class="tutorial-progress" id="tutorialProgress"></div>
        <div class="tutorial-buttons">
            <button style="border-radius: 50px !important;" class="tutorial-btn tutorial-btn-secondary" id="tutorialPrevBtn" onclick="tutorialAnterior()">Anterior</button>
            <button style="border-radius: 50px !important;" class="tutorial-btn tutorial-btn-primary" id="tutorialNextBtn" onclick="tutorialProximo()">Pr√≥ximo</button>
        </div>
        <button style="border-radius: 50px !important;" class="tutorial-btn tutorial-btn-skip" id="tutorialSkipBtn" onclick="tutorialPular()">Pular Tutorial</button>
        <div class="tutorial-step-counter" id="tutorialStepCounter">Passo 1 de 5</div>
    </div>
</div>

<!-- Modal para in√≠cio de foco -->
<div id="startFocusModalOverlay">
    <div id="startFocusModalContent" class="modal-anim-in">
        <h3 style="color: var(--primary); margin-top:0;">Hora de focar! Boa sess√£o! ‚è±Ô∏è</h3>
        
        <div style="display:flex; gap:10px; margin-top:15px;">
    <button 
        class="secundario"
        onclick="closeStartFocusModal(false)"
        style="width:100%; border-radius: 50px !important;">
        Cancelar
    </button>

    <button 
        onclick="closeStartFocusModal(true)"
        style="width:100%; border-radius: 50px !important;">
        Iniciar agora
    </button>
</div>
    </div>
</div>

<!-- NOVO: Modal para adicionar foco manual -->
<div id="aviso3DOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 5000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px);">
    <div id="aviso3DContent" style="background: var(--bg-panel); width: 90%; max-width: 400px; border-radius: 25px; padding: 25px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
        <h3 style="color: var(--accent); margin-top: 0;">Aviso: Modo 3D Experimental</h3>
        <p>O modo 3D √© uma funcionalidade nova e pode apresentar instabilidades ou consumir mais recursos do seu dispositivo.</p>
        <p>Se notar lentid√£o ou erros, por favor, volte para o modo 2D.</p>
        <button onclick="fecharAviso3D()" style="margin-top: 15px; border-radius: 50px !important;">Entendi, Continuar</button>
    </div>
</div>

<div id="manualFocusOverlay">
    <div id="manualFocusContent">
        <h3 style="color: var(--primary); margin-top:0;">Adicionar Foco Manual</h3>
        <p id="manualFocusText" style="margin: 20px 0;">Aviso: adicionar imediatamente um foco em <strong id="manualMotivo">[motivo]</strong> por <strong id="manualTempo">[tempo]</strong> min?</p>
        <div style="display: flex; justify-content: center; gap: 10px;">
            <button onclick="confirmarFocoManual()" style="flex:1; border-radius: 50px !important;">Ok</button>
            <button onclick="fecharModal('manualFocusOverlay')" class="secundario" style="flex:1; border-radius: 50px !important;">Cancelar</button>
        </div>
    </div>
</div>

<audio id="audioChuva" loop>
    <source src="data:audio/wav;base64,UklGRmSBAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YX6BAAA=" type="audio/wav">
</audio>
<audio id="audioVento" loop>
    <source src="data:audio/wav;base64,UklGRmSBAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YX6BAAA=" type="audio/wav">
</audio>

<div id="dashboardOverlay">
    <div id="dashboardContent">
        <h2 style="color: var(--primary)">üìä Painel de Foco</h2>
        <div class="dashboard-periodo">
            <button style="border-radius: 50px !important;" onclick="mostrarDashboardPeriodo('semanal')" id="btnDashboardSemanal" class="active">Semanal</button>
            <button style="border-radius: 50px !important;" onclick="mostrarDashboardPeriodo('mensal')" id="btnDashboardMensal">Mensal</button>
            <button style="border-radius: 50px !important;" onclick="mostrarDashboardPeriodo('anual')" id="btnDashboardAnual">Anual</button>
            <button style="border-radius: 50px !important;" onclick="mostrarDashboardPeriodo('grid3d')" id="btnDashboardGrid3d">Floresta 3D</button>
        </div>
        <div class="dashboard-container" id="dashboardContainerSemanal"></div>
        <div class="dashboard-container" id="dashboardContainerMensal" style="display: none;"></div>
        <div class="dashboard-container" id="dashboardContainerAnual" style="display: none;"></div>
        <div class="dashboard-container" id="dashboardContainerGrid3d" style="display: none; min-height: 450px; position: relative; overflow-x: auto; overflow-y: hidden; background: var(--bg-body); border-radius: 20px; padding: 20px;"></div>
        <button onclick="fecharModal('dashboardOverlay')" class="secundario" style="width:100%; margin-top:20px; border-radius: 50px !important;">Fechar Painel</button>
    </div>
</div>



<div id="debugOverlay">
    <div id="debugContent">
        <h2 style="color: var(--primary)">üõ†Ô∏è Painel de Testes (Debug)</h2>
        <div style="display: flex; flex-direction: column; gap: 10px;">
            <button onclick="fillGridTest()" style="background: #2196f3; border-radius: 50px !important; ">Preencher Todo o Grid (Ciclo Final)</button>
            <button onclick="addMaxStarsTest()" style="background: var(--accent); color: #333; border-radius: 50px !important; ">Adicionar 5 Estrelas no C√©u</button>
            <button onclick="simularSucessosTest()" style="background: var(--primary); border-radius: 50px !important; ">Gerar Hist√≥rico (Ativar Relat√≥rio)</button>
            <button onclick="debugAdicionar100Arvores()" style="background: #4caf50; border-radius: 50px !important; ">üå≥ Debug: +100 √Årvores (Ano Atual)</button>
            
            <!-- NOVO: Bot√£o para alternar entre 5x5 e 10x10 -->
            <button onclick="debugGanharPerola()" style="width:100%; background: #9c27b0; color: white; margin-top: 10px; border-radius: 50px !important; ">‚ú® Debug: +1 P√©rola ü¶™</button>

            <button onclick="ganharMoedasDebug()" style="background: #daa520; color: #333; font-weight: bold; border-radius: 50px !important; ">üí∞ Ganhar 200 Moedas (Debug)</button>
            
            <div style="border-top: 1px solid #eee; margin: 5px 0; padding-top: 5px;">
                <small style="color: #666; font-weight: bold;">Hist√≥rias & Metas:</small>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                <button onclick="debugAvancarEurosummer()" style="background: #ff9800; font-size: 11px; padding: 8px 5px; border-radius: 50px !important; ">+1 Eurosummer</button>
                <button onclick="debugAvancarFundoMar()" style="background: #00bcd4; font-size: 11px; padding: 8px 5px; border-radius: 50px !important; ">+1 Fundo do Mar</button>
                <button onclick="debugResetarHistorias()" style="background: #f44336; font-size: 11px; padding: 8px 5px; grid-column: span 2; border-radius: 50px !important; ">Resetar Hist√≥rias</button>
            </div>

            <button style="border-radius: 50px !important;" onclick="fecharModal('debugOverlay')" class="secundario">Fechar Debug</button>
        </div>
    </div>
</div>

<div id="estanteOverlay">
    <div id="estanteContent">
        <button style="border-radius: 50px !important;" class="help-btn" onclick="mostrarInfoEstante()">?</button>
        <h2 style="color: var(--primary)">üìö Minha Estante</h2>
        <div id="listaLivros" style="min-height: 200px;"></div>
        <button onclick="prepararNovoLivro()" style="width:100%; margin-top: 20px; border-radius: 50px !important;">+ Novo Livro</button>
        <button onclick="fecharModal('estanteOverlay')" class="secundario" style="width:100%; margin-top:10px; border-radius: 50px !important;">Fechar</button>
    </div>
</div>

<div id="diarioOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 45000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(10px);">
    <style>
        .book-container {
            width: 95%;
            max-width: 800px;
            height: 85vh;
            background: #f4e4bc;
            border-radius: 5px 20px 20px 5px;
            box-shadow: 20px 20px 60px rgba(0,0,0,0.5), inset 5px 0 15px rgba(0,0,0,0.2);
            display: flex;
            position: relative;
            overflow: hidden;
            border: 1px solid #d4c49c;
        }
        .book-spine {
            width: 30px;
            background: linear-gradient(to right, #8b4513, #a0522d, #8b4513);
            height: 100%;
            box-shadow: inset -2px 0 5px rgba(0,0,0,0.3);
        }
        .book-page {
            flex: 1;
            padding: 40px;
            display: flex;
            flex-direction: column;
            background-image: radial-gradient(#d4c49c 1px, transparent 1px);
            background-size: 20px 20px;
            background-position: 0 0;
            overflow-y: auto;
            position: relative;
        }
        .book-page::before {
            content: '';
            position: absolute;
            left: 0; top: 0; bottom: 0;
            width: 1px;
            background: rgba(0,0,0,0.1);
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
        }
        .book-title {
            font-family: 'Georgia', serif;
            color: #5d4037;
            text-align: center;
            border-bottom: 2px solid #8b4513;
            padding-bottom: 10px;
            margin-bottom: 30px;
            font-style: italic;
        }
        .diary-input-area {
            background: rgba(255,255,255,0.3);
            border-radius: 10px;
            padding: 20px;
            border: 1px dashed #8b4513;
            margin-bottom: 30px;
        }
        .diary-textarea {
            width: 100%;
            height: 150px;
            background: transparent;
            border: none;
            border-bottom: 1px solid rgba(139, 69, 19, 0.3);
            font-family: 'Courier New', Courier, monospace;
            font-size: 16px;
            line-height: 24px;
            resize: none;
            color: #3e2723;
            padding: 0;
            outline: none;
            background-image: linear-gradient(transparent, transparent 23px, rgba(139, 69, 19, 0.1) 23px);
            background-size: 100% 24px;
        }
        .diary-entry {
            background: rgba(255,255,255,0.5);
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 5px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.05);
            border-left: 5px solid #8b4513;
            font-family: 'Courier New', Courier, monospace;
        }
        .btn-book-close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 24px;
            cursor: pointer;
            color: #8b4513;
            z-index: 10;
            transition: transform 0.2s;
        }
        .btn-book-close:hover { transform: scale(1.2); }
        
        @media (max-width: 600px) {
            .book-container { flex-direction: column; height: 90vh; }
            .book-spine { width: 100%; height: 15px; }
            .book-page { padding: 20px; }
        }

        /* --- TEMAS ESPECIAIS DO DI√ÅRIO --- */

        /* MODO DARK (Geral) */
        body.dark-mode .book-container { background: #2c2c2c; border-color: #444; color: #e0e0e0; box-shadow: 20px 20px 60px rgba(0,0,0,0.7); }
        body.dark-mode .book-page { background-image: radial-gradient(#444 1px, transparent 1px); }
        body.dark-mode .book-title { color: #fff; border-bottom-color: #555; }
        body.dark-mode .diary-input-area { background: rgba(0,0,0,0.2); border-color: #555; }
        body.dark-mode .diary-textarea { color: #e0e0e0; background-image: linear-gradient(transparent, transparent 23px, rgba(255,255,255,0.05) 23px); }
        body.dark-mode .diary-entry { background: rgba(255,255,255,0.05); border-left-color: #666; color: #ccc; }
        body.dark-mode .btn-book-close { color: #aaa; }
        body.dark-mode #diarioPaginaAtual { color: #aaa !important; }

        /* MODO MEDIEVAL */
        body.medieval-mode .book-container { background: #f4e4bc; border: 4px double #8b4513; border-radius: 0; font-family: 'Georgia', serif; }
        body.medieval-mode .book-spine { background: linear-gradient(to right, #5d4037, #8b4513, #5d4037); }
        body.medieval-mode .book-title { font-variant: small-caps; letter-spacing: 2px; }
        body.medieval-mode .diary-textarea { font-family: 'Georgia', serif; }
        body.medieval-mode .diary-entry { border-left: 8px solid #8b4513; background: rgba(139, 69, 19, 0.05); }
        
        body.dark-mode.medieval-mode .book-container { background: #3e2723; border-color: #8b4513; }
        body.dark-mode.medieval-mode .book-title { color: #d7ccc8; }
        body.dark-mode.medieval-mode .diary-textarea { color: #d7ccc8; }

        /* MODO CANDYFORNIA */
        body.candyfornia-mode .book-container { background: #fff0f5; border: 3px dashed #ff6bad; border-radius: 30px; }
        body.candyfornia-mode .book-spine { background: linear-gradient(to right, #ff6bad, #ffb7d5, #ff6bad); }
        body.candyfornia-mode .book-title { color: #ff6bad; border-bottom: 2px dashed #ffb7d5; font-family: 'Comic Sans MS', cursive; }
        body.candyfornia-mode .diary-input-area { background: #fff; border: 2px dashed #ffb7d5; border-radius: 20px; }
        body.candyfornia-mode .diary-textarea { color: #d63384; background-image: linear-gradient(transparent, transparent 23px, rgba(255, 107, 173, 0.1) 23px); }
        body.candyfornia-mode .diary-entry { background: #fff; border-left: 5px solid #ff6bad; border-radius: 15px; box-shadow: 5px 5px 0 rgba(255, 107, 173, 0.1); }
        body.candyfornia-mode .btn-book-close { color: #ff6bad; }
        body.candyfornia-mode #diarioPaginaAtual { color: #ff6bad !important; }

        body.dark-mode.candyfornia-mode .book-container { background: #4a1e36; border-color: #ff6bad; }
        body.dark-mode.candyfornia-mode .book-title { color: #ffb7d5; }
        body.dark-mode.candyfornia-mode .diary-textarea { color: #ffb7d5; }
        body.dark-mode.candyfornia-mode .diary-entry { background: rgba(0,0,0,0.3); }

        /* MODO EURO SUMMER */
        body.eurosummer-mode .book-container { background: #f0f8ff; border: 2px solid #0077be; border-radius: 10px; }
        body.eurosummer-mode .book-spine { background: linear-gradient(to right, #005b96, #0077be, #005b96); }
        body.eurosummer-mode .book-title { color: #005b96; border-bottom: 2px solid #0077be; font-family: 'Trebuchet MS', sans-serif; }
        body.eurosummer-mode .diary-input-area { background: rgba(255,255,255,0.8); border: 1px solid #0077be; border-radius: 10px; }
        body.eurosummer-mode .diary-textarea { color: #003366; background-image: linear-gradient(transparent, transparent 23px, rgba(0, 119, 190, 0.1) 23px); }
        body.eurosummer-mode .diary-entry { background: #fff; border-left: 5px solid #0077be; border-radius: 0; box-shadow: 3px 3px 10px rgba(0, 119, 190, 0.1); }
        body.eurosummer-mode .btn-book-close { color: #005b96; }
        body.eurosummer-mode #diarioPaginaAtual { color: #005b96 !important; }

        body.dark-mode.eurosummer-mode .book-container { background: #001d3d; border-color: #003566; }
        body.dark-mode.eurosummer-mode .book-title { color: #4cc9f0; }
        body.dark-mode.eurosummer-mode .diary-textarea { color: #4cc9f0; }
        body.dark-mode.eurosummer-mode .diary-entry { background: rgba(0, 53, 102, 0.5); }
    </style>
    <div class="book-container" id="diarioContent">
        <div class="book-spine"></div>
        <div class="book-page">
            <span class="btn-book-close" onclick="fecharModal('diarioOverlay')">‚úï</span>
            <h2 class="book-title">üìî Di√°rio de Reflex√µes</h2>
            
            <!-- √Årea de Conte√∫do da P√°gina (Input ou Mem√≥ria) -->
            <div id="diarioPaginaConteudo" style="min-height: 400px; display: flex; flex-direction: column;">
                <!-- O conte√∫do ser√° injetado aqui via JS -->
            </div>
            
            <!-- Controles de Pagina√ß√£o -->
            <div id="diarioPaginacao" style="display: flex; justify-content: center; align-items: center; gap: 20px; margin-top: 20px; padding-top: 15px; border-top: 1px dashed rgba(139, 69, 19, 0.3);">
                <button onclick="mudarPaginaDiario(-1)" id="btnDiarioAnterior" style="background: #8b4513; color: white; border: none; border-radius: 50%; width: 35px; height: 35px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">‚ùÆ</button>
                <span id="diarioPaginaAtual" style="font-family: 'Georgia', serif; color: #5d4037; font-weight: bold; font-size: 14px;">P√°gina 1 de 1</span>
                <button onclick="mudarPaginaDiario(1)" id="btnDiarioProximo" style="background: #8b4513; color: white; border: none; border-radius: 50%; width: 35px; height: 35px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">‚ùØ</button>
            </div>
        </div>
    </div>
</div>


<div id="lojaOverlay">
    <div id="lojaContent">
        <h2 style="color: #daa520;">üõí Loja do Jardim</h2>
        <div class="moedas-display-loja">Minhas Moedas: <span id="saldoLojaMoedas">0</span> üí∞</div>
        
        
                <div class="loja-grid">
    <div class="loja-secao-titulo">üåç Temas do Jardim</div>
    
    <div class="item-loja">
        <div>üéÑ Natal</div>
        <small>Clima Festivo</small>
        <div class="ios-switch-container" style="margin-top: 5px;">
            <div id="btnNatal" class="ios-switch" onclick="toggleNatal()">
                <div class="ios-switch-thumb"></div>
            </div>
        </div>
    </div>
    <div class="item-loja">
        <div>üè∞ Medieval</div>
        <small>Um reino tranquilo</small>
        <div id="containerMedievalLoja">
            <button style="border-radius: 50px !important;" id="btnComprarMedieval" onclick="comprarItemLoja('medieval', 50)">50 üí∞</button>
        </div>
    </div>
    <div class="item-loja">
        <div>üç≠ Candyfornia</div>
        <small>Mundo de Doces</small>
        <div id="containerCandyforniaLoja">
            <button style="border-radius: 50px !important;" id="btnComprarCandyfornia" onclick="comprarItemLoja('candyfornia', 80)">80 üí∞</button>
        </div>
    </div>
    <div class="item-loja">
        <div>üèõÔ∏è Eurosummer</div>
        <small>Di√°rio do Mediterr√¢neo</small>
        <div style="font-size: 10px; color: var(--text-secondary); margin-top: 4px; font-style: italic; line-height: 1.2; max-width: 150px; margin-bottom: 5px; text-align: justify; margin-left: auto; margin-right: auto;">
            üìñ <b>Modo Hist√≥ria:</b> Desbloqueia mem√≥rias e itens exclusivos a cada 3 sess√µes de foco. Viva uma narrativa nost√°lgica na Riviera Italiana.
        </div>
        <div id="containerEurosummerLoja">
            <button style="border-radius: 50px !important;" id="btnComprarEurosummer" onclick="comprarItemLoja('eurosummer', 100)">100 üí∞</button>
        </div>
    </div>
    <div class="item-loja">
        <div>üßú‚Äç‚ôÄÔ∏è Reino de Coral</div>
        <small>Fundo do Mar</small>
        <div style="font-size: 10px; color: var(--text-secondary); margin-top: 4px; font-style: italic; line-height: 1.2; max-width: 150px; margin-bottom: 5px; text-align: justify; margin-left: auto; margin-right: auto;">
            üìñ <b>Modo Hist√≥ria:</b> Desbloqueia mem√≥rias subaqu√°ticas e itens exclusivos a cada 3 sess√µes de foco. Viva uma narrativa moderna no fundo do oceano.
        </div>
        <div id="containerFundoMarLoja">
            <button style="border-radius: 50px !important;" id="btnComprarFundoMar" onclick="comprarItemLoja('fundomar', 120)">120 üí∞</button>
        </div>
        
    </div>
   


        <div class="loja-secao-titulo" id="tituloSecaoPets">üìè Licen√ßa de Ado√ß√£o (Terrestres M√°x: 2 | Aqu√°ticos: Sem Limite)</div>
        
        <!-- Animais Fundo do Mar (Apenas se comprado) -->
        <div id="secaoPetsFundoMar" style="display: contents;">
            <div class="item-loja" id="itemPetFish">
                <div style="font-size: 30px;">üêü</div>
                <small>Peixinho</small>
                <div style="font-size: 9px; color: #4cc9f0; margin-bottom: 5px;">‚ú® Meta 1</div>
                <button style="border-radius: 50px !important;" id="btnPetFish" onclick="processarCompraPet('üêü', 40, 'btnPetFish')">40 üí∞</button>
            </div>
            <div class="item-loja" id="itemPetTropicalFish">
                <div style="font-size: 30px;">üê†</div>
                <small>Peixe Tropical</small>
                <div style="font-size: 9px; color: #4cc9f0; margin-bottom: 5px;">‚ú® Meta 2</div>
                <button style="border-radius: 50px !important;" id="btnPetTropicalFish" onclick="processarCompraPet('üê†', 60, 'btnPetTropicalFish')">60 üí∞</button>
            </div>
            <div class="item-loja" id="itemPetBlowfish">
                <div style="font-size: 30px;">üê°</div>
                <small>Baiacu</small>
                <div style="font-size: 9px; color: #4cc9f0; margin-bottom: 5px;">‚ú® Meta 3</div>
                <button style="border-radius: 50px !important;" id="btnPetBlowfish" onclick="processarCompraPet('üê°', 80, 'btnPetBlowfish')">80 üí∞</button>
            </div>
            <div class="item-loja" id="itemPetOctopus">
                <div style="font-size: 30px;">üêô</div>
                <small>Polvo</small>
                <div style="font-size: 9px; color: #4cc9f0; margin-bottom: 5px;">‚ú® Meta 4</div>
                <button style="border-radius: 50px !important;" id="btnPetOctopus" onclick="processarCompraPet('üêô', 120, 'btnPetOctopus')">120 üí∞</button>
            </div>
            <div class="item-loja" id="itemPetTurtle">
                <div style="font-size: 30px;">üê¢</div>
                <small>Tartaruga</small>
                <div style="font-size: 9px; color: #4cc9f0; margin-bottom: 5px;">‚ú® Meta 5</div>
                <button style="border-radius: 50px !important;" id="btnPetTurtle" onclick="processarCompraPet('üê¢', 100, 'btnPetTurtle')">100 üí∞</button>
            </div>
            <div class="item-loja" id="itemPetOtter">
                <div style="font-size: 30px;">ü¶¶</div>
                <small>Lontra</small>
                <div style="font-size: 9px; color: #4cc9f0; margin-bottom: 5px;">‚ú® Meta 6</div>
                <button style="border-radius: 50px !important;" id="btnPetOtter" onclick="processarCompraPet('ü¶¶', 120, 'btnPetOtter')">120 üí∞</button>
            </div>
            <div class="item-loja" id="itemPetMermaid">
                <div style="font-size: 30px;">üßú‚Äç‚ôÄÔ∏è</div>
                <small>Sereia</small>
                <div style="font-size: 9px; color: #4cc9f0; margin-bottom: 5px;">‚ú® Meta 7 (Escolha)</div>
                <button style="border-radius: 50px !important;" id="btnPetMermaid" onclick="processarCompraPet('üßú‚Äç‚ôÄÔ∏è', 200, 'btnPetMermaid')">200 üí∞</button>
            </div>
            <div class="item-loja" id="itemPetMerman">
                <div style="font-size: 30px;">üßú‚Äç‚ôÇÔ∏è</div>
                <small>Trit√£o</small>
                <div style="font-size: 9px; color: #4cc9f0; margin-bottom: 5px;">‚ú® Meta 7 (Escolha)</div>
                <button style="border-radius: 50px !important;" id="btnPetMerman" onclick="processarCompraPet('üßú‚Äç‚ôÇÔ∏è', 200, 'btnPetMerman')">200 üí∞</button>
            </div>
            <div class="item-loja" id="itemPetSeal">
                <div style="font-size: 30px;">ü¶≠</div>
                <small>Foca</small>
                <div style="font-size: 9px; color: #4cc9f0; margin-bottom: 5px;">‚ú® Meta 8</div>
                <button style="border-radius: 50px !important;" id="btnPetSeal" onclick="processarCompraPet('ü¶≠', 150, 'btnPetSeal')">150 üí∞</button>
            </div>
            <div class="item-loja" id="itemPetWhale">
                <div style="font-size: 30px;">üêã</div>
                <small>Baleia</small>
                <div style="font-size: 9px; color: #4cc9f0; margin-bottom: 5px;">‚ú® Meta 9</div>
                <button style="border-radius: 50px !important;" id="btnPetWhale" onclick="processarCompraPet('üêã', 200, 'btnPetWhale')">200 üí∞</button>
            </div>
        </div>

    <div class="item-loja" id="itemLojaRena" style="display: none; border: 2px solid #e74c3c; background: #fff5f5;">
        <div style="font-size: 30px;">ü¶å</div>
        <small>Rena</small>
        <div style="font-size: 9px; color: #e74c3c; margin-bottom: 5px; font-weight: bold;">‚ú® +10 moedas no foco (Modo Natal)</div>
        <button style="border-radius: 50px !important;" id="btnPetReindeer" onclick="processarCompraPet('ü¶å', 150, 'btnPetReindeer')">150 üí∞</button>
    </div>

    <div class="item-loja">
        <div style="font-size: 30px;">ü¶Ü</div>
        <small>Pato</small>
        <div style="font-size: 9px; color: #666; margin-bottom: 5px;">‚ú® +2 moedas por carinho</div>
        <button style="border-radius: 50px !important;" id="btnPetDuck1" onclick="processarCompraPet('ü¶Ü', 50, 'btnPetDuck1')">50 üí∞</button>
    </div>
    <div class="item-loja">
        <div style="font-size: 30px;">ü™ø</div>
        <small>Ganso</small>
        <div style="font-size: 9px; color: #666; margin-bottom: 5px;">‚ú® B√¥nus de sorte +2</div>
        <button style="border-radius: 50px !important;" id="btnPetGoose" onclick="processarCompraPet('ü™ø', 60, 'btnPetGoose')">60 üí∞</button>
    </div>
    <div class="item-loja">
        <div style="font-size: 30px;">üêï</div>
        <small>C√£ozinho</small>
        <div style="font-size: 9px; color: #666; margin-bottom: 5px;">‚ú® Recupera 50% ao desistir</div>
        <button style="border-radius: 50px !important;" id="btnPetDog1" onclick="processarCompraPet('üêï', 80, 'btnPetDog1')">80 üí∞</button>
    </div>
    <div class="item-loja">
        <div style="font-size: 30px;">üêà</div>
        <small>Gatinho</small>
        <div style="font-size: 9px; color: #666; margin-bottom: 5px;">‚ú® +20% moedas de foco</div>
        <button style="border-radius: 50px !important;" id="btnPetCat1" onclick="processarCompraPet('üêà', 80, 'btnPetCat1')">80 üí∞</button>
    </div>
    <div class="item-loja">
        <div style="font-size: 30px;">üêñ</div>
        <small>Porquinho</small>
        <div style="font-size: 9px; color: #666; margin-bottom: 5px;">‚ú® 10% desconto na loja</div>
        <button style="border-radius: 50px !important;" id="btnPetPig" onclick="processarCompraPet('üêñ', 100, 'btnPetPig')">100 üí∞</button>
    </div>
    <div class="item-loja">
        <div style="font-size: 30px;">ü¶â</div>
        <small>Coruja</small>
        <div style="font-size: 9px; color: #666; margin-bottom: 5px;">‚ú® +5 moedas √† noite</div>
        <button style="border-radius: 50px !important;" id="btnPetOwl" onclick="processarCompraPet('ü¶â', 120, 'btnPetOwl')">120 üí∞</button>
    </div>
    <div class="item-loja">
        <div style="font-size: 30px;">ü¶´</div>
        <small>Castor</small>
        <div style="font-size: 9px; color: #666; margin-bottom: 5px;">‚ú® Constru√ß√µes 20% mais baratas</div>
        <button style="border-radius: 50px !important;" id="btnPetBeaver" onclick="processarCompraPet('ü¶´', 130, 'btnPetBeaver')">130 üí∞</button>
    </div>
    <div class="item-loja">
        <div style="font-size: 30px;">üêí</div>
        <small>Macaco</small>
        <div style="font-size: 9px; color: #666; margin-bottom: 5px;">‚ú® +10 moedas em metas</div>
        <button style="border-radius: 50px !important;" id="btnPetMonkey" onclick="processarCompraPet('üêí', 150, 'btnPetMonkey')">150 üí∞</button>
    </div>
    <div class="item-loja">
        <div style="font-size: 30px;">ü¶ô</div>
        <small>Lhama</small>
        <div style="font-size: 9px; color: #666; margin-bottom: 5px;">‚ú® +5 moedas por carinho</div>
        <button style="border-radius: 50px !important;" id="btnPetLlama" onclick="processarCompraPet('ü¶ô', 160, 'btnPetLlama')">160 üí∞</button>
    </div>
    <div class="item-loja">
        <div style="font-size: 30px;">üêÑ</div>
        <small>Vaquinha</small>
        <div style="font-size: 9px; color: #666; margin-bottom: 5px;">‚ú® Produz 5 moedas/hora</div>
        <button style="border-radius: 50px !important;" id="btnPetCow" onclick="processarCompraPet('üêÑ', 180, 'btnPetCow')">180 üí∞</button>
    </div>
    <div class="item-loja">
        <div style="font-size: 30px;">ü¶ö</div>
        <small>Pav√£o</small>
        <div style="font-size: 9px; color: #666; margin-bottom: 5px;">‚ú® Chance de dobrar moedas</div>
        <button style="border-radius: 50px !important;" id="btnPetPeacock" onclick="processarCompraPet('ü¶ö', 200, 'btnPetPeacock')">200 üí∞</button>
    </div>
    <div class="item-loja">
        <div style="font-size: 30px;">üêÜ</div>
        <small>Leopardo</small>
        <div style="font-size: 9px; color: #666; margin-bottom: 5px;">‚ú® Foco 25m = 30m</div>
        <button style="border-radius: 50px !important;" id="btnPetLeopard" onclick="processarCompraPet('üêÜ', 220, 'btnPetLeopard')">220 üí∞</button>
    </div>
    <div class="item-loja">
        <div style="font-size: 30px;">ü¶í</div>
        <small>Girafa</small>
        <div style="font-size: 9px; color: #666; margin-bottom: 5px;">‚ú® Revela Planta da Sorte</div>
        <button style="border-radius: 50px !important;" id="btnPetGiraffe" onclick="processarCompraPet('ü¶í', 250, 'btnPetGiraffe')">250 üí∞</button>
    </div>

</div>

        <button onclick="fecharModal('lojaOverlay')" class="secundario" style="width:100%; margin-top:20px; border-radius: 50px !important;">Sair da Loja</button>
</div>
</div>

<div id="modalPlantaOverlay">
    <div id="modalPlantaContent">
        <span class="btn-fechar-modal" onclick="fecharModal('modalPlantaOverlay')">‚úñ</span>
        <h3 style="color: var(--primary)">Selecione sua semente üå±</h3>
        <p style="font-size: 11px; margin: 5px 0; color: var(--text-secondary)">PRATELEIRA: COMUNS</p>
        <div id="paletaModal" class="modal-prateleira"></div>
        <p style="font-size: 11px; margin: 5px 0; color: var(--text-secondary)">PRATELEIRA: ESPECIAL (MODOS)</p>
        <div id="paletaEspecialModal" class="modal-prateleira"></div>
    </div>
</div>

<div id="configOverlay">
    <div id="configContent">
        <span class="btn-fechar-modal" onclick="fecharModal('configOverlay')">‚úñ</span>
        <h2 style="color: var(--primary)">‚öôÔ∏è Configura√ß√µes</h2>

        
        
        <div class="config-grid">
            <div class="config-card">
                <h4>üë§ Nome de Usu√°rio</h4>
                <input type="text" id="configNomeUsuario" placeholder="Seu nome..." oninput="salvarNovoNomeAuto()" style="width: 100%; padding: 10px; border-radius: 10px; border: 2px solid var(--primary); font-size: 14px; text-align: center; box-sizing: border-box; background: var(--bg-card); color: var(--text-main);">
                <div style="text-align: center; margin-top: 5px;">
                    <small style="color: var(--text-secondary); font-size: 9px;">O nome √© salvo automaticamente ao digitar.</small>
                </div>
            </div>

            <div class="config-card">
                <h4>üîî Sino</h4>
                <div class="ios-switch-container">
                    <div id="btnSino" class="ios-switch" onclick="toggleSino()">
                        <div class="ios-switch-thumb"></div>
                    </div>
                </div>
            </div>
            
            <div class="config-card">
                <h4>üåô Auto Tema</h4>
                <div class="ios-switch-container">
                    <div id="btnTemaAuto" class="ios-switch" onclick="toggleTemaAuto()">
                        <div class="ios-switch-thumb"></div>
                    </div>
                </div>
                
                 <div style="text-align: center; margin-top: 8px; padding: 6px; border-radius: 8px;">
        <small style="color: var(--text-secondary); font-size: 10px; line-height: 1.3; display: block;">
            <span style="color: var(--primary);"></span> 
            Desative para alternar entre modo claro ou escuro manualmente.
        </small>
            </div>
            </div>
            
            
            <div class="config-card">
                <h4>‚ú® Estrelas</h4>
                <div class="ios-switch-container">
                    <div id="btnEstrelas" class="ios-switch on" onclick="toggleEstrelas()">
                        <div class="ios-switch-thumb"></div>
                    </div>
                </div>
                 <div style="text-align: center; margin-top: 8px; padding: 6px; border-radius: 8px;">
        <small style="color: var(--text-secondary); font-size: 10px; line-height: 1.3; display: block;">
            <span style="color: var(--primary);"></span> 
            Uma estrela aparece no modo noturno sempre que um livro 5 estrelas √© colocado na estante.
        </small>
            </div>
            </div>
            <!-- No configOverlay, dentro da grid de configura√ß√µes -->
<div class="config-card">
    <h4>üì± Tela Sempre Ativa Durante Foco</h4>
    <div class="ios-switch-container">
        <div id="btnTelaAtiva" class="ios-switch" onclick="toggleTelaAtiva()">
            <div class="ios-switch-thumb"></div>
        </div>
    </div>
    <div style="text-align: center; margin-top: 8px; padding: 6px; border-radius: 8px;">
        <small style="color: var(--text-secondary); font-size: 10px; line-height: 1.3; display: block;">
            <span style="color: var(--primary);"></span> 
            Mant√©m sua tela ativa automaticamente durante o foco. N√£o saia do app para que funcione corretamente.
        </small>
    </div>
</div>
            
            <div class="config-card">
                <h4>üé® Anima√ß√£o do Fundo</h4>
                <div class="ios-switch-container">
                    <div id="btnAnimFundo" class="ios-switch on" onclick="toggleAnimacaoFundo()">
                        <div class="ios-switch-thumb"></div>
                    </div>
                </div>
            </div>
            
            <!-- NOVO: Configura√ß√£o para previs√£o -->
            <div class="config-card">
                <h4>üîÆ Previs√£o</h4>
                <div class="ios-switch-container">
                    <div id="btnPrevisao" class="ios-switch" onclick="togglePrevisao()">
                        <div class="ios-switch-thumb"></div>
                    </div>
                </div>
                 <div style="text-align: center; margin-top: 8px; padding: 6px; border-radius: 8px;">
        <small style="color: var(--text-secondary); font-size: 10px; line-height: 1.3; display: block;">
            <span style="color: var(--primary);"></span> 
            Fun√ß√£o baseada em estat√≠sticas que prev√™ sua taxa de sucesso nas sess√µes de foco.
        </small>
            </div>
            </div>

<div class="config-card">
    <h4>üòä Emojis Padronizados</h4>

    <div class="ios-switch-container">
        <div id="btnEmojis" class="ios-switch on" onclick="toggleEmojis()">
            <div class="ios-switch-thumb"></div>
        </div>
    </div>

    <div style="text-align: center; margin-top: 8px; padding: 6px; border-radius: 8px;">
        <small style="color: var(--text-secondary); font-size: 10px; line-height: 1.3; display: block;">
            Ative se os emojis do seu celular estiverem desatualizados ou aparecerem diferentes.
        </small>
   
    </div>
</div>


            </div>
        
        

        
        <!-- NOVA SE√á√ÉO: VISUALIZA√á√ÉO -->
        <h3 style="margin-top: 20px; margin-bottom: 10px; color: var(--text-main);">VISUALIZA√á√ÉO</h3>
        <div class="config-grid">
            <div class="config-card">
                <h4>‚ñ† Diminuir/Aumentar Grid</h4>
                <div class="ios-switch-container">
                    <div id="btnGrid10x10Toggle" class="ios-switch" onclick="toggleGrid10x10()">
                        <div class="ios-switch-thumb"></div>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 8px; padding: 6px; border-radius: 8px;">
                    <small style="color: var(--text-secondary); font-size: 10px; line-height: 1.3; display: block;">
                        <span style="color: var(--primary);"></span> 
                        Alterna o tamanho do seu jardim entre 5x5 e 10x10. As plantas s√£o reposicionadas. Algumas podem sumir.
                    </small>
                </div>
            </div>
        </div>
        
        <!-- NOVA SE√á√ÉO: GERENCIAMENTO -->
        <h3 style="margin-top: 20px; margin-bottom: 10px; color: var(--text-main); border-top: 1px solid var(--shadow); padding-top: 20px;">‚öôÔ∏è GERENCIAR OP√á√ïES</h3>
        
        <div class="config-card" style="align-items: stretch; text-align: left; min-height: auto; margin-bottom: 15px; width: 100%; box-sizing: border-box;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h4 style="margin: 0;">‚è±Ô∏è Tempos de Foco</h4>
<!-- Bot√£o movido para dentro da lista -->
            </div>
            <div id="listaGerenciarTempos" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 5px;"></div>
        </div>

        <div class="config-card" style="align-items: stretch; text-align: left; min-height: auto; margin-bottom: 15px; width: 100%; box-sizing: border-box;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h4 style="margin: 0;">üè∑Ô∏è Motivos de Foco</h4>
<!-- Bot√£o movido para dentro da lista -->
            </div>
            <div id="listaGerenciarMotivos" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 5px;"></div>
        </div>

        <!-- BOT√ÉO DE TUTORIAL -->
        <button onclick="iniciarTutorial()" style="width:100%; background: #9c27b0; color: white; margin-bottom: 15px; border-radius: 50px !important; font-weight: bold; padding: 12px; ">üìñ Repetir Tutorial</button>
        
        <!-- SE√á√ÉO DE BACKUP DE DADOS -->
<div class="backup-section" style="text-align: center; margin: 15px 0;">
    <button onclick="BackupManager.exportarTudo()" class="btn-config" style="background: #2196F3; color: white; width: 100%; margin-bottom: 10px;">
        üíæ Salvar Backup Completo (Tudo)
    </button>

    <button onclick="document.getElementById('inputRestore').click()" class="btn-config" style="background: #FF9800; color: white; width: 100%;">
        üìÇ Restaurar Backup
    </button>
    <input type="file" id="inputRestore" style="display: none;" 
           accept=".json" onchange="BackupManager.restaurarTudo(this)">
</div>

        
        <button onclick="resetAbsoluto()" style="width:100%; background:#c62828; color: white; margin-bottom:10px; border-radius: 50px !important; font-weight: bold; ">‚ö†Ô∏è Reset Absoluto (Zerar Tudo)</button>
        <div style="text-align: center; font-size: 10px; color: var(--text-secondary); margin-top: 15px;">Vers√£o: 3.0.0</div>
        <button onclick="fecharModal('configOverlay')" class="secundario" style="width:100%; margin-top:10px; border-radius: 50px !important;">Fechar</button>
    </div>
</div>

<div id="modalLivroInput">
    <div style="background:var(--bg-panel); padding:20px; border-radius:20px; width:280px; text-align:center;">
        <h3>Adicionar Livro</h3>
        <input type="text" id="nomeLivroInput" placeholder="T√≠tulo..." style="width:90%; border:1px solid #ddd; margin-bottom:10px; padding: 8px; border-radius: 8px;">
        <textarea id="notasLivroInput" placeholder="Notas..." style="width:90%; height: 60px; border:1px solid #ddd; margin-bottom:10px; font-family: inherit; padding: 8px; border-radius: 8px;"></textarea>
        
        <div class="color-picker" id="livroColorPicker">
            </div>

        <div class="star-rating" id="starsClickable">
            <span class="star" data-v="1">‚òÖ</span><span class="star" data-v="2">‚òÖ</span><span class="star" data-v="3">‚òÖ</span><span class="star" data-v="4">‚òÖ</span><span class="star" data-v="5">‚òÖ</span>
        </div>
        <button onclick="confirmarNovoLivro()" style="width:100%; border-radius: 50px !important;">Salvar</button>
        <button onclick="fecharModal('modalLivroInput')" class="secundario" style="width:100%; margin-top:5px; border-radius: 50px !important;">Cancelar</button>
    </div>
</div>

<div id="customAlertOverlay">
    <div id="customAlertBox">
        <div id="customAlertText" style="margin-bottom: 20px; font-weight: 500;">Mensagem</div>
        <input type="text" id="customAlertInput" style="display:none; width:90%; margin: 0 auto 15px; padding: 12px; border: 1px solid #ddd; border-radius: 12px;">
        <div class="alert-btns" style="display: flex; justify-content: center; gap: 10px;">
            <button style="border-radius: 50px !important;" id="alertConfirmBtn">Ok!</button>
            <button style="border-radius: 50px !important;" id="alertCancelBtn" class="cancelar">Cancelar</button>
            <button id="alertAltBtn" style="display:none; background: #2196f3; border-radius: 50px !important; "></button>
        </div>
    </div>
</div>

<button style="border-radius: 50px !important;" id="abrirMenuBtn" onclick="toggleMenu()">‚ò∞</button>
<button style="border-radius: 50px !important;" id="btnTema" onclick="toggleDarkMode()">üåì</button>
<button id="btnCorreioEurosummer" onclick="abrirCorreioEurosummer()" title="Correio de Mem√≥rias" style="display: none; border-radius: 50px !important;">üì™</button>
<button id="btnMetasFundoMar" onclick="toggleMetasFundoMar()" title="Metas do Oceano" style="display: none; border-radius: 50px !important;">üéØ</button>
<button id="btnCorreioFundoMar" onclick="abrirCorreioFundoMar()" title="Correio do Mar" style="display: none; border-radius: 50px !important;">üêö</button>

<div id="painelMetasFundoMar" style="display: none;">
    <div class="metas-fundo-mar-header">
        <h3>üåä Metas do Oceano</h3>
        <button style="border-radius: 50px !important;" onclick="toggleMetasFundoMar()">‚úï</button>
    </div>
    <div id="listaMetasFundoMar" style="overflow-y: auto !important; max-height: 280px;"></div>
</div>


<div id="abaEsquerda">
    <div style="text-align: center; padding-bottom: 20px; border-bottom: 2px solid rgba(76, 175, 80, 0.2); margin-top: 10px;">
        <h1 style="margin: 0 0 10px 0; color: var(--primary); cursor: pointer; font-size: 22px; white-space: nowrap;" onclick="acessarDebugViaTitulo()">üå± Garden Focus</h1>
        <h3 id="saudacaoUsuario" style="margin: 5px 0 15px 0; opacity: 0.8;">Ol√°!</h3>
        <div id="streakBadgeSide" onclick="abrirDashboard()">‚òÄÔ∏è <span id="streakBadgeValueSide">0</span> dias</div>
        
        <input type="file" id="profilePhotoInput" accept="image/*" style="display:none">
        <div id="profilePhotoContainer" onclick="document.getElementById('profilePhotoInput').click()" style="width: 80px; height: 80px; margin: 0 auto 10px; border-radius: 50%; overflow: hidden; cursor: pointer; transition: all 0.3s; border: 3px solid var(--primary); display: flex; align-items: center; justify-content: center; background: rgba(76, 175, 80, 0.1); box-shadow: 0 4px 15px rgba(76, 175, 80, 0.2);">
            <div id="profilePhotoPlaceholder" style="font-size: 40px;">üë§</div>
            <img id="profilePhoto" alt="Foto de perfil" style="width: 100%; height: 100%; object-fit: cover;">
        </div>
        <div id="profilePhotoLabel" onclick="document.getElementById('profilePhotoInput').click()" style="font-size: 12px; opacity: 0.7; cursor: pointer; margin-bottom: 10px;">Clique para adicionar foto</div>
        
        <div id="containerMoedas" style="background: rgba(76, 175, 80, 0.1); padding: 10px 15px; border-radius: 15px; font-weight: bold; color: var(--primary); display: inline-block;">
            üí∞ <span id="userMoedas">0</span> Moedas
        </div>
    </div>

    <div class="menu-grid-group">
        <h4 style="opacity: 0.6; font-size: 12px; text-transform: uppercase; letter-spacing: 1px;">Explora√ß√£o</h4>
        
        <button onclick="abrirDashboard(); toggleMenu()" style="background: linear-gradient(135deg, #2196f3, #1976d2); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);">
            <span style="font-size: 20px;">üìä</span> 
            <span>Painel</span>
        </button>
        
        <button onclick="abrirLoja(); toggleMenu()" style="background: linear-gradient(135deg, #daa520, #b8860b); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 12px rgba(218, 165, 32, 0.3);">
            <span style="font-size: 20px;">üõí</span> 
            <span>Loja</span>
        </button>
    </div>

    <div class="menu-grid-group">
        <h4 style="opacity: 0.6; font-size: 12px; text-transform: uppercase; letter-spacing: 1px;">Seu Acervo</h4>
        
        <button onclick="abrirInventario(); toggleMenu()" style="background: linear-gradient(135deg, #9c27b0, #7b1fa2); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 12px rgba(156, 39, 176, 0.3);">
            <span style="font-size: 20px;">üéí</span> 
            <span>Invent√°rio</span>
        </button>
        
        <button onclick="abrirEstante(); toggleMenu()" style="background: linear-gradient(135deg, #8d6e63, #6d4c41); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 12px rgba(141, 110, 99, 0.3);">
            <span style="font-size: 20px;">üìö</span> 
            <span>Estante</span>
        </button>
        
        <button onclick="abrirDiario(); toggleMenu()" style="background: linear-gradient(135deg, #c2185b, #880e4f); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 12px rgba(194, 24, 91, 0.3);">
            <span style="font-size: 20px;">üìî</span> 
            <span>Di√°rio</span>
        </button>
    
    <button onclick="abrirMenuJardins(); toggleMenu()" style="background: linear-gradient(135deg, #43a047, #2e7d32); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 12px rgba(46, 125, 50, 0.3);">
    <span style="font-size: 20px;">üèûÔ∏è</span> 
    <span>Jardins</span>
</button>
</div>

    <div class="menu-grid-group">
        <h4 style="opacity: 0.6; font-size: 12px; text-transform: uppercase; letter-spacing: 1px;">Produtividade</h4>
        
        <button id="btnTodoToggle" onclick="toggleTodoPopup()" style="background: linear-gradient(135deg, #4caf50, #388e3c); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3); z-index: 1002;">
            <span style="font-size: 20px;">üìù</span> 
            <span>Tarefas</span>
        </button>
        
        <button id="btnMetasToggle" onclick="toggleMetas()" style="background: linear-gradient(135deg, #ff9800, #f57c00); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3); z-index: 1001;">
            <span style="font-size: 20px;">üéØ</span> 
            <span>Metas</span>
        </button>

        <div id="todoPopup" class="todo-container" style="background: rgba(76, 175, 80, 0.05); border: 1px solid rgba(76, 175, 80, 0.2); border-radius: 12px;">
            <div style="display:flex; gap: 5px; margin-bottom: 10px;">
                <input id="novoTodo" type="text" placeholder="Nova tarefa..." style="flex: 1; min-height: 35px; font-size: 12px; padding: 8px 12px; border-radius: 8px; border: 1px solid rgba(76, 175, 80, 0.2); background: var(--bg-panel);">
                <button onclick="addTodo()" style="min-width: 35px; min-height: 35px; padding: 0; border-radius: 8px; background: var(--primary); color: white; border: none; cursor: pointer; font-weight: bold;">+</button>
            </div>
            <div id="listaTodo"></div>
        </div>

        <div id="metasContainer" class="todo-container" style="background: rgba(255, 152, 0, 0.05); border: 1px solid rgba(255, 152, 0, 0.2); border-radius: 12px;">
            <div style="display: flex; gap: 5px; margin-bottom: 10px;">
                <select id="metaMotivo" style="flex: 2; min-height: 35px; font-size: 12px; padding: 6px; border-radius: 8px; border: 1px solid rgba(255, 152, 0, 0.2); background: var(--bg-panel);"></select>
                <select id="metaTempo" style="flex: 1; min-height: 35px; font-size: 12px; padding: 6px; border-radius: 8px; border: 1px solid rgba(255, 152, 0, 0.2); background: var(--bg-panel);"></select>
                <button onclick="adicionarMeta()" style="min-width: 35px; min-height: 35px; padding: 0; border-radius: 8px; background: #ff9800; color: white; border: none; cursor: pointer; font-weight: bold;">+</button>
            </div>
            <div id="listaMetas"></div>
        </div>
    </div>

    <div class="menu-grid-group" style="border-top: 2px solid rgba(76, 175, 80, 0.2); padding-top: 15px;">
        <h4 style="opacity: 0.6; font-size: 12px; text-transform: uppercase; letter-spacing: 1px;">Prefer√™ncias</h4>
        
        <button id="btnTrocarSom" onclick="proximoSom()" style="background: linear-gradient(135deg, #607d8b, #455a64); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 12px rgba(96, 125, 139, 0.3);">
            <span style="font-size: 20px;">üîä</span> 
            <span>Som</span>
        </button>
        
        <button onclick="abrirConfig(); toggleMenu()" style="background: linear-gradient(135deg, #607d8b, #455a64); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 12px rgba(96, 125, 139, 0.3);">
            <span style="font-size: 20px;">‚öôÔ∏è</span> 
            <span>Config</span>
        </button>
    </div>
</div>
<div id="jardinsOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 35000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(8px); transition: all 0.3s ease;">
    <div id="jardinsContent" style="background: var(--bg-panel); width: 95%; max-width: 500px; max-height: 90vh; border-radius: 28px; padding: 30px; overflow-y: auto; position: relative; box-shadow: 0 20px 50px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1);">
        <button style="border-radius: 50px !important;" class="close-btn" onclick="fecharModal('jardinsOverlay')">√ó</button>
        
        <h2 style="color: var(--primary); margin-top: 0;">üèûÔ∏è Meus Jardins</h2>
        <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 20px;">Salve seu layout atual para visitar depois. (M√°x: 5)</p>

        <div id="listaJardinsSalvos" style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px;"></div>

        <button id="btnSalvarJardim" onclick="JardinsManager.salvarAtual()" style="width:100%; background: var(--accent); color: #333; font-weight: bold; border-radius: 50px !important; margin-bottom: 10px;">
            üíæ Salvar Grid Atual (3D)
        </button>

        <div id="visualizadorJardimContainer" style="display: none; margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h3 id="tituloVisualizador" style="margin:0; font-size: 16px; color: var(--primary);">Visualizando</h3>
                <button onclick="JardinsManager.fecharVisualizador()" style="padding: 5px 10px; font-size: 11px; background: #999; border-radius: 20px !important;">Voltar</button>
            </div>
            
            <div id="cenaJardimEspectador" style="width: 100%; height: 400px; background: var(--bg-body); border-radius: 15px; overflow: hidden; position: relative; border: 1px solid rgba(0,0,0,0.1);"></div>
            
            <div style="display: flex; justify-content: center; gap: 10px; margin-top: 10px;">
                <button onclick="JardinsManager.zoom(0.1)" style="width: 40px; background: var(--bg-panel); color: var(--text-main); border: 1px solid var(--primary); border-radius: 50% !important;">‚ûï</button>
                <button onclick="JardinsManager.zoom(-0.1)" style="width: 40px; background: var(--bg-panel); color: var(--text-main); border: 1px solid var(--primary); border-radius: 50% !important;">‚ûñ</button>
            </div>
        </div>

        <button onclick="fecharModal('jardinsOverlay')" class="secundario" style="width:100%; margin-top:10px; border-radius: 50px !important;">Fechar Menu</button>
    </div>
</div>



<div id="conteudo" onclick="fecharMenuSeAberto(event)">
    <div id="streakBadge" onclick="abrirDashboard()">‚òÄÔ∏è <span id="streakBadgeValue">0</span> dias</div>
    
    <div id="luckyPlantTag" class="lucky-plant-tag" style="display: none;">Sorte do dia: ...</div>

    <div class="painel-controle">
        <div style="display: flex; align-items: center; justify-content: center; gap: 4px; flex-wrap: wrap; margin-bottom: 5px;">
            <div style="display: flex; align-items: center; gap: 2px;">
                <select id="tempoEscolhido" style="min-width: 85px;"></select>
            </div>
            <span style="opacity: 0.2; margin: 0 2px;">|</span>
            <div style="display: flex; align-items: center; gap: 2px;">
                <select id="motivoEscolhido" style="min-width: 110px;"></select>
            </div>
        </div>
        <div id="painelInteligencia"></div>
        <div id="timer">25:00</div>
        
        <div class="deep-focus-controls" style="display: none; margin-bottom: 10px;">
            <div id="plantaFocoProfundo"></div>
            <button onclick="toggleDeepFocus(false)" style="background: rgba(0,0,0,0.2); border: 1px solid var(--primary); color: var(--text-main); font-size: 12px; padding: 8px 20px; border-radius: 50px !important; ">Sair do Foco Profundo</button>
        </div>

        <div style="display: flex; justify-content: center; gap: 5px;" id="mainButtons">
            <button id="btnStart" onclick="startTimer()" style="flex: 1; border-radius: 50px !important;">Iniciar Foco</button>
            <!-- NOVO: Bot√£o de adicionar foco manual -->
            <button id="btnAdicionarManual" onclick="adicionarFocoManual()" style="display: none; background: #666; color: white; max-width: 50px; border-radius: 50px !important; " disabled>+</button>
            <button id="btnDeepFocus" onclick="toggleDeepFocus(true)" style="display: none; background: #673ab7; border-radius: 50px !important; ">üñ•Ô∏è Foco Profundo</button>
            <button id="btnBulldoze" onclick="bulldoze()" style="flex: 1; max-width: 50px; border-radius: 50px !important;" title="Remover todas as plantas">üå™</button>
            <button id="btnParar" class="cancelar" onclick="cancelTimer()" style="flex: 1; max-width: 100px; display: none; border-radius: 50px !important;">Parar</button>
        </div>
    </div>

    <!-- JARDIM 2D (MODO ORIGINAL) -->
    <div id="jardim"></div>
    
    <!-- NOVO: JARDIM 3D ISOM√âTRICO -->
    <div id="jardim3D">
        <div class="scene-3d">
            <div class="grid-container-3d" id="grid3D"></div>
        </div>
    </div>
    
    <div id="painelMotivo" style="display:none; margin-top: 20px; padding: 15px; background: var(--bg-panel); border-radius: 10px; border-left: 5px solid var(--primary); max-width: 300px; margin: 20px auto;">
        <strong>Nota:</strong> <span id="textoMotivo"></span>
    </div>
</div>

<!-- BARRA DE NAVEGA√á√ÉO INFERIOR (P√çLULA) -->
<div id="bottomNavBar">
    <button class="bottom-nav-item" onclick="abrirLoja()" title="Loja">
        üõí
    </button>
    <button class="bottom-nav-item" onclick="abrirInventario()" title="Invent√°rio">
        üéí
    </button>
    <div id="bottomNavPhotoContainer" onclick="document.getElementById('profilePhotoInput').click()" title="Perfil">
        <div id="bottomNavPhotoPlaceholder">üì∑</div>
        <img id="bottomNavPhoto" alt="Foto de perfil" style="display:none;">
    </div>
    <button class="bottom-nav-item" onclick="abrirEstante()" title="Estante">
        üìö
    </button>
    <button class="bottom-nav-item" onclick="abrirConfig()" title="Ajustes">
        ‚öôÔ∏è
    </button>
</div>
<!-- INPUT OCULTO PARA FOTO DE PERFIL -->
<input type="file" id="profilePhotoInput" accept="image/*" style="display:none">

<div id="inventarioOverlay">
    <div id="inventarioContent">
        <span class="btn-fechar-modal" onclick="fecharModal('inventarioOverlay')">‚úñ</span>
        <h2 style="color: var(--primary)">üéí Meu Invent√°rio</h2>
        
        <div id="listaInventario" class="loja-grid">
            </div>

        <button onclick="fecharModal('inventarioOverlay')" class="secundario" style="width:100%; margin-top:20px; border-radius: 50px !important;">Fechar</button>
    </div>
</div>

<script>
/**
 * ============================================================
 * SISTEMA DE ARMAZENAMENTO PROFISSIONAL (INDEXEDDB + CACHE)
 * Vers√£o Final com Migra√ß√£o √önica e Limpeza Autom√°tica
 * ==========================================
 */

const DB_CONFIG = {
    name: 'GardenFocusDB',
    version: 1,
    storeName: 'gameState'
};

let memoryCache = {};
let dbConnection = null;
let isDatabaseReady = false;

const StorageSystem = {
    connect: function() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_CONFIG.name, DB_CONFIG.version);
            request.onupgradeneeded = (e) => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains(DB_CONFIG.storeName)) {
                    db.createObjectStore(DB_CONFIG.storeName);
                }
            };
            request.onsuccess = (e) => {
                dbConnection = e.target.result;
                resolve(dbConnection);
            };
            request.onerror = (e) => reject(e.target.error);
        });
    },

    loadToMemory: function() {
        return new Promise((resolve, reject) => {
            // Se n√£o houver conex√£o, carregamos tudo que existe no localStorage como fallback
            if (!dbConnection) {
                try {
                    for (let i = 0; i < localStorage.length; i++) {
                        const k = localStorage.key(i);
                        try {
                            memoryCache[k] = JSON.parse(localStorage.getItem(k));
                        } catch (e) {
                            memoryCache[k] = localStorage.getItem(k);
                        }
                    }
                } catch (e) {
                    console.warn('StorageSystem: falha ao carregar localStorage como fallback', e);
                }
                return resolve();
            }

            const transaction = dbConnection.transaction([DB_CONFIG.storeName], 'readonly');
            const store = transaction.objectStore(DB_CONFIG.storeName);
            const request = store.openCursor();
            request.onsuccess = (e) => {
                const cursor = e.target.result;
                if (cursor) {
                    memoryCache[cursor.key] = cursor.value;
                    cursor.continue();
                } else {
                    // Ap√≥s carregar do DB, garantimos que qualquer chave presente somente no localStorage seja promovida para o DB
                    try {
                        for (let i = 0; i < localStorage.length; i++) {
                            const k = localStorage.key(i);
                            if (!(k in memoryCache)) {
                                try {
                                    const parsed = JSON.parse(localStorage.getItem(k));
                                    memoryCache[k] = parsed;
                                    // Tenta persistir no DB para consolidar
                                    const tx = dbConnection.transaction([DB_CONFIG.storeName], 'readwrite');
                                    tx.objectStore(DB_CONFIG.storeName).put(parsed, k);
                                } catch (err) {
                                    memoryCache[k] = localStorage.getItem(k);
                                }
                            }
                        }
                    } catch (e) {
                        console.warn('StorageSystem: erro ao mesclar localStorage -> DB', e);
                    }
                    resolve();
                }
            };
            request.onerror = () => reject("Erro ao ler dados");
        });
    },

    setItem: function(key, value) {
        // Mant√©m em mem√≥ria para acesso r√°pido
        memoryCache[key] = value;

        // Escreve em localStorage como backup s√≠ncrono para garantir durabilidade imediata
        try {
            localStorage.setItem(key, JSON.stringify(value));
        } catch (e) {
            console.warn('StorageSystem: n√£o foi poss√≠vel gravar em localStorage (espaco/quota):', e);
        }

        // Tenta gravar no IndexedDB quando dispon√≠vel
        if (dbConnection) {
            try {
                const transaction = dbConnection.transaction([DB_CONFIG.storeName], 'readwrite');
                transaction.objectStore(DB_CONFIG.storeName).put(value, key);
            } catch (e) {
                console.warn("Erro ao salvar no DB (conex√£o pode estar fechada):", e);
            }
        } else {
            // Informa√ß√£o √∫til para depura√ß√£o: foi salvo apenas no localStorage por enquanto
            console.debug('StorageSystem: DB n√£o conectado ‚Äî valor salvo em localStorage como fallback para chave:', key);
        }
    },

    migrateFromLegacy: async function() {
        if (localStorage.getItem('MIGRACAO_CONCLUIDA_V3')) return;
        
        // Lista de chaves para migrar (mantive a l√≥gica para n√£o perder o que voc√™ j√° tinha)
        const legacyKeys = [
            'jardim', 'historico_foco', 'moedasFoco', 'estante_livros', 
            'petsComprados', 'sessoesTotais', 'streakDiasAtivos', 'tempos', 
            'motivos', 'todos', 'metas', 'darkMode', 'modoNatal', 'modoMedieval',
            'medievalComprado', 'candyforniaComprado', 'eurosummerComprado',
            'eurosummerSessoes', 'eurosummerEmojisDesbloqueados', 'exibirEstrelas',
            'animacaoFundoAtiva', 'sinoAtivo', 'temaAutomaticoAtivo', 
            'mostrarAvisoInicio', 'mostrarPrevisao', 'modo3D', 'aviso3DJaVisto',
            'somAtualIdx', 'profilePhoto', 'grid10x10', 'recursos',
            'romanceData', 'modoCandyfornia', 'modoEurosummer', 'modoFundoMar',
            'fundoMarComprado', 'jardimAquatico', 'fundoMarMetasConcluidas',
            'fundoMarEmojisDesbloqueados', 'vistoIntroEurosummer', 'vistoIntroFundoMar',
            'guiaEscolhidoFundoMar', 'manterTelaAtiva', 'diario_entradas',
            'jogadorNome', 'vistoPrimeiroUso', 'tutorialVisto', 'meuDiario'
        ];

        let migrouAlgo = false;
        // Verifica se h√° conex√£o antes de tentar transa√ß√£o
        if (!dbConnection) await this.connect();

        const transaction = dbConnection.transaction([DB_CONFIG.storeName], 'readwrite');
        const store = transaction.objectStore(DB_CONFIG.storeName);

        legacyKeys.forEach(key => {
            const rawValue = localStorage.getItem(key);
            if (rawValue !== null) {
                try {
                    const value = JSON.parse(rawValue);
                    store.put(value, key);
                    memoryCache[key] = value;
                    migrouAlgo = true;
                } catch (e) {
                    store.put(rawValue, key);
                    memoryCache[key] = rawValue;
                    migrouAlgo = true;
                }
            }
        });

        return new Promise((resolve) => {
            transaction.oncomplete = () => {
                if (migrouAlgo) {
                    showToast('üíæ', 'Sistema Atualizado', 'Seus dados foram migrados.');
                    localStorage.setItem('MIGRACAO_CONCLUIDA_V3', 'true');
                    legacyKeys.forEach(key => localStorage.removeItem(key));
                }
                resolve();
            };
            transaction.onerror = () => resolve();
        });
    },

    clearAllData: function() {
        return new Promise((resolve, reject) => {
            // 1. FECHA A CONEX√ÉO ATUAL OBRIGATORIAMENTE
            if (dbConnection) {
                dbConnection.close();
                dbConnection = null;
                console.log("Conex√£o com o banco fechada para exclus√£o.");
            }

            // 2. Deleta o banco de dados inteiro
            const req = indexedDB.deleteDatabase(DB_CONFIG.name);

            req.onsuccess = () => {
                console.log("Banco de dados deletado com sucesso.");
                memoryCache = {};
                resolve();
            };

            req.onerror = (e) => {
                console.error("Erro ao deletar banco:", e);
                resolve(); // Resolve mesmo com erro para permitir o reload
            };

            req.onblocked = () => {
                console.warn("A exclus√£o foi bloqueada pelo navegador. For√ßando reload...");
                resolve();
            };
        });
    }
};


async function bootApp() {
    try {
        await StorageSystem.connect();
        await StorageSystem.migrateFromLegacy();
        await StorageSystem.loadToMemory();
        isDatabaseReady = true;
        if (typeof init === 'function') init();
    } catch (err) {
        console.error("Erro no boot:", err);
        if (typeof init === 'function') init();
    }
}

// Inicializa√ß√£o
window.onload = null;
window.addEventListener('load', bootApp);
const StorageSeguro = {
    get: function(key, defaultValue) {
        if (!isDatabaseReady) {
            try {
                const item = localStorage.getItem(key);
                return item ? JSON.parse(item) : defaultValue;
            } catch (e) { return defaultValue; }
        }
        return memoryCache[key] !== undefined ? memoryCache[key] : defaultValue;
    },
    set: function(key, value) {
        StorageSystem.setItem(key, value);
        return true;
    },
    clear: async function() {
        // Limpa IndexedDB
        await StorageSystem.clearAllData();
        // Limpa LocalStorage
        localStorage.clear();
        return true;
    }
};

async function migrarParaBancoSeguro() {
    // Verifica se existe di√°rio no storage antigo
    const diarioAntigo = localStorage.getItem('meuDiario');
    
    if (diarioAntigo) {
        console.log("üì¶ Migrando Di√°rio para o Banco de Dados...");
        try {
            const dadosParseados = JSON.parse(diarioAntigo);
            // Salva no IndexedDB
            await StorageSeguro.set('meuDiario', dadosParseados);
            
            // Remove do LocalStorage (Limpeza)
            localStorage.removeItem('meuDiario');
            console.log("‚úÖ Migra√ß√£o conclu√≠da! LocalStorage est√° limpo.");
        } catch (e) {
            console.error("Erro na migra√ß√£o:", e);
        }
    }
}

// Executa ao iniciar
window.addEventListener('load', migrarParaBancoSeguro);

// Fun√ß√£o de verifica√ß√£o r√°pida para depura√ß√£o de persist√™ncia
function verificarPersistencia() {
    try {
        const keys = ['historico_foco','jardim','jardimAquatico','moedasFoco','tesouroAtivoIndex','ultimoTesouroData'];
        const resumo = {};
        keys.forEach(k => {
            const inMemory = memoryCache[k] !== undefined;
            let localVal = null;
            try { localVal = JSON.parse(localStorage.getItem(k)); } catch(e) { localVal = localStorage.getItem(k); }
            resumo[k] = { inMemory, inLocalStorage: localVal !== null && localVal !== undefined, localVal };
        });
        console.debug('verificarPersistencia:', resumo);
        return resumo;
    } catch (e) {
        console.error('verificarPersistencia falhou', e);
        return null;
    }
}

// =========================
// FUN√á√ïES PARA PRIMEIRO USO
// =========================
function mostrarPrimeiroUso() {
    document.getElementById('firstTimeOverlay').style.display = 'flex';
    document.getElementById('firstTimeContent').classList.add('modal-anim-in');
}

function pularPrimeiroUso() {
    StorageSeguro.set('jogadorNome', 'Jardineiro');
    StorageSeguro.set('vistoPrimeiroUso', true);
    document.getElementById('firstTimeOverlay').style.display = 'none';
    document.getElementById('firstTimeContent').classList.remove('modal-anim-in');
    location.reload();
}

function finalizarPrimeiroUso() {
    const nome = document.getElementById('firstTimeNameInput').value.trim();
    
    if (nome === '') {
        alert('Por favor, digite seu nome para continuar!');
        return;
    }
    
    StorageSeguro.set('vistoPrimeiroUso', true);
    StorageSeguro.set('jogadorNome', nome);
    
    document.getElementById('firstTimeOverlay').style.display = 'none';
    document.getElementById('firstTimeContent').classList.remove('modal-anim-in');
    
    location.reload();
}

// =========================
// SISTEMA DE PART√çCULAS SIMPLIFICADO E FUNCIONAL
// =========================
class ParticulasManager {
    constructor() {
        this.particulas = [];
        this.canvas = document.getElementById('bgCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.animacaoAtiva = false;
        this.ultimoTempo = 0;
        this.contadorParticulas = 0;
        this.temaAtual = 'padrao';
        this.animationId = null;
    }
    
    iniciar() {
        // For√ßar ativa√ß√£o se for modo fundo do mar
        if (modoFundoMar) animacaoFundoAtiva = true;
        
        if (!animacaoFundoAtiva) {
            this.parar();
            return;
        }
        this.redimensionarCanvas();
        this.criarParticulas();
        this.animacaoAtiva = true;
        this.animar();
        
        window.addEventListener('resize', () => {
            this.redimensionarCanvas();
        });
    }
    
    redimensionarCanvas() {
        this.canvas.width = window.innerWidth;
        this.canvas.height = window.innerHeight;
    }
    
    criarParticulas() {
        this.particulas = [];
        this.contadorParticulas = modoFundoMar ? 35 : (modoCandyfornia ? 40 : (modoNatal ? 60 : (modoMedieval ? 30 : 20)));
        this.temaAtual = modoFundoMar ? 'fundomar' : (modoCandyfornia ? 'candyfornia' : (modoNatal ? 'natal' : (modoMedieval ? 'medieval' : 'padrao')));
        
        for (let i = 0; i < this.contadorParticulas; i++) {
            this.particulas.push(this.criarParticula());
        }
    }
    
    criarParticula() {
        let cor, tamanho, velocidade;
        
        if (this.temaAtual === 'natal') {
            cor = '#FFFFFF';
            tamanho = Math.random() * 3 + 1;
            velocidade = Math.random() * 0.8 + 0.3;
        } else if (this.temaAtual === 'medieval') {
            const coresRosa = ['#FFB7C5', '#FFC0CB', '#F08080', '#FF69B4', '#F8BBD0'];
            cor = coresRosa[Math.floor(Math.random() * coresRosa.length)];
            tamanho = Math.random() * 4 + 2;
            velocidade = Math.random() * 1 + 0.5;
        } else if (this.temaAtual === 'candyfornia') {
            // NOVO: Modo Candyfornia
            const coresDoces = ['#FFB6C1', '#FF69B4', '#FF1493', '#FFC0CB', '#DB7093', '#FFD700'];
            cor = coresDoces[Math.floor(Math.random() * coresDoces.length)];
            tamanho = Math.random() * 4 + 2;
            velocidade = Math.random() * 1 + 0.5;
        } else if (this.temaAtual === 'fundomar') {
    // NOVO: Modo Fundo do Mar - Bolhas
    const coresBolhas = ['rgba(76, 201, 240, 0.6)', 'rgba(0, 180, 216, 0.5)', 'rgba(144, 224, 239, 0.7)'];
    cor = coresBolhas[Math.floor(Math.random() * coresBolhas.length)];
    tamanho = Math.random() * 6 + 3;
    
    // ALTERA√á√ÉO AQUI: Velocidade reduzida pela metade
    // Antes era: -(Math.random() * 1.5 + 0.8)
    velocidade = -(Math.random() * 0.3 + 0.1); // Agora varia entre -0.4 e -1.15
    
} else {

            const coresVerde = ['#81C784', '#AED581', '#66BB6A', '#4CAF50', '#388E3C'];
            cor = coresVerde[Math.floor(Math.random() * coresVerde.length)];
            tamanho = Math.random() * 5 + 3;
            velocidade = Math.random() * 1.2 + 0.5;
        }
        
        return {
            x: Math.random() * this.canvas.width,
            y: Math.random() * this.canvas.height,
            tamanho: tamanho,
            velocidade: velocidade,
            cor: cor,
            oscilacao: 0,
            oscilacaoVelocidade: 0,
            rotacao: Math.random() * Math.PI * 2,
            rotacaoVelocidade: (Math.random() - 0.5) * 0.01
        };
    }
    
    animar() {
        if (!this.animacaoAtiva || !animacaoFundoAtiva) {
            if (this.animationId) {
                cancelAnimationFrame(this.animationId);
                this.animationId = null;
            }
            return;
        }
        
        this.animationId = requestAnimationFrame(() => this.animar());
        
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        
        for (let i = 0; i < this.particulas.length; i++) {
            const p = this.particulas[i];
            
            p.y += p.velocidade;
            
            if (this.temaAtual === 'padrao') {
                p.rotacao += p.rotacaoVelocidade;
            }
            
            // Ajuste para resetar part√≠culas que sobem (bolhas) ou descem (outros temas)
            let saiuDaTela = false;
            if (this.temaAtual === 'fundomar') {
                if (p.y < -20 || p.x < -10 || p.x > this.canvas.width + 10) saiuDaTela = true;
            } else {
                if (p.y > this.canvas.height + 10 || p.x < -10 || p.x > this.canvas.width + 10) saiuDaTela = true;
            }

            if (saiuDaTela) {
                Object.assign(p, this.criarParticula());
                p.y = (this.temaAtual === 'fundomar') ? this.canvas.height + 20 : -10;
            }
            
            this.ctx.save();
            this.ctx.translate(p.x, p.y);
            
            if (this.temaAtual === 'padrao') {
                this.ctx.rotate(p.rotacao);
                this.ctx.fillStyle = p.cor;
                this.ctx.beginPath();
                this.ctx.ellipse(0, 0, p.tamanho, p.tamanho / 1.5, 0, 0, Math.PI * 2);
                this.ctx.fill();
            } else if (this.temaAtual === 'medieval') {
                this.ctx.fillStyle = p.cor;
                this.ctx.beginPath();
                this.ctx.arc(0, 0, p.tamanho, 0, Math.PI * 2);
                this.ctx.fill();
                
                this.ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                this.ctx.beginPath();
                this.ctx.arc(-p.tamanho/3, -p.tamanho/3, p.tamanho/2, 0, Math.PI * 2);
                this.ctx.fill();
            } else if (this.temaAtual === 'candyfornia') {
                // NOVO: Modo Candyfornia - formas de doces
                this.ctx.fillStyle = p.cor;
                this.ctx.beginPath();
                this.ctx.arc(0, 0, p.tamanho, 0, Math.PI * 2);
                this.ctx.fill();
                
                // Brilho no centro
                this.ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
                this.ctx.beginPath();
                this.ctx.arc(-p.tamanho/4, -p.tamanho/4, p.tamanho/3, 0, Math.PI * 2);
                this.ctx.fill();
                
                // Contorno brilhante
                this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.4)';
                this.ctx.lineWidth = 1;
                this.ctx.beginPath();
                this.ctx.arc(0, 0, p.tamanho, 0, Math.PI * 2);
                this.ctx.stroke();
            } else {
                this.ctx.fillStyle = p.cor;
                this.ctx.beginPath();
                this.ctx.arc(0, 0, p.tamanho, 0, Math.PI * 2);
                this.ctx.fill();
                
                this.ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                this.ctx.beginPath();
                this.ctx.arc(-p.tamanho/4, -p.tamanho/4, p.tamanho/3, 0, Math.PI * 2);
                this.ctx.fill();
            }
            
            this.ctx.restore();
        }
    }
    
    atualizarTema() {
        this.criarParticulas();
        if (!animacaoFundoAtiva) {
            this.parar();
        }
    }
    
    parar() {
        // Se for modo fundo do mar, ignorar o comando de parar para manter ativo a todo momento
        if (modoFundoMar) return;
        
        this.animacaoAtiva = false;
        if (this.animationId) {
            cancelAnimationFrame(this.animationId);
            this.animationId = null;
        }
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
    }
}
// =========================
// SISTEMA DE EFEITOS OTIMIZADO
// =========================
class EfeitosManager {
    constructor() {
        this.pool = [];
        this.activeElements = new Set();
        this.container = null;
        this.initContainer();
    }
    
    initContainer() {
        this.container = document.createElement('div');
        this.container.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
        `;
        document.body.appendChild(this.container);
    }
    
    criarElemento() {
        const div = document.createElement('div');
        div.style.cssText = `
            position: absolute;
            top: -50px;
            font-size: 24px;
            opacity: 0.8;
            will-change: transform, opacity;
        `;
        return div;
    }
    
    obterElemento() {
        if (this.pool.length > 0) {
            return this.pool.pop();
        }
        return this.criarElemento();
    }
    
    devolverElemento(element) {
        element.style.display = 'none';
        if (this.pool.length < 50) {
            this.pool.push(element);
        }
    }
    
    chuvaDeEfeitos(emoji = 'üéâ', quantidade = 35) {
        const emojiFinal = modoNatal ? 'üéÅ' : emoji;
        
        for(let i = 0; i < quantidade; i++) {
            setTimeout(() => {
                const elemento = this.obterElemento();
                elemento.textContent = emojiFinal;
                elemento.style.left = `${Math.random() * 100}vw`;
                elemento.style.animation = `fall ${Math.random() * 2 + 2}s linear forwards`;
                elemento.style.display = 'block';
                
                this.container.appendChild(elemento);
                this.activeElements.add(elemento);
                
                setTimeout(() => {
                    if (elemento.parentNode) {
                        elemento.parentNode.removeChild(elemento);
                    }
                    this.activeElements.delete(elemento);
                    this.devolverElemento(elemento);
                }, 4000);
            }, i * 150);
        }
    }
    
    limparTodos() {
        this.activeElements.forEach(elemento => {
            if (elemento.parentNode) {
                elemento.parentNode.removeChild(elemento);
            }
            this.devolverElemento(elemento);
        });
        this.activeElements.clear();
    }
}

// =========================
// SISTEMA DE √ÅUDIO OTIMIZADO
// =========================
class AudioManager {
    constructor() {
        this.audioCtx = null;
        this.noiseNode = null;
        this.currentSound = null;
        this.somAtualIdx = 0;
        this.sonsAmbiente = [
            { nome: "üîá Mudo", tipo: null },
            { nome: "üåßÔ∏è Chuva", tipo: "chuva" },
            { nome: "üå¨Ô∏è Vento", tipo: "vento" }
        ];
    }
    
    init() {
        this.somAtualIdx = parseInt(localStorage.getItem('somAtualIdx') || '0');
        document.getElementById('btnTrocarSom').textContent = this.sonsAmbiente[this.somAtualIdx].nome;
        this.tocarSomAtual();
    }
    
    fecharContexto() {
        if (this.audioCtx) {
            try {
                if (this.audioCtx.state !== 'closed') {
                    this.audioCtx.close();
                }
            } catch (e) {
                console.warn("Erro ao fechar audio context:", e);
            }
            this.audioCtx = null;
        }
        this.noiseNode = null;
        this.currentSound = null;
    }
    
    criarNoise(type) {
        this.fecharContexto();
        
        try {
            this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            
            if (type === null) {
                return;
            }
            
            const bufferSize = 2 * this.audioCtx.sampleRate;
            const noiseBuffer = this.audioCtx.createBuffer(1, bufferSize, this.audioCtx.sampleRate);
            const output = noiseBuffer.getChannelData(0);
            let lastOut = 0.0;
            
            for (let i = 0; i < bufferSize; i++) {
                const white = Math.random() * 2 - 1;
                output[i] = (lastOut + (0.02 * white)) / 1.02;
                lastOut = output[i];
                output[i] *= 3.5;
            }
            
            this.noiseNode = this.audioCtx.createBufferSource();
            this.noiseNode.buffer = noiseBuffer;
            this.noiseNode.loop = true;
            
            const filter = this.audioCtx.createBiquadFilter();
            filter.type = "lowpass";
            
            if (type === "chuva") {
                filter.frequency.value = 1000;
            } else if (type === "vento") {
                filter.frequency.value = 400;
                const lfo = this.audioCtx.createOscillator();
                const lfoGain = this.audioCtx.createGain();
                lfo.frequency.value = 0.2;
                lfoGain.gain.value = 200;
                lfo.connect(lfoGain);
                lfoGain.connect(filter.frequency);
                lfo.start();
            }
            
            this.noiseNode.connect(filter);
            filter.connect(this.audioCtx.destination);
            this.noiseNode.start();
            
            this.currentSound = type;
            
        } catch (e) {
            console.error("Erro ao criar √°udio:", e);
            this.fecharContexto();
        }
    }

    // Reproduz um breve som de vento (burst) por 'duration' ms (leve)
    playWindBurst(duration = 800) {
        try {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const bufferSize = 2 * ctx.sampleRate;
            const noiseBuffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
            const output = noiseBuffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) output[i] = Math.random() * 2 - 1;

            const src = ctx.createBufferSource();
            src.buffer = noiseBuffer;
            src.loop = true;

            const filter = ctx.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.value = 600;

            const gain = ctx.createGain();
            gain.gain.setValueAtTime(0.0001, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.12, ctx.currentTime + 0.02);
            gain.gain.exponentialRampToValueAtTime(0.02, ctx.currentTime + duration / 1000);

            src.connect(filter);
            filter.connect(gain);
            gain.connect(ctx.destination);
            src.start();
            
            setTimeout(() => {
                try { src.stop(); } catch (e) {}
                try { if (ctx.state !== 'closed') ctx.close(); } catch (e) {}
            }, duration);
        } catch (e) { console.warn('Erro ao tocar wind burst:', e); }
    }

    proximoSom() {
        this.somAtualIdx = (this.somAtualIdx + 1) % this.sonsAmbiente.length;
        StorageSeguro.set('somAtualIdx', this.somAtualIdx);
        
        const novoSom = this.sonsAmbiente[this.somAtualIdx].nome;
        document.getElementById('btnTrocarSom').textContent = novoSom;
        
        this.criarNoise(this.sonsAmbiente[this.somAtualIdx].tipo);
    }
    
    tocarSomAtual() {
        const tipoAtual = this.sonsAmbiente[this.somAtualIdx].tipo;
        this.criarNoise(tipoAtual);
    }
    
    parar() {
        this.fecharContexto();
    }
    
    tocarSino() {
        if (!sinoAtivo) return;
        
        try {
            const context = new (window.AudioContext || window.webkitAudioContext)();
            const osc = context.createOscillator();
            const gain = context.createGain();
            
            osc.type = "sine";
            osc.frequency.setValueAtTime(880, context.currentTime);
            osc.frequency.exponentialRampToValueAtTime(440, context.currentTime + 1);
            
            gain.gain.setValueAtTime(0.3, context.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, context.currentTime + 1);
            
            osc.connect(gain);
            gain.connect(context.destination);
            
            osc.start();
            
            setTimeout(() => {
                try {
                    if (context.state !== 'closed') {
                        context.close();
                    }
                } catch (e) {
                    // Ignorar erro ao fechar
                }
            }, 1500);
            
            osc.stop(context.currentTime + 1);
        } catch (e) {
            console.error("Erro ao tocar sino:", e);
        }
    }
}

const CAMINHO_TRILHOS = 'caminho-trilhos';
const CAMINHO_ASFALTO = 'caminho-asfalto';
const CAMINHO_PEDRA = 'caminho-pedra';
const TIPOS_CAMINHO = [CAMINHO_TRILHOS, CAMINHO_ASFALTO, CAMINHO_PEDRA, 'üõ§Ô∏è','üõ£Ô∏è','üß±'];

const ITENS_PADRAO = ['üõ§Ô∏è','üõ£Ô∏è','üß±','üå≤','üå≥','üå¥','üåµ','üåæ','üåø','‚òòÔ∏è','üåª','üåπ','üå∑','üçÑ','üçÑ‚Äçüü´','‚õ∞Ô∏è','üè†','üèò','üèØ','üè∞','‚õ™Ô∏è','‚õ©Ô∏è','ü™¥','‚õ≤Ô∏è','üïå','üõï','üóº','üåà','ü™ß','üóø','ü™®','üè°','üè¢','üè¨','üè≠','üè´','üè®','üõñ'];

const ITENS_FUNDO_MAR_BASE = ['ü´ß','üêö','ü™∏','‚öì','üõ•','üö¢','üè∞','üèùÔ∏è'];
// Itens permitidos em ambos os modos (mar e terra)
const ITENS_ALLOW_AMBOS = ['üè∞'];
const ITENS_NATAL = ['üéÑ','üéÅ','üéÖ','ü§∂','‚õÑ','‚ùÑÔ∏è','‚õÑ','‚ùÑÔ∏è','üïØÔ∏è','üîî','üç™','ü•õ','üç¨','ü•ß','üß£','üß§'];
const ITENS_MEDIEVAL = ['üè∞','üèØ','‚öîÔ∏è','üõ°Ô∏è','üëë','üìú','üç∫','üçû','üçó','üïØÔ∏è','üõñ','‚õ∫','üèπ','üèá','üê≤','üî•'];
const ITENS_CANDYFORNIA = ['üç¨','üç≠','üç´','üç©','üç™','üéÇ','üç∞','üßÅ','ü•ß','üç®','üçß','üç¶','üçØ','üçÆ','‚òïÔ∏è','ü•§','üçπ','üßã','ü•ê','üçø'];
const ITENS_EUROSUMMER = ['üçã','‚òï','‚õ≤','ü™ª','üçá','üè†','‚õµ','üåª','ü•Ç','üèõÔ∏è','üè°','üíê','üåº'];
const CORES_LIVROS = [
    '#2e7d32', // Verde Original
    '#1565c0', // Azul Original
    '#c62828', // Vermelho Original
    '#ef6c00', // Laranja Original
    '#6a1b9a', // Roxo Original
    '#795548', // Marrom Original
    // --- Novas Cores ---
    '#ad1457', // Rosa Intenso (√ìtimo para Candyfornia)
    '#00838f', // Turquesa Oceano
    '#283593', // Azul Indigo (Mais escuro/Medieval)
    '#f9a825', // Amarelo Ouro (Combina com Natal)
    '#455a64', // Cinza Azulado (Elegante para Modo Noturno)
    '#00695c'  // Verde √Ågua Escuro
];

const PROGRESSAO = {
    'üå≤': {estagio: 'üå±', final: 'üå≤'},
    'üå≥': {estagio: 'üå±', final: 'üå≥'},
    'üå¥': {estagio: 'üå±', final: 'üå¥'},
    'üåµ': {estagio: 'üå±', final: 'üåµ'},
    'üåæ': {estagio: 'üå±', final: 'üåæ'},
    'üåø': {estagio: 'üå±', final: 'üåø'},
    '‚òòÔ∏è': {estagio: 'üå±', final: '‚òòÔ∏è'},
    'üåª': {estagio: 'üå±', final: 'üåª'},
    'üåπ': {estagio: 'üå±', final: 'üåπ'},
    'üå∑': {estagio: 'üå±', final: 'üå∑'},
    'üçÑ': {estagio: 'ü´ò', final: 'üçÑ'},
    'üçÑ‚Äçüü´': {estagio: 'ü´ò', final: 'üçÑ‚Äçüü´'},
    'üè†': {estagio: 'üèóÔ∏è', final: 'üè†'},
    'üèØ': {estagio: 'üèóÔ∏è', final: 'üèØ'},
    'üè∞': {estagio: 'üèóÔ∏è', final: 'üè∞'},
    '‚õ™Ô∏è': {estagio: 'üèóÔ∏è', final: '‚õ™Ô∏è'},
    '‚õ©Ô∏è': {estagio: 'üèóÔ∏è', final: '‚õ©Ô∏è'},
    'ü™¥': {estagio: 'üå±', final: 'ü™¥'},
    '‚õ≤Ô∏è': {estagio: 'üèóÔ∏è', final: '‚õ≤Ô∏è'},
    'ü™®': {estagio: 'ü™®', final: 'ü™®'},
    'üïå': {estagio: 'üèóÔ∏è', final: 'üïå'},
    'üõï': {estagio: 'üèóÔ∏è', final: 'üõï'},
    'üóº': {estagio: 'üèóÔ∏è', final: 'üóº'},
    'üåà': {estagio: '‚òÅÔ∏è', final: 'üåà'},
    'ü™ß': {estagio: 'ü™ß', final: 'ü™ß'},
    'üóø': {estagio: 'ü™®', final: 'üóø'},
    'üéÑ': {estagio: 'üå≤', final: 'üéÑ'},
    'üéÅ': {estagio: 'üì¶', final: 'üéÅ'},
    'üéÖ': {estagio: 'üß¶', final: 'üéÖ'},
    '‚öîÔ∏è': {estagio: '‚öíÔ∏è', final: '‚öîÔ∏è'},
    'üõ°Ô∏è': {estagio: '‚öíÔ∏è', final: 'üõ°Ô∏è'},
    'üëë': {estagio: 'üíé', final: 'üëë'},
    'default': {estagio: '‚è≥Ô∏è', final: null}
};


// Inst√¢ncias dos sistemas otimizados
const particulasManager = new ParticulasManager();
const efeitosManager = new EfeitosManager();
const audioManager = new AudioManager();

// Dados do jogo
let tempos = StorageSeguro.get('tempos', [1, 5, 10, 15, 25, 45, 60, 90]);
let motivos = StorageSeguro.get('motivos', ["Estudo", "Trabalho", "Leitura", "Sa√∫de"]);
let modoNatal = StorageSeguro.get('modoNatal', false);
let modoMedieval = StorageSeguro.get('modoMedieval', false);
let medievalComprado = StorageSeguro.get('medievalComprado', false);
let modoCandyfornia = StorageSeguro.get('modoCandyfornia', false);
let candyforniaComprado = StorageSeguro.get('candyforniaComprado', false);
let modoEurosummer = StorageSeguro.get('modoEurosummer', false);
let eurosummerComprado = StorageSeguro.get('eurosummerComprado', false);
let eurosummerSessoes = StorageSeguro.get('eurosummerSessoes', 0);
let eurosummerEmojisDesbloqueados = StorageSeguro.get('eurosummerEmojisDesbloqueados', []);
let modoFundoMar = StorageSeguro.get('modoFundoMar', false);
let jardimDataAquatico = StorageSeguro.get('jardimAquatico', Array(25).fill(null));
let fundoMarComprado = StorageSeguro.get('fundoMarComprado', false);
let fundoMarMetasConcluidas = StorageSeguro.get('fundoMarMetasConcluidas', []);
let fundoMarEmojisDesbloqueados = StorageSeguro.get('fundoMarEmojisDesbloqueados', []);
let vistoIntroEurosummer = StorageSeguro.get('vistoIntroEurosummer', false);
let vistoIntroFundoMar = StorageSeguro.get('vistoIntroFundoMar', false);
let guiaEscolhidoFundoMar = StorageSeguro.get('guiaEscolhidoFundoMar', null); // 'üßú‚Äç‚ôÄÔ∏è' ou 'üßú‚Äç‚ôÇÔ∏è'
// Vari√°veis do Tesouro Di√°rio
let tesouroAtivoIndex = StorageSeguro.get('tesouroAtivoIndex', null); // Onde o tesouro est√° (null se n√£o houver)
let ultimoTesouroData = StorageSeguro.get('ultimoTesouroData', null); // Data da √∫ltima coleta


// Metas do Fundo do Mar (10 metas progressivas)
const METAS_FUNDO_MAR = [
    { id: 1, motivo: 'Hidrata√ß√£o', tempo: 5, emoji: 'üêü', texto: 'Eu te encontrei sem f√¥lego na superf√≠cie e te trouxe para as bolhas de ar. Beba esta √°gua; voc√™ precisa recuperar as for√ßas que o mar te tirou.', petGratis: 'üêü' },
    { id: 2, motivo: 'Postura', tempo: 10, emoji: 'üê†', texto: 'O naufr√°gio castigou seu corpo. Endireite-se. Enquanto voc√™ se cura, as cores come√ßam a voltar para este pequeno trecho de coral.', petGratis: 'üê†' },
    { id: 3, motivo: 'Medita√ß√£o', tempo: 15, emoji: 'üê°', texto: 'Sinta a calma das profundezas. O p√¢nico do naufr√°gio passou. Sua respira√ß√£o tranquila √© o que faz as plantas marinhas voltarem a dan√ßar.', petGratis: 'üê°' },
    { id: 4, motivo: 'Skincare', tempo: 20, emoji: 'üêô', texto: 'O sal do oceano resseca a pele, assim como o √≥leo do seu navio feriu o polvo. Cuide-se agora, para que possamos limpar o resto do recife juntos.', petGratis: 'üêô' },
    { id: 5, motivo: 'Desconex√£o', tempo: 30, emoji: 'üê¢', texto: 'Esque√ßa o mundo de onde voc√™ veio por um instante. Olhe para o azul. A tartaruga anci√£ decidiu confiar em voc√™ ap√≥s ver seu esfor√ßo.', petGratis: 'üê¢' },
    { id: 6, motivo: 'Medita√ß√£o', tempo: 45, emoji: 'ü¶¶', texto: 'Voc√™ n√£o √© mais um estranho aqui. O sil√™ncio da sua mente permitiu que as lontras voltassem a brincar nas ru√≠nas do seu antigo navio.', petGratis: 'ü¶¶' },
    { id: 7, motivo: 'Hidrata√ß√£o', tempo: 60, emoji: '‚ú®', texto: 'Voc√™ provou que sua vida vale a pena. Salvando-se, voc√™ me salvou. De n√°ufrago a guardi√£o, agora este reino tamb√©m te pertence.', petGratis: 'GUIA_DEFINIDO' },
    { id: 8, motivo: 'Postura', tempo: 80, emoji: 'ü¶≠', texto: 'O santu√°rio est√° quase restaurado. Sua postura firme reflete a for√ßa das novas barreiras de coral que protegemos hoje.', petGratis: 'ü¶≠' },
    { id: 9, motivo: 'Desconex√£o', tempo: 100, emoji: 'üêã', texto: 'O oceano n√£o √© mais um inimigo que te afogou, mas o lar que te acolheu. As baleias cantam sua hist√≥ria: o n√°ufrago que curou o mar.', petGratis: 'üêã' }
];
let exibirEstrelas = StorageSeguro.get('exibirEstrelas', true);
let animacaoFundoAtiva = StorageSeguro.get('animacaoFundoAtiva', true);
let escolhido = StorageSeguro.get('plantaEscolhida', (modoFundoMar ? (fundoMarEmojisDesbloqueados.length > 0 ? fundoMarEmojisDesbloqueados : ITENS_PADRAO) : (modoEurosummer ? (eurosummerEmojisDesbloqueados.length > 0 ? eurosummerEmojisDesbloqueados : ITENS_PADRAO) : (modoCandyfornia ? ITENS_CANDYFORNIA : (modoNatal ? ITENS_NATAL : (modoMedieval ? ITENS_MEDIEVAL : ITENS_PADRAO)))))[0]);
let alvo = null, intervalo = null;
let jardimDataNormal = StorageSeguro.get('jardim', Array(25).fill(null));
let jardimData = modoFundoMar ? jardimDataAquatico : jardimDataNormal;
let todos = StorageSeguro.get('todos', []);
let estante = StorageSeguro.get('estante_livros', []);
let sessoesTotais = StorageSeguro.get('sessoesTotais', 0);
let historico = StorageSeguro.get('historico_foco', []);
let totalMoedas = Number(StorageSeguro.get('moedasFoco', 0)) || 0;
let streakDiasAtivos = StorageSeguro.get('streakDiasAtivos', 0);
let luckyPlant = "";
let notaTemp = 0;
let corLivroTemp = CORES_LIVROS[0];
let sinoAtivo = StorageSeguro.get('sinoAtivo', true);
let temaAutomaticoAtivo = StorageSeguro.get('temaAutomaticoAtivo', true);
// Sincronizar nomes de vari√°veis para evitar confus√£o
// Sincronizar nomes de vari√°veis para evitar confus√£o
// Removido temaAutomaticoAtivo redundante para usar apenas temaAutomaticoAtivo

let mostrarAvisoInicio = StorageSeguro.get('mostrarAvisoInicio', true);
let mostrarPrevisao = StorageSeguro.get('mostrarPrevisao', true);
let metas = StorageSeguro.get('metas', []);
let modo3D = StorageSeguro.get('modo3D', true);
let aviso3DJaVisto = StorageSeguro.get('aviso3DJaVisto', false);
// NOVO: Sistema para manter tela ativa
let wakeLock = null;
let manterTelaAtiva = StorageSeguro.get('manterTelaAtiva', true);
// NOVO: Modo grid 10x10
let grid10x10 = StorageSeguro.get('grid10x10', false);
// ... suas vari√°veis existentes ...


let petsComprados = StorageSeguro.get('petsComprados', []); 
// Cada pet agora ter√° uma propriedade 'ultimoCarinho' interna

let petsEmCena = []; 
let intervaloPets = null;
let intervaloVaquinha = null;
const LIMITE_PETS = 2; // Limite definido


// =========================
// FUN√á√ïES DE PERSIST√äNCIA DO TIMER - CORRIGIDAS
// =========================
function salvarTimerAtivo() {
    if (!intervalo) {
        StorageSeguro.set('timerAtivo', null);
        return;
    }
    
    const motivo = document.getElementById('motivoEscolhido').value;
    const tempoEscolhido = document.getElementById('tempoEscolhido').value;
    
    // Calcular o tempo restante do display
    const timerText = document.getElementById('timer').textContent;
    const [minutos, segundos] = timerText.split(':').map(Number);
    const tempoRestante = minutos * 60 + segundos;
    
    const timerData = {
        alvo: alvo,
        inicio: Date.now() - (tempoEscolhido * 60 - tempoRestante) * 1000, // Tempo de in√≠cio ajustado
        duracao: tempoEscolhido * 60, // em segundos
        motivo: motivo,
        escolhido: escolhido,
        tempoRestante: tempoRestante
    };
    
    StorageSeguro.set('timerAtivo', timerData);
}

function recriarTimerSeExistir() {
    // Se o modo Coop j√° estiver tentando reconectar, evitamos duplicidade aqui
    

    const timerData = StorageSeguro.get('timerAtivo', null);
    
    if (!timerData) {
        return;
    }
    
    const agora = Date.now();
    const tempoPassado = Math.floor((agora - timerData.inicio) / 1000); // em segundos
    let tempoRestante = timerData.duracao - tempoPassado; // MUDAN√áA: usar let em vez de const
    
    if (tempoRestante <= 0) {
        // Timer j√° expirou, finalizar o foco
        StorageSeguro.set('timerAtivo', null);
        if (intervalo) { clearInterval(intervalo); intervalo = null; }
        
        // Verificar se j√° foi registrado no hist√≥rico
        const hoje = new Date().toISOString().split('T')[0];
        const jaRegistrado = historico.some(s => {
            const sessaoData = new Date(s.data).toISOString().split('T')[0];
            return sessaoData === hoje && s.status === 'sucesso' && s.motivo === timerData.motivo;
        });
        
        if (!jaRegistrado) {
            // Finalizar como sucesso
            alvo = timerData.alvo;
            escolhido = timerData.escolhido;
            document.getElementById('motivoEscolhido').value = timerData.motivo;
            document.getElementById('tempoEscolhido').value = timerData.duracao / 60;
            
            const emojiFinal = evoluirEmoji(escolhido);
            const isLucky = escolhido === luckyPlant;
            
            jardimData[alvo] = { 
                icone: emojiFinal, 
                motivo: timerData.motivo, 
                lucky: isLucky,
                emProgresso: false 
            };
            
            sessoesTotais++;
            historico.push({ 
                data: new Date(timerData.inicio).toISOString(), 
                minutos: timerData.duracao / 60, 
                motivo: timerData.motivo, 
                icone: emojiFinal, 
                mes: new Date(timerData.inicio).getMonth(), 
                ano: new Date(timerData.inicio).getFullYear(), 
                status: 'sucesso' 
            });
            
            updateMoedas(isLucky ? 2 : 1);
            atualizarStreak();
            salvarTudo();
            renderSelects();
        }
        
        return;
    }
    
    // Recriar o timer
    alvo = timerData.alvo;
    escolhido = timerData.escolhido;
    document.getElementById('motivoEscolhido').value = timerData.motivo;
    document.getElementById('tempoEscolhido').value = timerData.duracao / 60;
    
    const emojiEstagio = obterEmojiEstagio(escolhido);
    jardimData[alvo] = { 
        icone: emojiEstagio, 
        motivo: timerData.motivo, 
        lucky: false,
        emProgresso: true,
        emojiFinal: escolhido
    };
    
    renderJardim();
    document.getElementById('painelInteligencia').style.display = 'none';
    document.getElementById('btnStart').style.display = 'none';
    document.getElementById('btnDeepFocus').style.display = 'block';
    document.getElementById('btnParar').style.display = 'block';
    
    // CORRE√á√ÉO: Usar closure para manter a refer√™ncia √† vari√°vel tempoRestante
    intervalo = setInterval(() => { 
        tempoRestante--; 
        let m = Math.floor(tempoRestante/60), s = tempoRestante%60; 
        document.getElementById('timer').textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; 
        if(tempoRestante <= 0) {
            finalizarFoco(); gerenciarTelaAtiva(false);
            limparTimerAtivo();
        } else {
            salvarTimerAtivo(); // Salvar periodicamente
        }
    }, 1000);
    
    // Atualizar display imediatamente
    let m = Math.floor(tempoRestante/60), s = tempoRestante%60; 
    document.getElementById('timer').textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    
    atualizarBotoes();
    
    // Salvar novamente para manter atualizado
    salvarTimerAtivo();
}

function limparTimerAtivo() {
    StorageSeguro.set('timerAtivo', null);
}

// =========================
// FUN√á√ïES EXISTENTES MODIFICADAS
// =========================
function iniciarTimer(viaRede = false, tempoForcado = null) {
    if (intervalo) {
        clearInterval(intervalo);
        intervalo = null;
    }
    let tempo = tempoForcado !== null ? tempoForcado : document.getElementById('tempoEscolhido').value * 60; 
    const emojiEstagio = obterEmojiEstagio(escolhido);
    // Bloqueio: n√£o permite iniciar um foco (plantar) em cima de caminhos
    if (jardimData[alvo] && ehCaminhoEmoji(jardimData[alvo].icone)) {
        showToast('‚ö†Ô∏è', 'Imposs√≠vel plantar', 'Voc√™ n√£o pode plantar em cima de caminhos.');
        console.warn('iniciarTimer bloqueado: c√©lula com caminho no √≠ndice', alvo);
        return;
    }
    jardimData[alvo] = { 
        icone: emojiEstagio, 
        motivo: document.getElementById('motivoEscolhido').value, 
        lucky: false,
        emProgresso: true,
        emojiFinal: escolhido
    };
    renderJardim();
    let tempoRestante = tempo; 
    intervalo = setInterval(() => { 
        tempoRestante--; 
        if(tempoRestante <= 0) {
            document.getElementById('timer').textContent = "00:00";
            finalizarFoco(); 
            limparTimerAtivo();
            clearInterval(intervalo);
            intervalo = null;
        } else {
            let m = Math.floor(tempoRestante/60), s = tempoRestante%60; 
            document.getElementById('timer').textContent = (m<10?"0":"")+m+":"+(s<10?"0":"")+s;
            if (tempoRestante % 60 === 0) salvarTudo();
        }
    }, 1000);
}

function cancelTimer(viaRede = false) { 
            
    
    if(intervalo) {
        const confirmCancel = () => {
            // Se n√£o for via rede, envia o comando para o parceiro
            if (!viaRede && false) {
                
            }
            

            // NOVO: Desativar manuten√ß√£o de tela
                if (wakeLock) {
                    wakeLock.release();
                    wakeLock = null;
                }
                
                // Habilidade C√£ozinho: Recupera 50% das moedas ao desistir
                if (petsComprados.some(p => p.icone === 'üêï')) {
                    const tempoDecorrido = Math.floor((Date.now() - startTime) / 1000 / 60);
                    const moedasRecuperadas = Math.floor(tempoDecorrido / 10);
                    if (moedasRecuperadas > 0) {
                        updateMoedas(moedasRecuperadas);
                        showToast('üêï', 'C√£ozinho te ajudou!', `+${moedasRecuperadas} moedas recuperadas`);
                    }
                }
                
                clearInterval(intervalo); intervalo = null; 
                const failureEmoji = getFailureEmoji(escolhido);
                if(alvo !== null) jardimData[alvo] = { icone: failureEmoji, motivo: document.getElementById('motivoEscolhido').value + " (Falha)", lucky: false };
                historico.push({ data: new Date().toISOString(), minutos: 0, motivo: document.getElementById('motivoEscolhido').value, status: 'falha' });
                alvo = null; toggleDeepFocus(false);
                document.getElementById('btnDeepFocus').style.display = 'none';
                document.getElementById('btnStart').style.display = 'block';
                document.getElementById('btnParar').style.display = 'none';
                
                 // Limpar o timer ativo do storage
                limparTimerAtivo();
                
                renderJardim();
                atualizarBotoes();
        };

        if (viaRede) {
            confirmCancel();
        } else {
            showModal({ 
                text: "Desistir?", 
                onConfirm: confirmCancel,
                onCancel: () => {}
            });
        }
    }
}

function mostrarInfoEstante() {
    const LIVROS_POR_ANDAR = 12;
    const totalAndares = Math.ceil(estante.length / LIVROS_POR_ANDAR);
    const livrosComNotaMaxima = estante.filter(l => l.nota === 5).length;
    
    let mensagem = `<strong>üìä Estat√≠sticas da Estante</strong><br><br>`;
    mensagem += `üìö <strong>Livros totais:</strong> ${estante.length}<br>`;
    mensagem += `üèóÔ∏è <strong>Andares:</strong> ${totalAndares}<br>`;
    mensagem += `‚≠ê <strong>Livros com nota m√°xima (5):</strong> ${livrosComNotaMaxima}<br>`;
    mensagem += `üìà <strong>Capacidade atual:</strong> ${estante.length}/${totalAndares * LIVROS_POR_ANDAR} livros<br><br>`;
    mensagem += `üéØ <small>Cada andar suporta at√© ${LIVROS_POR_ANDAR} livros. Continue lendo para expandir sua biblioteca!</small>`;
    
    showModal({ 
        text: mensagem, 
        onConfirm: () => {} 
    });
}

// =========================
// TUTORIAL INTERATIVO (SIMPLIFICADO)
// =========================
const TUTORIAL_STEPS = [
    {
        icon: 'üå±',
        title: 'Bem-vindo ao Garden Focus!',
        text: 'Seu jardim est√° pronto para florecer! Vamos ver o essencial para come√ßar a focar.',
        location: null
    },
    {
        icon: 'ü™¥',
        title: 'Seu Jardim',
        text: '√â onde suas plantas e constru√ß√µes crescem. Clique em um espa√ßo vazio sempre que quiser focar.',
        location: 'jardim'
    },
    {
        icon: '‚è±Ô∏è',
        title: 'Timer e Motivo',
        text: 'Defina o tempo de foco e o motivo. Clique em "Iniciar Foco" para come√ßar.',
        location: 'timer'
    },
    {
        icon: '‚ò∞',
        title: 'Menu Principal',
        text: 'Acesse a Estante e Configura√ß√µes por aqui.',
        location: 'menu'
    },
    {
        icon: 'üöÄ',
        title: 'Pronto para Focar!',
        text: 'Foque, veja seu jardim crescer e divirta-se! Boa jornada!',
        location: null
    }
];

let tutorialAtual = 0;
let tutorialAtivo = false;

function iniciarTutorial() {
    fecharModal('configOverlay');
    fecharModal('firstTimeOverlay');
    
    tutorialAtual = 0;
    tutorialAtivo = true;
    
    const overlay = document.getElementById('tutorialOverlay');
    overlay.style.display = 'flex';
    
    renderizarProgressoTutorial();
    mostrarPassoTutorial();
}
// =========================
// NOVA FUN√á√ÉO: CONTROLE DE VISIBILIDADE DOS PETS
// =========================
function petDeveAparecer(petIcone) {
    // 1. REGRA DE OURO: O C√¥njuge aparece SEMPRE, em qualquer lugar
    if (RomanceManager && RomanceManager.data && RomanceManager.data.parceiroIcone === petIcone) {
        return true;
    }

    const animaisMarinhos = ['üêã', 'üê†', 'üêü', 'üê°', 'üêô', 'ü¶≠', 'üê¢', 'ü¶¶', 'üßú‚Äç‚ôÇÔ∏è', 'üßú‚Äç‚ôÄÔ∏è'];
    const isMarinho = animaisMarinhos.includes(petIcone);

    // 2. Filtro de Ambiente
    if (modoFundoMar) {
        return isMarinho; // No mar, s√≥ mostra peixes
    } else {
        return !isMarinho; // Na terra, s√≥ mostra animais terrestres
    }
}


function renderizarProgressoTutorial() {
    const progressContainer = document.getElementById('tutorialProgress');
    progressContainer.innerHTML = '';
    
    TUTORIAL_STEPS.forEach((_, index) => {
        const dot = document.createElement('div');
        dot.className = 'tutorial-progress-dot';
        if (index < tutorialAtual) dot.classList.add('completed');
        if (index === tutorialAtual) dot.classList.add('active');
        progressContainer.appendChild(dot);
    });
}

function mostrarPassoTutorial() {
    const step = TUTORIAL_STEPS[tutorialAtual];
    const icon = document.getElementById('tutorialIcon');
    const title = document.getElementById('tutorialTitle');
    const text = document.getElementById('tutorialText');
    const locationDiv = document.getElementById('tutorialLocation');
    const locationText = document.getElementById('tutorialLocationText');
    const prevBtn = document.getElementById('tutorialPrevBtn');
    const nextBtn = document.getElementById('tutorialNextBtn');
    const stepCounter = document.getElementById('tutorialStepCounter');
    
    icon.textContent = step.icon;
    title.textContent = step.title;
    text.innerHTML = step.text;
    stepCounter.textContent = `Passo ${tutorialAtual + 1} de ${TUTORIAL_STEPS.length}`;
    
    if (step.location) {
        locationDiv.style.display = 'flex';
        locationText.innerHTML = step.location;
    } else {
        locationDiv.style.display = 'none';
    }
    
    prevBtn.style.display = tutorialAtual === 0 ? 'none' : 'block';
    nextBtn.textContent = tutorialAtual === TUTORIAL_STEPS.length - 1 ? 'Concluir' : 'Pr√≥ximo';
    
    renderizarProgressoTutorial();
}

function tutorialProximo() {
    if (tutorialAtual < TUTORIAL_STEPS.length - 1) {
        tutorialAtual++;
        mostrarPassoTutorial();
    } else {
        finalizarTutorial();
    }
}

function tutorialAnterior() {
    if (tutorialAtual > 0) {
        tutorialAtual--;
        mostrarPassoTutorial();
    }
}

function tutorialPular() {
    finalizarTutorial();
}

function finalizarTutorial() {
    tutorialAtivo = false;
    const overlay = document.getElementById('tutorialOverlay');
    overlay.style.display = 'none';
    
    StorageSeguro.set('tutorialVisto', true);
}

function verificarPrimeiroAcesso() {
    const tutorialVisto = StorageSeguro.get('tutorialVisto', false);
    const nomeUsuario = StorageSeguro.get('jogadorNome', null);
    
    if (!tutorialVisto && nomeUsuario) {
        setTimeout(() => {
            iniciarTutorial();
        }, 500);
    }
}

// =========================
// FUN√á√ÉO PARA AJUSTE DIN√ÇMICO DO 3D
// =========================
function ajustarTamanho3D() {
    if (!modo3D) return;
    
    const jardim3D = document.getElementById('jardim3D');
    const grid3D = document.getElementById('grid3D');
    const gridSize = getGridSize();
    
    if (!jardim3D || !grid3D) return;
    
    // Calcular tamanho baseado na viewport
    const viewportWidth = window.innerWidth;
    const viewportHeight = window.innerHeight;
    const isMobile = viewportWidth <= 899;
    const isLandscape = viewportWidth > viewportHeight;
    
    let cellSize, scaleFactor = 1;
    
    if (isMobile) {
        if (grid10x10) {
            // Grid 10x10 em mobile
            if (isLandscape) {
                cellSize = Math.min(viewportHeight * 0.08, 35);
                scaleFactor = 0.7;
            } else {
                cellSize = Math.min(viewportWidth * 0.08, 32);
                scaleFactor = 0.8;
            }
        } else {
            // Grid 5x5 em mobile
            if (isLandscape) {
                cellSize = Math.min(viewportHeight * 0.12, 45);
                scaleFactor = 0.8;
            } else {
                cellSize = Math.min(viewportWidth * 0.15, 45);
                scaleFactor = 0.9;
            }
        }
    } else {
        // Desktop
        if (grid10x10) {
            cellSize = Math.min(viewportWidth * 0.045, 45);
            scaleFactor = 0.9;
        } else {
            cellSize = Math.min(viewportWidth * 0.07, 84);
            scaleFactor = 1;
        }
    }
    
    // Aplicar tamanho m√≠nimo
    cellSize = Math.max(cellSize, grid10x10 ? 25 : 30);
    
    // Aplicar as mudan√ßas
    document.documentElement.style.setProperty('--cell-3d-size', `${cellSize}px`);
    document.documentElement.style.setProperty('--scale-3d', scaleFactor.toString());
    
    // Adicionar classe de ajuste
    grid3D.classList.add('ajustado');
    
    // Ajustar altura do container com margem de seguran√ßa
    const projectedHeight = cellSize * gridSize * 0.866; // sin(60) ‚âà 0.866
    jardim3D.style.height = `${projectedHeight + 40}px`; // Adicionado 40px de margem inferior
    
    // Ajustar emojis
    const emojis = document.querySelectorAll('.emoji-3d');
    emojis.forEach(emoji => {
        const translateY = -cellSize * 0.46;
        emoji.style.transform = `rotateZ(-45deg) rotateX(-90deg) translateY(${translateY}px) scaleY(1)`;
    });
}

function toggleModo3D() {
    if (!modo3D && !aviso3DJaVisto) {
        abrirAviso3D();
        return;
    }
    
    modo3D = !modo3D;
    StorageSeguro.set('modo3D', modo3D);
    atualizarVisibilidadeModo3D();
    renderJardim();
    
    const btn3DConfig = document.getElementById('btn3DToggle');
    if (btn3DConfig) {
        btn3DConfig.classList.toggle('on', modo3D);
    }
    
    // Ajustar tamanho ap√≥s ativar/desativar
    if (modo3D) {
        setTimeout(ajustarTamanho3D, 100);
    }
}
// =========================
// FUN√á√ÉO UTILIT√ÅRIA: TOAST (NOTIFICA√á√ÉO)
// =========================
function showToast(icon, title, message, persistente = false) {
    // Remove toast anterior se houver (para n√£o acumular)
    const existingToast = document.querySelector('.pet-toast-moderno');
    if (existingToast) {
        existingToast.remove();
    }

    // Cria o elemento do toast
    const toast = document.createElement('div');
    toast.className = 'pet-toast-moderno' + (persistente ? ' persistente' : '');
    
    // Define o conte√∫do HTML igual ao estilo CSS j√° existente
    toast.innerHTML = `
        <div class="toast-content">
            <span class="toast-icon">${icon}</span>
            <div class="toast-text">
                <strong>${title}</strong>
                <span>${message}</span>
            </div>
        </div>
        <div class="toast-progress"></div>
    `;

    document.body.appendChild(toast);

    // Configura a remo√ß√£o autom√°tica (4 segundos) se n√£o for persistente
    if (!persistente) {
        setTimeout(() => {
            toast.classList.add('saindo'); // Aciona anima√ß√£o de sa√≠da do CSS
            
            // Remove do DOM ap√≥s a anima√ß√£o terminar
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 500); // Tempo da anima√ß√£o 'toastSaida'
        }, 4000); // Tempo de exibi√ß√£o na tela
    }
}

function removerToastPersistente() {
    const existingToast = document.querySelector('.pet-toast-moderno.persistente');
    if (existingToast) {
        existingToast.classList.add('saindo');
        setTimeout(() => {
            if (existingToast.parentNode) existingToast.parentNode.removeChild(existingToast);
        }, 500);
    }
}

function abrirAviso3D() {
    document.getElementById('aviso3DOverlay').style.display = 'flex';
}

function fecharAviso3D() {
    document.getElementById('aviso3DOverlay').style.display = 'none';
    aviso3DJaVisto = true;
    StorageSeguro.set('aviso3DJaVisto', true);
    
    modo3D = true;
    StorageSeguro.set('modo3D', modo3D);
    atualizarVisibilidadeModo3D();
    renderJardim();
    
    const btn3DConfig = document.getElementById('btn3DToggle');
    if (btn3DConfig) {
        btn3DConfig.classList.toggle('on', modo3D);
    }
    
    // Ajustar tamanho ap√≥s ativar
    setTimeout(ajustarTamanho3D, 100);
}

function atualizarVisibilidadeModo3D() {
    const jardim2D = document.getElementById('jardim');
    const jardim3D = document.getElementById('jardim3D');
    
    if (modo3D) {
        jardim2D.style.display = 'none';
        jardim3D.style.display = 'block';
    } else {
        jardim2D.style.display = 'grid';
        jardim3D.style.display = 'none';
    }
}

function renderJardim3D() {
    const container = document.getElementById('grid3D');
    container.innerHTML = '';
    
    const gridSize = getGridSize();
    ajustarTamanho3D();
    
    container.style.gridTemplateColumns = `repeat(${gridSize}, var(--cell-3d-size))`;
    container.style.gridTemplateRows = `repeat(${gridSize}, var(--cell-3d-size))`;

    jardimData.forEach((item, i) => {
        const cell = document.createElement('div');
        
        // Z-Index para profundidade correta
        cell.style.zIndex = 100 + i; 
        
        let petObj = petsEmCena.find(p => p.index === i);
        let petAqui = null;
        
        if (petObj && petDeveAparecer(petObj.icone)) {
            petAqui = petObj;
        }

        const isTesouro = (i === tesouroAtivoIndex);
        
        cell.className = 'cell-3d' + (i === alvo ? ' alvo' : '') + (petAqui ? ' has-pet' : '');

        const caminhos = TIPOS_CAMINHO;
        const floresEspeciais = ['üåª', 'üåπ', 'üå∑']; 
        
        const isCaminho = item && caminhos.includes(item.icone);
        const isFlorSprite = item && floresEspeciais.includes(item.icone);

        // 1. RENDERIZAR CAMINHO
        if (isCaminho) {
            cell.classList.add('is-path');
            const conexoes = obterConexoesCaminho(i);
            const svgBackground = gerarTexturaCaminho(conexoes, item.icone);
            
            const layer = document.createElement('div');
            layer.className = 'path-layer';
            layer.style.backgroundImage = `url('${svgBackground}')`;
            cell.appendChild(layer);
        }

        // 2. RENDERIZAR FLOR SPRITE
        else if (isFlorSprite) {
            const svgSprite = gerarSpriteFlor(item.icone);
            
            const florElem = document.createElement('div');
            florElem.style.position = 'absolute';
            florElem.style.width = '100%';
            florElem.style.height = '100%';
            florElem.style.backgroundImage = `url('${svgSprite}')`;
            florElem.style.backgroundSize = 'contain';
            florElem.style.backgroundRepeat = 'no-repeat';
            florElem.style.backgroundPosition = 'center bottom';
            florElem.style.pointerEvents = 'none'; 
            
            // --- POSICIONAMENTO ---
            florElem.style.left = '80%';
            florElem.style.top = '20%';
            florElem.style.transform = `translate(-50%, -50%) rotateZ(-45deg) rotateX(-90deg) scale(0.85)`;
            florElem.style.transformOrigin = 'center bottom';

            cell.appendChild(florElem);
        }

        // ------------------------------

        if (intervalo) {
            cell.style.pointerEvents = 'none';
            cell.style.opacity = '1';
        } else {
            cell.style.pointerEvents = 'auto';
            cell.style.opacity = '1';
        }

        // 3. Renderizar Planta Normal
        if (item && !isCaminho && !isFlorSprite) {
            const itensMarinhos = [...ITENS_FUNDO_MAR_BASE, 'üßú‚Äç‚ôÄÔ∏è', 'üßú‚Äç‚ôÇÔ∏è', 'ü´ß', 'üêö', 'ü™∏', '‚öì', 'üõ•', 'üö¢'];
            const isItemMarinho = itensMarinhos.includes(item.icone) || (item.final && itensMarinhos.includes(item.final));
            const isAllowBoth = (typeof ITENS_ALLOW_AMBOS !== 'undefined') && (ITENS_ALLOW_AMBOS.includes(item.icone) || (item.final && ITENS_ALLOW_AMBOS.includes(item.final)));
            
            let mostrarItem = true;
            if (modoFundoMar) {
                if (!isItemMarinho && !isAllowBoth) mostrarItem = false;
            } else {
                if (isItemMarinho && !isAllowBoth) mostrarItem = false;
            }

            if (mostrarItem) {
                const emoji = document.createElement('span');
                emoji.className = 'emoji-3d';
                emoji.textContent = item.icone;
                
                if (RomanceManager.telepatiaAtiva && RomanceManager.plantaSelecionadaIndex === i) {
                    emoji.classList.add('fantasma');
                }

                if (item.emProgresso) {
                    emoji.classList.add('plant-spawn');
                    emoji.style.animation = 'pulsar 1.5s infinite';
                } else if (item.lucky) {
                    emoji.classList.add('lucky-glow');
                }
                cell.appendChild(emoji);
            }
        }
        
        // 4. Renderizar Pet (Mantido igual)
        else if (petAqui) {
            if (RomanceManager.shouldShowPartnerOnLand(petAqui.icone) && !modoFundoMar) {
                const bubble = document.createElement('div');
                bubble.className = 'bolha-magica';
                cell.appendChild(bubble);
            }

            const petElem = document.createElement('span');
            petElem.className = 'pet-3d' + (petAqui.pausado ? ' pausado' : '');
            petElem.textContent = petAqui.icone;
            
            if (isCaminho) {
                petElem.style.transform = `translate(-50%, -50%) rotateZ(-45deg) rotateX(-90deg) translateY(calc(var(--cell-3d-size) * -0.4)) scaleY(1)`;
            }
            
            cell.appendChild(petElem);

            if (petAqui.pausado) {
                setTimeout(() => {
                    const rect = cell.getBoundingClientRect();
                    const agora = Date.now();
                    const dezMinutos = 10 * 60 * 1000;
                    
                    const petOriginal = petsComprados.find(p => p.icone === petAqui.icone && p.nome === petAqui.nome);
                    const ultimoCarinho = petOriginal ? (petOriginal.ultimoCarinho || 0) : 0;

                    const antigo = document.querySelector('.btn-carinho-flutuante');
                    if (antigo) antigo.remove();

                    const btnCarinho = document.createElement('button');
                    btnCarinho.className = 'btn-carinho-flutuante';
                    
                    const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
                    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                    
                    btnCarinho.style.left = `${rect.left + scrollLeft + rect.width / 2}px`;
                    btnCarinho.style.top = `${rect.top + scrollTop - 10}px`;

                    if (agora - ultimoCarinho < dezMinutos) {
                        const minutosRestantes = Math.ceil((dezMinutos - (agora - ultimoCarinho)) / 60000);
                        btnCarinho.textContent = `üò¥ ${minutosRestantes}m`;
                    } else {
                        btnCarinho.textContent = "Acariciar ‚ù§Ô∏è";
                        btnCarinho.onclick = (e) => {
                            e.stopPropagation();
                            darCarinho(petAqui, i);
                            petAqui.pausado = false;
                            btnCarinho.remove();
                            renderJardim3D();
                        };
                    }
                    
                    document.body.appendChild(btnCarinho);

                    const fecharAoClicarFora = (e) => {
                        if (!btnCarinho.contains(e.target) && !cell.contains(e.target)) {
                            btnCarinho.classList.add('fade-out');
                            setTimeout(() => {
                                if (btnCarinho.parentNode) btnCarinho.remove();
                                petAqui.pausado = false;
                                renderJardim3D();
                            }, 300);
                            document.removeEventListener('click', fecharAoClicarFora);
                        }
                    };
                    setTimeout(() => {
                        document.addEventListener('click', fecharAoClicarFora);
                    }, 10);
                }, 0);
            }
        }
        
        // 5. Renderizar Tesouro
        else if (isTesouro) {
            const tesouroElem = document.createElement('span');
            tesouroElem.className = 'emoji-3d';
            tesouroElem.textContent = 'ü™é';
            tesouroElem.style.transform = `rotateZ(-45deg) rotateX(-90deg) translateY(calc(var(--cell-3d-size) * -0.3)) scaleY(1)`;
            tesouroElem.style.filter = 'drop-shadow(0 0 8px gold)';
            cell.appendChild(tesouroElem);
        }

        // 6. Fantasma de Sele√ß√£o
        else if (i === alvo && escolhido && !intervalo) {
            const caminhosGhost = TIPOS_CAMINHO;
            const floresGhost = ['üåª', 'üåπ', 'üå∑'];
            
            const isEscolhaCaminho = caminhosGhost.includes(escolhido);
            const isEscolhaFlor = floresGhost.includes(escolhido);

            if (isEscolhaCaminho) {
                const conexoesFantasma = obterConexoesCaminho(i);
                const svgBackground = gerarTexturaCaminho(conexoesFantasma, escolhido);
                const ghostLayer = document.createElement('div');
                ghostLayer.className = 'path-layer';
                ghostLayer.style.backgroundImage = `url('${svgBackground}')`;
                ghostLayer.style.opacity = '0.5';
                cell.appendChild(ghostLayer);
            } 
            else if (isEscolhaFlor) {
                const svgSprite = gerarSpriteFlor(escolhido);
                const ghostFlor = document.createElement('div');
                ghostFlor.style.position = 'absolute';
                ghostFlor.style.width = '100%';
                ghostFlor.style.height = '100%';
                ghostFlor.style.backgroundImage = `url('${svgSprite}')`;
                ghostFlor.style.backgroundSize = 'contain';
                ghostFlor.style.backgroundRepeat = 'no-repeat';
                ghostFlor.style.backgroundPosition = 'center bottom';
                
                ghostFlor.style.left = '80%';
                ghostFlor.style.top = '20%';
                ghostFlor.style.transform = `translate(-50%, -50%) rotateZ(-45deg) rotateX(-90deg) scale(0.85)`;
                ghostFlor.style.transformOrigin = 'center bottom';
                ghostFlor.style.opacity = '0.6';
                
                cell.appendChild(ghostFlor);
            }
            else {
                const ghost = document.createElement('span');
                ghost.className = 'emoji-3d fantasma';
                ghost.textContent = escolhido;
                cell.appendChild(ghost);
            }
        }

        // --- HANDLER DE CLIQUE (L√ìGICA CORRIGIDA) ---
        cell.onclick = () => {
            if (RomanceManager.handleTelepatiaClick(i)) return;
            if (intervalo) return;
            
            if (isTesouro) {
                coletarTesouro(i);
                return;
            }
            
            // SE EXISTIR ITEM (PLANTA, CAMINHO OU FLOR)
            if (item) {
                document.getElementById('painelMotivo').style.display = 'block';
                
                // Exibe o MOTIVO (ex: "Trabalho", "Estudo") e n√£o o nome da planta
                // Se for caminho, exibe "Decora√ß√£o"
                const textoExibido = isCaminho ? "Decora√ß√£o" : item.motivo;
                document.getElementById('textoMotivo').textContent = `Focado em: ${textoExibido}`;
                
                // Caminhos s√£o s√≥lidos: N√ÉO abrem o modal de plantio. Apenas mostram o motivo.
                // Mantemos o painel de motivo vis√≠vel (j√° preenchido acima) e retornamos.
                return; // N√£o abre modal nem permite plantar em cima de caminhos.
            }
            
            if (petAqui) {
                if (RomanceManager.handlePetClick(petAqui)) return;
                if (petAqui.pausado) {
                    const btn = document.querySelector('.btn-carinho-flutuante');
                    if (btn) btn.remove();
                }
                petAqui.pausado = !petAqui.pausado;
                renderJardim3D();
                return;
            }

            // Se estiver vazio, abre modal para plantar
            abrirModalPlanta(i);
        };

        container.appendChild(cell);
    });
}



// Fun√ß√£o auxiliar para controlar visibilidade dos pets
function petDeveAparecer(petIcone) {
    // 1. O C√¥njuge (Guia Escolhido) aparece SEMPRE, independente do modo
    if (RomanceManager && RomanceManager.data && RomanceManager.data.parceiroIcone === petIcone) {
        return true;
    }

    const animaisMarinhos = ['üêã', 'üê†', 'üêü', 'üê°', 'üêô', 'ü¶≠', 'üê¢', 'ü¶¶', 'üßú‚Äç‚ôÇÔ∏è', 'üßú‚Äç‚ôÄÔ∏è'];
    const isMarinho = animaisMarinhos.includes(petIcone);

    // 2. Se estiver no Fundo do Mar:
    if (modoFundoMar) {
        return isMarinho; // Mostra apenas marinhos (e o c√¥njuge j√° passou no check 1)
    } 
    // 3. Se estiver na Terra (Normal, Natal, Medieval, etc):
    else {
        return !isMarinho; // Mostra apenas terrestres
    }
}

function adicionarPlantaAoJardim(novaPlanta) {
    if (modoFundoMar) {
        jardimDataAquatico.push(novaPlanta);
        StorageSeguro.set('jardimAquatico', jardimDataAquatico);
    } else {
        jardimDataNormal.push(novaPlanta);
        StorageSeguro.set('jardim', jardimDataNormal);
    }
    jardimData = modoFundoMar ? jardimDataAquatico : jardimDataNormal;
    renderJardim(); // Atualiza o visual (2D ou 3D conforme o modo)
}
function darCarinho(pet, index) {
    // 1. Recompensa Base
    let valorCarinho = 2;
    
    // Habilidade Pato: +2 moedas por carinho
    if (petsComprados.some(p => p.icone === 'ü¶Ü')) valorCarinho += 2;
    // Habilidade Lhama: +5 moedas por carinho
    if (petsComprados.some(p => p.icone === 'ü¶ô')) valorCarinho += 5;

    updateMoedas(valorCarinho);

    // 2. Salva o tempo no pet original
    const petOriginal = petsComprados.find(p => p.icone === pet.icone && p.nome === pet.nome);
    if (petOriginal) {
        petOriginal.ultimoCarinho = Date.now();
        StorageSeguro.set('petsComprados', petsComprados);
    }

   // 3. Efeito visual simples de m√∫ltiplos cora√ß√µes
const cells = document.querySelectorAll('.cell-3d');
const cellElement = cells[index];

if (cellElement) {
    for (let i = 0; i < 6; i++) {
        setTimeout(() => {
            const heart = document.createElement('div');
            heart.className = 'heart-simple';
            heart.innerHTML = '‚ù§Ô∏è';
            
            // Posi√ß√£o simples: espalha um pouco do centro
            const positions = ['20%', '50%', '80%', '40%', '60%', '30%'];
            heart.style.left = positions[i];
            heart.style.top = '20%';
            
            cellElement.appendChild(heart);
            
            // Remove ap√≥s a anima√ß√£o de 4s
            setTimeout(() => heart.remove(), 4000);
        }, i * 200);
    }
}


    // 4. Feedback r√°pido no topo da tela (Toast Adaptativo)
const aviso = document.createElement('div');

// Adicionamos uma classe base e o HTML interno
aviso.className = 'pet-toast-moderno';
	aviso.innerHTML = `
	    <div class="toast-content">
	        <span class="toast-icon">‚ù§Ô∏è</span>
	        <div class="toast-text">
	            <strong>${pet.nome} adorou o carinho!</strong>
	            <span>Voc√™ ganhou +${valorCarinho} moedas! üí∞</span>
	        </div>
	    </div>
	    <div class="toast-progress"></div>
	`;

document.body.appendChild(aviso);

// Remove o toast ap√≥s 6 segundos (conforme pedido anteriormente)
setTimeout(() => {
    aviso.classList.add('saindo');
    setTimeout(() => aviso.remove(), 500);
}, 6000);
}



function getFailureEmoji(emoji) {
    // --- L√≥gica Espec√≠fica para Modo Fundo do Mar ---
    if (modoFundoMar) {
        // Retorna aleatoriamente a Bota ou a Caixa de Suco (lixo marinho)
        return Math.random() < 0.5 ? 'ü•æ' : 'üßÉ';
    }

    // --- L√≥gica Padr√£o (Existente) ---
    const plantas = ['üå≤','üå≥','üå¥','üåµ','üåæ','üåø','‚òòÔ∏è','üåª','üåπ','üå∑','üçÑ','üçÑ‚Äçüü´','ü™¥'];
    const construcoes = ['üè†','üèØ','üè∞','‚õ™Ô∏è','‚õ©Ô∏è','üõñ','üïå','üõï','üóº'];
    
    if (emoji === 'üåπ') return 'ü•Ä';
    if (emoji === 'üéÅ') return 'ü™§';
    if (construcoes.includes(emoji)) return 'üèö';
    if (plantas.includes(emoji)) return 'ü™æ';
    
    return 'ü™æ';
}

// Verifica se um emoji representa um caminho (impede plantar sobre ele)
function ehCaminhoEmoji(emoji) {
    return TIPOS_CAMINHO.includes(emoji);
}


function calcularStreakDiasAtivos() {
    if (historico.length === 0) {
        streakDiasAtivos = 0;
        StorageSeguro.set('streakDiasAtivos', streakDiasAtivos);
        return;
    }
    
    const historicoOrdenado = [...historico].sort((a, b) => new Date(b.data) - new Date(a.data));
    const sucessos = historicoOrdenado.filter(s => s.status === 'sucesso');
    
    if (sucessos.length === 0) {
        streakDiasAtivos = 0;
        StorageSeguro.set('streakDiasAtivos', streakDiasAtivos);
        return;
    }
    
    const hoje = new Date();
    hoje.setHours(0, 0, 0, 0);
    
    const ontem = new Date(hoje);
    ontem.setDate(hoje.getDate() - 1);
    
    let streak = 0;
    let dataAtual = new Date(hoje);
    
    const temSessaoHoje = sucessos.some(s => {
        const dataSessao = new Date(s.data);
        dataSessao.setHours(0, 0, 0, 0);
        return dataSessao.getTime() === hoje.getTime();
    });
    
    if (!temSessaoHoje) {
        const temSessaoOntem = sucessos.some(s => {
            const dataSessao = new Date(s.data);
            dataSessao.setHours(0, 0, 0, 0);
            return dataSessao.getTime() === ontem.getTime();
        });
        
        if (temSessaoOntem) {
            streakDiasAtivos = StorageSeguro.get('streakDiasAtivos', 0);
            return;
        } else {
            streakDiasAtivos = 0;
            StorageSeguro.set('streakDiasAtivos', streakDiasAtivos);
            return;
        }
    }
    
    let diaContador = 0;
    let encontrouFalha = false;
    
    while (!encontrouFalha && diaContador < 365) {
        const dataVerificar = new Date(hoje);
        dataVerificar.setDate(hoje.getDate() - diaContador);
        dataVerificar.setHours(0, 0, 0, 0);
        
        const temSessaoNesseDia = sucessos.some(s => {
            const dataSessao = new Date(s.data);
            dataSessao.setHours(0, 0, 0, 0);
            return dataSessao.getTime() === dataVerificar.getTime();
        });
        
        if (temSessaoNesseDia) {
            streak++;
            diaContador++;
        } else {
            encontrouFalha = true;
        }
    }
    
    streakDiasAtivos = streak;
    StorageSeguro.set('streakDiasAtivos', streakDiasAtivos);
}

function atualizarStreak() {
    calcularStreakDiasAtivos();
    document.getElementById('streakBadgeValue').textContent = streakDiasAtivos;
    if(document.getElementById('streakBadgeValueSide')) {
        document.getElementById('streakBadgeValueSide').textContent = streakDiasAtivos;
    }
}

function criarParticulas() {
    particulasManager.atualizarTema();
}

function toggleAnimacaoFundo() {
    animacaoFundoAtiva = !animacaoFundoAtiva;
    StorageSeguro.set('animacaoFundoAtiva', animacaoFundoAtiva);
    
    const btn = document.getElementById('btnAnimFundo');
    btn.classList.toggle('on', animacaoFundoAtiva);
    
    if (animacaoFundoAtiva) {
        particulasManager.iniciar();
    } else {
        particulasManager.parar();
    }
}

function chuvaDeEfeitos() {
    efeitosManager.chuvaDeEfeitos();
}

function proximoSom() {
    audioManager.proximoSom();
}

function tocarSino() {
    audioManager.tocarSino();
}

function abrirModal(id) {
    const el = document.getElementById(id);
    const content = el.querySelector('#' + id.replace('Overlay', 'Content')) || el.querySelector('div');
    el.style.display = 'flex';
    content.classList.remove('modal-anim-out');
    content.classList.add('modal-anim-in');

    if (id === 'configOverlay') {
        const inputNome = document.getElementById('configNomeUsuario');
        if (inputNome) {
            inputNome.value = StorageSeguro.get('jogadorNome', '');
        }
    }
}

function fecharModal(id) {
    const el = document.getElementById(id);
    const content = el.querySelector('#' + id.replace('Overlay', 'Content')) || el.querySelector('div');
    content.classList.remove('modal-anim-in');
    content.classList.add('modal-anim-out');
    setTimeout(() => {
        el.style.display = 'none';
        content.classList.remove('modal-anim-out');
    }, 200);
}

function openStartFocusModal() {
    const overlay = document.getElementById("startFocusModalOverlay");
    const content = document.getElementById("startFocusModalContent");

    if (!overlay || !content) return;

    overlay.style.display = "flex";
    content.classList.add("modal-anim-in");
}

function closeStartFocusModal(startFocus) {
    const overlay = document.getElementById("startFocusModalOverlay");
    const content = document.getElementById("startFocusModalContent");

    if (overlay) overlay.style.display = "none";
    if (content) content.classList.remove("modal-anim-in");

    if (startFocus) {
        iniciarTimer(); // usa a sua fun√ß√£o real de iniciar foco
    }
}
function atualizarBotoes() {
    const btnStart = document.getElementById('btnStart');
    const btnAdicionarManual = document.getElementById('btnAdicionarManual');
    const btnDeepFocus = document.getElementById('btnDeepFocus');
    const btnBulldoze = document.getElementById('btnBulldoze');
    const btnParar = document.getElementById('btnParar');
    
    if (intervalo) {
        btnStart.style.display = 'none';
        btnAdicionarManual.style.display = 'none';
        btnDeepFocus.style.display = 'block';
        btnBulldoze.style.display = 'none';
        btnParar.style.display = 'block';
    } else {
        if (alvo !== null) {
            btnStart.style.display = 'block';
            btnAdicionarManual.style.display = 'block';
            btnAdicionarManual.disabled = false;
            btnDeepFocus.style.display = 'none';
            btnBulldoze.style.display = 'block';
            btnParar.style.display = 'none';
        } else {
            btnStart.style.display = 'block';
            btnAdicionarManual.style.display = 'none';
            btnDeepFocus.style.display = 'none';
            btnBulldoze.style.display = 'block';
            btnParar.style.display = 'none';
        }
    }
}
function adicionarFocoManual() {
    document.getElementById('manualMotivo').textContent = document.getElementById('motivoEscolhido').value;
    document.getElementById('manualTempo').textContent = document.getElementById('tempoEscolhido').value;
    abrirModal('manualFocusOverlay');
    salvarTudo();
}

function confirmarFocoManual() {
    const motivo = document.getElementById('motivoEscolhido').value;
    const tempo = parseInt(document.getElementById('tempoEscolhido').value);
    const agora = new Date();
    const isLucky = escolhido === luckyPlant;
    
    const emojiFinal = evoluirEmoji(escolhido);
    
    // Garantir que o alvo √© v√°lido
    if (alvo === null) {
        showModal({ text: "Selecione um espa√ßo no jardim primeiro!", onConfirm: () => {} });
        return;
    }

    // Bloqueio: n√£o permite confirmar plantio em cima de caminhos
    if (jardimData[alvo] && ehCaminhoEmoji(jardimData[alvo].icone)) {
        showToast('‚ö†Ô∏è', 'Imposs√≠vel plantar', 'Voc√™ n√£o pode plantar em cima de caminhos.');
        console.warn('confirmarFocoManual bloqueado: c√©lula com caminho no √≠ndice', alvo);
        return;
    }

    jardimData[alvo] = { 
        icone: emojiFinal, 
        motivo: motivo, 
        lucky: isLucky,
        emProgresso: false 
    }; 
    
    sessoesTotais++; 
    historico.push({ 
        data: agora.toISOString(), 
        minutos: tempo, 
        motivo: motivo, 
        icone: emojiFinal, 
        mes: agora.getMonth(), 
        ano: agora.getFullYear(), 
        status: 'sucesso' 
    }); 
    
    // Sistema Eurosummer: Verificar ciclos (foco manual)
    if (modoEurosummer) {
        eurosummerSessoes++;
        StorageSeguro.set('eurosummerSessoes', eurosummerSessoes);
        
        if (eurosummerSessoes % 3 === 0) {
            const cicloAtual = Math.floor(eurosummerSessoes / 3);
            if (cicloAtual <= 13) {
                mostrarCartaEurosummer(cicloAtual);
            }
        }
    }
    
    // Sistema Fundo do Mar: Verificar metas (foco manual)
    if (modoFundoMar) {
        verificarMetasFundoMar(motivo, tempo);
    }
    
    // Economia: Ganho de moedas manual (reduzido em rela√ß√£o ao foco real)
    let moedasGanhas = isLucky ? 2 : 1;
    updateMoedas(moedasGanhas); 
    
    // Verificar metas do jogo
    verificarMetasConcluidas(motivo, tempo);
    
    // Atualizar visualmente o jardim
    if (modo3D) {
        renderJardim3D();
    } else {
        renderJardim();
    }
    
    alvo = null;
    atualizarStreak();
    salvarTudo(); 
    renderSelects();
    atualizarBotoes();
    
    fecharModal('manualFocusOverlay');
    
    const totalCells = getTotalCells();
    if(jardimData.filter(x => x !== null).length === totalCells) triggerFinalSequence();
}

/* /* =========================================================================
   SISTEMA DE BACKUP PURO (SOMENTE INDEXED DB)
   Autor: Gemini
   Descri√ß√£o: Ignora localStorage. Foca apenas no banco de dados real.
   =========================================================================
*/

const BackupManager = {
    // Detecta o nome do banco
    getDbName: async function() {
        if (typeof DB_CONFIG !== 'undefined' && DB_CONFIG.dbName) return DB_CONFIG.dbName;
        if (window.indexedDB && window.indexedDB.databases) {
            const dbs = await window.indexedDB.databases();
            if (dbs.length > 0) return dbs[0].name;
        }
        return 'GardenFocusDB'; // Nome padr√£o
    },

    // 1. SINCRONIZAR MEM√ìRIA -> BANCO
    sincronizarEstado: function() {
        console.log("üîÑ Salvando RAM no Banco...");
        
        // Lista completa de vari√°veis globais
        const varsParaSalvar = {
            'moedasFoco': (typeof totalMoedas !== 'undefined' ? totalMoedas : null),
            'sessoesTotais': (typeof sessoesTotais !== 'undefined' ? sessoesTotais : null),
            'historico_foco': (typeof historico !== 'undefined' ? historico : null),
            'streakDiasAtivos': (typeof streakDiasAtivos !== 'undefined' ? streakDiasAtivos : null),
            'jardimDataNormal': (typeof jardimDataNormal !== 'undefined' ? jardimDataNormal : null),
            'jardimDataAquatico': (typeof jardimDataAquatico !== 'undefined' ? jardimDataAquatico : null),
            'grid10x10': (typeof grid10x10 !== 'undefined' ? grid10x10 : null),
            'recursos': (typeof recursos !== 'undefined' ? recursos : null),
            'petsComprados': (typeof petsComprados !== 'undefined' ? petsComprados : null),
            'estante_livros': (typeof estante_livros !== 'undefined' ? estante_livros : null),
            'tempos': (typeof tempos !== 'undefined' ? tempos : null),
            'motivos': (typeof motivos !== 'undefined' ? motivos : null),
            'metas': (typeof metas !== 'undefined' ? metas : null),
            'modo3D': (typeof modo3D !== 'undefined' ? modo3D : null),
            'profilePhoto': (typeof profilePhoto !== 'undefined' ? profilePhoto : null),
            'modoEurosummer': (typeof modoEurosummer !== 'undefined' ? modoEurosummer : null),
            'eurosummerEmojisDesbloqueados': (typeof eurosummerEmojisDesbloqueados !== 'undefined' ? eurosummerEmojisDesbloqueados : null),
            'modoFundoMar': (typeof modoFundoMar !== 'undefined' ? modoFundoMar : null),
            'fundoMarComprado': (typeof fundoMarComprado !== 'undefined' ? fundoMarComprado : null),
            'fundoMarMetasConcluidas': (typeof fundoMarMetasConcluidas !== 'undefined' ? fundoMarMetasConcluidas : null)
        };

        // Salva apenas o que existe (n√£o √© null)
        for (const [key, val] of Object.entries(varsParaSalvar)) {
            if (val !== null) StorageSeguro.set(key, val);
        }

        // Managers
        if (typeof RomanceManager !== 'undefined' && RomanceManager.save) RomanceManager.save();
    },

    // 2. EXPORTAR (DB -> ARQUIVO)
    exportarTudo: async function() {
        try {
            this.sincronizarEstado();
            const dbName = await this.getDbName();
            
            console.log(`üì¶ Extraindo dados do banco: ${dbName}`);

            // Acessa o IndexedDB diretamente para pegar TUDO
            const dadosExportados = await new Promise((resolve, reject) => {
                const request = indexedDB.open(dbName);
                request.onerror = () => reject("Erro ao abrir DB");
                request.onsuccess = (e) => {
                    const db = e.target.result;
                    if (db.objectStoreNames.length === 0) return resolve([]);
                    
                    const storeName = db.objectStoreNames[0];
                    const tx = db.transaction(storeName, 'readonly');
                    const store = tx.objectStore(storeName);
                    
                    // Pega todas as chaves e valores
                    const getAll = store.getAllKeys();
                    getAll.onsuccess = () => {
                        const keys = getAll.result;
                        const items = {};
                        let count = 0;
                        
                        if(keys.length === 0) return resolve({});

                        keys.forEach(key => {
                            store.get(key).onsuccess = (ev) => {
                                items[key] = ev.target.result;
                                count++;
                                if(count === keys.length) resolve(items);
                            };
                        });
                    };
                };
            });

            // Estrutura Final do JSON
            const backupFinal = {
                _meta: {
                    versao: "4.0 Pure DB",
                    data: new Date().toISOString()
                },
                dados: dadosExportados
            };

            // Download
            const blob = new Blob([JSON.stringify(backupFinal, null, 2)], { type: "application/json" });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `GardenFocus_DB_${new Date().toLocaleDateString('pt-BR').replace(/\//g,'-')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            alert("‚úÖ Backup Puro (IndexedDB) gerado com sucesso!");

        } catch (erro) {
            console.error(erro);
            alert("Erro: " + erro.message);
        }
    },

    // 3. RESTAURAR (ARQUIVO -> DB)
    restaurarTudo: function(inputElement) {
        const file = inputElement.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = async function(e) {
            try {
                const json = JSON.parse(e.target.result);
                // Suporte para vers√µes antigas (que tinham localStorage separado) ou nova
                const dadosParaRestaurar = json.dados || json.indexedDB || json;

                if (!confirm("‚ö†Ô∏è Isso apagar√° todo o banco de dados atual e restaurar√° o arquivo. Continuar?")) return;

                const dbName = await BackupManager.getDbName();
                
                await new Promise((resolve, reject) => {
                    const request = indexedDB.open(dbName);
                    request.onsuccess = (ev) => {
                        const db = ev.target.result;
                        const storeName = db.objectStoreNames[0];
                        const tx = db.transaction(storeName, 'readwrite');
                        const store = tx.objectStore(storeName);

                        store.clear(); // Limpa tudo

                        // Se for array (vers√£o antiga) ou objeto (vers√£o nova)
                        if (Array.isArray(dadosParaRestaurar)) {
                            dadosParaRestaurar.forEach(item => store.put(item.value, item.key));
                        } else {
                            Object.entries(dadosParaRestaurar).forEach(([key, val]) => {
                                if(key !== '_meta') store.put(val, key);
                            });
                        }

                        tx.oncomplete = () => resolve();
                    };
                });

                alert("‚úÖ Restaurado! Recarregando...");
                window.location.reload();

            } catch (erro) {
                alert("Arquivo inv√°lido.");
                console.error(erro);
            }
        };
        reader.readAsText(file);
    }
};


function mostrarAjudaBackup() {
    const mensagem = `
        <strong>üíæ Como funciona o Backup?</strong><br><br>
        
        <strong>üì§ EXPORTAR:</strong><br>
        Cria um arquivo JSON com todos os seus dados para download.<br><br>
        
        <strong>üì• IMPORTAR:</strong><br>
        Restaura seus dados a partir de um arquivo de backup.<br><br>
        
        <strong>üìã Dados salvos no backup:</strong><br>
        ‚Ä¢ üå± Jardim (plantas e posi√ß√µes)<br>
        ‚Ä¢ üìä Hist√≥rico completo de foco<br>
        ‚Ä¢ ü™ô Moedas acumuladas<br>
        ‚Ä¢ üìö Estante de livros<br>
        ‚Ä¢ ‚òÄÔ∏è Streak (sequ√™ncia de dias)<br>
        ‚Ä¢ ‚è±Ô∏è Tempos e motivos personalizados<br>
        ‚Ä¢ ‚öôÔ∏è Todas as configura√ß√µes<br>
        ‚Ä¢ üì∑ Foto de perfil<br><br>
        
        <strong>üí° Dica:</strong><br>
        Use esta fun√ß√£o para transferir seus dados entre navegadores ou dispositivos diferentes!
    `;
    
    showModal({ 
        text: mensagem, 
        onConfirm: () => {} 
    });
}

// ==========================================
// FUN√á√ÉO DE RESET TOTAL (CORRIGIDA E ROBUSTA)
// ==========================================
// ==========================================
// 1. SISTEMA DE MODAIS DO JOGO (NOVO)
// ==========================================

// Injeta o HTML do modal na p√°gina se n√£o existir
if (!document.getElementById('custom-modal-overlay')) {
    const modalHTML = `
        <div id="custom-modal-overlay">
            <div class="custom-modal-box">
                <div id="custom-modal-icon" class="custom-modal-icon">‚ú®</div>
                <div id="custom-modal-title" class="custom-modal-title">T√≠tulo</div>
                <div id="custom-modal-msg" class="custom-modal-msg">Mensagem</div>
                <div id="custom-modal-actions" class="custom-modal-actions"></div>
            </div>
        </div>`;
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

// Fun√ß√£o Gen√©rica para chamar o Modal (Retorna uma Promise)
function exibirModal(titulo, mensagem, tipo = 'alert', icone = '') {
    return new Promise((resolve) => {
        const overlay = document.getElementById('custom-modal-overlay');
        const box = overlay.querySelector('.custom-modal-box');
        const titleEl = document.getElementById('custom-modal-title');
        const msgEl = document.getElementById('custom-modal-msg');
        const iconEl = document.getElementById('custom-modal-icon');
        const actionsEl = document.getElementById('custom-modal-actions');
        
        // Configura textos
        titleEl.innerText = titulo;
        msgEl.innerHTML = mensagem.replace(/\n/g, '<br>'); // Suporta quebra de linha
        iconEl.innerText = icone || (tipo === 'danger' ? 'üíÄ' : (tipo === 'confirm' ? 'ü§î' : '‚ú®'));
        iconEl.style.display = 'block';

        // Limpa bot√µes antigos
        actionsEl.innerHTML = ''; 

        // Cria bot√µes baseados no tipo
        if (tipo === 'confirm' || tipo === 'danger') {
            const btnCancel = document.createElement('button');
            btnCancel.className = 'custom-modal-btn btn-modal-cancel';
            btnCancel.innerText = 'Cancelar';
            btnCancel.onclick = () => fechar(false);
            
            const btnConfirm = document.createElement('button');
            btnConfirm.className = `custom-modal-btn ${tipo === 'danger' ? 'btn-modal-danger' : 'btn-modal-confirm'}`;
            btnConfirm.innerText = tipo === 'danger' ? 'SIM, APAGAR!' : 'Confirmar';
            btnConfirm.onclick = () => fechar(true);
            
            actionsEl.appendChild(btnCancel);
            actionsEl.appendChild(btnConfirm);
        } else {
            // Apenas Alerta
            const btnOk = document.createElement('button');
            btnOk.className = 'custom-modal-btn btn-modal-confirm';
            btnOk.innerText = 'Entendi';
            btnOk.onclick = () => fechar(true);
            actionsEl.appendChild(btnOk);
        }

        // Mostra o modal
        overlay.style.display = 'flex';
        // Pequeno delay para permitir a transi√ß√£o CSS
        setTimeout(() => {
            overlay.style.opacity = '1';
            box.style.transform = 'translateY(0) scale(1)';
        }, 10);

        function fechar(valor) {
            overlay.style.opacity = '0';
            box.style.transform = 'translateY(20px) scale(0.9)';
            setTimeout(() => {
                overlay.style.display = 'none';
                resolve(valor); // Retorna true ou false para quem chamou
            }, 300);
        }
    });
}

// ==========================================
// 2. FUN√á√ÉO RESET ABSOLUTO (INTEGRADA)
// ==========================================
async function resetAbsoluto() {
    // Passo 1: Aviso de Perigo (Estilo "Danger")
    const confirmacao1 = await exibirModal(
        "Zona de Perigo", 
        "Voc√™ est√° prestes a apagar <b>TODO</b> o seu progresso, moedas e di√°rio.<br><br>Isso n√£o pode ser desfeito.", 
        "danger",
        "‚ö†Ô∏è"
    );
    
    if (!confirmacao1) return; // Se cancelou, para tudo

    // Passo 2: Certeza Absoluta (Estilo "Confirm")
    const confirmacao2 = await exibirModal(
        "√öltima Chance",
        "Tem certeza absoluta? Seu jardim voltar√° a ser um terreno vazio.",
        "confirm",
        "üóëÔ∏è"
    );

    if (!confirmacao2) return;

    // Passo 3: Execu√ß√£o
    // Muda o texto do bot√£o visualmente se existir
    const btn = document.getElementById('btnReset'); 
    if(btn) btn.innerText = "Apagando...";
    
    // Mostra um modal de "Carregando" (sem bot√µes por enquanto)
    const overlay = document.getElementById('custom-modal-overlay');
    document.getElementById('custom-modal-title').innerText = "Reiniciando...";
    document.getElementById('custom-modal-msg').innerText = "Limpando mem√≥rias e banco de dados...";
    document.getElementById('custom-modal-actions').innerHTML = ''; // Sem bot√µes para n√£o clicar
    overlay.style.display = 'flex';
    overlay.style.opacity = '1';

    try {
        console.log("üî• Iniciando Protocolo de Reset...");

        localStorage.clear();
        sessionStorage.clear();
        
        // Deletar DB (Fun√ß√£o auxiliar necess√°ria)
        await deletarBancoDados('GardenFocusDB');
        
        console.log("‚úÖ Limpeza conclu√≠da.");
        
        // Redireciona para home limpa
        setTimeout(() => {
            window.location.href = window.location.href.split('?')[0];
            window.location.reload(true);
        }, 1500); // Um tempinho para o usu√°rio ler a mensagem

    } catch (erro) {
        console.error("‚ùå Erro:", erro);
        await exibirModal("Erro", "Falha ao limpar: " + erro.message, "alert");
        window.location.reload();
    }
}

// Fun√ß√£o Auxiliar de Banco de Dados (Mantida a mesma l√≥gica segura)
function deletarBancoDados(nomeBanco) {
    return new Promise((resolve, reject) => {
        if (window.db) { try { window.db.close(); } catch(e) {} }
        const req = indexedDB.deleteDatabase(nomeBanco);
        req.onsuccess = () => resolve();
        req.onerror = () => reject(new Error("Erro no IndexedDB"));
        req.onblocked = () => {
             // Se bloquear, for√ßamos o reload mesmo assim
             window.location.reload();
        };
    });
}

// Fun√ß√£o para verificar e pedir o nome ao iniciar
async function verificarInicioUsuario() {
    try {
        // Tenta buscar o nome salvo no banco
        let nome = await StorageSeguro.get('nome_usuario');

        // Se N√ÉO tiver nome (ou seja, √© um novo jogo ou acabou de resetar)
        if (!nome || nome.trim() === '') {
            
            // Loop para garantir que o usu√°rio digite algo v√°lido
            while (!nome || nome.trim() === '') {
                nome = prompt("üå± Bem-vindo(a) ao Garden Focus!\n\nComo voc√™ gostaria de ser chamado(a)?");
                
                // Se o usu√°rio cancelar, definimos um padr√£o para n√£o quebrar
                if (nome === null) {
                    nome = "Jardineiro(a)";
                    break;
                }
            }
            
            // Salva o novo nome
            await StorageSeguro.set('nome_usuario', nome);
            
            // (Opcional) D√° moedas iniciais de presente
            await StorageSeguro.set('moedas', 50);
            
            // Feedback simples
            // alert(`Prazer, ${nome}! Voc√™ come√ßou com 50 moedas.`);
        }

        // Atualiza a exibi√ß√£o na tela (se o elemento existir)
        const elementoSaudacao = document.getElementById('saudacaoUsuario');
        if (elementoSaudacao) {
            elementoSaudacao.innerHTML = `Ol√°, <strong>${nome}</strong>`;
        }

    } catch (erro) {
        console.error("Erro ao verificar usu√°rio:", erro);
    }
}


function atualizarTogglesTemasLoja() {
    const containerMed = document.getElementById('containerMedievalLoja');
    const containerCandy = document.getElementById('containerCandyforniaLoja');
    const containerEuro = document.getElementById('containerEurosummerLoja');
    const containerFundoMar = document.getElementById('containerFundoMarLoja');
    
    if (medievalComprado && containerMed) {
        containerMed.innerHTML = `
            <div class="ios-switch-container" style="margin-top: 5px;">
                <div id="btnMedievalLoja" class="ios-switch ${modoMedieval ? 'on' : ''}" onclick="toggleMedieval()">
                    <div class="ios-switch-thumb"></div>
                </div>
            </div>`;
    }
    
    if (candyforniaComprado && containerCandy) {
        containerCandy.innerHTML = `
            <div class="ios-switch-container" style="margin-top: 5px;">
                <div id="btnCandyforniaLoja" class="ios-switch ${modoCandyfornia ? 'on' : ''}" onclick="toggleCandyfornia()">
                    <div class="ios-switch-thumb"></div>
                </div>
            </div>`;
    }
    
     if (eurosummerComprado && containerEuro) {
        containerEuro.innerHTML = `
            <div class="ios-switch-container" style="margin-top: 5px; flex-direction: column; gap: 10px;">
                <div id="btnEurosummerLoja" class="ios-switch ${modoEurosummer ? 'on' : ''}" onclick="toggleEurosummer()">
                    <div class="ios-switch-thumb"></div>
                </div>
                <button onclick="reiniciarEurosummer()" title="Reiniciar Hist√≥ria" style="background: var(--plot-empty); color: var(--text-main); border: none; border-radius: 50px !important; padding: 3px 8px; cursor: pointer; font-size: 10px; margin-top: 5px; opacity: 0.7; ">üîÑ Reset Hist√≥ria</button>
            </div>
        `;
    }
    
    if (fundoMarComprado && containerFundoMar) {
        containerFundoMar.innerHTML = `
            <div class="ios-switch-container" style="margin-top: 5px; flex-direction: column; gap: 10px;">
                <div id="btnFundoMarLoja" class="ios-switch ${modoFundoMar ? 'on' : ''}" onclick="toggleFundoMar()">
                    <div class="ios-switch-thumb"></div>
                </div>
                <button onclick="reiniciarFundoMar()" title="Reiniciar Hist√≥ria" style="background: var(--plot-empty); color: var(--text-main); border: none; border-radius: 50px !important; padding: 3px 8px; cursor: pointer; font-size: 10px; margin-top: 5px; opacity: 0.7; ">üîÑ Reset Hist√≥ria</button>
            </div>
        `;
    }
    
    const btnNatal = document.getElementById('btnNatal');
    if (btnNatal) btnNatal.classList.toggle('on', modoNatal);
}
function calcularPrecoFinal(precoBase, idItem = null, iconePet = null) {
    let preco = precoBase;

    // Verificar se o pet √© uma recompensa de meta do Fundo do Mar
    const metaRelacionada = METAS_FUNDO_MAR.find(m => m.petGratis === iconePet);
    if (metaRelacionada && fundoMarMetasConcluidas.includes(metaRelacionada.id)) {
        return 0; // Gratuito se a meta foi conclu√≠da
    }

    // Caso especial: Sereia ou Trit√£o (Meta 7) - Apenas o escolhido √© gratuito
    if ((iconePet === 'üßú‚Äç‚ôÄÔ∏è' || iconePet === 'üßú‚Äç‚ôÇÔ∏è') && fundoMarMetasConcluidas.includes(7)) {
        return iconePet === guiaEscolhidoFundoMar ? 0 : precoBase;
    }

    // Habilidade Porquinho: 10% desconto em TUDO (exceto no pr√≥prio porquinho)
    if (petsComprados.some(p => p.icone === 'üêñ') && iconePet !== 'üêñ') {
        preco = Math.floor(preco * 0.9);
    }
    // Habilidade Castor: 20% desconto em constru√ß√µes (temas)
    if (idItem && (idItem === 'medieval' || idItem === 'candyfornia') && petsComprados.some(p => p.icone === 'ü¶´')) {
        preco = Math.floor(preco * 0.8);
    }
    return preco;
}


function comprarItemLoja(id, preco) {
    const precoFinal = calcularPrecoFinal(preco, id, null);

    // Verifica√ß√£o de seguran√ßa para evitar compras duplicadas ou saldo negativo
    if (totalMoedas >= precoFinal) {
        // Bloqueia o bot√£o temporariamente se existir para evitar cliques duplos
        const btnId = id === 'medieval' ? 'btnComprarMedieval' : (id === 'candyfornia' ? 'btnComprarCandyfornia' : (id === 'eurosummer' ? 'btnComprarEurosummer' : 'btnComprarFundoMar'));
        const btn = document.getElementById(btnId);
        if (btn) btn.disabled = true;

        updateMoedas(-precoFinal);
        if (id === 'medieval') {
            medievalComprado = true;
            StorageSeguro.set('medievalComprado', true);
            atualizarTogglesTemasLoja();
            showModal({ 
                text: "üè∞ Reino Medieval Desbloqueado!<br><br>O modo Medieval est√° agora dispon√≠vel para ativa√ß√£o aqui na loja.", 
                onConfirm: () => {} 
            });
        }
        
        if (id === 'candyfornia') {
            candyforniaComprado = true;
            StorageSeguro.set('candyforniaComprado', true);
            atualizarTogglesTemasLoja();
            showModal({ 
                text: "üç≠ Candyfornia Desbloqueado!<br><br>O modo Candyfornia est√° agora dispon√≠vel para ativa√ß√£o aqui na loja.", 
                onConfirm: () => {} 
            });
        }
        
        if (id === 'eurosummer') {
            eurosummerComprado = true;
            vistoIntroEurosummer = false;
            StorageSeguro.set('eurosummerComprado', true);
            StorageSeguro.set('vistoIntroEurosummer', false);
            atualizarTogglesTemasLoja();
            showModal({ 
                text: "üèõÔ∏è Eurosummer Desbloqueado!<br><br>Bem-vindo √† Riviera. Entre ru√≠nas e o perfume dos limoeiros, desbloqueia mem√≥rias de um ver√£o eterno a cada 3 sess√µes de foco.<br><br>O modo est√° agora dispon√≠vel para ativa√ß√£o aqui na loja.", 
                onConfirm: () => {} 
            });
        }
        
        if (id === 'fundomar') {
            fundoMarComprado = true;
            vistoIntroFundoMar = false;
            StorageSeguro.set('fundoMarComprado', true);
            StorageSeguro.set('vistoIntroFundoMar', false);
            atualizarTogglesTemasLoja();
            showModal({ 
                text: "üßú‚Äç‚ôÄÔ∏è Reino de Coral Desbloqueado!<br><br>Tudo escureceu depois da tempestade. Acordei longe da superf√≠cie, num jardim de corais, salvo por algu√©m que n√£o √© do meu mundo...<br><br>Desbloqueia mem√≥rias subaqu√°ticas a cada 3 sess√µes de foco. O modo est√° agora dispon√≠vel para ativa√ß√£o aqui na loja.", 
                onConfirm: () => {} 
            });
        }
        
        document.getElementById('saldoLojaMoedas').textContent = totalMoedas;
        
        // Atualizar saldo no menu tamb√©m
        document.getElementById('userMoedas').textContent = totalMoedas;
        
    } else {
        showModal({ text: "Moedas insuficientes! Foque mais para ganhar.", onConfirm: () => {} });
    }
}

// Fun√ß√£o auxiliar para encontrar cards pelo t√≠tulo
function encontrarCardPorTitulo(titulo) {
    const cards = document.querySelectorAll('.config-card');
    for (let card of cards) {
        const h4 = card.querySelector('h4');
        if (h4 && h4.textContent.includes(titulo)) {
            return card;
        }
    }
    return null;
}

function atualizarTimerDisplay() { document.getElementById('timer').textContent = `${String(document.getElementById('tempoEscolhido').value).padStart(2,'0')}:00`; }

function acessarDebugViaTitulo() {
    const v = prompt("Digite a senha de acesso:");
    if (v === "Luiz") {
        abrirModal('debugOverlay');
    } else {
        showModal({ text: "Senha incorreta.", onConfirm: () => {} });
    }
}



function toggleDeepFocus(active) {
    const body = document.body;
    const deepControls = document.querySelector('.deep-focus-controls');
    const startBtn = document.getElementById('btnStart');
    const deepBtn = document.getElementById('btnDeepFocus');
    const pararBtn = document.getElementById('btnParar');
    if (active) {
        body.classList.add('deep-focus-active');
        deepControls.style.display = 'block';
        document.getElementById('plantaFocoProfundo').textContent = escolhido;
        startBtn.style.display = 'none';
        deepBtn.style.display = 'none';
        pararBtn.style.display = intervalo ? 'block' : 'none';
    } else {
        body.classList.remove('deep-focus-active');
        deepControls.style.display = 'none';
        if (intervalo) { 
            deepBtn.style.display = 'block'; 
            startBtn.style.display = 'none'; 
            pararBtn.style.display = 'block';
        } else { 
            deepBtn.style.display = 'none'; 
            startBtn.style.display = 'block'; 
            pararBtn.style.display = 'none';
        }
    }
    atualizarBotoes();
}

function updateMoedas(amount) {
    const valorAdicionar = Number(amount) || 0;
    totalMoedas = (Number(totalMoedas) || 0) + valorAdicionar;
    if (totalMoedas < 0) totalMoedas = 0; // Evita saldo negativo tamb√©m
    StorageSeguro.set('moedasFoco', totalMoedas);
    
    // Atualizar saldo em todos os lugares da interface
    const elementosSaldo = ['userMoedas', 'saldoLojaMoedas', 'userMoedasConfig'];
    elementosSaldo.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.textContent = totalMoedas;
    });
}

function setLuckyPlant() {
    const today = new Date().toDateString();
    let seed = 0;
    for(let i=0; i<today.length; i++) seed += today.charCodeAt(i);
    const pool = modoFundoMar ? (fundoMarEmojisDesbloqueados.length > 0 ? fundoMarEmojisDesbloqueados : ITENS_PADRAO) : (modoEurosummer ? (eurosummerEmojisDesbloqueados.length > 0 ? eurosummerEmojisDesbloqueados : ITENS_PADRAO) : (modoCandyfornia ? ITENS_CANDYFORNIA : (modoNatal ? ITENS_NATAL : (modoMedieval ? ITENS_MEDIEVAL : ITENS_PADRAO))));
    luckyPlant = pool[seed % pool.length];
    // Habilidade Girafa: Revela a Planta da Sorte
    const tagSorte = document.getElementById('luckyPlantTag');
    if (petsComprados.some(p => p.icone === 'ü¶í')) {
        tagSorte.style.display = 'block';
        tagSorte.textContent = `Sorte do dia: ${luckyPlant} (Moedas 2x)`;
    } else {
        tagSorte.style.display = 'none';
    }
}

// Fun√ß√£o para obter o tamanho atual do grid
function getGridSize() {
    return grid10x10 ? 10 : 5;
}

// Fun√ß√£o para obter o n√∫mero total de c√©lulas
function getTotalCells() {
    const size = getGridSize();
    return size * size;
}


// Fun√ß√£o para inicializar o jardimData com o tamanho correto
function initJardimData() {
    const totalCells = getTotalCells();
    
    // CORRE√á√ÉO: Carrega explicitamente o grid correto baseado no modo atual
    if (modoFundoMar) {
        jardimData = StorageSeguro.get('jardimAquatico', Array(totalCells).fill(null));
        jardimDataAquatico = jardimData;
    } else {
        jardimData = StorageSeguro.get('jardim', Array(totalCells).fill(null));
        jardimDataNormal = jardimData;
    }
    
    // Verifica√ß√£o de seguran√ßa para redimensionamento (se mudar de 5x5 para 10x10 ou vice-versa)
    if (!jardimData || jardimData.length !== totalCells) {
        if (grid10x10 && jardimData && jardimData.length === 25) {
            const newJardimData = Array(100).fill(null);
            for (let y = 0; y < 5; y++) {
                for (let x = 0; x < 5; x++) {
                    const oldIndex = y * 5 + x;
                    const newIndex = (y * 2) * 10 + (x * 2);
                    if (jardimData[oldIndex]) {
                        newJardimData[newIndex] = jardimData[oldIndex];
                    }
                }
            }
            jardimData = newJardimData;
        } 
        else if (!grid10x10 && jardimData && jardimData.length === 100) {
            const newJardimData = Array(25).fill(null);
            let indexDestino = 0;
            for (let i = 0; i < jardimData.length && indexDestino < 25; i++) {
                if (jardimData[i]) {
                    newJardimData[indexDestino] = jardimData[i];
                    indexDestino++;
                }
            }
            jardimData = newJardimData;
        } 
        else {
            const oldData = jardimData ? [...jardimData] : [];
            jardimData = Array(totalCells).fill(null);
            for(let i = 0; i < Math.min(oldData.length, totalCells); i++) {
                jardimData[i] = oldData[i];
            }
        }
        
        // Salva a estrutura corrigida
        if (modoFundoMar) {
            jardimDataAquatico = jardimData;
            StorageSeguro.set('jardimAquatico', jardimDataAquatico);
        } else {
            jardimDataNormal = jardimData;
            StorageSeguro.set('jardim', jardimDataNormal);
        }
    }
}

// NOVO: Fun√ß√£o para alternar entre grid 5x5 e 10x10
function toggleGrid10x10() {
    grid10x10 = !grid10x10;
    StorageSeguro.set('grid10x10', grid10x10);
    
    // 1. Aplica a classe ao body imediatamente
    if (grid10x10) {
        document.body.classList.add('grid-10x10');
    } else {
        document.body.classList.remove('grid-10x10');
    }
    
    // Atualiza bot√µes da interface
    const btnGrid10x10Config = document.getElementById('btnGrid10x10Toggle');
    if (btnGrid10x10Config) {
        btnGrid10x10Config.classList.toggle('on', grid10x10);
    }
    
    const debugOverlay = document.getElementById('debugOverlay');
    if (debugOverlay && debugOverlay.style.display === 'flex') {
        const btn = document.getElementById('btnGrid10x10');
        if (btn) btn.textContent = `Grid ${grid10x10 ? '5x5' : '10x10'} (Modo Debug)`;
    }
    
    // 2. Garante que os dados est√£o corretos (25 ou 100 c√©lulas)
    initJardimData();
    
    // 3. Renderiza com um pequeno delay ou requestAnimationFrame para garantir
    // que o navegador reconheceu a mudan√ßa da classe CSS 'grid-10x10'
    requestAnimationFrame(() => {
        renderJardim();
        if (modo3D) ajustarTamanho3D();
    });
    
    showModal({ 
        text: `Grid alterado para ${getGridSize()}x${getGridSize()}!<br><br>O jardim foi ${grid10x10 ? 'expandido' : 'reduzido'} e as plantas foram reposicionadas.`, 
        onConfirm: () => {} 
    });
}

function ganharMoedasDebug() {
    // Adicionar 200 moedas
    const moedasAntigas = totalMoedas;
    totalMoedas += 200;
    
    // Atualizar storage
    StorageSeguro.set('moedasFoco', totalMoedas);
    
    // Atualizar display
    document.getElementById('userMoedas').textContent = totalMoedas;
    
    // Se a loja estiver aberta, atualizar l√° tamb√©m
    const saldoLoja = document.getElementById('saldoLojaMoedas');
    if (saldoLoja) {
        saldoLoja.textContent = totalMoedas;
    }
    
    // Mostrar confirma√ß√£o
    showModal({ 
        text: `üí∞ +200 Moedas Adicionadas!<br><br>Saldo anterior: ${moedasAntigas} üí∞<br>Novo saldo: ${totalMoedas} üí∞<br><br>Agora voc√™ pode comprar itens na loja!`, 
        onConfirm: () => {} 
    });
    
    // Efeito visual
    chuvaDeEfeitos('üí∞', 20);
    
    // Fechar modal de debug
    fecharModal('debugOverlay');
}

function fillGridTest() {
    const totalCells = getTotalCells();
    const testEmoji = grid10x10 ? 'ü™¥' : 'ü™¥';
    jardimData = Array(totalCells).fill({ icone: testEmoji, motivo: 'Teste Debug', lucky: false });
    salvarTudo();
    triggerFinalSequence();
}

function addMaxStarsTest() {
    for(let i=0; i<5; i++) { estante.push({ nome: `Livro ${i+1}`, nota: 5, cor: '#4caf50' }); }
    StorageSeguro.set('estante_livros', estante);
    renderEstante();
    renderEstrelasNoCeu();
}

function simularSucessosTest() {
    const agora = new Date();
    for(let i=0; i<10; i++) {
        const diaSimulado = new Date();
        diaSimulado.setDate(agora.getDate() - i);
        historico.push({
            data: diaSimulado.toISOString(), minutos: 25, motivo: motivos[0],
            icone: ITENS_PADRAO[0], mes: agora.getMonth(), ano: agora.getFullYear(), status: 'sucesso'
        });
    }
    sessoesTotais += 10;
    atualizarStreak();
    salvarTudo();
    showModal({ text: "10 sucessos inseridos no hist√≥rico!", onConfirm: () => {} });
}

function debugAvancarEurosummer() {
    eurosummerSessoes += 3;
    StorageSeguro.set('eurosummerSessoes', eurosummerSessoes);
    const cicloAtual = Math.floor(eurosummerSessoes / 3);
    // A fun√ß√£o correta √© mostrarCartaEurosummer(ciclo)
    mostrarCartaEurosummer(cicloAtual);
}

function debugAvancarFundoMar() {
    const proximaMeta = METAS_FUNDO_MAR.find(m => !fundoMarMetasConcluidas.includes(m.id));
    if (proximaMeta) {
        // A l√≥gica de conclus√£o de metas do Fundo do Mar est√° em verificarMetasFundoMar
        // Mas para debug, podemos simular a conclus√£o diretamente
        fundoMarMetasConcluidas.push(proximaMeta.id);
        StorageSeguro.set('fundoMarMetasConcluidas', fundoMarMetasConcluidas);
        mostrarCartaFundoMar(proximaMeta);
        renderMetasFundoMar();
    } else {
        showModal({ text: "Todas as metas do Fundo do Mar j√° foram conclu√≠das!", onConfirm: () => {} });
    }
}

function debugResetarHistorias() {
    showModal({
        text: "Deseja resetar o progresso do Eurosummer e Fundo do Mar?",
        onConfirm: () => {
            eurosummerSessoes = 0;
            eurosummerEmojisDesbloqueados = [];
            fundoMarMetasConcluidas = [];
            fundoMarEmojisDesbloqueados = [];
            StorageSeguro.set('eurosummerSessoes', 0);
            StorageSeguro.set('eurosummerEmojisDesbloqueados', []);
            StorageSeguro.set('fundoMarMetasConcluidas', []);
            StorageSeguro.set('fundoMarEmojisDesbloqueados', []);
            location.reload();
        }
    });
}


   

function triggerFinalSequence() {
    const grid2D = document.getElementById('jardim');
    const grid3D = document.getElementById('grid3D');
    
    if (modo3D) {
        grid3D.classList.add('zoom-out-effect');
    } else {
        grid2D.classList.add('zoom-out-effect');
    }
    
    setTimeout(() => {
        showModal({ 
            text: `üåü PARAB√âNS! Voc√™ completou um ciclo de foco! Seu jardim ${grid10x10 ? '10x10' : '5x5'} floresceu lindamente e est√° pronto para novas sementes.`, 
            onConfirm: () => {
                const totalCells = getTotalCells();
                jardimData = Array(totalCells).fill(null);
                grid2D.classList.remove('zoom-out-effect');
                grid3D.classList.remove('zoom-out-effect');
                salvarTudo();
            }
        });
    }, 2000);
}

// 1. NOVA FUN√á√ÉO DE AN√ÅLISE (Otimizada)
function analisarMelhoresMomentos() {
    // Tenta pegar o hist√≥rico se ele n√£o estiver global
    const historicoAtual = typeof historico !== 'undefined' ? historico : JSON.parse(localStorage.getItem('historico_foco') || '[]');
    
    if (historicoAtual.length < 3) return null;

    const contagemPeriodos = { 'manh√£': 0, 'tarde': 0, 'noite': 0, 'madrugada': 0 };
    const contagemDias = [0, 0, 0, 0, 0, 0, 0]; 
    const nomesDias = ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'];
    const iconesPeriodos = { 'manh√£': 'üåÖ', 'tarde': '‚òÄÔ∏è', 'noite': 'üåô', 'madrugada': 'ü¶â' };

    const sucessos = historicoAtual.filter(s => s.status === 'sucesso');

    if (sucessos.length === 0) return null;

    sucessos.forEach(s => {
        const data = new Date(s.data);
        const hora = data.getHours();
        const dia = data.getDay();
        contagemDias[dia]++;

        if (hora >= 5 && hora < 12) contagemPeriodos['manh√£']++;
        else if (hora >= 12 && hora < 17) contagemPeriodos['tarde']++;
        else if (hora >= 17 && hora < 21) contagemPeriodos['noite']++;
        else contagemPeriodos['madrugada']++;
    });

    const melhorP = Object.keys(contagemPeriodos).reduce((a, b) => contagemPeriodos[a] > contagemPeriodos[b] ? a : b);
    const melhorDIdx = contagemDias.indexOf(Math.max(...contagemDias));

    return {
        periodo: `${iconesPeriodos[melhorP]} ${melhorP.charAt(0).toUpperCase() + melhorP.slice(1)}`,
        dia: `üìÖ ${nomesDias[melhorDIdx]}`
    };
}

// 2. FUN√á√ÉO CALCULAR PREVIS√ÉO ATUALIZADA
function calcularPrevisao() {
    const painel = document.getElementById('painelInteligencia');
    if (!painel) return;

    // Pega dados do hist√≥rico
    const h = typeof historico !== 'undefined' ? historico : JSON.parse(localStorage.getItem('historico_foco') || '[]');
    
    // Se n√£o tiver dado nenhum ou op√ß√£o desligada
    if (typeof mostrarPrevisao !== 'undefined' && !mostrarPrevisao) {
        painel.style.display = 'none';
        return;
    }

    if (h.length < 3) {
        painel.style.display = 'block';
        painel.innerHTML = `<strong>‚ú® Calibrando...</strong><div class="detalhes-intel"><small>Complete mais sess√µes para ver seus padr√µes.</small></div>`;
        return;
    }

    // L√≥gica de c√°lculo (reutilizando a l√≥gica que voc√™ j√° tinha)
    const now = new Date();
    const motivoAtual = document.getElementById('motivoEscolhido')?.value || "Geral";
    const fatores = calcularFatoresPredictivos(now.getDay(), getPeriodo(now.getHours()), motivoAtual);
    
    const probabilidade = Math.round(
        fatores.diaMatch * 0.15 + fatores.periodoMatch * 0.15 + fatores.motivoMatch * 0.25 +
        fatores.duracaoMedia * 0.10 + fatores.tendenciaRecente * 0.15 +
        fatores.consistencia * 0.10 + fatores.momentumSemanal * 0.10
    );

    const cor = probabilidade > 70 ? '#4caf50' : (probabilidade < 40 ? '#e57373' : '#ffb74d');
    const insights = analisarMelhoresMomentos();

    // Monta o HTML
    painel.style.display = 'block';
    painel.style.borderColor = cor;
    painel.style.color = cor;

    let htmlInterno = `<strong>‚ú® ${probabilidade}% Sucesso</strong>`;
    htmlInterno += `<div class="detalhes-intel">`;
    htmlInterno += `<small style="display:block; margin-bottom:5px;">${probabilidade > 70 ? 'Foco Alt√≠ssimo!' : 'Cuidado com distra√ß√µes'}</small>`;
    
    if (insights) {
        htmlInterno += `
            <div style="border-top:1px dashed rgba(0,0,0,0.1); margin-top:8px; padding-top:8px; font-size:11px; color:#555;">
                <div style="margin-bottom:3px">üèÜ <b>Melhor Performance:</b></div>
                <div>${insights.periodo}</div>
                <div>${insights.dia}</div>
            </div>
        `;
    }
    
    htmlInterno += `</div>`;
    painel.innerHTML = htmlInterno;

    // GARANTE QUE O CLIQUE FUNCIONE:
    painel.onclick = function() {
        this.classList.toggle('expandido');
    };
}

// Fun√ß√£o auxiliar para o per√≠odo
function getPeriodo(hora) {
    if (hora >= 5 && hora < 12) return 'manh√£';
    if (hora >= 12 && hora < 17) return 'tarde';
    if (hora >= 17 && hora < 21) return 'noite';
    return 'madrugada';
}

function calcularFatoresPredictivos(diaAtual, periodoAtual, motivoAtual) {
    // Fator 1: Desempenho no mesmo dia da semana
    const sessoesDia = historico.filter(s => new Date(s.data).getDay() === diaAtual);
    const sucessosDia = sessoesDia.filter(s => s.status === 'sucesso' || s.status === 'parcial').length;
    const diaMatch = sessoesDia.length > 0 ? (sucessosDia / sessoesDia.length) * 100 : 50;
    
    // Fator 2: Desempenho no mesmo per√≠odo do dia
    const sessoesPeriodo = historico.filter(s => {
        const h = new Date(s.data).getHours();
        let p;
        if (h >= 5 && h < 12) p = 'manh√£';
        else if (h >= 12 && h < 17) p = 'tarde';
        else if (h >= 17 && h < 21) p = 'noite';
        else p = 'madrugada';
        return p === periodoAtual;
    });
    const sucessosPeriodo = sessoesPeriodo.filter(s => s.status === 'sucesso' || s.status === 'parcial').length;
    const periodoMatch = sessoesPeriodo.length > 0 ? (sucessosPeriodo / sessoesPeriodo.length) * 100 : 50;
    
    // Fator 3: Desempenho com o mesmo motivo
    const sessoeMotivo = historico.filter(s => s.motivo === motivoAtual);
    const sucessosMotivo = sessoeMotivo.filter(s => s.status === 'sucesso' || s.status === 'parcial').length;
    const motivoMatch = sessoeMotivo.length > 0 ? (sucessosMotivo / sessoeMotivo.length) * 100 : 50;
    
    // Fator 4: Dura√ß√£o m√©dia das sess√µes bem-sucedidas
    const sessoesSucesso = historico.filter(s => s.status === 'sucesso');
    const duracaoMedia = sessoesSucesso.length > 0 
        ? Math.min(100, (sessoesSucesso.reduce((sum, s) => sum + (s.minutos || 0), 0) / sessoesSucesso.length) / 30 * 100)
        : 50;
    
    // Fator 5: Tend√™ncia recente (√∫ltimas 7 sess√µes)
    const recentes = historico.slice(-7);
    const sucessosRecentes = recentes.filter(s => s.status === 'sucesso' || s.status === 'parcial').length;
    const tendenciaRecente = recentes.length > 0 ? (sucessosRecentes / recentes.length) * 100 : 50;
    
    // Fator 6: Consist√™ncia (varia√ß√£o de sucesso)
    const taxaSucesso = historico.filter(s => s.status === 'sucesso' || s.status === 'parcial').length / Math.max(historico.length, 1) * 100;
    const consistencia = Math.min(100, 50 + (Math.abs(50 - taxaSucesso) / 50 * 50)); // Quanto mais consistente, melhor
    
    // Fator 7: Momentum semanal (comparar esta semana com semana anterior)
    const agora = new Date();
    const umaSemanAtr√°s = new Date(agora.getTime() - 7 * 24 * 60 * 60 * 1000);
    const sessoesSemanaAtual = historico.filter(s => new Date(s.data) >= umaSemanAtr√°s);
    const sucessosSemanaAtual = sessoesSemanaAtual.filter(s => s.status === 'sucesso' || s.status === 'parcial').length;
    const momentumSemanal = sessoesSemanaAtual.length > 0 ? (sucessosSemanaAtual / sessoesSemanaAtual.length) * 100 : 50;
    
    return {
        diaMatch: Math.max(0, Math.min(100, diaMatch)),
        periodoMatch: Math.max(0, Math.min(100, periodoMatch)),
        motivoMatch: Math.max(0, Math.min(100, motivoMatch)),
        duracaoMedia: Math.max(0, Math.min(100, duracaoMedia)),
        tendenciaRecente: Math.max(0, Math.min(100, tendenciaRecente)),
        consistencia: Math.max(0, Math.min(100, consistencia)),
        momentumSemanal: Math.max(0, Math.min(100, momentumSemanal)),
        totalSessoes: historico.length,
        taxaSucesso: Math.round(taxaSucesso),
        sessoesSimilares: sessoeMotivo.length
    };
}

// Fun√ß√£o para exibir an√°lise detalhada dos fatores
function mostrarAnaliseFatores() {
    const fatores = calcularFatoresPredictivos(
        new Date().getDay(),
        (() => {
            const h = new Date().getHours();
            if (h >= 5 && h < 12) return 'manh√£';
            else if (h >= 12 && h < 17) return 'tarde';
            else if (h >= 17 && h < 21) return 'noite';
            else return 'madrugada';
        })(),
        document.getElementById('motivoEscolhido').value
    );
    
    const analise = `
    üìä AN√ÅLISE DETALHADA DOS FATORES DE PREDI√á√ÉO
    
    üóìÔ∏è Dia da Semana: ${Math.round(fatores.diaMatch)}%
    Desempenho hist√≥rico neste dia espec√≠fico
    
    ‚è∞ Per√≠odo do Dia: ${Math.round(fatores.periodoMatch)}%
    Performance neste per√≠odo (manh√£/tarde/noite)
    
    üéØ Tipo de Motivo: ${Math.round(fatores.motivoMatch)}%
    Hist√≥rico com este motivo espec√≠fico
    
    ‚è±Ô∏è Dura√ß√£o M√©dia: ${Math.round(fatores.duracaoMedia)}%
    Comparado com sess√µes bem-sucedidas
    
    üìà Tend√™ncia Recente: ${Math.round(fatores.tendenciaRecente)}%
    Performance das √∫ltimas 7 sess√µes
    
    üîÑ Consist√™ncia: ${Math.round(fatores.consistencia)}%
    Varia√ß√£o de sucesso ao longo do tempo
    
    üöÄ Momentum Semanal: ${Math.round(fatores.momentumSemanal)}%
    Compara√ß√£o com semana anterior
    
    üìä ESTAT√çSTICAS GERAIS
    Total de Sess√µes: ${fatores.totalSessoes}
    Taxa de Sucesso Geral: ${fatores.taxaSucesso}%
    Sess√µes com este Motivo: ${fatores.sessoesSimilares}
    `;
    
    console.log(analise);
    alert(analise);
}

function renderEstrelasNoCeu() {
    const container = document.getElementById('starsContainer');
    container.innerHTML = '';
    
    const isDarkMode = document.body.classList.contains('dark-mode');
    if(!exibirEstrelas || !isDarkMode) return;
    
    const livrosNotaMaxima = estante.filter(l => l.nota === 5);
    livrosNotaMaxima.forEach((l, i) => {
        const estrela = document.createElement('div');
        estrela.className = 'estrela-conquista'; estrela.textContent = '‚ú¶';
        estrela.style.left = (10 + (i * 137 % 80)) + 'vw'; estrela.style.top = (5 + (i * 97 % 30)) + 'vh';
        estrela.style.animationDelay = (i * 0.5) + 's'; estrela.style.fontSize = (12 + (i % 3) * 4) + 'px';
        container.appendChild(estrela);
    });
}

function toggleEstrelas() {
    exibirEstrelas = !exibirEstrelas;
    StorageSeguro.set('exibirEstrelas', exibirEstrelas);
    const btn = document.getElementById('btnEstrelas');
    btn.classList.toggle('on', exibirEstrelas);
    renderEstrelasNoCeu();
}

function abrirEstante() { 
    abrirModal('estanteOverlay'); 
    renderEstante(); 
}

function renderEstante() {
    const container = document.getElementById('listaLivros');
    if (!container) return;
    container.innerHTML = '';
    
    // Garantir que estante seja um array v√°lido
    if (!Array.isArray(estante)) {
        estante = [];
        StorageSeguro.set('estante_livros', []);
    }
    
    const LIVROS_POR_ANDAR = 12;
    // Sempre ter pelo menos 1 andar para o di√°rio
    const totalAndares = Math.max(1, Math.ceil(estante.length / LIVROS_POR_ANDAR));
    
    const estanteContainer = document.createElement('div');
    estanteContainer.style.display = 'flex';
    estanteContainer.style.flexDirection = 'column';
    estanteContainer.style.gap = '0';
    const isMobile = window.innerWidth <= 600;
    estanteContainer.style.width = '100%';
    estanteContainer.style.maxWidth = isMobile ? '100%' : '450px';
    estanteContainer.style.margin = '0 auto';
    
    for (let andar = 0; andar < totalAndares; andar++) {
        const inicio = andar * LIVROS_POR_ANDAR;
        const fim = inicio + LIVROS_POR_ANDAR;
        const livrosDoAndar = estante.slice(inicio, fim);
        
        const andarDiv = document.createElement('div');
        andarDiv.className = 'madeira-shelf';
        andarDiv.style.margin = '0 0 0 0';
        andarDiv.style.position = 'relative';
        
        const prateleiraDiv = document.createElement('div');
        prateleiraDiv.className = 'prateleira-interna';
        prateleiraDiv.style.minHeight = '80px';
        prateleiraDiv.style.padding = '8px 8px 0 8px';
        prateleiraDiv.style.position = 'relative';
        prateleiraDiv.style.overflow = 'hidden';

        // Adicionar Di√°rio na primeira prateleira
        if (andar === 0) {
            const diarioDiv = document.createElement('div');
            diarioDiv.className = 'livro';
            diarioDiv.style.backgroundColor = '#c2185b';
            diarioDiv.style.height = '75px';
            diarioDiv.style.width = isMobile ? '22px' : '38px';
            diarioDiv.style.marginRight = '10px';
            diarioDiv.style.boxShadow = '0 0 10px rgba(194, 24, 91, 0.5)';
            diarioDiv.style.cursor = 'pointer';
            diarioDiv.style.transform = 'rotate(-8deg)';
            diarioDiv.style.transformOrigin = 'bottom left';
            diarioDiv.style.marginLeft = '5px';
            diarioDiv.title = "Meu Di√°rio";
            
            const lombada = document.createElement('div');
            lombada.style.position = 'absolute';
            lombada.style.top = '0';
            lombada.style.left = '0';
            lombada.style.width = '5px';
            lombada.style.height = '100%';
            lombada.style.backgroundColor = 'rgba(0,0,0,0.3)';
            diarioDiv.appendChild(lombada);
            
            const tituloDiv = document.createElement('div');
            tituloDiv.className = 'livro-titulo';
            tituloDiv.textContent = 'DI√ÅRIO';
            tituloDiv.style.fontSize = isMobile ? '7px' : '10px';
            tituloDiv.style.color = 'white';
            tituloDiv.style.padding = '5px 0px';
            tituloDiv.style.fontWeight = 'bold';
            diarioDiv.appendChild(tituloDiv);
            
            diarioDiv.onclick = () => {
                fecharModal('estanteOverlay');
                abrirDiario();
            };
            
            prateleiraDiv.appendChild(diarioDiv);
        }
        
        livrosDoAndar.forEach((livro, indexNoAndar) => {
            const livroDiv = document.createElement('div');
            livroDiv.className = 'livro';
            livroDiv.style.backgroundColor = livro.cor;
            livroDiv.style.height = (60 + (indexNoAndar % 3) * 8) + 'px';
            const isMobile = window.innerWidth <= 600;
            livroDiv.style.width = isMobile ? '18px' : '32px';
            livroDiv.style.marginRight = '-1px';
            
            const lombada = document.createElement('div');
            lombada.style.position = 'absolute';
            lombada.style.top = '0';
            lombada.style.left = '0';
            lombada.style.width = '3px';
            lombada.style.height = '100%';
            lombada.style.backgroundColor = 'rgba(0,0,0,0.15)';
            livroDiv.appendChild(lombada);
            
            const tituloDiv = document.createElement('div');
            tituloDiv.className = 'livro-titulo';
            tituloDiv.textContent = livro.nome;
            tituloDiv.style.fontSize = isMobile ? '6px' : '8px';
            tituloDiv.style.padding = '3px 0px';
            tituloDiv.style.fontWeight = 'bold';
            
            livroDiv.appendChild(tituloDiv);
            
            livroDiv.onclick = () => {
                showModal({ 
                    text: `üìñ <strong>${livro.nome}</strong><br>Nota: ${livro.nota > 0 ? '‚≠ê'.repeat(livro.nota) : 'Sem nota'}${livro.notas ? `<br><br>Notas: ${livro.notas}` : ''}<br><br>Deseja excluir este livro?`, 
                    onConfirm: () => { 
                        const indexGlobal = inicio + indexNoAndar;
                        estante.splice(indexGlobal, 1); 
                        StorageSeguro.set('estante_livros', estante); 
                        renderEstante(); 
                        renderEstrelasNoCeu();
                    } 
                });
            };
            
            prateleiraDiv.appendChild(livroDiv);
        });
        
        andarDiv.appendChild(prateleiraDiv);
        estanteContainer.appendChild(andarDiv);
    }
    
    const contadorDiv = document.createElement('div');
    contadorDiv.style.textAlign = 'center';
    contadorDiv.style.marginTop = '15px';
    contadorDiv.style.fontSize = '12px';
    contadorDiv.style.color = 'var(--text-main)';
    contadorDiv.innerHTML = `üìö <strong>${estante.length}</strong> livro${estante.length !== 1 ? 's' : ''} + üìî <strong>Di√°rio</strong> em <strong>${totalAndares}</strong> andar${totalAndares !== 1 ? 'es' : ''}`;
    estanteContainer.appendChild(contadorDiv);
    
    container.appendChild(estanteContainer);
}

function prepararNovoLivro() { 
    notaTemp = 0; 
    corLivroTemp = CORES_LIVROS[0];
    document.getElementById('nomeLivroInput').value = ''; 
    document.getElementById('notasLivroInput').value = ''; 
    atualizarEstrelas(0); 
    renderCorPicker();
    abrirModal('modalLivroInput'); 
}

function renderCorPicker() {
    const container = document.getElementById('livroColorPicker');
    container.innerHTML = '';
    CORES_LIVROS.forEach(cor => {
        const swatch = document.createElement('div');
        swatch.className = 'color-swatch' + (cor === corLivroTemp ? ' active' : '');
        swatch.style.backgroundColor = cor;
        swatch.onclick = () => {
            corLivroTemp = cor;
            renderCorPicker();
        };
        container.appendChild(swatch);
    });
}

function setupEstrelasClick() { 
    document.querySelectorAll('#starsClickable .star').forEach(s => { 
        s.onclick = (e) => { 
            notaTemp = parseInt(e.target.dataset.v); 
            atualizarEstrelas(notaTemp); 
        }; 
    }); 
}

function atualizarEstrelas(v) { 
    document.querySelectorAll('#starsClickable .star').forEach(s => { 
        s.classList.toggle('active', parseInt(s.dataset.v) <= v); 
    }); 
}

function confirmarNovoLivro() {
    const nome = document.getElementById('nomeLivroInput').value; 
    const notas = document.getElementById('notasLivroInput').value;
    if(!nome.trim()) return;
    
    const LIVROS_POR_ANDAR = 12;
    const andarAtual = Math.ceil(estante.length / LIVROS_POR_ANDAR);
    const novoAndar = Math.ceil((estante.length + 1) / LIVROS_POR_ANDAR);
    
    estante.push({ nome: nome, nota: notaTemp, cor: corLivroTemp, notas: notas });
    StorageSeguro.set('estante_livros', estante); 
    
    if (novoAndar > andarAtual) {
        showModal({ 
            text: `üìö Novo livro adicionado!\n‚ú® Sua estante agora tem ${novoAndar} andar${novoAndar !== 1 ? 'es' : ''}! Continue lendo e crescendo sua cole√ß√£o!`, 
            onConfirm: () => {} 
        });
    }
    
    fecharModal('modalLivroInput');
    renderEstante(); 
    renderEstrelasNoCeu();
}

function abrirDashboard() { 
    abrirModal('dashboardOverlay');
    mostrarDashboardPeriodo('semanal');
}

function mostrarDashboardPeriodo(periodo) {
    document.getElementById('btnDashboardSemanal').classList.remove('active');
    document.getElementById('btnDashboardMensal').classList.remove('active');
    document.getElementById('btnDashboardAnual').classList.remove('active');
    document.getElementById('btnDashboardGrid3d').classList.remove('active');
    document.getElementById('btnDashboard' + periodo.charAt(0).toUpperCase() + periodo.slice(1)).classList.add('active');
    
    document.getElementById('dashboardContainerSemanal').style.display = 'none';
    document.getElementById('dashboardContainerMensal').style.display = 'none';
    document.getElementById('dashboardContainerAnual').style.display = 'none';
    document.getElementById('dashboardContainerGrid3d').style.display = 'none';
    
    const containerId = 'dashboardContainer' + periodo.charAt(0).toUpperCase() + periodo.slice(1);
    document.getElementById(containerId).style.display = 'block';
    
    if (periodo === 'semanal') {
        renderizarDashboardSemanal();
    } else if (periodo === 'mensal') {
        renderizarDashboardMensal();
    } else if (periodo === 'anual') {
        renderizarDashboardAnual();
    } else if (periodo === 'grid3d') {
        renderizarDashboardGrid3D();
    }
}

function renderizarDashboardGrid3D() {
    const container = document.getElementById('dashboardContainerGrid3d');
    container.innerHTML = '';

    // ============================================================
    // CORRE√á√ÉO DE PERSIST√äNCIA (O SEGREDO PARA N√ÉO SUMIR)
    // ============================================================
    // Busca os dados diretamente do cofre seguro, ignorando a vari√°vel global vazia
    const historicoSeguro = StorageSeguro.get('historico_foco', []);
    
    // Atualiza a vari√°vel global para garantir que novos focos n√£o apaguem o passado
    if (typeof historico !== 'undefined') {
        historico = historicoSeguro; 
    }
    // ============================================================

    const agora = new Date();
    const anoAtual = agora.getFullYear();

    // Filtra sess√µes do ano atual usando a lista segura
    const sessoesAno = historicoSeguro.filter(s => {
        if (s.status !== 'sucesso') return false;
        const dataSessao = new Date(s.data);
        return dataSessao.getFullYear() === anoAtual;
    });

    // C√°lculo din√¢mico do tamanho do grid
    const totalArvores = sessoesAno.length;
    const gridSize = Math.max(10, Math.ceil(Math.sqrt(totalArvores)));

    // Ajuste fino do tamanho da c√©lula
    let cellSize = 32;
    if (gridSize > 25) cellSize = 12;
    else if (gridSize > 20) cellSize = 16;
    else if (gridSize > 15) cellSize = 20;
    else if (gridSize > 12) cellSize = 25;

    // Estilos do grid isom√©trico
    const style = document.createElement('style');
    style.textContent = `
        .dashboard-scene-3d {
            perspective: 2000px;
            width: 100%;
            height: 450px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: var(--bg-body);
            position: relative;
            padding: 0;
            box-sizing: border-box;
            cursor: grab;
            user-select: none;
            border-radius: 20px;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.1);
        }
        .dashboard-scene-3d:active { cursor: grabbing; }
        
        .dashboard-grid-container-3d {
            display: grid;
            grid-template-columns: repeat(${gridSize}, ${cellSize}px);
            grid-template-rows: repeat(${gridSize}, ${cellSize}px);
            gap: 2px;
            transform: rotateX(60deg) rotateZ(45deg) translateZ(0);
            transform-style: preserve-3d;
            position: relative;
            background-color: var(--grid-border);
            padding: 2px;
            transition: transform 0.1s ease-out;
            flex-shrink: 0;
            will-change: transform;
        }
        
        .dashboard-grid-container-3d::before {
            content: ''; position: absolute; top: 100%; left: 0; 
            width: 100%; height: 15px; 
            background: var(--side-color); 
            transform-origin: top; transform: rotateX(-90deg);
        }
        .dashboard-grid-container-3d::after {
            content: ''; position: absolute; top: 0; left: 100%; 
            width: 15px; height: 100%; 
            background: var(--bottom-color); 
            transform-origin: left; transform: rotateY(90deg);
        }

        .dashboard-cell-3d {
            width: ${cellSize}px;
            height: ${cellSize}px;
            background-color: var(--grid-color);
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 40 40"><path d="M5 35 L10 30 L15 35 Z" fill="%237db336" opacity="0.7"/><path d="M25 15 L30 10 L35 15 Z" fill="%237db336" opacity="0.7"/></svg>');
            background-size: ${cellSize}px ${cellSize}px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transform-style: preserve-3d;
        }
        
        .dashboard-emoji-3d {
            font-size: ${Math.floor(cellSize * 0.75)}px;
            position: absolute;
            transform: rotateZ(-45deg) rotateX(-90deg) translateY(-${Math.floor(cellSize * 0.45)}px);
            pointer-events: auto;
            cursor: pointer;
            transition: all 0.2s;
            z-index: 10;
            transform-style: preserve-3d;
        }
        .dashboard-emoji-3d:hover {
            transform: rotateZ(-45deg) rotateX(-90deg) translateY(-${Math.floor(cellSize * 0.6)}px) scale(1.3);
            z-index: 1000;
        }
    `;
    container.appendChild(style);

    const nota = document.createElement('div');
    nota.id = 'dashboardNotaDinamica';
    nota.style.cssText = 'background: var(--bg-panel); padding: 10px; border-radius: 15px; font-size: 13px; margin-bottom: 10px; border-left: 4px solid var(--primary); color: var(--text-main); text-align: left; width: 100%; box-sizing: border-box; transition: all 0.3s ease;';
    nota.innerHTML = `üí° <strong>Dica:</strong> Clique em uma planta para ver detalhes.`;
    container.appendChild(nota);

    const scene = document.createElement('div');
    scene.className = 'dashboard-scene-3d';

    const grid = document.createElement('div');
    grid.className = 'dashboard-grid-container-3d';

    // Loop de preenchimento
    const totalCells = gridSize * gridSize;
    
    for (let i = 0; i < totalCells; i++) {
        const cell = document.createElement('div');
        cell.className = 'dashboard-cell-3d';

        if (i < sessoesAno.length) {
            const sessao = sessoesAno[i];
            const icone = sessao.icone || 'üå≥';
            
            // Listas de verifica√ß√£o
            const caminhos = TIPOS_CAMINHO;
            const floresEspeciais = ['üåª', 'üåπ', 'üå∑'];
            
            const isCaminho = caminhos.includes(icone);
            const isFlor = floresEspeciais.includes(icone);

            // 1. SE FOR CAMINHO: N√£o renderiza nada (fica s√≥ a grama)
            if (isCaminho) {
                // Intencionalmente vazio para esconder a estrada
            } 
            // 2. SE FOR FLOR: Usa o novo sprite SVG rico
            else if (isFlor && typeof gerarSpriteFlor === 'function') {
                const svgSprite = gerarSpriteFlor(icone);
                const florElem = document.createElement('div');
                
                florElem.style.position = 'absolute';
                florElem.style.width = '100%';
                florElem.style.height = '100%';
                florElem.style.backgroundImage = `url('${svgSprite}')`;
                florElem.style.backgroundSize = 'contain';
                florElem.style.backgroundRepeat = 'no-repeat';
                florElem.style.backgroundPosition = 'center bottom';
                florElem.style.pointerEvents = 'auto';
                florElem.style.cursor = 'pointer';
                
                // Ajuste de posi√ß√£o 3D para flores
                florElem.style.left = '80%';
                florElem.style.top = '20%';
                florElem.style.transform = `translate(-50%, -50%) rotateZ(-45deg) rotateX(-90deg) scale(0.85)`;
                florElem.style.transformOrigin = 'center bottom';
                
                florElem.onclick = () => {
                    const dataFormatada = new Date(sessao.data).toLocaleDateString('pt-BR');
                    if (document.getElementById('dashboardNotaDinamica')) {
                        document.getElementById('dashboardNotaDinamica').innerHTML = `üåº <strong>${sessao.motivo || 'Flor'}:</strong> ${sessao.minutos} min em ${dataFormatada}`;
                    }
                };
                
                cell.appendChild(florElem);
            } 
            // 3. SE FOR √ÅRVORE/OUTRO: Renderiza emoji 3D padr√£o
            else {
                const tree = document.createElement('div');
                tree.className = 'dashboard-emoji-3d';
                tree.innerHTML = `${icone}`;
                
                tree.onclick = () => {
                    const dataFormatada = new Date(sessao.data).toLocaleDateString('pt-BR');
                    if (document.getElementById('dashboardNotaDinamica')) {
                        document.getElementById('dashboardNotaDinamica').innerHTML = `üå≥ <strong>${sessao.motivo || 'Foco'}:</strong> ${sessao.minutos} min em ${dataFormatada}`;
                    }
                };
                
                cell.appendChild(tree);
            }
        }

        grid.appendChild(cell);
    }

    scene.appendChild(grid);
    container.appendChild(scene);
    
    // --- CONTROLES DE PAN E ZOOM ---
    let isDragging = false;
    let startX, startY;
    let translateX = 0, translateY = 0;
    let scale = 1;

    const updateTransform = () => {
        grid.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale}) rotateX(60deg) rotateZ(45deg) translateZ(0)`;
    };

    scene.onmousedown = (e) => { isDragging = true; startX = e.clientX - translateX; startY = e.clientY - translateY; };
    window.onmousemove = (e) => { if (!isDragging) return; translateX = e.clientX - startX; translateY = e.clientY - startY; updateTransform(); };
    window.onmouseup = () => { isDragging = false; };
    
    // Touch
    scene.ontouchstart = (e) => { isDragging = true; startX = e.touches[0].clientX - translateX; startY = e.touches[0].clientY - translateY; };
    scene.ontouchmove = (e) => { if (!isDragging) return; translateX = e.touches[0].clientX - startX; translateY = e.touches[0].clientY - startY; updateTransform(); e.preventDefault(); };
    scene.ontouchend = () => { isDragging = false; };

    // Zoom Wheel
    scene.onwheel = (e) => {
        e.preventDefault();
        const delta = e.deltaY > 0 ? 0.9 : 1.1;
        const newScale = scale * delta;
        if (newScale >= 0.5 && newScale <= 3) { scale = newScale; updateTransform(); }
    };

    // Bot√µes de Zoom
    const zoomControls = document.createElement('div');
    zoomControls.style.cssText = 'position: absolute; bottom: 15px; right: 15px; display: flex; flex-direction: column; gap: 8px; z-index: 100;';
    
    const btnZoomIn = document.createElement('button');
    btnZoomIn.innerHTML = '‚ûï';
    btnZoomIn.style.cssText = 'width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--primary); background: var(--bg-panel); cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.2);';
    btnZoomIn.onclick = (e) => { e.stopPropagation(); if (scale <= 3) { scale *= 1.2; updateTransform(); } };

    const btnZoomOut = document.createElement('button');
    btnZoomOut.innerHTML = '‚ûñ';
    btnZoomOut.style.cssText = 'width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--primary); background: var(--bg-panel); cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.2);';
    btnZoomOut.onclick = (e) => { e.stopPropagation(); if (scale >= 0.5) { scale /= 1.2; updateTransform(); } };

    zoomControls.appendChild(btnZoomIn);
    zoomControls.appendChild(btnZoomOut);
    scene.appendChild(zoomControls);

    const info = document.createElement('div');
    info.className = 'dashboard-grid-info';
    info.innerHTML = `üå≥ <strong>${sessoesAno.length}</strong> √°rvores em ${anoAtual}`;
    container.appendChild(info);
}



function calcularMaisUsado(sessoes) {
    // Priorizar por tempo total (minutos) gasto com cada emoji, pois reflete uso real
    if (sessoes.length === 0) {
        return { icone: "üìä", motivo: "Nenhum dado", minutos: 0 };
    }
    
    const contagemIcones = {};
    const minutosPorIcone = {};
    const contagemMotivos = {};
    
    sessoes.forEach(sessao => {
        const minutos = Number(sessao.minutos) || 0;

        if (sessao.icone) {
            contagemIcones[sessao.icone] = (contagemIcones[sessao.icone] || 0) + 1;
            minutosPorIcone[sessao.icone] = (minutosPorIcone[sessao.icone] || 0) + minutos;
        }
        
        if (sessao.motivo) {
            contagemMotivos[sessao.motivo] = (contagemMotivos[sessao.motivo] || 0) + 1;
        }
    });
    
    // Escolher √≠cone com mais minutos (quebra-empate por n√∫mero de sess√µes)
    let iconeMaisUsado = "üìä";
    let maxMinutos = 0;
    for (const [icone, minutos] of Object.entries(minutosPorIcone)) {
        if (minutos > maxMinutos) {
            maxMinutos = minutos;
            iconeMaisUsado = icone;
        } else if (minutos === maxMinutos) {
            // tie-breaker: escolher o que tem mais sess√µes
            if ((contagemIcones[icone] || 0) > (contagemIcones[iconeMaisUsado] || 0)) {
                iconeMaisUsado = icone;
            }
        }
    }
    
    // Se n√£o houver minutos (ex.: registros inv√°lidos), cair para contagem por sess√µes
    if (maxMinutos === 0 && Object.keys(contagemIcones).length > 0) {
        let maxIcones = 0;
        for (const [icone, contagem] of Object.entries(contagemIcones)) {
            if (contagem > maxIcones) {
                maxIcones = contagem;
                iconeMaisUsado = icone;
            }
        }
    }
    
    // Motivo mais frequente (por n√∫mero de sess√µes)
    let motivoMaisUsado = "Nenhum";
    let maxMotivos = 0;
    for (const [motivo, contagem] of Object.entries(contagemMotivos)) {
        if (contagem > maxMotivos) {
            maxMotivos = contagem;
            motivoMaisUsado = motivo;
        }
    }
    
    console.debug('calcularMaisUsado result', { icone: iconeMaisUsado, motivo: motivoMaisUsado, minutos: maxMinutos, sessoes: sessoes.length });
    return { icone: iconeMaisUsado, motivo: motivoMaisUsado, minutos: maxMinutos };
}

// Sanitiza o hist√≥rico: valida datas, normaliza campos e remove duplicados exatos
function sanitizeHistorico() {
    const arr = Array.isArray(historico) ? historico : [];
    const cleaned = [];
    const seen = new Set();

    arr.forEach(s => {
        if (!s || !s.data) {
            console.warn('historico: registro inv√°lido ignorado', s);
            return;
        }
        const d = new Date(s.data);
        if (isNaN(d.getTime())) {
            console.warn('historico: data inv√°lida ignorada', s);
            return;
        }

        const minutos = Number(s.minutos) || 0;
        const motivo = s.motivo || 'Geral';
        const icone = s.icone || '‚ùì';
        const status = s.status || 'falha';

        const key = `${d.toISOString()}|${icone}|${motivo}|${minutos}|${status}`;
        if (seen.has(key)) {
            console.debug('historico: duplicado encontrado e ignorado', key);
            return;
        }
        seen.add(key);

        cleaned.push({ data: d.toISOString(), minutos, motivo, icone, mes: d.getMonth(), ano: d.getFullYear(), status });
    });

    if (arr.length !== cleaned.length) console.debug('historico: sanitizado', { original: arr.length, cleaned: cleaned.length });
    return cleaned;
}

function renderizarDashboardSemanal() {
    const container = document.getElementById('dashboardContainerSemanal');
    container.innerHTML = '';
    
    const ultimos7dias = [];
    const hoje = new Date();
    hoje.setHours(0, 0, 0, 0);
    
    for (let i = 6; i >= 0; i--) {
        const dia = new Date(hoje);
        dia.setDate(hoje.getDate() - i);
        ultimos7dias.push(dia);
    }
    
    const historicoSanitizado = sanitizeHistorico();
    const minutosPorDia = ultimos7dias.map(dia => {
        const sessoesDoDia = historicoSanitizado.filter(s => {
            const sDate = new Date(s.data);
            sDate.setHours(0, 0, 0, 0);
            return sDate.getTime() === dia.getTime() && s.status === 'sucesso';
        });
        return sessoesDoDia.reduce((acc, sessao) => acc + Number(sessao.minutos || 0), 0);
    });
    
    const maxMinutos = Math.max(...minutosPorDia, 60);
    const metaDiaria = 60;
    
    ultimos7dias.forEach((dia, index) => {
        const minutos = minutosPorDia[index];
        const porcentagem = Math.min((minutos / maxMinutos) * 100, 100);
        const isHoje = index === 6;
        
        const diaElement = document.createElement('div');
        diaElement.className = 'dia-semana';
        
        const nomesDias = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
        const diaSemana = nomesDias[dia.getDay()];
        
        diaElement.innerHTML = `
            <div class="dia-label">${diaSemana}</div>
            <div class="dia-barra-container">
                <div class="dia-barra ${isHoje ? 'hoje' : ''}" style="width: ${porcentagem}%"></div>
                <div class="dia-meta" style="left: ${(metaDiaria / maxMinutos) * 100}%"></div>
                <div class="dia-valor">${minutos} min</div>
            </div>
        `;
        
        container.appendChild(diaElement);
    });
    
    const totalSemana = minutosPorDia.reduce((a, b) => a + b, 0);
    const diasComSessoes = minutosPorDia.filter(m => m > 0).length;
    const mediaDiaria = diasComSessoes > 0 ? Math.round(totalSemana / diasComSessoes) : 0;
    
    const resumoHTML = `
        <div class="dashboard-resumo">
            <div class="resumo-item">
                <div class="resumo-valor total">${totalSemana}</div>
                <div class="resumo-label">Minutos na semana</div>
            </div>
            <div class="resumo-item">
                <div class="resumo-valor">${diasComSessoes}</div>
                <div class="resumo-label">Dias ativos</div>
            </div>
            <div class="resumo-item">
                <div class="resumo-valor meta">${mediaDiaria}</div>
                <div class="resumo-label">M√©dia por dia</div>
            </div>
            <div class="resumo-item">
                <div class="resumo-valor streak">${streakDiasAtivos}</div>
                <div class="resumo-label">Dias consecutivos ‚òÄÔ∏è</div>
            </div>
        </div>
    `;
    
    container.innerHTML += resumoHTML;
    
    const sessoesSemana = historicoSanitizado.filter(s => {
        const sDate = new Date(s.data);
        sDate.setHours(0, 0, 0, 0);
        return ultimos7dias.some(dia => dia.getTime() === sDate.getTime()) && s.status === 'sucesso';
    });
    
    const maisUsado = calcularMaisUsado(sessoesSemana);
    
    const maisUsadoHTML = `
        <div class="mais-usado-section">
            <div class="mais-usado-header">
                <span>üìà</span>
                <span>Mais usado na semana</span>
            </div>
            <div class="mais-usado-content">
                <div class="mais-usado-item">
                    <span class="mais-usado-emoji">${maisUsado.icone}</span>
                    <div class="mais-usado-motivo">${maisUsado.motivo}</div>
                    <span class="mais-usado-label">Motivo mais frequente</span>
                </div>
                <div class="mais-usado-item">
                    <span class="mais-usado-emoji">${maisUsado.icone}</span>
                    <div class="mais-usado-motivo">${sessoesSemana.length} sess√µes ¬∑ ${maisUsado.minutos || 0} min</div>
                    <span class="mais-usado-label">Sess√µes / Tempo</span>
                </div>
            </div>
        </div>
    `;
    
    container.innerHTML += maisUsadoHTML;
    console.debug('renderizarDashboardSemanal resumo', { totalSemana, diasComSessoes, sessoesSemana: sessoesSemana.length, minutosSemana: totalSemana });
    
    setTimeout(() => {
        container.querySelectorAll('.dia-barra').forEach((barra, index) => {
            const minutos = minutosPorDia[index];
            const porcentagem = Math.min((minutos / maxMinutos) * 100, 100);
            barra.style.width = `${porcentagem}%`;
        });
    }, 100);
}

function renderizarDashboardMensal() {
    const container = document.getElementById('dashboardContainerMensal');
    container.innerHTML = '';
    
    const agora = new Date();
    const mesAtual = agora.getMonth();
    const anoAtual = agora.getFullYear();
    const diasNoMes = new Date(anoAtual, mesAtual + 1, 0).getDate();
    
    const minutosPorDia = Array(diasNoMes).fill(0);
    
    const historicoSanitizado = sanitizeHistorico();
    historicoSanitizado.forEach(sessao => {
        if (sessao.status === 'sucesso') {
            const dataSessao = new Date(sessao.data);
            if (dataSessao.getMonth() === mesAtual && dataSessao.getFullYear() === anoAtual) {
                const dia = dataSessao.getDate() - 1;
                minutosPorDia[dia] += Number(sessao.minutos || 0);
            }
        }
    });
    
    const maxMinutos = Math.max(...minutosPorDia, 100);
    
    for (let i = 0; i < diasNoMes; i += 7) {
        const semanaDias = minutosPorDia.slice(i, Math.min(i + 7, diasNoMes));
        const semanaContainer = document.createElement('div');
        semanaContainer.className = 'semana-card';
        semanaContainer.innerHTML = `<strong>Semana ${Math.floor(i/7) + 1} (dias ${i+1}-${Math.min(i+7, diasNoMes)})</strong><br>`;
        
        semanaDias.forEach((minutos, indexDia) => {
            const diaNum = i + indexDia + 1;
            const porcentagem = Math.min((minutos / maxMinutos) * 100, 100);
            semanaContainer.innerHTML += `
                <div style="display: flex; align-items: center; margin: 5px 0;">
                    <div style="width: 30px; font-size: 11px;">${diaNum}</div>
                    <div style="flex: 1; background: var(--bg-body); height: 12px; border-radius: 6px; overflow: hidden;">
                        <div style="height: 100%; background: ${diaNum === agora.getDate() ? 'var(--accent)' : 'var(--primary)'}; width: ${porcentagem}%; border-radius: 6px;"></div>
                    </div>
                    <div style="width: 40px; font-size: 11px; text-align: right;">${minutos}m</div>
                </div>
            `;
        });
        
        container.appendChild(semanaContainer);
    }
    
    const totalMes = minutosPorDia.reduce((a, b) => a + b, 0);
    const diasAtivos = minutosPorDia.filter(m => m > 0).length;
    const mediaDiaria = diasAtivos > 0 ? Math.round(totalMes / diasAtivos) : 0;
    
    const resumoHTML = `
        <div class="dashboard-resumo">
            <div class="resumo-item">
                <div class="resumo-valor total">${totalMes}</div>
                <div class="resumo-label">Minutos no m√™s</div>
            </div>
            <div class="resumo-item">
                <div class="resumo-valor">${diasAtivos}</div>
                <div class="resumo-label">Dias ativos</div>
            </div>
            <div class="resumo-item">
                <div class="resumo-valor meta">${mediaDiaria}</div>
                <div class="resumo-label">M√©dia por dia</div>
            </div>
            <div class="resumo-item">
                <div class="resumo-valor streak">${streakDiasAtivos}</div>
                <div class="resumo-label">Dias consecutivos ‚òÄÔ∏è</div>
            </div>
        </div>
    `;
    
    container.innerHTML += resumoHTML;
    
    const sessoesMes = historicoSanitizado.filter(s => {
        if (s.status !== 'sucesso') return false;
        const dataSessao = new Date(s.data);
        return dataSessao.getMonth() === mesAtual && dataSessao.getFullYear() === anoAtual;
    });
    
    const maisUsado = calcularMaisUsado(sessoesMes);
    
    const maisUsadoHTML = `
        <div class="mais-usado-section">
            <div class="mais-usado-header">
                <span>üìà</span>
                <span>Mais usado no m√™s</span>
            </div>
            <div class="mais-usado-content">
                <div class="mais-usado-item">
                    <span class="mais-usado-emoji">${maisUsado.icone}</span>
                    <div class="mais-usado-motivo">${maisUsado.motivo}</div>
                    <span class="mais-usado-label">Motivo mais frequente</span>
                </div>
                <div class="mais-usado-item">
                    <span class="mais-usado-emoji">${maisUsado.icone}</span>
                    <div class="mais-usado-motivo">${sessoesMes.length} sess√µes ¬∑ ${maisUsado.minutos || 0} min</div>
                    <span class="mais-usado-label">Sess√µes / Tempo</span>
                </div>
            </div>
        </div>
    `;
    
    container.innerHTML += maisUsadoHTML;
    console.debug('renderizarDashboardMensal resumo', { totalMes, diasAtivos, sessoesMes: sessoesMes.length, minutosMes: totalMes });
}

function renderizarDashboardAnual() {
    const container = document.getElementById('dashboardContainerAnual');
    container.innerHTML = '';
    
    const agora = new Date();
    const anoAtual = agora.getFullYear();
    
    const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
    const minutosPorMes = Array(12).fill(0);
    
    const historicoSanitizado = sanitizeHistorico();
    historicoSanitizado.forEach(sessao => {
        if (sessao.status === 'sucesso') {
            const dataSessao = new Date(sessao.data);
            if (dataSessao.getFullYear() === anoAtual) {
                const mes = dataSessao.getMonth();
                minutosPorMes[mes] += Number(sessao.minutos || 0);
            }
        }
    });
    
    const maxMinutos = Math.max(...minutosPorMes, 1000);
    
    // 1. Primeiro adicionar os meses (gr√°ficos)
    meses.forEach((mesNome, index) => {
        const minutos = minutosPorMes[index];
        const porcentagem = Math.min((minutos / maxMinutos) * 100, 100);
        const isMesAtual = index === agora.getMonth();
        
        const mesElement = document.createElement('div');
        mesElement.className = 'dia-semana';
        
        mesElement.innerHTML = `
            <div class="dia-label">${mesNome}</div>
            <div class="dia-barra-container">
                <div class="dia-barra ${isMesAtual ? 'hoje' : ''}" style="width: ${porcentagem}%"></div>
                <div class="dia-valor">${minutos} min</div>
            </div>
        `;
        
        container.appendChild(mesElement);
    });
    
    // 2. Depois adicionar o resumo
    const totalAno = minutosPorMes.reduce((a, b) => a + b, 0);
    const mesesAtivos = minutosPorMes.filter(m => m > 0).length;
    const mediaMensal = mesesAtivos > 0 ? Math.round(totalAno / mesesAtivos) : 0;
    
    const resumoHTML = `
        <div class="dashboard-resumo">
            <div class="resumo-item">
                <div class="resumo-valor total">${totalAno}</div>
                <div class="resumo-label">Minutos no ano</div>
            </div>
            <div class="resumo-item">
                <div class="resumo-valor">${mesesAtivos}</div>
                <div class="resumo-label">Meses ativos</div>
            </div>
            <div class="resumo-item">
                <div class="resumo-valor meta">${mediaMensal}</div>
                <div class="resumo-label">M√©dia por m√™s</div>
            </div>
        </div>
    `;
    
    container.innerHTML += resumoHTML;
    
    // 3. Por √∫ltimo a se√ß√£o "Mais usado"
    const sessoesAno = historicoSanitizado.filter(s => {
        if (s.status !== 'sucesso') return false;
        const dataSessao = new Date(s.data);
        return dataSessao.getFullYear() === anoAtual;
    });
    
    const maisUsado = calcularMaisUsado(sessoesAno);
    
    const maisUsadoHTML = `
        <div class="mais-usado-section">
            <div class="mais-usado-header">
                <span>üìà</span>
                <span>Mais usado no ano</span>
            </div>
            <div class="mais-usado-content">
                <div class="mais-usado-item">
                    <span class="mais-usado-emoji">${maisUsado.icone}</span>
                    <div class="mais-usado-motivo">${maisUsado.motivo}</div>
                    <span class="mais-usado-label">Motivo mais frequente</span>
                </div>
                <div class="mais-usado-item">
                    <span class="mais-usado-emoji">${maisUsado.icone}</span>
                    <div class="mais-usado-motivo">${sessoesAno.length} sess√µes ¬∑ ${maisUsado.minutos || 0} min</div>
                    <span class="mais-usado-label">Sess√µes / Tempo</span>
                </div>
            </div>
        </div>
    `;
    
    container.innerHTML += maisUsadoHTML;
    console.debug('renderizarDashboardAnual resumo', { totalAno, mesesAtivos, sessoesAno: sessoesAno.length, minutosAno: totalAno });
    
    // Animar as barras
    setTimeout(() => {
        container.querySelectorAll('.dia-barra').forEach((barra, index) => {
            const minutos = minutosPorMes[index];
            const porcentagem = Math.min((minutos / maxMinutos) * 100, 100);
            barra.style.width = `${porcentagem}%`;
        });
    }, 100);
}

function obterEmojiEstagio(emojiFinal) {
    // --- L√≥gica Espec√≠fica para Modo Fundo do Mar ---
    // Se o modo Fundo do Mar estiver ativo, a progress√£o √© sempre bolhas
    if (modoFundoMar) {
        return 'ü´ß';
    }

    // --- L√≥gica Padr√£o (Existente) ---
    if (PROGRESSAO[emojiFinal]) {
        return PROGRESSAO[emojiFinal].estagio;
    }
    
    const emoji = emojiFinal;
    const plantas = ['üå≤','üå≥','üå¥','üåµ','üåæ','üåø','‚òòÔ∏è','üåª','üåπ','üå∑','üçÑ','üçÑ‚Äçüü´','ü™¥'];
    if (plantas.includes(emoji)) return 'üå±';
    
    const construcoes = ['üè†','üèØ','üè∞','‚õ™Ô∏è','‚õ©Ô∏è','üõñ','üïå','üõï','üóº'];
    if (construcoes.includes(emoji)) return 'üèóÔ∏è';
    
    const natal = ['üéÑ','üéÅ','üéÖ','ü§∂','‚õÑ','‚ùÑÔ∏è','ü¶å'];
    if (natal.includes(emoji)) return 'üå≤';
    
    return '‚è≥Ô∏è';
}

function evoluirEmoji(emojiFinal) {
    if (PROGRESSAO[emojiFinal]) {
        return PROGRESSAO[emojiFinal].final || emojiFinal;
    }
    return emojiFinal;
}

function startTimer() { 
    if(alvo === null) { 
        showModal({ 
            text: "Escolha primeiro um espa√ßo no jardim para sua planta crescer! üå±", 
            onConfirm: () => {} 
        }); 
        return; 
    }
    
    // Ativar manuten√ß√£o de tela se configurado
    if (manterTelaAtiva) {
        gerenciarTelaAtiva(true);
    }
    
    solicitarPermissaoNotificacao();
    
    document.getElementById('painelInteligencia').style.display = 'none'; 
    document.getElementById('btnStart').style.display = 'none';
    const btnManual = document.getElementById('btnAdicionarManual');
    if (btnManual) btnManual.style.display = 'none';
    document.getElementById('btnDeepFocus').style.display = 'block';
    document.getElementById('btnParar').style.display = 'block';
    atualizarBotoes();
    
    if (!mostrarAvisoInicio) {
        iniciarTimer();
    } else {
        openStartFocusModal();
    }
}

function toggleTelaAtiva() {
    manterTelaAtiva = !manterTelaAtiva;
    StorageSeguro.set('manterTelaAtiva', manterTelaAtiva);
    
    const btn = document.getElementById('btnTelaAtiva');
    btn.classList.toggle('on', manterTelaAtiva);
    
    if (!manterTelaAtiva && wakeLock) {
        gerenciarTelaAtiva(false);
    }
}

function solicitarPermissaoNotificacao() {
    if ('Notification' in window) {
        if (Notification.permission === 'default') {
            Notification.requestPermission().then(function(permission) {
                console.log('Permiss√£o de notifica√ß√£o:', permission);
            });
        }
    }
}

function enviarNotificacaoPlantaCresceu() {
    if ('Notification' in window && Notification.permission === 'granted') {
        try {
            const notificacao = new Notification('üå± Garden Focus', {
                body: 'Sua planta cresceu! Parab√©ns pela sess√£o de foco! üéâ',
                icon: 'https://www.iconpacks.net/icons/2/free-tree-icon-1578-thumb.png',
                tag: 'planta-cresceu',
                requireInteraction: true,
                silent: false
            });
            
            notificacao.onclick = function() {
                window.focus();
                notificacao.close();
            };
        } catch (e) {
            if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                navigator.serviceWorker.ready.then(function(registration) {
                    registration.showNotification('üå± Garden Focus', {
                        body: 'Sua planta cresceu! Parab√©ns pela sess√£o de foco! üéâ',
                        icon: 'https://www.iconpacks.net/icons/2/free-tree-icon-1578-thumb.png',
                        tag: 'planta-cresceu',
                        requireInteraction: true
                    });
                });
            }
          }
    }
}

function toggleNatal() { 
    modoNatal = !modoNatal; 
    if(modoNatal) {
        if (modoFundoMar) {
            StorageSeguro.set('jardimAquatico', jardimData);
        }
        modoMedieval = false;
        modoCandyfornia = false;
        modoEurosummer = false;
        modoFundoMar = false;
    }
    StorageSeguro.set('modoNatal', modoNatal); 
    StorageSeguro.set('modoMedieval', modoMedieval);
    StorageSeguro.set('modoCandyfornia', modoCandyfornia);
    StorageSeguro.set('modoEurosummer', modoEurosummer);
    StorageSeguro.set('modoFundoMar', modoFundoMar);
    
    // Carrega grid de terra imediatamente
    initJardimData();
    
    criarParticulas(); 
    applyNatalUI(); 
    applyMedievalUI(); 
    applyCandyforniaUI();
    applyEurosummerUI();
    applyFundoMarUI();
    
    const btnNatal = document.getElementById('btnNatal');
    const btnMedieval = document.getElementById('btnMedievalLoja');
    const btnCandy = document.getElementById('btnCandyforniaLoja');
    const btnEuro = document.getElementById('btnEurosummerLoja');
    const btnFundoMar = document.getElementById('btnFundoMarLoja');

    if (btnNatal) btnNatal.classList.toggle('on', modoNatal);
    if (btnMedieval) btnMedieval.classList.toggle('on', modoMedieval);
    if (btnCandy) btnCandy.classList.toggle('on', modoCandyfornia);
    if (btnEuro) btnEuro.classList.toggle('on', modoEurosummer);
    if (btnFundoMar) btnFundoMar.classList.toggle('on', modoFundoMar);

    verificarBotoesPetsLoja();

    const pool = modoNatal ? ITENS_NATAL : ITENS_PADRAO;
    escolhido = pool[0];

    setLuckyPlant(); 
    renderJardim();
}


function toggleMedieval() {
    if (!medievalComprado) return;
    modoMedieval = !modoMedieval;
    if(modoMedieval) {
        if (modoFundoMar) {
            StorageSeguro.set('jardimAquatico', jardimData);
        }
        modoNatal = false;
        modoCandyfornia = false;
        modoEurosummer = false;
        modoFundoMar = false;
    }
    StorageSeguro.set('modoMedieval', modoMedieval);
    StorageSeguro.set('modoNatal', modoNatal);
    StorageSeguro.set('modoCandyfornia', modoCandyfornia);
    StorageSeguro.set('modoEurosummer', modoEurosummer);
    StorageSeguro.set('modoFundoMar', modoFundoMar);
    
    // Carrega grid de terra imediatamente
    initJardimData();
    
    criarParticulas(); 
    applyMedievalUI(); 
    applyNatalUI();
    applyCandyforniaUI();
    applyEurosummerUI();
    applyFundoMarUI();

    const btnNatal = document.getElementById('btnNatal');
    const btnMedieval = document.getElementById('btnMedievalLoja');
    const btnCandy = document.getElementById('btnCandyforniaLoja');
    const btnEuro = document.getElementById('btnEurosummerLoja');
    const btnFundoMar = document.getElementById('btnFundoMarLoja');

    if (btnNatal) btnNatal.classList.toggle('on', modoNatal);
    if (btnMedieval) btnMedieval.classList.toggle('on', modoMedieval);
    if (btnCandy) btnCandy.classList.toggle('on', modoCandyfornia);
    if (btnEuro) btnEuro.classList.toggle('on', modoEurosummer);
    if (btnFundoMar) btnFundoMar.classList.toggle('on', modoFundoMar);

    verificarBotoesPetsLoja();

    const pool = modoMedieval ? ITENS_MEDIEVAL : ITENS_PADRAO;
    escolhido = pool[0];

    setLuckyPlant(); 
    renderJardim();
}


function toggleCandyfornia() {
    if (!candyforniaComprado) return;
    
    modoCandyfornia = !modoCandyfornia;
    if(modoCandyfornia) {
        if (modoFundoMar) {
            StorageSeguro.set('jardimAquatico', jardimData);
        }
        modoNatal = false;
        modoMedieval = false;
        modoEurosummer = false;
        modoFundoMar = false;
    }
    StorageSeguro.set('modoCandyfornia', modoCandyfornia);
    StorageSeguro.set('modoNatal', modoNatal);
    StorageSeguro.set('modoMedieval', modoMedieval);
    StorageSeguro.set('modoEurosummer', modoEurosummer);
    StorageSeguro.set('modoFundoMar', modoFundoMar);
    
    // Carrega grid de terra imediatamente
    initJardimData();
    
    criarParticulas();
    applyCandyforniaUI();
    applyNatalUI();
    applyMedievalUI();
    applyEurosummerUI();
    applyFundoMarUI();

    const btnNatal = document.getElementById('btnNatal');
    const btnMedieval = document.getElementById('btnMedievalLoja');
    const btnCandy = document.getElementById('btnCandyforniaLoja');
    const btnEuro = document.getElementById('btnEurosummerLoja');
    const btnFundoMar = document.getElementById('btnFundoMarLoja');

    if (btnNatal) btnNatal.classList.toggle('on', modoNatal);
    if (btnMedieval) btnMedieval.classList.toggle('on', modoMedieval);
    if (btnCandy) btnCandy.classList.toggle('on', modoCandyfornia);
    if (btnEuro) btnEuro.classList.toggle('on', modoEurosummer);
    if (btnFundoMar) btnFundoMar.classList.toggle('on', modoFundoMar);

    verificarBotoesPetsLoja();

    const pool = modoCandyfornia ? ITENS_CANDYFORNIA : ITENS_PADRAO;
    escolhido = pool[0];

    setLuckyPlant(); 
    renderJardim();
}

function toggleEurosummer() {
    if (!eurosummerComprado) return;
    
    modoEurosummer = !modoEurosummer;
    if(modoEurosummer) {
        // Se estava no fundo do mar, salva antes de sair
        if (modoFundoMar) {
            StorageSeguro.set('jardimAquatico', jardimData);
        }

        modoNatal = false;
        modoMedieval = false;
        modoCandyfornia = false;
        modoFundoMar = false; // Garante sa√≠da do mar

        if (!vistoIntroEurosummer) {
            setTimeout(() => {
                showModal({
                    text: "üèõÔ∏è <b>Bem-vindo √† Riviera Italiana</b><br><br>O sol brilha sobre as ru√≠nas antigas...",
                    onConfirm: () => {
                        vistoIntroEurosummer = true;
                        StorageSeguro.set('vistoIntroEurosummer', true);
                    }
                });
            }, 500);
        }
    }
    
    StorageSeguro.set('modoEurosummer', modoEurosummer);
    StorageSeguro.set('modoNatal', modoNatal);
    StorageSeguro.set('modoMedieval', modoMedieval);
    StorageSeguro.set('modoCandyfornia', modoCandyfornia);
    StorageSeguro.set('modoFundoMar', modoFundoMar);
    
    // 4. ATUALIZAR DADOS IMEDIATAMENTE (Carrega grid de terra)
    initJardimData();
    
    criarParticulas();
    applyEurosummerUI();
    applyNatalUI();
    applyMedievalUI();
    applyCandyforniaUI();
    applyFundoMarUI();

    const btnNatal = document.getElementById('btnNatal');
    const btnMedieval = document.getElementById('btnMedievalLoja');
    const btnCandy = document.getElementById('btnCandyforniaLoja');
    const btnEuro = document.getElementById('btnEurosummerLoja');
    const btnFundoMar = document.getElementById('btnFundoMarLoja');
    
    if (btnNatal) btnNatal.classList.toggle('on', modoNatal);
    if (btnMedieval) btnMedieval.classList.toggle('on', modoMedieval);
    if (btnCandy) btnCandy.classList.toggle('on', modoCandyfornia);
    if (btnEuro) btnEuro.classList.toggle('on', modoEurosummer);
    if (btnFundoMar) btnFundoMar.classList.toggle('on', modoFundoMar);

    verificarBotoesPetsLoja();

    // Atualizar planta escolhida
    const pool = modoEurosummer ? (eurosummerEmojisDesbloqueados.length > 0 ? eurosummerEmojisDesbloqueados : ITENS_PADRAO) : ITENS_PADRAO;
    escolhido = pool[0];

    setLuckyPlant();
    renderJardim();
}

function abrirPopUpEscolhaGuia() {
    const overlay = document.createElement('div');
    overlay.id = 'escolhaGuiaOverlay';
    overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100000;
        animation: fadeIn 0.3s ease;
    `;
    
    const popup = document.createElement('div');
    popup.className = 'guia-escolha-popup';
    popup.style.cssText = `
        background: var(--bg-panel, #ffffff);
        border-radius: 20px;
        padding: 30px;
        max-width: 400px;
        width: 90%;
        text-align: center;
        box-shadow: 0 15px 45px rgba(0, 0, 0, 0.2);
    `;
    
    popup.innerHTML = `
        <h2 style="color: var(--primary, #4CAF50); margin-bottom: 20px;">üåä Escolha seu Guia</h2>
        <p style="color: var(--text-main, #333); margin-bottom: 20px;">
            Algu√©m te salvou... Quem est√° diante de voc√™ agora?
        </p>
        <div style="display: flex; justify-content: space-around; gap: 20px;">
            <div onclick="escolherSereia()" style="cursor: pointer; transition: transform 0.3s;">
                <div style="font-size: 60px; color: var(--primary, #4CAF50); margin-bottom: 10px;">üßú‚Äç‚ôÄÔ∏è</div>
                <p style="font-weight: bold; color: var(--text-main, #333);">Sereia</p>
            </div>
            <div onclick="escolherTritao()" style="cursor: pointer; transition: transform 0.3s;">
                <div style="font-size: 60px; color: var(--primary, #4CAF50); margin-bottom: 10px;">üßú‚Äç‚ôÇÔ∏è</div>
                <p style="font-weight: bold; color: var(--text-main, #333);">Trit√£o</p>
            </div>
        </div>
    `;
    
    overlay.appendChild(popup);
    document.body.appendChild(overlay);
    
    // Anima√ß√£o de fade-in
    const style = document.createElement('style');
    style.setAttribute('data-popup-type', 'escolha');
    style.textContent = `
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        #escolhaGuiaOverlay { animation: fadeIn 0.3s ease; }
    `;
    document.head.appendChild(style);
    
    // Fechar pop-up ao clicar fora
    overlay.onclick = (e) => {
        if (e.target === overlay) {
            document.body.removeChild(overlay);
            document.head.removeChild(style);
        }
    };
}

function escolherSereia() {
    guiaEscolhidoFundoMar = 'üßú‚Äç‚ôÄÔ∏è';
    vistoIntroFundoMar = true;
    StorageSeguro.set('guiaEscolhidoFundoMar', 'üßú‚Äç‚ôÄÔ∏è');
    StorageSeguro.set('vistoIntroFundoMar', true);
    
    // Fechar pop-up de escolha
    const overlay = document.getElementById('escolhaGuiaOverlay');
    if (overlay) {
        document.body.removeChild(overlay);
        const style = document.querySelector('style[data-popup-type="escolha"]');
        if (style) document.head.removeChild(style);
    }
    
    // Abrir pop-up de confirma√ß√£o
    abrirPopUpConfirmaSereia();
}

function escolherTritao() {
    guiaEscolhidoFundoMar = 'üßú‚Äç‚ôÇÔ∏è';
    vistoIntroFundoMar = true;
    StorageSeguro.set('guiaEscolhidoFundoMar', 'üßú‚Äç‚ôÇÔ∏è');
    StorageSeguro.set('vistoIntroFundoMar', true);
    
    // Fechar pop-up de escolha
    const overlay = document.getElementById('escolhaGuiaOverlay');
    if (overlay) {
        document.body.removeChild(overlay);
        const style = document.querySelector('style[data-popup-type="escolha"]');
        if (style) document.head.removeChild(style);
    }
    
    // Abrir pop-up de confirma√ß√£o
    abrirPopUpConfirmaTritao();
}

function abrirPopUpConfirmaSereia() {
    const overlay = document.createElement('div');
    overlay.id = 'confirmaSereiaOverlay';
    overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100001;
        animation: fadeIn 0.3s ease;
    `;
    
    const popup = document.createElement('div');
    popup.className = 'guia-confirma-popup';
    popup.style.cssText = `
        background: var(--bg-panel, #ffffff);
        border-radius: 20px;
        padding: 30px;
        max-width: 400px;
        width: 90%;
        text-align: center;
        box-shadow: 0 15px 45px rgba(0, 0, 0, 0.2);
    `;
    
    popup.innerHTML = `
        <h3 style="color: var(--primary, #4CAF50); margin-bottom: 20px;">üßú‚Äç‚ôÄÔ∏è Sereia</h3>
        <p style="color: var(--text-main, #333); margin-bottom: 30px;">
            "Bem-vindo. Este recife j√° foi o cora√ß√£o do oceano, mas agora est√° morrendo. Sinto que sua energia pode nos ajudar a traz√™-lo de volta. Vamos come√ßar?"
        </p>
        <button onclick="confirmarSereia()" style="background: var(--primary, #4CAF50); color: white; border: none; padding: 12px 35px; border-radius: 50px !important; font-weight: bold; cursor: pointer; transition: all 0.3s; ">
            Confirmar
        </button>
    `;
    
    overlay.appendChild(popup);
    document.body.appendChild(overlay);
    
    // Anima√ß√£o de fade-in
    const style = document.createElement('style');
    style.setAttribute('data-popup-type', 'confirma-sereia');
    style.textContent = `
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        #confirmaSereiaOverlay { animation: fadeIn 0.3s ease; }
    `;
    document.head.appendChild(style);
    
    // Fechar pop-up ao clicar fora
    overlay.onclick = (e) => {
        if (e.target === overlay) {
            document.body.removeChild(overlay);
            document.head.removeChild(style);
            // Reativar o pop-up de escolha se o usu√°rio cancelar
            abrirPopUpEscolhaGuia();
        }
    };
}

function abrirPopUpConfirmaTritao() {
    const overlay = document.createElement('div');
    overlay.id = 'confirmaTritaoOverlay';
    overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100001;
        animation: fadeIn 0.3s ease;
    `;
    
    const popup = document.createElement('div');
    popup.className = 'guia-confirma-popup';
    popup.style.cssText = `
        background: var(--bg-panel, #ffffff);
        border-radius: 20px;
        padding: 30px;
        max-width: 400px;
        width: 90%;
        text-align: center;
        box-shadow: 0 15px 45px rgba(0, 0, 0, 0.2);
    `;
    
    popup.innerHTML = `
        <h3 style="color: var(--primary, #4CAF50); margin-bottom: 20px;">üßú‚Äç‚ôÇÔ∏è Trit√£o</h3>
        <p style="color: var(--text-main, #333); margin-bottom: 30px;">
            "Voc√™ sobreviveu √† f√∫ria do mar. Este lugar est√° em ru√≠nas, mas h√° uma for√ßa em voc√™ que eu n√£o via h√° s√©culos. Ajude-me a restaurar este recife e eu te guiarei pelas profundezas."
        </p>
        <button onclick="confirmarTritao()" style="background: var(--primary, #4CAF50); color: white; border: none; padding: 12px 35px; border-radius: 50px !important; font-weight: bold; cursor: pointer; transition: all 0.3s; ">
            Confirmar
        </button>
    `;
    
    overlay.appendChild(popup);
    document.body.appendChild(overlay);
    
    // Anima√ß√£o de fade-in
    const style = document.createElement('style');
    style.setAttribute('data-popup-type', 'confirma-tritao');
    style.textContent = `
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        #confirmaTritaoOverlay { animation: fadeIn 0.3s ease; }
    `;
    document.head.appendChild(style);
    
    // Fechar pop-up ao clicar fora
    overlay.onclick = (e) => {
        if (e.target === overlay) {
            document.body.removeChild(overlay);
            document.head.removeChild(style);
            // Reativar o pop-up de escolha se o usu√°rio cancelar
            abrirPopUpEscolhaGuia();
        }
    };
}

function confirmarSereia() {
    // Salvar escolha
    guiaEscolhidoFundoMar = 'üßú‚Äç‚ôÄÔ∏è';
    vistoIntroFundoMar = true;
    StorageSeguro.set('guiaEscolhidoFundoMar', 'üßú‚Äç‚ôÄÔ∏è');
    StorageSeguro.set('vistoIntroFundoMar', true);
    
    // ATUALIZA√á√ÉO IMEDIATA DO ROMANCE MANAGER
    RomanceManager.setPartner('üßú‚Äç‚ôÄÔ∏è');

    // Fechar pop-up de confirma√ß√£o
    const overlay = document.getElementById('confirmaSereiaOverlay');
    if (overlay) {
        document.body.removeChild(overlay);
        const style = document.querySelector('style[data-popup-type="confirma-sereia"]');
        if (style) document.head.removeChild(style);
    }
    
    // Atualizar a UI
    renderJardim();
}
function confirmarTritao() {
    // Salvar escolha
    guiaEscolhidoFundoMar = 'üßú‚Äç‚ôÇÔ∏è';
    vistoIntroFundoMar = true;
    StorageSeguro.set('guiaEscolhidoFundoMar', 'üßú‚Äç‚ôÇÔ∏è');
    StorageSeguro.set('vistoIntroFundoMar', true);
    
    // ATUALIZA√á√ÉO IMEDIATA DO ROMANCE MANAGER
    RomanceManager.setPartner('üßú‚Äç‚ôÇÔ∏è');
    
    // Fechar pop-up de confirma√ß√£o
    const overlay = document.getElementById('confirmaTritaoOverlay');
    if (overlay) {
        document.body.removeChild(overlay);
        const style = document.querySelector('style[data-popup-type="confirma-tritao"]');
        if (style) document.head.removeChild(style);
    }
    
    // Atualizar a UI
    renderJardim();
}


function toggleFundoMar() {
    if (!fundoMarComprado) return;
    
    // 1. SALVAR O ESTADO ATUAL ANTES DE TROCAR
    if (modoFundoMar) {
        // Estamos saindo da √°gua: Salva o aqu√°tico atual
        StorageSeguro.set('jardimAquatico', jardimData);
    } else {
        // Estamos entrando na √°gua: Salva o normal (terrestre) atual
        StorageSeguro.set('jardim', jardimData);
    }

    // 2. INVERTER O MODO E DESLIGAR OUTROS
    modoFundoMar = !modoFundoMar;
    if (modoFundoMar) {
        modoNatal = false;
        modoMedieval = false;
        modoCandyfornia = false;
        modoEurosummer = false;
        
        // Adicionar novos motivos se necess√°rio
        const novosMotivos = ['Hidrata√ß√£o', 'Postura', 'Medita√ß√£o', 'Skincare', 'Desconex√£o'];
        let motivosAtualizados = false;
        novosMotivos.forEach(m => {
            if (!motivos.includes(m)) {
                motivos.push(m);
                motivosAtualizados = true;
            }
        });
        if (motivosAtualizados) {
            StorageSeguro.set('motivos', motivos);
            preencherSelectsMetas();
            renderSelects();
        }

        if (!vistoIntroFundoMar) {
            setTimeout(() => { abrirPopUpEscolhaGuia(); }, 500);
        }
    }

    // 3. PERSISTIR ESTADOS
    StorageSeguro.set('modoFundoMar', modoFundoMar);
    StorageSeguro.set('modoNatal', modoNatal);
    StorageSeguro.set('modoMedieval', modoMedieval);
    StorageSeguro.set('modoCandyfornia', modoCandyfornia);
    StorageSeguro.set('modoEurosummer', modoEurosummer);
    
    // 4. ATUALIZAR INTERFACE E DADOS IMEDIATAMENTE
    initJardimData(); // For√ßa carregamento do grid correto (Terra ou Mar)
    
    criarParticulas();
    applyFundoMarUI();
    applyEurosummerUI();
    applyNatalUI();
    applyMedievalUI();
    applyCandyforniaUI();

    // Atualizar bot√µes
    const btnNatal = document.getElementById('btnNatal');
    const btnMedieval = document.getElementById('btnMedievalLoja');
    const btnCandy = document.getElementById('btnCandyforniaLoja');
    const btnEuro = document.getElementById('btnEurosummerLoja');
    const btnFundoMar = document.getElementById('btnFundoMarLoja');
    
    if (btnNatal) btnNatal.classList.toggle('on', modoNatal);
    if (btnMedieval) btnMedieval.classList.toggle('on', modoMedieval);
    if (btnCandy) btnCandy.classList.toggle('on', modoCandyfornia);
    if (btnEuro) btnEuro.classList.toggle('on', modoEurosummer);
    if (btnFundoMar) btnFundoMar.classList.toggle('on', modoFundoMar);

    verificarBotoesPetsLoja();

    // Atualizar planta escolhida
    const pool = modoFundoMar ? (fundoMarEmojisDesbloqueados.length > 0 ? fundoMarEmojisDesbloqueados : ITENS_PADRAO) : ITENS_PADRAO;
    escolhido = pool[0];
    
    setLuckyPlant();
    
    // 5. RENDERIZA√á√ÉO IMEDIATA
    renderJardim();
    if (modo3D) renderJardim3D();
}

function reiniciarFundoMar() {
    showModal({ 
        text: "‚ö†Ô∏è Desejas reiniciar a tua hist√≥ria no Fundo do Mar?<br><br>As tuas metas conclu√≠das do modo Fundo do Mar voltar√£o a zero e as mem√≥rias ser√£o guardadas novamente. Os emojis j√° plantados no jardim permanecer√£o.", 
        onConfirm: () => {
            fundoMarMetasConcluidas = [];
            fundoMarEmojisDesbloqueados = [];
            vistoIntroFundoMar = false;
            StorageSeguro.set('fundoMarMetasConcluidas', []);
            StorageSeguro.set('fundoMarEmojisDesbloqueados', []);
            StorageSeguro.set('vistoIntroFundoMar', false);
            
            // RESETAR O ROMANCE TAMB√âM
            RomanceManager.reset();
            guiaEscolhidoFundoMar = null;
            StorageSeguro.set('guiaEscolhidoFundoMar', null);

            // Abandonar animais marinhos
            const animaisMarinhos = ['üêã', 'üê†', 'üêü', 'üê°', 'üêô', 'ü¶≠', 'üê¢', 'ü¶¶', 'üßú‚Äç‚ôÇÔ∏è', 'üßú‚Äç‚ôÄÔ∏è'];
            petsComprados = petsComprados.filter(p => !animaisMarinhos.includes(p.icone));
            petsEmCena = petsEmCena.filter(p => !animaisMarinhos.includes(p.icone));
            StorageSeguro.set('petsComprados', petsComprados);

            // Se o modo estiver ativo, resetar a planta escolhida para o padr√£o e desativar o modo
            if (modoFundoMar) {
                escolhido = ITENS_PADRAO[0];
                StorageSeguro.set('plantaEscolhida', escolhido);
                
                modoFundoMar = false;
                StorageSeguro.set('modoFundoMar', false);
                
                // CORRE√á√ÉO: For√ßar recarregamento do jardim terrestre ao resetar e sair
                jardimDataNormal = StorageSeguro.get('jardim', Array(getTotalCells()).fill(null));
                jardimData = jardimDataNormal;
                
                // Atualizar UI imediatamente
                applyFundoMarUI();
                const btnFundoMar = document.getElementById('btnFundoMarLoja');
                if (btnFundoMar) btnFundoMar.classList.remove('on');
                
                initJardimData();
                renderJardim();
                if (modo3D) renderJardim3D();
            }
            
            setTimeout(() => {
                showModal({ 
                    text: "üåä Hist√≥ria reiniciada! As mem√≥rias do oceano aguardam por ti novamente.", 
                    onConfirm: () => {
                        renderMetasFundoMar();
                        if (modoFundoMar) applyFundoMarUI();
                    } 
                });
            }, 300);
        }
    });
}

function applyCandyforniaUI() {
    if(modoCandyfornia) {
        document.body.classList.add('candyfornia-mode');
    } else {
        document.body.classList.remove('candyfornia-mode');
    }
}

function applyEurosummerUI() {
    const btnCorreio = document.getElementById('btnCorreioEurosummer');
    if(modoEurosummer) {
        document.body.classList.add('eurosummer-mode');
        if (btnCorreio) btnCorreio.style.display = 'flex';
    } else {
        document.body.classList.remove('eurosummer-mode');
        if (btnCorreio) btnCorreio.style.display = 'none';
    }
}

function applyFundoMarUI() {
    const btnMetas = document.getElementById('btnMetasFundoMar');
    const btnCorreio = document.getElementById('btnCorreioFundoMar');
    const painelMetas = document.getElementById('painelMetasFundoMar');
    
    if(modoFundoMar) {
        document.body.classList.add('fundo-mar-mode');
        if (btnMetas) btnMetas.style.display = 'flex';
        if (btnCorreio) btnCorreio.style.display = 'flex';
        renderMetasFundoMar();
        // Garantir que as part√≠culas iniciem imediatamente ao ativar o modo
        if (typeof particulasManager !== 'undefined') {
            particulasManager.iniciar();
        }
    } else {
        document.body.classList.remove('fundo-mar-mode');
        if (btnMetas) btnMetas.style.display = 'none';
        if (btnCorreio) btnCorreio.style.display = 'none';
        if (painelMetas) painelMetas.style.display = 'none';
    }
}

/// Vari√°vel de controle do listener
let listenerFecharMetasFundoMar = null;

// Injeta o estilo de anima√ß√£o de sa√≠da (Slide Out) automaticamente
// Isto garante que o efeito funciona sem teres de editar o CSS manualmente
const styleSheetFundoMar = document.createElement("style");
styleSheetFundoMar.innerText = `
    @keyframes slideOutRight {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
`;
document.head.appendChild(styleSheetFundoMar);

function toggleMetasFundoMar() {
    const painel = document.getElementById('painelMetasFundoMar');
    const btn = document.getElementById('btnMetasFundoMar');
    
    if (!painel) return;

    // Verifica se est√° vis√≠vel
    const estaFechado = painel.style.display === 'none' || painel.style.display === '';

    if (estaFechado) {
        // === ABRIR ===
        renderMetasFundoMar();
        painel.style.display = 'block';
        // For√ßa a anima√ß√£o de entrada
        painel.style.animation = 'slideInRight 0.3s ease forwards';

        // L√≥gica do clique fora (igual √† anterior)
        if (listenerFecharMetasFundoMar) {
            document.removeEventListener('click', listenerFecharMetasFundoMar);
        }

        listenerFecharMetasFundoMar = function(event) {
            if (!painel.contains(event.target) && event.target !== btn && !btn.contains(event.target)) {
                toggleMetasFundoMar(); 
            }
        };

        setTimeout(() => {
            document.addEventListener('click', listenerFecharMetasFundoMar);
        }, 100);

    } else {
        // === FECHAR COM FADE OUT ===
        
        // 1. Aplica a anima√ß√£o de sa√≠da
        painel.style.animation = 'slideOutRight 0.3s ease forwards';

        // 2. Remove o listener imediatamente para evitar conflitos
        if (listenerFecharMetasFundoMar) {
            document.removeEventListener('click', listenerFecharMetasFundoMar);
            listenerFecharMetasFundoMar = null;
        }

        // 3. Aguarda o tempo da anima√ß√£o (300ms) antes de esconder o elemento
        setTimeout(() => {
            // S√≥ esconde se o utilizador n√£o tiver clicado para abrir novamente neste meio tempo
            if (painel.style.animationName === 'slideOutRight') {
                painel.style.display = 'none';
            }
        }, 280); // 280ms para garantir que n√£o pisca no final
    }
}


function renderMetasFundoMar() {
    const lista = document.getElementById('listaMetasFundoMar');
    if (!lista) return;
    
    lista.innerHTML = '';
    
    // Encontrar a pr√≥xima meta n√£o conclu√≠da
    let proximaMetaId = -1;
    for (let i = 0; i < METAS_FUNDO_MAR.length; i++) {
        if (!fundoMarMetasConcluidas.includes(METAS_FUNDO_MAR[i].id)) {
            proximaMetaId = METAS_FUNDO_MAR[i].id;
            break;
        }
    }
    
    METAS_FUNDO_MAR.forEach(meta => {
        const concluida = fundoMarMetasConcluidas.includes(meta.id);
        const isProxima = meta.id === proximaMetaId;
        const bloqueada = !concluida && !isProxima;
        
        const item = document.createElement('div');
        item.className = `meta-item-fundo ${concluida ? 'concluida' : ''} ${bloqueada ? 'bloqueada' : ''} ${isProxima ? 'proxima' : ''}`;        
        
        item.innerHTML = `
            <div class="meta-emoji">${concluida ? meta.emoji : (isProxima ? 'üéØ' : '‚ùì')}</div>
            <div class="meta-info">
                <strong>${bloqueada ? '???' : meta.motivo}</strong><br>
                <span>${bloqueada ? '???' : meta.tempo + ' minutos'}</span>
            </div>
            <div class="meta-status">${concluida ? '‚úÖ' : (isProxima ? 'üîì' : 'üîí')}</div>
        `;
        
        lista.appendChild(item);
    });
}

function abrirCorreioFundoMar() {
    if (fundoMarMetasConcluidas.length === 0) {
        showModal({ text: "üåä O teu correio do mar ainda est√° vazio. Completa as metas do oceano para receber a tua primeira mem√≥ria.", onConfirm: () => {} });
        return;
    }

    let html = `
        <div style="max-height: 400px; overflow-y: auto; padding-right: 10px; text-align: left;">
            <h3 style="color: #4cc9f0; text-align: center; margin-bottom: 20px;">üêö Mem√≥rias do Oceano</h3>
    `;

    // Ordenar metas conclu√≠das por ID
    const metasOrdenadas = [...METAS_FUNDO_MAR]
        .filter(m => fundoMarMetasConcluidas.includes(m.id))
        .sort((a, b) => a.id - b.id);

    metasOrdenadas.forEach(meta => {
        html += `
            <div style="background: rgba(0, 53, 102, 0.5); border: 1px solid #4cc9f0; border-radius: 12px; padding: 15px; margin-bottom: 15px;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <span style="font-size: 24px;">${meta.emoji}</span>
                    <strong style="color: #4cc9f0;">Mem√≥ria #${meta.id}</strong>
                </div>
                <p style="color: #ffffff; font-size: 14px; line-height: 1.6; margin: 0; font-style: italic;">
                    "${meta.texto}"
                </p>
                <div style="margin-top: 10px; font-size: 11px; color: #90e0ef; opacity: 0.8;">
                    üéØ Conquistada em: ${meta.motivo} (${meta.tempo} min)
                </div>
            </div>
        `;
    });

    html += `</div>`;

    showModal({
        text: html,
        onConfirm: () => {}
    });
}

function applyNatalUI() { 
    if(modoNatal) { document.body.classList.add('natal-mode'); } 
    else { document.body.classList.remove('natal-mode'); } 
}

function applyMedievalUI() {
    if(modoMedieval) { document.body.classList.add('medieval-mode'); }
    else { document.body.classList.remove('medieval-mode'); }
}

function toggleDarkMode() { 
    // 1. Ao clicar no bot√£o manual, DESATIVAMOS o modo autom√°tico obrigatoriamente
    temaAutomaticoAtivo = false;
    StorageSeguro.set('temaAutomaticoAtivo', false);
    
    // 2. Atualiza o visual do bot√£o switch do "Auto Tema" para desligado
    const btnTemaAuto = document.getElementById('btnTemaAuto');
    if (btnTemaAuto) {
        btnTemaAuto.classList.remove('on');
    }
    
    // 3. Alterna a classe no corpo do site
    const isDark = document.body.classList.toggle('dark-mode');
    
    // 4. Salva a prefer√™ncia do usu√°rio (true ou false)
    StorageSeguro.set('darkMode', isDark);
    
    // 5. Ajustes visuais extras
    renderEstrelasNoCeu();
    
    // 6. Atualiza o texto do bot√£o principal
    const btnTema = document.getElementById('btnTema');
    if (btnTema) {
        if (isDark) {
            btnTema.textContent = 'üåô';
            btnTema.title = 'Alternar para modo claro';
        } else {
            btnTema.textContent = '‚òÄÔ∏è';
            btnTema.title = 'Alternar para modo escuro';
        }
    }
}

function toggleTemaAuto() {
    const btn = document.getElementById('btnTemaAuto');
    
    // 1. Inverte o valor atual
    temaAutomaticoAtivo = !temaAutomaticoAtivo;
    
    // 2. Salva o novo valor
    StorageSeguro.set('temaAutomaticoAtivo', temaAutomaticoAtivo);
    
    // 3. Atualiza o visual do bot√£o switch
    if (btn) btn.classList.toggle('on', temaAutomaticoAtivo);
    
    if (temaAutomaticoAtivo) {
        // Se ativou, roda a verifica√ß√£o de hora imediatamente
        verificarTemaAutomatico();
        
        // Exibe um feedback visual r√°pido
        showModal({ 
            text: "üïí Modo Autom√°tico Ativado!<br><br>O tema mudar√° sozinho:<br>‚òÄÔ∏è Claro: 06:00 - 18:00<br>üåô Escuro: 18:00 - 06:00", 
            onConfirm: () => {} 
        });
    }
}


function toggleMenu() { document.getElementById('abaEsquerda').classList.toggle('aberto'); }

function fecharMenuSeAberto(event) {
    const menu = document.getElementById('abaEsquerda');
    const menuBtn = document.getElementById('abrirMenuBtn');
    if (menu.classList.contains('aberto') && !menu.contains(event.target) && event.target !== menuBtn) {
        menu.classList.remove('aberto');
    }
}

function renderJardim2D() {
    const c = document.getElementById('jardim');
    c.innerHTML = '';
    c.style.removeProperty('grid-template-columns');
    c.style.removeProperty('width');
    
    const fontSize = grid10x10 ? 18 : 28;
    
    jardimData.forEach((item, i) => {
        let d = document.createElement('div');
        d.className = 'plot' + (i === alvo ? ' alvo' : '');
        d.style.fontSize = `${fontSize}px`;
        
        if (grid10x10) d.style.borderRadius = '8px';
        
        if (intervalo) {
            d.style.pointerEvents = 'none';
            d.style.opacity = '1';
        } else {
            d.style.pointerEvents = 'auto';
            d.style.opacity = '1';
        }
        
        // 1. Renderizar Planta
        if(item) {
            const itensMarinhos = [...ITENS_FUNDO_MAR_BASE, 'üßú‚Äç‚ôÄÔ∏è', 'üßú‚Äç‚ôÇÔ∏è', 'ü´ß', 'üêö', 'ü™∏', '‚öì', 'üõ•', 'üö¢'];
            const isItemMarinho = itensMarinhos.includes(item.icone) || (item.final && itensMarinhos.includes(item.final));
            const isAllowBoth = (typeof ITENS_ALLOW_AMBOS !== 'undefined') && (ITENS_ALLOW_AMBOS.includes(item.icone) || (item.final && ITENS_ALLOW_AMBOS.includes(item.final)));
            
            let mostrarItem = true;
            if (modoFundoMar) {
                if (!isItemMarinho && !isAllowBoth) mostrarItem = false;
            } else {
                if (isItemMarinho && !isAllowBoth) mostrarItem = false;
            }

            if (mostrarItem) {
                let span = document.createElement('span');
                span.textContent = item.icone;
                span.className = 'plant-spawn' + (item.emProgresso ? ' pulsar' : '') + (item.lucky ? ' lucky-glow' : '');
                if(item.emProgresso) span.style.animation = 'pulsar 1.5s infinite';
                d.appendChild(span);
            }
        } 
        // 2. Renderizar Pet
        else {
            let petAqui = petsEmCena.find(p => p.index === i);
            if (petAqui) {
                const animaisMarinhos = ['üêã', 'üê†', 'üêü', 'üê°', 'üêô', 'ü¶≠', 'üê¢', 'ü¶¶', 'üßú‚Äç‚ôÇÔ∏è', 'üßú‚Äç‚ôÄÔ∏è'];
                const isMarinho = animaisMarinhos.includes(petAqui.icone);
                
                // Pets e c√¥njuge aparecem imediatamente em qualquer grid
                let mostrarPet = true; 

                if (mostrarPet) {
                    let span = document.createElement('span');
                    span.textContent = petAqui.icone;
                    span.style.cursor = 'pointer';
                    
                    if (!modoFundoMar && isMarinho) {
                        span.style.border = "2px solid #87cefa";
                        span.style.borderRadius = "50%";
                        span.style.padding = "2px";
                    }
                    d.appendChild(span);
                    
                    d.onclick = (e) => {
                        e.stopPropagation();
                        if (RomanceManager.handlePetClick(petAqui)) return;
                        darCarinho(petAqui, i);
                    };
                    c.appendChild(d); 
                    return; 
                }
            }
            // 3. Renderizar Tesouro (Prioridade sobre vazio, mas abaixo de planta/pet)
            else if (i === tesouroAtivoIndex) {
                let span = document.createElement('span');
                span.textContent = 'ü™é';
                span.style.cursor = 'pointer';
                span.style.filter = 'drop-shadow(0 0 5px gold)';
                span.classList.add('plant-spawn'); 
                d.appendChild(span);
                
                // Evento de clique exclusivo para o tesouro
                d.onclick = (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    coletarTesouro(i);
                };
                c.appendChild(d);
                return; // Importante: retorna aqui para n√£o adicionar o click de plantar
            }
        }

        // 4. Click padr√£o (Plantar) - S√≥ adiciona se n√£o for tesouro nem pet
        if (!d.onclick) {
            d.onclick = () => {
                if(intervalo) return;
                if(item) {
                    document.getElementById('painelMotivo').style.display = 'block';
                    document.getElementById('textoMotivo').textContent = `Focado em: ${item.motivo}`;
                } else {
                    abrirModalPlanta(i);
                }
            };
        }
        
        c.appendChild(d);
    });
}



function renderJardim() {
    // Garante que jardimData est√° sincronizado com o modo atual antes de renderizar
    jardimData = modoFundoMar ? jardimDataAquatico : jardimDataNormal;
    
    if (modo3D) {
        renderJardim3D();
    } else {
        renderJardim2D();
    }
}

function abrirModalPlanta(index) {
    // N√£o permite abrir modal de plantio sobre caminhos; apenas mostra o motivo
    if (jardimData[index] && ehCaminhoEmoji(jardimData[index].icone)) {
        document.getElementById('painelMotivo').style.display = 'block';
        document.getElementById('textoMotivo').textContent = `Focado em: ${jardimData[index].motivo || 'Decora√ß√£o'}`;
        showToast('‚ö†Ô∏è', 'Imposs√≠vel plantar', 'Voc√™ n√£o pode plantar em cima de caminhos.');
        console.warn('abrirModalPlanta bloqueado: c√©lula com caminho no √≠ndice', index);
        return;
    }
    alvo = index;
    renderJardim();
    const p = document.getElementById('paletaModal');
    const pe = document.getElementById('paletaEspecialModal');
    
    p.innerHTML = ''; pe.innerHTML = '';
    
    // Se estiver no modo Fundo do Mar, a paleta padr√£o (terrestre) fica vazia
    if (!modoFundoMar) {
        ITENS_PADRAO.forEach(i => { 
            let d = document.createElement('div'); d.className = 'item' + (i === escolhido ? ' selecionado' : ''); 
            // Mostrar a textura (imagem) para QUALQUER item que seja caminho, mantendo emojis para os demais
            if (ehCaminhoEmoji(i)) {
                const imgSrc = gerarTexturaCaminho({norte:false,sul:false,oeste:false,leste:false}, i);
                d.innerHTML = `<img src="${imgSrc}" alt="${i}" style="width:28px;height:28px;display:block;margin:0 auto;">`;
            } else {
                d.textContent = i;
            }
            d.onclick = () => { 
                escolhido = i; 
                StorageSeguro.set('plantaEscolhida', escolhido); // Salvar planta selecionada
                fecharModal('modalPlantaOverlay'); 
                renderJardim(); 
                atualizarBotoes();
            }; 
            p.appendChild(d); 
        });
    } else {
        p.innerHTML = '<small style="opacity:0.5; padding:15px;">Itens terrestres ocultos no modo aqu√°tico.</small>';
    }

    // Filtrar o pool especial para garantir que itens aqu√°ticos s√≥ apare√ßam no modo aqu√°tico
    let especialPool = [];
    if (modoFundoMar) {
        especialPool = [...ITENS_FUNDO_MAR_BASE, ...fundoMarEmojisDesbloqueados];
    } else {
        // Se N√ÉO for modo aqu√°tico, pegamos os itens dos outros modos (Eurosummer, Candy, Natal, Medieval)
        // mas EXCLU√çMOS qualquer item que possa ser considerado aqu√°tico se houver sobreposi√ß√£o
        especialPool = (modoEurosummer ? eurosummerEmojisDesbloqueados : (modoCandyfornia ? ITENS_CANDYFORNIA : (modoNatal ? ITENS_NATAL : (modoMedieval ? ITENS_MEDIEVAL : []))));
    }

    if(especialPool.length === 0) {
        pe.innerHTML = '<small style="opacity:0.5; padding:15px;">Nenhum modo especial ativo.</small>';
    } else {
        especialPool.forEach(i => {
            let d = document.createElement('div'); d.className = 'item' + (i === escolhido ? ' selecionado' : ''); 
            d.textContent = i; 
            d.onclick = () => { 
                escolhido = i; 
                StorageSeguro.set('plantaEscolhida', escolhido); // Salvar planta selecionada
                fecharModal('modalPlantaOverlay'); 
                renderJardim(); 
                atualizarBotoes();
            }; 
            pe.appendChild(d); 
        });
    }
    
    abrirModal('modalPlantaOverlay');
}

function salvarTudo() { 
    if (modoFundoMar) {
        jardimDataAquatico = jardimData;
        StorageSeguro.set('jardimAquatico', jardimDataAquatico);
    } else {
        jardimDataNormal = jardimData;
        StorageSeguro.set('jardim', jardimDataNormal);
    }
    StorageSeguro.set('sessoesTotais', sessoesTotais); 
    StorageSeguro.set('historico_foco', historico); 
    StorageSeguro.set('moedasFoco', totalMoedas);
    StorageSeguro.set('streakDiasAtivos', streakDiasAtivos);
    StorageSeguro.set('modo3D', modo3D);
    renderJardim();
}

function renderSelects() { 
	    const st = document.getElementById('tempoEscolhido'), sm = document.getElementById('motivoEscolhido'); 
	    
	    // 1. Carregar valores salvos
	    const savedTempo = StorageSeguro.get('ultimoTempo', null);
	    const savedMotivo = StorageSeguro.get('ultimoMotivo', null);
	    
	    st.innerHTML = ''; 
	    tempos.sort((a,b)=>a-b).forEach(t => st.add(new Option(t + " min", t))); 
	    sm.innerHTML = ''; motivos.forEach(m => sm.add(new Option(m, m))); 
	    
	    // 2. Aplicar valores salvos ou o primeiro da lista
	    if(savedTempo) st.value = savedTempo; 
	    if(savedMotivo) sm.value = savedMotivo; 
	    
	    // 3. Adicionar listeners para salvar ao mudar
	    st.onchange = () => StorageSeguro.set('ultimoTempo', st.value);
	    sm.onchange = () => StorageSeguro.set('ultimoMotivo', sm.value);
	    
    atualizarTimerDisplay(); 
    renderGerenciamento();
}

function renderGerenciamento() {
    const listaTempos = document.getElementById('listaGerenciarTempos');
    const listaMotivos = document.getElementById('listaGerenciarMotivos');
    
    if (!listaTempos || !listaMotivos) return;

    // Renderizar Tempos
    listaTempos.innerHTML = '';
    
    // Bot√£o Adicionar Tempo
    const btnAddT = document.createElement('div');
    btnAddT.style.cssText = 'background: var(--primary); padding: 8px 15px; border-radius: 50px !important; border: 1px solid var(--primary); display: flex; align-items: center; gap: 5px; font-size: 14px; color: white; box-shadow: 0 2px 4px var(--shadow); cursor: pointer; font-weight: bold;';
    btnAddT.innerHTML = `<span>+ Adicionar</span>`;
    btnAddT.onclick = () => promptCustom('Novo tempo (min):', true, addTempo);
    listaTempos.appendChild(btnAddT);

    tempos.sort((a, b) => a - b).forEach(t => {
        const item = document.createElement('div');
        item.style.cssText = 'background: var(--bg-body); padding: 8px 15px; border-radius: 50px !important; border: 1px solid var(--primary); display: flex; align-items: center; gap: 10px; font-size: 14px; color: var(--text-main); box-shadow: 0 2px 4px var(--shadow);';
        item.innerHTML = `
            <span style="font-weight: 500;">${t} min</span>
            <span onclick="removerTempoEspecifico(${t})" style="color: #ff5252; cursor: pointer; font-weight: bold; font-size: 18px; padding: 0 5px;">√ó</span>
        `;
        listaTempos.appendChild(item);
    });

    // Renderizar Motivos
    listaMotivos.innerHTML = '';

    // Bot√£o Adicionar Motivo
    const btnAddM = document.createElement('div');
    btnAddM.style.cssText = 'background: var(--primary); padding: 8px 15px; border-radius: 50px !important; border: 1px solid var(--primary); display: flex; align-items: center; gap: 5px; font-size: 14px; color: white; box-shadow: 0 2px 4px var(--shadow); cursor: pointer; font-weight: bold;';
    btnAddM.innerHTML = `<span>+ Adicionar</span>`;
    btnAddM.onclick = () => promptCustom('Novo motivo:', false, addMotivo);
    listaMotivos.appendChild(btnAddM);

    motivos.forEach(m => {
        const item = document.createElement('div');
        item.style.cssText = 'background: var(--bg-body); padding: 8px 15px; border-radius: 50px !important; border: 1px solid var(--primary); display: flex; align-items: center; gap: 10px; font-size: 14px; color: var(--text-main); box-shadow: 0 2px 4px var(--shadow);';
        item.innerHTML = `
            <span style="font-weight: 500;">${m}</span>
            <span onclick="removerMotivoEspecifico('${m}')" style="color: #ff5252; cursor: pointer; font-weight: bold; font-size: 18px; padding: 0 5px;">√ó</span>
        `;
        listaMotivos.appendChild(item);
    });
}

function removerTempoEspecifico(v) {
    if (tempos.length <= 1) {
        showModal({ text: "Voc√™ precisa ter pelo menos um tempo configurado.", onConfirm: () => {} });
        return;
    }
    showModal({
        text: `Deseja excluir o tempo de ${v} min?`,
        onConfirm: () => {
            tempos = tempos.filter(t => t !== v);
            StorageSeguro.set('tempos', tempos);
            renderSelects();
        }
    });
}

function removerMotivoEspecifico(m) {
    if (motivos.length <= 1) {
        showModal({ text: "Voc√™ precisa ter pelo menos um motivo configurado.", onConfirm: () => {} });
        return;
    }
    showModal({
        text: `Deseja excluir o motivo "${m}"?`,
        onConfirm: () => {
            motivos = motivos.filter(mot => mot !== m);
            StorageSeguro.set('motivos', motivos);
            renderSelects();
        }
    });
}

function toggleTodoPopup() {
	    const popup = document.getElementById('todoPopup');
	    const btn = document.getElementById('btnTodoToggle');
	    const isAtivo = popup.classList.toggle('ativo');
	    btn.classList.toggle('ativo');
	    
	    // Salvar estado no localStorage
	    StorageSeguro.set('todoPopupAtivo', isAtivo);
	}

function renderTodos() { 
    const l = document.getElementById('listaTodo'); 
    if (!l) return;
    l.innerHTML = ''; 
    todos.forEach((t, i) => { 
        let d = document.createElement('div'); d.className = 'todo-item'; 
        d.innerHTML = `<input type="checkbox" ${t.done?'checked':''} onchange="todos[${i}].done=!todos[${i}].done; StorageSeguro.set('todos', todos); renderTodos()"> <span style="${t.done ? 'text-decoration: line-through; opacity: 0.6;' : ''}">${t.texto}</span> <button style="border-radius: 50px !important;" onclick="todos.splice(${i},1); StorageSeguro.set('todos', todos); renderTodos()">√ó</button>`; 
        l.appendChild(d); 
    }); 
}

function addTodo() { let i = document.getElementById('novoTodo'); if(i.value.trim()){ todos.push({texto:i.value, done:false}); i.value=''; renderTodos(); } }

function abrirConfig() { 
    // Garantir que os bot√µes estejam atualizados
    setTimeout(() => {
        atualizarBotoesConfig();
    }, 50);
    
    
    
    abrirModal('configOverlay'); 
}
// =========================
// SISTEMA DE METAS
// =========================
function toggleMetas() {
    const container = document.getElementById('metasContainer');
    const btn = document.getElementById('btnMetasToggle');
    const isAtivo = container.classList.toggle('ativo');
    btn.classList.toggle('ativo', isAtivo);
    StorageSeguro.set('metasPopupAtivo', isAtivo);
    
    if (isAtivo) {
        preencherSelectsMetas();
    }
}

function preencherSelectsMetas() {
    const selectMotivo = document.getElementById('metaMotivo');
    const selectTempo = document.getElementById('metaTempo');
    
    selectMotivo.innerHTML = '';
    selectTempo.innerHTML = '';
    
    motivos.forEach(motivo => {
        const option = document.createElement('option');
        option.value = motivo;
        option.textContent = motivo;
        selectMotivo.appendChild(option);
    });
    
    tempos.sort((a,b) => a-b).forEach(tempo => {
        const option = document.createElement('option');
        option.value = tempo;
        option.textContent = `${tempo} min`;
        selectTempo.appendChild(option);
    });
    
    if (motivos.length > 0) selectMotivo.value = motivos[0];
    if (tempos.length > 0) selectTempo.value = tempos[0];
}

function adicionarMeta() {
    const motivo = document.getElementById('metaMotivo').value;
    const tempo = document.getElementById('metaTempo').value;
    
    if (!motivo || !tempo) {
        showModal({ text: "Selecione um motivo e um tempo para criar uma meta.", onConfirm: () => {} });
        return;
    }
    
    const novaMeta = {
        id: Date.now(),
        motivo: motivo,
        tempo: parseInt(tempo),
        concluida: false,
        totalSessoes: 1,
        sessoesConcluidas: 0,
        dataCriacao: new Date().toISOString()
    };
    
    metas.push(novaMeta);
    StorageSeguro.set('metas', metas);
    renderMetas();
}

function renderMetas() {
    const container = document.getElementById('listaMetas');
    container.innerHTML = '';
    
    if (metas.length === 0) {
        container.innerHTML = '<div style="padding: 10px; text-align: center; color: var(--text-secondary); font-size: 11px;">Nenhuma meta definida ainda.</div>';
        return;
    }
    
    metas.forEach((meta, index) => {
        const metaElement = document.createElement('div');
        metaElement.className = 'todo-item';
        metaElement.style.borderLeft = `4px solid ${meta.concluida ? '#4caf50' : '#ff9800'}`;
        
        const progressoPercent = meta.totalSessoes > 0 ? Math.round((meta.sessoesConcluidas / meta.totalSessoes) * 100) : 0;
        
        metaElement.innerHTML = `
            <div style="flex: 1;">
                <div style="font-size: 11px; font-weight: bold; color: ${meta.concluida ? '#4caf50' : 'var(--text-main)'};">
                    ${meta.motivo} - ${meta.tempo} min
                </div>
                <div style="font-size: 10px; color: var(--text-secondary); margin-top: 2px;">
                    ${meta.sessoesConcluidas}/${meta.totalSessoes} sess√µes conclu√≠das
                </div>
                ${meta.totalSessoes > 0 ? `
                    <div style="margin-top: 3px; height: 4px; background: var(--bg-body); border-radius: 2px; overflow: hidden;">
                        <div style="height: 100%; width: ${progressoPercent}%; background: ${meta.concluida ? '#4caf50' : '#ff9800'};"></div>
                    </div>
                ` : ''}
            </div>
            <div style="display: flex; gap: 5px;">
                <button onclick="concluirMeta(${index})" style="min-width: 24px; min-height: 24px; padding: 0; background: ${meta.concluida ? '#4caf50' : '#666'}; font-size: 10px; border-radius: 50px !important; ">‚úì</button>
                <button onclick="removerMeta(${index})" style="min-width: 24px; min-height: 24px; padding: 0; background: #ff5252; font-size: 10px; border-radius: 50px !important; ">√ó</button>
            </div>
        `;
        
        container.appendChild(metaElement);
    });
}

function concluirMeta(index) {
    metas[index].concluida = !metas[index].concluida;
    StorageSeguro.set('metas', metas);
    renderMetas();
}

function removerMeta(index) {
    showModal({
        text: "Tem certeza que deseja excluir esta meta?",
        onConfirm: () => {
            metas.splice(index, 1);
            StorageSeguro.set('metas', metas);
            renderMetas();
        }
    });
}

function verificarMetasConcluidas(motivo, tempo) {
    metas.forEach((meta, index) => {
        if (!meta.concluida && meta.motivo === motivo && meta.tempo === tempo) {
            metas[index].sessoesConcluidas += 1;
            
            if (metas[index].sessoesConcluidas >= metas[index].totalSessoes) {
                metas[index].concluida = true;
                
                // Habilidade Macaco: +10 moedas ao concluir metas
                let bonusMeta = 0;
                if (petsComprados.some(p => p.icone === 'üêí')) {
                    bonusMeta = 10;
                    updateMoedas(bonusMeta);
                }
                
                const mensagemBonus = bonusMeta > 0 ? `<br><br>üêí Macaco te deu +${bonusMeta} moedas!` : '';
                showModal({
                    text: `üéâ Meta conclu√≠da!<br><br>Voc√™ completou ${meta.totalSessoes} sess√£o(√µes) de ${motivo} por ${tempo} minutos!${mensagemBonus}`,
                    onConfirm: () => {}
                });
            }
        }
    });
}

function verificarMetasFundoMar(motivo, tempo) {
    if (!modoFundoMar) return;
    // Normalizar strings para compara√ß√£o
    const motivoNormalizado = motivo.trim();
    const tempoNormalizado = parseInt(tempo);
    // Verificar se alguma meta foi cumprida
    METAS_FUNDO_MAR.forEach(meta => {
        // Se a meta j√° foi conclu√≠da, pular
        if (fundoMarMetasConcluidas.includes(meta.id)) return;
        // Verificar se o motivo e tempo correspondem √† meta
        if (meta.motivo === motivoNormalizado && meta.tempo === tempoNormalizado) {
            // Meta conclu√≠da!
            fundoMarMetasConcluidas.push(meta.id);
           
            mostrarCartaFundoMar(meta);
            // Atualizar painel de metas
            renderMetasFundoMar();
        }
    });
}
function melhorarAcessibilidade() {
    const botoes = document.querySelectorAll('button:not([aria-label])');
    botoes.forEach(botao => {
        const texto = botao.textContent || botao.innerHTML;
        if (texto.trim() && !botao.getAttribute('aria-label')) {
            botao.setAttribute('aria-label', texto.replace(/[^a-zA-Z√Ä-√ø0-9\s]/g, ' ').trim());
        }
    });
    
    document.getElementById('abrirMenuBtn').setAttribute('aria-label', 'Abrir menu');
    document.getElementById('btnTema').setAttribute('aria-label', 'Alternar tema claro/escuro');
    
    document.querySelectorAll('.plot').forEach((plot, i) => {
        if (!plot.getAttribute('aria-label')) {
            const item = jardimData[i];
            if (item) {
                plot.setAttribute('aria-label', `Planta: ${item.icone}, Motivo: ${item.motivo}`);
            } else {
                plot.setAttribute('aria-label', `Espa√ßo vazio ${i+1}, clique para plantar`);
            }
        }
    });
}
// ==========================================
// SISTEMA DE PETS 3D - VERS√ÉO FINAL COM NOMES
// ==========================================

function processarCompraPet(icone, preco, btnId) {
    const precoFinal = calcularPrecoFinal(preco, null, icone);
    const animaisMarinhos = ['üêã', 'üê†', 'üêü', 'üê°', 'üêô', 'ü¶≠', 'üê¢', 'ü¶¶', 'üßú‚Äç‚ôÇÔ∏è', 'üßú‚Äç‚ôÄÔ∏è'];
    
    // Bloqueio de Animais Aqu√°ticos por Metas
    const animaisBloqueadosPorMeta = ['üêü', 'üê†', 'üê°', 'üêô', 'üê¢', 'ü¶¶', 'üßú‚Äç‚ôÄÔ∏è', 'üßú‚Äç‚ôÇÔ∏è', 'ü¶≠', 'üêã'];
    if (animaisBloqueadosPorMeta.includes(icone)) {
        const metaRelacionada = METAS_FUNDO_MAR.find(m => m.petGratis === icone || (m.escolhaEspecial && (icone === 'üßú‚Äç‚ôÄÔ∏è' || icone === 'üßú‚Äç‚ôÇÔ∏è')));
        if (metaRelacionada && !fundoMarMetasConcluidas.includes(metaRelacionada.id)) {
            showModal({ text: "üîí <strong>Animal Bloqueado!</strong><br>Este animal s√≥ pode ser adotado ap√≥s cumprir a meta correspondente no Fundo do Mar.", onConfirm: () => {} });
            return;
        }
        // Bloqueio extra para o guia n√£o escolhido
        if (metaRelacionada && metaRelacionada.escolhaEspecial && icone !== guiaEscolhidoFundoMar) {
            showModal({ text: "üîí <strong>Acesso Negado!</strong><br>Voc√™ j√° escolheu outro guia para esta jornada.", onConfirm: () => {} });
            return;
        }
    }
    const isMarinho = animaisMarinhos.includes(icone);

    // O limite de 2 animais s√≥ se aplica a animais terrestres
    if (!isMarinho && petsComprados.filter(p => !animaisMarinhos.includes(p.icone)).length >= LIMITE_PETS) {
        showModal({ text: "üö® <strong>Limite atingido!</strong><br>Voc√™ s√≥ pode ter 2 animais terrestres.", onConfirm: () => {} });
        return;
    }
    if (petsComprados.some(p => p.icone === icone)) {
        showModal({ text: "Voc√™ j√° adotou um desse!", onConfirm: () => {} });
        return;
    }

    if (totalMoedas >= precoFinal) {
        // Criar o pop-up de nome manualmente
        const overlay = document.createElement('div');
        overlay.id = "petPopupOverlay";
        overlay.style = "position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:19999; display:flex; align-items:center; justify-content:center;";
        
        const popup = document.createElement('div');
        popup.className = "pet-name-popup";
        popup.innerHTML = `
            <div style="font-size:40px">${icone}</div>
            <h3>Nome do Pet</h3>
            <input type="text" id="tempPetName" placeholder="Ex: Tot√≥" maxlength="12">
            <button style="border-radius: 50px !important;" id="btnConfirmarPet">Adotar</button>
        `;
        
        overlay.appendChild(popup);
        document.body.appendChild(overlay);

        // Focar no input automaticamente
        const input = document.getElementById('tempPetName');
        input.focus();

        // L√≥gica ao clicar no bot√£o confirmar
        document.getElementById('btnConfirmarPet').onclick = () => {
            const nomeDigitado = input.value.trim();
            const nomeFinal = nomeDigitado !== "" ? nomeDigitado : "Bichinho";
            
            // Finalizar Compra - Verifica√ß√£o final de saldo
            if (totalMoedas >= precoFinal) {
                updateMoedas(-precoFinal);
                const novoPet = { icone: icone, nome: nomeFinal };
                petsComprados.push(novoPet);
                StorageSeguro.set('petsComprados', petsComprados);
                
                setLuckyPlant(); // Atualiza visibilidade da sorte (Girafa)
                adicionarPetNaCena(novoPet);
                verificarBotoesPetsLoja();
                
                // Fechar e avisar
                document.body.removeChild(overlay);
                showModal({ text: `üéâ <strong>${nomeFinal}</strong> foi adotado!`, onConfirm: () => {} });
            } else {
                document.body.removeChild(overlay);
                showModal({ text: "Moedas insuficientes!", onConfirm: () => {} });
            }
        };

        // Fechar ao clicar fora (opcional)
        overlay.onclick = (e) => {
            if(e.target === overlay) document.body.removeChild(overlay);
        };
    } else {
        showModal({ text: "Moedas insuficientes.", onConfirm: () => {} });
    }
}

function moverPetsLoop() {
    let mudouAlgo = false;
    const gridSize = getGridSize();
    const animaisMarinhos = ['üêã', 'üê†', 'üêü', 'üê°', 'üêô', 'ü¶≠', 'üê¢', 'ü¶¶', 'üßú‚Äç‚ôÇÔ∏è', 'üßú‚Äç‚ôÄÔ∏è'];
    
    petsEmCena.forEach(pet => {
        const isMarinho = animaisMarinhos.includes(pet.icone);

        // L√≥gica de permiss√£o de movimento: Pets e c√¥njuge se movem em qualquer modo
        // Removida a restri√ß√£o que impedia marinhos de se moverem na terra ou terrestres no mar

        if (pet.pausado) return;
        
        if (Math.random() > 0.3) {
            const vizinhos = [];
            const x = pet.index % gridSize;
            const y = Math.floor(pet.index / gridSize);

            if (y > 0) vizinhos.push(pet.index - gridSize);
            if (y < gridSize - 1) vizinhos.push(pet.index + gridSize);
            if (x > 0) vizinhos.push(pet.index - 1);
            if (x < gridSize - 1) vizinhos.push(pet.index + 1);

            const vizinhosLivres = vizinhos.filter(idx => {
                const temPlanta = jardimData[idx] !== null;
                const temOutroPet = petsEmCena.some(p => p.index === idx);
                const temTesouro = (typeof tesouroAtivoIndex !== 'undefined') && (idx === tesouroAtivoIndex);
                return !temPlanta && !temOutroPet && !temTesouro;
            });

            if (vizinhosLivres.length > 0) {
                const novoIndex = vizinhosLivres[Math.floor(Math.random() * vizinhosLivres.length)];
                pet.index = novoIndex;
                mudouAlgo = true;
            }
        }
    });

    if (mudouAlgo) {
        renderJardim();
    }
}



// Habilidade Vaquinha: Produ√ß√£o passiva de moedas
function iniciarProducaoVaquinha() {
    // Limpar intervalo anterior se existir
    if (intervaloVaquinha) {
        clearInterval(intervaloVaquinha);
        intervaloVaquinha = null;
    }
    
    // Verificar se tem vaquinha
    if (petsComprados.some(p => p.icone === 'üêÑ')) {
        // Produz 5 moedas a cada hora (3600000 ms)
        intervaloVaquinha = setInterval(() => {
            if (petsComprados.some(p => p.icone === 'üêÑ')) {
                updateMoedas(5);
                showToast('üêÑ', 'Vaquinha produziu!', '+5 moedas');
            }
        }, 3600000); // 1 hora
    }
}

function inicializarPets() {
    // Limpa a cena antes de carregar (evita duplicados)
    petsEmCena = [];
    
    // Carrega do storage
    const salvos = StorageSeguro.get('petsComprados', []);
    petsComprados = salvos;

    petsComprados.forEach(petObj => {
        adicionarPetNaCena(petObj);
    });

    // Inicia o movimento se estiver no modo 3D
    if (!intervaloPets) {
        intervaloPets = setInterval(moverPetsLoop, 3000);
    }
    
    // Habilidade Vaquinha: Produz 5 moedas a cada hora
    iniciarProducaoVaquinha();
    
    verificarBotoesPetsLoja();
}

function adicionarPetNaCena(petObj) {
    const totalCells = getTotalCells();
    // Tenta achar um lugar vazio
    for(let i=0; i<30; i++) {
        const randIndex = Math.floor(Math.random() * totalCells);
        
        // Corre√ß√£o: Adicionado '&& randIndex !== tesouroAtivoIndex' para n√£o nascer no tesouro
        if (!jardimData[randIndex] && !petsEmCena.some(p => p.index === randIndex) && randIndex !== tesouroAtivoIndex) {
            // Insere o objeto com nome e √≠cone na cena
            petsEmCena.push({ ...petObj, index: randIndex });
            renderJardim3D();
            break;
        }
    }
}

function salvarNovoNomeAuto() {
    const input = document.getElementById('configNomeUsuario');
    const novoNome = input.value.trim();
    
    if (novoNome !== "") {
        StorageSeguro.set('jogadorNome', novoNome);
        
        // Atualiza a sauda√ß√£o na aba lateral instantaneamente
        const saudacao = document.getElementById('saudacaoUsuario');
        if (saudacao) saudacao.innerHTML = `Ol√°, ${novoNome}!`;
    }
}

function abandonarPet(icone) {
    const pet = petsComprados.find(p => p.icone === icone);
    if (!pet) return;

    showModal({
        text: `üò¢ Deseja realmente abandonar o(a) <strong>${pet.nome}</strong> (${pet.icone})?<br><br>Ele(a) sentir√° sua falta!`,
        onConfirm: () => {
            // Remove do array de comprados
            petsComprados = petsComprados.filter(p => p.icone !== icone);
            StorageSeguro.set('petsComprados', petsComprados);
            
            // Remove da cena (jardim)
            petsEmCena = petsEmCena.filter(p => p.icone !== icone);
            
            // Atualiza interface
            renderJardim3D();
            verificarBotoesPetsLoja();
            setLuckyPlant();
            
            showModal({ text: "O animal de estima√ß√£o foi embora. üçÉ", onConfirm: () => {} });
        }
    });
}function verificarBotoesPetsLoja() {
    // Atualizar saldo na loja imediatamente
    const saldoLoja = document.getElementById('saldoLojaMoedas');
    if (saldoLoja) saldoLoja.textContent = totalMoedas;

    // IDs dos bot√µes da loja
    const ids = [
        { id: 'btnPetDuck1', preco: 50, icone: 'ü¶Ü' },
        { id: 'btnPetGoose', preco: 60, icone: 'ü™ø' },
        { id: 'btnPetDog1', preco: 80, icone: 'üêï' },
        { id: 'btnPetCat1', preco: 80, icone: 'üêà' },
        { id: 'btnPetPig', preco: 100, icone: 'üêñ' },
        { id: 'btnPetOwl', preco: 120, icone: 'ü¶â' },
        { id: 'btnPetBeaver', preco: 130, icone: 'ü¶´' },
        { id: 'btnPetMonkey', preco: 150, icone: 'üêí' },
        { id: 'btnPetLlama', preco: 160, icone: 'ü¶ô' },
        { id: 'btnPetCow', preco: 180, icone: 'üêÑ' },
        { id: 'btnPetPeacock', preco: 200, icone: 'ü¶ö' },
        { id: 'btnPetLeopard', preco: 220, icone: 'üêÜ' },
        { id: 'btnPetGiraffe', preco: 250, icone: 'ü¶í' },
        { id: 'btnPetReindeer', preco: 150, icone: 'ü¶å' },
        { id: 'btnPetWhale', preco: 200, icone: 'üêã' },
        { id: 'btnPetTropicalFish', preco: 60, icone: 'üê†' },
        { id: 'btnPetFish', preco: 40, icone: 'üêü' },
        { id: 'btnPetBlowfish', preco: 80, icone: 'üê°' },
        { id: 'btnPetOctopus', preco: 120, icone: 'üêô' },
        { id: 'btnPetSeal', preco: 150, icone: 'ü¶≠' },
        { id: 'btnPetTurtle', preco: 100, icone: 'üê¢' },
        { id: 'btnPetOtter', preco: 120, icone: 'ü¶¶' },
        { id: 'btnPetMermaid', preco: 200, icone: 'üßú‚Äç‚ôÄÔ∏è' },
        { id: 'btnPetMerman', preco: 200, icone: 'üßú‚Äç‚ôÇÔ∏è' }
    ];
    
    const iconesAdotados = petsComprados.map(p => p.icone);
    const temPorquinho = iconesAdotados.includes('üêñ');

    // Controle de visibilidade da Rena (S√≥ aparece no Modo Natal)
    const itemLojaRena = document.getElementById('itemLojaRena');
    if (itemLojaRena) {
        itemLojaRena.style.display = modoNatal ? 'block' : 'none';
    }

    // Mostrar/Ocultar se√ß√£o de pets do Fundo do Mar
    const secaoFundoMar = document.getElementById('secaoPetsFundoMar');
    const tituloSecao = document.getElementById('tituloSecaoPets');
    
    if (secaoFundoMar) {
        secaoFundoMar.style.display = fundoMarComprado ? 'contents' : 'none';
    }

    // Ajustar t√≠tulo da se√ß√£o conforme o modo
    if (tituloSecao) {
        if (modoFundoMar) {
            tituloSecao.innerHTML = "üåä Fauna Marinha (Sem Limite de Ado√ß√£o)";
        } else {
            tituloSecao.innerHTML = "üìè Licen√ßa de Ado√ß√£o (Terrestres M√°x: 2 | Aqu√°ticos: Sem Limite)";
        }
    }

    ids.forEach(item => {
        const btn = document.getElementById(item.id);
        if (!btn) return;

        const container = btn.parentElement;

        // NOVA REGRA: Animais terrestres N√ÉO aparecem na loja no modo Fundo do Mar
        const animaisMarinhos = ['üêã', 'üê†', 'üêü', 'üê°', 'üêô', 'ü¶≠', 'üê¢', 'ü¶¶', 'üßú‚Äç‚ôÇÔ∏è', 'üßú‚Äç‚ôÄÔ∏è'];
        const isMarinho = animaisMarinhos.includes(item.icone);
        
        if (modoFundoMar) {
            // No modo aqu√°tico: MOSTRA marinhos, OCULTA terrestres
            if (!isMarinho) {
                container.style.display = "none";
                return;
            }
        } else {
            // Em QUALQUER outro modo (Normal, Natal, Medieval, etc.): MOSTRA terrestres, OCULTA marinhos
            if (isMarinho) {
                container.style.display = "none";
                return;
            }
            
            // Regra espec√≠fica para a Rena: Apenas no modo Natal
            if (item.icone === 'ü¶å' && !modoNatal) {
                container.style.display = "none";
                return;
            }
        }
        
        // Garantir que o container esteja vis√≠vel se passou pelos filtros
        container.style.display = "block";

        // Regra de exclusividade Sereia/Trit√£o
        if (fundoMarMetasConcluidas.includes(7)) {
            if ((item.icone === 'üßú‚Äç‚ôÄÔ∏è' || item.icone === 'üßú‚Äç‚ôÇÔ∏è') && item.icone !== guiaEscolhidoFundoMar) {
                container.style.display = "none";
                return;
            }
        }

        // Se passou pelos filtros acima, garante que o container esteja vis√≠vel antes de checar se j√° foi adotado
        container.style.display = "block";

        const jaAdotado = iconesAdotados.includes(item.icone);

        if (jaAdotado) {
            btn.style.display = "none";
            // Remove bot√£o de abandonar anterior se existir para evitar duplicados
            const btnAbandonarAntigo = container.querySelector('.btn-abandonar-pet');
            if (btnAbandonarAntigo) btnAbandonarAntigo.remove();

            const btnAbandonar = document.createElement('button');
            btnAbandonar.textContent = "Abandonar";
            btnAbandonar.className = "btn-abandonar-pet";
            btnAbandonar.style.backgroundColor = "#e74c3c";
            btnAbandonar.style.marginTop = "10px";
            btnAbandonar.style.width = "100%";
            btnAbandonar.onclick = () => abandonarPet(item.icone);
            container.appendChild(btnAbandonar);
        } else {
            btn.style.display = "block";
            // Atualizar Pre√ßo com Desconto usando a fun√ß√£o unificada
            const precoFinal = calcularPrecoFinal(item.preco, null, item.icone);
            const animaisBloqueadosPorMeta = ['üêü', 'üê†', 'üê°', 'üêô', 'üê¢', 'ü¶¶', 'üßú‚Äç‚ôÄÔ∏è', 'üßú‚Äç‚ôÇÔ∏è', 'ü¶≠', 'üêã'];
            if (animaisBloqueadosPorMeta.includes(item.icone) && precoFinal > 0) {
                btn.innerHTML = `BLOQUEADO üîí`;
                btn.style.color = "#e74c3c";
                btn.style.fontWeight = "bold";
                btn.disabled = true;
                btn.style.opacity = "0.6";
                btn.style.cursor = "not-allowed";
            } else if (precoFinal === 0 && item.preco > 0) {
                btn.innerHTML = `RESGATAR üéÅ`;
                btn.style.color = "#4caf50";
                btn.style.fontWeight = "bold";
                btn.disabled = false;
                btn.style.opacity = "1";
                btn.style.cursor = "pointer";
            } else if (precoFinal < item.preco) {
                btn.innerHTML = `<span style="text-decoration: line-through; opacity: 0.6; font-size: 0.8em;">${item.preco}</span> ${precoFinal} üí∞`;
                btn.style.color = "#4caf50";
                btn.style.fontWeight = "bold";
            } else {
                btn.innerHTML = `${item.preco} üí∞`;
                btn.style.color = "";
                btn.style.fontWeight = "";
            }
            
            const btnAbandonarAntigo = container.querySelector('.btn-abandonar-pet');
            if (btnAbandonarAntigo) btnAbandonarAntigo.remove();
        }
    });

    // Atualizar Pre√ßos dos Temas (Medieval, Candyfornia, Eurosummer e Fundo do Mar)
    const temas = [
        { id: 'btnComprarMedieval', preco: 50, key: 'medieval', comprado: medievalComprado },
        { id: 'btnComprarCandyfornia', preco: 80, key: 'candyfornia', comprado: candyforniaComprado },
        { id: 'btnComprarEurosummer', preco: 100, key: 'eurosummer', comprado: eurosummerComprado },
        { id: 'btnComprarFundoMar', preco: 120, key: 'fundomar', comprado: fundoMarComprado }
    ];
    
    const temCastor = iconesAdotados.includes('ü¶´');
    
    temas.forEach(tema => {
        const btn = document.getElementById(tema.id);
        if (!btn) return;
        
        if (tema.comprado) {
            btn.textContent = "J√° Adquirido";
            btn.disabled = true;
            btn.style.color = "";
            btn.style.fontWeight = "";
            btn.style.opacity = "0.7";
        } else {
            btn.disabled = false;
            btn.style.opacity = "1";
            const precoFinal = calcularPrecoFinal(tema.preco, tema.key);
            
            if (precoFinal < tema.preco) {
                btn.innerHTML = `<span style="text-decoration: line-through; opacity: 0.6; font-size: 0.8em;">${tema.preco}</span> ${precoFinal} üí∞`;
                btn.style.color = "#4caf50";
                btn.style.fontWeight = "bold";
            } else {
                btn.innerHTML = `${tema.preco} üí∞`;
                btn.style.color = "";
                btn.style.fontWeight = "";
            }
        }
    });
}


function atualizarBotoesConfig() {
    const btnSino = document.getElementById('btnSino');
    if (btnSino) {
        btnSino.classList.toggle('on', sinoAtivo);
    }

    const btnTemaAuto = document.getElementById('btnTemaAuto');
    if (btnTemaAuto) {
        btnTemaAuto.classList.toggle('on', temaAutomaticoAtivo);
    }

    const btnNatal = document.getElementById('btnNatal');
    if (btnNatal) {
        btnNatal.classList.toggle('on', modoNatal);
    }

    const btnMedieval = document.getElementById('btnMedievalLoja');
    if (btnMedieval) {
        btnMedieval.classList.toggle('on', modoMedieval);
    }

    const btnCandyfornia = document.getElementById('btnCandyforniaLoja');
    if (btnCandyfornia) {
        btnCandyfornia.classList.toggle('on', modoCandyfornia);
    }

    const btnEstrelas = document.getElementById('btnEstrelas');
    if (btnEstrelas) {
        btnEstrelas.classList.toggle('on', exibirEstrelas);
    }

    const btnAnimFundo = document.getElementById('btnAnimFundo');
    if (btnAnimFundo) {
        btnAnimFundo.classList.toggle('on', animacaoFundoAtiva);
    }

    const btnPrevisao = document.getElementById('btnPrevisao');
    if (btnPrevisao) {
        btnPrevisao.classList.toggle('on', mostrarPrevisao);
    }



    // Atualizar os bot√µes da se√ß√£o Visualiza√ß√£o
    const btn3D = document.getElementById('btn3DToggle');
    if (btn3D) {
        btn3D.classList.toggle('on', modo3D);
    }

    const btnGrid10x10 = document.getElementById('btnGrid10x10Toggle');
    if (btnGrid10x10) {
        btnGrid10x10.classList.toggle('on', grid10x10);
    }
}
// =========================
// M√ìDULO: ROMANCE MANAGER (ATUALIZADO COM DI√ÅLOGOS)
// =========================
const RomanceManager = {
    data: {
        ativo: false,
        parceiroIcone: null,
        pontos: 0,
        namorando: false,
        casado: false,
        ultimoCarinhoRomantico: 0,
        perolas: 0
    },

    // Banco de Falas
    quotes: {
        0: [ // Desconhecido (0-19 pts)
            "Gratid√£o por me ajudar a restaurar este lugar.",
            "Quem √© voc√™, viajante da superf√≠cie?",
            "Nunca vi ningu√©m como voc√™ por aqui antes.",
            "Como voc√™ se chama mesmo?",
            "Ainda estou me acostumando com sua presen√ßa."
        ],
        1: [ // Conhecido (20-39 pts)
            "Como √© o mundo l√° em cima? √â muito seco?",
            "Ouvi dizer que existe uma esp√©cie de peixe no c√©u... p√°ssaros?",
            "Voc√™ trabalha muito bem nesse jardim.",
            "Gosto quando voc√™ vem me visitar.",
            "As correntes mar√≠timas trazem boas not√≠cias sobre voc√™."
        ],
        2: [ // Colega/Amigo Distante (40-59 pts)
            "Estou come√ßando a entender seus costumes estranhos.",
            "Voc√™ √© diferente dos outros humanos das lendas.",
            "Sinto que posso confiar em voc√™.",
            "As flores do seu jardim s√£o coloridas como nossos corais?",
            "Hoje o mar parece mais brilhante com voc√™ aqui."
        ],
        3: [ // Amigo Pr√≥ximo (60-79 pts)
            "Voc√™ deve estar ansioso para voltar pro seu jardim...",
            "Sua companhia √© o melhor tesouro que encontrei nestas ru√≠nas.",
            "√Äs vezes, subo at√© a superf√≠cie s√≥ para ver se te encontro.",
            "Gostaria de te mostrar os recifes profundos um dia.",
            "Nossos mundos s√£o distantes, mas n√≥s estamos perto.",
            "J√° fugi de diversos predadores apenas com a for√ßa da minha mente... voc√™ tem isso?"
        ],
        4: [ // Namorado (80-99 pts)
            "Meu bem, quando acabarem suas obriga√ß√µes por aqui... como ficar√° nossa rela√ß√£o?",
            "Vou sentir sua falta a cada segundo que estiver em terra firme.",
            "Eu te amo mais do que todas as p√©rolas do oceano.",
            "N√£o v√° embora ainda... fique mais um pouco.",
            "O mar fica cinza e frio sem o seu sorriso."
        ],
        5: [ // Noivo (100 pts - Antes de casar)
            "Descobri que posso viver contigo na terra! Conversei com uma bruxa do mar que permitir√° isso!",
            "N√£o quero mais que o mar nos separe.",
            "Aceitaria unir nossos mundos para sempre?",
            "Tenho um segredo... encontrei uma forma de ficarmos juntos.",
            "Meu cora√ß√£o bate no ritmo das mar√©s por ti."
        ],
        married: [ // Casado
            "N√£o perdi a voz, mas n√£o ganhei pernas. Pelo menos gosto dessa bolha flutuante!",
            "Adoro ver as estrelas do seu jardim contigo, meu amor.",
            "A vida na terra √© estranha, mas perfeita ao seu lado.",
            "Sinto falta do mar, mas voc√™ √© meu lar agora.",
            "Olha! Aprendi a regar as plantas sem afog√°-las!",
            "Descobri que consigo mover plantas de lugar assim como eu fazia com tubar√µes"
        ]
    },

    init: function() {
        const savedData = StorageSeguro.get('romanceData', null);
        const guia = StorageSeguro.get('guiaEscolhidoFundoMar', null);

        if (savedData) {
            this.data = Object.assign({}, this.data, savedData);
            // Sincroniza o guia caso tenha mudado na hist√≥ria
            if (guia) this.data.parceiroIcone = guia;
        } else {
            this.data.ativo = !!guia;
            this.data.parceiroIcone = guia;
            this.save();
        }
        this.injectHtml();
    },

    // Define o parceiro e ativa imediatamente
    setPartner: function(icone) {
        this.data.parceiroIcone = icone;
        this.data.ativo = true;
        this.save();
    },

    reset: function() {
        this.data = {
            ativo: false,
            parceiroIcone: null,
            pontos: 0,
            namorando: false,
            casado: false,
            ultimoCarinhoRomantico: 0,
            perolas: 0,
            telepatiaDisponivel: false
        };
        this.save();
    },

    save: function() {
        StorageSeguro.set('romanceData', this.data);
    },

    injectHtml: function() {
        if (document.getElementById('romanceOverlay')) return;
        const overlay = document.createElement('div');
        overlay.id = 'romanceOverlay';
        overlay.innerHTML = `
            <div class="romance-card">
                <div class="romance-backpack" id="romanceBackpack">
                    üîÆ <span id="perolaCount">0</span>
                </div>
                <button onclick="RomanceManager.closeMenu()" class="close-btn" style="top:10px; right:10px; border-radius: 50px !important;">√ó</button>
                <div id="romanceAvatar" class="romance-avatar"></div>
                <h3 id="romanceTitle" style="color:#ff4757; margin:0; font-size: 22px; font-weight: bold;"></h3>
                <small id="romanceStatus" style="color:#666; font-weight:bold; display:block; margin-top:5px; font-size: 14px;"></small>
                
                <div class="romance-hearts" id="romanceHearts"></div>

                <div id="romanceDialogue" class="romance-dialogue-box">
                    "..."
                </div>

                <div class="romance-actions">
                    <button style="border-radius: 50px !important;" class="btn-romance" onclick="RomanceManager.darCarinho()">
                        üíô <span>Carinho</span><small style="font-size:9px">+5 pts (Di√°rio)</small>
                    </button>
                    <button style="border-radius: 50px !important;" class="btn-romance" onclick="RomanceManager.darPresente()">
                        üéÅ <span>Presentear</span><small style="font-size:9px">Usa 1 P√©rola</small>
                    </button>
                    <button id="btnTelepatia" class="btn-romance" onclick="RomanceManager.toggleTelepatia()" style="display:none; grid-column: span 2; background: #e0f7fa; border-color: #4cc9f0; border-radius: 50px !important; ">
                        üåÄ <span>Telepatia</span><small style="font-size:9px">Mover Plantas</small>
                    </button>
                    <button id="btnNamoro" class="btn-romance btn-namoro" onclick="RomanceManager.pedirEmNamoro()" style="display:none; grid-column: span 2; border-radius: 50px !important;">
                        üíñ Pedir em Namoro
                    </button>
                    <button id="btnCasar" class="btn-romance btn-casar" onclick="RomanceManager.proporCasamento()" style="display:none; border-radius: 50px !important;">
                        üíç Propor Casamento
                    </button>
                </div>
            </div>`;
        document.body.appendChild(overlay);
    },

    handlePetClick: function(pet) {
        if (!this.data.parceiroIcone || pet.icone !== this.data.parceiroIcone) return false;
        
        if (modoFundoMar || this.data.casado) {
            this.openMenu();
            return true;
        }
        return false;
    },

    shouldShowPartnerOnLand: function(petIcone) {
        return this.data.casado && petIcone === this.data.parceiroIcone;
    },

    // L√≥gica dos t√≠tulos evolutivos
    getRelationshipLevel: function() {
        if (this.data.casado) return 'married';
        // Se n√£o estiver namorando, o n√≠vel trava em 3 (Amigo)
        if (!this.data.namorando) return Math.min(Math.floor(this.data.pontos / 20), 3);
        // Mapeia pontos (0-100) para n√≠veis (0-5)
        return Math.min(Math.floor(this.data.pontos / 20), 5);
    },

    getRelationshipTitle: function(level, icone) {
        const isFemale = icone === 'üßú‚Äç‚ôÄÔ∏è';
        
        const titles = {
            0: isFemale ? "Desconhecida" : "Desconhecido",
            1: isFemale ? "Conhecida" : "Conhecido",
            2: "Colega",
            3: isFemale ? "Amiga" : "Amigo",
            4: isFemale ? "Namorada" : "Namorado",
            5: isFemale ? "Noiva" : "Noivo"
        };
        
        if (this.data.casado) {
            return isFemale ? "Esposa" : "Marido";
        }

        return titles[level] || (isFemale ? "Desconhecida" : "Desconhecido");
    },

    getRandomQuote: function(level) {
        const possibleQuotes = this.quotes[level] || this.quotes[0];
        const randomIndex = Math.floor(Math.random() * possibleQuotes.length);
        return `"${possibleQuotes[randomIndex]}"`;
    },

    openMenu: function() {
        const overlay = document.getElementById('romanceOverlay');
        const avatar = document.getElementById('romanceAvatar');
        const titulo = document.getElementById('romanceTitle');
        const status = document.getElementById('romanceStatus');
        const dialogue = document.getElementById('romanceDialogue');
        const heartsContainer = document.getElementById('romanceHearts');
        const btnCasar = document.getElementById('btnCasar');
        const btnNamoro = document.getElementById('btnNamoro');
        const perolaCount = document.getElementById('perolaCount');

        // Atualizar Invent√°rio
        if (perolaCount) perolaCount.textContent = this.data.perolas || 0;

        // Calcular N√≠vel
        const level = this.getRelationshipLevel();
        let coracoesCheios = this.data.casado ? 5 : Math.floor(this.data.pontos / 20);
        
        // Se n√£o estiver namorando, trava em 3 cora√ß√µes (Amigo)
        if (!this.data.namorando && !this.data.casado) {
            coracoesCheios = Math.min(coracoesCheios, 3);
        }

        // Configurar Avatar e Nome
        avatar.textContent = this.data.parceiroIcone;
        const petInfo = petsComprados.find(p => p.icone === this.data.parceiroIcone);
        const nomeReal = petInfo ? petInfo.nome : (this.data.parceiroIcone === 'üßú‚Äç‚ôÄÔ∏è' ? "Sereia" : "Trit√£o");
        titulo.textContent = nomeReal;
        
        // Configurar T√≠tulo da Rela√ß√£o
        status.textContent = this.getRelationshipTitle(this.data.casado ? 'married' : coracoesCheios, this.data.parceiroIcone);

        // Configurar Frase do Dia (Aleat√≥ria baseada no n√≠vel)
        dialogue.textContent = this.getRandomQuote(level);

        // Renderizar Cora√ß√µes
        heartsContainer.innerHTML = '';
        for(let i=0; i<5; i++) {
            const h = document.createElement('span');
            h.className = `heart-slot ${i < coracoesCheios ? 'filled' : ''}`;
            h.textContent = '‚ù§';
            heartsContainer.appendChild(h);
        }

        // Bot√£o Namoro (Aparece se tiver 79 pontos e n√£o estiver namorando)
        if (btnNamoro) {
            btnNamoro.style.display = (this.data.pontos >= 79 && !this.data.namorando && !this.data.casado) ? 'block' : 'none';
        }

        // Bot√£o Casar (Aparece se tiver 100 pontos e estiver namorando e n√£o for casado)
        if (btnCasar) {
            btnCasar.style.display = (this.data.pontos >= 100 && this.data.namorando && !this.data.casado) ? 'block' : 'none';
        }

        // Bot√£o Telepatia (Aparece apenas se for casado e dispon√≠vel)
        const btnTelepatia = document.getElementById('btnTelepatia');
        if (btnTelepatia) {
            btnTelepatia.style.display = this.data.casado ? 'flex' : 'none';
            
            if (!this.data.telepatiaDisponivel) {
                btnTelepatia.style.opacity = '0.5';
                btnTelepatia.style.filter = 'grayscale(1)';
                btnTelepatia.querySelector('small').textContent = 'Foque para carregar';
                btnTelepatia.onclick = () => showToast('‚è≥', 'Habilidade em recarga', 'Complete uma sess√£o de foco');
            } else {
                btnTelepatia.style.opacity = '1';
                btnTelepatia.style.filter = 'none';
                btnTelepatia.querySelector('small').textContent = 'Dispon√≠vel!';
                btnTelepatia.onclick = () => RomanceManager.toggleTelepatia();
            }

            if (this.telepatiaAtiva) {
                btnTelepatia.style.background = '#4cc9f0';
                btnTelepatia.style.color = 'white';
            } else {
                btnTelepatia.style.background = '#e0f7fa';
                btnTelepatia.style.color = '#003566';
            }
        }
        
        overlay.style.display = 'flex';
    },

    telepatiaAtiva: false,
    plantaSelecionadaIndex: null,

    toggleTelepatia: function() {
        if (!this.data.telepatiaDisponivel && !this.telepatiaAtiva) return;

        this.telepatiaAtiva = !this.telepatiaAtiva;
        this.plantaSelecionadaIndex = null;
        this.closeMenu();
        
        if (this.telepatiaAtiva) {
            this.manterToastTelepatia();
        } else {
            if (this.toastInterval) clearInterval(this.toastInterval);
            showToast('üåÄ', 'Telepatia Desativada', '');
        }
        renderJardim();
    },

    toastInterval: null,
    manterToastTelepatia: function() {
        if (this.toastInterval) clearInterval(this.toastInterval);
        
        const dispararToast = () => {
            if (!this.telepatiaAtiva) {
                clearInterval(this.toastInterval);
                return;
            }
            const msg = this.plantaSelecionadaIndex === null ? 'Clique em uma planta para mover' : 'Clique no destino vazio';
            showToast('üåÄ', 'Telepatia Ativada', msg);
        };

        dispararToast();
        this.toastInterval = setInterval(dispararToast, 5000); // Mant√©m o toast vivo a cada 5s
    },

    handleTelepatiaClick: function(index) {
        if (!this.telepatiaAtiva) return false;

        // Se j√° tem uma planta selecionada, tenta mover para o novo index
        if (this.plantaSelecionadaIndex !== null) {
            if (index === this.plantaSelecionadaIndex) {
                this.plantaSelecionadaIndex = null;
                showToast('üåÄ', 'Sele√ß√£o cancelada', '');
                renderJardim();
                return true;
            }

            // Verifica se o destino est√° vazio (sem planta e sem pet)
            const temPet = petsEmCena.some(p => p.index === index);
            if (!jardimData[index] && !temPet) {
                // Move a planta
                jardimData[index] = jardimData[this.plantaSelecionadaIndex];
                jardimData[this.plantaSelecionadaIndex] = null;
                this.plantaSelecionadaIndex = null;
                
                // Finaliza o modo
                this.telepatiaAtiva = false;
                this.data.telepatiaDisponivel = false;
                if (this.toastInterval) clearInterval(this.toastInterval);
                
                showToast('‚ú®', 'Planta movida!', 'Habilidade usada');
                this.save();
                salvarTudo();
                renderJardim();
                
                // Reabre o menu ap√≥s um pequeno delay
                setTimeout(() => this.openMenu(), 800);
            } else {
                showToast('‚ùå', 'Espa√ßo ocupado', 'Escolha um lugar vazio');
            }
            return true;
        } 
        
        // Se n√£o tem sele√ß√£o, tenta selecionar a planta no index clicado
        else {
            if (jardimData[index]) {
                // Verifica se √© planta (n√£o pet)
                const temPet = petsEmCena.some(p => p.index === index);
                if (!temPet) {
                    this.plantaSelecionadaIndex = index;
                    showToast('üåÄ', 'Planta selecionada', 'Agora clique no destino');
                    renderJardim();
                } else {
                    showToast('‚ùå', 'N√£o pode mover pets', 'Apenas plantas!');
                }
            }
            return true;
        }
    },

    closeMenu: function() {
        document.getElementById('romanceOverlay').style.display = 'none';
    },

    darCarinho: function() {
        const agora = Date.now();
        if (agora - this.data.ultimoCarinhoRomantico < 86400000) {
            showToast('‚è≥', 'Volte amanh√£', 'Carinho di√°rio j√° feito');
            return;
        }
        this.addPoints(5);
        this.data.ultimoCarinhoRomantico = agora;
        this.save();
        showToast('üíô', 'Sentiu-se amado!', '+5 Pontos');
        
        // Reabre o menu para atualizar a frase e os pontos
        this.openMenu(); 
        this.spawnHearts();
    },

    darPresente: function() {
        if (!this.data.perolas || this.data.perolas <= 0) {
            showToast('ü¶™', 'Sem P√©rolas', 'Compre na loja!');
            return;
        }
        this.data.perolas--;
        this.addPoints(10);
        this.save();
        showToast('üéÅ', 'Adorou o presente!', '+10 Pontos');
        
        // Reabre o menu para atualizar a frase e os pontos
        this.openMenu(); 
        this.spawnHearts();
    },

    addPoints: function(qtd) {
        // Se n√£o estiver namorando, os pontos travam em 79 (quase 4 cora√ß√µes - Amigo)
        if (!this.data.namorando && !this.data.casado) {
            this.data.pontos = Math.min(this.data.pontos + qtd, 79);
        } else {
            this.data.pontos = Math.min(this.data.pontos + qtd, 100);
        }
        this.save();
    },

    pedirEmNamoro: function() {
        if (!this.data.perolas || this.data.perolas <= 0) {
            this.closeMenu();
            showModal({ 
                text: "ü¶™ <strong>Falta algo...</strong><br><br>Voc√™ precisa de uma <b>P√©rola do Mar</b> para pedir em namoro. Compre uma na loja!", 
                onConfirm: () => { this.openMenu(); } 
            });
            return;
        }

        this.closeMenu();
        showModal({
            text: `üíñ <strong>O Pedido de Namoro</strong><br><br>Voc√™ oferece a P√©rola do Mar e abre seu cora√ß√£o...<br><br>"Eu aceito! Adoraria ser sua namorada(o)!"`,
            onConfirm: () => {
                this.data.perolas--;
                this.data.namorando = true;
                this.data.pontos = 80; // Desbloqueia o 4¬∫ cora√ß√£o (Namorado)
                this.save();
                this.openMenu();
                if (typeof efeitosManager !== 'undefined') efeitosManager.chuvaDeEfeitos('üíñ', 30);
            }
        });
    },

    proporCasamento: function() {
        if (!this.data.perolas || this.data.perolas <= 0) {
            this.closeMenu();
            showModal({ 
                text: "üîÆ <strong>Falta algo...</strong><br><br>Voc√™ precisa de uma <b>P√©rola do Mar</b> para propor casamento. Compre uma na loja!", 
                onConfirm: () => { this.openMenu(); } 
            });
            return;
        }

        this.closeMenu();
        showModal({
            text: `üíç <strong>O Pedido</strong><br><br>Voc√™ oferece a P√©rola do Compromisso...<br><br>"Sim! Eu irei contigo para onde fores, at√© para a superf√≠cie!"`,
            onConfirm: () => {
                this.data.perolas--;
                this.data.casado = true;
                this.save();
                this.openMenu(); // Mant√©m aberto para ver o status de casado
                if (typeof efeitosManager !== 'undefined') efeitosManager.chuvaDeEfeitos('üíç', 30);
                renderJardim();
            }
        });
    },

    spawnHearts: function() {
        const rect = document.querySelector('.romance-avatar').getBoundingClientRect();
        for(let i=0; i<5; i++) {
            const h = document.createElement('div');
            h.textContent = 'üíô';
            h.style.position = 'fixed';
            h.style.left = (rect.left + 20) + 'px';
            h.style.top = rect.top + 'px';
            h.style.zIndex = 20001;
            h.style.animation = 'fall 1.5s ease-out reverse';
            document.body.appendChild(h);
            setTimeout(() => h.remove(), 1500);
        }
    }
};



// Inicializador
window.addEventListener('load', () => RomanceManager.init());

// =========================
// SISTEMA DE TESOURO DI√ÅRIO (ü™é)
// =========================

function verificarSpawnTesouro() {
    const hoje = new Date().toDateString(); // Retorna "Wed Dec 31 2025"
    
    // Se j√° coletou hoje, n√£o faz nada
    if (ultimoTesouroData === hoje) return;

    // Se j√° existe um tesouro no mapa mas n√£o foi coletado, mant√©m ele l√°
    if (tesouroAtivoIndex !== null) return;

    // Tenta encontrar um lugar vazio para spawnar
    const totalCells = getTotalCells();
    let tentativas = 0;
    let spawnou = false;

    while (tentativas < 50 && !spawnou) {
        const randIndex = Math.floor(Math.random() * totalCells);
        
        // Verifica se a c√©lula est√° vazia (sem planta e sem pet)
        const temPlanta = jardimData[randIndex] !== null;
        const temPet = petsEmCena.some(p => p.index === randIndex);
        
        if (!temPlanta && !temPet) {
            tesouroAtivoIndex = randIndex;
            StorageSeguro.set('tesouroAtivoIndex', tesouroAtivoIndex);
            // Marca que o tesouro j√° foi gerado hoje para evitar m√∫ltiplos spawns no mesmo dia
            ultimoTesouroData = hoje;
            StorageSeguro.set('ultimoTesouroData', ultimoTesouroData);
            spawnou = true;
            console.log("Tesouro spawnado no index:", randIndex);
        }
        tentativas++;
    }
}

function coletarTesouro(index) {
    if (index !== tesouroAtivoIndex) return;

    // Evita coleta duplicada: limpa o √≠ndice imediatamente e persiste
    tesouroAtivoIndex = null;
    StorageSeguro.set('tesouroAtivoIndex', null);

    // 1. Calcular Recompensas
    const moedasGanhas = Math.floor(Math.random() * 10) + 1; // 1 a 10 moedas
    const ganhouPerola = Math.random() < 0.10; // 10% de chance

    // 2. Aplicar Recompensas
    updateMoedas(moedasGanhas);
    console.log('Tesouro coletado:', moedasGanhas, 'moedas. Saldo:', totalMoedas);
    
    let msgPerola = "";
    if (ganhouPerola) {
        if (!RomanceManager.data.perolas) RomanceManager.data.perolas = 0;
        RomanceManager.data.perolas++;
        RomanceManager.save();
        msgPerola = "<br>‚ú® <strong>Sorte Grande!</strong> Voc√™ encontrou uma ü¶™ P√©rola do Mar!";
    }

    // 3. Atualizar Estado da data da √∫ltima coleta
    ultimoTesouroData = new Date().toDateString();
    StorageSeguro.set('ultimoTesouroData', ultimoTesouroData);

    // 4. Feedback Visual e Sonoro
    showModal({
        text: `ü™é <strong>Tesouro Antigo Aberto!</strong><br><br>Voc√™ encontrou <strong>${moedasGanhas} moedas</strong>!${msgPerola}`,
        onConfirm: () => {}
    });

    if (typeof efeitosManager !== 'undefined') efeitosManager.chuvaDeEfeitos('ü™é', 15);
    
    // 5. Atualizar Grid
    renderJardim();
}


function init() { 
    const vistoPrimeiroUso = StorageSeguro.get('vistoPrimeiroUso', false);
    let nome = StorageSeguro.get('jogadorNome');

    // Sincroniza o estado do tesouro a partir do storage (assegura consist√™ncia ap√≥s o banco carregar)
    tesouroAtivoIndex = StorageSeguro.get('tesouroAtivoIndex', null);
    ultimoTesouroData = StorageSeguro.get('ultimoTesouroData', null);
    console.log('Sincronizado: tesouroAtivoIndex=', tesouroAtivoIndex, 'ultimoTesouroData=', ultimoTesouroData);
    // Sanitizar e persistir hist√≥rico corrompido/duplicado (robustez)
    try {
        const historicoLimpo = sanitizeHistorico();
        if (historicoLimpo.length !== (historico || []).length) {
            console.info('historico: removendo registros inv√°lidos/duplicados', { antes: (historico || []).length, depois: historicoLimpo.length });
            historico = historicoLimpo;
            StorageSeguro.set('historico_foco', historico);
        }
    } catch (e) {
        console.error('Erro ao sanitizar hist√≥rico', e);
    }

    // Verifica√ß√£o r√°pida de persist√™ncia no boot (√∫til para confirma√ß√µes imediatas)
    try {
        console.debug('startup persistence check', verificarPersistencia());
    } catch (e) {
        console.warn('Erro ao executar verifica√ß√£o de persist√™ncia', e);
    }
    
    // 1. Primeiro Uso
    if (!vistoPrimeiroUso) {
        setTimeout(() => { mostrarPrimeiroUso(); }, 500);
        return;
    }
    
    RomanceManager.init();
    verificarPrimeiroAcesso();
    verificarSpawnTesouro();

    
    
    // 2. Nome do Jogador
    if(!nome) {
        showModal({
            text: "Bem-vindo ao Garden Focus! üå±\n\nQual √© o seu nome?",
            showInput: true,
            onConfirm: (nomeDigitado) => {
                if(nomeDigitado && nomeDigitado.trim()) {
                    StorageSeguro.set('jogadorNome', nomeDigitado.trim());
                    location.reload();
                }
            }
        });
        return;
            // ... c√≥digo existente dentro de init() ...
    
    // Inicializar Pets
    
    
    
    // Listeners finais
    window.addEventListener('resize', () => {
        if (modo3D) ajustarTamanho3D();
    });
    // ...

    }
    
    // 3. Configura√ß√µes Iniciais de Interface
    const btnTelaAtiva = document.getElementById('btnTelaAtiva');
    if (btnTelaAtiva) btnTelaAtiva.classList.toggle('on', manterTelaAtiva);
    
    document.getElementById('saudacaoUsuario').innerHTML = `Ol√°, ${nome}!`;
    carregarFotoPerfil();
    
    // ============================================================
    // L√ìGICA DE TEMA CORRIGIDA
    // ============================================================
    // L√™ as vari√°veis globais j√° carregadas (agora usando .get corretamente)
    const btnTema = document.getElementById('btnTema');

    // For√ßa a leitura do storage para garantir (caso as vari√°veis globais tenham falhado)
    const darkModeSalvo = StorageSeguro.get('darkMode', false);
    
    if (temaAutomaticoAtivo) {
        // Se auto est√° ligado, verifica a hora
        verificarTemaAutomatico();
    } else {
        // Se auto est√° desligado, usa a prefer√™ncia manual
        // Verifica se √© true booleano ou string "true" para compatibilidade
        const deveSerEscuro = (darkModeSalvo === true || darkModeSalvo === 'true');

        if (deveSerEscuro) {
            document.body.classList.add('dark-mode');
            if(btnTema) {
                btnTema.textContent = 'üåô';
                btnTema.title = 'Alternar para modo claro';
            }
        } else {
            document.body.classList.remove('dark-mode');
            if(btnTema) {
                btnTema.textContent = '‚òÄÔ∏è ';
                btnTema.title = 'Alternar para modo escuro';
            }
        }
    }
    atualizarBotoesConfig();
    // ============================================================

    // Restante das inicializa√ß√µes
    document.getElementById('userMoedas').textContent = totalMoedas;
    modo3D = true;
    atualizarVisibilidadeModo3D();
    particulasManager.iniciar();
    audioManager.init();
    
        initJardimData();
    
    applyNatalUI(); 
    applyMedievalUI(); 
    applyCandyforniaUI();
    applyEurosummerUI();
    applyFundoMarUI();
    setLuckyPlant(); 
    renderSelects(); 
    
    if (grid10x10) {
        document.body.classList.add('grid-10x10');
    }
    
    renderJardim(); 
    renderTodos(); 
    
    // Popups e Containers
    const todoPopupAtivo = StorageSeguro.get('todoPopupAtivo', false);
    if (todoPopupAtivo) {
        document.getElementById('todoPopup').classList.add('ativo');
        document.getElementById('btnTodoToggle').classList.add('ativo');
    }
    
    renderEstante(); 
    // abrirModal('estanteOverlay'); // Removido para n√£o abrir ao iniciar
    renderEstrelasNoCeu(); 
    setupEstrelasClick();
    renderMetas();
    
    const metasPopupAtivo = StorageSeguro.get('metasPopupAtivo', false);
    if (metasPopupAtivo) {
        document.getElementById('metasContainer').classList.add('ativo');
        document.getElementById('btnMetasToggle').classList.add('ativo');
        preencherSelectsMetas();
    }
    
    if (modoFundoMar) {
        renderMetasFundoMar();
    }
    
    calcularPrevisao();
    atualizarStreak();
    atualizarBotoes();
    recriarTimerSeExistir();
    melhorarAcessibilidade();
    
    const tutorialVisto = StorageSeguro.get('tutorialVisto', false);
    if (!tutorialVisto) {
        setTimeout(() => { iniciarTutorial(); }, 800);
    }
    
    window.addEventListener('resize', () => {
        if (modo3D) ajustarTamanho3D();
    });
    
        // Inicializar Pets salvos
    if (typeof inicializarPets === "function") {
        inicializarPets();
    }

    
    setTimeout(() => {
        if (modo3D) ajustarTamanho3D();
    }, 500);
}


// Fun√ß√£o para mostrar as cartas do modo Eurosummer
function mostrarCartaEurosummer(ciclo) {
    const cartas = {
        1: { texto: "Lembras-te daquela vez que tent√°mos colher lim√µes e eu quase ca√≠ da escada? Tu riste tanto que at√© te esqueceste de me segurar! Hoje encontrei este lim√£o e, entre risos e saudades, senti o cheiro daquele dia. üçã‚ú®<br><br><small>‚Äî Ver√£o de 1994</small>", emoji: "üçã" },
        2: { texto: "Passei pelo nosso caf√©. O dono ainda pergunta por ti e eu, para disfar√ßar, disse que estavas a chegar. Pedi o teu caf√© favorito e deixei-o arrefecer, como se estivesses apenas a ler um livro ao meu lado. ‚òïüíï<br><br><small>‚Äî Outono de 1996</small>", emoji: "‚òï" },
        3: { texto: "A fonte da pra√ßa continua a espirrar √°gua para todo o lado. Lembras-te de quando tent√°mos tirar aquela foto 'est√©tica' e acab√°mos ensopados? As pessoas olhavam, mas n√≥s s√≥ consegu√≠amos rir. Que falta me fazes. ‚õ≤üíô<br><br><small>‚Äî Agosto de 1998</small>", emoji: "‚õ≤" },
        4: { texto: "Caminhei pelos campos de lavanda e o perfume trouxe-me aquela tua mania de espirrar sempre que pass√°vamos por aqui. Sorri sozinha, imaginando-te a reclamar do p√≥len enquanto seguravas a minha m√£o. ü™ªüíú<br><br><small>‚Äî Primavera de 2001</small>", emoji: "ü™ª" },
        5: { texto: "As uvas est√£o doces, mas n√£o tanto como aquele vinho barato que compr√°mos e bebemos no telhado. Lembras-te de como jur√°mos que √©ramos sommeliers? Acab√°mos com a l√≠ngua roxa e o cora√ß√£o cheio. üçáüç∑‚ú®<br><br><small>‚Äî Vindima de 2003</small>", emoji: "üçá" },
        6: { texto: "A casa na colina ainda tem aquela porta que range. Lembras-te de quando tent√°mos entrar em sil√™ncio √†s 3 da manh√£ e a porta acordou a vila inteira? Bons tempos de fugas e segredos. üè†üíõ<br><br><small>‚Äî Julho de 2005</small>", emoji: "üè†" },
        7: { texto: "Vi o barquinho azul passar. Lembras-te de quando decidiste que √≠amos ser marinheiros e quase fic√°mos √† deriva porque nenhum de n√≥s sabia remar direito? O p√¢nico nos teus olhos foi a coisa mais fofa. ‚õµüíô<br><br><small>‚Äî Ver√£o de 2007</small>", emoji: "‚õµ" },
        8: { texto: "Os girass√≥is est√£o enormes! Lembras-te de quando tentaste levar um para casa e ele era maior que tu? Acab√°mos por deix√°-lo no jardim, dizendo que ele era o nosso guardi√£o dourado. üåªüíõ<br><br><small>‚Äî Agosto de 2009</small>", emoji: "üåª" },
        9: { texto: "Abri aquela garrafa que guard√°vamos para uma ocasi√£o especial. A ocasi√£o √© apenas a saudade. Brindei ao nosso 'quase' e ao nosso 'sempre'. Onde quer que estejas, este gole √© por n√≥s. ü•Ç‚ú®üíï<br><br><small>‚Äî Dezembro de 2011</small>", emoji: "ü•Ç" },
        10: { texto: "Nas ru√≠nas, o tempo parece parado. Lembras-te de quando escrevemos os nossos nomes numa pedra escondida? Procurei-a hoje e ela ainda l√° est√°, firme, como a promessa que fizemos sob o luar. üèõÔ∏èüíû<br><br><small>‚Äî Setembro de 2013</small>", emoji: "üèõÔ∏è" },
        11: { texto: "Encontrei a chave daquela nossa casinha de sonho. Lembras-te de quando plane√°mos cada detalhe, desde a cor das cortinas at√© ao lugar onde o gato ia dormir? A chave ainda brilha, esperando por n√≥s. üè°üóùÔ∏è‚ú®<br><br><small>‚Äî Maio de 2015</small>", emoji: "üè°" },
        12: { texto: "O jardim est√° cheio de flores silvestres. Lembras-te de quando me fizeste um buqu√™ e eu tive uma crise de alergia? Tu entraste em p√¢nico e eu s√≥ conseguia rir entre espirros. Foi o buqu√™ mais lindo. üíêüíñ<br><br><small>‚Äî Primavera de 2017</small>", emoji: "üíê" },
        13: { texto: "As margaridas voltaram a florescer. Lembras-te de quando faz√≠amos 'bem-me-quer, mal-me-quer' e tu batoteavas sempre para dar 'bem-me-quer'? Eu sabia, mas deixava-te ganhar s√≥ para ver o teu sorriso. üåºüíõ‚ú®<br><br><small>‚Äî Ver√£o de 2018</small>", emoji: "üåº" }
    };

    const carta = cartas[ciclo];
    if (!carta) return;

    // Adicionar emoji aos desbloqueados se ainda n√£o estiver
    if (!eurosummerEmojisDesbloqueados.includes(carta.emoji)) {
        eurosummerEmojisDesbloqueados.push(carta.emoji);
        StorageSeguro.set('eurosummerEmojisDesbloqueados', eurosummerEmojisDesbloqueados);
    }

    // Criar modal personalizado para a carta
    const overlay = document.createElement('div');
    overlay.id = 'eurosummerCartaOverlay';
    overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100000;
        animation: fadeIn 0.3s ease;
    `;

    const cartaDiv = document.createElement('div');
    cartaDiv.style.cssText = `
        background: #ffffff;
        border: 1px solid #a2d2ff;
        border-radius: 20px;
        padding: 35px;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 15px 45px rgba(162, 210, 255, 0.2);
        text-align: center;
        animation: slideIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        font-family: 'Georgia', serif;
    `;

    cartaDiv.innerHTML = `
        <div style="font-size: 50px; margin-bottom: 20px; filter: drop-shadow(0 5px 15px rgba(0,0,0,0.1));">${carta.emoji}</div>
        <h3 style="color: #546e7a; font-size: 18px; margin-bottom: 15px; font-weight: normal; letter-spacing: 1px; text-transform: uppercase;">
            Mem√≥ria #${ciclo}
        </h3>
        <p style="color: #2c3e50; font-size: 15px; line-height: 1.8; font-style: italic; margin-bottom: 20px; padding: 0 10px;">
            "${carta.texto}"
        </p>
        <p style="color: #a2d2ff; font-size: 10px; letter-spacing: 1px; margin-bottom: 25px; font-family: sans-serif; text-transform: uppercase;">
            Novo item: ${carta.emoji}
        </p>
        <button id="eurosummerCartaBtn" style="
            background: #a2d2ff;
            color: #ffffff;
            border: none;
            padding: 12px 35px;
            border-radius: 50px !important;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            letter-spacing: 1px; ">GUARDAR</button>
    `;

    overlay.appendChild(cartaDiv);
    document.body.appendChild(overlay);

    // Adicionar estilos de anima√ß√£o
    const style = document.createElement('style');
    style.textContent = `
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideIn {
            from { transform: translateY(-50px) scale(0.9); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }
        #eurosummerCartaBtn:hover {
            background: #004488 !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 51, 102, 0.4);
        }
    `;
    document.head.appendChild(style);

    // Fechar ao clicar no bot√£o
    document.getElementById('eurosummerCartaBtn').onclick = () => {
        overlay.style.animation = 'fadeOut 0.3s ease';
        setTimeout(() => {
            document.body.removeChild(overlay);
            document.head.removeChild(style);
        }, 300);
    };

    // Adicionar anima√ß√£o de fadeOut
    style.textContent += `
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
    `;
}

// Fun√ß√£o para mostrar as cartas do modo Fundo do Mar
function mostrarCartaFundoMar(meta) {
    if (!meta) return;

    // Criar modal personalizado para a carta
    const overlay = document.createElement('div');
    overlay.id = 'fundoMarCartaOverlay';
    overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 29, 61, 0.95);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100000;
        animation: fadeIn 0.3s ease;
    `;

    const cartaDiv = document.createElement('div');
    cartaDiv.style.cssText = `
        background: #003566;
        border: 2px solid #4cc9f0;
        border-radius: 20px;
        padding: 35px;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 15px 45px rgba(76, 201, 240, 0.3);
        text-align: center;
        animation: slideIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    `;

    // L√ìGICA DE CORRE√á√ÉO PARA O GUIA (META 7)
    let petReward = meta.petGratis;
    
    // Se for a Meta 7, usamos o guia que o utilizador escolheu no in√≠cio
    if (meta.id === 7) {
        // Se por algum motivo a vari√°vel n√£o existir, assume Sereia como fallback
        petReward = guiaEscolhidoFundoMar || 'üßú‚Äç‚ôÄÔ∏è'; 
    }

    const guiaIcone = guiaEscolhidoFundoMar || 'üßú‚Äç‚ôÄÔ∏è';
    const guiaNome = guiaIcone === 'üßú‚Äç‚ôÄÔ∏è' ? 'Sereia' : 'Trit√£o';

    cartaDiv.innerHTML = `
        <h3 style="color: #4cc9f0; font-size: 18px; margin-bottom: 15px; font-weight: normal; letter-spacing: 1px; text-transform: uppercase;">
            Mensagem de ${guiaNome}
        </h3>
        <p style="color: #90e0ef; font-size: 11px; margin-bottom: 10px; opacity: 0.8; text-transform: uppercase;">
            Recupera√ß√£o do Recife - Fase ${meta.id}
        </p>
        <p style="color: #ffffff; font-size: 15px; line-height: 1.8; margin-bottom: 20px; padding: 0 10px; font-style: italic;">
            "${meta.texto}"
        </p>
        <p style="color: #4cc9f0; font-size: 10px; letter-spacing: 1px; margin-bottom: 25px; font-family: sans-serif; text-transform: uppercase;">
            Novo pet desbloqueado: ${petReward}
        </p>
        <button id="fundoMarCartaBtn" style="
            background: #4cc9f0;
            color: #001d3d;
            border: none;
            padding: 12px 35px;
            border-radius: 50px !important;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            letter-spacing: 1px; ">GUARDAR</button>
    `;

    overlay.appendChild(cartaDiv);
    document.body.appendChild(overlay);

    // Adicionar estilos de anima√ß√£o
    const style = document.createElement('style');
    style.textContent = `
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideIn {
            from { transform: translateY(-50px) scale(0.9); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }
        #fundoMarCartaBtn:hover {
            background: #00b4d8 !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 180, 216, 0.4);
        }
    `;
    document.head.appendChild(style);

    // Fechar ao clicar no bot√£o
    document.getElementById('fundoMarCartaBtn').onclick = () => {
        // Se houver recompensa (peixes normais ou o guia da meta 7)
        if (petReward) {
            showModal({ 
                text: `üêæ Um novo companheiro foi desbloqueado na loja gratuitamente: ${petReward}!`, 
                onConfirm: () => {} 
            });
        }
        
        // Removemos a chamada antiga "abrirEscolhaSereiaTritao" daqui

        overlay.style.animation = 'fadeOut 0.3s ease';
        setTimeout(() => {
            document.body.removeChild(overlay);
            document.head.removeChild(style);
        }, 300);
    };

    // Adicionar anima√ß√£o de fadeOut
    style.textContent += `
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
    `;
}



function abrirCorreioEurosummer() {
    const cartasDesbloqueadas = Math.floor(eurosummerSessoes / 3);
    if (cartasDesbloqueadas === 0) {
        showModal({ text: "üì¨ O teu correio ainda est√° vazio. Completa sess√µes de foco para receber a tua primeira carta da Riviera.", onConfirm: () => {} });
        return;
    }

    const cartas = {
        1: { texto: "Lembras-te daquela vez que tent√°mos colher lim√µes e eu quase ca√≠ da escada? Tu riste tanto que at√© te esqueceste de me segurar! Hoje encontrei este lim√£o e, entre risos e saudades, senti o cheiro daquele dia. üçã‚ú®<br><br><small>‚Äî Ver√£o de 1994</small>", emoji: "üçã" },
        2: { texto: "Passei pelo nosso caf√©. O dono ainda pergunta por ti e eu, para disfar√ßar, disse que estavas a chegar. Pedi o teu caf√© favorito e deixei-o arrefecer, como se estivesses apenas a ler um livro ao meu lado. ‚òïüíï<br><br><small>‚Äî Outono de 1996</small>", emoji: "‚òï" },
        3: { texto: "A fonte da pra√ßa continua a espirrar √°gua para todo o lado. Lembras-te de quando tent√°mos tirar aquela foto 'est√©tica' e acab√°mos ensopados? As pessoas olhavam, mas n√≥s s√≥ consegu√≠amos rir. Que falta me fazes. ‚õ≤üíô<br><br><small>‚Äî Agosto de 1998</small>", emoji: "‚õ≤" },
        4: { texto: "Caminhei pelos campos de lavanda e o perfume trouxe-me aquela tua mania de espirrar sempre que pass√°vamos por aqui. Sorri sozinha, imaginando-te a reclamar do p√≥len enquanto seguravas a minha m√£o. ü™ªüíú<br><br><small>‚Äî Primavera de 2001</small>", emoji: "ü™ª" },
        5: { texto: "As uvas est√£o doces, mas n√£o tanto como aquele vinho barato que compr√°mos e bebemos no telhado. Lembras-te de como jur√°mos que √©ramos sommeliers? Acab√°mos com a l√≠ngua roxa e o cora√ß√£o cheio. üçáüç∑‚ú®<br><br><small>‚Äî Vindima de 2003</small>", emoji: "üçá" },
        6: { texto: "A casa na colina ainda tem aquela porta que range. Lembras-te de quando tent√°mos entrar em sil√™ncio √†s 3 da manh√£ e a porta acordou a vila inteira? Bons tempos de fugas e segredos. üè†üíõ<br><br><small>‚Äî Julho de 2005</small>", emoji: "üè†" },
        7: { texto: "Vi o barquinho azul passar. Lembras-te de quando decidiste que √≠amos ser marinheiros e quase fic√°mos √† deriva porque nenhum de n√≥s sabia remar direito? O p√¢nico nos teus olhos foi a coisa mais fofa. ‚õµüíô<br><br><small>‚Äî Ver√£o de 2007</small>", emoji: "‚õµ" },
        8: { texto: "Os girass√≥is est√£o enormes! Lembras-te de quando tentaste levar um para casa e ele era maior que tu? Acab√°mos por deix√°-lo no jardim, dizendo que ele era o nosso guardi√£o dourado. üåªüíõ<br><br><small>‚Äî Agosto de 2009</small>", emoji: "üåª" },
        9: { texto: "Abri aquela garrafa que guard√°vamos para uma ocasi√£o especial. A ocasi√£o √© apenas a saudade. Brindei ao nosso 'quase' e ao nosso 'sempre'. Onde quer que estejas, este gole √© por n√≥s. ü•Ç‚ú®üíï<br><br><small>‚Äî Dezembro de 2011</small>", emoji: "ü•Ç" },
        10: { texto: "Nas ru√≠nas, o tempo parece parado. Lembras-te de quando escrevemos os nossos nomes numa pedra escondida? Procurei-a hoje e ela ainda l√° est√°, firme, como a promessa que fizemos sob o luar. üèõÔ∏èüíû<br><br><small>‚Äî Setembro de 2013</small>", emoji: "üèõÔ∏è" },
        11: { texto: "Encontrei a chave daquela nossa casinha de sonho. Lembras-te de quando plane√°mos cada detalhe, desde a cor das cortinas at√© ao lugar onde o gato ia dormir? A chave ainda brilha, esperando por n√≥s. üè°üóùÔ∏è‚ú®<br><br><small>‚Äî Maio de 2015</small>", emoji: "üè°" },
        12: { texto: "O jardim est√° cheio de flores silvestres. Lembras-te de quando me fizeste um buqu√™ e eu tive uma crise de alergia? Tu entraste em p√¢nico e eu s√≥ conseguia rir entre espirros. Foi o buqu√™ mais lindo. üíêüíñ<br><br><small>‚Äî Primavera de 2017</small>", emoji: "üíê" },
        13: { texto: "As margaridas voltaram a florescer. Lembras-te de quando faz√≠amos 'bem-me-quer, mal-me-quer' e tu batoteavas sempre para dar 'bem-me-quer'? Eu sabia, mas deixava-te ganhar s√≥ para ver o teu sorriso. üåºüíõ‚ú®<br><br><small>‚Äî Ver√£o de 2018</small>", emoji: "üåº" }
    };

    let htmlCartas = '';
    for (let i = 1; i <= Math.min(cartasDesbloqueadas, 13); i++) {
        htmlCartas += `
            <div style="background: #fef9f3; border: 1px solid #003366; border-radius: 10px; padding: 15px; margin-bottom: 15px; text-align: left; position: relative;">
                <div style="font-size: 24px; position: absolute; top: 10px; right: 10px;">${cartas[i].emoji}</div>
                <div style="color: #003366; font-weight: bold; font-size: 14px; margin-bottom: 8px; font-family: 'Georgia', serif;">Mem√≥ria #${i}</div>
                <div style="color: #5d4037; font-size: 13px; line-height: 1.5; font-style: italic; font-family: 'Georgia', serif;">"${cartas[i].texto}"</div>
            </div>
        `;
    }

    const overlay = document.createElement('div');
    overlay.style.cssText = `position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 100000; animation: fadeIn 0.3s ease;`;
    
    const container = document.createElement('div');
    container.style.cssText = `background: #ffffff; border: 1px solid #a2d2ff; border-radius: 20px; padding: 30px; max-width: 450px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 15px 45px rgba(162, 210, 255, 0.2); text-align: center;`;
    
    container.innerHTML = `
        <h2 style="color: #546e7a; margin-bottom: 25px; font-family: 'Georgia', serif; font-weight: normal; letter-spacing: 2px; text-transform: uppercase;">üì¨ Correio</h2>
        <div style="margin-bottom: 25px;">${htmlCartas}</div>
        <button id="fecharCorreioBtn" style="background: #a2d2ff; color: #ffffff; border: none; padding: 12px 35px; border-radius: 50px !important; font-weight: bold; cursor: pointer; letter-spacing: 1px; ">FECHAR</button>
    `;

    overlay.appendChild(container);
    document.body.appendChild(overlay);

    document.getElementById('fecharCorreioBtn').onclick = () => {
        document.body.removeChild(overlay);
    };
}

function reiniciarEurosummer() {
    showModal({ 
        text: "‚ö†Ô∏è Desejas reiniciar a tua hist√≥ria na Riviera?<br><br>As tuas sess√µes do modo Eurosummer voltar√£o a zero e as mem√≥rias ser√£o guardadas novamente. Os emojis j√° plantados no jardim permanecer√£o.", 
        onConfirm: () => {
            eurosummerSessoes = 0;
            eurosummerEmojisDesbloqueados = [];
            vistoIntroEurosummer = false;
            StorageSeguro.set('eurosummerSessoes', 0);
            StorageSeguro.set('eurosummerEmojisDesbloqueados', []);
            StorageSeguro.set('vistoIntroEurosummer', false);
            
            // Se o modo estiver ativo, resetar a planta escolhida para o padr√£o e desativar o modo
            if (modoEurosummer) {
                escolhido = ITENS_PADRAO[0];
                StorageSeguro.set('plantaEscolhida', escolhido);
                
                modoEurosummer = false;
                StorageSeguro.set('modoEurosummer', false);
                
                // Atualizar UI imediatamente
                applyEurosummerUI();
                const btnEuro = document.getElementById('btnEurosummerLoja');
                if (btnEuro) btnEuro.classList.remove('on');
            }
            
            setTimeout(() => {
                showModal({ 
                    text: "üåä A brisa do mar limpou o teu di√°rio. Uma nova jornada come√ßa agora.", 
                    onConfirm: () => {
                        location.reload();
                    }
                });
            }, 300);
        } 
    });
}
function promptCustom(text, isNumber, onConfirm) {
    showModal({
        text: text,
        showInput: true,
        inputType: isNumber ? 'number' : 'text',
        onConfirm: (val) => {
            if (val) {
                if (isNumber) {
                    const n = parseInt(val);
                    if (!isNaN(n) && n > 0) onConfirm(n);
                } else {
                    onConfirm(val.trim());
                }
            }
        }
    });
}

function showModal({ text, showInput = false, onConfirm, onCancel = null, altText = null, confirmText = "Ok!", inputType = "text" }) {
    const overlay = document.getElementById('customAlertOverlay');
    const input = document.getElementById('customAlertInput');
    const cancelBtn = document.getElementById('alertCancelBtn');
    const altBtn = document.getElementById('alertAltBtn');
    const confirmBtn = document.getElementById('alertConfirmBtn');

    document.getElementById('customAlertText').innerHTML = text;

    input.style.display = showInput ? 'block' : 'none';

    if (showInput) {
        input.type = inputType;
        input.value = '';
        input.focus();
    } else {
        input.style.display = 'none';
    }

    confirmBtn.textContent = confirmText;
    cancelBtn.textContent = "Cancelar";

    // L√≥gica do bot√£o Alternativo (se houver)
    if (altText) {
        altBtn.style.display = 'block';
        altBtn.textContent = altText;
        altBtn.onclick = () => {
            fecharModal('customAlertOverlay');
            onConfirm(altText);
        };
        // Se tem bot√£o alternativo, geralmente escondemos o cancelar padr√£o, 
        // mas aqui mantemos se n√£o conflitarem visualmente, ou ajustamos conforme prefer√™ncia.
        // Pelo padr√£o do seu c√≥digo, vou ocultar o cancelar se tiver Alt, a menos que seja input.
        cancelBtn.style.display = 'none';
    } else {
        altBtn.style.display = 'none';
        // Bot√£o cancelar sempre vis√≠vel em perguntas ou inputs
        cancelBtn.style.display = 'block';
    }

    // ABRIR O MODAL
    abrirModal('customAlertOverlay');

    // CONFIGURAR A√á√ÉO DE CONFIRMAR
    confirmBtn.onclick = () => {
        if (inputType === 'number' && showInput) {
            const val = parseInt(input.value);
            if (isNaN(val) || val < 1) {
                input.style.borderColor = 'red';
                setTimeout(() => input.style.borderColor = '', 1000);
                return;
            }
        }
        fecharModal('customAlertOverlay');
        if (onConfirm) onConfirm(input.value);
    };

    // CONFIGURAR A√á√ÉO DE CANCELAR
    cancelBtn.onclick = () => {
        fecharModal('customAlertOverlay');
        if (onCancel) onCancel();
    };
}

function addTempo(v) { tempos.push(v); StorageSeguro.set('tempos', tempos); renderSelects(); }
function addMotivo(v) { motivos.push(v); StorageSeguro.set('motivos', motivos); renderSelects(); }

	function carregarFotoPerfil() {
	    const fotoSalva = StorageSeguro.get('profilePhoto', null);
	    if (fotoSalva) {
	        const imgElement = document.getElementById('profilePhoto');
	        const placeholder = document.getElementById('profilePhotoPlaceholder');
	        const bottomNavImg = document.getElementById('bottomNavPhoto');
	        const bottomNavPlaceholder = document.getElementById('bottomNavPhotoPlaceholder');
	        
	        // Fallback para caso a imagem esteja corrompida
	        imgElement.onerror = () => {
	            imgElement.style.display = 'none';
	            placeholder.style.display = 'flex';
	            bottomNavImg.style.display = 'none';
	            bottomNavPlaceholder.style.display = 'flex';
	            StorageSeguro.set('profilePhoto', null);
	        };
	        
	        imgElement.src = fotoSalva;
	        imgElement.style.display = 'block';
	        placeholder.style.display = 'none';
	        
	        // Sincronizar com barra inferior
	        bottomNavImg.src = fotoSalva;
	        bottomNavImg.style.display = 'block';
	        bottomNavPlaceholder.style.display = 'none';
	    }
	}

document.getElementById('profilePhotoInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file && file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(event) {
            const imgElement = document.getElementById('profilePhoto');
            const placeholder = document.getElementById('profilePhotoPlaceholder');
            const bottomNavImg = document.getElementById('bottomNavPhoto');
            const bottomNavPlaceholder = document.getElementById('bottomNavPhotoPlaceholder');
            
            imgElement.src = event.target.result;
            imgElement.style.display = 'block';
            placeholder.style.display = 'none';
            
            // Sincronizar com barra inferior
            bottomNavImg.src = event.target.result;
            bottomNavImg.style.display = 'block';
            bottomNavPlaceholder.style.display = 'none';
            
            StorageSeguro.set('profilePhoto', event.target.result);
        };
        reader.readAsDataURL(file);
    }
});



function toggleSino() {
    const btn = document.getElementById('btnSino');
    sinoAtivo = !sinoAtivo;
    StorageSeguro.set('sinoAtivo', sinoAtivo);
    
    btn.classList.toggle('on', sinoAtivo);
}



function togglePrevisao() {
    const btn = document.getElementById('btnPrevisao');
    mostrarPrevisao = !mostrarPrevisao;
    StorageSeguro.set('mostrarPrevisao', mostrarPrevisao);
    
    btn.classList.toggle('on', mostrarPrevisao);
    
    calcularPrevisao();
}



function verificarTemaAutomatico() {
    // S√ì aplicar se modo autom√°tico estiver ATIVADO
    if (!temaAutomaticoAtivo) {
        console.log("Modo autom√°tico DESATIVADO, n√£o alterando tema");
        return;
    }
    
    const agora = new Date();
    const hora = agora.getHours();
    const isNoite = hora >= 18 || hora < 6;
    
    console.log("Verificando tema autom√°tico. Hora:", hora, "√â noite?", isNoite);
    
    if (isNoite) {
        // Aplicar tema escuro
        document.body.classList.add('dark-mode');
        StorageSeguro.set('darkMode', 'true');
        console.log("Aplicando tema escuro (autom√°tico - noite)");
    } else {
        // Aplicar tema claro
        document.body.classList.remove('dark-mode');
        StorageSeguro.set('darkMode', 'false');
        console.log("Aplicando tema claro (autom√°tico - dia)");
    }
    
    renderEstrelasNoCeu();
}

document.getElementById('tempoEscolhido').addEventListener('change', () => { if(!intervalo) { atualizarTimerDisplay(); calcularPrevisao(); } });
document.getElementById('motivoEscolhido').addEventListener('change', calcularPrevisao);

window.addEventListener('beforeunload', () => {
    if (intervalo) {
        // Salvar o estado atual do timer antes de sair
        salvarTimerAtivo();
        clearInterval(intervalo);
        intervalo = null;
    }
    audioManager.parar();
    efeitosManager.limparTodos();
    particulasManager.parar();
});



// Por esta NOVA:
// Verificar tema autom√°tico periodicamente (a cada minuto)
setInterval(() => {
    if (temaAutomaticoAtivo) {
        verificarTemaAutomatico();
    }
}, 60000);

if ('serviceWorker' in navigator) {
window.addEventListener('load', () => {
navigator.serviceWorker.register('sw.js')
.then(reg => console.log('Service Worker registado com sucesso!'))
.catch(err => console.log('Erro ao registar Service Worker:', err));
});
}
async function gerenciarTelaAtiva(ativar) {
    if (!('wakeLock' in navigator)) {
        console.log("API Wake Lock n√£o suportada neste navegador");
        return;
    }
    
    try {
        if (ativar) {
            if (wakeLock) return; // J√° est√° ativo
            
            wakeLock = await navigator.wakeLock.request('screen');
            console.log("Tela bloqueada (Ativa)");
            
            // Lidar com libera√ß√£o inesperada
            wakeLock.addEventListener('release', () => {
                console.log("Wake Lock foi liberado");
                wakeLock = null;
            });
        } else if (wakeLock) {
            await wakeLock.release();
            wakeLock = null;
            console.log("Tela liberada");
        }
    } catch (err) {
        console.error(`${err.name}, ${err.message}`);
        
        // Feedback visual se houver erro
        if (err.name === 'NotAllowedError') {
            showModal({ 
                text: "Permiss√£o necess√°ria: Para manter a tela ativa durante o foco, permita que o navegador impe√ßa o bloqueio de tela.", 
                onConfirm: () => {} 
            });
        }
    }
}
// =========================
// FUN√á√ÉO BULLDOZE - REMOVER TODAS AS PLANTAS
// =========================
function bulldoze() {
    showModal({
        text: "Tem certeza que deseja remover todas as plantas do jardim?<br><br>Aten√ß√£o: Seus animais ficar√£o seguros.",
        onConfirm: () => {
            // --- C√ÅLCULO DE RECURSOS (Loot) ---
            let loot = { apples: 0, wood: 0, stone: 0 };
            let ganhouAlgo = false;

            // Apenas gera recursos se N√ÉO estiver no modo Fundo do Mar
            if (!modoFundoMar) {
                const totalCells = getTotalCells();
                
                // Percorre o jardim atual para ver o que ser√° destru√≠do
                for (let i = 0; i < totalCells; i++) {
                    // Verifica se existe planta (e ignora se for apenas um buraco vazio ou null)
                    // Tamb√©m garantimos que n√£o √© um pet (pets n√£o s√£o removidos no bulldoze visualmente, mas verificamos por seguran√ßa)
                    if (jardimData[i]) {
                        // L√≥gica de Drop Proporcional
                        // Madeira (ü™µ): Comum - 50% de chance por planta
                        if (Math.random() < 0.5) loot.wood++;
                        
                        // Pedra (ü™®): Incomum - 20% de chance por planta
                        if (Math.random() < 0.2) loot.stone++;
                        
                        // Ma√ß√£ (üçé): Rara - 5% de chance por planta
                        if (Math.random() < 0.05) loot.apples++;
                    }
                }

                // Salvar no Invent√°rio
                if (loot.wood > 0 || loot.stone > 0 || loot.apples > 0) {
                    ganhouAlgo = true;
                    let recursosAtuais = StorageSeguro.get('recursos', { apples: 0, wood: 0, stone: 0 });
                    
                    recursosAtuais.apples = (recursosAtuais.apples || 0) + loot.apples;
                    recursosAtuais.wood = (recursosAtuais.wood || 0) + loot.wood;
                    recursosAtuais.stone = (recursosAtuais.stone || 0) + loot.stone;
                    
                    StorageSeguro.set('recursos', recursosAtuais);
                }
            }

            // Iniciar anima√ß√£o do tornado
            animarTornado().then(() => {
                // O jardimData j√° foi atualizado (limpo) durante a anima√ß√£o na fun√ß√£o animarTornado
                alvo = null; // Apenas resetar o alvo
                salvarTudo(); // Salvar o estado vazio
                renderJardim(); // Renderizar para garantir que est√° limpo
                
                // Mensagem de Feedback
                let msg = "Jardim limpo! üå™<br><br>Todas as plantas foram removidas.";
                
                if (ganhouAlgo) {
                    msg += "<br><br><strong>Recursos Coletados:</strong><br>";
                    if (loot.wood > 0) msg += `${loot.wood} ü™µ Madeira<br>`;
                    if (loot.stone > 0) msg += `${loot.stone} ü™® Pedra<br>`;
                    if (loot.apples > 0) msg += `${loot.apples} üçé Ma√ß√£<br>`;
                    msg += "<small>(Verifique seu invent√°rio)</small>";
                } else if (!modoFundoMar) {
                    msg += "<br><br><small>Nenhum recurso encontrado desta vez.</small>";
                }
                
                showModal({ 
                    text: msg, 
                    onConfirm: () => {} 
                });
            });
        }
    });
}


function animarTornado() {
    return new Promise((resolve) => {
        const totalCells = getTotalCells();
        let currentIndex = 0;
        
        // Fun√ß√£o para mostrar tornado em uma c√©lula e remover a planta
        function mostrarTornadoNoIndice(index) {
            // REMOVER PLANTA IMEDIATAMENTE do jardimData
            jardimData[index] = null;
            
            if (modo3D) {
                // Modo 3D
                const cells = document.querySelectorAll('.cell-3d');
                if (cells[index]) {
                    // Remover spans e layers relacionados a plantas/caminhos/ghosts, mas preservar pets e bolhas
                    cells[index].querySelectorAll('.emoji-3d, .plant-spawn, .fantasma, .path-layer').forEach(el => el.remove());

                    // Remover divs com backgroundImage (ex: sprites de flor, texturas) exceto bolhas m√°gicas
                    Array.from(cells[index].children).forEach(child => {
                        if (child.nodeType === 1 && child.tagName === 'DIV') {
                            try {
                                const bg = getComputedStyle(child).backgroundImage;
                                if (bg && bg !== 'none' && !child.classList.contains('bolha-magica')) {
                                    child.remove();
                                }
                            } catch(e) {}
                        }
                    });

                    // Adicionar tornado
                    const tornado = document.createElement('span');
                    tornado.className = 'tornado-3d';
                    tornado.textContent = 'üå™';
                    cells[index].appendChild(tornado);
                    
                    // Remover ap√≥s anima√ß√£o
                    setTimeout(() => {
                        if (cells[index].contains(tornado)) {
                            cells[index].removeChild(tornado);
                        }
                    }, 500);
                }
            } else {
                // Modo 2D
                const plots = document.querySelectorAll('.plot');
                if (plots[index]) {
                    const hasPet = petsEmCena.some(p => p.index === index);

                    // Se n√£o houver pet, remove todos os spans (plantas/tesouro)
                    if (!hasPet) {
                        plots[index].querySelectorAll('span.plant-spawn, span').forEach(s => {
                            // Evita remover elementos espec√≠ficos de UI que n√£o s√£o plantas (checagens extra se necess√°rio)
                            s.remove();
                        });
                    } else {
                        // Se houver pet, remove apenas spans marcados como plantas
                        plots[index].querySelectorAll('span.plant-spawn').forEach(s => s.remove());
                    }

                    // Remover divs com backgroundImage (sprites de flor/decora√ß√£o)
                    Array.from(plots[index].children).forEach(child => {
                        if (child.nodeType === 1 && child.tagName === 'DIV') {
                            try {
                                const bg = getComputedStyle(child).backgroundImage;
                                if (bg && bg !== 'none') child.remove();
                            } catch(e) {}
                        }
                    });

                    // Adicionar tornado
                    const tornado = document.createElement('span');
                    tornado.className = 'tornado-2d';
                    tornado.textContent = 'üå™';
                    plots[index].appendChild(tornado);
                    
                    // Remover ap√≥s anima√ß√£o
                    setTimeout(() => {
                        if (plots[index].contains(tornado)) {
                            plots[index].removeChild(tornado);
                        }
                    }, 500);
                }
            }
        }
        
        // Tocar som leve de vento durante o tornado
        try { if (typeof audioManager !== 'undefined' && audioManager.playWindBurst) audioManager.playWindBurst(totalCells * 50 + 400); } catch (e) {}

        // Animar tornado passando por todas as c√©lulas
        const interval = setInterval(() => {
            if (currentIndex >= totalCells) {
                clearInterval(interval);
                setTimeout(resolve, 600); // Dar tempo para √∫ltima anima√ß√£o
                return;
            }
            
            mostrarTornadoNoIndice(currentIndex);
            currentIndex++;
        }, 50); // Velocidade do tornado (ms entre c√©lulas)
    });
}
// Verificar atualiza√ß√µes automaticamente quando a p√°gina carrega
window.addEventListener('load', () => {
    // Verifica a cada 1 hora se h√° atualiza√ß√µes
    setInterval(() => {
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.ready.then(registration => {
                registration.update();
            });
        }
    }, 3600000); // 1 hora em milissegundos
});

if ('serviceWorker' in navigator) {
  window.addEventListener('load', async () => {
    try {
      const registration = await navigator.serviceWorker.register('./sw.js');

      // For√ßa checagem de atualiza√ß√£o sempre que o app abrir
      registration.update();

      // Se um novo SW for encontrado
      registration.addEventListener('updatefound', () => {
        const newWorker = registration.installing;

        newWorker.addEventListener('statechange', () => {
          if (
            newWorker.state === 'installed' &&
            navigator.serviceWorker.controller
          ) {
            // Novo SW ativo ‚Üí F5 sem d√≥
            window.location.reload();
          }
        });
      });
    } catch (err) {
      console.error('Erro ao registrar SW:', err);
    }
  });
}

// =========================
// PAGE VISIBILITY API - REATIVAR AO RETORNAR √Ä ABA
// =========================
document.addEventListener('visibilitychange', function() {
    if (!document.hidden) {
        // Usu√°rio retornou √† aba - reativar tudo
        console.log('Aba reativada - reiniciando timers');
        
        // 1. Reativar movimento dos pets se existir (Limpando antes para evitar duplicatas)
        if (typeof intervaloPets !== 'undefined' && typeof moverPetsLoop === 'function') {
            clearInterval(intervaloPets);
            intervaloPets = setInterval(moverPetsLoop, 3000);
        }
        
        // 2. Reativar produ√ß√£o da vaquinha se existir
        if (typeof iniciarProducaoVaquinha === 'function') {
            iniciarProducaoVaquinha();
        }
        
        // 3. Verificar tema autom√°tico se ativo
        if (typeof temaAutomaticoAtivo !== 'undefined' && temaAutomaticoAtivo && typeof verificarTemaAutomatico === 'function') {
            verificarTemaAutomatico();
        }
        
        // 4. Atualizar o timer de foco se estiver rodando
        if (typeof intervalo !== 'undefined' && intervalo) {
            // O timer j√° est√° rodando, apenas garantir que o display est√° atualizado
            if (typeof atualizarTimerDisplay === 'function') {
                atualizarTimerDisplay();
            }
        }
        
        // 5. Reativar anima√ß√µes de fundo se estiverem ativas
        if (typeof animacaoFundoAtiva !== 'undefined' && animacaoFundoAtiva && typeof particulasManager !== 'undefined') {
            if (typeof particulasManager.iniciar === 'function') {
                particulasManager.iniciar();
            }
        }
        
        // 6. Renderizar jardim para garantir que est√° atualizado
        if (typeof renderJardim === 'function') {
            renderJardim();
        }
        
        console.log('Todos os sistemas reativados com sucesso!');
    } else {
        // Usu√°rio saiu da aba
        console.log('Aba em segundo plano');
    }
});

</script>
  <script src="https://cdn.jsdelivr.net/npm/@twemoji/api@latest/dist/twemoji.min.js" crossorigin="anonymous"></script>

<style>
  /* 1. O SEGREDO: Deixa o texto invis√≠vel onde tiver emoji nativo */
  /* Isso evita que o emoji "feio" apare√ßa antes da troca */
  body {
    text-rendering: optimizeLegibility;
  }

  /* 2. Garante o tamanho correto e fixo */
  img.emoji {
     display: inline-block !important;
     height: 1em !important;
     width: 1em !important;
     margin: 0 .1em !important;
     vertical-align: -0.1em !important;
  }
</style>

<script>
 
let emojisAtivos = true;

// Aplica Twemoji
function fixEmojis() {
    if (!emojisAtivos) return;

    twemoji.parse(document.body, {
        folder: 'svg',
        ext: '.svg'
    });
}

// Ativa / desativa pelo toggle
function toggleEmojis() {
    emojisAtivos = !emojisAtivos;

    const btn = document.getElementById('btnEmojis');
    btn.classList.toggle('on', emojisAtivos);

    if (emojisAtivos) {
        fixEmojis();
    } else {
        removerTwemoji();
    }

    localStorage.setItem('emojisAtivos', emojisAtivos);
}

// Remove os emojis do Twemoji e volta ao nativo
function removerTwemoji() {
    document.querySelectorAll('img.emoji').forEach(img => {
        const span = document.createTextNode(img.alt);
        img.replaceWith(span);
    });
}

// Carrega prefer√™ncia salva
document.addEventListener('DOMContentLoaded', () => {
    const salvo = localStorage.getItem('emojisAtivos');

    if (salvo !== null) {
        emojisAtivos = salvo === 'true';
    }

    document.getElementById('btnEmojis').classList.toggle('on', emojisAtivos);

    if (emojisAtivos) {
        fixEmojis();
    }
});

// Observer s√≥ atua se estiver ligado
const observer = new MutationObserver(() => {
    if (!emojisAtivos) return;

    observer.disconnect();
    fixEmojis();
    observer.observe(document.body, { childList: true, subtree: true });
});

observer.observe(document.body, { childList: true, subtree: true });
// =========================
// SISTEMA DE TESOURO DI√ÅRIO (ü™é) - CORRIGIDO
// =========================

function verificarSpawnTesouro() {
    const hoje = new Date().toDateString();
    
    // Se j√° coletou hoje, n√£o faz nada
    if (ultimoTesouroData === hoje) return;

    // Se j√° existe um tesouro no mapa mas n√£o foi coletado, mant√©m ele l√°
    if (tesouroAtivoIndex !== null) return;

    // Tenta encontrar um lugar vazio
    const totalCells = getTotalCells();
    let tentativas = 0;
    let spawnou = false;

    while (tentativas < 50 && !spawnou) {
        const randIndex = Math.floor(Math.random() * totalCells);
        
        const temPlanta = jardimData[randIndex] !== null;
        const temPet = petsEmCena.some(p => p.index === randIndex);
        
        if (!temPlanta && !temPet) {
            tesouroAtivoIndex = randIndex;
            StorageSeguro.set('tesouroAtivoIndex', tesouroAtivoIndex);
            // Marca que o tesouro j√° foi gerado hoje para evitar m√∫ltiplos spawns no mesmo dia
            ultimoTesouroData = hoje;
            StorageSeguro.set('ultimoTesouroData', ultimoTesouroData);
            spawnou = true;
            console.log("Tesouro spawnado no index:", randIndex);
        }
        tentativas++;
    }
}

function coletarTesouro(index) {
    if (index !== tesouroAtivoIndex) return;

    // Evita coleta duplicada: limpa o √≠ndice imediatamente e persiste
    tesouroAtivoIndex = null;
    StorageSeguro.set('tesouroAtivoIndex', null);

    // 1. Calcular Recompensas
    const moedasGanhas = Math.floor(Math.random() * 10) + 1; // 1 a 10 moedas
    const ganhouPerola = Math.random() < 0.10; // 10% de chance

    // 2. Aplicar Recompensas
    updateMoedas(moedasGanhas);
    console.log('Tesouro coletado:', moedasGanhas, 'moedas. Saldo:', totalMoedas);
    
    let msgPerola = "";
    if (ganhouPerola) {
        if (!RomanceManager.data.perolas) RomanceManager.data.perolas = 0;
        RomanceManager.data.perolas++;
        RomanceManager.save();
        msgPerola = "<br>‚ú® <strong>Sorte Grande!</strong> Voc√™ encontrou uma ü¶™ P√©rola do Mar!";
    }

    // 3. Limpar o tesouro dos dados
    ultimoTesouroData = new Date().toDateString();
    
    StorageSeguro.set('ultimoTesouroData', ultimoTesouroData);

    // 4. Feedback e Atualiza√ß√£o Visual
    showModal({
        text: `ü™é <strong>Tesouro Antigo Aberto!</strong><br><br>Voc√™ encontrou <strong>${moedasGanhas} moedas</strong>!${msgPerola}`,
        onConfirm: () => {}
    });

    if (typeof efeitosManager !== 'undefined') efeitosManager.chuvaDeEfeitos('ü™é', 15);
    
    // FOR√áA A ATUALIZA√á√ÉO IMEDIATA DO JARDIM PARA SUMIR O √çCONE
    renderJardim();
}
// =========================
// SISTEMA DE INVENT√ÅRIO (C√ìDIGO COMPLETO)
// =========================

function abrirInventario() {
    renderInventario();
    abrirModal('inventarioOverlay');
}

// =========================
// RENDERIZAR INVENT√ÅRIO (CORRIGIDO)
// =========================
function renderInventario() {
    const container = document.getElementById('listaInventario');
    if (!container) return;
    
    container.innerHTML = '';
    let itensExibidos = 0;

    // Fun√ß√£o auxiliar para HTML do controle de venda
    const gerarControleVenda = (tipo, preco, quantidadeAtual) => {
        const inputId = `qtd_venda_${tipo}`;
        return `
            <div class="controle-venda-container">
                <input type="number" 
                       id="${inputId}" 
                       value="1" 
                       min="1" 
                       max="${quantidadeAtual}" 
                       style="width: 50px; padding: 5px; border-radius: 8px; border: 1px solid #ccc; text-align: center; font-weight: bold;"
                       oninput="validarInputVenda(this, ${quantidadeAtual})">
                
                <button onclick="venderItemInventario('${tipo}', ${preco}, ${quantidadeAtual}, '${inputId}')" 
                        style="flex: 1; padding: 8px; cursor: pointer; background: #ff4d4d; color: white; border: none; border-radius: 50px !important; font-weight: bold; font-size: 12px;">
                    Vender
                </button>
            </div>
            <div style="text-align: center; margin-top: 4px;">
                <small style="color: var(--text-secondary); font-size: 10px;">Valor un: ${preco} üí∞</small>
            </div>
        `;
    };

    // 1. P√©rolas (Romance)
    if (typeof RomanceManager !== 'undefined' && RomanceManager.data && RomanceManager.data.perolas > 0) {
        itensExibidos++;
        const qtd = RomanceManager.data.perolas;
        const controleHtml = gerarControleVenda('perolas', 500, qtd);
        const controlePersonalizado = controleHtml.replace('#ff4d4d', '#4cc9f0'); // Azul para p√©rolas

        container.innerHTML += `
            <div class="item-loja" style="border: 2px solid #4cc9f0; background: linear-gradient(135deg, var(--bg-panel), #f0f8ff);">
                <div style="padding: 10px; display: flex; flex-direction: column; align-items: center;">
                    <div style="font-size: 35px; filter: drop-shadow(0 0 5px #4cc9f0);">ü¶™</div>
                    <div style="font-weight: bold; color: #003566; margin-top: 5px;">P√©rola</div>
                    <div style="font-size: 14px; font-weight: 900; color: #4cc9f0;">x${qtd}</div>
                </div>
                ${controlePersonalizado}
            </div>
        `;
    }

    // 2. Recursos (Ma√ß√£, Madeira, Pedra)
    // FIX: Garante que o objeto tenha todas as chaves mesmo se o save for antigo
    const recursosRaw = StorageSeguro.get('recursos', {});
    const recursos = { apples: 0, wood: 0, stone: 0, ...recursosRaw };

    const itensComuns = [
        { tipo: 'apples', icone: 'üçé', nome: 'Ma√ß√£', preco: 50 },
        { tipo: 'wood', icone: 'ü™µ', nome: 'Madeira', preco: 20 },
        { tipo: 'stone', icone: 'ü™®', nome: 'Pedra', preco: 15 }
    ];

    itensComuns.forEach(item => {
        if (recursos[item.tipo] > 0) {
            itensExibidos++;
            const qtd = recursos[item.tipo];
            
            container.innerHTML += `
                <div class="item-loja">
                    <div style="padding: 10px; display: flex; flex-direction: column; align-items: center;">
                        <div style="font-size: 35px;">${item.icone}</div>
                        <div style="font-weight: bold; margin-top: 5px;">${item.nome}</div>
                        <div style="font-size: 14px; font-weight: 900; color: var(--text-main);">x${qtd}</div>
                    </div>
                    ${gerarControleVenda(item.tipo, item.preco, qtd)}
                </div>
            `;
        }
    });

    // 3. Estado Vazio
    if (itensExibidos === 0) {
        container.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 30px; color: var(--text-secondary); opacity: 0.7;">
                <div style="font-size: 60px; margin-bottom: 15px;">üéí</div>
                <p>Seu invent√°rio est√° vazio.</p>
                <small>Use o bot√£o "Tornado" üå™ no jardim (ao lado de Iniciar Foco) para tentar coletar recursos ao limpar plantas.</small>
            </div>
        `;
    }
}

// Fun√ß√£o auxiliar para validar input em tempo real
function validarInputVenda(input, max) {
    let val = parseInt(input.value);
    if (isNaN(val) || val < 1) input.value = 1;
    if (val > max) input.value = max;
}

// =========================
// FUN√á√ÉO PARA VENDER ITEM (CORRIGIDA)
// =========================
function venderItemInventario(tipo, precoUnitario, maxQuantidade, inputId) {
    const nomes = { apples: "üçé Ma√ß√£", wood: "ü™µ Madeira", stone: "ü™® Pedra", perolas: "ü¶™ P√©rola" };
    const nomeItem = nomes[tipo] || tipo;

    const input = document.getElementById(inputId);
    if (!input) return;
    
    const qtdSelecionada = parseInt(input.value);

    if (isNaN(qtdSelecionada) || qtdSelecionada <= 0) {
        showToast('‚ùå', 'Erro', 'Quantidade inv√°lida');
        return;
    }

    if (qtdSelecionada > maxQuantidade) {
        showToast('‚ùå', 'Erro', 'Voc√™ n√£o tem tantos itens');
        return;
    }

    const totalGanho = qtdSelecionada * precoUnitario;

    // Confirma√ß√£o estilizada
    // Injeta CSS tempor√°rio para o alerta ficar acima do invent√°rio
    const styleZ = document.createElement('style');
    styleZ.textContent = `#customAlertOverlay { z-index: 30000 !important; }`;
    document.head.appendChild(styleZ);

    showModal({
        text: `Vender <strong>${qtdSelecionada}x ${nomeItem}</strong>?<br><br>Receber√°: <span style="color:var(--primary); font-weight:bold; font-size:18px;">${totalGanho} üí∞</span>`,
        confirmText: "VENDER",
        
        onConfirm: () => {
            // Executar Venda
            if (tipo === 'perolas') {
                if (RomanceManager.data.perolas >= qtdSelecionada) {
                    RomanceManager.data.perolas -= qtdSelecionada;
                    RomanceManager.save();
                    updateMoedas(totalGanho);
                }
            } else {
                let recursos = StorageSeguro.get('recursos', { apples: 0, wood: 0, stone: 0 });
                // Merge para garantir integridade
                recursos = { apples: 0, wood: 0, stone: 0, ...recursos };
                
                if (recursos[tipo] >= qtdSelecionada) {
                    recursos[tipo] -= qtdSelecionada;
                    updateMoedas(totalGanho);
                    StorageSeguro.set('recursos', recursos);
                }
            }

            salvarTudo();
            
            // Efeito visual
            if (typeof chuvaDeEfeitos === 'function') chuvaDeEfeitos('üí∞', 10);
            
            showToast('üí∞', 'Venda realizada!', `+${totalGanho} moedas`);

            // Atualiza UI
            renderInventario();

            // Limpeza
            if (document.head.contains(styleZ)) document.head.removeChild(styleZ);
        },
        onCancel: () => {
            if (document.head.contains(styleZ)) document.head.removeChild(styleZ);
        }
    });
}



// =========================
// FUN√á√ÉO DE DEBUG: P√âROLAS
// =========================
function debugGanharPerola() {
    // Garante que a estrutura de dados exista
    if (!RomanceManager.data.perolas) {
        RomanceManager.data.perolas = 0;
    }

    // Adiciona a p√©rola
    RomanceManager.data.perolas++;
    
    // Salva no localStorage
    RomanceManager.save();

    // Feedback visual r√°pido
    console.log("Debug: P√©rola adicionada! Total: " + RomanceManager.data.perolas);
    
    // Se o modal de invent√°rio estiver aberto, ele atualiza em tempo real
    if (document.getElementById('inventarioOverlay').style.display === 'flex') {
        renderInventario();
    }

    // Notifica√ß√£o simples na tela (opcional, usando o sistema do jogo se existir)
    if (typeof showModal === 'function') {
        // Apenas um log ou um pequeno alerta para confirmar
    }
}

function debugAdicionar100Arvores() {
    const agora = new Date();
    const anoAtual = agora.getFullYear();
    const icones = ['üå≥', 'üå≤', 'üå¥', 'üåµ', 'üåª', 'üå∏'];
    const motivos = ['Foco', 'Estudo', 'Trabalho', 'Leitura', 'Medita√ß√£o'];
    
    for (let i = 0; i < 100; i++) {
        const dataAleatoria = new Date(anoAtual, Math.floor(Math.random() * 12), Math.floor(Math.random() * 28));
        historico.push({
            data: dataAleatoria.toISOString(),
            minutos: Math.floor(Math.random() * 60) + 10,
            status: 'sucesso',
            icone: icones[Math.floor(Math.random() * icones.length)],
            motivo: motivos[Math.floor(Math.random() * motivos.length)]
        });
    }
    
    salvarDados();
    if (typeof mostrarToast === 'function') {
        mostrarToast("üå≥ 100 √°rvores adicionadas ao hist√≥rico!", "success");
    } else {
        alert("üå≥ 100 √°rvores adicionadas ao hist√≥rico!");
    }
    
    if (document.getElementById('dashboardOverlay').style.display === 'flex') {
        renderizarDashboardGrid3D();
    }
}

// CORRE√á√ÉO VISUAL: Bolha M√°gica atr√°s do Pet
const styleFix = document.createElement('style');
styleFix.innerHTML = `
    .bolha-magica {
        z-index: 14 !important; /* Reduzido para ficar atr√°s do pet (que √© 15) */
        background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.4), rgba(135,206,250,0.2)) !important; /* Mais transparente */
    }
    .pet-3d {
        z-index: 20 !important; /* Garante que o pet fique na frente */
    }
`;
document.head.appendChild(styleFix);



// Fun√ß√µes do Di√°rio Integrado na Estante
let diarioPaginaAtual = 0; // 0 ser√° a p√°gina de escrita (√∫ltima p√°gina)
let diarioFiltroTexto = '';
let diarioFiltroData = '';
let diarioFiltroHumor = '';
let diarioBuscaExpandida = false;

function abrirDiario() {
    diarioPaginaAtual = 0;
    diarioFiltroTexto = '';
    diarioFiltroData = '';
    diarioFiltroHumor = '';
    abrirModal('diarioOverlay');
    renderizarEntradasDiario();
}

function aplicarBuscaDiario() {
    diarioFiltroTexto = document.getElementById('buscaDiarioTexto').value.toLowerCase();
    diarioFiltroData = document.getElementById('buscaDiarioData').value;
    diarioFiltroHumor = document.getElementById('buscaDiarioHumor').value;
    
    if (diarioFiltroTexto || diarioFiltroData || diarioFiltroHumor) {
        showToast('üîç', 'Busca aplicada', 'Mostrando apenas mem√≥rias filtradas.');
    }
    
    diarioPaginaAtual = 0; // Volta para a p√°gina de escrita para ver o resultado da busca ao navegar
    renderizarEntradasDiario();
}

function limparBuscaDiario() {
    diarioFiltroTexto = '';
    diarioFiltroData = '';
    diarioFiltroHumor = '';
    diarioPaginaAtual = 0;
    renderizarEntradasDiario();
}

function alternarBuscaDiario() {
    diarioBuscaExpandida = !diarioBuscaExpandida;
    renderizarEntradasDiario();
}

function iniciarEdicaoDiario(id) {
    const diario = StorageSeguro.get('diario_entradas', []);
    const entrada = diario.find(e => e.id === id);
    if (!entrada) return;

    const divConteudo = document.getElementById(`conteudoMemoria_${id}`);
    divConteudo.innerHTML = `
        <textarea id="editarTextoDiario_${id}" class="diary-textarea" style="width: 100%; height: 200px; margin-top: 10px; background: rgba(255,255,255,0.5); border: 1px solid #8b4513; border-radius: 5px; padding: 10px;">${entrada.texto}</textarea>
        <div style="display: flex; gap: 10px; margin-top: 10px;">
            <button onclick="salvarEdicaoDiario(${id})" style="flex: 1; padding: 10px; background: #4caf50; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">Salvar Altera√ß√µes</button>
            <button onclick="renderizarEntradasDiario()" style="padding: 10px; background: #f44336; color: white; border: none; border-radius: 5px; cursor: pointer;">Cancelar</button>
        </div>
    `;
}

function salvarEdicaoDiario(id) {
    const novoTexto = document.getElementById(`editarTextoDiario_${id}`).value.trim();
    if (!novoTexto) {
        showToast('‚ö†Ô∏è', 'Campo vazio', 'O texto n√£o pode estar vazio!');
        return;
    }

    let diario = StorageSeguro.get('diario_entradas', []);
    const index = diario.findIndex(e => e.id === id);
    
    if (index !== -1) {
        const agora = new Date();
        const dataEditada = agora.toLocaleString('pt-BR', { 
            day: '2-digit', 
            month: '2-digit', 
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        diario[index].texto = novoTexto;
        diario[index].editadaEm = dataEditada;
        
        StorageSeguro.set('diario_entradas', diario);
        showToast('‚úèÔ∏è', 'Mem√≥ria atualizada', 'Sua nota foi editada com sucesso.');
        renderizarEntradasDiario();
    }
}

function mudarPaginaDiario(direcao) {
    // Dire√ß√£o -1 vai para mem√≥rias antigas (aumenta o √≠ndice)
    // Dire√ß√£o +1 volta para a p√°gina de escrita (diminui o √≠ndice)
    diarioPaginaAtual -= direcao; 
    renderizarEntradasDiario();
}

function salvarEntradaDiario() {
    const texto = document.getElementById('diarioTexto').value.trim();
    const humor = document.getElementById('diarioHumor').value;
    
    if (!texto) {
        showToast('‚ö†Ô∏è', 'Campo vazio', 'Escreva algo antes de salvar!');
        return;
    }
    
    const agora = new Date();
    const data = agora.toLocaleString('pt-BR', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric', 
        hour: '2-digit', 
        minute: '2-digit' 
    });
    
    let diario = StorageSeguro.get('diario_entradas', []);
    diario.unshift({ 
        id: Date.now(),
        data: agora.toISOString(), 
        dataFormatada: data,
        humor: humor, 
        texto: texto 
    });
    
    StorageSeguro.set('diario_entradas', diario);
    
    // Limpar campos
    document.getElementById('diarioTexto').value = '';
    document.getElementById('diarioHumor').value = 'üòä';
    
    // Atualizar lista
    renderizarEntradasDiario();
    
    // Mostrar notifica√ß√£o
    showToast('üìî', 'Entrada salva!', 'Sua reflex√£o foi guardada no di√°rio.');
}

function renderizarEntradasDiario() {
    const container = document.getElementById('diarioPaginaConteudo');
    const paginacaoInfo = document.getElementById('diarioPaginaAtual');
    const btnAnterior = document.getElementById('btnDiarioAnterior');
    const btnProximo = document.getElementById('btnDiarioProximo');
    
    if (!container) return;
    
    let diarioOriginal = StorageSeguro.get('diario_entradas', []);
    let diario = [...diarioOriginal];
    
    // Aplicar filtros se existirem
    if (diarioFiltroTexto) {
        diario = diario.filter(e => e.texto.toLowerCase().includes(diarioFiltroTexto));
    }
    if (diarioFiltroData) {
        diario = diario.filter(e => e.data.startsWith(diarioFiltroData));
    }
    if (diarioFiltroHumor) {
        diario = diario.filter(e => e.humor === diarioFiltroHumor);
    }

    const totalMemorias = diario.length;
    const totalPaginas = totalMemorias + 1; // +1 para a p√°gina de escrita
    
    // Garantir limites
    if (diarioPaginaAtual < 0) diarioPaginaAtual = 0;
    if (diarioPaginaAtual >= totalPaginas) diarioPaginaAtual = totalPaginas - 1;
    
    // Atualizar controles de pagina√ß√£o
    if (paginacaoInfo) {
        if (diarioPaginaAtual === 0) {
            paginacaoInfo.textContent = `Nova Entrada (P√°g. ${totalPaginas})`;
        } else {
            paginacaoInfo.textContent = `Mem√≥ria ${diarioPaginaAtual} de ${totalMemorias} (P√°g. ${totalPaginas - diarioPaginaAtual})`;
        }
    }
    
    if (btnAnterior) {
        btnAnterior.disabled = diarioPaginaAtual >= totalPaginas - 1;
        btnAnterior.style.opacity = btnAnterior.disabled ? '0.3' : '1';
    }
    if (btnProximo) {
        btnProximo.disabled = diarioPaginaAtual <= 0;
        btnProximo.style.opacity = btnProximo.disabled ? '0.3' : '1';
    }
    
    if (diarioPaginaAtual === 0) {
        // Renderizar p√°gina de escrita
        container.innerHTML = `
            <div class="diary-input-area" style="flex: 1; display: flex; flex-direction: column;">
                <!-- Se√ß√£o de Busca Compacta -->
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <button onclick="alternarBuscaDiario()" style="flex: 1; padding: 8px; background: ${diarioBuscaExpandida ? '#5d4037' : 'rgba(139, 69, 19, 0.1)'}; color: ${diarioBuscaExpandida ? 'white' : '#8b4513'}; border: 1px solid #8b4513; border-radius: 50px !important; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; transition: all 0.3s;">
                            ${diarioBuscaExpandida ? '‚úï Fechar Busca' : 'üîç Pesquisar no Di√°rio'}
                        </button>
                        ${(diarioFiltroTexto || diarioFiltroData || diarioFiltroHumor) ? `
                            <button onclick="limparBuscaDiario()" style="padding: 8px 15px; background: #f44336; color: white; border: none; border-radius: 50px !important; font-size: 12px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">Limpar</button>
                        ` : ''}
                    </div>

                    <div id="painelBuscaDiario" style="display: ${diarioBuscaExpandida ? 'block' : 'none'}; background: rgba(139, 69, 19, 0.05); padding: 12px; border-radius: 15px; margin-top: 10px; border: 1px solid rgba(139, 69, 19, 0.1); animation: fadeIn 0.3s ease;">
                        <div style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 10px;">
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="buscaDiarioTexto" value="${diarioFiltroTexto}" placeholder="Palavras-chave..." style="flex: 2; padding: 8px; border-radius: 8px; border: 1px solid #8b4513; background: #fff9e6; font-size: 12px;">
                                <input type="date" id="buscaDiarioData" value="${diarioFiltroData}" style="flex: 1; padding: 8px; border-radius: 8px; border: 1px solid #8b4513; background: #fff9e6; font-size: 12px;">
                            </div>
                            <select id="buscaDiarioHumor" style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #8b4513; background: #fff9e6; font-size: 12px; color: #3e2723;">
                                <option value="">üé≠ Todas as emo√ß√µes</option>
                                <option value="üòä" ${diarioFiltroHumor === 'üòä' ? 'selected' : ''}>üòä Feliz</option>
                                <option value="üòå" ${diarioFiltroHumor === 'üòå' ? 'selected' : ''}>üòå Calmo</option>
                                <option value="üòê" ${diarioFiltroHumor === 'üòê' ? 'selected' : ''}>üòê Neutro</option>
                                <option value="üòî" ${diarioFiltroHumor === 'üòî' ? 'selected' : ''}>üòî Triste</option>
                                <option value="üò¥" ${diarioFiltroHumor === 'üò¥' ? 'selected' : ''}>üò¥ Cansado</option>
                                <option value="üò§" ${diarioFiltroHumor === 'üò§' ? 'selected' : ''}>üò§ Frustrado</option>
                                <option value="üôè" ${diarioFiltroHumor === 'üôè' ? 'selected' : ''}>üôè Grato</option>
                            </select>
                        </div>
                        <button onclick="aplicarBuscaDiario()" style="width: 100%; padding: 10px; background: #8b4513; color: white; border: none; border-radius: 50px !important; font-size: 12px; font-weight: bold; cursor: pointer; transition: background 0.2s;">
                            Aplicar Filtros
                        </button>
                    </div>
                </div>

                <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 15px;">
                    <label style="font-family: 'Georgia', serif; color: #5d4037; font-weight: bold;">Humor:</label>
                    <select id="diarioHumor" style="flex: 1; padding: 8px; border-radius: 5px; border: 1px solid #8b4513; background: #fff9e6; color: #3e2723;">
                        <option value="üòä">üòä Feliz</option>
                        <option value="üòå">üòå Calmo</option>
                        <option value="üòê">üòê Neutro</option>
                        <option value="üòî">üòî Triste</option>
                        <option value="üò¥">üò¥ Cansado</option>
                        <option value="üò§">üò§ Frustrado</option>
                        <option value="üôè">üôè Grato</option>
                    </select>
                </div>
                <textarea id="diarioTexto" class="diary-textarea" style="flex: 1; min-height: 150px;" placeholder="Querido di√°rio, hoje eu..."></textarea>
                <button onclick="salvarEntradaDiario()" style="width: 100%; padding: 12px; background: #8b4513; color: white; border: none; border-radius: 50px !important; font-weight: bold; cursor: pointer; margin-top: 15px; box-shadow: 0 4px 0 #5d4037;">‚úçÔ∏è Escrever no Di√°rio</button>
            </div>
        `;
    } else {
        // Renderizar uma mem√≥ria espec√≠fica (√≠ndice diarioPaginaAtual - 1)
        const entrada = diario[diarioPaginaAtual - 1];
        container.innerHTML = `
            <div class="diary-entry" style="flex: 1; display: flex; flex-direction: column; border: none; background: transparent; padding: 0;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; border-bottom: 1px solid rgba(139, 69, 19, 0.2); padding-bottom: 10px;">
                    <div>
                        <small style="color: #8b4513; font-weight: bold; font-family: 'Georgia', serif; font-size: 14px;">${entrada.dataFormatada}</small>
                        ${entrada.editadaEm ? `<br><small style="color: #d32f2f; font-style: italic; font-size: 11px;">editada em ${entrada.editadaEm}</small>` : ''}
                        <div style="font-size: 30px; margin-top: 10px;">${entrada.humor}</div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="iniciarEdicaoDiario(${entrada.id})" style="background: #8b4513; color: white; border: none; border-radius: 5px; padding: 5px 10px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 5px;">‚úèÔ∏è Editar</button>
                        <button onclick="deletarEntradaDiario(${entrada.id})" style="background: none; color: #8b4513; border: 1px solid #8b4513; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center;" title="Apagar mem√≥ria">‚úï</button>
                    </div>
                </div>
                <div id="conteudoMemoria_${entrada.id}" style="flex: 1;">
                    <p style="margin: 10px 0 0 0; color: #3e2723; line-height: 1.8; white-space: pre-wrap; word-wrap: break-word; font-style: italic; font-size: 18px; font-family: 'Courier New', Courier, monospace;">${escapeHtml(entrada.texto)}</p>
                </div>
            </div>
        `;
    }
}

function deletarEntradaDiario(id) {
    // Garantir que o alerta fique acima do di√°rio (z-index do di√°rio √© 45000)
    const styleZ = document.createElement('style');
    styleZ.id = 'tempStyleDiarioZ';
    styleZ.textContent = `#customAlertOverlay { z-index: 100000 !important; }`;
    document.head.appendChild(styleZ);

    showModal({
        text: 'üóëÔ∏è <strong>Deletar entrada?</strong><br>Esta a√ß√£o n√£o pode ser desfeita.',
        onConfirm: () => {
            let diario = StorageSeguro.get('diario_entradas', []);
            diario = diario.filter(e => e.id !== id);
            StorageSeguro.set('diario_entradas', diario);
            renderizarEntradasDiario();
            showToast('üóëÔ∏è', 'Entrada deletada', 'A entrada foi removida do di√°rio.');
            if (document.getElementById('tempStyleDiarioZ')) document.getElementById('tempStyleDiarioZ').remove();
        },
        onCancel: () => {
            if (document.getElementById('tempStyleDiarioZ')) document.getElementById('tempStyleDiarioZ').remove();
        }
    });
}

// Fun√ß√£o auxiliar para escapar HTML
function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
}

// ==========================================
// üìî NOVO DI√ÅRIO (100% via StorageSeguro)
// ==========================================

async function salvarNoLivro() {
    const texto = document.getElementById('textoMsg').value;
    const humor = document.getElementById('humorSel').value;
    const data = new Date().toLocaleString();

    if(!texto) return alert("Escreve algo!");

    try {
        // 1. Pega os dados antigos do banco (await)
        let historico = (await StorageSeguro.get('meuDiario')) || [];
        
        // 2. Adiciona o novo
        historico.unshift({ data, humor, texto });
        
        // 3. Salva de volta no banco
        await StorageSeguro.set('meuDiario', historico);

        document.getElementById('textoMsg').value = '';
        alert("Gravado no Banco de Dados!");
        
        // Atualiza a visualiza√ß√£o se estiver aberta
        abrirLivro(); 
    } catch (e) {
        console.error(e);
        alert("Erro ao salvar no banco.");
    }
}

async function abrirLivro() {
    const lista = document.getElementById('listaEntradas');
    lista.innerHTML = "Carregando mem√≥rias...";

    try {
        // Busca do banco assincronamente
        let historico = (await StorageSeguro.get('meuDiario')) || [];
        
        if (historico.length === 0) {
            lista.innerHTML = "<p style='text-align:center; padding:20px'>O di√°rio est√° vazio.</p>";
            return;
        }

        lista.innerHTML = historico.map(e => `
            <div style="border-bottom:1px solid #ccc; padding: 10px 0;">
                <small style="color:#666">üìÖ ${e.data} | üé≠ ${e.humor}</small>
                <p style="margin-top:5px; font-size:1.1em">${escapeHtml(e.texto)}</p>
            </div>
        `).join('');
    } catch (e) {
        lista.innerHTML = "Erro ao ler o di√°rio.";
        console.error(e);
    }
}

/* ==========================================
   GERENCIADOR DE JARDINS (FIXED & NO-ROTATION)
   ========================================== */
const JardinsManager = {
    currentScale: 1, // Controle de zoom interno

    // Carrega com fallback para garantir persist√™ncia
    getSaved: function() {
        // Tenta pegar do sistema seguro primeiro
        let dados = StorageSeguro.get('meus_jardins_salvos', null);
        
        // Se falhar ou estiver vazio, tenta o backup f√≠sico do localStorage
        if (!dados || (Array.isArray(dados) && dados.length === 0)) {
            try {
                const backup = localStorage.getItem('meus_jardins_salvos_backup');
                if (backup) {
                    dados = JSON.parse(backup);
                    // Sincroniza de volta para o sistema seguro
                    StorageSeguro.set('meus_jardins_salvos', dados);
                }
            } catch(e) {
                console.error("Erro ao ler backup de jardins", e);
            }
        }
        return Array.isArray(dados) ? dados : [];
    },

    salvarDados: function(dados) {
        // Salva em ambos os lugares para garantir
        StorageSeguro.set('meus_jardins_salvos', dados);
        localStorage.setItem('meus_jardins_salvos_backup', JSON.stringify(dados));
    },

    abrirMenu: function() {
        abrirModal('jardinsOverlay');
        this.renderizarLista();
        this.fecharVisualizador(); // Garante estado inicial
    },

    salvarAtual: function() {
        const salvos = [...this.getSaved()]; // Cria c√≥pia limpa do array
        if (salvos.length >= 5) {
            showModal({ text: "‚ö†Ô∏è Limite atingido (5/5)! Exclua um jardim antigo para salvar um novo.", onConfirm: () => {} });
            return;
        }

        const temPlantas = jardimData.some(item => item !== null);
        if (!temPlantas) {
            showModal({ text: "O jardim est√° vazio! Plante algo antes de salvar.", onConfirm: () => {} });
            return;
        }

        showModal({ 
            text: "Nome do Jardim (ex: Recanto de Paz):", 
            showInput: true,
            confirmText: "Salvar",
            onConfirm: (nome) => {
                if (!nome || !nome.trim()) nome = "Jardim sem nome";
                
                const novoJardim = {
                    id: Date.now(),
                    nome: nome.trim(),
                    dataCriacao: new Date().toLocaleDateString(),
                    grid10x10: grid10x10,
                    itens: JSON.parse(JSON.stringify(jardimData)), // Snapshot profundo
                    modoOrigem: modoFundoMar ? 'fundoMar' : (modoEurosummer ? 'euro' : 'terra')
                };

                salvos.push(novoJardim);
                this.salvarDados(salvos); // Salva com persist√™ncia dupla
                showToast('üíæ', 'Jardim Salvo!', 'Salvo com sucesso');
                this.renderizarLista();
            }
        });
    },

    excluir: function(id) {
        showModal({ 
            text: "Tem certeza que deseja excluir este jardim salvo?", 
            onConfirm: () => {
                let salvos = this.getSaved();
                salvos = salvos.filter(j => j.id !== id);
                this.salvarDados(salvos);
                this.renderizarLista();
            }
        });
    },

    renderizarLista: function() {
        const lista = document.getElementById('listaJardinsSalvos');
        if(!lista) return;
        
        const salvos = this.getSaved();
        lista.innerHTML = '';

        if (salvos.length === 0) {
            lista.innerHTML = '<div style="text-align:center; padding:20px; color:#999; font-style:italic; background:rgba(0,0,0,0.02); border-radius:10px;">Nenhum jardim salvo ainda.</div>';
            return;
        }

        salvos.forEach(jardim => {
            const item = document.createElement('div');
            item.style.cssText = `
                background: var(--bg-body);
                border: 1px solid rgba(0,0,0,0.1);
                border-radius: 12px;
                padding: 12px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            `;
            
            item.innerHTML = `
                <div style="text-align: left;">
                    <div style="font-weight: bold; color: var(--text-main); font-size:14px;">${jardim.nome}</div>
                    <div style="font-size: 10px; color: var(--text-secondary); margin-top:2px;">
                        ${jardim.grid10x10 ? 'üìê 10x10' : 'üìê 5x5'} ‚Ä¢ üìÖ ${jardim.dataCriacao}
                    </div>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button onclick="JardinsManager.visualizar(${jardim.id})" style="padding: 6px 12px; font-size: 12px; background: var(--primary); color:white; border:none; border-radius: 50px !important; cursor:pointer;">üëÅÔ∏è Ver</button>
                    <button onclick="JardinsManager.excluir(${jardim.id})" style="padding: 6px 10px; font-size: 12px; background: #ff5252; color:white; border:none; border-radius: 50px !important; cursor:pointer;">üóëÔ∏è</button>
                </div>
            `;
            lista.appendChild(item);
        });
    },

    visualizar: function(id) {
        const salvos = this.getSaved();
        const jardim = salvos.find(j => j.id === id);
        if (!jardim) return;

        // Alterna visibilidade
        document.getElementById('listaJardinsSalvos').style.display = 'none';
        document.getElementById('btnSalvarJardim').style.display = 'none';
        document.getElementById('visualizadorJardimContainer').style.display = 'block';
        document.getElementById('tituloVisualizador').textContent = `üëÅÔ∏è ${jardim.nome}`;
        
        this.renderizarCena3D(jardim);
    },

    fecharVisualizador: function() {
        const container = document.getElementById('visualizadorJardimContainer');
        if(container) container.style.display = 'none';
        
        const lista = document.getElementById('listaJardinsSalvos');
        if(lista) lista.style.display = 'flex';
        
        const btn = document.getElementById('btnSalvarJardim');
        if(btn) btn.style.display = 'block';
        
        document.getElementById('cenaJardimEspectador').innerHTML = '';
        this.currentScale = 1; // Reseta zoom
    },

    zoom: function(delta) {
        const grid = document.querySelector('.spec-grid');
        if (!grid) return;
        
        let newScale = this.currentScale + delta;
        if (newScale >= 0.5 && newScale <= 2.5) {
            this.currentScale = newScale;
            // Mant√©m rota√ß√£o fixa, muda apenas a escala
            grid.style.transform = `scale(${this.currentScale}) rotateX(60deg) rotateZ(45deg)`;
        }
    },

    renderizarCena3D: function(jardim) {
        const container = document.getElementById('cenaJardimEspectador');
        container.innerHTML = '';
        
        const gridSize = jardim.grid10x10 ? 10 : 5;
        const totalCells = gridSize * gridSize;
        // Ajusta tamanho da c√©lula para caber no container sem overflow excessivo
        let cellSize = jardim.grid10x10 ? 25 : 45;

        // CSS Espec√≠fico do Visualizador (Est√°tico)
        const style = document.createElement('style');
        style.textContent = `
            .spec-scene { perspective: 1500px; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; overflow: hidden; /* Cursor padr√£o pois n√£o h√° arraste */ cursor: default; }
            .spec-grid { display: grid; grid-template-columns: repeat(${gridSize}, ${cellSize}px); grid-template-rows: repeat(${gridSize}, ${cellSize}px); gap: 2px; transform-style: preserve-3d; background-color: var(--grid-border); padding: 2px; /* Rota√ß√£o Fixa Inicial */ transform: scale(1) rotateX(60deg) rotateZ(45deg); transition: transform 0.3s ease-out; /* Suaviza o zoom */ }
            .spec-grid::before { content: ''; position: absolute; top: 100%; left: 0; width: 100%; height: 15px; background: var(--side-color); transform-origin: top; transform: rotateX(-90deg); }
            .spec-grid::after { content: ''; position: absolute; top: 0; left: 100%; width: 15px; height: 100%; background: var(--bottom-color); transform-origin: left; transform: rotateY(90deg); }
            .spec-cell { width: ${cellSize}px; height: ${cellSize}px; background-color: var(--grid-color); background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 40 40"><path d="M5 35 L10 30 L15 35 Z" fill="%237db336" opacity="0.6"/><path d="M25 15 L30 10 L35 15 Z" fill="%237db336" opacity="0.6"/></svg>'); background-size: ${cellSize}px ${cellSize}px; display: flex; align-items: center; justify-content: center; transform-style: preserve-3d; position: relative; }
            .spec-item { font-size: ${Math.floor(cellSize * 0.75)}px; position: absolute; /* Corre√ß√£o de posicionamento do emoji 3D */ transform: rotateZ(-45deg) rotateX(-90deg) translateY(-${Math.floor(cellSize * 0.45)}px); filter: drop-shadow(0 2px 2px rgba(0,0,0,0.2)); }
        `;
        container.appendChild(style);

        const scene = document.createElement('div');
        scene.className = 'spec-scene';
        const grid = document.createElement('div');
        grid.className = 'spec-grid';

        // Arrays de tipos especiais
        const caminhos = TIPOS_CAMINHO;
        const floresEspeciais = ['üåª', 'üåπ', 'üå∑'];

        // Renderiza c√©lulas
        for (let i = 0; i < totalCells; i++) {
            const cell = document.createElement('div');
            cell.className = 'spec-cell';
            const itemData = jardim.itens[i];

            if (itemData && itemData.icone) {
                const isCaminho = caminhos.includes(itemData.icone);
                const isFlor = floresEspeciais.includes(itemData.icone);

                if (isCaminho) {
                    // --- L√ìGICA DE CONEX√ïES PARA O GRID SALVO ---
                    const x = i % gridSize;
                    const y = Math.floor(i / gridSize);
                    
                    const check = (dx, dy) => {
                        const nx = x + dx;
                        const ny = y + dy;
                        if (nx < 0 || nx >= gridSize || ny < 0 || ny >= gridSize) return false;
                        const ni = ny * gridSize + nx;
                        const nItem = jardim.itens[ni];
                        return nItem && caminhos.includes(nItem.icone);
                    };

                    const conexoes = {
                        norte: check(0, -1),
                        sul: check(0, 1),
                        leste: check(1, 0),
                        oeste: check(-1, 0)
                    };

                    // Gera textura e aplica como camada
                    const svgBackground = gerarTexturaCaminho(conexoes, itemData.icone);
                    const layer = document.createElement('div');
                    layer.style.cssText = `position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-size: cover; background-repeat: no-repeat; pointer-events: none; transform-style: preserve-3d; background-image: url('${svgBackground}');`;
                    
                    // Remove borda da c√©lula base para ficar cont√≠nuo
                    cell.style.borderColor = 'rgba(0,0,0,0.05)';
                    cell.appendChild(layer);

                } else if (isFlor && typeof gerarSpriteFlor === 'function') {
                    // --- L√ìGICA DE FLORES ESPECIAIS ---
                    const svgSprite = gerarSpriteFlor(itemData.icone);
                    const florElem = document.createElement('div');
                    florElem.style.cssText = `
                        position: absolute; 
                        width: 100%; 
                        height: 100%; 
                        background-image: url('${svgSprite}'); 
                        background-size: contain; 
                        background-repeat: no-repeat; 
                        background-position: center bottom; 
                        left: 80%; 
                        top: 20%; 
                        transform: translate(-50%, -50%) rotateZ(-45deg) rotateX(-90deg) scale(0.85); 
                        transform-origin: center bottom;
                    `;
                    cell.appendChild(florElem);

                } else {
                    // --- RENDERIZA√á√ÉO PADR√ÉO (Emoji) ---
                    const item = document.createElement('div');
                    item.className = 'spec-item';
                    item.textContent = itemData.icone;
                    cell.appendChild(item);
                }

                // Tooltip simples ao clicar na planta
                cell.onclick = (e) => {
                    e.stopPropagation();
                    const motivo = itemData.motivo || 'Planta';
                    const icone = itemData.icone;
                    if(typeof showToast === 'function') {
                        showToast(icone, motivo, 'Detalhes do item salvo');
                    }
                };
                cell.style.cursor = 'help';
            }
            grid.appendChild(cell);
        }
        scene.appendChild(grid);
        container.appendChild(scene);

        // Suporte apenas para Zoom com Scroll (sem rota√ß√£o)
        scene.onwheel = (e) => {
            e.preventDefault();
            const delta = e.deltaY > 0 ? -0.1 : 0.1;
            this.zoom(delta);
        };
        
        // Aplica corre√ß√£o de emojis se dispon√≠vel
        if (typeof fixEmojis === 'function') fixEmojis();
    }
};


// Fun√ß√£o global de acesso ao menu
function abrirMenuJardins() {
    JardinsManager.abrirMenu();
}
// ==========================================
// SISTEMA DE CAMINHOS INTELIGENTES (AUTO-TILE)
// ==========================================

/**
 * Gera o SVG do caminho baseado nas conex√µes
 */
function gerarTexturaCaminho(conexoes, tipoIcone) {
    // Defini√ß√£o de cores e flags
    let corEstrada, corBorda, corDetalhe;
    let isAsfalto = false;
    let isPedra = false;
    let defsPattern = "";

    // 1. ASFALTO
    if (tipoIcone.includes('üõ£')) { 
        isAsfalto = true;
        corEstrada = '#34495e'; // Cinza Escuro
        corBorda = '#ecf0f1';   // Branco (Faixas laterais)
        corDetalhe = '#f1c40f'; // Amarelo (Faixa central)
    } 
    // 2. PEDRA / TIJOLO
    else if (tipoIcone.includes('üß±')) { 
        isPedra = true;
        corEstrada = '#7f8c8d'; // Cinza M√©dio (Fundo)
        corBorda = '#2c3e50';   // Cinza Escuro (Borda)
        
        // Define o padr√£o de "poucas pedrinhas"
        defsPattern = `
            <defs>
                <pattern id="patPedra" x="0" y="0" width="20" height="20" patternUnits="userSpaceOnUse">
                    <circle cx="10" cy="10" r="2" fill="#bdc3c7" opacity="0.5"/>
                </pattern>
            </defs>`;
    } 
    // 3. TERRA
    else { 
        corEstrada = '#dcc096'; // Marrom Claro
        corBorda = '#a1887f';   // Marrom Escuro
    }

    const largura = 40;
    const centro = 30;
    const meio = 50; // Centro exato da c√©lula (30 + 40/2)
    
    // In√≠cio do SVG
    let svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">`;
    
    // Adiciona a defini√ß√£o do pattern se houver
    if (isPedra) svg += defsPattern;

    // Helper para desenhar a textura de pedra por cima do fundo
    const addTexture = (x, y, w, h) => {
        if (isPedra) {
            return `<rect x="${x}" y="${y}" width="${w}" height="${h}" fill="url(#patPedra)" />`;
        }
        return "";
    };

    // Helper para desenhar linha amarela
    const addYellowLine = (x1, y1, x2, y2) => {
        if (isAsfalto) {
            return `<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" stroke="${corDetalhe}" stroke-width="2" stroke-dasharray="5,5" />`;
        }
        return "";
    };
    
    // 1. FUNDO DO CAMINHO (Centro)
    svg += `<rect x="${centro}" y="${centro}" width="${largura}" height="${largura}" fill="${corEstrada}" />`;
    svg += addTexture(centro, centro, largura, largura);

    // 2. DESENHAR CONEX√ïES
    
    // NORTE
    if (conexoes.norte) {
        svg += `<rect x="${centro}" y="0" width="${largura}" height="${centro + 5}" fill="${corEstrada}" />`;
        svg += addTexture(centro, 0, largura, centro + 5);
        svg += `<line x1="${centro}" y1="0" x2="${centro}" y2="${centro}" stroke="${corBorda}" stroke-width="4" />`;
        svg += `<line x1="${centro+largura}" y1="0" x2="${centro+largura}" y2="${centro}" stroke="${corBorda}" stroke-width="4" />`;
        svg += addYellowLine(meio, 0, meio, centro);
    } else {
        svg += `<line x1="${centro}" y1="${centro}" x2="${centro+largura}" y2="${centro}" stroke="${corBorda}" stroke-width="4" />`;
    }

    // SUL
    if (conexoes.sul) {
        svg += `<rect x="${centro}" y="${centro + largura - 5}" width="${largura}" height="${centro + 5}" fill="${corEstrada}" />`;
        svg += addTexture(centro, centro + largura - 5, largura, centro + 5);
        svg += `<line x1="${centro}" y1="${centro+largura}" x2="${centro}" y2="100" stroke="${corBorda}" stroke-width="4" />`;
        svg += `<line x1="${centro+largura}" y1="${centro+largura}" x2="${centro+largura}" y2="100" stroke="${corBorda}" stroke-width="4" />`;
        svg += addYellowLine(meio, centro + largura, meio, 100);
    } else {
        svg += `<line x1="${centro}" y1="${centro+largura}" x2="${centro+largura}" y2="${centro+largura}" stroke="${corBorda}" stroke-width="4" />`;
    }

    // OESTE
    if (conexoes.oeste) {
        svg += `<rect x="0" y="${centro}" width="${centro + 5}" height="${largura}" fill="${corEstrada}" />`;
        svg += addTexture(0, centro, centro + 5, largura);
        svg += `<line x1="0" y1="${centro}" x2="${centro}" y2="${centro}" stroke="${corBorda}" stroke-width="4" />`;
        svg += `<line x1="0" y1="${centro+largura}" x2="${centro}" y2="${centro+largura}" stroke="${corBorda}" stroke-width="4" />`;
        svg += addYellowLine(0, meio, centro, meio);
    } else {
        svg += `<line x1="${centro}" y1="${centro}" x2="${centro}" y2="${centro+largura}" stroke="${corBorda}" stroke-width="4" />`;
    }

    // LESTE
    if (conexoes.leste) {
        svg += `<rect x="${centro + largura - 5}" y="${centro}" width="${centro + 5}" height="${largura}" fill="${corEstrada}" />`;
        svg += addTexture(centro + largura - 5, centro, centro + 5, largura);
        svg += `<line x1="${centro+largura}" y1="${centro}" x2="100" y2="${centro}" stroke="${corBorda}" stroke-width="4" />`;
        svg += `<line x1="${centro+largura}" y1="${centro+largura}" x2="100" y2="${centro+largura}" stroke="${corBorda}" stroke-width="4" />`;
        svg += addYellowLine(centro + largura, meio, 100, meio);
    } else {
        svg += `<line x1="${centro+largura}" y1="${centro}" x2="${centro+largura}" y2="${centro+largura}" stroke="${corBorda}" stroke-width="4" />`;
    }

    // Cruzamento central amarelo (opcional, para conectar as linhas)
    if (isAsfalto) {
        if (conexoes.norte) svg += addYellowLine(meio, centro, meio, meio);
        if (conexoes.sul) svg += addYellowLine(meio, meio, meio, centro + largura);
        if (conexoes.oeste) svg += addYellowLine(centro, meio, meio, meio);
        if (conexoes.leste) svg += addYellowLine(meio, meio, centro + largura, meio);
    }

    svg += `</svg>`;
    
    return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
}


/**
 * Verifica vizinhos para conectar o caminho
 */
function obterConexoesCaminho(index) {
    const gridSize = getGridSize();
    const total = getTotalCells();
    
    // Coordenadas X, Y
    const x = index % gridSize;
    const y = Math.floor(index / gridSize);

    // Tipos que contam como caminho (usamos TIPOS_CAMINHO global)
    const CONSTRUCOES = ['üè†','üèØ','üè∞','‚õ©Ô∏è','üõñ','üïå','üõï'];

    // Helpers para verificar vizinho
    const isPath = (i) => {
        if (i < 0 || i >= total) return false;
        
        const item = jardimData[i];
        if (!item) return false;
        
        // Verifica se o vizinho √© QUALQUER tipo de caminho ou constru√ß√£o
        const ehCaminho = TIPOS_CAMINHO.includes(item.icone);
        const ehConstrucao = CONSTRUCOES.includes(item.icone);

        return ehCaminho || ehConstrucao;
    };

    return {
        norte: (y > 0) && isPath(index - gridSize),
        sul:   (y < gridSize - 1) && isPath(index + gridSize),
        oeste: (x > 0) && isPath(index - 1),
        leste: (x < gridSize - 1) && isPath(index + 1)
    };
}
function gerarSpriteFlor(icone) {
    let svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">`;

    // --- HELPER DE DESENHO DETALHADO ---
    const drawCozyFlower = (x, y, h, s, r, tipo) => {
        let el = `<g transform="translate(${x}, ${y}) scale(${s}) rotate(${r})">`;
        
        // Sombra suave
        el += `<ellipse cx="0" cy="0" rx="7" ry="3" fill="#000" opacity="0.2" />`;

        if (tipo === 'üåª') { 
            // GIRASSOL
            el += `<path d="M0,0 Q-5,${-h/2} 0,${-h}" stroke="#558b2f" stroke-width="4" stroke-linecap="round" />`;
            el += `<path d="M0,-5 Q-12,-8 -10,-15 Q-5,-18 0,-10" fill="#689f38" />`;
            el += `<path d="M0,-5 Q12,-8 10,-15 Q5,-18 0,-10" fill="#689f38" />`;
            el += `<g transform="translate(0, ${-h})">`;
                for(let i=0; i<10; i++) 
                    el += `<ellipse cx="0" cy="0" rx="3.5" ry="12" fill="#fbc02d" transform="rotate(${18 + i*36})"/>`;
                for(let i=0; i<10; i++) 
                    el += `<ellipse cx="0" cy="0" rx="3.5" ry="11" fill="#fdd835" transform="rotate(${i*36})"/>`;
                el += `<circle cx="0" cy="0" r="9" fill="#4e342e" />`;
                el += `<circle cx="0" cy="0" r="7" fill="none" stroke="#5d4037" stroke-width="1" stroke-dasharray="2,2"/>`;
            el += `</g>`;
        }
        else if (tipo === 'üåπ') { 
            // ROSA
            el += `<path d="M0,0 Q3,${-h/2} 0,${-h}" stroke="#2e7d32" stroke-width="3" fill="none" />`;
            el += `<path d="M0,-10 L-7,-12 L-4,-16 Z" fill="#388e3c" />`;
            el += `<path d="M0,-8 L7,-10 L4,-14 Z" fill="#388e3c" />`;
            el += `<g transform="translate(0, ${-h})">`;
                el += `<circle cx="0" cy="2" r="9" fill="#c62828" />`;
                el += `<ellipse cx="-2" cy="-1" rx="7" ry="5" fill="#d32f2f" transform="rotate(-10)" />`;
                el += `<ellipse cx="2" cy="-3" rx="6" ry="4" fill="#e53935" transform="rotate(10)" />`;
                el += `<ellipse cx="0" cy="-4" rx="4" ry="2.5" fill="#ffcdd2" opacity="0.4" />`;
            el += `</g>`;
        }
        else if (tipo === 'üå∑') { 
            // TULIPA
            el += `<path d="M0,0 Q-10,${-h/2} -6,${-h+5}" stroke="#4caf50" stroke-width="4" fill="none" />`;
            el += `<path d="M0,0 Q10,${-h/2} 6,${-h+5}" stroke="#4caf50" stroke-width="4" fill="none" />`;
            el += `<line x1="0" y1="0" x2="0" y2="${-h}" stroke="#66bb6a" stroke-width="3" />`;
            el += `<g transform="translate(0, ${-h})">`;
                el += `<path d="M-6,2 Q-8,12 0,14 Q8,12 6,2 L6,-5 Q0,0 -6,-5 Z" fill="#ef6c00" />`;
                el += `<path d="M-4,3 Q-5,10 0,12 Q5,10 4,3 L0,-6 Z" fill="#ff9800" />`;
                el += `<path d="M0,-6 L0,5" stroke="#ffe0b2" stroke-width="1" opacity="0.5"/>`;
            el += `</g>`;
        }
        el += `</g>`;
        return el;
    };

    // --- DISTRIBUI√á√ÉO "W" DISTORCIDO ---
    // (x, y, altura, escala, rota√ß√£o)

    // 1. Fundo Esquerda (Bem recuada)
    svg += drawCozyFlower(20, 55, 20, 0.8, -15, icone); 

    // 2. Fundo Direita (Mas mais perto que a esquerda)
    svg += drawCozyFlower(85, 65, 23, 0.85, 10, icone); 

    // 3. Meio (Deslocado do centro)
    svg += drawCozyFlower(45, 75, 25, 0.9, -5, icone); 

    // 4. Frente Esquerda (Bem na ponta)
    svg += drawCozyFlower(25, 95, 28, 1.0, -20, icone); 

    // 5. Frente Direita (Recuada em rela√ß√£o √† 4)
    svg += drawCozyFlower(70, 88, 26, 0.95, 15, icone); 

    svg += `</svg>`;
    return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
}

function abrirLoja() {
    // 1. Atualiza quais pets j√° foram comprados e ajusta os pre√ßos
    if (typeof verificarBotoesPetsLoja === 'function') {
        verificarBotoesPetsLoja(); 
    }

    // 2. Atualiza os bot√µes de ativar/desativar temas (Natal, Medieval, etc)
    if (typeof atualizarTogglesTemasLoja === 'function') {
        atualizarTogglesTemasLoja();
    }

    // 3. Garante que o saldo de moedas mostrado na loja est√° atualizado
    if (document.getElementById('saldoLojaMoedas')) {
        document.getElementById('saldoLojaMoedas').textContent = totalMoedas;
    }

    // 4. Abre a janela (Modal) da loja
    abrirModal('lojaOverlay');
}

// ==========================================
</script>
<!-- O sistema de di√°rio antigo foi removido e substitu√≠do pela nova integra√ß√£o. -->

</body>
</html>

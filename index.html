<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
<title>Garden Focus üå±</title>
    
    
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#4caf50">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="https://www.iconpacks.net/icons/2/free-tree-icon-1578-thumb.png">

<!-- PeerJS para conex√£o P2P -->
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

<style>
    /* =========================================
   MODAIS BRASILEIROS CUSTOMIZADOS (NOVO)
   ========================================= */
#statusCoop {
    position: fixed;
    top: 15px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(255, 255, 255, 0.95);
    padding: 8px 15px;
    border-radius: 50px;
    display: none;
    align-items: center;
    gap: 10px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    z-index: 99999;
    border: 2px solid #4CAF50;
    font-family: 'Segoe UI', sans-serif;
    font-size: 14px;
    font-weight: 600;
    color: #333;
    backdrop-filter: blur(5px);
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from { transform: translate(-50%, -50px); opacity: 0; }
    to { transform: translate(-50%, 0); opacity: 1; }
}

/* Plantar Juntos ‚Äî Visual em formato de p√≠lula */
#plantarJuntosOverlay #plantarJuntosContent,
#avisoPlantarJuntosOverlay #avisoPlantarJuntosContent,
#menuPlantasPJOverlay > div,
#confirmacaoResetCodigoOverlay #confirmacaoResetCodigoContent {
    border-radius: 50px;
    padding: 28px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.35); /* Mant√©m profundidade consistente */
    border: 1px solid rgba(255,255,255,0.04);
    background-clip: padding-box; /* garante cantos limpos */
}

#plantarJuntosOverlay button,
#avisoPlantarJuntosOverlay button,
#menuPlantasPJOverlay button,
#plantarJuntosOverlay .secundario {
    border-radius: 50px;
}

#lojaOverlay button,
#lojaOverlay .secundario {
    border-radius: 50px;
}

#lojaOverlay select,
#lojaOverlay input {
    border-radius: 20px;
}

/* Ajustes finos: close buttons */
#lojaOverlay .btn-fechar-modal {
    border-radius: 50%;
    padding: 6px 8px;
}

/* Ajustes finos: setas, close buttons e pequenos widgets */
#plantarJuntosOverlay .btn-fechar-modal,
#menuPlantasPJOverlay .btn-fechar-modal,
#avisoPlantarJuntosOverlay .btn-fechar-modal {
    border-radius: 50%;
    padding: 6px 8px;
}

/* Garante que o popup do timer mantenha o formato p√≠lula quando aninhado */
#btnTimerFlutuantePJ > #popupTimerPJ {
    border-radius: 50px;
}

#statusCoop .indicador {
    width: 10px;
    height: 10px;
    background: #4CAF50;
    border-radius: 50%;
    box-shadow: 0 0 8px #4CAF50;
}

#statusCoop .btn-desconectar {
    background: #ff4757;
    color: white;
    border: none;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 11px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.2s;
}

#statusCoop .btn-desconectar:hover {
    background: #ff2e43;
    transform: scale(1.05);
}

#custom-modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.85); /* Fundo bem escuro para foco */
    z-index: 100000; /* Normalizado para evitar conflitos com outros elementos */
    display: none; align-items: center; justify-content: center;
    backdrop-filter: blur(5px);
    opacity: 0; transition: opacity 0.3s ease;
}

.custom-modal-box {
    background: var(--bg-card, #ffffff);
    padding: 30px; 
    border-radius: 25px;
    width: 85%; max-width: 380px;
    text-align: center;
    box-shadow: 0 20px 60px rgba(0,0,0,0.6);
    border: 4px solid var(--primary-color, #4CAF50);
    transform: translateY(20px) scale(0.9); 
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    font-family: 'Segoe UI', sans-serif;
    position: relative;
    overflow: hidden;
}

/* Efeito de brilho no topo */
.custom-modal-box::before {
    content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 6px;
    background: rgba(255,255,255,0.5);
}

.custom-modal-icon {
    font-size: 50px; margin-bottom: 15px; display: block;
    animation: bounceIn 0.6s;
}

.custom-modal-title { 
    font-size: 1.6em; font-weight: 800; margin-bottom: 12px; 
    color: var(--primary-color, #4CAF50); text-transform: uppercase; letter-spacing: 0.5px;
}

.custom-modal-msg { 
    font-size: 1.1em; margin-bottom: 25px; color: var(--text-color, #444); 
    line-height: 1.5; font-weight: 500;
}

.custom-modal-actions { 
    display: flex; gap: 12px; justify-content: center; 
}

.custom-modal-btn {
    flex: 1; padding: 14px; border: none; border-radius: 50px;
    font-weight: bold; cursor: pointer; font-size: 1em;
    transition: transform 0.2s, filter 0.2s;
    text-transform: uppercase;
    box-shadow: 0 4px 0 rgba(0,0,0,0.1);
}
.custom-modal-btn:active { transform: translateY(2px); box-shadow: none; }

/* Bot√µes Espec√≠ficos */
.btn-modal-confirm { background: var(--primary-color, #4CAF50); color: white; }
.btn-modal-cancel { background: #e0e0e0; color: #555; }
.btn-modal-danger { background: #ff4757; color: white; border: 2px solid #ff2e43; }

/* --- ADAPTA√á√ÉO AOS TEMAS DO JOGO --- */

/* MODO ESCURO */
body.dark-mode .custom-modal-box { 
    background: #2d2d2d; border-color: #66bb6a; color: white; 
}
body.dark-mode .custom-modal-msg { color: #ddd; }
body.dark-mode .btn-modal-cancel { background: #555; color: #fff; }

/* MODO MEDIEVAL */
body.medieval-mode .custom-modal-box { 
    background: #f4e4bc; border: 6px double #8b4513; border-radius: 5px;
    font-family: 'Georgia', serif; 
    box-shadow: 0 20px 50px rgba(0,0,0,0.8);
}
body.medieval-mode .custom-modal-title { color: #5d4037; }

/* MODO CANDYFORNIA */
body.candyfornia-mode .custom-modal-box {
    background: #fff0f5; border: 4px dashed #ff85a2; border-radius: 35px;
}
body.candyfornia-mode .custom-modal-title { color: #ff6bad; }
body.candyfornia-mode .btn-modal-confirm { background: #ff85a2; }

@keyframes bounceIn {
    0% { transform: scale(0); } 50% { transform: scale(1.2); } 100% { transform: scale(1); }
}

    /* Estilo para a Mochila no Menu de Romance */
.romance-backpack {
    background: rgba(255, 255, 255, 0.9);
    border: 2px solid #ffd700;
    border-radius: 12px;
    padding: 5px 10px;
    position: absolute;
    top: 10px;
    left: 10px;
    font-size: 14px;
    font-weight: bold;
    color: #555;
    display: flex;
    align-items: center;
    gap: 5px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

/* Bot√£o Especial de Pedido de Namoro */
.btn-namoro {
    background: linear-gradient(45deg, #d63384, #ff4757);
    color: #ffffff;
    border: 2px solid #fff;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    font-weight: 900;
    animation: pulse 2s infinite;
     }

@keyframes pulse {
    0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.7); }
    70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(255, 71, 87, 0); }
    100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 71, 87, 0); }
}

@keyframes pulsar {
    0%, 100% { opacity: 0.3; }
    50% { opacity: 1; }
}

    body {
  font-family: 'Noto Color Emoji', 'Segoe UI Emoji', 'Apple Color Emoji', sans-serif;
  overflow-x: hidden;
  overflow-y: auto; /* Permite rolagem quando necess√°rio */
  min-height: 100dvh;
  min-height: 100vh; /* Fallback para navegadores que n√£o suportam dvh */
  width: 100%;
  position: relative; /* Evita problemas com elementos fixos no documento */
  touch-action: manipulation; /* Permite rolagem e evita zoom acidental */
  -webkit-tap-highlight-color: transparent;
  margin: 0;
  padding: 0;
}

    /* =========================
   SISTEMA DE ROMANCE
   ========================= */
/* =========================
   ATUALIZA√á√ÉO: SISTEMA DE ROMANCE
   ========================= */

.romance-card {
    background: linear-gradient(135deg, #fff, #f0f8ff);
    border: 3px solid #ff9ebb;
    border-radius:  50px;
    padding: 25px;
    width: 90%;
    max-width: 400px; /* Aumentado levemente */
    text-align: center;
    box-shadow: 0 15px 50px rgba(255, 158, 187, 0.4);
    position: relative;
    font-family: 'Segoe UI', sans-serif;
    display: flex;
    flex-direction: column;
    gap: 10px;
    max-height: 85vh; /* Garante que cabe na tela */
    overflow-y: auto; /* Permite rolagem se o texto for muito grande em telas pequenas */
}

/* NOVO: Caixa de Di√°logo */
.romance-dialogue-box {
    background: rgba(255, 255, 255, 0.8);
    border: 2px dashed #4cc9f0; /* Azul tema marinho */
    border-radius: 15px;
    padding: 15px;
    margin: 5px 0 15px 0;
    min-height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-style: italic;
    color: #003566;
    font-size: 14px;
    line-height: 1.4;
    box-shadow: inset 0 0 15px rgba(76, 201, 240, 0.1);
    position: relative;
}

.romance-dialogue-box::after {
    content: '';
    position: absolute;
    top: -10px;
    left: 50%;
    transform: translateX(-50%);
    border-width: 0 10px 10px 10px;
    border-style: solid;
    border-color: transparent transparent #4cc9f0 transparent;
    display: block;
    width: 0;
}

/* Ajustes nos elementos existentes para ficarem compactos */
.romance-avatar {
    font-size: 60px;
    margin-bottom: 5px;
    animation: floatHeart 3s infinite ease-in-out;
    filter: drop-shadow(0 5px 5px rgba(0,0,0,0.2));
}

.romance-hearts {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin: 5px 0 10px 0;
}

/* Overlay do Menu */
#romanceOverlay {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 29, 61, 0.85);
    z-index: 20000;
    display: none;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(5px);
    animation: romanceFadeIn 0.3s ease;
}






.heart-slot {
    font-size: 24px;
    color: #e0e0e0;
    transition: all 0.3s;
}

.heart-slot.filled {
    color: #ff4757;
    transform: scale(1.1);
    filter: drop-shadow(0 0 5px rgba(255, 71, 87, 0.5));
}

.romance-actions {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
}

.btn-romance {
    background: white;
    border: 2px solid #ff9ebb;
    color: #ff4757;
    padding: 12px;
    border-radius:   50px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
     }

.btn-romance:hover {
    background: #fff0f5;
    transform: translateY(-2px);
}

.btn-casar {
    grid-column: span 2;
    background: linear-gradient(135deg, #ff9ebb, #ff4757);
    color: white;
    border: none;
    margin-top: 10px;
     }

/* Bolha M√°gica (Visual do Parceiro em Terra) */
.bolha-magica {
    position: absolute;
    width: 90%; height: 90%;
    top: 0; left: 0;
    border-radius: 50%;
    background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.8), rgba(135,206,250,0.4));
    box-shadow: inset 0 0 10px rgba(255,255,255,0.8), 0 0 10px rgba(135,206,250,0.5);
    animation: bubbleFloat 4s infinite ease-in-out;
    pointer-events: none;
    z-index: 18; /* Acima do ch√£o, abaixo do pet */
}

@keyframes bubbleFloat {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-8px); }
}

@keyframes romanceFadeIn {
    from { opacity: 0; transform: scale(0.9); }
    to { opacity: 1; transform: scale(1); }
}

    .guia-escolha-popup {
    background: var(--bg-panel, #ffffff);
    border-radius: 20px;
    padding: 30px;
    max-width: 400px;
    width: 90%;
    text-align: center;
    box-shadow: 0 15px 45px rgba(0, 0, 0, 0.2);
    color: var(--text-main, #333);
}

.guia-confirma-popup {
    background: var(--bg-panel, #ffffff);
    border-radius: 20px;
    padding: 30px;
    max-width: 400px;
    width: 90%;
    text-align: center;
    box-shadow: 0 15px 45px rgba(0, 0, 0, 0.2);
    color: var(--text-main, #333);
}

.guia-confirma-popup button {
    background: var(--primary, #4CAF50);
    color: white;
    border: none;
    padding: 12px 35px;
    border-radius:     50px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
}

.guia-confirma-popup button:hover {
    background: var(--accent, #FF9800);
    transform: translateY(-2px);
}
   /* Cora√ß√£o Simples e Pequeno */
.heart-simple {
    position: absolute;
    font-size: 1px; /* Tamanho pequeno fixo */
    pointer-events: none;
    z-index: 1000;
    /* Alinhamento b√°sico para o 3D */
    transform: translate(-50%, -50%) rotateZ(-45deg) rotateX(-90deg);
    animation: heartUpSimple 4s forwards linear;
}

@keyframes heartUpSimple {
    0% { 
        transform: translate(-50%, -50%) rotateZ(-45deg) rotateX(-90deg) translateY(0);
        opacity: 0; 
    }
    10% { opacity: 1; }
    100% { 
        transform: translate(-50%, -50%) rotateZ(-45deg) rotateX(-90deg) translateY(-150px);
        opacity: 0; 
    }
}

/* Toast Base - Adapta-se ao Normal e Noturno automaticamente */
.pet-toast-moderno {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--bg-card, #ffffff);
    color: var(--text-color, #333);
    padding: 15px 25px;
    border-radius: 20px;
    z-index: 10001; /* Normalizado para evitar conflitos com overlays maiores */
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    border: 2px solid var(--primary-color);
    min-width: 280px;
    overflow: hidden;
    animation: toastEntrada 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
}

.toast-content {
    display: flex;
    align-items: center;
    gap: 12px;
}

.toast-icon { font-size: 24px; }

.toast-text {
    display: flex;
    flex-direction: column;
    text-align: left;
}

.toast-text strong { font-size: 14px; color: var(--primary-color); }
.toast-text span { font-size: 13px; opacity: 0.9; }

/* Barrinha de progresso removida (sistema de progress√£o desabilitado) */

/* --- ADAPTA√á√ïES POR TEMA --- */

/* MODO MEDIEVAL (E Noturno Medieval) */
body.medieval-mode .pet-toast-moderno {
    border-radius: 0;
    border: 4px double var(--primary-color);
    background: #f4e4bc; /* Papel antigo */
    color: #5d4037;
    font-family: 'Georgia', serif;
}
body.dark-mode.medieval-mode .pet-toast-moderno {
    background: #3e2723;
    color: #d7ccc8;
}

/* MODO CANDYFORNIA (E Noturno Candy) */
body.candyfornia-mode .pet-toast-moderno {
    border-radius: 30px;
    border-style: dashed;
    background: #fff0f5;
    color: #ff6bad;
}
body.dark-mode.candyfornia-mode .pet-toast-moderno {
    background: #4a1e36;
    color: #ffb7d5;
}

/* Anima√ß√µes */
@keyframes toastEntrada {
    from { opacity: 0; transform: translateX(-50%) translateY(-100px); }
    to { opacity: 1; transform: translateX(-50%) translateY(0); }
}

@keyframes toastBarra {
    from { width: 100%; }
    to { width: 0%; }
}

.pet-toast-moderno.saindo {
    animation: toastSaida 0.5s forwards ease-in;
}

@keyframes toastSaida {
    to { opacity: 0; transform: translateX(-50%) translateY(-100px); }
}

  /* --- BASE DO MODAL (ESTILO NORMAL) --- */
.pet-name-popup {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: var(--bg-card, #ffffff);
    padding: 25px;
    border-radius: 24px;
    box-shadow: 0 15px 50px rgba(0,0,0,0.4);
    z-index: 200000; /* Normalizado para ficar acima de outros overlays */
    text-align: center;
    width: 280px;
    border: 5px solid var(--primary-color, #4CAF50);
    color: var(--text-color, #333);
    animation: popupAparecer 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

/* INPUT: Sempre vis√≠vel independente do tema */
/* O INPUT: Centraliza√ß√£o Absoluta e For√ßa de Contraste */
#petPopupOverlay { z-index: 199999; position: fixed; top: 0; left: 0; width: 100%; height: 100%; }
.pet-name-popup input#tempPetName {
    display: block;
    width: 90%;        /* Ocupa quase toda a largura interna */
    max-width: 240px;  /* Limite para n√£o esticar demais */
    margin: 15px auto; /* AUTO nas laterais centraliza o elemento */
    padding: 12px 0;   /* Padding vertical apenas */
    border: 2px solid var(--primary-color, #4CAF50);
    border-radius: 12px;
    text-align: center; /* Centraliza o texto digitado */
    font-size: 18px;
    background-color: #ffffff;
    color: #1a1a1a; 
    outline: none;
    box-sizing: border-box; /* Garante que o padding n√£o aumente a largura */
}


.pet-name-popup .btn-container {
    display: flex;
    gap: 10px;
    margin-top: 10px;
}

.pet-name-popup button {
    flex: 1;
    background-color: var(--primary-color, #4CAF50);
    color: #ffffff;
    border: none;
    padding: 14px;
    border-radius:     50px;
    cursor: pointer;
    font-weight: bold;
    text-transform: uppercase;
    transition: transform 0.1s;
}

.pet-name-popup button:active { transform: scale(0.95); }
.pet-name-popup button.cancelar { background-color: #888; }

/* --- VERS√ÉO MODO NOTURNO (DARK MODE) --- */
body.dark-mode .pet-toast-moderno,
body.dark-mode .pet-name-popup {
    background: #2d2d2d;
    color: #ffffff;
    box-shadow: 0 15px 50px rgba(0,0,0,0.8);
}

/* --- VERS√ÉO MEDIEVAL --- */
body.medieval-mode .pet-name-popup {
    border-radius: 0px;
    border: 6px double #8b4513;
    background: #f4e4bc; /* Papel pergaminho */
    background-image: radial-gradient(#ead29d 1px, transparent 1px);
    background-size: 20px 20px;
}
body.medieval-mode .pet-name-popup h3 {
    font-family: 'Georgia', serif;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: #5d4037;
}
body.medieval-mode .pet-name-popup button {
    border-radius:     50px;
    background: #5d4037;
    border: 1px solid #3e2723;
}

/* --- VERS√ÉO CANDYFORNIA --- */
body.candyfornia-mode .pet-name-popup {
    border-radius: 40px;
    border: 5px dashed #ff85a2;
    background: #fff0f5;
}
body.candyfornia-mode .pet-name-popup h3 {
    color: #ff6bad;
    font-style: italic;
}
body.candyfornia-mode .pet-name-popup input#tempPetName {
    border-color: #ffb7d5;
}
body.candyfornia-mode .pet-name-popup button {
    border-radius:     50px;
    background: #ff85a2;
}

/* --- VERS√ÉO NATAL --- */
body.natal-mode .pet-name-popup {
    border: 5px solid #e74c3c;
    background: #ffffff;
    /* Adiciona uma borda interna verde */
    outline: 3px solid #27ae60;
    outline-offset: -10px;
}
body.natal-mode .pet-name-popup h3 {
    color: #e74c3c;
}
body.natal-mode .pet-name-popup button {
    background: #e74c3c;
}
body.natal-mode .pet-name-popup button.cancelar {
    background: #27ae60;
}

/* ANIMA√á√ÉO */
@keyframes popupAparecer {
    from { transform: translate(-50%, -50%) scale(0.7); opacity: 0; }
    to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
}


    .loja-secao-titulo {
    grid-column: 1 / -1; /* Ocupa a largura toda do grid */
    text-align: left;
    font-weight: bold;
    font-size: 1.2rem;
    margin: 15px 0 10px 5px;
    color: var(--primary-color);
    border-bottom: 2px solid #eee;
    padding-bottom: 5px;
}

    /* =========================
   ADICIONAR: ESTILOS DOS PETS
   ========================= */

.pet-3d {
    /* Alinhado com emojis e sprites */
    font-size: calc(var(--cell-3d-size) * 0.6); /* Mesmo tamanho que .emoji-3d */
    
    pointer-events: none;
    display: block;
    user-select: none;
    position: absolute;
    left: 50%;
    top: 30%;
    
    /* Mesma transforma√ß√£o que .emoji-3d e .sprite-alinhado */
    transform-origin: center bottom;
    transform: translate(calc(-50% + var(--sprite-offset-x, 0%)), var(--sprite-translate-y, -60%)) rotateZ(-45deg) rotateX(-90deg) scale(var(--sprite-scale, 1));
    
    z-index: 15;
    transition: all 0.5s ease;
    animation: petBounce 1s infinite alternate;
}

.pet-3d.pausado {
    animation-play-state: paused;
}

.btn-carinho-flutuante {
    position: absolute; /* Mudado para absolute para respeitar a rolagem do container pai */
    z-index: 900; /* Abaixo da aba esquerda (1000) */
    background: white;
    border: 1px solid var(--primary);
    border-radius:   50px;
    padding: 3px 6px;
    font-size: 9px;
    font-weight: bold;
    color: var(--primary);
    cursor: pointer;
    box-shadow: 0 3px 8px rgba(0,0,0,0.15);
    white-space: nowrap;
    pointer-events: auto;
    transform: translate(-50%, -100%);
    animation: floatBtnGlobal 2s infinite ease-in-out;
    transition: background 0.2s, color 0.2s, transform 0.2s, opacity 0.3s ease-out;
     }

.btn-carinho-flutuante.fade-out {
    opacity: 0;
    pointer-events: none;
}

.btn-carinho-flutuante:hover {
    background: var(--primary);
    color: white;
    transform: translate(-50%, -110%) scale(1.1);
}

@keyframes floatBtnGlobal {
    0%, 100% { transform: translate(-50%, -100%); }
    50% { transform: translate(-50%, -105%); }
}

/* Ajuste na anima√ß√£o para o pulo ser proporcional ao tamanho menor */
@keyframes petBounce {
    0% { 
        transform: translate(calc(-50% + var(--sprite-offset-x, 0%)), var(--sprite-translate-y, -60%)) rotateZ(-45deg) rotateX(-90deg) scale(var(--sprite-scale, 1));
    }
    100% { 
        transform: translate(calc(-50% + var(--sprite-offset-x, 0%)), calc(var(--sprite-translate-y, -60%) - 5%)) rotateZ(-45deg) rotateX(-90deg) scale(calc(var(--sprite-scale, 1) * 1.02));
    }
}


/* Ajuste para quando o pet estiver se movendo (opcional, para suavidade) */
.cell-3d.has-pet {
    cursor: not-allowed; /* Mostra que n√£o pode plantar aqui */
}

   /* =========================
   AJUSTE ‚Äì PAINEL INTELIGENTE
   CANDYFORNIA + DARK MODE
   ========================= */

body.dark-mode.candyfornia-mode #painelInteligencia {
    background: linear-gradient(
        135deg,
        rgba(90, 58, 74, 0.85),
        rgba(60, 36, 50, 0.85)
    ) ;

    border: 1px solid rgba(255, 133, 162, 0.35);
    color: #f4cbe0;

    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.45);
}

/* Texto principal */
body.dark-mode.candyfornia-mode #painelInteligencia strong {
    color: #ffd6e9;
}

/* Texto secund√°rio */
body.dark-mode.candyfornia-mode #painelInteligencia small {
    color: #e0a9c6;
    opacity: 0.9;
}

/* Probabilidade ALTA */
body.dark-mode.candyfornia-mode #painelInteligencia .probabilidade-alta {
    color: #9be7c4; /* verde menta suave */
}

/* Probabilidade M√âDIA */
body.dark-mode.candyfornia-mode #painelInteligencia .probabilidade-media {
    color: #ffd166; /* amarelo pastel elegante */
}

/* Probabilidade BAIXA */
body.dark-mode.candyfornia-mode #painelInteligencia .probabilidade-baixa {
    color: #ff9aa2; /* rosa coral suave */
}

/* Hover discreto (sem flash) */
body.dark-mode.candyfornia-mode #painelInteligencia:hover {
    transform: translateY(-1px);
    box-shadow: 0 8px 22px rgba(0, 0, 0, 0.55);
}

    /* Estilo do bot√£o bulldoze */
#btnBulldoze {
    background: #ff9800;
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 20px;
    padding: 10px;
    cursor: pointer;
    transition: all 0.2s;
}

#btnBulldoze:hover {
    background: #f57c00;
    transform: translateY(-2px);
}

#btnBulldoze:active {
    transform: translateY(0);
}

/* Anima√ß√£o do tornado 2D */
.tornado-2d {
    position: absolute;
    font-size: 30px;
    z-index: 10;
    pointer-events: none;
    animation: tornadoMove 0.5s linear forwards;
}

@keyframes tornadoMove {
    0% { transform: translateY(0) rotate(0deg); opacity: 0.5; }
    50% { transform: translateY(-20px) rotate(180deg); opacity: 1; }
    100% { transform: translateY(-40px) rotate(360deg); opacity: 0; }
}

/* Anima√ß√£o do tornado 3D */
.tornado-3d {
    position: absolute;
    font-size: calc(var(--cell-3d-size) * 0.6);
    z-index: 20;
    pointer-events: none;
    transform: rotateZ(-45deg) rotateX(-90deg) translateY(calc(var(--cell-3d-size) * -0.46)) scaleY(1);
    animation: tornadoMove3D 0.5s linear forwards;
}

@keyframes tornadoMove3D {
    0% { transform: rotateZ(-45deg) translateY(calc(var(--cell-3d-size) * -0.46)) scaleY(1) rotate(0deg); opacity: 0.5; }
    50% { transform: rotateZ(-45deg) rotateX(-90deg) translateY(calc(var(--cell-3d-size) * -0.56)) scaleY(1.2); opacity: 1; }
    100% { transform: rotateZ(-45deg) rotateX(-90deg) translateY(calc(var(--cell-3d-size) * -0.66)) scaleY(1.4); opacity: 0; }
}
    /* Estilos para Metas */
#btnMetasToggle.ativo {
    border-radius: 18px 18px 0 0;
    box-shadow: none;
    background: #ff9800;
}

#metasContainer {
    background: var(--bg-panel);
    border-radius: 0 0 18px 18px;
    border: 1px solid #ff9800;
    border-top: none;
    padding: 12px;
    display: none;
    flex-direction: column;
    margin-top: -12px;
    max-height: 400px;
    overflow-y: auto;
    box-shadow: 0 10px 20px rgba(0,0,0,0.1);
}

#metasContainer.ativo {
    display: flex;
    animation: expandDown 0.3s ease-out;
}

#metaMotivo, #metaTempo {
    border-radius: 8px;
    border: 1px solid rgba(0,0,0,0.1);
    background: var(--bg-panel);
    color: var(--text-main);
    padding: 5px;
    font-size: 11px;
}
/* =========================
   VARI√ÅVEIS E TEMAS
   ========================= */
:root {
    --bg-body: #f0f7f2;
    --bg-panel: white;
    --text-main: #333;
    --text-secondary: #666;
    --primary: #4caf50;
    --accent: #ffd54f;
    --plot-empty: #daeedb;
    --shadow: rgba(0,0,0,0.05);
    /* VARI√ÅVEIS 3D */
    --grid-color: #8cc63f;
    --grid-border: #7db336;
    --side-color: #8d6e63;
    --bottom-color: #5d4037;
    --cell-3d-size: 75px;
    --scale-3d: 1; /* Nova vari√°vel para escala */
    --inverse-scale-3d: 1; /* Escala inversa para emojis */
}

body.natal-mode {
    --bg-body: #fdfdfd;
    --bg-panel: #ffffff;
    --text-main: #2c3e50;
    --primary: #c62828;
    --accent: #ffd700;
    --plot-empty: #f5f5f5;
    /* 3D NATAL */
    --grid-color: #e8f5e9;
    --grid-border: #c8e6c9;
    --side-color: #d7ccc8;
    --bottom-color: #bcaaa4;
}

body.medieval-mode {
    --bg-body: #3e2723;
    --bg-panel: #5d4037;
    --text-main: #fff8e1;
    --text-secondary: #ffccbc;
    --primary: #8d6e63;
    --accent: #ffb74d;
    --plot-empty: #4e342e;
    --shadow: rgba(0,0,0,0.4);
    /* 3D MEDIEVAL */
    --grid-color: #5d4037;
    --grid-border: #4e342e;
    --side-color: #3e2723;
    --bottom-color: #2d1a1a;
    background-image: url('https://www.transparenttextures.com/patterns/wood-pattern.png');
}

body.dark-mode {
    --bg-body: #1a1d1a;
    --bg-panel: #2d322d;
    --text-main: #e0e0e0;
    --text-secondary: #aaa;
    --primary: #81c784;
    --accent: #ffd54f;
    --plot-empty: #3d453d;
    --shadow: rgba(0,0,0,0.3);
    /* 3D DARK MODE - mant√©m cores do modo claro */
    --grid-color: #8cc63f;
    --grid-border: #7db336;
    --side-color: #8d6e63;
    --bottom-color: #5d4037;
}

body.dark-mode.natal-mode {
    --bg-body: #1a0f0f;
    --bg-panel: #2d1a1a;
    --text-main: #f8f8f8;
    --primary: #e53935;
    --accent: #ffb300;
    --plot-empty: #3d2525;
    /* 3D DARK NATAL - mant√©m cores do modo claro natal */
    --grid-color: #e8f5e9;
    --grid-border: #c8e6c9;
    --side-color: #d7ccc8;
    --bottom-color: #bcaaa4;
}

body.dark-mode.medieval-mode {
    --bg-body: #1a0f0a;
    --bg-panel: #2d1a15;
    --text-main: #f8f8f8;
    --text-secondary: #ffccbc;
    --primary: #8d6e63;
    --accent: #ffb74d;
    --plot-empty: #3d2520;
    --shadow: rgba(0,0,0,0.5);
    /* 3D MEDIEVAL NOTURNO - mant√©m cores do modo medieval claro */
    --grid-color: #5d4037;
    --grid-border: #4e342e;
    --side-color: #3e2723;
    --bottom-color: #2d1a1a;
    background-image: url('https://www.transparenttextures.com/patterns/wood-pattern.png');
}

/* NOVO: Modo Candyfornia - Mundo de Doces Fofo */
body.candyfornia-mode {
    --bg-body: #fff5f7; /* Rosa muito clarinho */
    --bg-panel: #ffffff; /* Branco puro */
    --text-main: #8a4b76; /* Roxo rosado suave */
    --text-secondary: #c97aa0; /* Rosa m√©dio */
    --primary: #ff85a2; /* Rosa fofo */
    --accent: #ffd166; /* Amarelo pastel */
    --plot-empty: #ffe8f0; /* Rosa muito clarinho */
    --shadow: rgba(255, 133, 162, 0.1);
    /* 3D CANDYFORNIA */
    --grid-color: #ffccd5; /* Rosa beb√™ */
    --grid-border: #ffb3c6; /* Rosa mais forte */
    --side-color: #ffafcc; /* Rosa algod√£o doce */
    --bottom-color: #ff8fab; /* Rosa m√©dio */
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="10" cy="10" r="3" fill="%23ffafcc" opacity="0.6"/><circle cx="30" cy="25" r="4" fill="%23ffd166" opacity="0.6"/><circle cx="70" cy="15" r="3" fill="%23ff8fab" opacity="0.6"/><circle cx="85" cy="40" r="3" fill="%23ffafcc" opacity="0.6"/><circle cx="20" cy="60" r="4" fill="%23ffd166" opacity="0.6"/><circle cx="50" cy="80" r="3" fill="%23ff8fab" opacity="0.6"/></svg>');
}

body.dark-mode.candyfornia-mode {
    --bg-body: #3a2432; /* Roxo escuro rosado */
    --bg-panel: #4a2e3f; /* Roxo m√©dio */
    --text-main: #ffcce0; /* Rosa claro */
    --text-secondary: #ff99c8; /* Rosa m√©dio */
    --primary: #ff85a2; /* Rosa fofo (mesmo do modo claro) */
    --accent: #ffd166; /* Amarelo pastel (mesmo) */
    --plot-empty: #5a3a4a; /* Roxo escuro */
    --shadow: rgba(255, 133, 162, 0.2);
    /* 3D CANDYFORNIA NOTURNO */
    --grid-color: #ff8fab; /* Rosa */
    --grid-border: #ff7096; /* Rosa mais forte */
    --side-color: #ffafcc; /* Rosa claro */
    --bottom-color: #e75480; /* Rosa escuro */
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="10" cy="10" r="3" fill="%23ff7096" opacity="0.3"/><circle cx="30" cy="25" r="4" fill="%23ffd166" opacity="0.3"/><circle cx="70" cy="15" r="3" fill="%23ff85a2" opacity="0.3"/><circle cx="85" cy="40" r="3" fill="%23ff7096" opacity="0.3"/><circle cx="20" cy="60" r="4" fill="%23ffd166" opacity="0.3"/><circle cx="50" cy="80" r="3" fill="%23ff85a2" opacity="0.3"/></svg>');
}

/* NOVO: Modo Eurosummer - Ver√£o Italiano Pastel (Old Money Riviera) */
body.eurosummer-mode {
    --bg-body: #f8f9fa; /* Branco Gelo Suave */
    --bg-panel: #ffffff; 
    --text-main: #001d3d; /* Azul Marinho Profundo (Quase Preto para Moedas) */
    --text-secondary: #2c3e50; /* Azul Acinzentado Escuro */
    --primary: #a2d2ff; /* Azul Beb√™ Pastel */
    --accent: #fefae0; /* Creme / Areia Suave */
    --plot-empty: #f1f3f5; /* Cinza muito claro */
    --shadow: rgba(162, 210, 255, 0.15);
    /* 3D EUROSUMMER - RIVIERA PASTEL */
    --grid-color: #e9ecef; /* Cinza Suave */
    --grid-border: #dee2e6; /* Cinza M√©dio */
    --side-color: #f8edeb; /* Rosa Areia P√°lido */
    --bottom-color: #fae1dd; /* Rosa P√°lido Profundo */
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="15" cy="15" r="1.5" fill="%23a2d2ff" opacity="0.2"/><circle cx="45" cy="30" r="2" fill="%23fefae0" opacity="0.3"/><circle cx="75" cy="20" r="1.5" fill="%23a2d2ff" opacity="0.2"/><circle cx="90" cy="50" r="1.5" fill="%23fefae0" opacity="0.3"/><circle cx="25" cy="70" r="2" fill="%23a2d2ff" opacity="0.2"/><circle cx="60" cy="85" r="1.5" fill="%23fefae0" opacity="0.3"/></svg>');
}

body.dark-mode.eurosummer-mode {
    --bg-body: #1a202c; /* Azul Escuro Mate */
    --bg-panel: #2d3748; 
    --text-main: #f8f9fa; 
    --text-secondary: #a2d2ff; 
    --primary: #a2d2ff; 
    --accent: #4a5568; 
    --plot-empty: #171923; 
    --shadow: rgba(0, 0, 0, 0.4);
    /* 3D EUROSUMMER NOTURNO SUAVE - Quase igual ao claro */
    --grid-color: #ced4da; 
    --grid-border: #adb5bd; 
    --side-color: #e9ecef; 
    --bottom-color: #dee2e6; 
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="15" cy="15" r="1.5" fill="%23a2d2ff" opacity="0.1"/><circle cx="45" cy="30" r="2" fill="%23edf2f7" opacity="0.1"/><circle cx="75" cy="20" r="1.5" fill="%23a2d2ff" opacity="0.1"/><circle cx="90" cy="50" r="1.5" fill="%23edf2f7" opacity="0.1"/><circle cx="25" cy="70" r="2" fill="%23a2d2ff" opacity="0.1"/><circle cx="60" cy="85" r="1.5" fill="%23edf2f7" opacity="0.1"/></svg>');
}

/* CORRE√á√ÉO: Estilo espec√≠fico para modo Candyfornia 3D */
body.candyfornia-mode .cell-3d {
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 40 40"><path d="M5 35 L10 30 L15 35 Z" fill="%23ffb3c6" opacity="0.7"/><path d="M25 15 L30 10 L35 15 Z" fill="%23ffb3c6" opacity="0.7"/><circle cx="20" cy="20" r="4" fill="%23ffd166" opacity="0.5"/></svg>');
}

/* Estilo espec√≠fico para modo Eurosummer 3D */
body.eurosummer-mode .cell-3d {
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 40 40"><path d="M5 35 L10 30 L15 35 Z" fill="%23d4a574" opacity="0.6"/><path d="M25 15 L30 10 L35 15 Z" fill="%23d4a574" opacity="0.6"/><circle cx="20" cy="20" r="3" fill="%23ffd700" opacity="0.4"/></svg>');
}

/* NOVO: Modo Fundo do Mar - Mundo Subaqu√°tico */
body.fundo-mar-mode {
    --bg-body: #001d3d; /* Azul Escuro Profundo */
    --bg-panel: #003566; 
    --text-main: #ffffff; 
    --text-secondary: #4cc9f0; /* Ciano */
    --primary: #4cc9f0; /* Ciano Brilhante */
    --accent: #00b4d8; /* Azul Aqu√°tico */
    --plot-empty: #002847; 
    --shadow: rgba(76, 201, 240, 0.2);
    --grid-color: #003566; 
    --grid-border: #4cc9f0; 
    --side-color: #002847; 
    --bottom-color: #001d3d; 
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="15" cy="15" r="2" fill="%234cc9f0" opacity="0.3"/><circle cx="45" cy="30" r="2.5" fill="%2300b4d8" opacity="0.2"/><circle cx="75" cy="20" r="2" fill="%234cc9f0" opacity="0.3"/><circle cx="90" cy="50" r="2" fill="%2300b4d8" opacity="0.2"/><circle cx="25" cy="70" r="2.5" fill="%234cc9f0" opacity="0.3"/><circle cx="60" cy="85" r="2" fill="%2300b4d8" opacity="0.2"/></svg>');
}

body.dark-mode.fundo-mar-mode {
    --bg-body: #000814; 
    --bg-panel: #001d3d; 
    --text-main: #caf0f8; 
    --text-secondary: #90e0ef; 
    --primary: #00b4d8; 
    --accent: #0077b6; 
    --plot-empty: #001427; 
    --shadow: rgba(0, 180, 216, 0.3);
    --grid-color: #001d3d; 
    --grid-border: #00b4d8; 
    --side-color: #001427; 
    --bottom-color: #000814; 
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="15" cy="15" r="2" fill="%2300b4d8" opacity="0.2"/><circle cx="45" cy="30" r="2.5" fill="%230077b6" opacity="0.15"/><circle cx="75" cy="20" r="2" fill="%2300b4d8" opacity="0.2"/><circle cx="90" cy="50" r="2" fill="%230077b6" opacity="0.15"/><circle cx="25" cy="70" r="2.5" fill="%2300b4d8" opacity="0.2"/><circle cx="60" cy="85" r="2" fill="%230077b6" opacity="0.15"/></svg>');
}

/* Estilo espec√≠fico para modo Fundo do Mar 3D */
body.fundo-mar-mode .cell-3d {
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 40 40"><circle cx="10" cy="10" r="3" fill="%234cc9f0" opacity="0.4"/><circle cx="30" cy="25" r="2" fill="%2300b4d8" opacity="0.3"/><circle cx="20" cy="35" r="2.5" fill="%234cc9f0" opacity="0.4"/></svg>');
}

/* BOT√ïES LATERAIS PARA MODO FUNDO DO MAR */
body.fundo-mar-mode #containerMoedas {
    color: #4cc9f0;
}

body.fundo-mar-mode #abaEsquerda h1, 
body.fundo-mar-mode #abaEsquerda h3,
body.fundo-mar-mode #abaEsquerda div {
    color: #ffffff;
}

body.fundo-mar-mode #abaEsquerda button {
    background: #003566;
    color: #4cc9f0;
    border: 1px solid #4cc9f0;
}

body.fundo-mar-mode #abaEsquerda button:hover {
    background: #004080;
    color: #00b4d8;
    transform: translateY(-2px);
}

body.fundo-mar-mode .painel-controle button {
    background: #4cc9f0;
    color: #001d3d;
    border: none;
     }

body.fundo-mar-mode .painel-controle button:hover {
    background: #00b4d8;
}

body.fundo-mar-mode .painel-controle button.secundario {
    background: #003566;
    color: #4cc9f0;
    border: 1px solid #4cc9f0;
}

/* BOT√ïES LATERAIS PARA MODO EUROSUMMER - RIVIERA PASTEL */
body.eurosummer-mode #containerMoedas {
    color: #001d3d; /* Azul Marinho Profundo para Moedas */
}

body.eurosummer-mode #abaEsquerda h1, 
body.eurosummer-mode #abaEsquerda h3,
body.eurosummer-mode #abaEsquerda div {
    color: #001d3d; /* For√ßar cor escura em todo o texto da aba esquerda */
}

body.eurosummer-mode #abaEsquerda button {
    background: #ffffff;
    color: #546e7a;
    border: 1px solid #a2d2ff;
}

body.eurosummer-mode #abaEsquerda button:hover {
    background: #f8f9fa;
    color: #a2d2ff;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(162, 210, 255, 0.2);
}

body.eurosummer-mode .painel-controle button {
    background: #a2d2ff;
    color: #ffffff;
    border: none;
    box-shadow: 0 2px 5px rgba(162, 210, 255, 0.3);
     }

body.eurosummer-mode .painel-controle button:hover {
    background: #90c2ef;
}

body.eurosummer-mode .painel-controle button.secundario {
    background: #ffffff;
    color: #546e7a;
    border: 1px solid #a2d2ff;
}

/* BOT√ïES LATERAIS ESPECIAIS PARA MODO CANDYFORNIA */
body.candyfornia-mode #abaEsquerda button {
    background: linear-gradient(135deg, #ff9ebb, #ff85a2);
    color: white;
    border: none;
    box-shadow: 0 3px 10px rgba(255, 133, 162, 0.3);
    transition: all 0.3s ease;
}

body.candyfornia-mode #abaEsquerda button:hover {
    background: linear-gradient(135deg, #ff85a2, #ff6b8b);
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(255, 133, 162, 0.4);
}

body.candyfornia-mode #abaEsquerda button:active {
    transform: translateY(0);
    box-shadow: 0 2px 5px rgba(255, 133, 162, 0.3);
}

/* BOT√ïES ESPEC√çFICOS DO MENU */
body.candyfornia-mode #btnTodoToggle {
    background: linear-gradient(135deg, #a2e1db, #8bd3cc);
    color: #333;
}

body.candyfornia-mode #btnMetasToggle {
    background: linear-gradient(135deg, #ffd166, #ffc145);
    color: #333;
}

body.candyfornia-mode #btnTrocarSom {
    background: linear-gradient(135deg, #c97aa0, #b5698f);
    color: white;
}

/* BOT√ïES DE CONFIGURA√á√ÉO (OPCIONAL - se quiser mais consistente) */
body.candyfornia-mode .config-card h4 {
    color: #8a4b76;
}

body.candyfornia-mode .ios-switch.on {
    background-color: #ff85a2;
}

/* BOT√ïES DO PAINEL DE CONTROLE (TIMER) */
body.candyfornia-mode .painel-controle button {
    background: linear-gradient(135deg, #ff85a2, #ff6b8b);
    color: white;
     }

body.candyfornia-mode .painel-controle button.secundario {
    background: #ffe8f0;
    color: #8a4b76;
    border: 1px solid #ffb3c6;
}

body.candyfornia-mode .painel-controle button.cancelar {
    background: linear-gradient(135deg, #ff6b6b, #ff5252);
    color: white;
}

/* BOT√ïES DE MODAL */
body.candyfornia-mode .modal-prateleira .item {
    background: #ffe8f0;
    border: 2px solid #ffccd5;
}

body.candyfornia-mode .modal-prateleira .item:hover {
    background: #ffccd5;
    border-color: #ff85a2;
}

body.candyfornia-mode .modal-prateleira .item.selecionado {
    background: #ffccd5;
    border-color: #ff85a2;
    box-shadow: 0 0 10px rgba(255, 133, 162, 0.5);
}

/* BOT√ïES DA LOJA */
body.candyfornia-mode .item-loja button {
    background: linear-gradient(135deg, #ffd166, #ffc145);
    color: #333;
    font-weight: bold;
     }

/* BOT√ïES DO DASHBOARD */
body.candyfornia-mode .dashboard-periodo button {
    background: #ffe8f0;
    color: #8a4b76;
    border: 1px solid #ffb3c6;
}

body.candyfornia-mode .dashboard-periodo button.active {
    background: linear-gradient(135deg, #ff85a2, #ff6b8b);
    color: white;
    border: none;
}

/* BOT√ïES ESPECIAIS */
body.candyfornia-mode #streakBadge {
    background: linear-gradient(135deg, #ffd166, #ffc145);
    color: #333;
    box-shadow: 0 3px 8px rgba(255, 209, 102, 0.3);
}

body.candyfornia-mode #luckyPlantTag {
    background: linear-gradient(135deg, #a2e1db, #8bd3cc);
    color: #333;
}


/* BOT√ïES SUPERIORES (MENU E TEMA) */
body.candyfornia-mode #abrirMenuBtn {
    background: linear-gradient(135deg, #ff85a2, #ff6b8b);
    color: white;
    box-shadow: 0 3px 8px rgba(255, 133, 162, 0.3);
}

body.candyfornia-mode #btnTema {
    background: #ffffff;
    color: #8a4b76;
    border: 1px solid #ffb3c6;
    box-shadow: 0 3px 8px rgba(255, 133, 162, 0.2);
}

body.candyfornia-mode #btnTema:hover {
    background: #ffe8f0;
}

/* TODO LIST E METAS */
body.candyfornia-mode .todo-item {
    background: #ffe8f0;
    border-color: #ffccd5;
}

body.candyfornia-mode .todo-item input[type="checkbox"]:checked + span {
    color: #ff85a2;
}

/* PLOTS NO JARDIM */
body.candyfornia-mode .plot {
    background: #ffe8f0;
    border: 1px solid #ffccd5;
}

body.candyfornia-mode .plot:hover {
    background: #ffccd5;
    border-color: #ff85a2;
}

body.candyfornia-mode .plot.alvo {
    outline-color: #ff85a2;
}

/* C√âLULAS 3D */
body.candyfornia-mode .cell-3d {
    border: 1px solid #ffb3c6;
}

body.candyfornia-mode .cell-3d:hover {
    background-color: #ffccd5;
    border-color: #ff85a2;
}

/* BOT√ïES LATERAIS ROSINHAS - VERS√ÉO SIMPLES */
body.candyfornia-mode #abaEsquerda button {
    background: #ff9ebb;
    color: white;
    border: none;
    box-shadow: 0 3px 8px rgba(255, 158, 187, 0.3);
}

body.candyfornia-mode #abaEsquerda button:hover {
    background: #ff85a2;
    transform: translateY(-2px);
    box-shadow: 0 5px 12px rgba(255, 133, 162, 0.4);
}

/* BOT√ïES ESPECIAIS DO MENU */
body.candyfornia-mode #btnTodoToggle {
    background: #a2e1db;
    color: #333;
}

body.candyfornia-mode #btnMetasToggle {
    background: #ffd166;
    color: #333;
}

body.candyfornia-mode #btnTrocarSom {
    background: #c97aa0;
    color: white;
}

/* CORRE√á√ÉO ESPEC√çFICA PARA BOT√ïES LATERAIS NO MODO CANDYFORNIA */

/* 1. BOT√ïES DO MENU LATERAL - SOBRESCREVER TODOS OS ESTILOS */
body.candyfornia-mode #abaEsquerda button:not(#btnTodoToggle):not(#btnMetasToggle):not(#btnTrocarSom) {
    background: linear-gradient(135deg, #ff9ebb, #ff85a2);
    color: white;
    border: none;
    box-shadow: 0 3px 10px rgba(255, 133, 162, 0.3);
}

body.candyfornia-mode #abaEsquerda button:not(#btnTodoToggle):not(#btnMetasToggle):not(#btnTrocarSom):hover {
    background: linear-gradient(135deg, #ff85a2, #ff6b8b);
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(255, 133, 162, 0.4);
}

/* 2. BOT√ïES ESPEC√çFICOS COM CORES DIFERENTES */
body.candyfornia-mode #btnTodoToggle {
    background: linear-gradient(135deg, #a2e1db, #8bd3cc);
    color: #333;
    border: none;
}

body.candyfornia-mode #btnMetasToggle {
    background: linear-gradient(135deg, #ffd166, #ffc145);
    color: #333;
    border: none;
}

body.candyfornia-mode #btnTrocarSom {
    background: linear-gradient(135deg, #c97aa0, #b5698f);
    color: white;
    border: none;
}

/* 3. REMOVER BORDAS E FUNDOS HERDADOS */
body.candyfornia-mode #abaEsquerda button.secundario {
    background: linear-gradient(135deg, #ff9ebb, #ff85a2);
    color: white;
    border: none;
}

/* 4. SE OS BOT√ïES AINDA N√ÉO FICAREM ROSAS, ADICIONE ESTE BLOCO MAIS ESPEC√çFICO */
body.candyfornia-mode #abaEsquerda button[onclick*="abrirLoja"],
body.candyfornia-mode #abaEsquerda button[onclick*="abrirDashboard"],
body.candyfornia-mode #abaEsquerda button[onclick*="abrirEstante"],
body.candyfornia-mode #abaEsquerda button[onclick*="abrirConfig"] {
    background: linear-gradient(135deg, #ff9ebb, #ff85a2);
    color: white;
    border: none;
    box-shadow: 0 3px 10px rgba(255, 133, 162, 0.3);
}

/* 5. BOT√ïES QUANDO ATIVOS/EXPANDIDOS */
body.candyfornia-mode #btnTodoToggle.ativo {
    background: linear-gradient(135deg, #8bd3cc, #74c5be);
}

body.candyfornia-mode #btnMetasToggle.ativo {
    background: linear-gradient(135deg, #ffc145, #ffb52d);
}


/* =========================
   PAINEL DE INTELIG√äNCIA NO MODO CANDYFORNIA
   ========================= */

/* Cor de fundo e borda azul para o painel */
body.candyfornia-mode #painelInteligencia {
    background: linear-gradient(135deg, rgba(162, 225, 219, 0.25), rgba(135, 206, 250, 0.2));
    border: 1px solid #a2e1db;
    color: #2c5282;
    box-shadow: 0 3px 10px rgba(162, 225, 219, 0.25);
    transition: all 0.3s ease;
    width: fit-content;
    border-radius: 50px;
}

body.candyfornia-mode #painelInteligencia.expandido {
    border-radius: 20px;
}

/* Efeito hover suave */
body.candyfornia-mode #painelInteligencia:hover {
    background: linear-gradient(135deg, rgba(162, 225, 219, 0.35), rgba(135, 206, 250, 0.3));
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(162, 225, 219, 0.35);
}

/* Cores din√¢micas baseadas na probabilidade - ALTA (acima de 70%) */
body.candyfornia-mode #painelInteligencia[style*="border-color:#4caf50"],
body.candyfornia-mode #painelInteligencia[style*="color:#4caf50"] {
    background: linear-gradient(135deg, rgba(102, 204, 255, 0.25), rgba(102, 255, 204, 0.2));
    border: 1px solid #66ccff;
    color: #0066cc;
    box-shadow: 0 3px 10px rgba(102, 204, 255, 0.25);
}

/* Cores din√¢micas - M√âDIA (40-70%) */
body.candyfornia-mode #painelInteligencia[style*="border-color:#ffb74d"],
body.candyfornia-mode #painelInteligencia[style*="color:#ffb74d"] {
    background: linear-gradient(135deg, rgba(255, 204, 102, 0.25), rgba(255, 229, 153, 0.2));
    border: 1px solid #ffcc66;
    color: #cc9900;
    box-shadow: 0 3px 10px rgba(255, 204, 102, 0.25);
}

/* Cores din√¢micas - BAIXA (abaixo de 40%) */
body.candyfornia-mode #painelInteligencia[style*="border-color:#e57373"],
body.candyfornia-mode #painelInteligencia[style*="color:#e57373"] {
    background: linear-gradient(135deg, rgba(255, 153, 153, 0.25), rgba(255, 204, 204, 0.2));
    border: 1px solid #ff9999;
    color: #cc6666;
    box-shadow: 0 3px 10px rgba(255, 153, 153, 0.25);
}

/* Estilo do texto dentro do painel */
body.candyfornia-mode #painelInteligencia strong {
    color: #2c5282;
    font-weight: 700;
}

body.candyfornia-mode #painelInteligencia small {
    color: #4a5568;
    opacity: 0.9;
}

/* Cor espec√≠fica para a tag de probabilidade */
body.candyfornia-mode #painelInteligencia .probabilidade-alta {
    color: #0066cc;
}

body.candyfornia-mode #painelInteligencia .probabilidade-media {
    color: #cc9900;
}

body.candyfornia-mode #painelInteligencia .probabilidade-baixa {
    color: #cc6666;
}

/* Anima√ß√£o sutil para quando o painel √© atualizado */
@keyframes candyfornia-painel-pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.02); }
    100% { transform: scale(1); }
}

body.candyfornia-mode #painelInteligencia.atualizado {
    animation: candyfornia-painel-pulse 0.5s ease;
}

/* Responsividade para mobile no modo Candyfornia */
@media (max-width: 899px) {
    body.candyfornia-mode #painelInteligencia {
        margin: 8px auto;
        padding: 8px 16px;
        font-size: 10px;
        border-radius: 50px;
    }
    
    body.candyfornia-mode #painelInteligencia.expandido {
        border-radius: 20px;
        padding: 12px;
    }
    
    body.candyfornia-mode #painelInteligencia strong {
        font-size: 11px;
    }
}

/* Efeito de brilho para destaque */
body.candyfornia-mode #painelInteligencia.destaque {
    position: relative;
    overflow: hidden;
}

body.candyfornia-mode #painelInteligencia.destaque::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(
        45deg,
        transparent,
        rgba(255, 255, 255, 0.1),
        transparent
    );
    transform: rotate(45deg);
    animation: candyfornia-brilho 3s infinite;
}

@keyframes candyfornia-brilho {
    0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
    100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
}



/* NOVO: Estilos para modo 10x10 */

body.grid-10x10 .plot {
    width: 35px;
    height: 35px;
    border-radius: 8px;
    font-size: 18px;
}


/* Ajustes para 3D 10x10 - Removido para permitir zoom din√¢mico */
body.grid-10x10 .cell-3d {
    width: var(--cell-3d-size);
    height: var(--cell-3d-size);
}

/* Ajuste de altura para 3D 10x10 */
body.grid-10x10 #jardim3D {
    min-height: 400px;
}

/* Ajustes responsivos para mobile 10x10 */
@media (max-width: 899px) {
    
    body.grid-10x10 .plot {
        width: 28px;
        height: 28px;
        font-size: 14px;
    }
    
    body.grid-10x10 #jardim3D {
        min-height: 350px;
    }
}

/* Desktop 10x10 */
@media (min-width: 900px) {
    
    body.grid-10x10 .plot {
        width: 40px;
        height: 40px;
        font-size: 20px;
    }
    
    body.grid-10x10 #jardim3D {
        min-height: 500px;
    }
}





body { 
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
    background: var(--bg-body); 
    margin: 0; 
    color: var(--text-main); 
    transition: all 0.3s; 
    overflow-x: hidden; 
    -webkit-tap-highlight-color: transparent; 
}

/* =========================
   PADRONIZA√á√ÉO VISUAL (Bot√µes, Modais, Hovers)
   ========================= */
button, select, input[type="checkbox"], input[type="text"], input[type="number"] {
    min-height: 44px;
    min-width: 44px;
    border-radius:  50px;
    border: 1px solid rgba(0,0,0,0.1);
    font-family: inherit;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

button {
    border-radius: 50px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 10px 20px;
    font-weight: 600;
    letter-spacing: 0.3px;
    background: var(--primary);
    color: white;
    border: none;
    box-shadow: 0 2px 4px var(--shadow);
}

button:hover {
    filter: brightness(1.1);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px var(--shadow);
}

button:active {
    transform: translateY(0);
    filter: brightness(0.95);
}

button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

button.cancelar, button[style*="background:#e57373"], button[style*="background:#c62828"] {
    background: #ff5252;
    color: white;
}

button.secundario, button[style*="background:#999"], button[style*="background:#eee"] {
    background: rgba(0,0,0,0.05);
    color: var(--text-main);
    border: 1px solid rgba(0,0,0,0.1);
}

body.dark-mode button.secundario, 
body.dark-mode button[style*="background:#999"], 
body.dark-mode button[style*="background:#eee"] {
    background: rgba(255,255,255,0.1);
    color: #eee;
}

button:focus, 
select:focus, 
input:focus {
    outline: 3px solid rgba(76, 175, 80, 0.4);
    outline-offset: 1px;
}

@media (prefers-reduced-motion: reduce) {
    * {
        animation-duration: 0.01ms;
        animation-iteration-count: 1;
        transition-duration: 0.01ms;
    }
}


#bgCanvas { 
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%; 
    pointer-events: none; 
    z-index: 1; 
    display: block;
}

.presente-fall {
    position: fixed; top: -50px; font-size: 32px; z-index: 9999;
    pointer-events: none; animation: fall linear forwards;
}
@keyframes fall { to { transform: translateY(110vh) rotate(360deg); } }

.estrela-conquista {
    position: fixed;
    color: var(--accent);
    text-shadow: 0 0 8px var(--accent);
    z-index: 5;
    pointer-events: none;
    animation: brilharEstrela 3s infinite ease-in-out;
}
@keyframes brilharEstrela { 0%, 100% { opacity: 0.3; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.1); } }

@keyframes zoomInModal {
    from { opacity: 0; transform: scale(0.8); }
    to { opacity: 1; transform: scale(1); }
}

@keyframes zoomOutModal {
    from { opacity: 1; transform: scale(1); }
    to { opacity: 0; transform: scale(0.8); }
}

.modal-anim-in { animation: zoomInModal 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
.modal-anim-out { animation: zoomOutModal 0.2s ease-in forwards; }

#estanteOverlay, #configOverlay, #debugOverlay, #lojaOverlay, #modalPlantaOverlay, #modalLivroInput, #dashboardOverlay, #firstTimeOverlay, #manualFocusOverlay, #cacaNiquelOverlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.6); z-index: 40000; display: none;
    align-items: center; justify-content: center; backdrop-filter: blur(8px);
    transition: all 0.3s ease;
}

#customAlertOverlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.8); z-index: 100000; display: none;
    align-items: center; justify-content: center; backdrop-filter: blur(10px);
    transition: all 0.3s ease;
}

#estanteContent, #configContent, #debugContent, #lojaContent, #modalPlantaContent, #modalLivroInput > div, #customAlertBox, #dashboardContent, #firstTimeContent, #manualFocusContent, #cacaNiquelContent {
    background: var(--bg-panel); width: 95%; max-width: 500px; max-height: 85vh;
    border-radius: 28px; padding: 30px; overflow-y: auto; position: relative;
    box-shadow: 0 20px 50px rgba(0,0,0,0.3);
    border: 1px solid rgba(255,255,255,0.1);
}

/* Loja ‚Äî Visual em formato de p√≠lula */
#lojaOverlay #lojaContent {
    border-radius: 50px;
    padding: 28px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.35);
    border: 1px solid rgba(255,255,255,0.04);
    background-clip: padding-box;
}

.close-btn {
    position: absolute;
    top: 15px;
    right: 15px;
    background: none;
    border: none;
    font-size: 28px; /* Um pouco maior para melhor toque */
    color: var(--text-secondary);
    cursor: pointer;
    line-height: 1;
    padding: 5px;
    transition: color 0.2s;
    z-index: 3001;
}
.close-btn:hover {
    color: var(--primary);
}

@media (max-width: 600px) {
    #estanteContent {
        max-width: 270px; /* Aumentado para 270px para evitar sobreposi√ß√£o (12 * 18px + 2 * 15px padding + margens) */
        padding: 15px;
    }
}

.dashboard-container {
    margin-top: 15px;
}

.dia-semana {
    display: flex;
    align-items: center;
    margin-bottom: 12px;
    gap: 12px;
}

.dia-label {
    width: 20px;
    font-weight: bold;
    font-size: 13px;
    color: var(--text-secondary);
}

.dia-barra-container {
    flex: 1;
    background: var(--bg-body);
    border-radius: 8px;
    height: 20px;
    overflow: hidden;
    position: relative;
}

.dia-barra {
    height: 100%;
    background: linear-gradient(90deg, var(--primary), #66bb6a);
    border-radius: 8px 0 0 8px;
    min-width: 8px;
    transition: width 1s ease-out;
    position: relative;
}

.dia-barra.hoje {
    background: linear-gradient(90deg, var(--accent), #ffca28);
}

.dia-valor {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 12px;
    font-weight: bold;
    color: var(--text-main);
    z-index: 2;
}

.dia-meta {
    position: absolute;
    top: 0;
    width: 2px;
    height: 100%;
    background: rgba(255, 0, 0, 0.3);
}

.dashboard-resumo {
    display: flex;
    justify-content: space-between;
    background: var(--bg-body);
    padding: 15px;
    border-radius: 15px;
    margin-top: 20px;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 10px;
}

.resumo-item {
    text-align: center;
    flex: 1;
    min-width: 80px;
}

.resumo-valor {
    font-size: 24px;
    font-weight: bold;
    color: var(--primary);
}

.resumo-label {
    font-size: 11px;
    color: var(--text-secondary);
    margin-top: 5px;
}

.resumo-valor.meta {
    color: var(--accent);
}

.resumo-valor.total {
    color: #2196f3;
}

.resumo-valor.streak {
    color: #ff5722;
}

.moedas-display-loja {
    background: var(--plot-empty);
    padding: 15px;
    border-radius: 15px;
    font-size: 20px;
    font-weight: bold;
    color: #b8860b;
    margin-bottom: 20px;
}
.loja-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
}
.item-loja {
    background: var(--bg-body);
    padding: 15px;
    border-radius: 15px;
    border: 1px solid var(--shadow);
    text-align: center;
}
.item-loja button { width: 100%; margin-top: 10px; background: #daa520;
     }

.madeira-shelf {
    background: #795548; 
    padding: 10px; 
    border-radius: 0;
    box-shadow: inset 0 0 15px rgba(0,0,0,0.3); 
    margin: 0; 
    position: relative;
}

#listaLivros .madeira-shelf:last-child {
    border-radius: 0 0 8px 8px;
}

.prateleira-interna {
    background: #5d4037; 
    min-height: 80px; 
    display: flex; 
    align-items: flex-end;
    gap: 0; 
    padding: 0 8px; 
    border-bottom: 8px solid #3e2723;
    flex-wrap: wrap;
    justify-content: flex-start;
    width: 100%;
    box-sizing: border-box;
}

.livro {
    width: 24px; 
    border-radius: 2px 2px 0 0; 
    cursor: pointer;
    transition: transform 0.2s; 
    border-left: 2px solid rgba(255,255,255,0.1);
    box-shadow: 1px 0 3px rgba(0,0,0,0.2); 
    display: flex; 
    justify-content: center;
    position: relative;
    flex-shrink: 0;
    margin-right: -1px;
}
.livro:hover { transform: translateY(-5px); filter: brightness(1.1); }
.livro-titulo { 
    writing-mode: vertical-rl; 
    font-size: 7px; 
    color: white; 
    padding: 3px 0px;
    overflow: hidden; 
    text-overflow: ellipsis; 
    white-space: nowrap; 
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.star-rating { font-size: 28px; margin: 10px 0; display: flex; justify-content: center; gap: 5px; cursor: pointer; }
.star-rating .star { color: #ccc; }
.star-rating .star.active { color: var(--accent); }

.modal-prateleira {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 8px;
    padding: 15px 5px;
    background: rgba(0,0,0,0.05);
    border-radius: 15px;
    border-bottom: 4px solid #8d6e63;
    margin-bottom: 15px;
}

.item {
    font-size: 24px;
    width: 42px;
    height: 42px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg-panel);
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s;
    border: 2px solid transparent;
    box-shadow: 0 2px 5px var(--shadow);
    flex-shrink: 0;
}

.item:hover { transform: translateY(-3px); }

@keyframes aproximarSuave {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

.item.selecionado {
    border-color: var(--primary);
    background: var(--plot-empty);
    animation: aproximarSuave 1.5s infinite ease-in-out;
    z-index: 5;
}

#abaEsquerda { 
    position: fixed; 
    top: 70px; 
    left: -300px; 
    width: 280px; 
    max-height: calc(100vh - 100px); 
    background: var(--bg-panel);
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    padding: 15px; 
    box-sizing: border-box; 
    overflow-y: auto; 
    border-radius: 18px;
    transition: left 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
    z-index: 10000;
    display: flex;
    flex-direction: column;
    gap: 12px;
}

#abaEsquerda.aberto { left: 15px; }

/* Estilos para os grupos de bot√µes */
#abaEsquerda > div[style*="flex-direction: column"] {
    animation: slideInUp 0.5s ease-out;
}

@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Melhorias no scrollbar */
#abaEsquerda::-webkit-scrollbar {
    width: 6px;
}

#abaEsquerda::-webkit-scrollbar-track {
    background: transparent;
}

#abaEsquerda::-webkit-scrollbar-thumb {
    background: rgba(76, 175, 80, 0.3);
    border-radius: 3px;
}

#abaEsquerda::-webkit-scrollbar-thumb:hover {
    background: rgba(76, 175, 80, 0.5);
}
/* --- NOVO ESTILO: GRID DE 2 COLUNAS NO MENU --- */
.menu-grid-group {
    display: grid;
    grid-template-columns: 1fr 1fr; /* Cria 2 colunas iguais */
    gap: 10px;
    align-items: start;
    margin-bottom: 15px;
}

/* T√≠tulos das se√ß√µes ocupam a largura total */
.menu-grid-group h4 {
    grid-column: 1 / -1; /* Ocupa de ponta a ponta */
    width: 100%;
    margin: 5px 0 5px 0;
}

/* Pain√©is que abrem (Tarefas/Metas) ocupam a largura total */
.menu-grid-group .todo-container {
    grid-column: 1 / -1;
    width: 100%;
    box-sizing: border-box;
    margin-top: 5px;
}

/* Bot√µes dentro do grid */
.menu-grid-group > button {
    height: 100%; /* Garante altura igual */
    margin: 0;
    min-height: 50px; /* Altura m√≠nima para clique f√°cil */
    font-size: 13px; /* Fonte levemente menor para caber */
    padding: 5px 8px;
    line-height: 1.2;
    display: flex;
    flex-direction: column; /* √çcone em cima do texto (opcional, remove se preferir lado a lado) */
    align-items: center;
    justify-content: center;
    gap: 5px;
}


/* Lista de Tarefas Integrada ao Bot√£o */
.todo-container {
    background: var(--bg-panel);
    border-radius: 12px;
    border: 1px solid rgba(76, 175, 80, 0.2);
    padding: 12px;
    display: none;
    flex-direction: column;
    margin-top: 0;
    max-height: 300px;
    overflow-y: auto;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

.todo-container.ativo {
    display: flex;
    animation: expandDown 0.3s ease-out;
}

@keyframes expandDown {
    from { transform: translateY(-10px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.todo-item {
    display: flex;
    align-items: flex-start; /* Alinha ao topo para quando o texto quebrar linha */
    gap: 8px;
    padding: 8px 0;
    border-bottom: 1px solid rgba(0,0,0,0.05);
}

.todo-item span {
    flex: 1;
    font-size: 11px;
    line-height: 1.4;
    word-break: break-word; /* Quebra palavras longas se necess√°rio */
    white-space: normal;    /* Permite quebra de linha normal */
    padding-top: 2px;       /* Ajuste fino para alinhar com o checkbox */
}

.todo-item input[type="checkbox"] {
    min-width: 16px;
    min-height: 16px;
}

.todo-item button {
    min-width: 24px;
    min-height: 24px;
    padding: 0;
    background: #ff5252;
    font-size: 10px;
    border-radius:     50px;
}

#btnTodoToggle.ativo {
    box-shadow: 0 6px 16px rgba(76, 175, 80, 0.4);
}
#abrirMenuBtn { 
    position: fixed; 
    top: 15px; 
    left: 15px; 
    z-index: 10001; 
    background: var(--accent); 
    color: #333; 
    border-radius: 12px; 
    border: none; 
    width: 45px; 
    height: 45px; 
    cursor: pointer; 
    font-weight: bold;
    font-size: 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

#abrirMenuBtn:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 16px rgba(0,0,0,0.2);
}
#btnTema { 
    position: fixed; 
    top: 15px; 
    right: 15px; 
    z-index: 10001; 
    background: var(--bg-panel); color: var(--text-main); border: 1px solid var(--primary);
    border-radius: 50px; padding: 10px 15px; cursor: pointer; font-weight: bold;
}
#btnCorreioEurosummer { 
    position: fixed; top: 70px; right: 15px; z-index: 900; 
    background: var(--bg-panel); color: var(--text-main); border-radius: 50px; 
    border: 1px solid var(--primary); padding: 8px 12px; cursor: pointer; font-size: 18px;
    transition: all 0.3s;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    width: 45px; height: 45px; display: flex; align-items: center; justify-content: center;
}
#btnCorreioEurosummer:hover { transform: scale(1.1); background: var(--primary); color: white; }

#btnMetasFundoMar { 
    position: fixed; top: 70px; right: 15px; z-index: 900; 
    background: #003566; color: #4cc9f0; border-radius: 50px; 
    border: 1px solid #4cc9f0; padding: 8px 12px; cursor: pointer; font-size: 18px;
    transition: all 0.3s;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    width: 45px; height: 45px; display: flex; align-items: center; justify-content: center;
}
#btnMetasFundoMar:hover { transform: scale(1.1); background: #4cc9f0; color: #001d3d; }

#btnCorreioFundoMar { 
    position: fixed; top: 125px; right: 15px; z-index: 900; 
    background: #003566; color: #4cc9f0; border-radius: 50px; 
    border: 1px solid #4cc9f0; padding: 8px 12px; cursor: pointer; font-size: 18px;
    transition: all 0.3s;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    width: 45px; height: 45px; display: flex; align-items: center; justify-content: center;
}
#btnCorreioFundoMar:hover { transform: scale(1.1); background: #4cc9f0; color: #001d3d; }

#painelMetasFundoMar {
    position: fixed;
    top: 180px;
    right: 15px;
    width: 260px;
    height: 350px;
    background: #003566;
    border: 2px solid #4cc9f0;
    border-radius: 15px;
    z-index: 10000; /* Aumentado para garantir que fique no topo */
    box-shadow: 0 10px 30px rgba(0,0,0,0.4);
    padding: 12px;
    color: white;
    animation: slideInRight 0.3s ease;
    display: flex;
    flex-direction: column;
    box-sizing: border-box;
    overflow: hidden; /* O painel n√£o rola, apenas a lista */
}

@keyframes slideInRight {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

.metas-fundo-mar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    border-bottom: 1px solid rgba(76, 201, 240, 0.3);
    padding-bottom: 8px;
    flex-shrink: 0;
}
#listaMetasFundoMar {
    overflow-y: auto;
    overflow-x: hidden;
    flex: 1;
    padding-right: 5px;
    margin-top: 5px;
    height: calc(100% - 40px); /* For√ßa uma altura calculada */
    display: block;
    scrollbar-width: thin;
    scrollbar-color: #4cc9f0 rgba(0, 53, 102, 0.3);
}
#listaMetasFundoMar::-webkit-scrollbar {
    width: 6px;
}
#listaMetasFundoMar::-webkit-scrollbar-track {
    background: rgba(0, 53, 102, 0.3);
    border-radius: 10px;
}
#listaMetasFundoMar::-webkit-scrollbar-thumb {
    background: #4cc9f0;
    border-radius: 10px;
}

.metas-fundo-mar-header h3 { margin: 0; font-size: 16px; color: #4cc9f0; }
.metas-fundo-mar-header button { background: transparent; border: none; color: #4cc9f0; cursor: pointer; font-size: 18px;
}

.meta-item-fundo {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 8px;
    padding: 8px;
    background: rgba(0, 29, 61, 0.5);
    border-radius: 8px;
    font-size: 13px;
    transition: all 0.2s;
}
.meta-item-fundo.bloqueada {
    filter: blur(3px);
    opacity: 0.5;
    pointer-events: none;
    user-select: none;
}
.meta-item-fundo.proxima {
    filter: none;
    opacity: 1;
    border: 1px dashed #4cc9f0;
}

.meta-item-fundo.concluida {
    opacity: 0.6;
    border-left: 3px solid #4cc9f0;
    background: rgba(76, 201, 240, 0.1);
}

.meta-item-fundo .meta-emoji { font-size: 20px; }
.meta-item-fundo .meta-info { flex: 1; }
.meta-item-fundo .meta-status { font-size: 16px; }




#conteudo { 
    margin-left:0; 
    padding: 10px 20px 250px 20px; 
    text-align:center; 
    transition: margin-left 0.3s; 
    position: relative; 
    z-index: 20; 
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    background: transparent;
    height: 100dvh;
    width: 100dvw;
    box-sizing: border-box;
    justify-content: center;
    /* overflow: hidden; */ /* Removido para permitir que o jardim 3D apare√ßa completamente */
    position: fixed;
    top: 0;
    left: 0;
}

/* DESKTOP: MAIOR GRID E PLOTS GRUDADOS */
@media(min-width: 900px) {
    /* Removido: #abaEsquerda { left: 0; } para manter o menu oculto */
    /* Removido: #conteudo { margin-left: 210px; } para manter o conte√∫do centralizado */
    /* Removido: #abrirMenuBtn { display: none; } para manter o bot√£o vis√≠vel */
    
    /* .painel-controle fixado no bottom */
    
    #jardim3D { 
        order: 2; /* Mapa 3D para cima */
        max-width: 480px; /* Limitar a largura √† altura fixa (480px) para evitar achatamento */
        margin: 20px auto; /* Centralizar */
    }
    #painelMotivo { order: 5; }
    
    /* DESKTOP: HOVER EFFECT PARA SELE√á√ÉO */
    .plot:hover {
        transform: scale(1.05);
        transition: transform 0.2s;
        outline: 2px solid var(--primary);
        outline-offset: 2px;
    }
    
    
}

/* Barra de navega√ß√£o inferior removida: estilos foram limpos e a estrutura da interface n√£o depende mais da barra inferior */
.plot { width: 38px; height: 38px; font-size: 18px; }

/* NOVO: HOVER PARA GRID 2D EM TODOS OS DISPOSITIVOS */
.plot:hover {
    transform: scale(1.03);
    transition: transform 0.2s;
    outline: 2px solid var(--primary);
    outline-offset: 2px;
}

.painel-controle { 
    background: var(--bg-panel); 
    display: inline-block; 
    padding: 20px; 
    border-radius: 25px 25px 0 0; 
    box-shadow: 0 -10px 30px var(--shadow); 
    margin-bottom: 0; 
    width: 100%; 
    max-width: 450px; 
    box-sizing: border-box;
    position: fixed;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1000;
}

body.dark-mode .painel-controle,
body.medieval-mode .painel-controle {
    border: 1px solid rgba(255, 255, 255, 0.1);
}

#painelInteligencia {
    background: rgba(255, 255, 255, 0.9);
    margin: 10px auto;
    padding: 8px 16px;
    border-radius: 50px;
    font-size: 12px;
    width: fit-content;
    max-width: 300px;
    border: 2px solid var(--primary);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    animation: fadeInPainel 0.5s ease-out;
    cursor: pointer;
    overflow: hidden;
    white-space: nowrap;
    user-select: none;
}

#painelInteligencia.expandido {
    border-radius: 20px;
    padding: 15px;
    white-space: normal;
}

@keyframes fadeInPainel {
    from {
        opacity: 0;
        transform: translateY(-5px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

#painelInteligencia:hover {
    box-shadow: 0 6px 16px rgba(0,0,0,0.15);
    transform: translateY(-2px);
}

#painelInteligencia strong {
    display: block;
    font-size: 14px;
    font-weight: 700;
    transition: all 0.3s;
}

#painelInteligencia.expandido strong {
    font-size: 18px;
    margin-bottom: 4px;
}

#painelInteligencia .detalhes-intel {
    max-height: 0;
    opacity: 0;
    overflow: hidden;
    transition: all 0.4s ease;
    text-align: center;
}

#painelInteligencia.expandido .detalhes-intel {
    max-height: 200px;
    opacity: 1;
    margin-top: 8px;
}

#painelInteligencia small {
    display: block;
    opacity: 0.85;
}

#painelInteligencia div[style*="margin-top"] {
    display: flex;
    justify-content: space-around;
    font-size: 10px;
    opacity: 0.75;
    padding-top: 6px;
    border-top: 1px solid rgba(0,0,0,0.1);
}

#timer { font-size: 60px; margin: 10px 0; font-weight: bold; font-family: 'Courier New', monospace; color: var(--text-main); text-align: center; }

/* Estilos de bot√µes legados removidos para usar a nova padroniza√ß√£o */

@keyframes spawn {
    0% { transform: rotateZ(-45deg) rotateX(-90deg) scale(0); }
    70% { transform: rotateZ(-45deg) rotateX(-90deg) scale(1.2); }
    100% { transform: rotateZ(-45deg) rotateX(-90deg) scale(1); }
}
.plant-spawn { animation: spawn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

@keyframes crescer {
    0% { transform: rotateZ(-45deg) rotateX(-90deg) scale(0.5); opacity: 0.7; }
    50% { transform: rotateZ(-45deg) rotateX(-90deg) scale(1.1); opacity: 1; }
    100% { transform: rotateZ(-45deg) rotateX(-90deg) scale(1); opacity: 1; }
}
.crescendo { animation: crescer 0.5s ease-out forwards; }

@keyframes gardenZoomOut {
    0% { transform: scale(1); opacity: 1; }
    40% { transform: scale(0.6); opacity: 0.7; }
    80% { transform: scale(0); opacity: 0; }
    100% { transform: scale(1); opacity: 1; }
}
.zoom-out-effect { animation: gardenZoomOut 2.5s ease-in-out forwards; }

.lucky-plant-tag { 
    font-size: 11px; 
    background: var(--accent); 
    padding: 2px 8px; 
    border-radius: 20px; 
    display: inline-block; 
    margin-bottom: 10px; 
    font-weight: bold; 
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    position: relative;
    z-index: 2;
}
.lucky-glow { filter: drop-shadow(0 0 5px var(--accent)); animation: glowPulse 2s infinite ease-in-out; }

@keyframes glowPulse { 0%, 100% { filter: drop-shadow(0 0 2px var(--accent)); } 50% { filter: drop-shadow(0 0 8px var(--accent)); } }

#modalPlantaContent h3 { margin-top: 0; }
#cacaNiquelContent h2 { margin-top: 0; }
#cacaNiquelContent {
    max-width: 520px;
    max-height: 90vh;
    overflow-y: auto;
    padding: 20px 15px 20px 15px;
    box-sizing: border-box;
}
.slot-reel.spinning {
    animation: slotRoll 1.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
}
#slotLever {
    transition: all 0.2s ease;
}
#slotLever {
    transition: all 0.3s ease;
}
#slotLever:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.4), inset 0 2px 5px rgba(255,255,255,0.3);
    filter: brightness(1.1);
}
#slotLever:hover div:last-child {
    left: 100%;
}
#slotLever:active {
    transform: translateY(0px);
    box-shadow: 0 4px 10px rgba(0,0,0,0.3), inset 0 1px 3px rgba(0,0,0,0.2);
}
@keyframes slotRoll {
    0% {
        transform: translateY(0px);
        opacity: 1;
    }
    10%, 90% {
        transform: translateY(-5px) scale(1.02);
        opacity: 0.9;
    }
    20%, 80% {
        transform: translateY(-10px) scale(1.05);
        opacity: 0.8;
    }
    30%, 70% {
        transform: translateY(-15px) scale(1.08);
        opacity: 0.7;
    }
    40%, 60% {
        transform: translateY(-20px) scale(1.1);
        opacity: 0.6;
    }
    50% {
        transform: translateY(-25px) scale(1.12);
        opacity: 0.5;
    }
    100% {
        transform: translateY(0px) scale(1);
        opacity: 1;
    }
}
.reel-window {
    transition: all 0.3s ease;
    position: relative;
    z-index: 1;
}
.reel-window.winning {
    animation: winningGlow 1s infinite alternate;
    z-index: 2;
}
.reel-overlay {
    z-index: 3;
}
@keyframes winningGlow {
    0% {
        box-shadow: inset 0 0 20px rgba(76, 175, 80, 0.6), 0 0 20px rgba(76, 175, 80, 0.4);
        transform: scale(1.05);
    }
    100% {
        box-shadow: inset 0 0 30px rgba(76, 175, 80, 0.8), 0 0 30px rgba(76, 175, 80, 0.6);
        transform: scale(1.1);
    }
}
.btn-fechar-modal { position: absolute; top: 15px; right: 15px; font-size: 20px; cursor: pointer; color: var(--text-secondary); }

.color-picker { 
    display: flex; 
    justify-content: center; 
    gap: 10px; 
    margin: 15px 0; 
    flex-wrap: wrap; /* Permite que as cores quebrem linha se forem muitas */
    padding: 5px;
}

.color-swatch { 
    width: 32px; 
    height: 32px; 
    border-radius: 50%; 
    cursor: pointer; 
    border: 3px solid rgba(0,0,0,0.1); /* Borda sutil para cores claras */
    transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.color-swatch:hover {
    transform: scale(1.15);
}

.color-swatch.active { 
    border-color: var(--text-color, #333); 
    transform: scale(1.2);
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}

/* Ajuste para Modo Noturno: borda ativa branca */
body.dark-mode .color-swatch.active {
    border-color: #ffffff;
}

.todo-item { display: flex; align-items: center; justify-content: space-between; margin-bottom: 5px; background: rgba(0,0,0,0.03); padding: 5px 10px; border-radius: 8px; font-size: 13px; }
.semana-card { background: var(--bg-body); padding: 15px; border-radius: 15px; margin-bottom: 12px; border-left: 5px solid var(--primary); text-align: left; box-shadow: 0 4px 6px var(--shadow); }
.mini-grind { display: block; margin: 8px 0; font-size: 18px; line-height: 1.4; word-break: break-all; }

.toggle-container { display: flex; align-items: center; justify-content: space-between; background: rgba(0,0,0,0.03); padding: 10px 15px; border-radius: 15px; margin-bottom: 10px; font-size: 14px; }

.secao-estilo {
    background: rgba(0,0,0,0.05);
    border: 1px solid var(--shadow);
    padding: 15px;
    border-radius: 20px;
    margin-bottom: 15px;
    text-align: left;
}
.secao-estilo h4 { margin: 0 0 10px 5px; font-size: 14px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; }

/* Dashboard Unificado */
.dashboard-periodo {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-bottom: 20px;
}

.dashboard-periodo button {
    background: var(--bg-body);
    color: var(--text-main);
    border: 1px solid var(--primary);
}

.dashboard-periodo button.active {
    background: var(--primary);
    color: white;
}

.dashboard-periodo-content {
    display: none;
}

.dashboard-periodo-content.active {
    display: block;
}

/* NOVO: Estilos para a se√ß√£o "Mais usado" no dashboard */
.mais-usado-section {
    background: var(--bg-panel);
    padding: 20px;
    border-radius: 20px;
    margin-top: 25px;
    border-left: 5px solid var(--accent);
    box-shadow: 0 4px 12px var(--shadow);
}

.mais-usado-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 15px;
    color: var(--primary);
    font-size: 16px;
    font-weight: bold;
}

.mais-usado-content {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    justify-content: space-between;
}

.mais-usado-item {
    flex: 1;
    min-width: 140px;
    text-align: center;
    padding: 15px;
    background: var(--bg-body);
    border-radius: 15px;
    border: 1px solid var(--shadow);
}

.mais-usado-emoji {
    font-size: 36px;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 40px;
}

.mais-usado-motivo {
    font-size: 13px;
    color: var(--text-main);
    line-height: 1.4;
    word-break: break-word;
}

.mais-usado-label {
    font-size: 11px;
    color: var(--text-secondary);
    margin-top: 5px;
    display: block;
}

/* NOVO ESTILO: CONFIGURA√á√ïES EM GRID */
.config-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin-bottom: 20px;
}

.config-card {
    background: var(--bg-body);
    border-radius: 16px;
    padding: 18px;
    text-align: center;
    border: 1px solid var(--shadow);
    transition: all 0.2s;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100px;
}

.config-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 15px var(--shadow);
}

.config-card h4 {
    margin: 0 0 10px 0;
    font-size: 14px;
    color: var(--text-main);
}

/* NOVO: Estilo de Switch Arredondado (iOS-style) */
.ios-switch-container {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%; /* Para centralizar no config-card */
    margin-top: 10px; /* Espa√ßamento */
}

.ios-switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 30px;
    background-color: var(--text-secondary); /* Cor de fundo para OFF */
    border-radius: 15px;
    cursor: pointer;
    transition: background-color 0.3s;
}

.ios-switch.on {
    background-color: var(--primary); /* Cor de fundo para ON */
}

.ios-switch-thumb {
    position: absolute;
    top: 2px;
    left: 2px;
    width: 26px;
    height: 26px;
    background-color: white;
    border-radius: 50%;
    transition: transform 0.3s;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
}

.ios-switch.on .ios-switch-thumb {
    transform: translateX(20px);
}

/* Removendo estilos de bot√£o que n√£o ser√£o mais usados */
.config-card button {
    display: none;
}



/* ESTILO DO T√çTULO */
h1 {
    font-family: 'Georgia', 'Times New Roman', serif;
    font-weight: 700;
    font-size: 2.5rem;
    margin-bottom: 5px;
    color: var(--primary);
    letter-spacing: 0.5px;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    cursor: pointer;
    position: relative;
    z-index: 2;
}

/* ESTILO DO BADGE DE STREAK (VERS√ÉO P√çLULA ULTRA COMPACTA) */
#streakBadge {
    background: linear-gradient(90deg, #ff5722, #ff9800);
    color: white;
    padding: 4px 12px;
    border-radius: 50px;
    font-size: 12px;
    line-height: 1;
    min-width: fit-content;
    font-weight: 800;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
    box-shadow: 0 2px 8px rgba(255, 87, 34, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.2);
    cursor: pointer;
    transition: all 0.2s ease;
    position: fixed;
    top: 15px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10002;
}

#streakBadgeSide {
    background: linear-gradient(90deg, #ff5722, #ff9800);
    color: white;
    padding: 6px 15px;
    border-radius: 50px;
    font-size: 13px;
    font-weight: 800;
    display: none;
    align-items: center;
    justify-content: center;
    gap: 5px;
    margin: 10px auto;
    width: fit-content;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(255, 87, 34, 0.3);
}

#streakBadge:hover {
    transform: scale(0.85);
}

/* Ajuste do √≠cone de fogo para n√£o empurrar a p√≠lula */
#streakBadge span {
    font-size: 9px;
}

#streakBadge:hover {
    transform: scale(0.85);
    box-shadow: 0 4px 10px rgba(255, 87, 34, 0.4);
}

/* Ajuste espec√≠fico para o √≠cone/texto dentro dele se necess√°rio */
#streakBadge span {
    font-size: 9px; /* N√∫mero do streak levemente maior que o texto */
}

/* ESTILOS PARA FOTO DE PERFIL */
#profilePhotoContainer {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    overflow: hidden;
    margin: 0 auto 10px;
    background: var(--bg-panel);
    border: 3px solid var(--primary);
    cursor: pointer;
    transition: all 0.3s;
    position: relative;
    box-shadow: 0 4px 12px var(--shadow);
}

#profilePhotoContainer:hover {
    transform: scale(1.05);
    border-color: var(--accent);
}

#profilePhoto {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: none;
}

#profilePhotoPlaceholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 35px;
    background: linear-gradient(135deg, var(--primary), var(--accent));
    color: white;
}

#profilePhotoLabel {
    text-align: center;
    font-size: 11px;
    color: var(--text-secondary);
    margin-bottom: 15px;
    cursor: pointer;
    transition: color 0.3s;
}

#profilePhotoLabel:hover {
    color: var(--primary);
}

#profilePhotoInput {
    display: none;
}

/* NOVO: Estilos para estante com m√∫ltiplos andares */
.prateleira-interna {
    display: flex;
    align-items: flex-end;
    justify-content: flex-start;
    flex-wrap: wrap;
    gap: 0;
}

.livro {
    position: relative;
    flex-shrink: 0;
    transition: all 0.3s ease;
    border-radius: 2px 2px 0 0;
    cursor: pointer;
    overflow: hidden;
    margin-right: -1px;
}

.livro:hover {
    transform: translateY(-5px);
    filter: brightness(1.1);
}

.livro-titulo {
    writing-mode: vertical-rl;
    text-orientation: mixed;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 3px 0px;
}

@media (max-width: 600px) {
    .livro {
        width: 18px;
    }
    
    .livro-titulo {
        font-size: 6px;
    }
}

/* NOVO: Bot√£o de ajuda na estante */
.help-btn {
    position: absolute;
    top: 15px;
    right: 15px;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--primary);
    color: white;
    border: none;
    font-size: 18px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
}

.help-btn:hover {
    background: var(--accent);
    color: #333;
    transform: scale(1.1);
}



/* Estilos para o popup de primeiro uso */
.first-time-step {
    text-align: center;
}

.first-time-step h3 {
    color: var(--primary);
    margin-bottom: 15px;
}

.first-time-step p {
    margin-bottom: 15px;
    line-height: 1.6;
}

.first-time-step ul {
    text-align: left;
    margin: 15px 0;
    padding-left: 20px;
}

.first-time-step li {
    margin-bottom: 8px;
    line-height: 1.5;
}

.first-time-emoji {
    font-size: 40px;
    margin: 15px 0;
    display: block;
}

.first-time-buttons {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-top: 10px;
}

/* =========================
   TUTORIAL INTERATIVO (SIMPLIFICADO)
   ========================= */
#tutorialOverlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 9999;
    display: none;
    justify-content: center;
    align-items: center;
    background: rgba(0, 0, 0, 0.85);
}

#tutorialOverlay.active {
    display: flex;
}

.tutorial-card {
    background: var(--bg-panel);
    border-radius: 24px;
    padding: 30px;
    max-width: 380px;
    width: 90%;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
    animation: tutorialSlideIn 0.4s ease-out;
    text-align: center;
}

@keyframes tutorialSlideIn {
    from { opacity: 0; transform: scale(0.9) translateY(20px); }
    to { opacity: 1; transform: scale(1) translateY(0); }
}

.tutorial-icon {
    font-size: 50px;
    margin-bottom: 15px;
}

.tutorial-title {
    font-size: 20px;
    font-weight: bold;
    color: var(--primary);
    margin-bottom: 15px;
}

.tutorial-text {
    font-size: 15px;
    color: var(--text-main);
    line-height: 1.6;
    margin-bottom: 20px;
}

.tutorial-location {
    background: var(--plot-empty);
    border-radius: 12px;
    padding: 12px 15px;
    margin-bottom: 20px;
    font-size: 13px;
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.tutorial-location strong {
    color: var(--primary);
}

/* Indicadores do tutorial removidos (progress√£o visual desabilitada) */

.tutorial-buttons {
    display: flex;
    gap: 12px;
    justify-content: center;
    margin-bottom: 15px;
}

.tutorial-btn {
    padding: 12px 24px;
    border-radius:  50px;
    border: none;
    font-size: 14px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.2s;
    min-width: 100px;
}

.tutorial-btn-primary {
    background: var(--primary);
    color: white;
}

.tutorial-btn-primary:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
}

.tutorial-btn-secondary {
    background: var(--bg-body);
    color: var(--text-main);
    border: 1px solid var(--shadow);
}

.tutorial-btn-secondary:hover {
    background: var(--plot-empty);
}

.tutorial-btn-skip {
    background: transparent;
    color: var(--text-secondary);
    font-size: 12px;
    padding: 8px 15px;
    width: 100%;
}

.tutorial-btn-skip:hover {
    color: var(--text-main);
}

.tutorial-step-counter {
    font-size: 12px;
    color: var(--text-secondary);
}

/* Estilos para o modal de in√≠cio de foco */
#startFocusModalOverlay {
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%;
    background: rgba(0,0,0,0.8); 
    z-index: 4000; 
    display: none;
    align-items: center; 
    justify-content: center; 
    backdrop-filter: blur(5px);
}

#startFocusModalContent {
    background: var(--bg-panel); 
    width: 95%; 
    max-width: 400px;
    border-radius: 25px; 
    padding: 25px; 
    text-align: center;
    position: relative;
}

.dont-show-again {
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 15px 0;
    gap: 8px;
    font-size: 14px;
    color: var(--text-secondary);
}

.dont-show-again input[type="checkbox"] {
    min-height: 20px;
    min-width: 20px;
    height: 20px;
    width: 20px;
    margin: 0;
    cursor: pointer;
}

.dont-show-again label {
    font-size: 14px;
    cursor: pointer;
    user-select: none;
}

/* =========================
   ESTILOS 3D ISOM√âTRICO - RESPONSIVO
   ========================= */
#jardim3D {
    display: block; /* Sempre vis√≠vel - modo 2D removido */
    position: relative;
    margin-top: 5px;
    width: 100%;
    height: auto;
    min-height: 300px; /* Reduzido para caber em telas menores */
    /* max-height: 50vh; */ /* Removido para permitir altura maior se necess√°rio */
    overflow: visible;
}

.scene-3d {
    perspective: 1200px;
    perspective-origin: 50% 50%;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    transform-origin: center center;
}

.grid-container-3d {
    display: grid;
    grid-template-columns: repeat(5, var(--cell-3d-size));
    grid-template-rows: repeat(5, var(--cell-3d-size));
    gap: 2px;
    transform: rotateX(60deg) rotateZ(45deg) scale(var(--scale-3d, 1)); /* Adicionado scale para ajuste */
    transform-style: preserve-3d;
    position: relative;
    background-color: var(--grid-border);
    padding: 2px;
    transition: all 0.5s ease;
    transform-origin: center center; /* Origem da transforma√ß√£o no centro */
    will-change: transform;
    transition: transform 0.6s cubic-bezier(0.23, 1, 0.32, 1), background-color 0.3s;
}

.cell-3d {
    width: var(--cell-3d-size);
    height: var(--cell-3d-size);
    background-color: var(--grid-color);
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 40 40"><path d="M5 35 L10 30 L15 35 Z" fill="%237db336" opacity="0.7"/><path d="M25 15 L30 10 L35 15 Z" fill="%237db336" opacity="0.7"/></svg>');
    background-size: 40px 40px;
    background-repeat: repeat;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background 0.2s, transform 0.2s;
    position: relative;
    user-select: none;
    transform-style: preserve-3d;
    overflow: visible; /* Garante que o bot√£o de carinho n√£o seja cortado */
}

.cell-3d:hover {
    background-color: color-mix(in srgb, var(--grid-color) 80%, white);
    transform: translateZ(10px);
}

/* Preview layer: mostra a planta selecionada quando o usu√°rio passa o mouse/toca */
.preview-layer {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    pointer-events: none;
    z-index: 200;
}

.preview-sprite {
    /* Mesmo estilo que .emoji-3d e .sprite-alinhado, mas com efeito fantasma */
    font-size: calc(var(--cell-3d-size) * 0.6);
    pointer-events: none;
    display: block;
    user-select: none;
    position: absolute;
    left: 50%;
    top: 30%;
    transform-origin: center bottom;
    transform: translate(calc(-50% + var(--sprite-offset-x, 0%)), var(--sprite-translate-y, -60%)) rotateZ(-45deg) rotateX(-90deg) scale(var(--sprite-scale, 1));
    filter: none;
    z-index: 200;
    transition: all 0.3s ease;
    opacity: 0.5; /* Efeito fantasma */
    width: 100%;
    height: 100%;
}

.preview-sprite.preview-blocked {
    filter: grayscale(80%) brightness(0.6);
    opacity: 0.25;
    transform: translate(calc(-50% + var(--sprite-offset-x, 0%)), var(--sprite-translate-y, -60%)) rotateZ(-45deg) rotateX(-90deg) scale(calc(var(--sprite-scale, 1) * 0.95));
}

.cell-3d.alvo {
    outline: 2px solid rgba(76,175,80,0.25);
    outline-offset: -4px;
    /* Anima√ß√£o removida: sele√ß√£o agora √© est√°tica */
    z-index: 5;
} 

/* Profundidade do bloco (terra) */
.grid-container-3d::before {
    content: '';
    position: absolute;
    top: 100%;
    left: 0;
    width: 100%;
    height: 20px;
    background: var(--side-color);
    transform-origin: top;
    transform: rotateX(-90deg);
}

.grid-container-3d::after {
    content: '';
    position: absolute;
    top: 0;
    left: 100%;
    width: 20px;
    height: 100%;
    background: var(--bottom-color);
    transform-origin: left;
    transform: rotateY(90deg);
}

/* Emojis 3D - TAMANHO AJUSTADO PROPORCIONALMENTE */
.emoji-3d,
.sprite-alinhado {
    font-size: calc(var(--cell-3d-size) * 0.6); /* Tamanho responsivo e proporcional (reduzido para evitar texto grande) */
    pointer-events: none;
    display: block;
    user-select: none;
    position: absolute;
    left: 50%;
    top: 30%;
    transform-origin: center bottom;
    transform: translate(calc(-50% + var(--sprite-offset-x, 0%)), var(--sprite-translate-y, -60%)) rotateZ(-45deg) rotateX(-90deg) scale(var(--sprite-scale, 1));
    filter: none;
    z-index: 10;
    transition: all 0.3s ease;
}

.emoji-3d.lucky-glow {
    filter: drop-shadow(0 0 5px var(--accent));
    animation: glowPulse 2s infinite ease-in-out;
}

.emoji-3d.crescendo {
    animation: crescer 0.5s ease-out forwards;
}

/* Miniatura para √°rvores na paleta 2D */
.tree-thumb {
    width: 60%;
    height: auto;
    display: block;
    margin: 2% auto 0 auto;
    transform: translateY(-4%);
}



/* CORRE√á√ÉO: Estilo espec√≠fico para modo Natal - apenas altera background-image */
body.natal-mode .cell-3d {
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 40 40"><path d="M5 35 L10 30 L15 35 Z" fill="%23cccccc" opacity="0.7"/><path d="M25 15 L30 10 L35 15 Z" fill="%23cccccc" opacity="0.7"/></svg>');
}

/* Ajustes para grid 10x10 no 3D */
body.grid-10x10 #jardim3D {
    min-height: 400px;
    max-height: 85vh;
}

body.grid-10x10 .grid-container-3d {
    grid-template-columns: repeat(10, var(--cell-3d-size));
    grid-template-rows: repeat(10, var(--cell-3d-size));
}

/* Responsividade 3D - MOBILE PRIORITY */
@media (max-width: 899px) {
    :root {
        --cell-3d-size: 12vw; /* Usando viewport width para ser responsivo */
    }
    
    #jardim3D {
        height: 70vw; /* Altura proporcional √† largura */
        max-height: 70vh;
        min-height: 250px;
    }
    
    .grid-container-3d {
        transform: rotateX(60deg) rotateZ(45deg) scale(0.9); /* Escala menor em mobile */
    }
    
    /* Grid 10x10 em mobile */
    body.grid-10x10 #jardim3D {
        height: 85vw;
        max-height: 80vh;
    }
    
    body.grid-10x10 .grid-container-3d {
        transform: rotateX(60deg) rotateZ(45deg) scale(0.8);
    }
}

/* Responsividade 3D - TABLET */
@media (min-width: 600px) and (max-width: 899px) {
    :root {
        --cell-3d-size: 14vw;
    }
    
    #jardim3D {
        height: 65vw;
        max-height: 65vh;
    }
    
    .grid-container-3d {
        transform: rotateX(60deg) rotateZ(45deg) scale(1);
    }
    
    body.grid-10x10 #jardim3D {
        height: 80vw;
    }
}

/* Responsividade 3D - DESKTOP */
@media (min-width: 900px) {
    :root {
        --cell-3d-size: 16vw; /* Ajustado para responsivo */
    }
    
    #jardim3D {
        height: 60vw;
        max-height: 620px;
        max-width: 800px;
        margin: 20px auto;
    }
    
    .grid-container-3d {
        transform: rotateX(60deg) rotateZ(45deg) scale(1.1);
    }
    
    /* Grid 10x10 em desktop */
    body.grid-10x10 #jardim3D {
        height: 65vw;
        max-height: 550px;
    }
    
    body.grid-10x10 .grid-container-3d {
        transform: rotateX(60deg) rotateZ(45deg) scale(1);
    }

    /* Ajuste para controles de zoom n√£o colidirem com o painel */
    #controlesZoom3D {
        bottom: 50px;
        left: auto;
        right: auto;
        transform: none;
        width: auto;
    }
    #controlesZoom3D > div {
        flex-direction: column;
    }
}

/* Ajustes para telas muito pequenas (celulares antigos) */
@media (max-width: 360px) {
    :root {
        --cell-3d-size: 14vw;
    }
    
    #jardim3D {
        height: 75vw;
        max-height: 75vh;
    }
    
    .grid-container-3d {
        transform: rotateX(60deg) rotateZ(45deg) scale(0.8);
    }
    
    body.grid-10x10 #jardim3D {
        height: 90vw;
    }
}

/* Ajustes para orienta√ß√£o paisagem (landscape) */
@media (max-height: 600px) and (orientation: landscape) {
    #jardim3D {
        height: 50vh;
        max-height: 50vh;
    }
    
    .grid-container-3d {
        transform: rotateX(60deg) rotateZ(45deg) scale(0.8);
    }
    
    body.grid-10x10 #jardim3D {
        height: 60vh;
    }
}

/* Classe para for√ßar redimensionamento quando necess√°rio */
.grid-container-3d.ajustado {
    transform: rotateX(60deg) rotateZ(45deg) scale(var(--scale-3d, 1));
}

/* Bot√£o de altern√¢ncia 3D removido - sempre 3D */
/* Estilo para bot√µes desabilitados */
.ios-switch.disabled {
    opacity: 0.5;
    cursor: not-allowed;
    pointer-events: none;
}

.ios-switch.disabled .ios-switch-thumb {
    background-color: #cccccc;
}

.ios-switch.disabled.on {
    background-color: #cccccc;
}
/* =========================
   ESTILOS DO INVENT√ÅRIO
   ========================= */
#inventarioOverlay {
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%;
    background: rgba(0,0,0,0.6); 
    z-index: 3000; 
    display: none;
    align-items: center; 
    justify-content: center; 
    backdrop-filter: blur(8px);
    transition: all 0.3s ease;
}

#inventarioContent {
    background: var(--bg-panel); 
    width: 95%; 
    max-width: 500px; 
    max-height: 85vh;
    border-radius: 28px; 
    padding: 30px; 
    overflow-y: auto; 
    position: relative;
    box-shadow: 0 20px 50px rgba(0,0,0,0.3);
    border: 1px solid rgba(255,255,255,0.1);
}

/* CORRE√á√ÉO: Invent√°rio acima de tudo (Menu √© 10000, Avisos s√£o 20000) */
#inventarioOverlay {
    z-index: 25000; 
}

/* Ajuste para o conte√∫do do invent√°rio */
#inventarioContent {
    z-index: 25001;
    max-height: 80vh; /* Garante que cabe na tela */
    display: flex;
    flex-direction: column;
}

#listaInventario {
    overflow-y: auto;
    padding-bottom: 20px;
    flex: 1; /* Ocupa o espa√ßo restante */
}

/* Garante que o input de venda n√£o fique espremido */
.controle-venda-container {
    display: flex; 
    gap: 8px; 
    align-items: center; 
    justify-content: center;
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid rgba(0,0,0,0.05);
}
/* Estilo para o Contador de Dias Consecutivos */
.streak-display {
    position: fixed; /* Garante que fique fixo na tela */
    top: 15px;       /* Dist√¢ncia do topo */
    left: 50%;       /* Posiciona no meio horizontal */
    transform: translateX(-50%); /* Centraliza perfeitamente */
    z-index: 10000;  /* Garante que fique acima do cen√°rio e modais */
    
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    
    background: rgba(255, 255, 255, 0.95);
    padding: 8px 20px;
    border-radius: 30px;
    border: 2px solid #ff7f50; /* Cor de destaque (fogo/laranja) */
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    font-weight: bold;
    color: #333;
    font-size: 16px;
    pointer-events: none; /* Permite clicar atrav√©s dele se necess√°rio */
    white-space: nowrap; /* Impede que o texto quebre em telas pequenas */
}

/* √çcone de fogo animado */
.streak-icon {
    font-size: 1.2em;
    animation: pulseFire 1.5s infinite alternate;
}

@keyframes pulseFire {
    from { transform: scale(1); filter: brightness(100%); }
    to { transform: scale(1.2); filter: brightness(120%); }
}

/* Ajuste espec√≠fico para Telas Muito Pequenas (iPhone SE, Galaxy Fold fechado) */
@media (max-width: 350px) {
    .streak-display {
        font-size: 13px;
        padding: 5px 12px;
        top: 10px;
    }
}
/* --- CORRE√á√ÉO: DIAS CONSECUTIVOS NO TOPO FIXO --- */
/* VERS√ÉO "GORDINHA" DO CONTADOR */
#streakBadge {
    position: fixed;
    top: 15px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10000;

    /* Visual mais robusto (gordinho) */
    background: linear-gradient(135deg, #ff5722, #ff9800);
    color: white;
    padding: 10px 22px;    /* Mais estofado nas laterais e altura */
    border-radius: 50px;   /* Totalmente arredondado */
    font-size: 14px;       /* Fonte levemente maior */
    font-weight: 900;       /* M√°ximo peso da fonte (negrito pesado) */
    
    display: inline-flex;
    align-items: center;
    gap: 8px;
    
    /* Sombra mais forte para parecer que flutua */
    box-shadow: 0 6px 20px rgba(255, 87, 34, 0.4);
    border: 2px solid rgba(255, 255, 255, 0.4);
    
    text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
    letter-spacing: 0.5px;
}

/* √çcone de fogo um pouco maior */
#streakBadge span {
    font-size: 1.2em;
}

#streakBadge:hover {
    transform: translateX(-50%) scale(1.05); /* Efeito de zoom mantendo o centro */
}

/* Ajuste fino para telas MUITO pequenas (tipo Galaxy Fold fechado ou Z Flip Cover Screen) */
@media (max-width: 380px) {
    #streakBadge {
        font-size: 10px;
        padding: 4px 10px;
        top: 10px;
    }
    .painel-controle {
        padding: 8px 5px;
        width: 98%;
        margin-top: 5px;
    }
    #timer {
        font-size: 32px;
        margin: 2px 0;
    }
    #mainButtons button {
        font-size: 11px;
        padding: 8px 4px;
    }
    #tempoEscolhido, #motivoEscolhido {
        font-size: 11px;
        min-width: 65px;
        padding: 2px;
    }
    /* Ajuste para telas quadradas ou curtas (Z Flip Cover Screen) */
    @media (max-height: 500px) or (max-aspect-ratio: 1/1) {
        #conteudo {
            padding-top: 60px;
            padding-bottom: 100px; /* Espa√ßo extra no final para garantir scroll */
            height: auto;
            min-height: 100vh;
            overflow: visible;
        }
        
        .painel-controle {
            margin-top: 15px;
            margin-bottom: 30px;
            width: 95%;
            max-width: 350px;
        }
        #timer {
            font-size: 40px;
        }
    }
}
/* Container principal para o efeito */
.grid-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: #000; /* Fundo preto profundo */
    overflow: hidden;
    z-index: -1; /* Fica atr√°s de toda a interface do jogo */
}

/* Cria a perspectiva 3D */
.grid-perspective {
    position: absolute;
    width: 100%;
    height: 200%;
    bottom: 0;
    perspective: 500px;
}

/* As linhas do grid */
.grid-lines {
    position: absolute;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    background-image: 
        linear-gradient(to right, rgba(0, 255, 255, 0.3) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(0, 255, 255, 0.3) 1px, transparent 1px);
    background-size: 50px 50px; /* Tamanho dos quadrados */
    transform: rotateX(60deg);
    transform-origin: center bottom;
    animation: moveGrid 2s linear infinite; /* Faz o grid andar */
}

/* Efeito de brilho/n√©on nas linhas */
.grid-lines::after {
    content: "";
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    box-shadow: inset 0px 0px 100px 50px rgba(0, 0, 0, 0.9); /* Suaviza as bordas */
}

/* Overlay para criar o gradiente de horizonte (roxo/azul) */
.grid-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(to bottom, 
        rgba(0, 0, 0, 1) 0%, 
        rgba(0, 0, 0, 0.5) 50%, 
        rgba(75, 0, 130, 0.2) 100%);
    pointer-events: none;
}

/* Anima√ß√£o para dar movimento ao grid */
@keyframes moveGrid {
    from { background-position: 0 0; }
    to { background-position: 0 50px; }
}
/* ============================================================
   REESTRUTURA√á√ÉO MOBILE DEFINITIVA (GARDEN FOCUS)
   ============================================================ */

@media (max-width: 899px) {
    /* 1. FOR√áAR ORDEM E FLUXO (GRID ACIMA DE TUDO) */
    #conteudo {
        display: flex;
        flex-direction: column;
        height: auto;
        min-height: 100vh;
        padding-top: 60px; /* Espa√ßo reduzido para Streak e Bot√µes */
        padding-bottom: 80px;
        justify-content: flex-start;
        align-items: center;
        gap: 0; /* Controle manual de margens */
    }

    /* Move o Jardim para o topo absoluto dentro do container */
    #jardim3D { 
        order: -1; 
        margin: 10px auto 20px auto;
    }

    /* 2. AMPLIA√á√ÉO F√çSICA DO GRID (Aumenta o tamanho real) */
    /* Grid Normal (5x5) */
    
    /* Grid Denso (10x10) - Amplia√ß√£o M√°xima para Mobile */
    
    /* 3. CORRE√á√ÉO DO PAINEL INTELIGENTE E CONTROLES */
    .painel-controle {
        order: 1;
        width: 98%;
        max-width: 400px;
        padding: 10px 5px;
        margin: 0 auto;
        box-sizing: border-box;
    }

    #timer {
        font-size: 45px;
        margin: 5px 0;
    }

    #mainButtons button {
        padding: 10px 5px;
        font-size: 13px;
    }

    #painelInteligencia {
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
        font-size: 12px;
        padding: 8px;
        white-space: normal;
        height: auto;
        margin-bottom: 10px;
    }

    /* 4. CORRE√á√ÉO DO STREAK E BOT√ïES DE TOPO */
    #streakBadge {
        display: inline-flex;
    }
    #streakBadgeSide {
        display: none;
    }

    /* 5. ELIMINAR ESPA√áO VAGO */
    #painelMotivo {
        order: 2;
        margin-top: 10px;
    }
}

/* 6. MODO PAISAGEM (LANDSCAPE) - ROLAGEM OBRIGAT√ìRIA */
@media (max-height: 500px) {
    body, html { overflow: auto; height: auto; }
    #conteudo { height: auto; display: flex; }
}

/* 7. GARANTIA DE CAMADAS (Z-INDEX) */
#estanteOverlay, #configOverlay, #lojaOverlay, #romanceOverlay, #customAlertOverlay {
    z-index: 40000;
}

/* Efeito de Zoom ao Tocar (Feedback) */
.plot:active {
    transform: scale(1.15);
    z-index: 50;
}
/* LIVRO SIMPLES NO CANTO */
.livro-clicavel {
    position: fixed;
    bottom: 20px;
    right: 20px;
    font-size: 40px;
    cursor: pointer;
    z-index: 9999;
    background: #5d4037;
    padding: 10px;
    border-radius: 10px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.5);
}

/* ABA ESQUERDA - √ÅREA DE ESCREVER */
.bloco-diario-input {
    background: rgba(0,0,0,0.2);
    padding: 10px;
    border-radius: 8px;
    margin: 10px 0;
}

.bloco-diario-input textarea {
    width: 100%;
    height: 60px;
    margin: 5px 0;
    border-radius: 5px;
    border: none;
    padding: 5px;
}

/* MODAL DO DI√ÅRIO */
.modal-diario {
    display: none;
    position: fixed;
    top:0; left:0; width:100%; height:100%;
    background: rgba(0,0,0,0.9);
    z-index: 10000;
    color: #333;
    justify-content: center;
    align-items: center;
}

.caderno-folha {
    background: #fff;
    width: 90%;
    max-width: 400px;
    height: 70vh;
    padding: 20px;
    border-radius: 5px;
    overflow-y: auto;
}
/* =========================
   CAMADA DA ESTRADA (CORRE√á√ÉO)
   ========================= */
.path-layer {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-size: cover;
    background-repeat: no-repeat;
    pointer-events: none; /* Deixa clicar atrav√©s da estrada */
    z-index: 1; /* Fica logo acima do ch√£o, mas abaixo de pets/itens */
    transform-style: preserve-3d;
}

/* Removemos a borda e o fundo espec√≠fico da c√©lula base quando √© caminho, 
   para garantir que o estilo do tema (grama/cor) prevale√ßa */
.cell-3d.is-path {
    border-color: rgba(0,0,0,0.05); 
}

/* Estilos para as abas do Plantar Juntos */
.tab-active {
    background: var(--primary);
    color: white;
    border: 2px solid var(--primary);
}


</style>
</head>
<body id="mainBody">



<canvas id="bgCanvas"></canvas>
<div id="starsContainer"></div>




<!-- Novo overlay para primeiro uso -->
<div id="firstTimeOverlay" style="display: none;">
    <div id="firstTimeContent">
        <button style="border-radius: 50px;" class="close-btn" onclick="pularPrimeiroUso()">√ó</button>
        <div id="firstTimeStep2" class="first-time-step" style="display: block;">
            <div class="first-time-emoji">üë§</div>
            <h3>Como gostaria de ser chamado?</h3>
            <p>Digite seu nome abaixo para personalizar sua experi√™ncia:</p>
            
            <input type="text" id="firstTimeNameInput" placeholder="Seu nome..." style="width: 90%; padding: 12px; border-radius: 10px; border: 2px solid var(--primary); font-size: 16px; margin: 15px 0;">
            
            <div class="first-time-buttons">
                <button style="border-radius: 50px;" onclick="finalizarPrimeiroUso()">Come√ßar a focar!</button>
            </div>
        </div>
    </div>
</div>

<!-- TUTORIAL INTERATIVO (SIMPLIFICADO) -->
<div id="tutorialOverlay" style="display: none;">
    <div class="tutorial-card" id="tutorialCard">
        <div class="tutorial-icon" id="tutorialIcon">üå±</div>
        <div class="tutorial-title" id="tutorialTitle">Bem-vindo!</div>
        <div class="tutorial-text" id="tutorialText">Texto do tutorial</div>
        <div class="tutorial-location" id="tutorialLocation" style="display: none;">
            üìç <span id="tutorialLocationText">Localiza√ß√£o</span>
        </div>
        <div class="tutorial-buttons">
            <button style="border-radius: 50px;" class="tutorial-btn tutorial-btn-secondary" id="tutorialPrevBtn" onclick="tutorialAnterior()">Anterior</button>
            <button style="border-radius: 50px;" class="tutorial-btn tutorial-btn-primary" id="tutorialNextBtn" onclick="tutorialProximo()">Pr√≥ximo</button>
        </div>
        <button style="border-radius: 50px;" class="tutorial-btn tutorial-btn-skip" id="tutorialSkipBtn" onclick="tutorialPular()">Pular Tutorial</button>
        <div class="tutorial-step-counter" id="tutorialStepCounter">Passo 1 de 5</div>
    </div>
</div>

<!-- Modal para in√≠cio de foco -->
<div id="startFocusModalOverlay">
    <div id="startFocusModalContent" class="modal-anim-in">
        <h3 style="color: var(--primary); margin-top:0;">Hora de focar! Boa sess√£o! ‚è±Ô∏è</h3>
        
        <div style="display:flex; gap:10px; margin-top:15px;">
    <button 
        class="secundario"
        onclick="closeStartFocusModal(false)"
        style="width:100%; border-radius: 50px;">
        Cancelar
    </button>

    <button 
        onclick="closeStartFocusModal(true)"
        style="width:100%; border-radius: 50px;">
        Iniciar agora
    </button>
</div>
    </div>
</div>

<!-- NOVO: Modal para adicionar foco manual -->
<div id="aviso3DOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 5000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px);">
    <div id="aviso3DContent" style="background: var(--bg-panel); width: 90%; max-width: 400px; border-radius: 25px; padding: 25px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
        <h3 style="color: var(--accent); margin-top: 0;">Aviso: Modo 3D Experimental</h3>
        <p>O modo 3D √© uma funcionalidade nova e pode apresentar instabilidades ou consumir mais recursos do seu dispositivo.</p>
        <p>Se notar lentid√£o ou erros, por favor, volte para o modo 2D.</p>
        <button onclick="fecharAviso3D()" style="margin-top: 15px; border-radius: 50px;">Entendi, Continuar</button>
    </div>
</div>

<div id="manualFocusOverlay">
    <div id="manualFocusContent">
        <h3 style="color: var(--primary); margin-top:0;">Adicionar Foco Manual</h3>
        <p id="manualFocusText" style="margin: 20px 0;">Aviso: adicionar imediatamente um foco em <strong id="manualMotivo">[motivo]</strong> por <strong id="manualTempo">[tempo]</strong> min?</p>
        <div style="display: flex; justify-content: center; gap: 10px;">
            <button onclick="confirmarFocoManual()" style="flex:1; border-radius: 50px;">Ok</button>
            <button onclick="fecharModal('manualFocusOverlay')" class="secundario" style="flex:1; border-radius: 50px;">Cancelar</button>
        </div>
    </div>
</div>

<audio id="audioChuva" loop>
    <source src="data:audio/wav;base64,UklGRmSBAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YX6BAAA=" type="audio/wav">
</audio>
<audio id="audioVento" loop>
    <source src="data:audio/wav;base64,UklGRmSBAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YX6BAAA=" type="audio/wav">
</audio>

<div id="dashboardOverlay">
    <div id="dashboardContent">
        <h2 style="color: var(--primary)">üìä Painel de Foco</h2>
        <div class="dashboard-periodo">
            <button style="border-radius: 50px;" onclick="mostrarDashboardPeriodo('semanal')" id="btnDashboardSemanal" class="active">Semanal</button>
            <button style="border-radius: 50px;" onclick="mostrarDashboardPeriodo('mensal')" id="btnDashboardMensal">Mensal</button>
            <button style="border-radius: 50px;" onclick="mostrarDashboardPeriodo('anual')" id="btnDashboardAnual">Anual</button>
            <button style="border-radius: 50px;" onclick="mostrarDashboardPeriodo('grid3d')" id="btnDashboardGrid3d">Floresta 3D</button>
        </div>
        <div class="dashboard-container" id="dashboardContainerSemanal"></div>
        <div class="dashboard-container" id="dashboardContainerMensal" style="display: none;"></div>
        <div class="dashboard-container" id="dashboardContainerAnual" style="display: none;"></div>
        <div class="dashboard-container" id="dashboardContainerGrid3d" style="display: none; min-height: 450px; position: relative; overflow-x: auto; overflow-y: hidden; background: var(--bg-body); border-radius: 20px; padding: 20px;"></div>
        <button onclick="fecharModal('dashboardOverlay')" class="secundario" style="width:100%; margin-top:20px; border-radius: 50px;">Fechar Painel</button>
    </div>
</div>



<div id="debugOverlay">
    <div id="debugContent">
        <h2 style="color: var(--primary)">üõ†Ô∏è Painel de Testes (Debug)</h2>
        <div style="display: flex; flex-direction: column; gap: 10px;">
            <button onclick="fillGridTest()" style="background: #2196f3; border-radius: 50px; ">Preencher Todo o Grid (Ciclo Final)</button>
            <button onclick="addMaxStarsTest()" style="background: var(--accent); color: #333; border-radius: 50px; ">Adicionar 5 Estrelas no C√©u</button>
            <button onclick="simularSucessosTest()" style="background: var(--primary); border-radius: 50px; ">Gerar Hist√≥rico (Ativar Relat√≥rio)</button>
            <button onclick="debugAdicionar100Arvores()" style="background: #4caf50; border-radius: 50px; ">üå≥ Debug: +100 √Årvores (Ano Atual)</button>
            
            <!-- NOVO: Bot√£o para alternar entre 5x5 e 10x10 -->
            <button onclick="debugGanharPerola()" style="width:100%; background: #9c27b0; color: white; margin-top: 10px; border-radius: 50px; ">‚ú® Debug: +1 P√©rola ü¶™</button>

            <button onclick="ganharMoedasDebug()" style="background: #daa520; color: #333; font-weight: bold; border-radius: 50px; ">üí∞ Ganhar 200 Moedas (Debug)</button>
            
            <div style="border-top: 1px solid #eee; margin: 5px 0; padding-top: 5px;">
                <small style="color: #666; font-weight: bold;">Hist√≥rias & Metas:</small>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                <button onclick="debugAvancarEurosummer()" style="background: #ff9800; font-size: 11px; padding: 8px 5px; border-radius: 50px; ">+1 Eurosummer</button>
                <button onclick="debugAvancarFundoMar()" style="background: #00bcd4; font-size: 11px; padding: 8px 5px; border-radius: 50px; ">+1 Fundo do Mar</button>
                <button onclick="debugResetarHistorias()" style="background: #f44336; font-size: 11px; padding: 8px 5px; grid-column: span 2; border-radius: 50px; ">Resetar Hist√≥rias</button>
            </div>

            <button style="border-radius: 50px;" onclick="fecharModal('debugOverlay')" class="secundario">Fechar Debug</button>
        </div>
    </div>
</div>

<div id="estanteOverlay">
    <div id="estanteContent">
        <button style="border-radius: 50px;" class="help-btn" onclick="mostrarInfoEstante()">?</button>
        <h2 style="color: var(--primary)">üìö Minha Estante</h2>
        <div id="listaLivros" style="min-height: 200px;"></div>
        <button onclick="prepararNovoLivro()" style="width:100%; margin-top: 20px; border-radius: 50px;">+ Novo Livro</button>
        <button onclick="fecharModal('estanteOverlay')" class="secundario" style="width:100%; margin-top:10px; border-radius: 50px;">Fechar</button>
    </div>
</div>

<div id="diarioOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 45000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(10px);">
    <style>
        .book-container {
            width: 95%;
            max-width: 800px;
            height: 85vh;
            background: #f4e4bc;
            border-radius: 5px 20px 20px 5px;
            box-shadow: 20px 20px 60px rgba(0,0,0,0.5), inset 5px 0 15px rgba(0,0,0,0.2);
            display: flex;
            position: relative;
            overflow: hidden;
            border: 1px solid #d4c49c;
        }
        .book-spine {
            width: 30px;
            background: linear-gradient(to right, #8b4513, #a0522d, #8b4513);
            height: 100%;
            box-shadow: inset -2px 0 5px rgba(0,0,0,0.3);
        }
        .book-page {
            flex: 1;
            padding: 40px;
            display: flex;
            flex-direction: column;
            background-image: radial-gradient(#d4c49c 1px, transparent 1px);
            background-size: 20px 20px;
            background-position: 0 0;
            overflow-y: auto;
            position: relative;
        }
        .book-page::before {
            content: '';
            position: absolute;
            left: 0; top: 0; bottom: 0;
            width: 1px;
            background: rgba(0,0,0,0.1);
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
        }
        .book-title {
            font-family: 'Georgia', serif;
            color: #5d4037;
            text-align: center;
            border-bottom: 2px solid #8b4513;
            padding-bottom: 10px;
            margin-bottom: 30px;
            font-style: italic;
        }
        .diary-input-area {
            background: rgba(255,255,255,0.3);
            border-radius: 10px;
            padding: 20px;
            border: 1px dashed #8b4513;
            margin-bottom: 30px;
        }
        .diary-textarea {
            width: 100%;
            height: 150px;
            background: transparent;
            border: none;
            border-bottom: 1px solid rgba(139, 69, 19, 0.3);
            font-family: 'Courier New', Courier, monospace;
            font-size: 16px;
            line-height: 24px;
            resize: none;
            color: #3e2723;
            padding: 0;
            outline: none;
            background-image: linear-gradient(transparent, transparent 23px, rgba(139, 69, 19, 0.1) 23px);
            background-size: 100% 24px;
        }
        .diary-entry {
            background: rgba(255,255,255,0.5);
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 5px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.05);
            border-left: 5px solid #8b4513;
            font-family: 'Courier New', Courier, monospace;
        }
        .btn-book-close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 24px;
            cursor: pointer;
            color: #8b4513;
            z-index: 10;
            transition: transform 0.2s;
        }
        .btn-book-close:hover { transform: scale(1.2); }
        
        @media (max-width: 600px) {
            .book-container { flex-direction: column; height: 90vh; }
            .book-spine { width: 100%; height: 15px; }
            .book-page { padding: 20px; }
        }

        /* --- TEMAS ESPECIAIS DO DI√ÅRIO --- */

        /* MODO DARK (Geral) */
        body.dark-mode .book-container { background: #2c2c2c; border-color: #444; color: #e0e0e0; box-shadow: 20px 20px 60px rgba(0,0,0,0.7); }
        body.dark-mode .book-page { background-image: radial-gradient(#444 1px, transparent 1px); }
        body.dark-mode .book-title { color: #fff; border-bottom-color: #555; }
        body.dark-mode .diary-input-area { background: rgba(0,0,0,0.2); border-color: #555; }
        body.dark-mode .diary-textarea { color: #e0e0e0; background-image: linear-gradient(transparent, transparent 23px, rgba(255,255,255,0.05) 23px); }
        body.dark-mode .diary-entry { background: rgba(255,255,255,0.05); border-left-color: #666; color: #ccc; }
        body.dark-mode .btn-book-close { color: #aaa; }
        body.dark-mode #diarioPaginaAtual { color: #aaa; }

        /* MODO MEDIEVAL */
        body.medieval-mode .book-container { background: #f4e4bc; border: 4px double #8b4513; border-radius: 0; font-family: 'Georgia', serif; }
        body.medieval-mode .book-spine { background: linear-gradient(to right, #5d4037, #8b4513, #5d4037); }
        body.medieval-mode .book-title { font-variant: small-caps; letter-spacing: 2px; }
        body.medieval-mode .diary-textarea { font-family: 'Georgia', serif; }
        body.medieval-mode .diary-entry { border-left: 8px solid #8b4513; background: rgba(139, 69, 19, 0.05); }
        
        body.dark-mode.medieval-mode .book-container { background: #3e2723; border-color: #8b4513; }
        body.dark-mode.medieval-mode .book-title { color: #d7ccc8; }
        body.dark-mode.medieval-mode .diary-textarea { color: #d7ccc8; }

        /* MODO CANDYFORNIA */
        body.candyfornia-mode .book-container { background: #fff0f5; border: 3px dashed #ff6bad; border-radius: 30px; }
        body.candyfornia-mode .book-spine { background: linear-gradient(to right, #ff6bad, #ffb7d5, #ff6bad); }
        body.candyfornia-mode .book-title { color: #ff6bad; border-bottom: 2px dashed #ffb7d5; font-family: 'Comic Sans MS', cursive; }
        body.candyfornia-mode .diary-input-area { background: #fff; border: 2px dashed #ffb7d5; border-radius: 20px; }
        body.candyfornia-mode .diary-textarea { color: #d63384; background-image: linear-gradient(transparent, transparent 23px, rgba(255, 107, 173, 0.1) 23px); }
        body.candyfornia-mode .diary-entry { background: #fff; border-left: 5px solid #ff6bad; border-radius: 15px; box-shadow: 5px 5px 0 rgba(255, 107, 173, 0.1); }
        body.candyfornia-mode .btn-book-close { color: #ff6bad; }
        body.candyfornia-mode #diarioPaginaAtual { color: #ff6bad; }

        body.dark-mode.candyfornia-mode .book-container { background: #4a1e36; border-color: #ff6bad; }
        body.dark-mode.candyfornia-mode .book-title { color: #ffb7d5; }
        body.dark-mode.candyfornia-mode .diary-textarea { color: #ffb7d5; }
        body.dark-mode.candyfornia-mode .diary-entry { background: rgba(0,0,0,0.3); }

        /* MODO EURO SUMMER */
        body.eurosummer-mode .book-container { background: #f0f8ff; border: 2px solid #0077be; border-radius: 10px; }
        body.eurosummer-mode .book-spine { background: linear-gradient(to right, #005b96, #0077be, #005b96); }
        body.eurosummer-mode .book-title { color: #005b96; border-bottom: 2px solid #0077be; font-family: 'Trebuchet MS', sans-serif; }
        body.eurosummer-mode .diary-input-area { background: rgba(255,255,255,0.8); border: 1px solid #0077be; border-radius: 10px; }
        body.eurosummer-mode .diary-textarea { color: #003366; background-image: linear-gradient(transparent, transparent 23px, rgba(0, 119, 190, 0.1) 23px); }
        body.eurosummer-mode .diary-entry { background: #fff; border-left: 5px solid #0077be; border-radius: 0; box-shadow: 3px 3px 10px rgba(0, 119, 190, 0.1); }
        body.eurosummer-mode .btn-book-close { color: #005b96; }
        body.eurosummer-mode #diarioPaginaAtual { color: #005b96; }

        body.dark-mode.eurosummer-mode .book-container { background: #001d3d; border-color: #003566; }
        body.dark-mode.eurosummer-mode .book-title { color: #4cc9f0; }
        body.dark-mode.eurosummer-mode .diary-textarea { color: #4cc9f0; }
        body.dark-mode.eurosummer-mode .diary-entry { background: rgba(0, 53, 102, 0.5); }
    </style>
    <div class="book-container" id="diarioContent">
        <div class="book-spine"></div>
        <div class="book-page">
            <span class="btn-book-close" onclick="fecharModal('diarioOverlay')">‚úï</span>
            <h2 class="book-title">üìî Di√°rio de Reflex√µes</h2>
            
            <!-- √Årea de Conte√∫do da P√°gina (Input ou Mem√≥ria) -->
            <div id="diarioPaginaConteudo" style="min-height: 400px; display: flex; flex-direction: column;">
                <!-- O conte√∫do ser√° injetado aqui via JS -->
            </div>
            
            <!-- Controles de Pagina√ß√£o -->
            <div id="diarioPaginacao" style="display: flex; justify-content: center; align-items: center; gap: 20px; margin-top: 20px; padding-top: 15px; border-top: 1px dashed rgba(139, 69, 19, 0.3);">
                <button onclick="mudarPaginaDiario(-1)" id="btnDiarioAnterior" style="background: #8b4513; color: white; border: none; border-radius: 50%; width: 35px; height: 35px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">‚ùÆ</button>
                <span id="diarioPaginaAtual" style="font-family: 'Georgia', serif; color: #5d4037; font-weight: bold; font-size: 14px;">P√°gina 1 de 1</span>
                <button onclick="mudarPaginaDiario(1)" id="btnDiarioProximo" style="background: #8b4513; color: white; border: none; border-radius: 50%; width: 35px; height: 35px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">‚ùØ</button>
            </div>
        </div>
    </div>
</div>


<div id="lojaOverlay">
    <div id="lojaContent">
        <span class="btn-fechar-modal" onclick="fecharModal('lojaOverlay')">‚úñ</span>
        <!-- Header aprimorado com saldo no topo -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px; padding: 15px; background: linear-gradient(135deg, #daa520, #ffd700); border-radius: 50px; color: white; box-shadow: 0 4px 12px rgba(218, 165, 32, 0.3);">
            <h2 style="margin: 0; color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">üõí Loja do Jardim</h2>
            <div style="font-size: 18px; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">
                üí∞ <span id="saldoLojaMoedasTopo">0</span>
            </div>
        </div>
        
        <!-- Navega√ß√£o por abas -->
        <div style="display: flex; margin-bottom: 20px; background: rgba(0,0,0,0.05); border-radius: 50px; padding: 5px;">
            <button onclick="trocarAbaLoja('tema')" id="abaTema" style="flex: 1; padding: 10px; border: none; border-radius: 50px; background: var(--primary); color: white; font-weight: bold; cursor: pointer;">üé® Tema</button>
            <button onclick="trocarAbaLoja('pets')" id="abaPets" style="flex: 1; padding: 10px; border: none; border-radius: 50px; background: transparent; color: var(--text-main); cursor: pointer;">üêæ Pets</button>
            <button onclick="trocarAbaLoja('jogos')" id="abaJogos" style="flex: 1; padding: 10px; border: none; border-radius: 50px; background: transparent; color: var(--text-main); cursor: pointer;">üé∞ Jogos</button>
        </div>
        
        <!-- Conte√∫do das abas -->
        <div id="conteudoTema" class="conteudo-aba">
            <div class="loja-grid">
                <div class="loja-secao-titulo">üåç Temas do Jardim</div>
                
                <div class="item-loja">
                    <div>üéÑ Natal</div>
                    <small>Clima Festivo</small>
                    <div class="ios-switch-container" style="margin-top: 5px;">
                        <div id="btnNatal" class="ios-switch" onclick="toggleNatal()">
                            <div class="ios-switch-thumb"></div>
                        </div>
                    </div>
                </div>
                <div class="item-loja">
                    <div>üè∞ Medieval</div>
                    <small>Um reino tranquilo</small>
                    <div id="containerMedievalLoja">
                        <button style="border-radius: 50px;" id="btnComprarMedieval" onclick="comprarItemLoja('medieval', 50)">50 üí∞</button>
                    </div>
                </div>
                <div class="item-loja">
                    <div>üç≠ Candyfornia</div>
                    <small>Mundo de Doces</small>
                    <div id="containerCandyforniaLoja">
                        <button style="border-radius: 50px;" id="btnComprarCandyfornia" onclick="comprarItemLoja('candyfornia', 80)">80 üí∞</button>
                    </div>
                </div>
                <div class="item-loja">
                    <div>üèõÔ∏è Eurosummer</div>
                    <small>Di√°rio do Mediterr√¢neo</small>
                    <div style="font-size: 10px; color: var(--text-secondary); margin-top: 4px; font-style: italic; line-height: 1.2; max-width: 150px; margin-bottom: 5px; text-align: justify; margin-left: auto; margin-right: auto;">
                        üìñ <b>Modo Hist√≥ria:</b> Desbloqueia mem√≥rias e itens exclusivos a cada 3 sess√µes de foco. Viva uma narrativa nost√°lgica na Riviera Italiana.
                    </div>
                    <div id="containerEurosummerLoja">
                        <button style="border-radius: 50px;" id="btnComprarEurosummer" onclick="comprarItemLoja('eurosummer', 100)">100 üí∞</button>
                    </div>
                </div>
                <div class="item-loja">
                    <div>üßú‚Äç‚ôÄÔ∏è Reino de Coral</div>
                    <small>Fundo do Mar</small>
                    <div style="font-size: 10px; color: var(--text-secondary); margin-top: 4px; font-style: italic; line-height: 1.2; max-width: 150px; margin-bottom: 5px; text-align: justify; margin-left: auto; margin-right: auto;">
                        üìñ <b>Modo Hist√≥ria:</b> Desbloqueia mem√≥rias subaqu√°ticas e itens exclusivos a cada 3 sess√µes de foco. Viva uma narrativa moderna no fundo do oceano.
                    </div>
                    <div id="containerFundoMarLoja">
                        <button style="border-radius: 50px;" id="btnComprarFundoMar" onclick="comprarItemLoja('fundomar', 120)">120 üí∞</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="conteudoPets" class="conteudo-aba" style="display: none;">
            <div class="loja-grid">
                <div class="loja-secao-titulo" id="tituloSecaoPets">üìè Licen√ßa de Ado√ß√£o (Terrestres M√°x: 2 | Aqu√°ticos: Sem Limite)</div>
                
                <!-- Animais Fundo do Mar (Apenas se comprado) -->
                <div id="secaoPetsFundoMar" style="display: contents;">
                    <div class="item-loja" id="itemPetFish">
                        <div style="font-size: 30px;">üêü</div>
                        <small>Peixinho</small>
                        <div style="font-size: 9px; color: #4cc9f0; margin-bottom: 5px;">‚ú® Meta 1</div>
                        <button style="border-radius: 50px;" id="btnPetFish" onclick="processarCompraPet('üêü', 40, 'btnPetFish')">40 üí∞</button>
                    </div>
                    <div class="item-loja" id="itemPetTropicalFish">
                        <div style="font-size: 30px;">üê†</div>
                        <small>Peixe Tropical</small>
                        <div style="font-size: 9px; color: #4cc9f0; margin-bottom: 5px;">‚ú® Meta 2</div>
                        <button style="border-radius: 50px;" id="btnPetTropicalFish" onclick="processarCompraPet('üê†', 60, 'btnPetTropicalFish')">60 üí∞</button>
                    </div>
                    <div class="item-loja" id="itemPetBlowfish">
                        <div style="font-size: 30px;">üê°</div>
                        <small>Baiacu</small>
                        <div style="font-size: 9px; color: #4cc9f0; margin-bottom: 5px;">‚ú® Meta 3</div>
                        <button style="border-radius: 50px;" id="btnPetBlowfish" onclick="processarCompraPet('üê°', 80, 'btnPetBlowfish')">80 üí∞</button>
                    </div>
                    <div class="item-loja" id="itemPetOctopus">
                        <div style="font-size: 30px;">üêô</div>
                        <small>Polvo</small>
                        <div style="font-size: 9px; color: #4cc9f0; margin-bottom: 5px;">‚ú® Meta 4</div>
                        <button style="border-radius: 50px;" id="btnPetOctopus" onclick="processarCompraPet('üêô', 120, 'btnPetOctopus')">120 üí∞</button>
                    </div>
                    <div class="item-loja" id="itemPetTurtle">
                        <div style="font-size: 30px;">üê¢</div>
                        <small>Tartaruga</small>
                        <div style="font-size: 9px; color: #4cc9f0; margin-bottom: 5px;">‚ú® Meta 5</div>
                        <button style="border-radius: 50px;" id="btnPetTurtle" onclick="processarCompraPet('üê¢', 100, 'btnPetTurtle')">100 üí∞</button>
                    </div>
                    <div class="item-loja" id="itemPetOtter">
                        <div style="font-size: 30px;">ü¶¶</div>
                        <small>Lontra</small>
                        <div style="font-size: 9px; color: #4cc9f0; margin-bottom: 5px;">‚ú® Meta 6</div>
                        <button style="border-radius: 50px;" id="btnPetOtter" onclick="processarCompraPet('ü¶¶', 120, 'btnPetOtter')">120 üí∞</button>
                    </div>
                    <div class="item-loja" id="itemPetMermaid">
                        <div style="font-size: 30px;">üßú‚Äç‚ôÄÔ∏è</div>
                        <small>Sereia</small>
                        <div style="font-size: 9px; color: #4cc9f0; margin-bottom: 5px;">‚ú® Meta 7 (Escolha)</div>
                        <button style="border-radius: 50px;" id="btnPetMermaid" onclick="processarCompraPet('üßú‚Äç‚ôÄÔ∏è', 200, 'btnPetMermaid')">200 üí∞</button>
                    </div>
                    <div class="item-loja" id="itemPetMerman">
                        <div style="font-size: 30px;">üßú‚Äç‚ôÇÔ∏è</div>
                        <small>Trit√£o</small>
                        <div style="font-size: 9px; color: #4cc9f0; margin-bottom: 5px;">‚ú® Meta 7 (Escolha)</div>
                        <button style="border-radius: 50px;" id="btnPetMerman" onclick="processarCompraPet('üßú‚Äç‚ôÇÔ∏è', 200, 'btnPetMerman')">200 üí∞</button>
                    </div>
                    <div class="item-loja" id="itemPetSeal">
                        <div style="font-size: 30px;">ü¶≠</div>
                        <small>Foca</small>
                        <div style="font-size: 9px; color: #4cc9f0; margin-bottom: 5px;">‚ú® Meta 8</div>
                        <button style="border-radius: 50px;" id="btnPetSeal" onclick="processarCompraPet('ü¶≠', 150, 'btnPetSeal')">150 üí∞</button>
                    </div>
                    <div class="item-loja" id="itemPetWhale">
                        <div style="font-size: 30px;">üêã</div>
                        <small>Baleia</small>
                        <div style="font-size: 9px; color: #4cc9f0; margin-bottom: 5px;">‚ú® Meta 9</div>
                        <button style="border-radius: 50px;" id="btnPetWhale" onclick="processarCompraPet('üêã', 200, 'btnPetWhale')">200 üí∞</button>
                    </div>
                </div>

                <div class="item-loja" id="itemLojaRena" style="display: none; border: 2px solid #e74c3c; background: #fff5f5;">
                    <div style="font-size: 30px;">ü¶å</div>
                    <small>Rena</small>
                    <div style="font-size: 9px; color: #e74c3c; margin-bottom: 5px; font-weight: bold;">‚ú® +10 moedas no foco (Modo Natal)</div>
                    <button style="border-radius: 50px;" id="btnPetReindeer" onclick="processarCompraPet('ü¶å', 150, 'btnPetReindeer')">150 üí∞</button>
                </div>

                <div class="item-loja">
                    <div style="font-size: 30px;">ü¶Ü</div>
                    <small>Pato</small>
                    <div style="font-size: 9px; color: #666; margin-bottom: 5px;">‚ú® +2 moedas por carinho</div>
                    <button style="border-radius: 50px;" id="btnPetDuck1" onclick="processarCompraPet('ü¶Ü', 50, 'btnPetDuck1')">50 üí∞</button>
                </div>
                <div class="item-loja">
                    <div style="font-size: 30px;">ü™ø</div>
                    <small>Ganso</small>
                    <div style="font-size: 9px; color: #666; margin-bottom: 5px;">‚ú® B√¥nus de sorte +2</div>
                    <button style="border-radius: 50px;" id="btnPetGoose" onclick="processarCompraPet('ü™ø', 60, 'btnPetGoose')">60 üí∞</button>
                </div>
                <div class="item-loja">
                    <div style="font-size: 30px;">üêï</div>
                    <small>C√£ozinho</small>
                    <div style="font-size: 9px; color: #666; margin-bottom: 5px;">‚ú® Recupera 50% ao desistir</div>
                    <button style="border-radius: 50px;" id="btnPetDog1" onclick="processarCompraPet('üêï', 80, 'btnPetDog1')">80 üí∞</button>
                </div>
                <div class="item-loja">
                    <div style="font-size: 30px;">üêà</div>
                    <small>Gatinho</small>
                    <div style="font-size: 9px; color: #666; margin-bottom: 5px;">‚ú® +20% moedas de foco</div>
                    <button style="border-radius: 50px;" id="btnPetCat1" onclick="processarCompraPet('üêà', 80, 'btnPetCat1')">80 üí∞</button>
                </div>
                <div class="item-loja">
                    <div style="font-size: 30px;">üêñ</div>
                    <small>Porquinho</small>
                    <div style="font-size: 9px; color: #666; margin-bottom: 5px;">‚ú® 10% desconto na loja</div>
                    <button style="border-radius: 50px;" id="btnPetPig" onclick="processarCompraPet('üêñ', 100, 'btnPetPig')">100 üí∞</button>
                </div>
                <div class="item-loja">
                    <div style="font-size: 30px;">ü¶â</div>
                    <small>Coruja</small>
                    <div style="font-size: 9px; color: #666; margin-bottom: 5px;">‚ú® +5 moedas √† noite</div>
                    <button style="border-radius: 50px;" id="btnPetOwl" onclick="processarCompraPet('ü¶â', 120, 'btnPetOwl')">120 üí∞</button>
                </div>
                <div class="item-loja">
                    <div style="font-size: 30px;">ü¶´</div>
                    <small>Castor</small>
                    <div style="font-size: 9px; color: #666; margin-bottom: 5px;">‚ú® Constru√ß√µes 20% mais baratas</div>
                    <button style="border-radius: 50px;" id="btnPetBeaver" onclick="processarCompraPet('ü¶´', 130, 'btnPetBeaver')">130 üí∞</button>
                </div>
                <div class="item-loja">
                    <div style="font-size: 30px;">üêí</div>
                    <small>Macaco</small>
                    <div style="font-size: 9px; color: #666; margin-bottom: 5px;">‚ú® +10 moedas em metas</div>
                    <button style="border-radius: 50px;" id="btnPetMonkey" onclick="processarCompraPet('üêí', 150, 'btnPetMonkey')">150 üí∞</button>
                </div>
                <div class="item-loja">
                    <div style="font-size: 30px;">ü¶ô</div>
                    <small>Lhama</small>
                    <div style="font-size: 9px; color: #666; margin-bottom: 5px;">‚ú® +5 moedas por carinho</div>
                    <button style="border-radius: 50px;" id="btnPetLlama" onclick="processarCompraPet('ü¶ô', 160, 'btnPetLlama')">160 üí∞</button>
                </div>
                <div class="item-loja">
                    <div style="font-size: 30px;">üêÑ</div>
                    <small>Vaquinha</small>
                    <div style="font-size: 9px; color: #666; margin-bottom: 5px;">‚ú® Produz 5 moedas/hora</div>
                    <button style="border-radius: 50px;" id="btnPetCow" onclick="processarCompraPet('üêÑ', 180, 'btnPetCow')">180 üí∞</button>
                </div>
                <div class="item-loja">
                    <div style="font-size: 30px;">ü¶ö</div>
                    <small>Pav√£o</small>
                    <div style="font-size: 9px; color: #666; margin-bottom: 5px;">‚ú® Chance de dobrar moedas</div>
                    <button style="border-radius: 50px;" id="btnPetPeacock" onclick="processarCompraPet('ü¶ö', 200, 'btnPetPeacock')">200 üí∞</button>
                </div>
                <div class="item-loja">
                    <div style="font-size: 30px;">üêÜ</div>
                    <small>Leopardo</small>
                    <div style="font-size: 9px; color: #666; margin-bottom: 5px;">‚ú® Foco 25m = 30m</div>
                    <button style="border-radius: 50px;" id="btnPetLeopard" onclick="processarCompraPet('üêÜ', 220, 'btnPetLeopard')">220 üí∞</button>
                </div>
                <div class="item-loja">
                    <div style="font-size: 30px;">ü¶í</div>
                    <small>Girafa</small>
                    <div style="font-size: 9px; color: #666; margin-bottom: 5px;">‚ú® Revela Planta da Sorte</div>
                    <button style="border-radius: 50px;" id="btnPetGiraffe" onclick="processarCompraPet('ü¶í', 250, 'btnPetGiraffe')">250 üí∞</button>
                </div>
            </div>
        </div>
        
        <div id="conteudoJogos" class="conteudo-aba" style="display: none;">
            <div class="loja-grid">
                <div class="loja-secao-titulo">üé∞ Jogos de Azar</div>
                
                <div class="item-loja">
                    <div style="font-size: 30px;">üé∞</div>
                    <small>Ca√ßa-N√≠quel</small>
                    <div style="font-size: 9px; color: #daa520; margin-bottom: 5px;">‚ú® Jogue e ganhe moedas!</div>
                    <button style="border-radius: 50px;" onclick="abrirCacaNiquel()">JOGAR</button>
                </div>
            </div>
        </div>

        <button onclick="fecharModal('lojaOverlay')" class="secundario" style="width:100%; margin-top:20px; border-radius: 50px;">Sair da Loja</button>
    </div>
</div>

<div id="modalPlantaOverlay">
    <div id="modalPlantaContent">
        <span class="btn-fechar-modal" onclick="fecharModal('modalPlantaOverlay')">‚úñ</span>
        <h3 style="color: var(--primary)">Selecione sua semente üå±</h3>
        <p id="avisoEscolhaLocal" style="font-size:11px; margin:6px 0; color:var(--text-secondary); display:none;">Nenhum local selecionado ‚Äî voc√™ pode escolher a planta agora e selecionar onde plantar depois.</p>
        <p style="font-size: 11px; margin: 5px 0; color: var(--text-secondary)">PRATELEIRA: COMUNS</p>
        <div id="paletaModal" class="modal-prateleira"></div>
        <p style="font-size: 11px; margin: 5px 0; color: var(--text-secondary)">PRATELEIRA: ESPECIAL (MODOS)</p>
        <div id="paletaEspecialModal" class="modal-prateleira"></div>
    </div>
</div>

<div id="cacaNiquelOverlay">
    <div id="cacaNiquelContent">
        <span class="btn-fechar-modal" onclick="fecharModal('cacaNiquelOverlay')">‚úñ</span>
        <h2 style="color: #daa520; text-align: center; margin-bottom: 15px;">üé∞ Ca√ßa-N√≠quel</h2>

        <!-- Informa√ß√µes do jogador -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 10px; background: rgba(0,0,0,0.1); border-radius: 10px;">
            <div style="font-size: 16px;">üí∞ <span id="saldoCacaNiquel">0</span></div>
            <div style="font-size: 12px; color: var(--text-secondary);">Custo: 5 moedas</div>
        </div>

        <!-- M√°quina do ca√ßa-n√≠quel -->
        <div id="slotMachine" style="display: flex; flex-direction: column; align-items: center; gap: 8px; margin: 15px 0; padding: 15px; background: linear-gradient(135deg, #1a1a1a 0%, #2c3e50 50%, #34495e 100%); border-radius: 12px; border: 2px solid #daa520; position: relative; box-shadow: inset 0 0 15px rgba(0,0,0,0.4), 0 4px 15px rgba(0,0,0,0.3);">

            <!-- Painel superior com informa√ß√µes -->
            <div style="width: 100%; background: #0a0a0a; border-radius: 8px; padding: 8px; margin-bottom: 10px; border: 1px solid #daa520; text-align: center; font-size: 11px; color: #daa520;">
                üé∞ SLOT MACHINE üé∞
            </div>

            <!-- M√°quina principal compacta -->
            <div style="display: flex; align-items: center; gap: 12px;">
                <!-- Lado esquerdo decorativo -->
                <div style="display: flex; flex-direction: column; gap: 6px;">
                    <div style="width: 20px; height: 20px; background: #e74c3c; border-radius: 50%; border: 1px solid #c0392b; box-shadow: inset 0 0 3px rgba(0,0,0,0.5);"></div>
                    <div style="width: 20px; height: 20px; background: #f39c12; border-radius: 50%; border: 1px solid #e67e22; box-shadow: inset 0 0 3px rgba(0,0,0,0.5);"></div>
                    <div style="width: 20px; height: 20px; background: #27ae60; border-radius: 50%; border: 1px solid #229954; box-shadow: inset 0 0 3px rgba(0,0,0,0.5);"></div>
                </div>

                <!-- Rolos -->
                <div style="display: flex; gap: 8px; background: #0f0f0f; padding: 12px; border-radius: 8px; border: 1px solid #daa520;">
                    <div class="slot-reel" id="reel1" style="width: 55px; height: 55px; background: #fff; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 28px; border: 1px solid #daa520; transition: all 0.3s ease; position: relative; overflow: hidden;">
                        <div class="reel-window" style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;"></div>
                        <div class="reel-overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(180deg, rgba(255,255,255,0.9) 0%, transparent 25%, transparent 75%, rgba(255,255,255,0.9) 100%); pointer-events: none; border-radius: 4px;"></div>
                    </div>
                    <div class="slot-reel" id="reel2" style="width: 55px; height: 55px; background: #fff; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 28px; border: 1px solid #daa520; transition: all 0.3s ease; position: relative; overflow: hidden;">
                        <div class="reel-window" style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;"></div>
                        <div class="reel-overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(180deg, rgba(255,255,255,0.9) 0%, transparent 25%, transparent 75%, rgba(255,255,255,0.9) 100%); pointer-events: none; border-radius: 4px;"></div>
                    </div>
                    <div class="slot-reel" id="reel3" style="width: 55px; height: 55px; background: #fff; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 28px; border: 1px solid #daa520; transition: all 0.3s ease; position: relative; overflow: hidden;">
                        <div class="reel-window" style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;"></div>
                        <div class="reel-overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(180deg, rgba(255,255,255,0.9) 0%, transparent 25%, transparent 75%, rgba(255,255,255,0.9) 100%); pointer-events: none; border-radius: 4px;"></div>
                    </div>
                </div>

                <!-- Lado direito decorativo -->
                <div style="display: flex; flex-direction: column; gap: 6px;">
                    <div style="width: 20px; height: 20px; background: #9b59b6; border-radius: 50%; border: 1px solid #8e44ad; box-shadow: inset 0 0 3px rgba(0,0,0,0.5);"></div>
                    <div style="width: 20px; height: 20px; background: #1abc9c; border-radius: 50%; border: 1px solid #16a085; box-shadow: inset 0 0 3px rgba(0,0,0,0.5);"></div>
                    <div style="width: 20px; height: 20px; background: #e67e22; border-radius: 50%; border: 1px solid #d35400; box-shadow: inset 0 0 3px rgba(0,0,0,0.5);"></div>
                </div>
            </div>

            <!-- Painel inferior com bot√µes -->
            <div style="width: 100%; background: #0a0a0a; border-radius: 8px; padding: 8px; margin-top: 10px; border: 1px solid #daa520; display: flex; justify-content: space-around; align-items: center;">
                <div style="font-size: 10px; color: #aaa;">SPIN</div>
                <div style="width: 2px; height: 15px; background: #daa520;"></div>
                <div style="font-size: 10px; color: #aaa;">MAX BET</div>
                <div style="width: 2px; height: 15px; background: #daa520;"></div>
                <div style="font-size: 10px; color: #aaa;">AUTO</div>
            </div>

            <!-- Bot√£o SPIN moderno -->
            <div style="display: flex; justify-content: center; margin-top: 15px;">
                <button id="slotLever" onclick="girarCacaNiquel()" style="background: linear-gradient(135deg, #ff6b35, #f7931e); border: 3px solid #daa520; border-radius: 50px; padding: 15px 30px; font-size: 18px; font-weight: bold; color: white; cursor: pointer; text-transform: uppercase; letter-spacing: 2px; box-shadow: 0 6px 15px rgba(0,0,0,0.3), inset 0 2px 5px rgba(255,255,255,0.2); transition: all 0.3s ease; position: relative; overflow: hidden;" title="Clique para girar!">
                    <span style="position: relative; z-index: 2;">üé∞ SPIN</span>
                    <div style="position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent); transition: left 0.5s; border-radius: 50px;"></div>
                </button>
            </div>
        </div>

        <!-- Instru√ß√µes e resultado -->
        <div style="text-align: center; margin: 15px 0;">
            <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">Clique no bot√£o SPIN para jogar!</div>
            <div id="resultadoCacaNiquel" style="font-size: 16px; font-weight: bold; min-height: 24px; margin: 8px 0;"></div>
        </div>

        <!-- Tabela de valores -->
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; font-size: 11px; color: var(--text-secondary); text-align: center; margin-top: 15px;">
            <div>üçí = 8</div>
            <div>üçã = 12</div>
            <div>üçä = 18</div>
            <div>‚≠ê = 35</div>
            <div>üíé = 75</div>
            <div style="grid-column: span 2; color: #daa520; font-weight: bold; margin-top: 5px;">3 iguais = 3x valor<br>Jackpot: 3 üíé = 750 | 3 ‚≠ê = 280</div>
        </div>
    </div>
</div>

<div id="configOverlay">
    <div id="configContent">
        <span class="btn-fechar-modal" onclick="fecharModal('configOverlay')">‚úñ</span>
        <h2 style="color: var(--primary)">‚öôÔ∏è Configura√ß√µes</h2>

        
        
        <div class="config-grid">
            <div class="config-card">
                <h4>üë§ Nome de Usu√°rio</h4>
                <input type="text" id="configNomeUsuario" placeholder="Seu nome..." oninput="salvarNovoNomeAuto()" style="width: 100%; padding: 10px; border-radius: 10px; border: 2px solid var(--primary); font-size: 14px; text-align: center; box-sizing: border-box; background: var(--bg-card); color: var(--text-main);">
                <div style="text-align: center; margin-top: 5px;">
                    <small style="color: var(--text-secondary); font-size: 9px;">O nome √© salvo automaticamente ao digitar.</small>
                </div>
            </div>

            <div class="config-card">
                <h4>üîî Sino</h4>
                <div class="ios-switch-container">
                    <div id="btnSino" class="ios-switch" onclick="toggleSino()">
                        <div class="ios-switch-thumb"></div>
                    </div>
                </div>
            </div>
            
            <div class="config-card">
                <h4>üåô Auto Tema</h4>
                <div class="ios-switch-container">
                    <div id="btnTemaAuto" class="ios-switch" onclick="toggleTemaAuto()">
                        <div class="ios-switch-thumb"></div>
                    </div>
                </div>
                
                 <div style="text-align: center; margin-top: 8px; padding: 6px; border-radius: 8px;">
        <small style="color: var(--text-secondary); font-size: 10px; line-height: 1.3; display: block;">
            <span style="color: var(--primary);"></span> 
            Desative para alternar entre modo claro ou escuro manualmente.
        </small>
            </div>
            </div>
            
            
            <div class="config-card">
                <h4>‚ú® Estrelas</h4>
                <div class="ios-switch-container">
                    <div id="btnEstrelas" class="ios-switch on" onclick="toggleEstrelas()">
                        <div class="ios-switch-thumb"></div>
                    </div>
                </div>
                 <div style="text-align: center; margin-top: 8px; padding: 6px; border-radius: 8px;">
        <small style="color: var(--text-secondary); font-size: 10px; line-height: 1.3; display: block;">
            <span style="color: var(--primary);"></span> 
            Uma estrela aparece no modo noturno sempre que um livro 5 estrelas √© colocado na estante.
        </small>
            </div>
            </div>
            <!-- No configOverlay, dentro da grid de configura√ß√µes -->
<div class="config-card">
    <h4>üì± Tela Sempre Ativa Durante Foco</h4>
    <div class="ios-switch-container">
        <div id="btnTelaAtiva" class="ios-switch" onclick="toggleTelaAtiva()">
            <div class="ios-switch-thumb"></div>
        </div>
    </div>
    <div style="text-align: center; margin-top: 8px; padding: 6px; border-radius: 8px;">
        <small style="color: var(--text-secondary); font-size: 10px; line-height: 1.3; display: block;">
            <span style="color: var(--primary);"></span> 
            Mant√©m sua tela ativa automaticamente durante o foco. N√£o saia do app para que funcione corretamente.
        </small>
    </div>
</div>
            
            <div class="config-card">
                <h4>üé® Anima√ß√£o do Fundo</h4>
                <div class="ios-switch-container">
                    <div id="btnAnimFundo" class="ios-switch on" onclick="toggleAnimacaoFundo()">
                        <div class="ios-switch-thumb"></div>
                    </div>
                </div>
            </div>
            
            <!-- NOVO: Configura√ß√£o para previs√£o -->
            <div class="config-card">
                <h4>üîÆ Previs√£o</h4>
                <div class="ios-switch-container">
                    <div id="btnPrevisao" class="ios-switch" onclick="togglePrevisao()">
                        <div class="ios-switch-thumb"></div>
                    </div>
                </div>
                 <div style="text-align: center; margin-top: 8px; padding: 6px; border-radius: 8px;">
        <small style="color: var(--text-secondary); font-size: 10px; line-height: 1.3; display: block;">
            <span style="color: var(--primary);"></span> 
            Fun√ß√£o baseada em estat√≠sticas que prev√™ sua taxa de sucesso nas sess√µes de foco.
        </small>
            </div>
            </div>

<div class="config-card">
    <h4>üòä Emojis Padronizados</h4>

    <div class="ios-switch-container">
        <div id="btnEmojis" class="ios-switch on" onclick="toggleEmojis()">
            <div class="ios-switch-thumb"></div>
        </div>
    </div>

    <div style="text-align: center; margin-top: 8px; padding: 6px; border-radius: 8px;">
        <small style="color: var(--text-secondary); font-size: 10px; line-height: 1.3; display: block;">
            Ative se os emojis do seu celular estiverem desatualizados ou aparecerem diferentes.
        </small>
   
    </div>
</div>


            </div>
        
        

        
        <!-- NOVA SE√á√ÉO: VISUALIZA√á√ÉO -->
        <h3 style="margin-top: 20px; margin-bottom: 10px; color: var(--text-main);">VISUALIZA√á√ÉO</h3>
        <div class="config-grid">
            <div class="config-card">
                <h4>üìê Tamanho do Jardim</h4>
                <div style="display: flex; flex-direction: column; align-items: center; gap: 10px; margin-top: 10px;">
                    <span id="gridSizeDisplay" style="font-size: 1.2em; font-weight: 800; color: var(--primary);">5x5</span>
                    <input type="range" id="configGridSize" min="3" max="10" step="1" value="5" oninput="atualizarPreviewGrid(this.value)" onchange="salvarNovoGrid(this.value)" style="width: 100%; height: 8px; border-radius: 5px; background: #ddd; outline: none; transition: 0.2s; cursor: pointer;">
                </div>
                <div style="text-align: center; margin-top: 12px; padding: 6px; border-radius: 8px;">
                    <small style="color: var(--text-secondary); font-size: 10px; line-height: 1.3; display: block;">
                        Personalize o tamanho do seu grid (m√°ximo 10x10). <br><strong>Aten√ß√£o:</strong> Plantas ser√£o reposicionadas ao mudar o tamanho.
                    </small>
                </div>
            </div>
        </div>
        
        <!-- NOVA SE√á√ÉO: GERENCIAMENTO -->
        <h3 style="margin-top: 20px; margin-bottom: 10px; color: var(--text-main); border-top: 1px solid var(--shadow); padding-top: 20px;">‚öôÔ∏è GERENCIAR OP√á√ïES</h3>
        
        <div class="config-card" style="align-items: stretch; text-align: left; min-height: auto; margin-bottom: 15px; width: 100%; box-sizing: border-box;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h4 style="margin: 0;">‚è±Ô∏è Tempos de Foco</h4>
<!-- Bot√£o movido para dentro da lista -->
            </div>
            <div id="listaGerenciarTempos" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 5px;"></div>
        </div>

        <div class="config-card" style="align-items: stretch; text-align: left; min-height: auto; margin-bottom: 15px; width: 100%; box-sizing: border-box;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h4 style="margin: 0;">üè∑Ô∏è Motivos de Foco</h4>
<!-- Bot√£o movido para dentro da lista -->
            </div>
            <div id="listaGerenciarMotivos" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 5px;"></div>
        </div>

        <!-- BOT√ÉO DE TUTORIAL -->
        <button onclick="iniciarTutorial()" style="width:100%; background: #9c27b0; color: white; margin-bottom: 15px; border-radius: 50px; font-weight: bold; padding: 12px; ">üìñ Repetir Tutorial</button>
        
        <!-- SE√á√ÉO DE BACKUP DE DADOS -->
<div class="backup-section" style="text-align: center; margin: 15px 0;">
    <button onclick="BackupManager.exportarTudo()" class="btn-config" style="background: #2196F3; color: white; width: 100%; margin-bottom: 10px;">
        üíæ Salvar Backup Completo (Tudo)
    </button>

    <button onclick="document.getElementById('inputRestore').click()" class="btn-config" style="background: #FF9800; color: white; width: 100%;">
        üìÇ Restaurar Backup
    </button>
    <input type="file" id="inputRestore" style="display: none;" 
           accept=".json" onchange="BackupManager.restaurarTudo(this)">
</div>

        
        <button onclick="resetAbsoluto()" style="width:100%; background:#c62828; color: white; margin-bottom:10px; border-radius: 50px; font-weight: bold; ">‚ö†Ô∏è Reset Absoluto (Zerar Tudo)</button>
        <div style="text-align: center; font-size: 10px; color: var(--text-secondary); margin-top: 15px;">Vers√£o: 3.0.0</div>
        <button onclick="fecharModal('configOverlay')" class="secundario" style="width:100%; margin-top:10px; border-radius: 50px;">Fechar</button>
    </div>
</div>

<div id="modalLivroInput">
    <div style="background:var(--bg-panel); padding:20px; border-radius:20px; width:280px; text-align:center;">
        <h3>Adicionar Livro</h3>
        <input type="text" id="nomeLivroInput" placeholder="T√≠tulo..." style="width:90%; border:1px solid #ddd; margin-bottom:10px; padding: 8px; border-radius: 8px;">
        <textarea id="notasLivroInput" placeholder="Notas..." style="width:90%; height: 60px; border:1px solid #ddd; margin-bottom:10px; font-family: inherit; padding: 8px; border-radius: 8px;"></textarea>
        
        <div class="color-picker" id="livroColorPicker">
            </div>

        <div class="star-rating" id="starsClickable">
            <span class="star" data-v="1">‚òÖ</span><span class="star" data-v="2">‚òÖ</span><span class="star" data-v="3">‚òÖ</span><span class="star" data-v="4">‚òÖ</span><span class="star" data-v="5">‚òÖ</span>
        </div>
        <button onclick="confirmarNovoLivro()" style="width:100%; border-radius: 50px;">Salvar</button>
        <button onclick="fecharModal('modalLivroInput')" class="secundario" style="width:100%; margin-top:5px; border-radius: 50px;">Cancelar</button>
    </div>
</div>

<div id="customAlertOverlay">
    <div id="customAlertBox">
        <div id="customAlertText" style="margin-bottom: 20px; font-weight: 500;">Mensagem</div>
        <input type="text" id="customAlertInput" style="display:none; width:90%; margin: 0 auto 15px; padding: 12px; border: 1px solid #ddd; border-radius: 12px;">
        <div class="alert-btns" style="display: flex; justify-content: center; gap: 10px;">
            <button style="border-radius: 50px;" id="alertConfirmBtn">Ok!</button>
            <button style="border-radius: 50px;" id="alertCancelBtn" class="cancelar">Cancelar</button>
            <button id="alertAltBtn" style="display:none; background: #2196f3; border-radius: 50px; "></button>
        </div>
    </div>
</div>

<button style="border-radius: 50px;" id="abrirMenuBtn" onclick="toggleMenu()">‚ò∞</button>
<button style="border-radius: 50px;" id="btnTema" onclick="toggleDarkMode()">üåì</button>
<button id="btnCorreioEurosummer" onclick="abrirCorreioEurosummer()" title="Correio de Mem√≥rias" style="display: none; border-radius: 50px;">üì™</button>
<button id="btnMetasFundoMar" onclick="toggleMetasFundoMar()" title="Metas do Oceano" style="display: none; border-radius: 50px;">üéØ</button>
<button id="btnCorreioFundoMar" onclick="abrirCorreioFundoMar()" title="Correio do Mar" style="display: none; border-radius: 50px;">üêö</button>

<div id="painelMetasFundoMar" style="display: none;">
    <div class="metas-fundo-mar-header">
        <h3>üåä Metas do Oceano</h3>
        <button style="border-radius: 50px;" onclick="toggleMetasFundoMar()">‚úï</button>
    </div>
    <div id="listaMetasFundoMar" style="overflow-y: auto; max-height: 280px;"></div>
</div>


<div id="abaEsquerda">
    <div style="text-align: center; padding-bottom: 20px; border-bottom: 2px solid rgba(76, 175, 80, 0.2); margin-top: 10px;">
        <h1 style="margin: 0 0 10px 0; color: var(--primary); cursor: pointer; font-size: 22px; white-space: nowrap;" onclick="acessarDebugViaTitulo()">üå± Garden Focus</h1>
        <h3 id="saudacaoUsuario" style="margin: 5px 0 15px 0; opacity: 0.8;">Ol√°!</h3>
        <div id="streakBadgeSide" onclick="abrirDashboard()">‚òÄÔ∏è <span id="streakBadgeValueSide">0</span> dias</div>
        
        <input type="file" id="profilePhotoInput" accept="image/*" style="display:none">
        <div id="profilePhotoContainer" onclick="document.getElementById('profilePhotoInput').click()" style="width: 80px; height: 80px; margin: 0 auto 10px; border-radius: 50%; overflow: hidden; cursor: pointer; transition: all 0.3s; border: 3px solid var(--primary); display: flex; align-items: center; justify-content: center; background: rgba(76, 175, 80, 0.1); box-shadow: 0 4px 15px rgba(76, 175, 80, 0.2);">
            <div id="profilePhotoPlaceholder" style="font-size: 40px;">üë§</div>
            <img id="profilePhoto" alt="Foto de perfil" style="width: 100%; height: 100%; object-fit: cover;">
        </div>
        <div id="profilePhotoLabel" onclick="document.getElementById('profilePhotoInput').click()" style="font-size: 12px; opacity: 0.7; cursor: pointer; margin-bottom: 10px;">Clique para adicionar foto</div>
        
        <div id="containerMoedas" style="background: rgba(76, 175, 80, 0.1); padding: 10px 15px; border-radius: 15px; font-weight: bold; color: var(--primary); display: inline-block;">
            üí∞ <span id="userMoedas">0</span> Moedas
        </div>
    </div>

    <div class="menu-grid-group">
        <h4 style="opacity: 0.6; font-size: 12px; text-transform: uppercase; letter-spacing: 1px;">Explora√ß√£o</h4>
        
        <button onclick="abrirDashboard(); toggleMenu()" style="background: linear-gradient(135deg, #2196f3, #1976d2); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);">
            <span style="font-size: 20px;">üìä</span> 
            <span>Painel</span>
        </button>
        
        <button onclick="abrirLoja(); toggleMenu()" style="background: linear-gradient(135deg, #daa520, #b8860b); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 12px rgba(218, 165, 32, 0.3);">
            <span style="font-size: 20px;">üõí</span> 
            <span>Loja</span>
        </button>
    </div>

    <div class="menu-grid-group">
        <h4 style="opacity: 0.6; font-size: 12px; text-transform: uppercase; letter-spacing: 1px;">Seu Acervo</h4>
        
        <button onclick="abrirInventario(); toggleMenu()" style="background: linear-gradient(135deg, #9c27b0, #7b1fa2); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 12px rgba(156, 39, 176, 0.3);">
            <span style="font-size: 20px;">üéí</span> 
            <span>Invent√°rio</span>
        </button>
        
        <button onclick="abrirEstante(); toggleMenu()" style="background: linear-gradient(135deg, #8d6e63, #6d4c41); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 12px rgba(141, 110, 99, 0.3);">
            <span style="font-size: 20px;">üìö</span> 
            <span>Estante</span>
        </button>
        

    <button onclick="abrirMenuJardins(); toggleMenu()" style="background: linear-gradient(135deg, #43a047, #2e7d32); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 12px rgba(46, 125, 50, 0.3);">
    <span style="font-size: 20px;">üèûÔ∏è</span> 
    <span>Jardins</span>
</button>

        <button onclick="abrirAvisoPlantarJuntos(); toggleMenu()" style="background: linear-gradient(135deg, #66bb6a, #43a047); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 12px rgba(67, 160, 71, 0.3);">
            <span style="font-size: 20px;">üåø</span> 
            <span>Plantar juntos</span>
        </button>
</div>

    <div class="menu-grid-group">
        <h4 style="opacity: 0.6; font-size: 12px; text-transform: uppercase; letter-spacing: 1px;">Produtividade</h4>
        
        <button id="btnTodoToggle" onclick="toggleTodoPopup()" style="background: linear-gradient(135deg, #4caf50, #388e3c); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3); z-index: 1002;">
            <span style="font-size: 20px;">üìù</span> 
            <span>Tarefas</span>
        </button>
        
        <button id="btnMetasToggle" onclick="toggleMetas()" style="background: linear-gradient(135deg, #ff9800, #f57c00); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3); z-index: 1001;">
            <span style="font-size: 20px;">üéØ</span> 
            <span>Metas</span>
        </button>

        <div id="todoPopup" class="todo-container" style="background: rgba(76, 175, 80, 0.05); border: 1px solid rgba(76, 175, 80, 0.2); border-radius: 12px;">
            <div style="display:flex; gap: 5px; margin-bottom: 10px;">
                <input id="novoTodo" type="text" placeholder="Nova tarefa..." style="flex: 1; min-height: 35px; font-size: 12px; padding: 8px 12px; border-radius: 8px; border: 1px solid rgba(76, 175, 80, 0.2); background: var(--bg-panel);">
                <button onclick="addTodo()" style="min-width: 35px; min-height: 35px; padding: 0; border-radius: 8px; background: var(--primary); color: white; border: none; cursor: pointer; font-weight: bold;">+</button>
            </div>
            <div id="listaTodo"></div>
        </div>

        <div id="metasContainer" class="todo-container" style="background: rgba(255, 152, 0, 0.05); border: 1px solid rgba(255, 152, 0, 0.2); border-radius: 12px;">
            <div style="display: flex; gap: 5px; margin-bottom: 10px;">
                <select id="metaMotivo" style="flex: 2; min-height: 35px; font-size: 12px; padding: 6px; border-radius: 8px; border: 1px solid rgba(255, 152, 0, 0.2); background: var(--bg-panel);"></select>
                <select id="metaTempo" style="flex: 1; min-height: 35px; font-size: 12px; padding: 6px; border-radius: 8px; border: 1px solid rgba(255, 152, 0, 0.2); background: var(--bg-panel);"></select>
                <button onclick="adicionarMeta()" style="min-width: 35px; min-height: 35px; padding: 0; border-radius: 8px; background: #ff9800; color: white; border: none; cursor: pointer; font-weight: bold;">+</button>
            </div>
            <div id="listaMetas"></div>
        </div>
    </div>

    <div class="menu-grid-group" style="border-top: 2px solid rgba(76, 175, 80, 0.2); padding-top: 15px;">
        <h4 style="opacity: 0.6; font-size: 12px; text-transform: uppercase; letter-spacing: 1px;">Prefer√™ncias</h4>
        
        <button id="btnTrocarSom" onclick="proximoSom()" style="background: linear-gradient(135deg, #607d8b, #455a64); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 12px rgba(96, 125, 139, 0.3);">
            <span style="font-size: 20px;">üîä</span> 
            <span>Som</span>
        </button>
        
        <button onclick="abrirConfig(); toggleMenu()" style="background: linear-gradient(135deg, #607d8b, #455a64); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 12px rgba(96, 125, 139, 0.3);">
            <span style="font-size: 20px;">‚öôÔ∏è</span> 
            <span>Config</span>
        </button>
    </div>
</div>
<div id="jardinsOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 35000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(8px); transition: all 0.3s ease;">
    <div id="jardinsContent" style="background: var(--bg-panel); width: 95%; max-width: 500px; max-height: 90vh; border-radius: 28px; padding: 30px; overflow-y: auto; position: relative; box-shadow: 0 20px 50px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1);">
        <button style="border-radius: 50px;" class="close-btn" onclick="fecharModal('jardinsOverlay')">√ó</button>
        
        <h2 style="color: var(--primary); margin-top: 0;">üèûÔ∏è Meus Jardins</h2>
        <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 20px;">Salve seu layout atual para visitar depois. (M√°x: 5)</p>

        <div id="listaJardinsSalvos" style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px;"></div>

        <button id="btnSalvarJardim" onclick="JardinsManager.salvarAtual()" style="width:100%; background: var(--accent); color: #333; font-weight: bold; border-radius: 50px; margin-bottom: 10px;">
            üíæ Salvar Grid Atual (3D)
        </button>

        <div id="visualizadorJardimContainer" style="display: none; margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h3 id="tituloVisualizador" style="margin:0; font-size: 16px; color: var(--primary);">Visualizando</h3>
                <button onclick="JardinsManager.fecharVisualizador()" style="padding: 5px 10px; font-size: 11px; background: #999; border-radius: 20px;">Voltar</button>
            </div>
            
            <div id="cenaJardimEspectador" style="width: 100%; height: 400px; background: var(--bg-body); border-radius: 15px; overflow: hidden; position: relative; border: 1px solid rgba(0,0,0,0.1);"></div>
            
            <div style="display: flex; justify-content: center; gap: 10px; margin-top: 10px;">
                <button onclick="JardinsManager.zoom(0.1)" style="width: 40px; background: var(--bg-panel); color: var(--text-main); border: 1px solid var(--primary); border-radius: 50%;">‚ûï</button>
                <button onclick="JardinsManager.zoom(-0.1)" style="width: 40px; background: var(--bg-panel); color: var(--text-main); border: 1px solid var(--primary); border-radius: 50%;">‚ûñ</button>
            </div>
        </div>

        <button onclick="fecharModal('jardinsOverlay')" class="secundario" style="width:100%; margin-top:10px; border-radius: 50px;">Fechar Menu</button>
    </div>
</div>



<div id="conteudo" onclick="fecharMenuSeAberto(event)">
    <div id="streakBadge" onclick="abrirDashboard()">‚òÄÔ∏è <span id="streakBadgeValue">0</span> dias</div>
    
    <div id="luckyPlantTag" class="lucky-plant-tag" style="display: none;">Sorte do dia: ...</div>

    <div class="painel-controle">
        <div style="display: flex; align-items: center; justify-content: center; gap: 4px; flex-wrap: wrap; margin-bottom: 5px;">
            <div style="display: flex; align-items: center; gap: 2px;">
                <select id="tempoEscolhido" style="min-width: 85px;"></select>
            </div>
            <span style="opacity: 0.2; margin: 0 2px;">|</span>
            <div style="display: flex; align-items: center; gap: 2px;">
                <select id="motivoEscolhido" style="min-width: 110px;"></select>
            </div>
        </div>
        <div id="painelInteligencia"></div>
        <div id="timer">25:00</div>
        
        <div style="display: flex; justify-content: center; gap: 5px;" id="mainButtons">
            <button id="btnStart" onclick="startTimer()" style="flex: 1; border-radius: 50px;">Iniciar Foco</button>
            <!-- NOVO: Bot√£o de adicionar foco manual -->
            <button id="btnAdicionarManual" onclick="adicionarFocoManual()" style="display: block; background: #666; color: white; max-width: 50px; border-radius: 50px; " disabled>+</button>
            <button id="btnBulldoze" onclick="bulldoze()" style="flex: 1; max-width: 50px; border-radius: 50px;" title="Remover todas as plantas">üå™</button>
            <button id="btnParar" class="cancelar" onclick="cancelTimer()" style="flex: 1; max-width: 100px; display: none; border-radius: 50px;">Parar</button>
        </div>

        <!-- Bot√£o de plantar fixo relativo ao painel (posicionado acima, centralizado) -->
        <button id="btnPlantAbovePanel" onclick="abrirModalPlanta(null)" title="Plantar" style="position: absolute; left: calc(50% - 35px); top: -62px; transform: translateX(-50%); width: 56px; height: 56px; border-radius: 50%; background: linear-gradient(45deg,#a8e6a1,#72c26a); border: 2px solid #5aa85a; font-size: 22px; box-shadow: 0 6px 16px rgba(0,0,0,0.25); cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--text-main); z-index: 1002; pointer-events: auto;" aria-label="Plantar"><img draggable="false" class="emoji" alt="üå±" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@17.0.2/assets/svg/1f331.svg" style="width:28px; height:28px;"></button>

        <!-- Bot√£o de expandir grid ao lado do plantar -->
        <button id="btnExpandGrid" onclick="expandGridManual()" style="position: absolute; left: calc(50% + 35px); top: -62px; transform: translateX(-50%); width: 56px; height: 56px; border-radius: 50%; background: linear-gradient(45deg,#a8e6a1,#72c26a); border: 2px solid #5aa85a; font-size: 18px; box-shadow: 0 6px 16px rgba(0,0,0,0.25); cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--text-main); z-index: 1002; pointer-events: auto;" title="Expandir Grid" aria-label="Expandir Grid"><img draggable="false" class="emoji" alt="üìê" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@17.0.2/assets/svg/1f4d0.svg" style="width:20px; height:20px;"><span style="font-size:16px; line-height:1; margin-left: -10px;">+</span></button>

    </div>

    <!-- Controles de Visualiza√ß√£o 3D (Fixos verticalmente ao lado esquerdo do painel) -->
    <div id="controlesZoom3D" class="no-pan" style="display: none; position: fixed; left: 15px; bottom: 20px; z-index: 10001; pointer-events: auto; display: flex; align-items: center;">
        <div style="display: flex; flex-direction: column; gap: 12px; pointer-events: auto; background: transparent; padding: 6px;">
            <button onclick="alterarZoom3D(0.1)" title="Aumentar Zoom" style="width: 45px; height: 45px; border-radius: 50%; background: var(--bg-panel); border: 2px solid var(--primary-color); font-size: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--text-main);" aria-label="Aumentar zoom">‚ûï</button>
            <button onclick="alterarZoom3D(-0.1)" title="Diminuir Zoom" style="width: 45px; height: 45px; border-radius: 50%; background: var(--bg-panel); border: 2px solid var(--primary-color); font-size: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--text-main);" aria-label="Diminuir zoom">‚ûñ</button>
            <button onclick="visaoPanoramica3D()" title="Vis√£o Panor√¢mica" style="width: 45px; height: 45px; border-radius: 50%; background: var(--bg-panel); border: 2px solid var(--primary-color); font-size: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--text-main);" aria-label="Vis√£o panor√¢mica">üñºÔ∏è</button>
        </div>
    </div>

    <!-- JARDIM 2D removido - sempre 3D -->
    
    <!-- NOVO: JARDIM 3D ISOM√âTRICO -->
    <div id="jardim3D">
        <div class="scene-3d">
            <div class="grid-container-3d" id="grid3D"></div>
        </div>
        <!-- Controles de Zoom 3D -->

    </div>
    
    <div id="painelMotivo" style="display:none; margin-top: 20px; padding: 15px; background: var(--bg-panel); border-radius: 10px; border-left: 5px solid var(--primary); max-width: 300px; margin: 20px auto;">
        <strong>Nota:</strong> <span id="textoMotivo"></span>
    </div>
</div>

<!-- Barra inferior removida intencionalmente -->

<div id="inventarioOverlay">
    <div id="inventarioContent">
        <span class="btn-fechar-modal" onclick="fecharModal('inventarioOverlay')">‚úñ</span>
        <h2 style="color: var(--primary)">üéí Meu Invent√°rio</h2>
        
        <div id="listaInventario" class="loja-grid">
            </div>

        <button onclick="fecharModal('inventarioOverlay')" class="secundario" style="width:100%; margin-top:20px; border-radius: 50px;">Fechar</button>
    </div>
</div>

<script>
/**
 * ============================================================
 * SISTEMA DE ARMAZENAMENTO PROFISSIONAL (INDEXEDDB + CACHE)
 * Vers√£o Final com Migra√ß√£o √önica e Limpeza Autom√°tica
 * ==========================================
 */

const DB_CONFIG = {
    name: 'GardenFocusDB',
    version: 1,
    storeName: 'gameState'
};

let memoryCache = {};
let dbConnection = null;
let isDatabaseReady = false;

const StorageSystem = {
    connect: function() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_CONFIG.name, DB_CONFIG.version);
            request.onupgradeneeded = (e) => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains(DB_CONFIG.storeName)) {
                    db.createObjectStore(DB_CONFIG.storeName);
                }
            };
            request.onsuccess = (e) => {
                dbConnection = e.target.result;
                resolve(dbConnection);
            };
            request.onerror = (e) => reject(e.target.error);
        });
    },

    loadToMemory: function() {
        return new Promise((resolve, reject) => {
            // Se n√£o houver conex√£o, carregamos tudo que existe no localStorage como fallback
            if (!dbConnection) {
                try {
                    for (let i = 0; i < localStorage.length; i++) {
                        const k = localStorage.key(i);
                        try {
                            memoryCache[k] = JSON.parse(localStorage.getItem(k));
                        } catch (e) {
                            memoryCache[k] = localStorage.getItem(k);
                        }
                    }
                } catch (e) {
                    console.warn('StorageSystem: falha ao carregar localStorage como fallback', e);
                }
                return resolve();
            }

            const transaction = dbConnection.transaction([DB_CONFIG.storeName], 'readonly');
            const store = transaction.objectStore(DB_CONFIG.storeName);
            const request = store.openCursor();
            request.onsuccess = (e) => {
                const cursor = e.target.result;
                if (cursor) {
                    memoryCache[cursor.key] = cursor.value;
                    cursor.continue();
                } else {
                    // Ap√≥s carregar do DB, garantimos que qualquer chave presente somente no localStorage seja promovida para o DB
                    try {
                        for (let i = 0; i < localStorage.length; i++) {
                            const k = localStorage.key(i);
                            if (!(k in memoryCache)) {
                                try {
                                    const parsed = JSON.parse(localStorage.getItem(k));
                                    memoryCache[k] = parsed;
                                    // Tenta persistir no DB para consolidar
                                    const tx = dbConnection.transaction([DB_CONFIG.storeName], 'readwrite');
                                    tx.objectStore(DB_CONFIG.storeName).put(parsed, k);
                                } catch (err) {
                                    memoryCache[k] = localStorage.getItem(k);
                                }
                            }
                        }
                    } catch (e) {
                        console.warn('StorageSystem: erro ao mesclar localStorage -> DB', e);
                    }
                    resolve();
                }
            };
            request.onerror = () => reject("Erro ao ler dados");
        });
    },

    setItem: function(key, value) {
        // Mant√©m em mem√≥ria para acesso r√°pido
        memoryCache[key] = value;

        // Escreve em localStorage como backup s√≠ncrono para garantir durabilidade imediata
        try {
            localStorage.setItem(key, JSON.stringify(value));
        } catch (e) {
            console.warn('StorageSystem: n√£o foi poss√≠vel gravar em localStorage (espaco/quota):', e);
        }

        // Tenta gravar no IndexedDB quando dispon√≠vel e retorna Promise para suportar awaits
        if (dbConnection) {
            try {
                return new Promise((resolve, reject) => {
                    try {
                        const transaction = dbConnection.transaction([DB_CONFIG.storeName], 'readwrite');
                        const req = transaction.objectStore(DB_CONFIG.storeName).put(value, key);

                        transaction.oncomplete = () => resolve(true);
                        transaction.onerror = (e) => {
                            console.warn("StorageSystem: erro na transa√ß√£o do DB", e);
                            resolve(false);
                        };
                        // No caso de rejei√ß√£o do request
                        req.onerror = (e) => {
                            console.warn("StorageSystem: falha ao gravar valor:", e);
                            resolve(false);
                        };
                    } catch (e) {
                        console.warn("Erro ao salvar no DB (conex√£o pode estar fechada):", e);
                        resolve(false);
                    }
                });
            } catch (e) {
                console.warn("Erro ao salvar no DB (exce√ß√£o):", e);
                return Promise.resolve(false);
            }
        } else {
            // Informa√ß√£o √∫til para depura√ß√£o: foi salvo apenas no localStorage por enquanto
            console.debug('StorageSystem: DB n√£o conectado ‚Äî valor salvo em localStorage como fallback para chave:', key);
            return Promise.resolve(true);
        }
    },

    migrateFromLegacy: async function() {
        if (localStorage.getItem('MIGRACAO_CONCLUIDA_V3')) return;
        
        // Lista de chaves para migrar (mantive a l√≥gica para n√£o perder o que voc√™ j√° tinha)
        const legacyKeys = [
            'jardim', 'historico_foco', 'moedasFoco', 'estante_livros', 
            'petsComprados', 'sessoesTotais', 'streakDiasAtivos', 'tempos', 
            'motivos', 'todos', 'metas', 'darkMode', 'modoNatal', 'modoMedieval',
            'medievalComprado', 'candyforniaComprado', 'eurosummerComprado',
            'eurosummerSessoes', 'eurosummerEmojisDesbloqueados', 'exibirEstrelas',
            'animacaoFundoAtiva', 'sinoAtivo', 'temaAutomaticoAtivo', 
            'mostrarAvisoInicio', 'mostrarPrevisao', 'aviso3DJaVisto',
            'somAtualIdx', 'profilePhoto', 'grid10x10', 'recursos',
            'romanceData', 'modoCandyfornia', 'modoEurosummer', 'modoFundoMar',
            'fundoMarComprado', 'jardimAquatico', 'fundoMarMetasConcluidas',
            'fundoMarEmojisDesbloqueados', 'vistoIntroEurosummer', 'vistoIntroFundoMar',
            'guiaEscolhidoFundoMar', 'manterTelaAtiva', 'diario_entradas',
            'jogadorNome', 'vistoPrimeiroUso', 'tutorialVisto', 'meuDiario'
        ];

        let migrouAlgo = false;
        // Verifica se h√° conex√£o antes de tentar transa√ß√£o
        if (!dbConnection) await this.connect();

        const transaction = dbConnection.transaction([DB_CONFIG.storeName], 'readwrite');
        const store = transaction.objectStore(DB_CONFIG.storeName);

        legacyKeys.forEach(key => {
            const rawValue = localStorage.getItem(key);
            if (rawValue !== null) {
                try {
                    const value = JSON.parse(rawValue);
                    store.put(value, key);
                    memoryCache[key] = value;
                    migrouAlgo = true;
                } catch (e) {
                    store.put(rawValue, key);
                    memoryCache[key] = rawValue;
                    migrouAlgo = true;
                }
            }
        });

        return new Promise((resolve) => {
            transaction.oncomplete = () => {
                if (migrouAlgo) {
                    showToast('üíæ', 'Sistema Atualizado', 'Seus dados foram migrados.');
                    localStorage.setItem('MIGRACAO_CONCLUIDA_V3', 'true');
                    legacyKeys.forEach(key => localStorage.removeItem(key));
                }
                resolve();
            };
            transaction.onerror = () => resolve();
        });
    },

    clearAllData: function() {
        return new Promise((resolve, reject) => {
            // 1. FECHA A CONEX√ÉO ATUAL OBRIGATORIAMENTE
            if (dbConnection) {
                dbConnection.close();
                dbConnection = null;
                console.log("Conex√£o com o banco fechada para exclus√£o.");
            }

            // 2. Deleta o banco de dados inteiro
            const req = indexedDB.deleteDatabase(DB_CONFIG.name);

            req.onsuccess = () => {
                console.log("Banco de dados deletado com sucesso.");
                memoryCache = {};
                resolve();
            };

            req.onerror = (e) => {
                console.error("Erro ao deletar banco:", e);
                resolve(); // Resolve mesmo com erro para permitir o reload
            };

            req.onblocked = () => {
                console.warn("A exclus√£o foi bloqueada pelo navegador. For√ßando reload...");
                resolve();
            };
        });
    }
};


async function bootApp() {
    try {
        await StorageSystem.connect();
        await StorageSystem.migrateFromLegacy();
        await StorageSystem.loadToMemory();
        isDatabaseReady = true;
        if (typeof init === 'function') init();
    } catch (err) {
        console.error("Erro no boot:", err);
        if (typeof init === 'function') init();
    }
}

// Inicializa√ß√£o
window.onload = null;
window.addEventListener('load', bootApp);
const StorageSeguro = {
    get: function(key, defaultValue) {
        if (!isDatabaseReady) {
            try {
                const item = localStorage.getItem(key);
                return item ? JSON.parse(item) : defaultValue;
            } catch (e) { return defaultValue; }
        }
        return memoryCache[key] !== undefined ? memoryCache[key] : defaultValue;
    },
    set: async function(key, value) {
        try {
            return await StorageSystem.setItem(key, value);
        } catch (e) {
            console.warn('StorageSeguro: falha ao salvar valor', e);
            return false;
        }
    },
    clear: async function() {
        // Limpa IndexedDB
        await StorageSystem.clearAllData();
        // Limpa LocalStorage
        localStorage.clear();
        return true;
    }
};

async function migrarParaBancoSeguro() {
    // Verifica se existe di√°rio no storage antigo
    const diarioAntigo = localStorage.getItem('meuDiario');
    
    if (diarioAntigo) {
        console.log("üì¶ Migrando Di√°rio para o Banco de Dados...");
        try {
            const dadosParseados = JSON.parse(diarioAntigo);
            // Salva no IndexedDB
            await StorageSeguro.set('meuDiario', dadosParseados);
            
            // Remove do LocalStorage (Limpeza)
            localStorage.removeItem('meuDiario');
            console.log("‚úÖ Migra√ß√£o conclu√≠da! LocalStorage est√° limpo.");
        } catch (e) {
            console.error("Erro na migra√ß√£o:", e);
        }
    }
}

// Executa ao iniciar
window.addEventListener('load', migrarParaBancoSeguro);

// Fun√ß√£o de verifica√ß√£o r√°pida para depura√ß√£o de persist√™ncia
function verificarPersistencia() {
    try {
        const keys = ['historico_foco','jardim','jardimAquatico','moedasFoco','tesouroAtivoIndex','ultimoTesouroData'];
        const resumo = {};
        keys.forEach(k => {
            const inMemory = memoryCache[k] !== undefined;
            let localVal = null;
            try { localVal = JSON.parse(localStorage.getItem(k)); } catch(e) { localVal = localStorage.getItem(k); }
            resumo[k] = { inMemory, inLocalStorage: localVal !== null && localVal !== undefined, localVal };
        });
        console.debug('verificarPersistencia:', resumo);
        return resumo;
    } catch (e) {
        console.error('verificarPersistencia falhou', e);
        return null;
    }
}

// =========================
// FUN√á√ïES PARA PRIMEIRO USO
// =========================
function mostrarPrimeiroUso() {
    document.getElementById('firstTimeOverlay').style.display = 'flex';
    document.getElementById('firstTimeContent').classList.add('modal-anim-in');
}

function pularPrimeiroUso() {
    StorageSeguro.set('jogadorNome', 'Jardineiro');
    StorageSeguro.set('vistoPrimeiroUso', true);
    document.getElementById('firstTimeOverlay').style.display = 'none';
    document.getElementById('firstTimeContent').classList.remove('modal-anim-in');
    location.reload();
}

function finalizarPrimeiroUso() {
    const nome = document.getElementById('firstTimeNameInput').value.trim();
    
    if (nome === '') {
        alert('Por favor, digite seu nome para continuar!');
        return;
    }
    
    StorageSeguro.set('vistoPrimeiroUso', true);
    StorageSeguro.set('jogadorNome', nome);
    
    document.getElementById('firstTimeOverlay').style.display = 'none';
    document.getElementById('firstTimeContent').classList.remove('modal-anim-in');
    
    location.reload();
}

// =========================
// SISTEMA DE PART√çCULAS SIMPLIFICADO E FUNCIONAL
// =========================
class ParticulasManager {
    constructor() {
        this.particulas = [];
        this.canvas = document.getElementById('bgCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.animacaoAtiva = false;
        this.ultimoTempo = 0;
        this.contadorParticulas = 0;
        this.temaAtual = 'padrao';
        this.animationId = null;
    }
    
    iniciar() {
        // For√ßar ativa√ß√£o se for modo fundo do mar
        if (modoFundoMar) animacaoFundoAtiva = true;
        
        if (!animacaoFundoAtiva) {
            this.parar();
            return;
        }
        this.redimensionarCanvas();
        this.criarParticulas();
        this.animacaoAtiva = true;
        this.animar();
        
        window.addEventListener('resize', () => {
            this.redimensionarCanvas();
        });
    }
    
    redimensionarCanvas() {
        this.canvas.width = window.innerWidth;
        this.canvas.height = window.innerHeight;
    }
    
    criarParticulas() {
        this.particulas = [];
        this.contadorParticulas = modoFundoMar ? 35 : (modoCandyfornia ? 40 : (modoNatal ? 60 : (modoMedieval ? 30 : 20)));
        this.temaAtual = modoFundoMar ? 'fundomar' : (modoCandyfornia ? 'candyfornia' : (modoNatal ? 'natal' : (modoMedieval ? 'medieval' : 'padrao')));
        
        for (let i = 0; i < this.contadorParticulas; i++) {
            this.particulas.push(this.criarParticula());
        }
    }
    
    criarParticula() {
        let cor, tamanho, velocidade;
        
        if (this.temaAtual === 'natal') {
            cor = '#FFFFFF';
            tamanho = Math.random() * 3 + 1;
            velocidade = Math.random() * 0.8 + 0.3;
        } else if (this.temaAtual === 'medieval') {
            const coresRosa = ['#FFB7C5', '#FFC0CB', '#F08080', '#FF69B4', '#F8BBD0'];
            cor = coresRosa[Math.floor(Math.random() * coresRosa.length)];
            tamanho = Math.random() * 4 + 2;
            velocidade = Math.random() * 1 + 0.5;
        } else if (this.temaAtual === 'candyfornia') {
            // NOVO: Modo Candyfornia
            const coresDoces = ['#FFB6C1', '#FF69B4', '#FF1493', '#FFC0CB', '#DB7093', '#FFD700'];
            cor = coresDoces[Math.floor(Math.random() * coresDoces.length)];
            tamanho = Math.random() * 4 + 2;
            velocidade = Math.random() * 1 + 0.5;
        } else if (this.temaAtual === 'fundomar') {
    // NOVO: Modo Fundo do Mar - Bolhas
    const coresBolhas = ['rgba(76, 201, 240, 0.6)', 'rgba(0, 180, 216, 0.5)', 'rgba(144, 224, 239, 0.7)'];
    cor = coresBolhas[Math.floor(Math.random() * coresBolhas.length)];
    tamanho = Math.random() * 6 + 3;
    
    // ALTERA√á√ÉO AQUI: Velocidade reduzida pela metade
    // Antes era: -(Math.random() * 1.5 + 0.8)
    velocidade = -(Math.random() * 0.3 + 0.1); // Agora varia entre -0.4 e -1.15
    
} else {

            const coresVerde = ['#81C784', '#AED581', '#66BB6A', '#4CAF50', '#388E3C'];
            cor = coresVerde[Math.floor(Math.random() * coresVerde.length)];
            tamanho = Math.random() * 5 + 3;
            velocidade = Math.random() * 1.2 + 0.5;
        }
        
        return {
            x: Math.random() * this.canvas.width,
            y: Math.random() * this.canvas.height,
            tamanho: tamanho,
            velocidade: velocidade,
            cor: cor,
            oscilacao: 0,
            oscilacaoVelocidade: 0,
            rotacao: Math.random() * Math.PI * 2,
            rotacaoVelocidade: (Math.random() - 0.5) * 0.01
        };
    }
    
    animar() {
        if (!this.animacaoAtiva || !animacaoFundoAtiva) {
            if (this.animationId) {
                cancelAnimationFrame(this.animationId);
                this.animationId = null;
            }
            return;
        }
        
        this.animationId = requestAnimationFrame(() => this.animar());
        
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        
        for (let i = 0; i < this.particulas.length; i++) {
            const p = this.particulas[i];
            
            p.y += p.velocidade;
            
            if (this.temaAtual === 'padrao') {
                p.rotacao += p.rotacaoVelocidade;
            }
            
            // Ajuste para resetar part√≠culas que sobem (bolhas) ou descem (outros temas)
            let saiuDaTela = false;
            if (this.temaAtual === 'fundomar') {
                if (p.y < -20 || p.x < -10 || p.x > this.canvas.width + 10) saiuDaTela = true;
            } else {
                if (p.y > this.canvas.height + 10 || p.x < -10 || p.x > this.canvas.width + 10) saiuDaTela = true;
            }

            if (saiuDaTela) {
                Object.assign(p, this.criarParticula());
                p.y = (this.temaAtual === 'fundomar') ? this.canvas.height + 20 : -10;
            }
            
            this.ctx.save();
            this.ctx.translate(p.x, p.y);
            
            if (this.temaAtual === 'padrao') {
                this.ctx.rotate(p.rotacao);
                this.ctx.fillStyle = p.cor;
                this.ctx.beginPath();
                this.ctx.ellipse(0, 0, p.tamanho, p.tamanho / 1.5, 0, 0, Math.PI * 2);
                this.ctx.fill();
            } else if (this.temaAtual === 'medieval') {
                this.ctx.fillStyle = p.cor;
                this.ctx.beginPath();
                this.ctx.arc(0, 0, p.tamanho, 0, Math.PI * 2);
                this.ctx.fill();
                
                this.ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                this.ctx.beginPath();
                this.ctx.arc(-p.tamanho/3, -p.tamanho/3, p.tamanho/2, 0, Math.PI * 2);
                this.ctx.fill();
            } else if (this.temaAtual === 'candyfornia') {
                // NOVO: Modo Candyfornia - formas de doces
                this.ctx.fillStyle = p.cor;
                this.ctx.beginPath();
                this.ctx.arc(0, 0, p.tamanho, 0, Math.PI * 2);
                this.ctx.fill();
                
                // Brilho no centro
                this.ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
                this.ctx.beginPath();
                this.ctx.arc(-p.tamanho/4, -p.tamanho/4, p.tamanho/3, 0, Math.PI * 2);
                this.ctx.fill();
                
                // Contorno brilhante
                this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.4)';
                this.ctx.lineWidth = 1;
                this.ctx.beginPath();
                this.ctx.arc(0, 0, p.tamanho, 0, Math.PI * 2);
                this.ctx.stroke();
            } else {
                this.ctx.fillStyle = p.cor;
                this.ctx.beginPath();
                this.ctx.arc(0, 0, p.tamanho, 0, Math.PI * 2);
                this.ctx.fill();
                
                this.ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                this.ctx.beginPath();
                this.ctx.arc(-p.tamanho/4, -p.tamanho/4, p.tamanho/3, 0, Math.PI * 2);
                this.ctx.fill();
            }
            
            this.ctx.restore();
        }
    }
    
    atualizarTema() {
        this.criarParticulas();
        if (!animacaoFundoAtiva) {
            this.parar();
        }
    }
    
    parar() {
        // Se for modo fundo do mar, ignorar o comando de parar para manter ativo a todo momento
        if (modoFundoMar) return;
        
        this.animacaoAtiva = false;
        if (this.animationId) {
            cancelAnimationFrame(this.animationId);
            this.animationId = null;
        }
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
    }
}
// =========================
// SISTEMA DE EFEITOS OTIMIZADO
// =========================
class EfeitosManager {
    constructor() {
        this.pool = [];
        this.activeElements = new Set();
        this.container = null;
        this.initContainer();
    }
    
    initContainer() {
        this.container = document.createElement('div');
        this.container.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
        `;
        document.body.appendChild(this.container);
    }
    
    criarElemento() {
        const div = document.createElement('div');
        div.style.cssText = `
            position: absolute;
            top: -50px;
            font-size: 24px;
            opacity: 0.8;
            will-change: transform, opacity;
        `;
        return div;
    }
    
    obterElemento() {
        if (this.pool.length > 0) {
            return this.pool.pop();
        }
        return this.criarElemento();
    }
    
    devolverElemento(element) {
        element.style.display = 'none';
        if (this.pool.length < 50) {
            this.pool.push(element);
        }
    }
    
    chuvaDeEfeitos(emoji = 'üéâ', quantidade = 35) {
        const emojiFinal = modoNatal ? 'üéÅ' : emoji;
        
        for(let i = 0; i < quantidade; i++) {
            setTimeout(() => {
                const elemento = this.obterElemento();
                elemento.textContent = emojiFinal;
                elemento.style.left = `${Math.random() * 100}vw`;
                elemento.style.animation = `fall ${Math.random() * 2 + 2}s linear forwards`;
                elemento.style.display = 'block';
                
                this.container.appendChild(elemento);
                this.activeElements.add(elemento);
                
                setTimeout(() => {
                    if (elemento.parentNode) {
                        elemento.parentNode.removeChild(elemento);
                    }
                    this.activeElements.delete(elemento);
                    this.devolverElemento(elemento);
                }, 4000);
            }, i * 150);
        }
    }
    
    limparTodos() {
        this.activeElements.forEach(elemento => {
            if (elemento.parentNode) {
                elemento.parentNode.removeChild(elemento);
            }
            this.devolverElemento(elemento);
        });
        this.activeElements.clear();
    }
}

// =========================
// SISTEMA DE √ÅUDIO OTIMIZADO
// =========================
class AudioManager {
    constructor() {
        this.audioCtx = null;
        this.noiseNode = null;
        this.currentSound = null;
        this.somAtualIdx = 0;
        this.sonsAmbiente = [
            { nome: "üîá Mudo", tipo: null },
            { nome: "üåßÔ∏è Chuva", tipo: "chuva" },
            { nome: "üå¨Ô∏è Vento", tipo: "vento" }
        ];
    }
    
    init() {
        this.somAtualIdx = parseInt(localStorage.getItem('somAtualIdx') || '0');
        document.getElementById('btnTrocarSom').textContent = this.sonsAmbiente[this.somAtualIdx].nome;
        this.tocarSomAtual();
    }
    
    fecharContexto() {
        if (this.audioCtx) {
            try {
                if (this.audioCtx.state !== 'closed') {
                    this.audioCtx.close();
                }
            } catch (e) {
                console.warn("Erro ao fechar audio context:", e);
            }
            this.audioCtx = null;
        }
        this.noiseNode = null;
        this.currentSound = null;
    }
    
    criarNoise(type) {
        this.fecharContexto();
        
        try {
            this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            
            if (type === null) {
                return;
            }
            
            const bufferSize = 2 * this.audioCtx.sampleRate;
            const noiseBuffer = this.audioCtx.createBuffer(1, bufferSize, this.audioCtx.sampleRate);
            const output = noiseBuffer.getChannelData(0);
            let lastOut = 0.0;
            
            for (let i = 0; i < bufferSize; i++) {
                const white = Math.random() * 2 - 1;
                output[i] = (lastOut + (0.02 * white)) / 1.02;
                lastOut = output[i];
                output[i] *= 3.5;
            }
            
            this.noiseNode = this.audioCtx.createBufferSource();
            this.noiseNode.buffer = noiseBuffer;
            this.noiseNode.loop = true;
            
            const filter = this.audioCtx.createBiquadFilter();
            filter.type = "lowpass";
            
            if (type === "chuva") {
                filter.frequency.value = 1000;
            } else if (type === "vento") {
                filter.frequency.value = 400;
                const lfo = this.audioCtx.createOscillator();
                const lfoGain = this.audioCtx.createGain();
                lfo.frequency.value = 0.2;
                lfoGain.gain.value = 200;
                lfo.connect(lfoGain);
                lfoGain.connect(filter.frequency);
                lfo.start();
            }
            
            this.noiseNode.connect(filter);
            filter.connect(this.audioCtx.destination);
            this.noiseNode.start();
            
            this.currentSound = type;
            
        } catch (e) {
            console.error("Erro ao criar √°udio:", e);
            this.fecharContexto();
        }
    }

    // Reproduz um breve som de vento (burst) por 'duration' ms (leve)
    playWindBurst(duration = 800) {
        try {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const bufferSize = 2 * ctx.sampleRate;
            const noiseBuffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
            const output = noiseBuffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) output[i] = Math.random() * 2 - 1;

            const src = ctx.createBufferSource();
            src.buffer = noiseBuffer;
            src.loop = true;

            const filter = ctx.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.value = 600;

            const gain = ctx.createGain();
            gain.gain.setValueAtTime(0.0001, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.12, ctx.currentTime + 0.02);
            gain.gain.exponentialRampToValueAtTime(0.02, ctx.currentTime + duration / 1000);

            src.connect(filter);
            filter.connect(gain);
            gain.connect(ctx.destination);
            src.start();
            
            setTimeout(() => {
                try { src.stop(); } catch (e) {}
                try { if (ctx.state !== 'closed') ctx.close(); } catch (e) {}
            }, duration);
        } catch (e) { console.warn('Erro ao tocar wind burst:', e); }
    }

    proximoSom() {
        this.somAtualIdx = (this.somAtualIdx + 1) % this.sonsAmbiente.length;
        StorageSeguro.set('somAtualIdx', this.somAtualIdx);
        
        const novoSom = this.sonsAmbiente[this.somAtualIdx].nome;
        document.getElementById('btnTrocarSom').textContent = novoSom;
        
        this.criarNoise(this.sonsAmbiente[this.somAtualIdx].tipo);
    }
    
    tocarSomAtual() {
        const tipoAtual = this.sonsAmbiente[this.somAtualIdx].tipo;
        this.criarNoise(tipoAtual);
    }
    
    parar() {
        this.fecharContexto();
    }
    
    tocarSino() {
        if (!sinoAtivo) return;
        
        try {
            const context = new (window.AudioContext || window.webkitAudioContext)();
            const osc = context.createOscillator();
            const gain = context.createGain();
            
            osc.type = "sine";
            osc.frequency.setValueAtTime(880, context.currentTime);
            osc.frequency.exponentialRampToValueAtTime(440, context.currentTime + 1);
            
            gain.gain.setValueAtTime(0.3, context.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, context.currentTime + 1);
            
            osc.connect(gain);
            gain.connect(context.destination);
            
            osc.start();
            
            setTimeout(() => {
                try {
                    if (context.state !== 'closed') {
                        context.close();
                    }
                } catch (e) {
                    // Ignorar erro ao fechar
                }
            }, 1500);
            
            osc.stop(context.currentTime + 1);
        } catch (e) {
            console.error("Erro ao tocar sino:", e);
        }
    }
}


const CAMINHO_TRILHOS = 'caminho-trilhos';
const CAMINHO_ASFALTO = 'caminho-asfalto';
const CAMINHO_PEDRA = 'caminho-pedra';
const AGUA_RIO = 'agua-rio';
const AGUA_RIO_MARGEM = 'agua-rio-margem';
const TIPOS_CAMINHO = [CAMINHO_TRILHOS, CAMINHO_ASFALTO, CAMINHO_PEDRA, AGUA_RIO, AGUA_RIO_MARGEM, 'üõ§Ô∏è','üõ£Ô∏è','üß±','üåä', 'lago'];

// Categorias de itens
const ITENS_ARVORES = ['üå≤','üå≥','üå¥','arvore-rosa','arvore-roxa','arvore-amarela','arvore-branca','arvore-colmeia','arvore-frutifera'];
const ITENS_FLORES = ['üåª','üåπ','üå∑','üåæ','üåø','‚òòÔ∏è','ü™¥'];
const ITENS_NATUREZA = ['üçÑ','üçÑ‚Äçüü´','‚õ∞Ô∏è','üóø','ü™®','‚õ≤Ô∏è','üåà', 'lago'];
const ITENS_CONSTRUCAO = ['üõ§Ô∏è','üõ£Ô∏è','üß±','üè†','üèò','üèØ','üè∞','‚õ™Ô∏è','‚õ©Ô∏è','üïå','üõï','üóº','ü™ß','üè°','üè¢','üè¨','üè≠','üè´','üè®','üõñ','üé™','üé°','poste-luz','banco-praca','piquenique','gazebo','torre','casa'];

const ITENS_PADRAO = [...ITENS_ARVORES, ...ITENS_FLORES, ...ITENS_NATUREZA, ...ITENS_CONSTRUCAO];

// Helper para normalizar nomes de √≠cones (tratar espa√ßos, mai√∫sculas e acentos)
function iconKey(s) {
    if (!s) return '';
    try {
        return s.toString().toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu, '').replace(/\s+/g, '-');
    } catch (e) {
        // Fallback para ambientes onde \p{Diacritic} n√£o √© suportado
        return s.toString().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/\s+/g, '-');
    }
} 

const ITENS_FUNDO_MAR_BASE = ['ü´ß','üêö','ü™∏','‚öì','üõ•','üö¢','üè∞','üèùÔ∏è'];
// Itens permitidos em ambos os modos (mar e terra)
const ITENS_ALLOW_AMBOS = ['üè∞'];
const ITENS_NATAL = ['üéÑ','üéÅ','üéÖ','ü§∂','‚õÑ','‚ùÑÔ∏è','‚õÑ','‚ùÑÔ∏è','üïØÔ∏è','üîî','üç™','ü•õ','üç¨','ü•ß','üß£','üß§'];
const ITENS_MEDIEVAL = ['üè∞','üèØ','‚öîÔ∏è','üõ°Ô∏è','üëë','üìú','üç∫','üçû','üçó','üïØÔ∏è','üõñ','‚õ∫','üèπ','üèá','üê≤','üî•'];
const ITENS_CANDYFORNIA = ['üç¨','üç≠','üç´','üç©','üç™','üéÇ','üç∞','üßÅ','ü•ß','üç®','üçß','üç¶','üçØ','üçÆ','‚òïÔ∏è','ü•§','üçπ','üßã','ü•ê','üçø'];
const ITENS_EUROSUMMER = ['üçã','‚òï','‚õ≤','ü™ª','üçá','üè†','‚õµ','üåª','ü•Ç','üèõÔ∏è','üè°','üíê','üåº'];
const CORES_LIVROS = [
    '#2e7d32', // Verde Original
    '#1565c0', // Azul Original
    '#c62828', // Vermelho Original
    '#ef6c00', // Laranja Original
    '#6a1b9a', // Roxo Original
    '#795548', // Marrom Original
    // --- Novas Cores ---
    '#ad1457', // Rosa Intenso (√ìtimo para Candyfornia)
    '#00838f', // Turquesa Oceano
    '#283593', // Azul Indigo (Mais escuro/Medieval)
    '#f9a825', // Amarelo Ouro (Combina com Natal)
    '#455a64', // Cinza Azulado (Elegante para Modo Noturno)
    '#00695c'  // Verde √Ågua Escuro
];

// Sistema de progress√£o removido (mantido como objeto vazio para compatibilidade)
const PROGRESSAO = {};


// Inst√¢ncias dos sistemas otimizados
const particulasManager = new ParticulasManager();
const efeitosManager = new EfeitosManager();
const audioManager = new AudioManager();

// Dados do jogo
let tempos = StorageSeguro.get('tempos', [1, 5, 10, 15, 25, 45, 60, 90]);
let motivos = StorageSeguro.get('motivos', ["Estudo", "Trabalho", "Leitura", "Sa√∫de"]);
let modoNatal = StorageSeguro.get('modoNatal', false);
let modoMedieval = StorageSeguro.get('modoMedieval', false);
let medievalComprado = StorageSeguro.get('medievalComprado', false);
let modoCandyfornia = StorageSeguro.get('modoCandyfornia', false);
let candyforniaComprado = StorageSeguro.get('candyforniaComprado', false);
let modoEurosummer = StorageSeguro.get('modoEurosummer', false);
let eurosummerComprado = StorageSeguro.get('eurosummerComprado', false);
let eurosummerSessoes = StorageSeguro.get('eurosummerSessoes', 0);
let eurosummerEmojisDesbloqueados = StorageSeguro.get('eurosummerEmojisDesbloqueados', []);
let modoFundoMar = StorageSeguro.get('modoFundoMar', false);

// NOVO: Grid Personalizado (Sucesssor do grid10x10)
let gridSize = StorageSeguro.get('gridSize', StorageSeguro.get('grid10x10', false) ? 10 : 3);
let grid10x10 = gridSize >= 8; // Mantido para compatibilidade com CSS legados e l√≥gica de densidade

let jardimDataAquatico = StorageSeguro.get('jardimAquatico', Array(gridSize * gridSize).fill(null));
let fundoMarComprado = StorageSeguro.get('fundoMarComprado', false);
let fundoMarMetasConcluidas = StorageSeguro.get('fundoMarMetasConcluidas', []);
let fundoMarEmojisDesbloqueados = StorageSeguro.get('fundoMarEmojisDesbloqueados', []);
let vistoIntroEurosummer = StorageSeguro.get('vistoIntroEurosummer', false);
let vistoIntroFundoMar = StorageSeguro.get('vistoIntroFundoMar', false);
let guiaEscolhidoFundoMar = StorageSeguro.get('guiaEscolhidoFundoMar', null); // 'üßú‚Äç‚ôÄÔ∏è' ou 'üßú‚Äç‚ôÇÔ∏è'
// Vari√°veis do Tesouro Di√°rio
let tesouroAtivoIndex = StorageSeguro.get('tesouroAtivoIndex', null); // Onde o tesouro est√° (null se n√£o houver)
let ultimoTesouroData = StorageSeguro.get('ultimoTesouroData', null); // Data da √∫ltima coleta


// Metas do Fundo do Mar (removidas - sistema de progress√£o desabilitado)
const METAS_FUNDO_MAR = [];
let exibirEstrelas = StorageSeguro.get('exibirEstrelas', true);
let animacaoFundoAtiva = StorageSeguro.get('animacaoFundoAtiva', true);
let escolhido = StorageSeguro.get('plantaEscolhida', (modoFundoMar ? (fundoMarEmojisDesbloqueados.length > 0 ? fundoMarEmojisDesbloqueados : ITENS_PADRAO) : (modoEurosummer ? (eurosummerEmojisDesbloqueados.length > 0 ? eurosummerEmojisDesbloqueados : ITENS_PADRAO) : (modoCandyfornia ? ITENS_CANDYFORNIA : (modoNatal ? ITENS_NATAL : (modoMedieval ? ITENS_MEDIEVAL : ITENS_PADRAO)))))[0]);
let alvo = null, intervalo = null;

function setAlvo(newAlvo, options = { render: true }) {
    if (newAlvo === null || typeof newAlvo === 'undefined') {
        alvo = null;
    } else {
        alvo = Number(newAlvo);
        if (Number.isNaN(alvo)) alvo = null;
    }

    if (options.render) {
        try { renderJardim(); } catch(e) { console.warn('Erro em renderJardim ao setAlvo', e); }
    }

    try { atualizarPreviewDoAlvo(); } catch(e) { console.warn('Erro em atualizarPreviewDoAlvo', e); }
}
let jardimDataNormal = StorageSeguro.get('jardim', Array(gridSize * gridSize).fill(null));
let jardimData = modoFundoMar ? jardimDataAquatico : jardimDataNormal;
let todos = StorageSeguro.get('todos', []);
let estante = StorageSeguro.get('estante_livros', []);
let sessoesTotais = StorageSeguro.get('sessoesTotais', 0);
let historico = StorageSeguro.get('historico_foco', []);
let totalMoedas = Number(StorageSeguro.get('moedasFoco', 0)) || 0;
let streakDiasAtivos = StorageSeguro.get('streakDiasAtivos', 0);
let luckyPlant = "";
let notaTemp = 0;
let corLivroTemp = CORES_LIVROS[0];
let sinoAtivo = StorageSeguro.get('sinoAtivo', true);
let temaAutomaticoAtivo = StorageSeguro.get('temaAutomaticoAtivo', true);
// Sincronizar nomes de vari√°veis para evitar confus√£o
// Sincronizar nomes de vari√°veis para evitar confus√£o
// Removido temaAutomaticoAtivo redundante para usar apenas temaAutomaticoAtivo

let mostrarAvisoInicio = StorageSeguro.get('mostrarAvisoInicio', true);
let mostrarPrevisao = StorageSeguro.get('mostrarPrevisao', true);
let metas = StorageSeguro.get('metas', []);
// Sempre 3D - modo 2D removido
let aviso3DJaVisto = StorageSeguro.get('aviso3DJaVisto', false);
// NOVO: Sistema para manter tela ativa
let wakeLock = null;
let manterTelaAtiva = StorageSeguro.get('manterTelaAtiva', true);
// ... suas vari√°veis existentes ...


let petsComprados = StorageSeguro.get('petsComprados', []); 
// Cada pet agora ter√° uma propriedade 'ultimoCarinho' interna

let petsEmCena = []; 
let intervaloPets = null;
let intervaloVaquinha = null;
const LIMITE_PETS = 2; // Limite definido


// =========================
// FUN√á√ïES DE PERSIST√äNCIA DO TIMER - CORRIGIDAS
// =========================
function salvarTimerAtivo() {
    if (!intervalo) {
        StorageSeguro.set('timerAtivo', null);
        return;
    }
    
    const motivo = document.getElementById('motivoEscolhido')?.value || '';
    const tempoEscolhidoRaw = document.getElementById('tempoEscolhido')?.value || '25';
    const tempoEscolhido = Number(tempoEscolhidoRaw) || 25;
    
    // Calcular o tempo restante do display
    const timerText = document.getElementById('timer')?.textContent || '25:00';
    const [minutos, segundos] = timerText.split(':').map(v => Number(v) || 0);
    const tempoRestante = minutos * 60 + segundos;
    
    const timerData = {
        alvo: alvo,
        inicio: Date.now() - (tempoEscolhido * 60 - tempoRestante) * 1000, // Tempo de in√≠cio ajustado
        duracao: tempoEscolhido * 60, // em segundos
        motivo: motivo,
        escolhido: escolhido,
        tempoRestante: tempoRestante
    };
    
    StorageSeguro.set('timerAtivo', timerData);
}

function recriarTimerSeExistir() {
    // Se o modo Coop j√° estiver tentando reconectar, evitamos duplicidade aqui
    

    const timerData = StorageSeguro.get('timerAtivo', null);
    
    if (!timerData) {
        return;
    }
    
    const agora = Date.now();
    const tempoPassado = Math.floor((agora - timerData.inicio) / 1000); // em segundos
    let tempoRestante = timerData.duracao - tempoPassado; // MUDAN√áA: usar let em vez de const
    
    if (tempoRestante <= 0) {
        // Timer j√° expirou, finalizar o foco
        StorageSeguro.set('timerAtivo', null);
        if (intervalo) { clearInterval(intervalo); intervalo = null; }
        
        // Verificar se j√° foi registrado no hist√≥rico
        const hoje = new Date().toISOString().split('T')[0];
        const jaRegistrado = historico.some(s => {
            const sessaoData = new Date(s.data).toISOString().split('T')[0];
            return sessaoData === hoje && s.status === 'sucesso' && s.motivo === timerData.motivo;
        });
        
        if (!jaRegistrado) {
            // Finalizar como sucesso
            setAlvo(timerData.alvo);
            escolhido = timerData.escolhido;
            if (document.getElementById('motivoEscolhido')) document.getElementById('motivoEscolhido').value = timerData.motivo;
            if (document.getElementById('tempoEscolhido')) document.getElementById('tempoEscolhido').value = timerData.duracao / 60;
            
            const emojiFinal = evoluirEmoji(escolhido);
            const isLucky = escolhido === luckyPlant;
            
            // Verificar bounds do alvo antes de escrever
            const total = getTotalCells();
            if (alvo !== null && Number.isInteger(alvo) && alvo >= 0 && alvo < total) {
                // Evita sobrepor caminhos por engano
                if (!jardimData[alvo] || !ehCaminhoEmoji(jardimData[alvo].icone)) {
                    jardimData[alvo] = { 
                        icone: emojiFinal, 
                        motivo: timerData.motivo, 
                        lucky: !!isLucky
                    };
                } else {
                    console.warn('recriarTimerSeExistir: n√£o plantou porque c√©lula era caminho no √≠ndice', alvo);
                }
            } else {
                console.warn('recriarTimerSeExistir: alvo inv√°lido, pulando plantio', alvo);
            }
            
            sessoesTotais++;
            historico.push({ 
                data: new Date(timerData.inicio).toISOString(), 
                minutos: timerData.duracao / 60, 
                motivo: timerData.motivo, 
                icone: emojiFinal, 
                mes: new Date(timerData.inicio).getMonth(), 
                ano: new Date(timerData.inicio).getFullYear(), 
                status: 'sucesso' 
            });
            
            updateMoedas(isLucky ? 2 : 1);
            atualizarStreak();
            salvarTudo();
            renderSelects();
        }
        
        return;
    }
    
    // Recriar o timer
    setAlvo(timerData.alvo);
    escolhido = timerData.escolhido;
    if (document.getElementById('motivoEscolhido')) document.getElementById('motivoEscolhido').value = timerData.motivo;
    if (document.getElementById('tempoEscolhido')) document.getElementById('tempoEscolhido').value = timerData.duracao / 60;
    
    // Timers n√£o exibem est√°gio intermedi√°rio; a c√©lula ser√° atualizada ao finalizar
    renderJardim();
    if (document.getElementById('painelInteligencia')) document.getElementById('painelInteligencia').style.display = 'none';
    if (document.getElementById('btnStart')) document.getElementById('btnStart').style.display = 'none';
    if (document.getElementById('btnParar')) document.getElementById('btnParar').style.display = 'block';
    
    // CORRE√á√ÉO: Usar closure para manter a refer√™ncia √† vari√°vel tempoRestante
    intervalo = setInterval(() => { 
        tempoRestante--; 
        let m = Math.floor(tempoRestante/60), s = tempoRestante%60; 
        document.getElementById('timer').textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; 
        if(tempoRestante <= 0) {
            finalizarFoco(); gerenciarTelaAtiva(false);
            limparTimerAtivo();
        } else {
            salvarTimerAtivo(); // Salvar periodicamente
        }
    }, 1000);
    
    // Atualizar display imediatamente
    let m = Math.floor(tempoRestante/60), s = tempoRestante%60; 
    document.getElementById('timer').textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    
    atualizarBotoes();
    
    // Salvar novamente para manter atualizado
    salvarTimerAtivo();
}

function limparTimerAtivo() {
    StorageSeguro.set('timerAtivo', null);
}

// =========================
// FUN√á√ïES EXISTENTES MODIFICADAS
// =========================
function iniciarTimer(viaRede = false, tempoForcado = null) {
    if (intervalo) {
        clearInterval(intervalo);
        intervalo = null;
    }

    // Validar tempo escolhido
    let tempo = tempoForcado !== null ? Number(tempoForcado) : Number(document.getElementById('tempoEscolhido')?.value || 25) * 60;
    if (isNaN(tempo) || tempo <= 0) tempo = 25 * 60;

    // Validar planta escolhida
    if (!escolhido) {
        showToast('‚ö†Ô∏è', 'Escolha uma planta', 'Selecione uma planta antes de iniciar o foco.');
        abrirModalPlanta(null);
        return;
    }

    // Validar alvo (deve estar selecionado para plantar)
    if (alvo === null || alvo === undefined) {
        showToast('‚ö†Ô∏è', 'Local n√£o selecionado', 'Selecione uma c√©lula vazia no jardim para plantar.');
        return;
    }

    const emojiEstagio = obterEmojiEstagio(escolhido);

    // Bloqueio: n√£o permite iniciar um foco (plantar) em cima de caminhos
    if (jardimData[alvo] && ehCaminhoEmoji(jardimData[alvo].icone)) {
        showToast('‚ö†Ô∏è', 'Imposs√≠vel plantar', 'Voc√™ n√£o pode plantar em cima de caminhos.');
        console.warn('iniciarTimer bloqueado: c√©lula com caminho no √≠ndice', alvo);
        return;
    }

    // N√£o marcar c√©lula como 'emProgresso' ‚Äî progress√£o removida
    renderJardim();
    
    // Ocultar campos durante o foco
    document.getElementById('motivoEscolhido').style.display = 'none';
    document.getElementById('tempoEscolhido').style.display = 'none';
    
    // Ativar modo background para funcionar minimizado
    iniciarBackgroundMode();
    
    // Iniciar timer no Worker (funciona em background)
    if (workerGlobal) {
        workerGlobal.postMessage({ comando: 'iniciar_timer', id: 'principal', tempo: tempo });
    }
    
    let tempoRestante = tempo; 
    intervalo = setInterval(() => { 
        tempoRestante--; 
        if(tempoRestante <= 0) {
            document.getElementById('timer').textContent = "00:00";
            finalizarFoco(); 
            limparTimerAtivo();
            clearInterval(intervalo);
            intervalo = null;
            pararBackgroundMode();
        } else {
            let m = Math.floor(tempoRestante/60), s = tempoRestante%60; 
            document.getElementById('timer').textContent = (m<10?"0":"")+m+":"+(s<10?"0":"")+s;
            if (tempoRestante % 60 === 0) salvarTudo();
        }
    }, 1000);
    // Registrar timestamp de in√≠cio e atualizar bot√µes para refletir estado ativo
    startTime = Date.now();
    atualizarBotoes();
}

function cancelTimer(viaRede = false) { 
            
    
    if(intervalo) {
        const confirmCancel = () => {
            // Se n√£o for via rede, envia o comando para o parceiro
            if (!viaRede && false) {
                
            }
            

            // NOVO: Desativar manuten√ß√£o de tela
                if (wakeLock) {
                    wakeLock.release();
                    wakeLock = null;
                }
                
                // Parar modo background global
                pararBackgroundMode();
                
                // Habilidade C√£ozinho: Recupera 50% das moedas ao desistir
                if (petsComprados.some(p => p.icone === 'üêï')) {
                    const tempoDecorrido = Math.floor((Date.now() - startTime) / 1000 / 60);
                    const moedasRecuperadas = Math.floor(tempoDecorrido / 10);
                    if (moedasRecuperadas > 0) {
                        updateMoedas(moedasRecuperadas);
                        showToast('üêï', 'C√£ozinho te ajudou!', `+${moedasRecuperadas} moedas recuperadas`);
                    }
                }
                
                clearInterval(intervalo); intervalo = null; 
                const failureEmoji = getFailureEmoji(escolhido);
                if (alvo !== null) {
                    const motivoFalha = document.getElementById('motivoEscolhido') ? document.getElementById('motivoEscolhido').value : '';
                    jardimData[alvo] = { icone: failureEmoji, motivo: motivoFalha + " (Falha)", lucky: false };
                    historico.push({ data: new Date().toISOString(), minutos: 0, motivo: motivoFalha, status: 'falha' });
                }
                setAlvo(null);
                atualizarPreviewDoAlvo();
                document.getElementById('btnStart').style.display = 'block';
                document.getElementById('btnParar').style.display = 'none';
                
                 // Limpar o timer ativo do storage
                limparTimerAtivo();
                
                renderJardim();
                atualizarBotoes();
        };

        if (viaRede) {
            confirmCancel();
        } else {
            showModal({ 
                text: "Desistir?", 
                onConfirm: confirmCancel,
                onCancel: () => {}
            });
        }
    }
}

function finalizarFoco() {
    // Garantir que o timer e modos de background parem
    if (intervalo) { clearInterval(intervalo); intervalo = null; }
    try { if (workerGlobal) workerGlobal.postMessage({ comando: 'parar_timer', id: 'principal' }); } catch(e){}
    pararBackgroundMode();

    // Dados do plantio
    const emojiFinal = (typeof evoluirEmoji === 'function') ? evoluirEmoji(escolhido) : escolhido;
    const motivo = document.getElementById('motivoEscolhido') ? document.getElementById('motivoEscolhido').value : '';
    const minutos = Number(document.getElementById('tempoEscolhido') ? document.getElementById('tempoEscolhido').value : 25);
    const isLucky = (escolhido === luckyPlant);

    if (alvo !== null) {
        const total = getTotalCells();
        if (Number.isInteger(alvo) && alvo >= 0 && alvo < total) {
            // N√£o plantar sobre caminhos
            if (jardimData[alvo] && ehCaminhoEmoji(jardimData[alvo].icone)) {
                console.warn('finalizarFoco: c√©lula √© caminho, cancelando plantio', alvo);
                showToast('‚ö†Ô∏è', 'Plantar cancelado', 'O local selecionado √© um caminho.');
            } else {
                jardimData[alvo] = { icone: emojiFinal, motivo: motivo, minutos: minutos, lucky: !!isLucky };

                // Persistir no storage correto
                if (modoFundoMar) StorageSeguro.set('jardimAquatico', jardimData);
                else StorageSeguro.set('jardim', jardimData);

                // Hist√≥rico
                historico.push({ data: new Date().toISOString(), minutos: minutos, motivo: motivo, status: 'sucesso' });

                // Feedback
                showToast('üå≥', 'Planta cresceu!', '√ìtimo trabalho ‚Äî sua planta cresceu!');
                if (navigator.vibrate) navigator.vibrate([200,100,200]);
            }
        } else {
            console.warn('finalizarFoco: alvo inv√°lido, plantio ignorado', alvo);
        }
    }

    // Expans√£o autom√°tica do grid desabilitada para preservar o jardim
    // const occupied = new Set();
    // jardimData.forEach((x, i) => { if (x) occupied.add(i); });
    // petsEmCena.forEach(p => occupied.add(p.index));
    // const emptyCells = gridSize * gridSize - occupied.size;
    // console.log('Expans√£o check: occupied', occupied.size, 'total cells', gridSize * gridSize, 'empty', emptyCells);
    // if (emptyCells === 0 && gridSize < 10) {
    //     console.log('Expandindo grid para', gridSize + 1);
    //     gridSize++;
    //     const newCells = gridSize * gridSize - jardimData.length;
    //     jardimData.push(...Array(newCells).fill(null));
    //     StorageSeguro.set('gridSize', gridSize);
    //     if (modoFundoMar) StorageSeguro.set('jardimAquatico', jardimData);
    //     else StorageSeguro.set('jardim', jardimData);
    //     renderJardim3D();
    //     showToast('üìè', 'Jardim expandido!', `Grid aumentou para ${gridSize}x${gridSize}`);
    // }

    // Limpeza e UI
    limparTimerAtivo();
    setAlvo(null, { render: false }); // Limpar sele√ß√£o de alvo ap√≥s foco
    document.getElementById('btnStart').style.display = 'block';
    document.getElementById('btnParar').style.display = 'none';
    
    // Mostrar campos novamente
    document.getElementById('motivoEscolhido').style.display = 'block';
    document.getElementById('tempoEscolhido').style.display = 'block';

    renderJardim();
    atualizarBotoes();
    try { if (typeof salvarTudo === 'function') salvarTudo(); } catch(e) {}
}

function mostrarInfoEstante() {
    const LIVROS_POR_ANDAR = 12;
    const totalAndares = Math.ceil(estante.length / LIVROS_POR_ANDAR);
    const livrosComNotaMaxima = estante.filter(l => l.nota === 5).length;
    
    let mensagem = `<strong>üìä Estat√≠sticas da Estante</strong><br><br>`;
    mensagem += `üìö <strong>Livros totais:</strong> ${estante.length}<br>`;
    mensagem += `üèóÔ∏è <strong>Andares:</strong> ${totalAndares}<br>`;
    mensagem += `‚≠ê <strong>Livros com nota m√°xima (5):</strong> ${livrosComNotaMaxima}<br>`;
    mensagem += `üìà <strong>Capacidade atual:</strong> ${estante.length}/${totalAndares * LIVROS_POR_ANDAR} livros<br><br>`;
    mensagem += `üéØ <small>Cada andar suporta at√© ${LIVROS_POR_ANDAR} livros. Continue lendo para expandir sua biblioteca!</small>`;
    
    showModal({ 
        text: mensagem, 
        onConfirm: () => {} 
    });
}

// =========================
// TUTORIAL INTERATIVO (SIMPLIFICADO)
// =========================
const TUTORIAL_STEPS = [
    {
        icon: 'üå±',
        title: 'Bem-vindo ao Garden Focus!',
        text: 'Seu jardim est√° pronto para florecer! Vamos ver o essencial para come√ßar a focar.',
        location: null
    },
    {
        icon: 'ü™¥',
        title: 'Seu Jardim',
        text: '√â onde suas plantas e constru√ß√µes crescem. Clique em um espa√ßo vazio sempre que quiser focar.',
        location: 'jardim'
    },
    {
        icon: '‚è±Ô∏è',
        title: 'Timer e Motivo',
        text: 'Defina o tempo de foco e o motivo. Clique em "Iniciar Foco" para come√ßar.',
        location: 'timer'
    },
    {
        icon: '‚ò∞',
        title: 'Menu Principal',
        text: 'Acesse a Estante e Configura√ß√µes por aqui.',
        location: 'menu'
    },
    {
        icon: 'üöÄ',
        title: 'Pronto para Focar!',
        text: 'Foque, veja seu jardim crescer e divirta-se! Boa jornada!',
        location: null
    }
];

let tutorialAtual = 0;
let tutorialAtivo = false;

function iniciarTutorial() {
    fecharModal('configOverlay');
    fecharModal('firstTimeOverlay');
    
    tutorialAtual = 0;
    tutorialAtivo = true;
    
    const overlay = document.getElementById('tutorialOverlay');
    overlay.style.display = 'flex';
    
    renderizarProgressoTutorial();
    mostrarPassoTutorial();
}
// Fun√ß√£o `petDeveAparecer` movida/atualizada mais abaixo para evitar duplica√ß√£o


// Fun√ß√£o de progresso do tutorial desabilitada (removido indicador visual)
function renderizarProgressoTutorial() {
    // noop
}

function mostrarPassoTutorial() {
    const step = TUTORIAL_STEPS[tutorialAtual];
    const icon = document.getElementById('tutorialIcon');
    const title = document.getElementById('tutorialTitle');
    const text = document.getElementById('tutorialText');
    const locationDiv = document.getElementById('tutorialLocation');
    const locationText = document.getElementById('tutorialLocationText');
    const prevBtn = document.getElementById('tutorialPrevBtn');
    const nextBtn = document.getElementById('tutorialNextBtn');
    const stepCounter = document.getElementById('tutorialStepCounter');
    
    icon.textContent = step.icon;
    title.textContent = step.title;
    text.innerHTML = step.text;
    stepCounter.textContent = `Passo ${tutorialAtual + 1} de ${TUTORIAL_STEPS.length}`;
    
    if (step.location) {
        locationDiv.style.display = 'flex';
        locationText.innerHTML = step.location;
    } else {
        locationDiv.style.display = 'none';
    }
    
    prevBtn.style.display = tutorialAtual === 0 ? 'none' : 'block';
    nextBtn.textContent = tutorialAtual === TUTORIAL_STEPS.length - 1 ? 'Concluir' : 'Pr√≥ximo';
    
    renderizarProgressoTutorial();
}

function tutorialProximo() {
    if (tutorialAtual < TUTORIAL_STEPS.length - 1) {
        tutorialAtual++;
        mostrarPassoTutorial();
    } else {
        finalizarTutorial();
    }
}

function tutorialAnterior() {
    if (tutorialAtual > 0) {
        tutorialAtual--;
        mostrarPassoTutorial();
    }
}

function tutorialPular() {
    finalizarTutorial();
}

function finalizarTutorial() {
    tutorialAtivo = false;
    const overlay = document.getElementById('tutorialOverlay');
    overlay.style.display = 'none';
    
    StorageSeguro.set('tutorialVisto', true);
}

function verificarPrimeiroAcesso() {
    const tutorialVisto = StorageSeguro.get('tutorialVisto', false);
    const nomeUsuario = StorageSeguro.get('jogadorNome', null);
    
    if (!tutorialVisto && nomeUsuario) {
        setTimeout(() => {
            iniciarTutorial();
        }, 500);
    }
}

// =========================
// FUN√á√ÉO PARA AJUSTE DIN√ÇMICO DO 3D
// =========================
let zoom3DManual = StorageSeguro.get('zoom3DManual', 1.0);
let panX3D = StorageSeguro.get('panX3D', 0);
let panY3D = StorageSeguro.get('panY3D', 0);
var isDragging3D = false;
let startX3D, startY3D;
let lastPanX3D = panX3D;
let lastPanY3D = panY3D;

// Touch Zoom/Pinch
let isPinching3D = false;
let startPinchDistance = 0;
let startZoom3D = 1.0;

function alterarZoom3D(delta) {
    zoom3DManual = Math.max(0.5, Math.min(2.0, zoom3DManual + delta));
    StorageSeguro.set('zoom3DManual', zoom3DManual);
    ajustarTamanho3D();
}

function visaoPanoramica3D() {
    // Ajusta o zoom para ver todo o jardim e reseta o pan
    zoom3DManual = grid10x10 ? 0.6 : 0.85;
    panX3D = 0;
    panY3D = 0;
    StorageSeguro.set('zoom3DManual', zoom3DManual);
    StorageSeguro.set('panX3D', panX3D);
    StorageSeguro.set('panY3D', panY3D);
    ajustarTamanho3D();
    showToast('üñºÔ∏è', 'Vis√£o Panor√¢mica', 'Zoom ajustado para ver tudo');
}


function ajustarTamanho3D() {
    
    const jardim3D = document.getElementById('jardim3D');
    const controlesZoom = document.getElementById('controlesZoom3D');

    const grid3D = document.getElementById('grid3D');
    const gridSize = getGridSize();

    // Exibe/oculta controles de zoom no mobile
    const viewportWidth = window.innerWidth;
    const isMobile = viewportWidth <= 899;
    if (controlesZoom) {
        if (isMobile) {
            controlesZoom.style.display = 'none';
        } else {
            controlesZoom.style.display = 'flex';
            // Reposicionar dinamicamente para ficar junto ao bot√£o de menu (esquerda, abaixo)
            const menuBtn = document.getElementById('abrirMenuBtn');
            if (menuBtn) {
                const rect = menuBtn.getBoundingClientRect();
                controlesZoom.style.left = `${rect.left}px`;
                // Fixar na parte inferior do dispositivo, alinhado horizontalmente com o bot√£o do menu
                controlesZoom.style.bottom = `20px`;
                controlesZoom.style.position = 'fixed';
                controlesZoom.style.zIndex = '10001';
            }
        }
        if (typeof updatePlantButtonPosition === 'function') updatePlantButtonPosition();
    }
    
    if (!jardim3D || !grid3D) return;
    
    // Calcular tamanho baseado na viewport
    const viewportHeight = window.innerHeight;
    const isLandscape = viewportWidth > viewportHeight;
    
    let cellSize, scaleFactor = 1;
    
    if (isMobile) {
        if (grid10x10) {
            // Grid 10x10 em mobile - Ajustado para evitar que as c√©lulas fiquem muito pequenas
            if (isLandscape) {
                cellSize = Math.min(viewportHeight * 0.09, 38);
                scaleFactor = 0.8;
            } else {
                cellSize = Math.min(viewportWidth * 0.09, 35);
                scaleFactor = 0.85;
            }
        } else {
            // Grid 5x5 em mobile
            if (isLandscape) {
                cellSize = Math.min(viewportHeight * 0.12, 45);
                scaleFactor = 0.8;
            } else {
                cellSize = Math.min(viewportWidth * 0.15, 45);
                scaleFactor = 0.9;
            }
        }
    } else {
        // Desktop
        if (grid10x10) {
            cellSize = Math.min(viewportWidth * 0.05, 50);
            scaleFactor = 0.9;
        } else {
            cellSize = Math.min(viewportWidth * 0.07, 84);
            scaleFactor = 1;
        }
    }
    
    // Aplicar tamanho m√≠nimo
    cellSize = Math.max(cellSize, grid10x10 ? 28 : 32);
    
    // APLICAR ZOOM MANUAL DIRETAMENTE NO TAMANHO DA C√âLULA (Como no Candyfornia)
    // Isso evita a deforma√ß√£o (achatamento) dos emojis
    const finalCellSize = cellSize * zoom3DManual;
    
    document.documentElement.style.setProperty('--cell-3d-size', `${finalCellSize}px`);
    document.documentElement.style.setProperty('--scale-3d', scaleFactor.toString());
    
    // Aplicar Pan, Rota√ß√£o e Escala (Scale) com para evitar conflitos
    // O scaleFactor garante que o grid caiba na tela, o zoom3DManual afeta o tamanho interno
    let baseScale = scaleFactor;
    if (grid10x10) baseScale *= 0.92; // Redu√ß√£o estrat√©gica para o grid 10x10 caber melhor
    
    const transformation = `translate(${panX3D}px, ${panY3D}px) rotateX(60deg) rotateZ(45deg) scale(${baseScale})`;
    grid3D.style.setProperty('transform', transformation, 'important');
    
    // Adicionar classe de ajuste
    grid3D.classList.add('ajustado');
    
    // Ajustar altura do container com margem de seguran√ßa (levando em conta a escala)
    const projectedHeight = (finalCellSize * gridSize * 0.866) * baseScale; 
    jardim3D.style.height = `${projectedHeight + 60}px`; // Margem aumentada para 60px
}

// Recalcula o tamanho/posicionamento ao redimensionar a viewport
window.addEventListener('resize', ajustarTamanho3D);

// Fun√ß√£o toggleModo3D removida - sempre 3D
// =========================
// FUN√á√ÉO UTILIT√ÅRIA: TOAST (NOTIFICA√á√ÉO)
// =========================
function showToast(icon, title, message, persistente = false) {
    // Remove toast anterior se houver (para n√£o acumular)
    const existingToast = document.querySelector('.pet-toast-moderno');
    if (existingToast) {
        existingToast.remove();
    }

    // Cria o elemento do toast
    const toast = document.createElement('div');
    toast.className = 'pet-toast-moderno' + (persistente ? ' persistente' : '');
    
    // Define o conte√∫do HTML igual ao estilo CSS j√° existente
    toast.innerHTML = `
        <div class="toast-content">
            <span class="toast-icon">${icon}</span>
            <div class="toast-text">
                <strong>${title}</strong>
                <span>${message}</span>
            </div>
        </div>

    `;

    document.body.appendChild(toast);

    // Configura a remo√ß√£o autom√°tica (4 segundos) se n√£o for persistente
    if (!persistente) {
        setTimeout(() => {
            toast.classList.add('saindo'); // Aciona anima√ß√£o de sa√≠da do CSS
            
            // Remove do DOM ap√≥s a anima√ß√£o terminar
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 500); // Tempo da anima√ß√£o 'toastSaida'
        }, 4000); // Tempo de exibi√ß√£o na tela
    }
}

function removerToastPersistente() {
    const existingToast = document.querySelector('.pet-toast-moderno.persistente');
    if (existingToast) {
        existingToast.classList.add('saindo');
        setTimeout(() => {
            if (existingToast.parentNode) existingToast.parentNode.removeChild(existingToast);
        }, 500);
    }
}

function abrirAviso3D() {
    document.getElementById('aviso3DOverlay').style.display = 'flex';
}

function fecharAviso3D() {
    document.getElementById('aviso3DOverlay').style.display = 'none';
    aviso3DJaVisto = true;
    StorageSeguro.set('aviso3DJaVisto', true);
    
    // atualizarVisibilidadeModo3D(); // Removido - sempre 3D
    renderJardim();
    
    // Bot√£o removido - sempre 3D
    
    // Ajustar tamanho ap√≥s ativar
    setTimeout(ajustarTamanho3D, 100);
}

// Fun√ß√£o atualizarVisibilidadeModo3D removida - sempre 3D

// Bot√£o agora √© posicionado via CSS dentro do painel (absoluto) ‚Äî esta fun√ß√£o apenas garante que esteja vis√≠vel
function updatePlantButtonPosition() {
    const btn = document.getElementById('btnPlantAbovePanel');
    if (!btn) return;
    btn.style.display = 'flex';
}

// Atualiza o sprite/√≠cone do bot√£o de plantar conforme a planta selecionada
function updatePlantButtonSprite() {
    const btn = document.getElementById('btnPlantAbovePanel');
    if (!btn) return;
    // Valor padr√£o: mudinha
    if (!escolhido) {
        btn.innerHTML = `<img draggable="false" class="emoji sprite" alt="üå±" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@17.0.2/assets/svg/1f331.svg" style="width:28px;height:28px;">`;
        btn.title = 'Plantar';
        return;
    }

    // Caminhos ‚Äî renderiza textura
    if (typeof ehCaminhoEmoji === 'function' && ehCaminhoEmoji(escolhido)) {
        const imgSrc = gerarTexturaCaminho({norte:false,sul:false,oeste:false,leste:false}, escolhido);
        btn.innerHTML = `<img draggable=\"false\" class=\"sprite\" src=\"${imgSrc}\" alt=\"${escolhido}\" style=\"width:28px;height:28px;\">`;
        btn.title = escolhido;
        return;
    }

    // √Årvores especiais
    const arvoresEspeciais = ['arvore-rosa','arvore-roxa','arvore-amarela','arvore-branca','arvore-colmeia','arvore-frutifera'];
    if (arvoresEspeciais.includes(escolhido) && typeof gerarSpriteArvore === 'function') {
        const svgThumb = gerarSpriteArvore(escolhido);
        btn.innerHTML = `<img draggable=\"false\" class=\"sprite\" src=\"${svgThumb}\" alt=\"${escolhido}\" style=\"width:28px;height:28px;\">`;
        btn.title = escolhido;
        return;
    }

    // Postes, bancos, piquenique, gazebo, lago etc
    if (escolhido === 'poste-luz' && typeof gerarSpritePosteLuz === 'function') {
        const svgThumb = gerarSpritePosteLuz(escolhido);
        btn.innerHTML = `<img draggable=\"false\" class=\"sprite\" src=\"${svgThumb}\" alt=\"${escolhido}\" style=\"width:28px;height:28px;\">`;
        btn.title = escolhido;
        return;
    }
    if (escolhido === 'banco-praca' && typeof gerarSpriteBancoPraca === 'function') {
        const svgThumb = gerarSpriteBancoPraca(escolhido);
        btn.innerHTML = `<img draggable=\"false\" class=\"sprite\" src=\"${svgThumb}\" alt=\"${escolhido}\" style=\"width:28px;height:28px;\">`;
        btn.title = escolhido;
        return;
    }
    if (escolhido === 'piquenique' && typeof gerarSpritePiquenique === 'function') {
        const svgThumb = gerarSpritePiquenique(escolhido);
        btn.innerHTML = `<img draggable=\"false\" class=\"sprite\" src=\"${svgThumb}\" alt=\"${escolhido}\" style=\"width:28px;height:28px;\">`;
        btn.title = escolhido;
        return;
    }
    if (escolhido === 'gazebo' && typeof gerarSpriteGazebo === 'function') {
        const svgThumb = gerarSpriteGazebo(escolhido);
        btn.innerHTML = `<img draggable=\"false\" class=\"sprite\" src=\"${svgThumb}\" alt=\"${escolhido}\" style=\"width:28px;height:28px;\">`;
        btn.title = escolhido;
        return;
    }
    if (escolhido === 'lago' && typeof gerarSpriteLago === 'function') {
        const svgThumb = gerarSpriteLago(escolhido);
        btn.innerHTML = `<img draggable=\"false\" class=\"sprite\" src=\"${svgThumb}\" alt=\"${escolhido}\" style=\"width:28px;height:28px;\">`;
        btn.title = escolhido;
        return;
    }
    if (escolhido === 'torre' && typeof gerarSpriteTorre === 'function') {
        const svgThumb = gerarSpriteTorre(escolhido);
        btn.innerHTML = `<img draggable=\"false\" class=\"sprite\" src=\"${svgThumb}\" alt=\"${escolhido}\" style=\"width:28px;height:28px;\">`;
        btn.title = escolhido;
        return;
    }
    if (escolhido === 'casa' && typeof gerarSpriteCasa === 'function') {
        const svgThumb = gerarSpriteCasa(escolhido);
        btn.innerHTML = `<img draggable=\"false\" class=\"sprite\" src=\"${svgThumb}\" alt=\"${escolhido}\" style=\"width:28px;height:28px;\">`;
        btn.title = escolhido;
        return;
    }

    // Caso padr√£o: emoji/texto
    btn.innerHTML = `<span style="font-size:22px; line-height:1;">${escolhido}</span>`;
    btn.title = (typeof escolhido === 'string') ? escolhido : 'Plantar';
    // Atualizar preview do alvo (para refletir planta selecionada)
    try { atualizarPreviewDoAlvo(); } catch(e) { console.warn('Erro ao atualizar preview do alvo', e); }
}

function aplicarAlinhamentoSprite(element, options = {}) {
    element.classList.add('sprite-alinhado');
    const escala = options.scale || 1;
    const translateY = options.translateY || '-60%';
    const offsetX = options.offsetX || '15%';
    element.style.setProperty('--sprite-scale', escala);
    element.style.setProperty('--sprite-translate-y', translateY);
    element.style.setProperty('--sprite-offset-x', offsetX);
}

// Retorna um objeto descrevendo como renderizar o preview para um √≠cone selecionado
function getPreviewSpriteForIcon(icon) {
    if (!icon) return null;

    // Caminho/textura (auto-tile) ‚Äî renderizado como camada plana
    if (typeof ehCaminhoEmoji === 'function' && ehCaminhoEmoji(icon)) {
        const svg = gerarTexturaCaminho({norte:false,sul:false,oeste:false,leste:false}, icon);
        return { type: 'img', src: svg, scale: 0.95, translateY: '-30%' };
    }

    const arvoresEspeciais = ['arvore-rosa','arvore-roxa','arvore-amarela','arvore-branca','arvore-colmeia','arvore-frutifera'];
    if (arvoresEspeciais.includes(icon) && typeof gerarSpriteArvore === 'function') {
        return { type: 'img', src: gerarSpriteArvore(icon), scale: 0.9, translateY: '-60%' };
    }

    if (icon === 'poste-luz' && typeof gerarSpritePosteLuz === 'function') {
        return { type: 'img', src: gerarSpritePosteLuz(icon), scale: 0.9, translateY: '-60%' };
    }
    if (icon === 'banco-praca' && typeof gerarSpriteBancoPraca === 'function') {
        return { type: 'img', src: gerarSpriteBancoPraca(icon), scale: 0.9, translateY: '-60%' };
    }
    if (icon === 'piquenique' && typeof gerarSpritePiquenique === 'function') {
        return { type: 'img', src: gerarSpritePiquenique(icon), scale: 1.2, translateY: '-60%' };
    }
    if (icon === 'gazebo' && typeof gerarSpriteGazebo === 'function') {
        return { type: 'img', src: gerarSpriteGazebo(icon), scale: 0.7, translateY: '-60%' };
    }
    if (icon === 'torre' && typeof gerarSpriteTorre === 'function') {
        return { type: 'img', src: gerarSpriteTorre(icon), scale: 0.8, translateY: '-70%' };
    }
    if (icon === 'casa' && typeof gerarSpriteCasa === 'function') {
        return { type: 'img', src: gerarSpriteCasa(icon), scale: 0.8, translateY: '-70%' };
    }
    if (icon === 'lago' && typeof gerarSpriteLago === 'function') {
        return { type: 'img', src: gerarSpriteLago(icon), scale: 0.7, translateY: '-60%' };
    }

    // Flores espec√≠ficas
    const floresEspeciais = ['üåª', 'üåπ', 'üå∑'];
    if (floresEspeciais.includes(icon) && typeof gerarSpriteFlor === 'function') {
        return { type: 'img', src: gerarSpriteFlor(icon), scale: 0.85, translateY: '-60%' };
    }

    // Padr√£o: emoji
    const code = twemoji.convert.toCodePoint(icon);
    return { type: 'img', src: twemoji.base + 'svg/' + code + '.svg', scale: 1, translateY: '-60%' };
}

function showPreviewAtElement(previewEl, icon, index, cell) {
    // Verificar se o grid que cont√©m essa c√©lula permite preview
    const grid = cell ? cell.closest('#grid3D, .spec-grid, .some-other-grid') : null;
    if (!grid || grid.dataset.previewEnabled !== 'true') {
        // N√£o mostrar preview se o grid n√£o estiver marcado como o selecionado
        return;
    }

    // Mostrar preview somente se esta c√©lula for o alvo atualmente selecionado
    if (typeof alvo === 'undefined' || index !== alvo) {
        return;
    }

    if (!icon) return;

    // N√£o mostrar preview em c√©lulas j√° plantadas
    if (jardimData[index]) return;

    console.log('Showing preview for', icon, 'at index', index);

    // Preview como elemento absoluto na c√©lula, com sprite correto
    const sprite = getPreviewSpriteForIcon(icon);
    if (!sprite) return;

    // Se for caminho/√°gua (ex.: AGUA_RIO, 'üåä', etc), renderizar exatamente como nos plantados (path-layer)
    if (typeof ehCaminhoEmoji === 'function' && ehCaminhoEmoji(icon)) {
        // Remover outros previews tempor√°rios
        document.querySelectorAll('.preview-temp').forEach(el => el.remove());
        const div = document.createElement('div');
        div.className = 'path-layer preview-temp';
        // Match planted path layering (z-index: 1) but keep preview opacity lower
        div.style.zIndex = '1';
        div.style.opacity = '0.5';
        div.style.width = '100%';
        div.style.height = '100%';
        div.style.backgroundImage = `url('${sprite.src}')`;
        div.style.backgroundSize = 'contain';
        div.style.backgroundRepeat = 'no-repeat';
        div.style.backgroundPosition = 'center';
        cell.appendChild(div);
        return; // Pronto
    }

    // Usar o elemento preview existente se fornecido, sen√£o criar novo
    let element = previewEl;
    if (!element) {
        const isSprite = !sprite.src.includes('twemoji');
        if (isSprite) {
            // Sprites usam <div> com background-image
            element = document.createElement('div');
            element.className = 'emoji-3d preview-temp';
            element.style.width = '100%';
            element.style.height = '100%';
            element.style.backgroundImage = `url('${sprite.src}')`;
            element.style.backgroundSize = 'contain';
            element.style.backgroundRepeat = 'no-repeat';
            element.style.backgroundPosition = 'center bottom';
        } else {
            // Emojis usam <span> com textContent
            element = document.createElement('span');
            element.className = 'emoji-3d preview-temp';
            element.textContent = icon;
        }
    } else {
        // Configurar elemento existente
        element.classList.add('preview-temp');
        if (!sprite.src.includes('twemoji')) {
            element.style.backgroundImage = `url('${sprite.src}')`;
            element.style.backgroundSize = 'contain';
            element.style.backgroundRepeat = 'no-repeat';
            element.style.backgroundPosition = 'center bottom';
            element.textContent = '';
        } else {
            element.textContent = icon;
            element.style.backgroundImage = '';
        }
    }

    // Aplicar o mesmo alinhamento que os plantados
    aplicarAlinhamentoSprite(element, sprite);

    // Efeito fantasma
    element.style.opacity = '0.5';
    element.style.zIndex = '200';

    // Remover outros previews tempor√°rios
    document.querySelectorAll('.preview-temp').forEach(el => { if (el !== element) el.remove(); });

    // Anexar √† c√©lula se n√£o estiver j√° anexado
    if (!cell.contains(element)) {
        cell.appendChild(element);
    }

    // Adicionar barra de progresso se timer estiver ativo
    if (intervalo) {
        // Remover barra existente se houver
        element.querySelector('.progress-bar')?.remove();
        const progressDiv = document.createElement('div');
        progressDiv.className = 'progress-bar';
        progressDiv.style.cssText = 'position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 70%; height: 3px; background: rgba(0,0,0,0.7); border-radius: 2px;';
        const fill = document.createElement('div');
        fill.className = 'progress-fill';
        fill.style.cssText = 'height: 100%; background: green; width: 0%; border-radius: 2px; transition: width 0.5s ease;';
        progressDiv.appendChild(fill);
        element.appendChild(progressDiv);
        
        // Calcular progresso atual da barra
        const timerEl = document.getElementById('timer');
        if (timerEl) {
            const timerText = timerEl.textContent;
            const [m, s] = timerText.split(':').map(Number);
            const remaining = m * 60 + s;
            const total = Number(document.getElementById('tempoEscolhido')?.value || 25) * 60;
            const progresso = Math.min(100, ((total - remaining) / total) * 100);
            fill.style.width = progresso + '%';
        }
    }
}

function hidePreviewAtElement(previewEl) {
    // Remover todos os previews tempor√°rios
    document.querySelectorAll('.preview-temp').forEach(el => el.remove());
}

function atualizarPreviewDoAlvo() {
    // Esconder todos os previews removendo os elementos tempor√°rios
    document.querySelectorAll('.preview-temp').forEach(el => el.remove());

    if (typeof alvo === 'undefined' || alvo === null) return;

    const container = document.getElementById('grid3D');
    if (!container || container.dataset.previewEnabled !== 'true') return;

    const cell = container.querySelector(`.cell-3d[data-index="${alvo}"]`);
    if (!cell) return;

    // Mostrar preview no alvo atual
    showPreviewAtElement(null, escolhido, Number(alvo), cell);
}

function renderJardim3D() {
    const container = document.getElementById('grid3D');
    if (!container) return; // Guard: evita erro se o elemento n√£o existir
    container.innerHTML = '';

    // Marcar este grid como o √∫nico que mostra previews
    container.dataset.previewEnabled = 'true';
    // Garantir que visualizadores e outros grids n√£o tenham preview ativo
    document.querySelectorAll('.spec-grid').forEach(g => { g.dataset.previewEnabled = 'false'; });

    const gridSize = getGridSize();
    ajustarTamanho3D();
    
    container.style.gridTemplateColumns = `repeat(${gridSize}, var(--cell-3d-size))`;
    container.style.gridTemplateRows = `repeat(${gridSize}, var(--cell-3d-size))`;

    jardimData.forEach((item, i) => {
        const cell = document.createElement('div');
        
        // Z-Index para profundidade correta
        cell.style.zIndex = 100 + i; 
        
        let petObj = petsEmCena.find(p => p.index === i);
        let petAqui = null;
        
        if (petObj && petDeveAparecer(petObj.icone)) {
            petAqui = petObj;
        }

        const isTesouro = (i === tesouroAtivoIndex);
        
        cell.className = 'cell-3d' + (i === alvo ? ' alvo' : '') + (petAqui ? ' has-pet' : '');
        // data-index para localizar facilmente durante eventos
        cell.dataset.index = i;

        // Camada de preview (inicialmente oculta)
        const previewLayer = document.createElement('div');
        previewLayer.className = 'preview-layer';
        const previewSprite = document.createElement('div');
        previewSprite.className = 'preview-sprite';
        previewLayer.appendChild(previewSprite);
        cell.appendChild(previewLayer);

        // Preview desabilitado no hover, sempre ativo no alvo selecionado

        // Preview desabilitado no toque, sempre ativo no alvo selecionado

        const caminhos = TIPOS_CAMINHO;
        const floresEspeciais = ['üåª', 'üåπ', 'üå∑'];
        const arvoresEspeciais = ['arvore-rosa','arvore-roxa','arvore-amarela','arvore-branca','arvore-colmeia','arvore-frutifera'];
        
        const isCaminho = item && caminhos.includes(item.icone);
        const isFlorSprite = item && floresEspeciais.includes(item.icone);
        const isArvoreEspecial = item && arvoresEspeciais.includes(iconKey(item.icone));

        // 1. RENDERIZAR CAMINHO
        if (isCaminho) {
            cell.classList.add('is-path');
            const conexoes = obterConexoesCaminho(i);
            // Detecta se est√° na borda do grid
            const x = i % gridSize;
            const y = Math.floor(i / gridSize);
            const isBorda = {
                norte: y === 0,
                sul: y === gridSize - 1,
                oeste: x === 0,
                leste: x === gridSize - 1
            };
            const svgBackground = gerarTexturaCaminho(conexoes, item.icone, isBorda);
            const layer = document.createElement('div');
            layer.className = 'path-layer';
            layer.style.backgroundImage = `url('${svgBackground}')`;
            cell.appendChild(layer);
        }

        // 2. RENDERIZAR FLOR SPRITE
        else if (isFlorSprite) {
            const svgSprite = gerarSpriteFlor(item.icone);
            
            const florElem = document.createElement('div');
            florElem.style.position = 'absolute';
            florElem.style.width = '100%';
            florElem.style.height = '100%';
            florElem.style.backgroundImage = `url('${svgSprite}')`;
            florElem.style.backgroundSize = 'contain';
            florElem.style.backgroundRepeat = 'no-repeat';
            florElem.style.backgroundPosition = 'center bottom';
            florElem.style.pointerEvents = 'none'; 
            
            aplicarAlinhamentoSprite(florElem, { scale: 0.85, translateY: '-60%' });

            cell.appendChild(florElem);
        }
        else if (isArvoreEspecial) {
            const svgSprite = gerarSpriteArvore(item.icone);
            const treeElem = document.createElement('div');
            treeElem.style.position = 'absolute';
            treeElem.style.width = '100%';
            treeElem.style.height = '100%';
            treeElem.style.backgroundImage = `url('${svgSprite}')`;
            treeElem.style.backgroundSize = 'contain';
            treeElem.style.backgroundRepeat = 'no-repeat';
            treeElem.style.backgroundPosition = 'center bottom';
            treeElem.style.pointerEvents = 'none';
            aplicarAlinhamentoSprite(treeElem, { scale: 0.82, translateY: '-65%' });

            cell.appendChild(treeElem);
        }

        // ------------------------------

        if (intervalo) {
            cell.style.pointerEvents = 'none';
            cell.style.opacity = '1';
        } else {
            cell.style.pointerEvents = 'auto';
            cell.style.opacity = '1';
        }

        // 3. Renderizar Planta Normal
        if (item && !isCaminho && !isFlorSprite && !isArvoreEspecial) {
            const itensMarinhos = [...ITENS_FUNDO_MAR_BASE, 'üßú‚Äç‚ôÄÔ∏è', 'üßú‚Äç‚ôÇÔ∏è', 'ü´ß', 'üêö', 'ü™∏', '‚öì', 'üõ•', 'üö¢'];
            const isItemMarinho = itensMarinhos.includes(item.icone) || (item.final && itensMarinhos.includes(item.final));
            const isAllowBoth = (typeof ITENS_ALLOW_AMBOS !== 'undefined') && (ITENS_ALLOW_AMBOS.includes(item.icone) || (item.final && ITENS_ALLOW_AMBOS.includes(item.final)));
            
            let mostrarItem = true;
            if (modoFundoMar) {
                if (!isItemMarinho && !isAllowBoth) mostrarItem = false;
            } else {
                if (isItemMarinho && !isAllowBoth) mostrarItem = false;
            }

            if (mostrarItem) {
                // Se for uma √°rvore nomeada (texto), renderizar o sprite em vez do texto gigante
                const rawIcon = item.icone;
                const normIcon = iconKey(rawIcon);
                if (['arvore-rosa','arvore-roxa','arvore-amarela','arvore-branca','arvore-colmeia','arvore-frutifera'].includes(normIcon) && typeof gerarSpriteArvore === 'function') {
                    const treeImg = document.createElement('div');
                    treeImg.className = 'emoji-3d';
                    treeImg.style.width = '100%';
                    treeImg.style.height = '100%';
                    treeImg.style.backgroundImage = `url('${gerarSpriteArvore(rawIcon)}')`;
                    treeImg.style.backgroundSize = 'contain';
                    treeImg.style.backgroundRepeat = 'no-repeat';
                    treeImg.style.backgroundPosition = 'center bottom';
                    // Aplicar escala reduzida (metade da anterior)
                    aplicarAlinhamentoSprite(treeImg, { scale: 0.9 });
                    if (item.lucky) {
                        treeImg.classList.add('lucky-glow');
                    }
                    cell.appendChild(treeImg);
                } else if (normIcon === 'poste-luz' && typeof gerarSpritePosteLuz === 'function') {
                    const posteImg = document.createElement('div');
                    posteImg.className = 'emoji-3d';
                    posteImg.style.width = '100%';
                    posteImg.style.height = '100%';
                    posteImg.style.backgroundImage = `url('${gerarSpritePosteLuz(rawIcon)}')`;
                    posteImg.style.backgroundSize = 'contain';
                    posteImg.style.backgroundRepeat = 'no-repeat';
                    posteImg.style.backgroundPosition = 'center';
                    aplicarAlinhamentoSprite(posteImg, { scale: 0.9 });
                    cell.appendChild(posteImg);
                } else if (normIcon === 'banco-praca' && typeof gerarSpriteBancoPraca === 'function') {
                    const bancoImg = document.createElement('div');
                    bancoImg.className = 'emoji-3d';
                    bancoImg.style.width = '100%';
                    bancoImg.style.height = '100%';
                    bancoImg.style.backgroundImage = `url('${gerarSpriteBancoPraca(rawIcon)}')`;
                    bancoImg.style.backgroundSize = 'contain';
                    bancoImg.style.backgroundRepeat = 'no-repeat';
                    bancoImg.style.backgroundPosition = 'center bottom';
                    aplicarAlinhamentoSprite(bancoImg, { scale: 0.9 });
                    cell.appendChild(bancoImg);
                } else if (normIcon === 'gazebo' && typeof gerarSpriteGazebo === 'function') {
                    const gazeboImg = document.createElement('div');
                    gazeboImg.className = 'emoji-3d';
                    gazeboImg.style.width = '100%';
                    gazeboImg.style.height = '100%';
                    gazeboImg.style.backgroundImage = `url('${gerarSpriteGazebo(rawIcon)}')`;
                    gazeboImg.style.backgroundSize = 'contain';
                    gazeboImg.style.backgroundRepeat = 'no-repeat';
                    gazeboImg.style.backgroundPosition = 'center bottom';
                    aplicarAlinhamentoSprite(gazeboImg, { scale: 0.7 });
                    gazeboImg.style.position = 'absolute';
                    gazeboImg.style.overflow = 'visible';
                    cell.appendChild(gazeboImg);

                } else if (normIcon === 'torre' && typeof gerarSpriteTorre === 'function') {
                    const torreImg = document.createElement('div');
                    torreImg.className = 'emoji-3d';
                    torreImg.style.width = '100%';
                    torreImg.style.height = '100%';
                    torreImg.style.backgroundImage = `url('${gerarSpriteTorre(rawIcon)}')`;
                    torreImg.style.backgroundSize = 'contain';
                    torreImg.style.backgroundRepeat = 'no-repeat';
                    torreImg.style.backgroundPosition = 'center bottom';
                    aplicarAlinhamentoSprite(torreImg, { scale: 0.8 });
                    cell.appendChild(torreImg);
                } else if (normIcon === 'casa' && typeof gerarSpriteCasa === 'function') {
                    const casaImg = document.createElement('div');
                    casaImg.className = 'emoji-3d';
                    casaImg.style.width = '100%';
                    casaImg.style.height = '100%';
                    casaImg.style.backgroundImage = `url('${gerarSpriteCasa(rawIcon)}')`;
                    casaImg.style.backgroundSize = 'contain';
                    casaImg.style.backgroundRepeat = 'no-repeat';
                    casaImg.style.backgroundPosition = 'center bottom';
                    aplicarAlinhamentoSprite(casaImg, { scale: 0.8 });
                    cell.appendChild(casaImg);
                } else if (normIcon === 'piquenique' && typeof gerarSpritePiquenique === 'function') {
                    const piqueniqueImg = document.createElement('div');
                    piqueniqueImg.className = 'emoji-3d';
                    piqueniqueImg.style.width = '100%';
                    piqueniqueImg.style.height = '100%';
                    piqueniqueImg.style.backgroundImage = `url('${gerarSpritePiquenique(rawIcon)}')`;
                    piqueniqueImg.style.backgroundSize = 'contain';
                    piqueniqueImg.style.backgroundRepeat = 'no-repeat';
                    piqueniqueImg.style.backgroundPosition = 'center bottom';
                    aplicarAlinhamentoSprite(piqueniqueImg, { scale: 1.2 });
                    cell.appendChild(piqueniqueImg);
                } else {
                    const emoji = document.createElement('span');
                    emoji.className = 'emoji-3d';
                    // Se for texto longo, trocar por um emoji gen√©rico para n√£o ficar gigante
                    if (rawIcon && rawIcon.length > 2 && /[a-zA-Z]/.test(rawIcon)) {
                        emoji.textContent = 'üå≥';
                    } else {
                        emoji.textContent = rawIcon;
                    }
                    if (item.lucky) {
                        emoji.classList.add('lucky-glow');
                    }
                    aplicarAlinhamentoSprite(emoji);
                    cell.appendChild(emoji);
                }
            }
        }
        
        // 4. Renderizar Pet (Mantido igual)
        else if (petAqui) {
            if (RomanceManager.shouldShowPartnerOnLand(petAqui.icone) && !modoFundoMar) {
                const bubble = document.createElement('div');
                bubble.className = 'bolha-magica';
                cell.appendChild(bubble);
            }

            const petElem = document.createElement('span');
            petElem.className = 'pet-3d sprite-alinhado' + (petAqui.pausado ? ' pausado' : '');
            // Conte√∫do: exibir o emoji ou √≠cone do pet
            petElem.textContent = petAqui.icone || '';
            petElem.setAttribute('role', 'img');
            if (petAqui.nome) petElem.setAttribute('title', petAqui.nome);
            petElem.setAttribute('data-pet-icone', petAqui.icone || '');
            // Aplicar alinhamento centralizado com tamanho reduzido
            aplicarAlinhamentoSprite(petElem, { scale: 0.7, translateY: '-60%', offsetX: '0%' });
            cell.appendChild(petElem);
            if (petAqui.pausado) {
                setTimeout(() => {
                    const rect = cell.getBoundingClientRect();
                    const agora = Date.now();
                    const dezMinutos = 10 * 60 * 1000;
                    
                    const petOriginal = petsComprados.find(p => p.icone === petAqui.icone && p.nome === petAqui.nome);
                    const ultimoCarinho = petOriginal ? (petOriginal.ultimoCarinho || 0) : 0;

                    const antigo = document.querySelector('.btn-carinho-flutuante');
                    if (antigo) antigo.remove();

                    const btnCarinho = document.createElement('button');
                    btnCarinho.className = 'btn-carinho-flutuante';
                    
                    const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
                    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                    
                    btnCarinho.style.left = `${rect.left + scrollLeft + rect.width / 2}px`;
                    btnCarinho.style.top = `${rect.top + scrollTop - 10}px`;

                    if (agora - ultimoCarinho < dezMinutos) {
                        const minutosRestantes = Math.ceil((dezMinutos - (agora - ultimoCarinho)) / 60000);
                        btnCarinho.textContent = `üò¥ ${minutosRestantes}m`;
                    } else {
                        btnCarinho.textContent = "Acariciar ‚ù§Ô∏è";
                        btnCarinho.onclick = (e) => {
                            e.stopPropagation();
                            darCarinho(petAqui, i);
                            petAqui.pausado = false;
                            btnCarinho.remove();
                            renderJardim3D();
                        };
                    }
                    
                    document.body.appendChild(btnCarinho);

                    const fecharAoClicarFora = (e) => {
                        if (!btnCarinho.contains(e.target) && !cell.contains(e.target)) {
                            btnCarinho.classList.add('fade-out');
                            setTimeout(() => {
                                if (btnCarinho.parentNode) btnCarinho.remove();
                                petAqui.pausado = false;
                                renderJardim3D();
                            }, 300);
                            document.removeEventListener('click', fecharAoClicarFora);
                        }
                    };
                    setTimeout(() => {
                        document.addEventListener('click', fecharAoClicarFora);
                    }, 10);
                }, 0);
            }
        }
        
        // 5. Renderizar Tesouro
        else if (isTesouro) {
            const tesouroElem = document.createElement('span');
            tesouroElem.className = 'emoji-3d';
            tesouroElem.textContent = 'ü™é';
            aplicarAlinhamentoSprite(tesouroElem, { scale: 0.7, translateY: '-60%', offsetX: '0%' });
            tesouroElem.style.filter = 'drop-shadow(0 0 8px gold)';
            cell.appendChild(tesouroElem);
        }

        // --- HANDLER DE CLIQUE (L√ìGICA CORRIGIDA) ---
        cell.onclick = () => {
            
            if (RomanceManager.handleTelepatiaClick(i)) return;
            if (intervalo) return;
            
            if (isTesouro) {
                coletarTesouro(i);
                return;
            }
            
            // SE EXISTIR ITEM (PLANTA, CAMINHO OU FLOR)
            if (item) {
                // Exibe um toast com o motivo e minutos do foco ao clicar em uma planta
                const textoExibido = isCaminho ? "Decora√ß√£o" : `${item.motivo || ''} ${item.minutos ? '(' + item.minutos + ' min)' : ''}`.trim();
                showToast('üå±', 'Foco', textoExibido);
                if (isCaminho) return; // N√£o permite plantar em cima de caminhos, mas permite preview em plantas
            }
            
            if (petAqui) {
                if (RomanceManager.handlePetClick(petAqui)) return;
                if (petAqui.pausado) {
                    const btn = document.querySelector('.btn-carinho-flutuante');
                    if (btn) btn.remove();
                }
                petAqui.pausado = !petAqui.pausado;
                renderJardim3D();
                return;
            }

            // Se estiver vazio: apenas seleciona a c√©lula como alvo no grid 3D (n√£o abre modal)
            setAlvo(i);
            // Removido: aviso toast 'Local selecionado' ‚Äî sele√ß√£o agora √© silenciosa
        };

        container.appendChild(cell);
    });

    try { atualizarPreviewDoAlvo(); } catch(e) { console.warn('Erro ao atualizar preview do alvo ap√≥s render', e); }
}



// Fun√ß√£o auxiliar para controlar visibilidade dos pets
function petDeveAparecer(petIcone) {
    // 1. O C√¥njuge (Guia Escolhido) aparece SEMPRE, independente do modo
    if (RomanceManager && RomanceManager.data && RomanceManager.data.parceiroIcone === petIcone) {
        return true;
    }

    const animaisMarinhos = ['üêã', 'üê†', 'üêü', 'üê°', 'üêô', 'ü¶≠', 'üê¢', 'ü¶¶', 'üßú‚Äç‚ôÇÔ∏è', 'üßú‚Äç‚ôÄÔ∏è'];
    const isMarinho = animaisMarinhos.includes(petIcone);

    // 2. Se estiver no Fundo do Mar:
    if (modoFundoMar) {
        return isMarinho; // Mostra apenas marinhos (e o c√¥njuge j√° passou no check 1)
    } 
    // 3. Se estiver na Terra (Normal, Natal, Medieval, etc):
    else {
        return !isMarinho; // Mostra apenas terrestres
    }
}

function adicionarPlantaAoJardim(novaPlanta) {
    // Tenta inserir na primeira c√©lula vazia do grid atual
    const total = getTotalCells();
    const idx = jardimData.findIndex(v => v === null);
    if (idx === -1) {
        showToast('üå±','Jardim cheio','N√£o h√° espa√ßo vazio no jardim para adicionar esta planta.');
        return false;
    }

    jardimData[idx] = novaPlanta;

    if (modoFundoMar) {
        jardimDataAquatico = jardimData;
        StorageSeguro.set('jardimAquatico', jardimDataAquatico);
    } else {
        jardimDataNormal = jardimData;
        StorageSeguro.set('jardim', jardimDataNormal);
    }

    renderJardim(); // Atualiza o visual
    return true;
}
function darCarinho(pet, index) {
    // 1. Recompensa Base
    let valorCarinho = 2;
    
    // Habilidade Pato: +2 moedas por carinho
    if (petsComprados.some(p => p.icone === 'ü¶Ü')) valorCarinho += 2;
    // Habilidade Lhama: +5 moedas por carinho
    if (petsComprados.some(p => p.icone === 'ü¶ô')) valorCarinho += 5;

    updateMoedas(valorCarinho);

    // 2. Salva o tempo no pet original
    const petOriginal = petsComprados.find(p => p.icone === pet.icone && p.nome === pet.nome);
    if (petOriginal) {
        petOriginal.ultimoCarinho = Date.now();
        StorageSeguro.set('petsComprados', petsComprados);
    }

   // 3. Efeito visual simples de m√∫ltiplos cora√ß√µes
const cells = document.querySelectorAll('.cell-3d');
const cellElement = cells[index];

if (cellElement) {
    for (let i = 0; i < 6; i++) {
        setTimeout(() => {
            const heart = document.createElement('div');
            heart.className = 'heart-simple';
            heart.innerHTML = '‚ù§Ô∏è';
            
            // Posi√ß√£o simples: espalha um pouco do centro
            const positions = ['20%', '50%', '80%', '40%', '60%', '30%'];
            heart.style.left = positions[i];
            heart.style.top = '20%';
            
            cellElement.appendChild(heart);
            
            // Remove ap√≥s a anima√ß√£o de 4s
            setTimeout(() => heart.remove(), 4000);
        }, i * 200);
    }
}


    // 4. Feedback r√°pido no topo da tela (Toast Adaptativo)
const aviso = document.createElement('div');

// Adicionamos uma classe base e o HTML interno
aviso.className = 'pet-toast-moderno';
	aviso.innerHTML = `
	    <div class="toast-content">
	        <span class="toast-icon">‚ù§Ô∏è</span>
	        <div class="toast-text">
	            <strong>${pet.nome} adorou o carinho!</strong>
	            <span>Voc√™ ganhou +${valorCarinho} moedas! üí∞</span>
	        </div>
	    </div>

	`;

document.body.appendChild(aviso);

// Remove o toast ap√≥s 6 segundos (conforme pedido anteriormente)
setTimeout(() => {
    aviso.classList.add('saindo');
    setTimeout(() => aviso.remove(), 500);
}, 6000);
}



function getFailureEmoji(emoji) {
    // --- L√≥gica Espec√≠fica para Modo Fundo do Mar ---
    if (modoFundoMar) {
        // Retorna aleatoriamente a Bota ou a Caixa de Suco (lixo marinho)
        return Math.random() < 0.5 ? 'ü•æ' : 'üßÉ';
    }

    // --- L√≥gica Padr√£o (Existente) ---
    const plantas = ['üå≤','üå≥','üå¥','üåµ','üåæ','üåø','‚òòÔ∏è','üåª','üåπ','üå∑','üçÑ','üçÑ‚Äçüü´','ü™¥'];
    const construcoes = ['üè†','üèØ','üè∞','‚õ™Ô∏è','‚õ©Ô∏è','üõñ','üïå','üõï','üóº'];
    
    if (emoji === 'üåπ') return 'ü•Ä';
    if (emoji === 'üéÅ') return 'ü™§';
    if (construcoes.includes(emoji)) return 'üèö';
    if (plantas.includes(emoji)) return 'ü™æ';
    
    return 'ü™æ';
}

// Verifica se um emoji representa um caminho (impede plantar sobre ele)
function ehCaminhoEmoji(emoji) {
    return TIPOS_CAMINHO.includes(emoji);
}

/**
 * Retorna o HTML (emoji ou <img>) do √≠cone, priorizando sprites SVG se existirem
 */
function getIconDisplayHTML(icone, size = '36px') {
    if (!icone) return '‚ùì';
    
    // 1. Caminhos (Auto-tile)
    if (ehCaminhoEmoji(icone)) {
        const imgSrc = gerarTexturaCaminho({norte:false,sul:false,oeste:false,leste:false}, icone);
        return `<img src="${imgSrc}" alt="${icone}" style="width:${size};height:${size};display:block;margin:0 auto;object-fit:contain;">`;
    }
    
    // 2. √Årvores Especiais
    const arvoresEspeciais = ['arvore-rosa','arvore-roxa','arvore-amarela','arvore-branca','arvore-colmeia','arvore-frutifera'];
    if (arvoresEspeciais.includes(icone)) {
        const svgThumb = gerarSpriteArvore(icone);
        return `<img src="${svgThumb}" alt="${icone}" style="width:${size};height:${size};display:block;margin:0 auto;object-fit:contain;">`;
    }
    
    // 3. Flores Especiais
    const floresEspeciais = ['üåª', 'üåπ', 'üå∑'];
    if (floresEspeciais.includes(icone) && typeof gerarSpriteFlor === 'function') {
        const svgThumb = gerarSpriteFlor(icone);
        return `<img src="${svgThumb}" alt="${icone}" style="width:${size};height:${size};display:block;margin:0 auto;object-fit:contain;">`;
    }
    
    // 4. Objetos Decorativos
    if (icone === 'poste-luz' && typeof gerarSpritePosteLuz === 'function') {
        const svgThumb = gerarSpritePosteLuz(icone);
        return `<img src="${svgThumb}" alt="${icone}" style="width:${size};height:${size};display:block;margin:0 auto;object-fit:contain;">`;
    }
    if (icone === 'banco-praca' && typeof gerarSpriteBancoPraca === 'function') {
        const svgThumb = gerarSpriteBancoPraca(icone);
        return `<img src="${svgThumb}" alt="${icone}" style="width:${size};height:${size};display:block;margin:0 auto;object-fit:contain;">`;
    }
    if (icone === 'piquenique' && typeof gerarSpritePiquenique === 'function') {
        const svgThumb = gerarSpritePiquenique(icone);
        return `<img src="${svgThumb}" alt="${icone}" style="width:${size};height:${size};display:block;margin:0 auto;object-fit:contain;">`;
    }
    if (icone === 'gazebo' && typeof gerarSpriteGazebo === 'function') {
        const svgThumb = gerarSpriteGazebo(icone);
        return `<img src="${svgThumb}" alt="${icone}" style="width:${size};height:${size};display:block;margin:0 auto;object-fit:contain;">`;
    }
    if (icone === 'lago' && typeof gerarSpriteLago === 'function') {
        const svgThumb = gerarSpriteLago(icone);
        return `<img src="${svgThumb}" alt="${icone}" style="width:${size};height:${size};display:block;margin:0 auto;object-fit:contain;">`;
    }
    
    // Fallback: Emoji comum
    return icone;
}


function calcularStreakDiasAtivos() {
    if (historico.length === 0) {
        streakDiasAtivos = 0;
        StorageSeguro.set('streakDiasAtivos', streakDiasAtivos);
        return;
    }
    
    const historicoOrdenado = [...historico].sort((a, b) => new Date(b.data) - new Date(a.data));
    const sucessos = historicoOrdenado.filter(s => s.status === 'sucesso');
    
    if (sucessos.length === 0) {
        streakDiasAtivos = 0;
        StorageSeguro.set('streakDiasAtivos', streakDiasAtivos);
        return;
    }
    
    const hoje = new Date();
    hoje.setHours(0, 0, 0, 0);
    
    const ontem = new Date(hoje);
    ontem.setDate(hoje.getDate() - 1);
    
    let streak = 0;
    let dataAtual = new Date(hoje);
    
    const temSessaoHoje = sucessos.some(s => {
        const dataSessao = new Date(s.data);
        dataSessao.setHours(0, 0, 0, 0);
        return dataSessao.getTime() === hoje.getTime();
    });
    
    if (!temSessaoHoje) {
        const temSessaoOntem = sucessos.some(s => {
            const dataSessao = new Date(s.data);
            dataSessao.setHours(0, 0, 0, 0);
            return dataSessao.getTime() === ontem.getTime();
        });
        
        if (temSessaoOntem) {
            streakDiasAtivos = StorageSeguro.get('streakDiasAtivos', 0);
            return;
        } else {
            streakDiasAtivos = 0;
            StorageSeguro.set('streakDiasAtivos', streakDiasAtivos);
            return;
        }
    }
    
    let diaContador = 0;
    let encontrouFalha = false;
    
    while (!encontrouFalha && diaContador < 365) {
        const dataVerificar = new Date(hoje);
        dataVerificar.setDate(hoje.getDate() - diaContador);
        dataVerificar.setHours(0, 0, 0, 0);
        
        const temSessaoNesseDia = sucessos.some(s => {
            const dataSessao = new Date(s.data);
            dataSessao.setHours(0, 0, 0, 0);
            return dataSessao.getTime() === dataVerificar.getTime();
        });
        
        if (temSessaoNesseDia) {
            streak++;
            diaContador++;
        } else {
            encontrouFalha = true;
        }
    }
    
    streakDiasAtivos = streak;
    StorageSeguro.set('streakDiasAtivos', streakDiasAtivos);
}

function atualizarStreak() {
    calcularStreakDiasAtivos();
    document.getElementById('streakBadgeValue').textContent = streakDiasAtivos;
    if(document.getElementById('streakBadgeValueSide')) {
        document.getElementById('streakBadgeValueSide').textContent = streakDiasAtivos;
    }
}

function criarParticulas() {
    particulasManager.atualizarTema();
}

function toggleAnimacaoFundo() {
    animacaoFundoAtiva = !animacaoFundoAtiva;
    StorageSeguro.set('animacaoFundoAtiva', animacaoFundoAtiva);
    
    const btn = document.getElementById('btnAnimFundo');
    if (btn) btn.classList.toggle('on', animacaoFundoAtiva);
    
    if (animacaoFundoAtiva) {
        particulasManager.iniciar();
    } else {
        particulasManager.parar();
    }
}

function chuvaDeEfeitos() {
    efeitosManager.chuvaDeEfeitos();
}

function proximoSom() {
    audioManager.proximoSom();
}

function tocarSino() {
    audioManager.tocarSino();
}

function abrirModal(id) {
    const el = document.getElementById(id);
    const content = el.querySelector('#' + id.replace('Overlay', 'Content')) || el.querySelector('div');
    el.style.display = 'flex';
    content.classList.remove('modal-anim-out');
    content.classList.add('modal-anim-in');

    if (id === 'configOverlay') {
        const inputNome = document.getElementById('configNomeUsuario');
        if (inputNome) {
            inputNome.value = StorageSeguro.get('jogadorNome', '');
        }
        
        // Inicializa o slider do grid
        const sliderGrid = document.getElementById('configGridSize');
        if (sliderGrid) {
            sliderGrid.value = gridSize;
            atualizarPreviewGrid(gridSize);
        }
    }
}

function fecharModal(id) {
    const el = document.getElementById(id);
    const content = el.querySelector('#' + id.replace('Overlay', 'Content')) || el.querySelector('div');
    content.classList.remove('modal-anim-in');
    content.classList.add('modal-anim-out');
    setTimeout(() => {
        el.style.display = 'none';
        content.classList.remove('modal-anim-out');
    }, 200);
    
    // Se fechar o Plantar Juntos, limpar timers de reconex√£o e heartbeat
    if (id === 'plantarJuntosOverlay') {
        if (intervalReconexaoPJ) {
            clearInterval(intervalReconexaoPJ);
            intervalReconexaoPJ = null;
        }
        if (intervalHeartbeatPJ) {
            clearInterval(intervalHeartbeatPJ);
            intervalHeartbeatPJ = null;
        }
        
        // Previews desabilitados (original limpeza removida)
        
        // Esconder bot√£o flutuante e popup do timer
        const btnFlutuante = document.getElementById('btnTimerFlutuantePJ');
        const popup = document.getElementById('popupTimerPJ');
        if (btnFlutuante) btnFlutuante.style.display = 'none';
        if (popup) popup.style.display = 'none';
        
        // Fechar PIP ao sair do Plantar Juntos
        if (typeof fecharPipPJ === 'function') {
            fecharPipPJ();
        }
        
        // Liberar Wake Lock ao sair do Plantar Juntos
        if (typeof gerenciarTelaAtiva === 'function') {
            gerenciarTelaAtiva(false);
        }
    }
}

function openStartFocusModal() {
    const overlay = document.getElementById("startFocusModalOverlay");
    const content = document.getElementById("startFocusModalContent");

    if (!overlay || !content) return;

    overlay.style.display = "flex";
    content.classList.add("modal-anim-in");
}

function closeStartFocusModal(startFocus) {
    const overlay = document.getElementById("startFocusModalOverlay");
    const content = document.getElementById("startFocusModalContent");

    if (overlay) overlay.style.display = "none";
    if (content) content.classList.remove("modal-anim-in");

    if (startFocus) {
        iniciarTimer(); // usa a sua fun√ß√£o real de iniciar foco
    }
}
function atualizarBotoes() {
    const btnStart = document.getElementById('btnStart');
    const btnAdicionarManual = document.getElementById('btnAdicionarManual');
    const btnBulldoze = document.getElementById('btnBulldoze');
    const btnParar = document.getElementById('btnParar');
    
    if (intervalo) {
        btnStart.style.display = 'none';
        btnAdicionarManual.style.display = 'none';
        btnBulldoze.style.display = 'none';
        btnParar.style.display = 'block';
        if (btnParar) btnParar.textContent = 'Cancelar'; // Mostrar 'Cancelar' enquanto o timer estiver ativo
    } else {
        if (btnParar) btnParar.textContent = 'Parar';
        if (alvo !== null) {
            btnStart.style.display = 'block';
            btnAdicionarManual.style.display = 'block';
            btnAdicionarManual.disabled = false;
            btnBulldoze.style.display = 'block';
            btnParar.style.display = 'none';
        } else {
            btnStart.style.display = 'block';
            btnAdicionarManual.style.display = 'block';
            btnAdicionarManual.disabled = false;
            btnBulldoze.style.display = 'block';
            btnParar.style.display = 'none';
        }
    }
    // Atualiza √≠cone do bot√£o de plantar (mant√©m sincronizado com a sele√ß√£o)
    try { if (typeof updatePlantButtonSprite === 'function') updatePlantButtonSprite(); } catch(e){ console.warn('updatePlantButtonSprite falhou', e); }
}
function adicionarFocoManual() {
    document.getElementById('manualMotivo').textContent = document.getElementById('motivoEscolhido')?.value || '';
    document.getElementById('manualTempo').textContent = document.getElementById('tempoEscolhido')?.value || '';
    abrirModal('manualFocusOverlay');
    salvarTudo();
}

function confirmarFocoManual() {
    const motivo = document.getElementById('motivoEscolhido')?.value || '';
    const tempo = parseInt(document.getElementById('tempoEscolhido')?.value) || 25;
    const agora = new Date();
    const isLucky = escolhido === luckyPlant;
    
    const emojiFinal = evoluirEmoji(escolhido);
    
    // Garantir que o alvo √© v√°lido
    if (alvo === null) {
        showModal({ text: "Selecione um espa√ßo no jardim primeiro!", onConfirm: () => {} });
        return;
    }

    // Bloqueio: n√£o permite confirmar plantio em cima de caminhos
    if (jardimData[alvo] && ehCaminhoEmoji(jardimData[alvo].icone)) {
        showToast('‚ö†Ô∏è', 'Imposs√≠vel plantar', 'Voc√™ n√£o pode plantar em cima de caminhos.');
        console.warn('confirmarFocoManual bloqueado: c√©lula com caminho no √≠ndice', alvo);
        return;
    }

    jardimData[alvo] = { 
        icone: emojiFinal, 
        motivo: motivo, 
        minutos: tempo,
        lucky: isLucky
    }; 
    
    sessoesTotais++; 
    historico.push({ 
        data: agora.toISOString(), 
        minutos: tempo, 
        motivo: motivo, 
        icone: emojiFinal, 
        mes: agora.getMonth(), 
        ano: agora.getFullYear(), 
        status: 'sucesso' 
    }); 
    
    // Sistema Eurosummer: Verificar ciclos (foco manual)
    if (modoEurosummer) {
        eurosummerSessoes++;
        StorageSeguro.set('eurosummerSessoes', eurosummerSessoes);
        
        if (eurosummerSessoes % 3 === 0) {
            const cicloAtual = Math.floor(eurosummerSessoes / 3);
            if (cicloAtual <= 13) {
                mostrarCartaEurosummer(cicloAtual);
            }
        }
    }
    
    // Sistema Fundo do Mar: Verificar metas (foco manual)
    if (modoFundoMar) {
        verificarMetasFundoMar(motivo, tempo);
    }
    
    // Economia: Ganho de moedas manual (reduzido em rela√ß√£o ao foco real)
    let moedasGanhas = isLucky ? 2 : 1;
    updateMoedas(moedasGanhas); 
    
    // Verificar metas do jogo
    verificarMetasConcluidas(motivo, tempo);
    
    // Atualizar visualmente o jardim
    renderJardim3D();
    
    setAlvo(null, { render: false });
    atualizarStreak();
    salvarTudo(); 
    renderSelects();
    atualizarBotoes();
    
    fecharModal('manualFocusOverlay');

    // Exibir toast com motivo e minutos ao adicionar foco manual
    showToast('üå±', 'Foco adicionado!', `${motivo} (${tempo} min)`);

    // Removido: triggerFinalSequence quando grid cheio
    atualizarVisibilidadeBtnExpand();
}

/* /* =========================================================================
   SISTEMA DE BACKUP PURO (SOMENTE INDEXED DB)
   Autor: Gemini
   Descri√ß√£o: Ignora localStorage. Foca apenas no banco de dados real.
   =========================================================================
*/

const BackupManager = {
    // Detecta o nome do banco
    getDbName: async function() {
        if (typeof DB_CONFIG !== 'undefined' && DB_CONFIG.dbName) return DB_CONFIG.dbName;
        if (window.indexedDB && window.indexedDB.databases) {
            const dbs = await window.indexedDB.databases();
            if (dbs.length > 0) return dbs[0].name;
        }
        return 'GardenFocusDB'; // Nome padr√£o
    },

    // 1. SINCRONIZAR MEM√ìRIA -> BANCO
    sincronizarEstado: function() {
        console.log("üîÑ Salvando RAM no Banco...");
        
        // Lista completa de vari√°veis globais
        const varsParaSalvar = {
            'moedasFoco': (typeof totalMoedas !== 'undefined' ? totalMoedas : null),
            'sessoesTotais': (typeof sessoesTotais !== 'undefined' ? sessoesTotais : null),
            'historico_foco': (typeof historico !== 'undefined' ? historico : null),
            'streakDiasAtivos': (typeof streakDiasAtivos !== 'undefined' ? streakDiasAtivos : null),
            'jardimDataNormal': (typeof jardimDataNormal !== 'undefined' ? jardimDataNormal : null),
            'jardimDataAquatico': (typeof jardimDataAquatico !== 'undefined' ? jardimDataAquatico : null),
            'grid10x10': (typeof grid10x10 !== 'undefined' ? grid10x10 : null),
            'recursos': (typeof recursos !== 'undefined' ? recursos : null),
            'petsComprados': (typeof petsComprados !== 'undefined' ? petsComprados : null),
            'estante_livros': (typeof estante_livros !== 'undefined' ? estante_livros : null),
            'tempos': (typeof tempos !== 'undefined' ? tempos : null),
            'motivos': (typeof motivos !== 'undefined' ? motivos : null),
            'metas': (typeof metas !== 'undefined' ? metas : null),
            'profilePhoto': (typeof profilePhoto !== 'undefined' ? profilePhoto : null),
            'modoEurosummer': (typeof modoEurosummer !== 'undefined' ? modoEurosummer : null),
            'eurosummerEmojisDesbloqueados': (typeof eurosummerEmojisDesbloqueados !== 'undefined' ? eurosummerEmojisDesbloqueados : null),
            'modoFundoMar': (typeof modoFundoMar !== 'undefined' ? modoFundoMar : null),
            'fundoMarComprado': (typeof fundoMarComprado !== 'undefined' ? fundoMarComprado : null),
            'fundoMarMetasConcluidas': (typeof fundoMarMetasConcluidas !== 'undefined' ? fundoMarMetasConcluidas : null)
        };

        // Salva apenas o que existe (n√£o √© null)
        for (const [key, val] of Object.entries(varsParaSalvar)) {
            if (val !== null) StorageSeguro.set(key, val);
        }

        // Managers
        if (typeof RomanceManager !== 'undefined' && RomanceManager.save) RomanceManager.save();
    },

    // 2. EXPORTAR (DB -> ARQUIVO)
    exportarTudo: async function() {
        try {
            this.sincronizarEstado();
            const dbName = await this.getDbName();
            
            console.log(`üì¶ Extraindo dados do banco: ${dbName}`);

            // Acessa o IndexedDB diretamente para pegar TUDO
            const dadosExportados = await new Promise((resolve, reject) => {
                const request = indexedDB.open(dbName);
                request.onerror = () => reject("Erro ao abrir DB");
                request.onsuccess = (e) => {
                    const db = e.target.result;
                    if (db.objectStoreNames.length === 0) return resolve([]);
                    
                    const storeName = db.objectStoreNames[0];
                    const tx = db.transaction(storeName, 'readonly');
                    const store = tx.objectStore(storeName);
                    
                    // Pega todas as chaves e valores
                    const getAll = store.getAllKeys();
                    getAll.onsuccess = () => {
                        const keys = getAll.result;
                        const items = {};
                        let count = 0;
                        
                        if(keys.length === 0) return resolve({});

                        keys.forEach(key => {
                            store.get(key).onsuccess = (ev) => {
                                items[key] = ev.target.result;
                                count++;
                                if(count === keys.length) resolve(items);
                            };
                        });
                    };
                };
            });

            // Estrutura Final do JSON
            const backupFinal = {
                _meta: {
                    versao: "4.0 Pure DB",
                    data: new Date().toISOString()
                },
                dados: dadosExportados
            };

            // Download
            const blob = new Blob([JSON.stringify(backupFinal, null, 2)], { type: "application/json" });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `GardenFocus_DB_${new Date().toLocaleDateString('pt-BR').replace(/\//g,'-')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            alert("‚úÖ Backup Puro (IndexedDB) gerado com sucesso!");

        } catch (erro) {
            console.error(erro);
            alert("Erro: " + erro.message);
        }
    },

    // 3. RESTAURAR (ARQUIVO -> DB)
    restaurarTudo: function(inputElement) {
        const file = inputElement.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = async function(e) {
            try {
                const json = JSON.parse(e.target.result);
                // Suporte para vers√µes antigas (que tinham localStorage separado) ou nova
                const dadosParaRestaurar = json.dados || json.indexedDB || json;

                if (!confirm("‚ö†Ô∏è Isso apagar√° todo o banco de dados atual e restaurar√° o arquivo. Continuar?")) return;

                const dbName = await BackupManager.getDbName();
                
                await new Promise((resolve, reject) => {
                    const request = indexedDB.open(dbName);
                    request.onsuccess = (ev) => {
                        const db = ev.target.result;
                        const storeName = db.objectStoreNames[0];
                        const tx = db.transaction(storeName, 'readwrite');
                        const store = tx.objectStore(storeName);

                        store.clear(); // Limpa tudo

                        // Se for array (vers√£o antiga) ou objeto (vers√£o nova)
                        if (Array.isArray(dadosParaRestaurar)) {
                            dadosParaRestaurar.forEach(item => store.put(item.value, item.key));
                        } else {
                            Object.entries(dadosParaRestaurar).forEach(([key, val]) => {
                                if(key !== '_meta') store.put(val, key);
                            });
                        }

                        tx.oncomplete = () => resolve();
                    };
                });

                alert("‚úÖ Restaurado! Recarregando...");
                window.location.reload();

            } catch (erro) {
                alert("Arquivo inv√°lido.");
                console.error(erro);
            }
        };
        reader.readAsText(file);
    }
};


function mostrarAjudaBackup() {
    const mensagem = `
        <strong>üíæ Como funciona o Backup?</strong><br><br>
        
        <strong>üì§ EXPORTAR:</strong><br>
        Cria um arquivo JSON com todos os seus dados para download.<br><br>
        
        <strong>üì• IMPORTAR:</strong><br>
        Restaura seus dados a partir de um arquivo de backup.<br><br>
        
        <strong>üìã Dados salvos no backup:</strong><br>
        ‚Ä¢ üå± Jardim (plantas e posi√ß√µes)<br>
        ‚Ä¢ üìä Hist√≥rico completo de foco<br>
        ‚Ä¢ ü™ô Moedas acumuladas<br>
        ‚Ä¢ üìö Estante de livros<br>
        ‚Ä¢ ‚òÄÔ∏è Streak (sequ√™ncia de dias)<br>
        ‚Ä¢ ‚è±Ô∏è Tempos e motivos personalizados<br>
        ‚Ä¢ ‚öôÔ∏è Todas as configura√ß√µes<br>
        ‚Ä¢ üì∑ Foto de perfil<br><br>
        
        <strong>üí° Dica:</strong><br>
        Use esta fun√ß√£o para transferir seus dados entre navegadores ou dispositivos diferentes!
    `;
    
    showModal({ 
        text: mensagem, 
        onConfirm: () => {} 
    });
}

// ==========================================
// FUN√á√ÉO DE RESET TOTAL (CORRIGIDA E ROBUSTA)
// ==========================================
// ==========================================
// 1. SISTEMA DE MODAIS DO JOGO (NOVO)
// ==========================================

// Injeta o HTML do modal na p√°gina se n√£o existir
if (!document.getElementById('custom-modal-overlay')) {
    const modalHTML = `
        <div id="custom-modal-overlay">
            <div class="custom-modal-box">
                <div id="custom-modal-icon" class="custom-modal-icon">‚ú®</div>
                <div id="custom-modal-title" class="custom-modal-title">T√≠tulo</div>
                <div id="custom-modal-msg" class="custom-modal-msg">Mensagem</div>
                <div id="custom-modal-actions" class="custom-modal-actions"></div>
            </div>
        </div>`;
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

// Fun√ß√£o Gen√©rica para chamar o Modal (Retorna uma Promise)
function exibirModal(titulo, mensagem, tipo = 'alert', icone = '') {
    return new Promise((resolve) => {
        const overlay = document.getElementById('custom-modal-overlay');
        const box = overlay.querySelector('.custom-modal-box');
        const titleEl = document.getElementById('custom-modal-title');
        const msgEl = document.getElementById('custom-modal-msg');
        const iconEl = document.getElementById('custom-modal-icon');
        const actionsEl = document.getElementById('custom-modal-actions');
        
        // Configura textos
        titleEl.innerText = titulo;
        msgEl.innerHTML = mensagem.replace(/\n/g, '<br>'); // Suporta quebra de linha
        iconEl.innerText = icone || (tipo === 'danger' ? 'üíÄ' : (tipo === 'confirm' ? 'ü§î' : '‚ú®'));
        iconEl.style.display = 'block';

        // Limpa bot√µes antigos
        actionsEl.innerHTML = ''; 

        // Cria bot√µes baseados no tipo
        if (tipo === 'confirm' || tipo === 'danger') {
            const btnCancel = document.createElement('button');
            btnCancel.className = 'custom-modal-btn btn-modal-cancel';
            btnCancel.innerText = 'Cancelar';
            btnCancel.onclick = () => fechar(false);
            
            const btnConfirm = document.createElement('button');
            btnConfirm.className = `custom-modal-btn ${tipo === 'danger' ? 'btn-modal-danger' : 'btn-modal-confirm'}`;
            btnConfirm.innerText = tipo === 'danger' ? 'SIM, APAGAR!' : 'Confirmar';
            btnConfirm.onclick = () => fechar(true);
            
            actionsEl.appendChild(btnCancel);
            actionsEl.appendChild(btnConfirm);
        } else {
            // Apenas Alerta
            const btnOk = document.createElement('button');
            btnOk.className = 'custom-modal-btn btn-modal-confirm';
            btnOk.innerText = 'Entendi';
            btnOk.onclick = () => fechar(true);
            actionsEl.appendChild(btnOk);
        }

        // Mostra o modal
        overlay.style.display = 'flex';
        // Pequeno delay para permitir a transi√ß√£o CSS
        setTimeout(() => {
            overlay.style.opacity = '1';
            box.style.transform = 'translateY(0) scale(1)';
        }, 10);

        function fechar(valor) {
            overlay.style.opacity = '0';
            box.style.transform = 'translateY(20px) scale(0.9)';
            setTimeout(() => {
                overlay.style.display = 'none';
                resolve(valor); // Retorna true ou false para quem chamou
            }, 300);
        }
    });
}

// ==========================================
// 2. FUN√á√ÉO RESET ABSOLUTO (INTEGRADA)
// ==========================================
async function resetAbsoluto() {
    // Passo 1: Aviso de Perigo (Estilo "Danger")
    const confirmacao1 = await exibirModal(
        "Zona de Perigo", 
        "Voc√™ est√° prestes a apagar <b>TODO</b> o seu progresso, moedas e di√°rio.<br><br>Isso n√£o pode ser desfeito.", 
        "danger",
        "‚ö†Ô∏è"
    );
    
    if (!confirmacao1) return; // Se cancelou, para tudo

    // Passo 2: Certeza Absoluta (Estilo "Confirm")
    const confirmacao2 = await exibirModal(
        "√öltima Chance",
        "Tem certeza absoluta? Seu jardim voltar√° a ser um terreno vazio.",
        "confirm",
        "üóëÔ∏è"
    );

    if (!confirmacao2) return;

    // Passo 3: Execu√ß√£o
    // Muda o texto do bot√£o visualmente se existir
    const btn = document.getElementById('btnReset'); 
    if(btn) btn.innerText = "Apagando...";
    
    // Mostra um modal de "Carregando" (sem bot√µes por enquanto)
    const overlay = document.getElementById('custom-modal-overlay');
    document.getElementById('custom-modal-title').innerText = "Reiniciando...";
    document.getElementById('custom-modal-msg').innerText = "Limpando mem√≥rias e banco de dados...";
    document.getElementById('custom-modal-actions').innerHTML = ''; // Sem bot√µes para n√£o clicar
    overlay.style.display = 'flex';
    overlay.style.opacity = '1';

    try {
        console.log("üî• Iniciando Protocolo de Reset...");

        localStorage.clear();
        sessionStorage.clear();
        
        // Deletar DB (Fun√ß√£o auxiliar necess√°ria)
        await deletarBancoDados('GardenFocusDB');
        
        console.log("‚úÖ Limpeza conclu√≠da.");
        
        // Redireciona para home limpa
        setTimeout(() => {
            window.location.href = window.location.href.split('?')[0];
            window.location.reload(true);
        }, 1500); // Um tempinho para o usu√°rio ler a mensagem

    } catch (erro) {
        console.error("‚ùå Erro:", erro);
        await exibirModal("Erro", "Falha ao limpar: " + erro.message, "alert");
        window.location.reload();
    }
}

// Fun√ß√£o Auxiliar de Banco de Dados (Mantida a mesma l√≥gica segura)
function deletarBancoDados(nomeBanco) {
    return new Promise((resolve, reject) => {
        if (window.db) { try { window.db.close(); } catch(e) {} }
        const req = indexedDB.deleteDatabase(nomeBanco);
        req.onsuccess = () => resolve();
        req.onerror = () => reject(new Error("Erro no IndexedDB"));
        req.onblocked = () => {
             // Se bloquear, for√ßamos o reload mesmo assim
             window.location.reload();
        };
    });
}

// Fun√ß√£o para verificar e pedir o nome ao iniciar
async function verificarInicioUsuario() {
    try {
        // Tenta buscar o nome salvo no banco
        let nome = await StorageSeguro.get('nome_usuario');

        // Se N√ÉO tiver nome (ou seja, √© um novo jogo ou acabou de resetar)
        if (!nome || nome.trim() === '') {
            
            // Loop para garantir que o usu√°rio digite algo v√°lido
            while (!nome || nome.trim() === '') {
                nome = prompt("üå± Bem-vindo(a) ao Garden Focus!\n\nComo voc√™ gostaria de ser chamado(a)?");
                
                // Se o usu√°rio cancelar, definimos um padr√£o para n√£o quebrar
                if (nome === null) {
                    nome = "Jardineiro(a)";
                    break;
                }
            }
            
            // Salva o novo nome
            await StorageSeguro.set('nome_usuario', nome);
            
            // (Opcional) D√° moedas iniciais de presente
            await StorageSeguro.set('moedas', 50);
            
            // Feedback simples
            // alert(`Prazer, ${nome}! Voc√™ come√ßou com 50 moedas.`);
        }

        // Atualiza a exibi√ß√£o na tela (se o elemento existir)
        const elementoSaudacao = document.getElementById('saudacaoUsuario');
        if (elementoSaudacao) {
            elementoSaudacao.innerHTML = `Ol√°, <strong>${nome}</strong>`;
        }

    } catch (erro) {
        console.error("Erro ao verificar usu√°rio:", erro);
    }
}


function atualizarTogglesTemasLoja() {
    const containerMed = document.getElementById('containerMedievalLoja');
    const containerCandy = document.getElementById('containerCandyforniaLoja');
    const containerEuro = document.getElementById('containerEurosummerLoja');
    const containerFundoMar = document.getElementById('containerFundoMarLoja');
    
    if (medievalComprado && containerMed) {
        containerMed.innerHTML = `
            <div class="ios-switch-container" style="margin-top: 5px;">
                <div id="btnMedievalLoja" class="ios-switch ${modoMedieval ? 'on' : ''}" onclick="toggleMedieval()">
                    <div class="ios-switch-thumb"></div>
                </div>
            </div>`;
    }
    
    if (candyforniaComprado && containerCandy) {
        containerCandy.innerHTML = `
            <div class="ios-switch-container" style="margin-top: 5px;">
                <div id="btnCandyforniaLoja" class="ios-switch ${modoCandyfornia ? 'on' : ''}" onclick="toggleCandyfornia()">
                    <div class="ios-switch-thumb"></div>
                </div>
            </div>`;
    }
    
     if (eurosummerComprado && containerEuro) {
        containerEuro.innerHTML = `
            <div class="ios-switch-container" style="margin-top: 5px; flex-direction: column; gap: 10px;">
                <div id="btnEurosummerLoja" class="ios-switch ${modoEurosummer ? 'on' : ''}" onclick="toggleEurosummer()">
                    <div class="ios-switch-thumb"></div>
                </div>
                <button onclick="reiniciarEurosummer()" title="Reiniciar Hist√≥ria" style="background: var(--plot-empty); color: var(--text-main); border: none; border-radius: 50px; padding: 3px 8px; cursor: pointer; font-size: 10px; margin-top: 5px; opacity: 0.7; ">üîÑ Reset Hist√≥ria</button>
            </div>
        `;
    }
    
    if (fundoMarComprado && containerFundoMar) {
        containerFundoMar.innerHTML = `
            <div class="ios-switch-container" style="margin-top: 5px; flex-direction: column; gap: 10px;">
                <div id="btnFundoMarLoja" class="ios-switch ${modoFundoMar ? 'on' : ''}" onclick="toggleFundoMar()">
                    <div class="ios-switch-thumb"></div>
                </div>
                <button onclick="reiniciarFundoMar()" title="Reiniciar Hist√≥ria" style="background: var(--plot-empty); color: var(--text-main); border: none; border-radius: 50px; padding: 3px 8px; cursor: pointer; font-size: 10px; margin-top: 5px; opacity: 0.7; ">üîÑ Reset Hist√≥ria</button>
            </div>
        `;
    }
    
    const btnNatal = document.getElementById('btnNatal');
    if (btnNatal) btnNatal.classList.toggle('on', modoNatal);
}
function calcularPrecoFinal(precoBase, idItem = null, iconePet = null) {
    let preco = precoBase;

    // Verificar se o pet √© uma recompensa de meta do Fundo do Mar
    const metaRelacionada = METAS_FUNDO_MAR.find(m => m.petGratis === iconePet);
    if (metaRelacionada && fundoMarMetasConcluidas.includes(metaRelacionada.id)) {
        return 0; // Gratuito se a meta foi conclu√≠da
    }

    // Caso especial: Sereia ou Trit√£o (Meta 7) - Apenas o escolhido √© gratuito
    if ((iconePet === 'üßú‚Äç‚ôÄÔ∏è' || iconePet === 'üßú‚Äç‚ôÇÔ∏è') && fundoMarMetasConcluidas.includes(7)) {
        return iconePet === guiaEscolhidoFundoMar ? 0 : precoBase;
    }

    // Habilidade Porquinho: 10% desconto em TUDO (exceto no pr√≥prio porquinho)
    if (petsComprados.some(p => p.icone === 'üêñ') && iconePet !== 'üêñ') {
        preco = Math.floor(preco * 0.9);
    }
    // Habilidade Castor: 20% desconto em constru√ß√µes (temas)
    if (idItem && (idItem === 'medieval' || idItem === 'candyfornia') && petsComprados.some(p => p.icone === 'ü¶´')) {
        preco = Math.floor(preco * 0.8);
    }
    return preco;
}


function comprarItemLoja(id, preco) {
    const precoFinal = calcularPrecoFinal(preco, id, null);

    // Verifica√ß√£o de seguran√ßa para evitar compras duplicadas ou saldo negativo
    if (totalMoedas >= precoFinal) {
        // Bloqueia o bot√£o temporariamente se existir para evitar cliques duplos
        const btnId = id === 'medieval' ? 'btnComprarMedieval' : (id === 'candyfornia' ? 'btnComprarCandyfornia' : (id === 'eurosummer' ? 'btnComprarEurosummer' : 'btnComprarFundoMar'));
        const btn = document.getElementById(btnId);
        if (btn) btn.disabled = true;

        updateMoedas(-precoFinal);
        if (id === 'medieval') {
            medievalComprado = true;
            StorageSeguro.set('medievalComprado', true);
            atualizarTogglesTemasLoja();
            showModal({ 
                text: "üè∞ Reino Medieval Desbloqueado!<br><br>O modo Medieval est√° agora dispon√≠vel para ativa√ß√£o aqui na loja.", 
                onConfirm: () => {} 
            });
        }
        
        if (id === 'candyfornia') {
            candyforniaComprado = true;
            StorageSeguro.set('candyforniaComprado', true);
            atualizarTogglesTemasLoja();
            showModal({ 
                text: "üç≠ Candyfornia Desbloqueado!<br><br>O modo Candyfornia est√° agora dispon√≠vel para ativa√ß√£o aqui na loja.", 
                onConfirm: () => {} 
            });
        }
        
        if (id === 'eurosummer') {
            eurosummerComprado = true;
            vistoIntroEurosummer = false;
            StorageSeguro.set('eurosummerComprado', true);
            StorageSeguro.set('vistoIntroEurosummer', false);
            atualizarTogglesTemasLoja();
            showModal({ 
                text: "üèõÔ∏è Eurosummer Desbloqueado!<br><br>Bem-vindo √† Riviera. Entre ru√≠nas e o perfume dos limoeiros, desbloqueia mem√≥rias de um ver√£o eterno a cada 3 sess√µes de foco.<br><br>O modo est√° agora dispon√≠vel para ativa√ß√£o aqui na loja.", 
                onConfirm: () => {} 
            });
        }
        
        if (id === 'fundomar') {
            fundoMarComprado = true;
            vistoIntroFundoMar = false;
            StorageSeguro.set('fundoMarComprado', true);
            StorageSeguro.set('vistoIntroFundoMar', false);
            atualizarTogglesTemasLoja();
            showModal({ 
                text: "üßú‚Äç‚ôÄÔ∏è Reino de Coral Desbloqueado!<br><br>Tudo escureceu depois da tempestade. Acordei longe da superf√≠cie, num jardim de corais, salvo por algu√©m que n√£o √© do meu mundo...<br><br>Desbloqueia mem√≥rias subaqu√°ticas a cada 3 sess√µes de foco. O modo est√° agora dispon√≠vel para ativa√ß√£o aqui na loja.", 
                onConfirm: () => {} 
            });
        }
        
        document.getElementById('saldoLojaMoedas').textContent = totalMoedas;
        
        // Atualizar saldo no menu tamb√©m
        document.getElementById('userMoedas').textContent = totalMoedas;
        
    } else {
        showModal({ text: "Moedas insuficientes! Foque mais para ganhar.", onConfirm: () => {} });
    }
}

// Fun√ß√£o auxiliar para encontrar cards pelo t√≠tulo
function encontrarCardPorTitulo(titulo) {
    const cards = document.querySelectorAll('.config-card');
    for (let card of cards) {
        const h4 = card.querySelector('h4');
        if (h4 && h4.textContent.includes(titulo)) {
            return card;
        }
    }
    return null;
}

function atualizarTimerDisplay() { const t = document.getElementById('tempoEscolhido')?.value || '25'; document.getElementById('timer').textContent = `${String(t).padStart(2,'0')}:00`; }

function acessarDebugViaTitulo() {
    const v = prompt("Digite a senha de acesso:");
    if (v === "Luiz") {
        abrirModal('debugOverlay');
    } else {
        showModal({ text: "Senha incorreta.", onConfirm: () => {} });
    }
}



// Removido: toggleDeepFocus function

function updateMoedas(amount) {
    const valorAdicionar = Number(amount) || 0;
    totalMoedas = (Number(totalMoedas) || 0) + valorAdicionar;
    if (totalMoedas < 0) totalMoedas = 0; // Evita saldo negativo tamb√©m
    StorageSeguro.set('moedasFoco', totalMoedas);
    
    // Atualizar saldo em todos os lugares da interface
    const elementosSaldo = ['userMoedas', 'saldoLojaMoedas', 'userMoedasConfig', 'saldoLojaMoedasTopo'];
    elementosSaldo.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.textContent = totalMoedas;
    });
}

function setLuckyPlant() {
    const today = new Date().toDateString();
    let seed = 0;
    for(let i=0; i<today.length; i++) seed += today.charCodeAt(i);
    const pool = modoFundoMar ? (fundoMarEmojisDesbloqueados.length > 0 ? fundoMarEmojisDesbloqueados : ITENS_PADRAO) : (modoEurosummer ? (eurosummerEmojisDesbloqueados.length > 0 ? eurosummerEmojisDesbloqueados : ITENS_PADRAO) : (modoCandyfornia ? ITENS_CANDYFORNIA : (modoNatal ? ITENS_NATAL : (modoMedieval ? ITENS_MEDIEVAL : ITENS_PADRAO))));
    luckyPlant = pool[seed % pool.length];
    // Habilidade Girafa: Revela a Planta da Sorte
    const tagSorte = document.getElementById('luckyPlantTag');
    if (petsComprados.some(p => p.icone === 'ü¶í')) {
        tagSorte.style.display = 'block';
        tagSorte.textContent = `Sorte do dia: ${luckyPlant} (Moedas 2x)`;
    } else {
        tagSorte.style.display = 'none';
    }
}

// Fun√ß√£o para obter o tamanho atual do grid
function getGridSize() {
    return gridSize;
}

function atualizarPreviewGrid(val) {
    const display = document.getElementById('gridSizeDisplay');
    if (display) display.textContent = `${val}x${val}`;
}

async function salvarNovoGrid(val) {
    const novaDimenso = parseInt(val);
    if (novaDimenso === gridSize) return;

    const confirmar = await exibirModal(
        'üìê Alterar Tamanho do Jardim',
        `Ao mudar para ${novaDimenso}x${novaDimenso}, suas plantas ser√£o reposicionadas para tentar manter o centro. Deseja continuar?`,
        'confirm',
        'ü§î'
    );

    if (!confirmar) {
        // Volta o slider para o valor anterior
        const slider = document.getElementById('configGridSize');
        if (slider) {
            slider.value = gridSize;
            atualizarPreviewGrid(gridSize);
        }
        return;
    }

    const antigaDimenso = gridSize;
    const antigoTotal = antigaDimenso * antigaDimenso;
    const novoTotal = novaDimenso * novaDimenso;

    // Reposicionamento inteligente: Mapeia do centro do antigo para o centro do novo
    const reposicionarData = (data, oldSize, newSize) => {
        if (!data) return Array(newSize * newSize).fill(null);
        const newData = Array(newSize * newSize).fill(null);
        const offset = Math.floor((newSize - oldSize) / 2);

        for (let y = 0; y < oldSize; y++) {
            for (let x = 0; x < oldSize; x++) {
                const oldIdx = y * oldSize + x;
                if (data[oldIdx]) {
                    const newX = x + offset;
                    const newY = y + offset;
                    if (newX >= 0 && newX < newSize && newY >= 0 && newY < newSize) {
                        const newIdx = newY * newSize + newX;
                        newData[newIdx] = data[oldIdx];
                    }
                }
            }
        }
        return newData;
    };

    // Atualiza estados globais
    gridSize = novaDimenso;
    grid10x10 = gridSize >= 8; // Ativa estilos de "grid denso" para tamanhos grandes
    StorageSeguro.set('gridSize', gridSize);
    StorageSeguro.set('grid10x10', grid10x10);

    // Ajusta os dados atuais
    jardimDataNormal = reposicionarData(StorageSeguro.get('jardim', null), antigaDimenso, novaDimenso);
    jardimDataAquatico = reposicionarData(StorageSeguro.get('jardimAquatico', null), antigaDimenso, novaDimenso);
    
    // Salva os novos dados
    StorageSeguro.set('jardim', jardimDataNormal);
    StorageSeguro.set('jardimAquatico', jardimDataAquatico);
    
    jardimData = modoFundoMar ? jardimDataAquatico : jardimDataNormal;

    // Aplica classes visuais
    if (grid10x10) {
        document.body.classList.add('grid-10x10');
    } else {
        document.body.classList.remove('grid-10x10');
    }

    // Reinicializa e renderiza
    renderJardim();
    atualizarBotoes();
    // Atualizar visibilidade do bot√£o expandir
    atualizarVisibilidadeBtnExpand();
    setTimeout(ajustarTamanho3D, 100);

    showToast('üìê', 'Grid Atualizado', `Jardim redimensionado para ${gridSize}x${gridSize}`);
}

// Fun√ß√£o para obter o n√∫mero total de c√©lulas
function getTotalCells() {
    const size = getGridSize();
    return size * size;
}


// Fun√ß√£o para inicializar o jardimData com o tamanho correto
function initJardimData() {
    const totalCells = getTotalCells();
    
    // CORRE√á√ÉO: Carrega explicitamente o grid correto baseado no modo atual
    if (modoFundoMar) {
        jardimData = StorageSeguro.get('jardimAquatico', Array(totalCells).fill(null));
        jardimDataAquatico = jardimData;
    } else {
        jardimData = StorageSeguro.get('jardim', Array(totalCells).fill(null));
        jardimDataNormal = jardimData;
    }
    
    // Normalizar entradas (compatibilidade com formatos antigos)
    if (Array.isArray(jardimData)) {
        for (let i = 0; i < jardimData.length; i++) {
            const v = jardimData[i];
            if (typeof v === 'string') {
                jardimData[i] = { icone: v };
            }
        }
    }

    // Verifica√ß√£o de seguran√ßa para redimensionamento (Garante que o array tenha o tamanho correto)
    if (!jardimData || jardimData.length !== totalCells) {
        const oldData = jardimData ? [...jardimData] : [];
        jardimData = Array(totalCells).fill(null);
        for(let i = 0; i < Math.min(oldData.length, totalCells); i++) {
            jardimData[i] = oldData[i];
        }
        
        // Salva a estrutura corrigida
        if (modoFundoMar) {
            jardimDataAquatico = jardimData;
            StorageSeguro.set('jardimAquatico', jardimData);
        } else {
            jardimDataNormal = jardimData;
            StorageSeguro.set('jardim', jardimData);
        }
    }
}

// NOVO: Fun√ß√£o para alternar entre grid 5x5 e 10x10
function toggleGrid10x10() {
    // Agora o toggle alterna entre os extremos comuns (5 e 10)
    const novoValor = gridSize === 10 ? 5 : 10;
    salvarNovoGrid(novoValor);
}

function expandGridManual() {
    if (gridSize >= 10) {
        showToast('üìê', 'Grid m√°ximo atingido!', 'O grid j√° est√° no tamanho m√°ximo (10x10).');
        return;
    }
    const novoTamanho = gridSize + 1;
    salvarNovoGrid(novoTamanho);
    showToast('üìè', 'Grid expandido!', `Grid aumentou para ${novoTamanho}x${novoTamanho}`);
    // Esconder o bot√£o se atingiu o m√°ximo
    const btnExpand = document.getElementById('btnExpandGrid');
    if (btnExpand && novoTamanho >= 10) {
        btnExpand.style.display = 'none';
    }
}

function ganharMoedasDebug() {
    // Adicionar 200 moedas
    const moedasAntigas = totalMoedas;
    totalMoedas += 200;
    
    // Atualizar storage
    StorageSeguro.set('moedasFoco', totalMoedas);
    
    // Atualizar display
    document.getElementById('userMoedas').textContent = totalMoedas;
    
    // Se a loja estiver aberta, atualizar l√° tamb√©m
    const saldoLoja = document.getElementById('saldoLojaMoedas');
    if (saldoLoja) {
        saldoLoja.textContent = totalMoedas;
    }
    
    // Mostrar confirma√ß√£o
    showModal({ 
        text: `üí∞ +200 Moedas Adicionadas!<br><br>Saldo anterior: ${moedasAntigas} üí∞<br>Novo saldo: ${totalMoedas} üí∞<br><br>Agora voc√™ pode comprar itens na loja!`, 
        onConfirm: () => {} 
    });
    
    // Efeito visual
    chuvaDeEfeitos('üí∞', 20);
    
    // Fechar modal de debug
    fecharModal('debugOverlay');
}

function fillGridTest() {
    const totalCells = getTotalCells();
    const testEmoji = grid10x10 ? 'ü™¥' : 'ü™¥';
    jardimData = Array(totalCells).fill({ icone: testEmoji, motivo: 'Teste Debug', lucky: false });
    salvarTudo();
    // Removido: triggerFinalSequence
}

function addMaxStarsTest() {
    for(let i=0; i<5; i++) { estante.push({ nome: `Livro ${i+1}`, nota: 5, cor: '#4caf50' }); }
    StorageSeguro.set('estante_livros', estante);
    renderEstante();
    renderEstrelasNoCeu();
}

function simularSucessosTest() {
    const agora = new Date();
    for(let i=0; i<10; i++) {
        const diaSimulado = new Date();
        diaSimulado.setDate(agora.getDate() - i);
        historico.push({
            data: diaSimulado.toISOString(), minutos: 25, motivo: motivos[0],
            icone: ITENS_PADRAO[0], mes: agora.getMonth(), ano: agora.getFullYear(), status: 'sucesso'
        });
    }
    sessoesTotais += 10;
    atualizarStreak();
    salvarTudo();
    showModal({ text: "10 sucessos inseridos no hist√≥rico!", onConfirm: () => {} });
}

function debugAvancarEurosummer() {
    eurosummerSessoes += 3;
    StorageSeguro.set('eurosummerSessoes', eurosummerSessoes);
    const cicloAtual = Math.floor(eurosummerSessoes / 3);
    // A fun√ß√£o correta √© mostrarCartaEurosummer(ciclo)
    mostrarCartaEurosummer(cicloAtual);
}

function debugAvancarFundoMar() {
    const proximaMeta = METAS_FUNDO_MAR.find(m => !fundoMarMetasConcluidas.includes(m.id));
    if (proximaMeta) {
        // A l√≥gica de conclus√£o de metas do Fundo do Mar est√° em verificarMetasFundoMar
        // Mas para debug, podemos simular a conclus√£o diretamente
        fundoMarMetasConcluidas.push(proximaMeta.id);
        StorageSeguro.set('fundoMarMetasConcluidas', fundoMarMetasConcluidas);
        mostrarCartaFundoMar(proximaMeta);
        renderMetasFundoMar();
    } else {
        showModal({ text: "Todas as metas do Fundo do Mar j√° foram conclu√≠das!", onConfirm: () => {} });
    }
}

function debugResetarHistorias() {
    showModal({
        text: "Deseja resetar o progresso do Eurosummer e Fundo do Mar?",
        onConfirm: () => {
            eurosummerSessoes = 0;
            eurosummerEmojisDesbloqueados = [];
            fundoMarMetasConcluidas = [];
            fundoMarEmojisDesbloqueados = [];
            StorageSeguro.set('eurosummerSessoes', 0);
            StorageSeguro.set('eurosummerEmojisDesbloqueados', []);
            StorageSeguro.set('fundoMarMetasConcluidas', []);
            StorageSeguro.set('fundoMarEmojisDesbloqueados', []);
            location.reload();
        }
    });
}


   

function atualizarVisibilidadeBtnExpand() {
    const btnExpand = document.getElementById('btnExpandGrid');
    const btnPlant = document.getElementById('btnPlantAbovePanel');
    if (!btnExpand || !btnPlant) return;
    
    const totalCells = gridSize * gridSize;
    const occupied = new Set();
    jardimData.forEach((x, i) => { if (x) occupied.add(i); });
    petsEmCena.forEach(p => occupied.add(p.index));
    
    const isFull = occupied.size === totalCells && gridSize < 10;
    btnExpand.style.display = isFull ? 'flex' : 'none';
    
    // Centralizar o bot√£o de plantar quando expand estiver oculto
    btnPlant.style.left = isFull ? 'calc(50% - 35px)' : '50%';
}
function analisarMelhoresMomentos() {
    // Tenta pegar o hist√≥rico se ele n√£o estiver global
    const historicoAtual = typeof historico !== 'undefined' ? historico : JSON.parse(localStorage.getItem('historico_foco') || '[]');
    
    if (historicoAtual.length < 3) return null;

    const contagemPeriodos = { 'manh√£': 0, 'tarde': 0, 'noite': 0, 'madrugada': 0 };
    const contagemDias = [0, 0, 0, 0, 0, 0, 0]; 
    const nomesDias = ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'];
    const iconesPeriodos = { 'manh√£': 'üåÖ', 'tarde': '‚òÄÔ∏è', 'noite': 'üåô', 'madrugada': 'ü¶â' };

    const sucessos = historicoAtual.filter(s => s.status === 'sucesso');

    if (sucessos.length === 0) return null;

    sucessos.forEach(s => {
        const data = new Date(s.data);
        const hora = data.getHours();
        const dia = data.getDay();
        contagemDias[dia]++;

        if (hora >= 5 && hora < 12) contagemPeriodos['manh√£']++;
        else if (hora >= 12 && hora < 17) contagemPeriodos['tarde']++;
        else if (hora >= 17 && hora < 21) contagemPeriodos['noite']++;
        else contagemPeriodos['madrugada']++;
    });

    const melhorP = Object.keys(contagemPeriodos).reduce((a, b) => contagemPeriodos[a] > contagemPeriodos[b] ? a : b);
    const melhorDIdx = contagemDias.indexOf(Math.max(...contagemDias));

    return {
        periodo: `${iconesPeriodos[melhorP]} ${melhorP.charAt(0).toUpperCase() + melhorP.slice(1)}`,
        dia: `üìÖ ${nomesDias[melhorDIdx]}`
    };
}

// 2. FUN√á√ÉO CALCULAR PREVIS√ÉO ATUALIZADA
function calcularPrevisao() {
    const painel = document.getElementById('painelInteligencia');
    if (!painel) return;

    // Pega dados do hist√≥rico
    const h = typeof historico !== 'undefined' ? historico : JSON.parse(localStorage.getItem('historico_foco') || '[]');
    
    // Se n√£o tiver dado nenhum ou op√ß√£o desligada
    if (typeof mostrarPrevisao !== 'undefined' && !mostrarPrevisao) {
        painel.style.display = 'none';
        return;
    }

    if (h.length < 3) {
        painel.style.display = 'block';
        painel.innerHTML = `<strong>‚ú® Calibrando...</strong><div class="detalhes-intel"><small>Complete mais sess√µes para ver seus padr√µes.</small></div>`;
        return;
    }

    // L√≥gica de c√°lculo (reutilizando a l√≥gica que voc√™ j√° tinha)
    const now = new Date();
    const motivoAtual = document.getElementById('motivoEscolhido')?.value || "Geral";
    const fatores = calcularFatoresPredictivos(now.getDay(), getPeriodo(now.getHours()), motivoAtual);
    
    const probabilidade = Math.round(
        fatores.diaMatch * 0.15 + fatores.periodoMatch * 0.15 + fatores.motivoMatch * 0.25 +
        fatores.duracaoMedia * 0.10 + fatores.tendenciaRecente * 0.15 +
        fatores.consistencia * 0.10 + fatores.momentumSemanal * 0.10
    );

    const cor = probabilidade > 70 ? '#4caf50' : (probabilidade < 40 ? '#e57373' : '#ffb74d');
    const insights = analisarMelhoresMomentos();

    // Monta o HTML
    painel.style.display = 'block';
    painel.style.borderColor = cor;
    painel.style.color = cor;

    let htmlInterno = `<strong>‚ú® ${probabilidade}% Sucesso</strong>`;
    htmlInterno += `<div class="detalhes-intel">`;
    htmlInterno += `<small style="display:block; margin-bottom:5px;">${probabilidade > 70 ? 'Foco Alt√≠ssimo!' : 'Cuidado com distra√ß√µes'}</small>`;
    
    if (insights) {
        htmlInterno += `
            <div style="border-top:1px dashed rgba(0,0,0,0.1); margin-top:8px; padding-top:8px; font-size:11px; color:#555;">
                <div style="margin-bottom:3px">üèÜ <b>Melhor Performance:</b></div>
                <div>${insights.periodo}</div>
                <div>${insights.dia}</div>
            </div>
        `;
    }
    
    htmlInterno += `</div>`;
    painel.innerHTML = htmlInterno;

    // GARANTE QUE O CLIQUE FUNCIONE:
    painel.onclick = function() {
        this.classList.toggle('expandido');
    };
}

// Fun√ß√£o auxiliar para o per√≠odo
function getPeriodo(hora) {
    if (hora >= 5 && hora < 12) return 'manh√£';
    if (hora >= 12 && hora < 17) return 'tarde';
    if (hora >= 17 && hora < 21) return 'noite';
    return 'madrugada';
}

function calcularFatoresPredictivos(diaAtual, periodoAtual, motivoAtual) {
    // Fator 1: Desempenho no mesmo dia da semana
    const sessoesDia = historico.filter(s => new Date(s.data).getDay() === diaAtual);
    const sucessosDia = sessoesDia.filter(s => s.status === 'sucesso' || s.status === 'parcial').length;
    const diaMatch = sessoesDia.length > 0 ? (sucessosDia / sessoesDia.length) * 100 : 50;
    
    // Fator 2: Desempenho no mesmo per√≠odo do dia
    const sessoesPeriodo = historico.filter(s => {
        const h = new Date(s.data).getHours();
        let p;
        if (h >= 5 && h < 12) p = 'manh√£';
        else if (h >= 12 && h < 17) p = 'tarde';
        else if (h >= 17 && h < 21) p = 'noite';
        else p = 'madrugada';
        return p === periodoAtual;
    });
    const sucessosPeriodo = sessoesPeriodo.filter(s => s.status === 'sucesso' || s.status === 'parcial').length;
    const periodoMatch = sessoesPeriodo.length > 0 ? (sucessosPeriodo / sessoesPeriodo.length) * 100 : 50;
    
    // Fator 3: Desempenho com o mesmo motivo
    const sessoeMotivo = historico.filter(s => s.motivo === motivoAtual);
    const sucessosMotivo = sessoeMotivo.filter(s => s.status === 'sucesso' || s.status === 'parcial').length;
    const motivoMatch = sessoeMotivo.length > 0 ? (sucessosMotivo / sessoeMotivo.length) * 100 : 50;
    
    // Fator 4: Dura√ß√£o m√©dia das sess√µes bem-sucedidas
    const sessoesSucesso = historico.filter(s => s.status === 'sucesso');
    const duracaoMedia = sessoesSucesso.length > 0 
        ? Math.min(100, (sessoesSucesso.reduce((sum, s) => sum + (s.minutos || 0), 0) / sessoesSucesso.length) / 30 * 100)
        : 50;
    
    // Fator 5: Tend√™ncia recente (√∫ltimas 7 sess√µes)
    const recentes = historico.slice(-7);
    const sucessosRecentes = recentes.filter(s => s.status === 'sucesso' || s.status === 'parcial').length;
    const tendenciaRecente = recentes.length > 0 ? (sucessosRecentes / recentes.length) * 100 : 50;
    
    // Fator 6: Consist√™ncia (varia√ß√£o de sucesso)
    const taxaSucesso = historico.filter(s => s.status === 'sucesso' || s.status === 'parcial').length / Math.max(historico.length, 1) * 100;
    const consistencia = Math.min(100, 50 + (Math.abs(50 - taxaSucesso) / 50 * 50)); // Quanto mais consistente, melhor
    
    // Fator 7: Momentum semanal (comparar esta semana com semana anterior)
    const agora = new Date();
    const umaSemanAtr√°s = new Date(agora.getTime() - 7 * 24 * 60 * 60 * 1000);
    const sessoesSemanaAtual = historico.filter(s => new Date(s.data) >= umaSemanAtr√°s);
    const sucessosSemanaAtual = sessoesSemanaAtual.filter(s => s.status === 'sucesso' || s.status === 'parcial').length;
    const momentumSemanal = sessoesSemanaAtual.length > 0 ? (sucessosSemanaAtual / sessoesSemanaAtual.length) * 100 : 50;
    
    return {
        diaMatch: Math.max(0, Math.min(100, diaMatch)),
        periodoMatch: Math.max(0, Math.min(100, periodoMatch)),
        motivoMatch: Math.max(0, Math.min(100, motivoMatch)),
        duracaoMedia: Math.max(0, Math.min(100, duracaoMedia)),
        tendenciaRecente: Math.max(0, Math.min(100, tendenciaRecente)),
        consistencia: Math.max(0, Math.min(100, consistencia)),
        momentumSemanal: Math.max(0, Math.min(100, momentumSemanal)),
        totalSessoes: historico.length,
        taxaSucesso: Math.round(taxaSucesso),
        sessoesSimilares: sessoeMotivo.length
    };
}

// Fun√ß√£o para exibir an√°lise detalhada dos fatores
function mostrarAnaliseFatores() {
    const fatores = calcularFatoresPredictivos(
        new Date().getDay(),
        (() => {
            const h = new Date().getHours();
            if (h >= 5 && h < 12) return 'manh√£';
            else if (h >= 12 && h < 17) return 'tarde';
            else if (h >= 17 && h < 21) return 'noite';
            else return 'madrugada';
        })(),
        document.getElementById('motivoEscolhido').value
    );
    
    const analise = `
    üìä AN√ÅLISE DETALHADA DOS FATORES DE PREDI√á√ÉO
    
    üóìÔ∏è Dia da Semana: ${Math.round(fatores.diaMatch)}%
    Desempenho hist√≥rico neste dia espec√≠fico
    
    ‚è∞ Per√≠odo do Dia: ${Math.round(fatores.periodoMatch)}%
    Performance neste per√≠odo (manh√£/tarde/noite)
    
    üéØ Tipo de Motivo: ${Math.round(fatores.motivoMatch)}%
    Hist√≥rico com este motivo espec√≠fico
    
    ‚è±Ô∏è Dura√ß√£o M√©dia: ${Math.round(fatores.duracaoMedia)}%
    Comparado com sess√µes bem-sucedidas
    
    üìà Tend√™ncia Recente: ${Math.round(fatores.tendenciaRecente)}%
    Performance das √∫ltimas 7 sess√µes
    
    üîÑ Consist√™ncia: ${Math.round(fatores.consistencia)}%
    Varia√ß√£o de sucesso ao longo do tempo
    
    üöÄ Momentum Semanal: ${Math.round(fatores.momentumSemanal)}%
    Compara√ß√£o com semana anterior
    
    üìä ESTAT√çSTICAS GERAIS
    Total de Sess√µes: ${fatores.totalSessoes}
    Taxa de Sucesso Geral: ${fatores.taxaSucesso}%
    Sess√µes com este Motivo: ${fatores.sessoesSimilares}
    `;
    
    console.log(analise);
    alert(analise);
}

function renderEstrelasNoCeu() {
    const container = document.getElementById('starsContainer');
    container.innerHTML = '';
    
    const isDarkMode = document.body.classList.contains('dark-mode');
    if(!exibirEstrelas || !isDarkMode) return;
    
    const livrosNotaMaxima = estante.filter(l => l.nota === 5);
    livrosNotaMaxima.forEach((l, i) => {
        const estrela = document.createElement('div');
        estrela.className = 'estrela-conquista'; estrela.textContent = '‚ú¶';
        estrela.style.left = (10 + (i * 137 % 80)) + 'vw'; estrela.style.top = (5 + (i * 97 % 30)) + 'vh';
        estrela.style.animationDelay = (i * 0.5) + 's'; estrela.style.fontSize = (12 + (i % 3) * 4) + 'px';
        container.appendChild(estrela);
    });
}

function toggleEstrelas() {
    exibirEstrelas = !exibirEstrelas;
    StorageSeguro.set('exibirEstrelas', exibirEstrelas);
    const btn = document.getElementById('btnEstrelas');
    if (btn) btn.classList.toggle('on', exibirEstrelas);
    renderEstrelasNoCeu();
}

function abrirEstante() { 
    abrirModal('estanteOverlay'); 
    renderEstante(); 
}

// ============================================================
// SISTEMA PLANTAR JUNTOS - P2P com PeerJS
// ============================================================

let plantarJuntosData = [];
let plantaPJSelecionada = 'üå±';
let celulaAlvoPJ = null;
let timerPJInterval = null;
let tempoPJRestante = 0;
let codigoSalaPJ = '';
let salaConectadaPJ = null;

// PeerJS
let peerPJ = null;
let conexaoPJ = null;
let conectadosAoMeuPeer = []; // Lista de conex√µes entrantes
let participantesPJ = new Map(); // Map: peerId -> { nome, conexao, statusConexao }
let focosEmProgressoPJ = new Map(); // Map: index -> { planta, nome, peerId }
let previewsPJ = new Map(); // Map: index -> { planta, nome }
let intervalReconexaoPJ = null; // Timer de reconex√£o autom√°tica
let intervalHeartbeatPJ = null; // Timer de heartbeat
let pipWindowPJ = null; // Janela PIP
let intervalPipUpdatePJ = null; // Timer de atualiza√ß√£o do PIP
let workerPJ = null; // Web Worker para background
let tempoTotalFocoPJHoje = 0; // Meu tempo focado hoje (em minutos)
let temposParticipantesPJ = new Map(); // Map: peerId -> minutos focados hoje
let digitandoPJTimeout = null; // Timeout para indicador de digitando
let statusParticipantesPJ = new Map(); // Map: peerId -> { status, tempoInicio }
let souHostPJ = false; // Se eu criei a sala (sou o host)
let permissaoBulldozePJ = false; // Host permite que convidados usem bulldoze?
let chatMutadoPJ = false; // Host silenciou o chat para todos?
let hostAtualPJ = null; // PeerId do host atual (para heran√ßa)
let ordemEntradaPJ = []; // Ordem de entrada para heran√ßa de host
let aprovarEntradaPJ = false; // Host precisa aprovar novas entradas?
let solicitacoesPendentes = new Map(); // Map: peerId -> { nome, conn, timestamp }
const HEARTBEAT_INTERVAL = 3000; // 3 segundos
const HEARTBEAT_TIMEOUT = 60000; // 60 segundos sem resposta = desconectado

// Carregar tempo total salvo
function carregarTempoTotalPJ() {
    const hoje = new Date().toDateString();
    const salvo = StorageSeguro.get('tempoTotalPJ', { data: '', minutos: 0 });
    
    if (salvo.data === hoje) {
        tempoTotalFocoPJHoje = salvo.minutos;
    } else {
        tempoTotalFocoPJHoje = 0;
    }
    atualizarDisplayTempoTotalPJ();
}

// Salvar tempo total
function salvarTempoTotalPJ() {
    const hoje = new Date().toDateString();
    StorageSeguro.set('tempoTotalPJ', { data: hoje, minutos: tempoTotalFocoPJHoje });
}

// Adicionar minutos ao total e sincronizar com grupo
function adicionarTempoFocoPJ(minutos) {
    tempoTotalFocoPJHoje += minutos;
    salvarTempoTotalPJ();
    atualizarDisplayTempoTotalPJ();
    
    // Enviar meu tempo atualizado para o grupo
    enviarMensagemP2P({
        tipo: 'tempo_focado',
        minutos: tempoTotalFocoPJHoje,
        nome: obterNomeJogador()
    });
}

// Calcular tempo total do grupo
function calcularTempoGrupoPJ() {
    let total = tempoTotalFocoPJHoje; // Come√ßa com meu tempo
    
    // Soma tempo dos participantes conectados
    temposParticipantesPJ.forEach((minutos, peerId) => {
        // S√≥ contar se o participante ainda est√° ativo
        const info = participantesPJ.get(peerId);
        if (info && !info.inativo && info.statusConexao !== 'sem_resposta') {
            total += minutos;
        }
    });
    
    return total;
}

// Atualizar display da p√≠lula (tempo do grupo)
function atualizarDisplayTempoTotalPJ() {
    const el = document.getElementById('tempoTotalPJValor');
    if (!el) return;
    
    const tempoGrupo = calcularTempoGrupoPJ();
    const horas = Math.floor(tempoGrupo / 60);
    const mins = tempoGrupo % 60;
    
    if (horas > 0) {
        el.textContent = `${horas}h ${mins}min`;
    } else {
        el.textContent = `${mins}min`;
    }
}

// Obter nome do jogador
function obterNomeJogador() {
    return StorageSeguro.get('jogadorNome', 'An√¥nimo');
}

// Fun√ß√£o de vibra√ß√£o para feedback h√°ptico
function vibrarPJ(tipo = 'curta') {
    if (!navigator.vibrate) return;
    
    const padroes = {
        curta: [50],                    // Toque r√°pido
        dupla: [50, 50, 50],           // Duplo toque
        sucesso: [100, 50, 100, 50, 200], // Conclus√£o
        alerta: [200, 100, 200],       // Aten√ß√£o
        mensagem: [30, 30, 30],        // Notifica√ß√£o sutil
        conexao: [100, 50, 100]        // Amigo conectou
    };
    
    navigator.vibrate(padroes[tipo] || padroes.curta);
}

// Toggle da permiss√£o de bulldoze para convidados
function togglePermissaoBulldozePJ() {
    const checkbox = document.getElementById('checkPermissaoBulldozePJ');
    const slider = document.getElementById('sliderBulldozePJ');
    
    permissaoBulldozePJ = checkbox ? checkbox.checked : false;
    
    // Atualizar visual do slider
    if (slider) {
        if (permissaoBulldozePJ) {
            slider.style.transform = 'translateX(16px)';
            slider.parentElement.querySelector('span:first-of-type').style.backgroundColor = 'var(--primary)';
        } else {
            slider.style.transform = 'translateX(0)';
            slider.parentElement.querySelector('span:first-of-type').style.backgroundColor = '#ccc';
        }
    }
    
    // Enviar atualiza√ß√£o de permiss√£o para todos os peers
    enviarMensagemP2P({
        tipo: 'permissao_bulldoze',
        permitido: permissaoBulldozePJ
    });
    
    showToast('üå™Ô∏è', 'Permiss√£o atualizada', 
        permissaoBulldozePJ 
            ? 'Convidados podem limpar o jardim' 
            : 'Apenas voc√™ pode limpar o jardim'
    );
}

// Toggle do modo silencioso (muta chat para todos)
function toggleChatMutadoPJ() {
    if (!souHostPJ) return;
    
    const checkbox = document.getElementById('checkChatMutadoPJ');
    const slider = document.getElementById('sliderChatMutadoPJ');
    
    chatMutadoPJ = checkbox ? checkbox.checked : false;
    
    // Atualizar visual do slider
    if (slider) {
        if (chatMutadoPJ) {
            slider.style.transform = 'translateX(16px)';
            slider.parentElement.querySelector('span:first-of-type').style.backgroundColor = '#f44336';
        } else {
            slider.style.transform = 'translateX(0)';
            slider.parentElement.querySelector('span:first-of-type').style.backgroundColor = '#ccc';
        }
    }
    
    // Enviar para todos
    enviarMensagemP2P({
        tipo: 'chat_mutado',
        mutado: chatMutadoPJ
    });
    
    // Atualizar UI local
    atualizarEstadoChatMutado();
    
    showToast('üîá', chatMutadoPJ ? 'Chat silenciado' : 'Chat liberado', 
        chatMutadoPJ ? 'Ningu√©m pode enviar mensagens' : 'Todos podem enviar mensagens'
    );
}

// Atualizar estado visual do chat quando mutado
function atualizarEstadoChatMutado() {
    const inputChat = document.getElementById('inputChatPJ');
    const btnEnviar = document.querySelector('#conteudoChatPJ button[onclick*="enviarMensagemChatPJ"]');
    
    if (inputChat) {
        inputChat.disabled = chatMutadoPJ && !souHostPJ;
        inputChat.placeholder = (chatMutadoPJ && !souHostPJ) ? 'üîá Chat silenciado pelo host' : 'Mensagem...';
        inputChat.style.opacity = (chatMutadoPJ && !souHostPJ) ? '0.5' : '1';
    }
    
    if (btnEnviar) {
        btnEnviar.disabled = chatMutadoPJ && !souHostPJ;
        btnEnviar.style.opacity = (chatMutadoPJ && !souHostPJ) ? '0.5' : '1';
    }
}

// Expulsar participante da sala
function expulsarParticipantePJ(peerId) {
    if (!souHostPJ) {
        showToast('üö´', 'Sem permiss√£o', 'Apenas o host pode expulsar');
        return;
    }
    
    const info = participantesPJ.get(peerId);
    const nome = info ? info.nome : 'Participante';
    
    showModal({
        text: `üö™ Expulsar <strong>${nome}</strong> da sala?<br><br>Essa pessoa ser√° desconectada imediatamente.`,
        confirmText: 'Sim, expulsar',
        onConfirm: () => {
            // Enviar mensagem de expuls√£o para o peer espec√≠fico
            const conn = info ? info.conexao : null;
            if (conn && conn.open) {
                conn.send(JSON.stringify({
                    tipo: 'expulso',
                    motivo: 'Voc√™ foi removido da sala pelo host'
                }));
                
                // Fechar conex√£o ap√≥s pequeno delay
                setTimeout(() => {
                    conn.close();
                }, 500);
            }
            
            // Remover localmente
            participantesPJ.delete(peerId);
            statusParticipantesPJ.delete(peerId);
            temposParticipantesPJ.delete(peerId);
            
            // Remover da lista de conex√µes
            conectadosAoMeuPeer = conectadosAoMeuPeer.filter(c => c.peer !== peerId);
            
            // Remover da ordem de entrada
            ordemEntradaPJ = ordemEntradaPJ.filter(p => p !== peerId);
            
            atualizarListaParticipantes();
            atualizarPlantasAmigos();
            atualizarVisibilidadeChat();
            
            showToast('üö™', 'Participante expulso', `${nome} foi removido da sala`);
            
            // Notificar outros participantes
            enviarMensagemP2P({
                tipo: 'participante_expulso',
                peerId: peerId,
                nome: nome
            });
        }
    });
}

// Transferir host para outro participante
function transferirHostPJ(peerId) {
    if (!souHostPJ) return;
    
    const info = participantesPJ.get(peerId);
    const nome = info ? info.nome : 'Participante';
    
    showModal({
        text: `üëë Transferir host para <strong>${nome}</strong>?<br><br>Voc√™ perder√° os controles de administrador.`,
        confirmText: 'Sim, transferir',
        onConfirm: () => {
            // Enviar mensagem de novo host
            enviarMensagemP2P({
                tipo: 'novo_host',
                novoHostId: peerId,
                novoHostNome: nome
            });
            
            // Atualizar localmente
            souHostPJ = false;
            hostAtualPJ = peerId;
            
            // Esconder controles de host
            const toggleBulldoze = document.getElementById('togglePermissaoBulldozePJ');
            const toggleChat = document.getElementById('toggleChatMutadoPJ');
            if (toggleBulldoze) toggleBulldoze.style.display = 'none';
            if (toggleChat) toggleChat.style.display = 'none';
            
            atualizarListaParticipantes();
            
            showToast('üëë', 'Host transferido', `${nome} agora √© o host da sala`);
        }
    });
}

// Heran√ßa autom√°tica de host quando host sai
function verificarHerancaHost(hostQueSaiu) {
    // Se eu n√£o era o host que saiu, verificar se devo assumir
    if (hostQueSaiu === hostAtualPJ && !souHostPJ) {
        // Verificar se sou o pr√≥ximo na fila
        const meuPeerId = peerPJ ? peerPJ.id : null;
        
        if (ordemEntradaPJ.length > 0 && ordemEntradaPJ[0] === meuPeerId) {
            // Eu sou o pr√≥ximo! Assumir host
            souHostPJ = true;
            hostAtualPJ = meuPeerId;
            permissaoBulldozePJ = true; // Resetar permiss√µes padr√£o para host
            chatMutadoPJ = false;
            aprovarEntradaPJ = false;
            
            // Mostrar controles de host
            const toggleBulldoze = document.getElementById('togglePermissaoBulldozePJ');
            const toggleChat = document.getElementById('toggleChatMutadoPJ');
            const toggleAprovar = document.getElementById('toggleAprovarEntradaPJ');
            if (toggleBulldoze) toggleBulldoze.style.display = 'flex';
            if (toggleChat) toggleChat.style.display = 'flex';
            if (toggleAprovar) toggleAprovar.style.display = 'flex';
            
            // Notificar todos que agora sou o host
            enviarMensagemP2P({
                tipo: 'novo_host',
                novoHostId: meuPeerId,
                novoHostNome: obterNomeJogador()
            });
            
            showToast('üëë', 'Voc√™ √© o novo host!', 'O host anterior saiu e voc√™ assumiu o controle');
            vibrarPJ('sucesso');
            
            atualizarListaParticipantes();
        }
    }
}

// Toggle para aprovar entrada de novos participantes
function toggleAprovarEntradaPJ() {
    if (!souHostPJ) return;
    
    const checkbox = document.getElementById('checkAprovarEntradaPJ');
    const slider = document.getElementById('sliderAprovarEntradaPJ');
    
    aprovarEntradaPJ = checkbox ? checkbox.checked : false;
    
    // Atualizar visual do slider
    if (slider) {
        if (aprovarEntradaPJ) {
            slider.style.transform = 'translateX(16px)';
            slider.parentElement.querySelector('span:first-of-type').style.backgroundColor = '#2196f3';
        } else {
            slider.style.transform = 'translateX(0)';
            slider.parentElement.querySelector('span:first-of-type').style.backgroundColor = '#ccc';
        }
    }
    
    // Se n√£o h√° ningu√©m conectado, n√£o gere novo c√≥digo automaticamente ‚Äî mantenha o c√≥digo atual.
    const conectados = Array.isArray(conectadosAoMeuPeer) ? conectadosAoMeuPeer.filter(c => c && c.open) : [];
    if (conectados.length === 0) {
        // Evitar rotacionar o c√≥digo sem a√ß√£o expl√≠cita do host ‚Äî isso confunde convidados que tentam entrar com o c√≥digo antigo.
        showToast('üö™', 'Configura√ß√£o alterada', 'Configura√ß√£o salva ‚Äî o c√≥digo da sala permanece o mesmo. Para criar um novo c√≥digo, use o bot√£o "Gerar Novo C√≥digo".');
        return;
    }

    // Enviar para todos
    enviarMensagemP2P({
        tipo: 'config_aprovacao',
        requerAprovacao: aprovarEntradaPJ
    });

    showToast('üö™', aprovarEntradaPJ ? 'Sala de espera ativada' : 'Entrada livre', 
        aprovarEntradaPJ ? 'Novos participantes precisam de aprova√ß√£o' : 'Qualquer um pode entrar'
    );
}

// Aprovar solicita√ß√£o de entrada
function aprovarSolicitacaoPJ(peerId) {
    const solicitacao = solicitacoesPendentes.get(peerId);
    if (!solicitacao) return; // J√° processada ou expirada
    
    const conn = solicitacao.conn;
    
    // Enviar aprova√ß√£o
    if (conn && conn.open) {
        conn.send(JSON.stringify({
            tipo: 'entrada_aprovada'
        }));
        
        // Adicionar √† lista de participantes
        participantesPJ.set(peerId, {
            nome: solicitacao.nome,
            conexao: conn,
            plantaSelecionada: 'üå±',
            inativo: false,
            statusConexao: 'conectado',
            conectadoEm: Date.now(),
            ultimoHeartbeat: Date.now()
        });
        
        // Enviar meu nome e grid
        enviarMensagemP2P({
            tipo: 'apresentacao',
            nome: obterNomeJogador(),
            peerId: peerPJ.id,
            planta: plantaPJSelecionada,
            tempoFocado: tempoTotalFocoPJHoje
        }, conn);
        
        enviarMensagemP2P({
            tipo: 'sync_completo',
            data: plantarJuntosData
        }, conn);
        
        // Enviar permiss√µes
        enviarMensagemP2P({ tipo: 'permissao_bulldoze', permitido: permissaoBulldozePJ }, conn);
        enviarMensagemP2P({ tipo: 'chat_mutado', mutado: chatMutadoPJ }, conn);
        enviarMensagemP2P({ tipo: 'novo_host', novoHostId: peerPJ.id, novoHostNome: obterNomeJogador() }, conn);
        
        // Adicionar √† ordem de entrada
        if (!ordemEntradaPJ.includes(peerId)) {
            ordemEntradaPJ.push(peerId);
        }
        
        // Configurar eventos
        configurarConexao(conn);
        conectadosAoMeuPeer.push(conn);
        
        showToast('‚úÖ', 'Entrada aprovada', `${solicitacao.nome} entrou na sala`);
        vibrarPJ('conexao');
    }
    
    solicitacoesPendentes.delete(peerId);
    atualizarListaParticipantes();
    atualizarListaSolicitacoes();
}

// Rejeitar solicita√ß√£o de entrada
function rejeitarSolicitacaoPJ(peerId) {
    const solicitacao = solicitacoesPendentes.get(peerId);
    if (!solicitacao) return; // J√° processada ou expirada
    
    const conn = solicitacao.conn;
    
    // Enviar rejei√ß√£o
    if (conn && conn.open) {
        conn.send(JSON.stringify({
            tipo: 'entrada_rejeitada',
            motivo: 'O host recusou sua entrada'
        }));
        
        setTimeout(() => {
            conn.close();
        }, 500);
    }
    
    showToast('üö´', 'Entrada recusada', `${solicitacao.nome} foi recusado`);
    
    solicitacoesPendentes.delete(peerId);
    atualizarListaSolicitacoes();
}

// Atualizar lista visual de solicita√ß√µes pendentes
function atualizarListaSolicitacoes() {
    const container = document.getElementById('solicitacoesPendentesPJ');
    if (!container) return;
    
    if (solicitacoesPendentes.size === 0) {
        container.style.display = 'none';
        container.innerHTML = '';
        return;
    }
    
    container.style.display = 'block';
    container.innerHTML = '<div style="font-size: 10px; font-weight: 600; margin-bottom: 8px; color: #ff9800;">üîî Solicita√ß√µes de entrada</div>';
    
    solicitacoesPendentes.forEach((info, peerId) => {
        const item = document.createElement('div');
        item.style.cssText = 'display: flex; align-items: center; justify-content: space-between; background: rgba(255, 152, 0, 0.15); padding: 6px 10px; border-radius: 10px; margin-bottom: 4px; font-size: 11px;';
        item.innerHTML = `
            <span>üë§ ${info.nome}</span>
            <div style="display: flex; gap: 4px;">
                <button onclick="aprovarSolicitacaoPJ('${peerId}')" style="background: #4caf50; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 12px;" title="Aprovar">‚úì</button>
                <button onclick="rejeitarSolicitacaoPJ('${peerId}')" style="background: #f44336; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 12px;" title="Recusar">‚úï</button>
            </div>
        `;
        container.appendChild(item);
    });
}

// Gerar c√≥digo √∫nico de 4 caracteres
function gerarCodigoSala() {
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    let codigo = '';
    for (let i = 0; i < 4; i++) {
        codigo += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return codigo;
}

// Inicializar PeerJS
function inicializarPeerPJ(codigo) {
    if (typeof Peer === 'undefined') {
        console.error('PeerJS n√£o carregado! Verifique sua conex√£o com a internet.');
        atualizarStatusConexao('‚ùå Biblioteca PeerJS n√£o carregada');
        return;
    }
    
    if (peerPJ) {
        peerPJ.destroy();
    }
    
    // Criar peer com o c√≥digo como ID
    peerPJ = new Peer('PJ-' + codigo, {
        debug: 0,
        config: {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:global.stun.twilio.com:3478' }
            ]
        }
    });
    
    peerPJ.on('open', (id) => {
        console.log('Peer criado com ID:', id);
        atualizarStatusConexao('üü¢ Sala aberta - aguardando conex√µes...');
        atualizarListaParticipantes();
    });
    
    peerPJ.on('connection', (conn) => {
        console.log('Algu√©m tentando conectar:', conn.peer);
        
        // Verificar se a sala est√° cheia (m√°ximo 4 amigos + host = 5 pessoas)
        const totalConectados = conectadosAoMeuPeer.filter(c => c.open).length;
        if (totalConectados >= 4) {
            console.log('Sala cheia, rejeitando conex√£o');
            // Enviar mensagem de sala cheia antes de fechar
            conn.on('open', () => {
                conn.send(JSON.stringify({
                    tipo: 'sala_cheia'
                }));
                setTimeout(() => conn.close(), 500);
            });
            return;
        }
        
        // Se aprova√ß√£o de entrada est√° ativada, colocar em sala de espera
        if (aprovarEntradaPJ && souHostPJ) {
            conn.on('open', () => {
                // Pedir nome do visitante
                conn.send(JSON.stringify({
                    tipo: 'aguardando_aprovacao'
                }));
                
                // Timeout: se n√£o solicitar em 30s, fechar
                const timeout = setTimeout(() => {
                    if (solicitacoesPendentes.has(conn.peer)) {
                        solicitacoesPendentes.delete(conn.peer);
                        atualizarListaSolicitacoes();
                        conn.close();
                        console.log('Conex√£o fechada por timeout de aprova√ß√£o:', conn.peer);
                    }
                }, 30000);
                
                // Esperar resposta com nome
                conn.on('data', (data) => {
                    try {
                        const msg = typeof data === 'string' ? JSON.parse(data) : data;
                        if (msg.tipo === 'solicitar_entrada') {
                            clearTimeout(timeout); // Cancelar timeout
                            solicitacoesPendentes.set(conn.peer, {
                                nome: msg.nome || 'Visitante',
                                conn: conn,
                                timestamp: Date.now()
                            });
                            atualizarListaSolicitacoes();
                            showToast('üîî', 'Nova solicita√ß√£o', `${msg.nome || 'Algu√©m'} quer entrar na sala`);
                            vibrarPJ('mensagem');
                        }
                    } catch(e) {
                        console.error('Erro ao processar solicitar_entrada:', e);
                    }
                });
            });
            return;
        }
        
        configurarConexao(conn);
        conectadosAoMeuPeer.push(conn);
        
        // Enviar estado atual do grid e meu nome para o novo conectado
        conn.on('open', () => {
            // Enviar meu nome primeiro
            enviarMensagemP2P({
                tipo: 'apresentacao',
                nome: obterNomeJogador(),
                peerId: peerPJ.id,
                planta: plantaPJSelecionada,
                tempoFocado: tempoTotalFocoPJHoje
            }, conn);
            
            // Depois enviar o grid
            enviarMensagemP2P({
                tipo: 'sync_completo',
                data: plantarJuntosData
            }, conn);
            
            // Se sou host, enviar permiss√µes e info
            if (souHostPJ) {
                enviarMensagemP2P({
                    tipo: 'permissao_bulldoze',
                    permitido: permissaoBulldozePJ
                }, conn);
                
                enviarMensagemP2P({
                    tipo: 'chat_mutado',
                    mutado: chatMutadoPJ
                }, conn);
                
                // Enviar quem √© o host
                enviarMensagemP2P({
                    tipo: 'novo_host',
                    novoHostId: peerPJ.id,
                    novoHostNome: obterNomeJogador()
                }, conn);
                
                // Enviar ordem de entrada
                enviarMensagemP2P({
                    tipo: 'ordem_entrada',
                    ordem: ordemEntradaPJ
                }, conn);
            }
        });
    });
    
    peerPJ.on('error', (err) => {
        console.error('Erro no peer:', err);
        const msg = (err && err.type) ? `${err.type}: ${err}` : (err && err.message) ? err.message : String(err);
        atualizarStatusConexao('‚ùå Erro na conex√£o P2P');
        showToast('‚ùå', 'Erro PeerJS', `Erro no peer: ${msg}`);
    });
}

// Configurar eventos de uma conex√£o
function configurarConexao(conn) {
    conn.on('data', (mensagem) => {
        receberMensagemP2P(mensagem, conn);
    });
    
    conn.on('close', () => {
        console.log('Conex√£o fechada:', conn.peer);
        conectadosAoMeuPeer = conectadosAoMeuPeer.filter(c => c !== conn);
        
        // Verificar se era o host que saiu
        const peerQueSaiu = conn.peer;
        const eraHost = peerQueSaiu === hostAtualPJ;
        
        // Marcar participante como inativo em vez de remover imediatamente
        if (participantesPJ.has(conn.peer)) {
            const info = participantesPJ.get(conn.peer);
            info.inativo = true;
            info.inativoDesde = Date.now();
            participantesPJ.set(conn.peer, info);
            
            // Atualizar ordem de entrada (remover quem saiu)
            ordemEntradaPJ = ordemEntradaPJ.filter(p => p !== conn.peer);
            
            // Se era o host, verificar heran√ßa
            if (eraHost) {
                verificarHerancaHost(peerQueSaiu);
            }
            
            // Agendar remo√ß√£o ap√≥s 1 minuto
            setTimeout(() => {
                if (participantesPJ.has(conn.peer)) {
                    const infoAtual = participantesPJ.get(conn.peer);
                    if (infoAtual.inativo) {
                        participantesPJ.delete(conn.peer);
                        atualizarListaParticipantes();
                        showToast('üëã', 'Amigo saiu', `${info.nome} foi desconectado por inatividade`);
                    }
                }
            }, 60000); // 1 minuto
        }
        
        if (conexaoPJ === conn) {
            conexaoPJ = null;
            salaConectadaPJ = null;
        }
        
        atualizarListaParticipantes();
        atualizarStatusConexao(conectadosAoMeuPeer.length > 0 ? 
            `ü§ù ${conectadosAoMeuPeer.length} amigo(s) conectado(s)` : 
            'üü¢ Sala aberta - aguardando conex√µes...');
    });
}

// Enviar mensagem P2P
function enviarMensagemP2P(mensagem, conexaoEspecifica = null) {
    const payload = JSON.stringify(mensagem);
    
    // Enviar para conex√£o espec√≠fica ou broadcast para todos
    if (conexaoEspecifica) {
        conexaoEspecifica.send(payload);
    } else {
        // Enviar para quem eu me conectei
        if (conexaoPJ && conexaoPJ.open) {
            conexaoPJ.send(payload);
        }
        
        // Enviar para quem se conectou a mim
        conectadosAoMeuPeer.forEach(conn => {
            if (conn.open) {
                conn.send(payload);
            }
        });
    }
}

// Receber mensagem P2P
function receberMensagemP2P(data, conn) {
    try {
        const mensagem = JSON.parse(data);
        
        // Qualquer mensagem recebida atualiza o heartbeat do remetente
        const peerRemetente = conn ? conn.peer : null;
        if (peerRemetente && participantesPJ.has(peerRemetente)) {
            const infoRem = participantesPJ.get(peerRemetente);
            infoRem.ultimoHeartbeat = Date.now();
            if (infoRem.statusConexao !== 'conectado') {
                infoRem.statusConexao = 'conectado';
                atualizarListaParticipantes();
            }
            participantesPJ.set(peerRemetente, infoRem);
        }
        
        switch (mensagem.tipo) {
            case 'apresentacao':
                // Receber nome de um participante (ou atualizar se reconectou)
                const peerIdApres = mensagem.peerId || conn.peer;
                const infoExistente = participantesPJ.get(peerIdApres);
                
                // Limpar perfis antigos que estejam sem resposta ou inativos
                // (quando algu√©m reconecta, pode vir com outro peer ID e/ou nome diferente)
                participantesPJ.forEach((info, peerId) => {
                    if (peerId !== peerIdApres && (info.statusConexao === 'sem_resposta' || info.inativo)) {
                        participantesPJ.delete(peerId);
                        console.log(`Removido perfil antigo: ${info.nome} (peer: ${peerId})`);
                    }
                });
                
                // Se j√° existia e estava inativo, significa que reconectou
                if (infoExistente && (infoExistente.inativo || infoExistente.statusConexao === 'sem_resposta')) {
                    showToast('üîó', 'Amigo voltou!', `${mensagem.nome} reconectou √† sala`);
                    vibrarPJ('conexao');
                } else if (!infoExistente) {
                    // Novo amigo conectando
                    vibrarPJ('conexao');
                }
                
                participantesPJ.set(peerIdApres, {
                    nome: mensagem.nome,
                    conexao: conn,
                    plantaSelecionada: mensagem.planta || 'üå±',
                    inativo: false, // Sempre marcar como ativo ao receber apresenta√ß√£o
                    statusConexao: 'conectado',
                    conectadoEm: Date.now(),
                    ultimoHeartbeat: Date.now()
                });
                
                // Atualizar ordem de entrada para heran√ßa de host
                if (!ordemEntradaPJ.includes(peerIdApres)) {
                    ordemEntradaPJ.push(peerIdApres);
                    
                    // Se sou host, enviar ordem atualizada para todos
                    if (souHostPJ) {
                        enviarMensagemP2P({
                            tipo: 'ordem_entrada',
                            ordem: ordemEntradaPJ
                        });
                    }
                }
                
                atualizarListaParticipantes();
                
                // Guardar tempo focado do amigo se enviado
                if (mensagem.tempoFocado !== undefined) {
                    temposParticipantesPJ.set(peerIdApres, mensagem.tempoFocado);
                    atualizarDisplayTempoTotalPJ();
                }
                
                // Enviar minha apresenta√ß√£o de volta
                enviarMensagemP2P({
                    tipo: 'apresentacao',
                    nome: obterNomeJogador(),
                    peerId: peerPJ.id,
                    planta: plantaPJSelecionada,
                    tempoFocado: tempoTotalFocoPJHoje
                }, conn);
                break;
                
            case 'sync_completo':
                // Receber estado completo do grid
                plantarJuntosData = mensagem.data || [];
                renderGridPlantarJuntos();
                break;
                
            case 'plantar':
                // Algu√©m plantou algo
                if (mensagem.index !== undefined && mensagem.planta) {
                    plantarJuntosData[mensagem.index] = mensagem.planta;
                    renderGridPlantarJuntos();
                    
                    const nomeParticipante = mensagem.nome || 'Amigo';
                    showToast('üå±', `${nomeParticipante} plantou!`, `${nomeParticipante} plantou ${mensagem.planta.icone}`);
                }
                break;
                
            case 'limpar_celula':
                // Algu√©m limpou uma c√©lula
                if (mensagem.index !== undefined) {
                    plantarJuntosData[mensagem.index] = null;
                    renderGridPlantarJuntos();
                }
                break;
                
            case 'iniciar_foco':
                // Sistema de progress√£o desabilitado; ignorando evento 'iniciar_foco'
                break;
                
            case 'finalizar_foco':
                // Sistema de progress√£o desabilitado; ignorando evento 'finalizar_foco'
                break;
                
            case 'cancelar_foco':
                // Sistema de progress√£o desabilitado; ignorando evento 'cancelar_foco'
                break;
                
            case 'planta_selecionada':
                // Evento de sele√ß√£o de planta recebido (previews desabilitados) - apenas atualiza informa√ß√µes do participante
                const peerId = mensagem.peerId || conn.peer;
                if (participantesPJ.has(peerId)) {
                    const info = participantesPJ.get(peerId);
                    info.plantaSelecionada = mensagem.planta;
                    participantesPJ.set(peerId, info);
                } else {
                    participantesPJ.set(peerId, {
                        nome: mensagem.nome || 'Amigo',
                        conexao: conn,
                        plantaSelecionada: mensagem.planta
                    });
                }
                atualizarPlantasAmigos();
                renderGridPlantarJuntos();
                break;
                
            case 'celula_selecionada':
                // Previews desabilitados - ignorando 'celula_selecionada'
                break;
                
            case 'celula_deselecionada':
                // Previews desabilitados - ignorando 'celula_deselecionada'
                break;
                
            case 'sala_cheia':
                // A sala est√° cheia, n√£o podemos entrar
                showToast('üö´', 'Sala Cheia!', 'Esta sala j√° tem 5 pessoas (m√°ximo permitido)');
                atualizarStatusConexao('‚ùå Sala cheia - tente outra sala');
                salaConectadaPJ = null;
                if (conexaoPJ) {
                    conexaoPJ.close();
                    conexaoPJ = null;
                }
                break;
                
            case 'chat':
                // Mensagem de chat recebida
                adicionarMensagemChatPJ({
                    nome: mensagem.nome || 'Amigo',
                    texto: mensagem.texto,
                    timestamp: mensagem.timestamp || Date.now(),
                    minha: false
                });
                
                // Vibrar ao receber mensagem
                vibrarPJ('mensagem');
                
                // Notifica√ß√£o se n√£o estiver com o modal aberto
                const modalPJ = document.getElementById('plantarJuntosOverlay');
                if (!modalPJ || modalPJ.style.display === 'none') {
                    showToast('üí¨', mensagem.nome || 'Amigo', mensagem.texto.substring(0, 50) + (mensagem.texto.length > 50 ? '...' : ''));
                }
                break;
                
            case 'heartbeat':
                // Responder ao ping com pong
                if (conn && conn.open) {
                    conn.send(JSON.stringify({
                        tipo: 'heartbeat_resposta',
                        peerId: peerPJ ? peerPJ.id : null
                    }));
                }
                break;
                
            case 'heartbeat_resposta':
                // Recebemos resposta de heartbeat, atualizar status
                const peerRespondeu = mensagem.peerId || (conn ? conn.peer : null);
                if (peerRespondeu && participantesPJ.has(peerRespondeu)) {
                    const infoParticipante = participantesPJ.get(peerRespondeu);
                    infoParticipante.ultimoHeartbeat = Date.now();
                    infoParticipante.statusConexao = 'conectado';
                    participantesPJ.set(peerRespondeu, infoParticipante);
                    atualizarListaParticipantes();
                }
                break;
                
            case 'tempo_focado':
                // Recebemos tempo focado de um amigo
                const peerTempo = mensagem.peerId || (conn ? conn.peer : null);
                if (peerTempo && mensagem.minutos !== undefined) {
                    temposParticipantesPJ.set(peerTempo, mensagem.minutos);
                    atualizarDisplayTempoTotalPJ();
                }
                break;
                
            case 'digitando':
                // Algu√©m est√° digitando
                mostrarIndicadorDigitando(mensagem.nome);
                break;
                
            case 'parou_digitar':
                // Algu√©m parou de digitar
                esconderIndicadorDigitando();
                break;
                
            case 'status_atualizado':
                // Status de um participante mudou
                const peerStatus = mensagem.peerId || (conn ? conn.peer : null);
                if (peerStatus) {
                    statusParticipantesPJ.set(peerStatus, {
                        status: mensagem.status,
                        tempoInicio: mensagem.tempoInicio,
                        nome: mensagem.nome
                    });
                    atualizarListaParticipantes();
                }
                break;
                
            case 'permissao_bulldoze':
                // Host atualizou permiss√£o de bulldoze
                if (!souHostPJ) {
                    permissaoBulldozePJ = mensagem.permitido === true;
                    console.log('Permiss√£o de bulldoze atualizada:', permissaoBulldozePJ);
                }
                break;
                
            case 'chat_mutado':
                // Host mutou/desmutou o chat
                if (!souHostPJ) {
                    chatMutadoPJ = mensagem.mutado === true;
                    atualizarEstadoChatMutado();
                    if (chatMutadoPJ) {
                        showToast('üîá', 'Chat silenciado', 'O host silenciou o chat');
                    } else {
                        showToast('üîä', 'Chat liberado', 'O host liberou o chat');
                    }
                }
                break;
                
            case 'expulso':
                // Fui expulso da sala
                showModal({
                    text: 'üö™ <strong>Voc√™ foi removido da sala</strong><br><br>' + (mensagem.motivo || 'O host te expulsou'),
                    confirmText: 'OK',
                    showCancel: false,
                    onConfirm: () => {
                        // Desconectar
                        if (conexaoPJ) {
                            conexaoPJ.close();
                            conexaoPJ = null;
                        }
                        salaConectadaPJ = null;
                        participantesPJ.clear();
                        atualizarStatusConexao('‚ùå Desconectado');
                        atualizarListaParticipantes();
                        atualizarVisibilidadeChat();
                    }
                });
                vibrarPJ('alerta');
                break;
                
            case 'participante_expulso':
                // Algu√©m foi expulso (notifica√ß√£o)
                if (mensagem.peerId) {
                    participantesPJ.delete(mensagem.peerId);
                    statusParticipantesPJ.delete(mensagem.peerId);
                    ordemEntradaPJ = ordemEntradaPJ.filter(p => p !== mensagem.peerId);
                    atualizarListaParticipantes();
                    atualizarPlantasAmigos();
                    showToast('üö™', 'Participante saiu', `${mensagem.nome || 'Algu√©m'} foi removido da sala`);
                }
                break;
                
            case 'novo_host':
                // Novo host foi definido
                hostAtualPJ = mensagem.novoHostId;
                const meuId = peerPJ ? peerPJ.id : null;
                
                if (mensagem.novoHostId === meuId) {
                    // Eu sou o novo host!
                    souHostPJ = true;
                    
                    // Mostrar controles de host
                    const toggleBulldoze = document.getElementById('togglePermissaoBulldozePJ');
                    const toggleChat = document.getElementById('toggleChatMutadoPJ');
                    if (toggleBulldoze) toggleBulldoze.style.display = 'flex';
                    if (toggleChat) toggleChat.style.display = 'flex';
                    
                    showToast('üëë', 'Voc√™ √© o novo host!', 'Voc√™ agora controla a sala');
                    vibrarPJ('sucesso');
                } else {
                    souHostPJ = false;
                    showToast('üëë', 'Novo host', `${mensagem.novoHostNome || 'Algu√©m'} agora √© o host`);
                }
                
                atualizarEstadoChatMutado();
                atualizarListaParticipantes();
                break;
                
            case 'host_saiu':
                // Host saiu, verificar heran√ßa
                verificarHerancaHost(mensagem.hostId);
                break;
                
            case 'ordem_entrada':
                // Receber ordem de entrada atualizada
                ordemEntradaPJ = mensagem.ordem || [];
                break;
                
            case 'aguardando_aprovacao':
                // Host ativou sala de espera, preciso enviar meu nome
                atualizarStatusConexao('üïê Aguardando aprova√ß√£o do host...');
                if (conexaoPJ && conexaoPJ.open) {
                    conexaoPJ.send(JSON.stringify({
                        tipo: 'solicitar_entrada',
                        nome: obterNomeJogador()
                    }));
                }
                break;
                
            case 'entrada_aprovada':
                // Host aprovou minha entrada!
                atualizarStatusConexao('‚úÖ Entrada aprovada!');
                showToast('‚úÖ', 'Aprovado!', 'O host aprovou sua entrada');
                vibrarPJ('sucesso');
                // A partir daqui as mensagens normais ser√£o recebidas
                break;
                
            case 'entrada_rejeitada':
                // Host rejeitou minha entrada
                atualizarStatusConexao('‚ùå Entrada recusada');
                showModal({
                    text: 'üö´ <strong>Entrada recusada</strong><br><br>' + (mensagem.motivo || 'O host n√£o aprovou sua entrada'),
                    confirmText: 'OK',
                    showCancel: false,
                    onConfirm: () => {}
                });
                vibrarPJ('alerta');
                if (conexaoPJ) {
                    conexaoPJ.close();
                    conexaoPJ = null;
                }
                salaConectadaPJ = null;
                break;
                
            case 'config_aprovacao':
                // Host mudou configura√ß√£o de aprova√ß√£o
                aprovarEntradaPJ = mensagem.requerAprovacao === true;
                break;
                
            case 'ping':
                // Responder ping com pong
                enviarMensagemP2P({ tipo: 'pong' }, conn);
                break;
                
            case 'pong':
                // Recebeu pong, conex√£o est√° ok
                console.log('Pong recebido de:', conn.peer);
                break;
                
            case 'verificar_conexao':
                // Host est√° verificando conex√µes, responder
                enviarMensagemP2P({ tipo: 'conexao_ok' }, conn);
                break;
                
            case 'conexao_ok':
                // Resposta de verifica√ß√£o, atualizar status
                if (participantesPJ.has(conn.peer)) {
                    const info = participantesPJ.get(conn.peer);
                    info.statusConexao = 'conectado';
                    participantesPJ.set(conn.peer, info);
                    atualizarListaParticipantes();
                }
                break;
        }
    } catch (e) {
        console.error('Erro ao processar mensagem P2P:', e);
    }
}

// Toggle do widget de conex√£o com anima√ß√£o
function toggleWidgetConexaoPJ() {
    const conteudo = document.getElementById('conteudoWidgetConexao');
    const seta = document.getElementById('setaWidgetConexao');
    
    if (!conteudo || !seta) return;
    
    if (conteudo.style.display === 'none') {
        conteudo.style.display = 'block';
        conteudo.style.opacity = '0';
        conteudo.style.transform = 'translateY(-10px)';
        conteudo.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
        
        // For√ßa reflow para anima√ß√£o funcionar
        conteudo.offsetHeight;
        
        conteudo.style.opacity = '1';
        conteudo.style.transform = 'translateY(0)';
        seta.style.transform = 'rotate(180deg)';
    } else {
        conteudo.style.opacity = '0';
        conteudo.style.transform = 'translateY(-10px)';
        seta.style.transform = 'rotate(0deg)';
        
        setTimeout(() => {
            conteudo.style.display = 'none';
        }, 300);
    }
}

// Atualizar lista visual de participantes
function atualizarListaParticipantes() {
    const participantesContainer = document.getElementById('participantesContainer');
    const contadorEl = document.getElementById('contadorParticipantes');
    const statusIcone = document.getElementById('statusConexaoIcone');
    
    if (!participantesContainer) return;
    
    // Limpar lista
    participantesContainer.innerHTML = '';
    
    // Meu status atual
    const meuStatus = timerPJInterval ? 'focando' : 'online';
    const meuTempoFocando = timerPJInterval && tempoPJRestante > 0 
        ? `Focando h√° ${Math.floor((parseInt(document.getElementById('tempoPlantarJuntos')?.value || 25) * 60 - tempoPJRestante) / 60)}min` 
        : '';
    
    // Adicionar EU primeiro (estilo compacto)
    const euItem = document.createElement('div');
    euItem.style.cssText = 'background: rgba(76, 175, 80, 0.2); padding: 4px 10px; border-radius: 12px; font-size: 12px; display: flex; align-items: center; gap: 4px; border: 1px solid var(--primary); flex-wrap: wrap;';
    euItem.innerHTML = `
        <span>üòä</span>
        <span style="font-weight: bold;">${obterNomeJogador()}</span>
        ${meuStatus === 'focando' ? `<span style="font-size: 9px; background: var(--primary); color: white; padding: 1px 5px; border-radius: 8px; margin-left: auto;">üî• ${meuTempoFocando || 'Focando'}</span>` : ''}
    `;
    participantesContainer.appendChild(euItem);
    
    // Adicionar outros participantes (estilo compacto)
    let totalParticipantes = 1;
    if (participantesPJ.size > 0) {
        participantesPJ.forEach((info, peerId) => {
            const item = document.createElement('div');
            const isInativo = info.inativo === true;
            const statusConexao = info.statusConexao || 'conectado';
            
            // Pegar status ao vivo do participante
            const statusVivo = statusParticipantesPJ.get(peerId);
            
            // Determinar √≠cone e estilo baseado no status
            let icone, corFundo, opacidade, textoStatus, badgeStatus;
            if (isInativo) {
                icone = 'üí§';
                corFundo = 'rgba(158, 158, 158, 0.1)';
                opacidade = '0.5';
                textoStatus = ' (offline)';
                badgeStatus = '';
            } else if (statusConexao === 'reconectando') {
                icone = 'üîÑ';
                corFundo = 'rgba(255, 152, 0, 0.15)';
                opacidade = '0.8';
                textoStatus = ' (reconectando...)';
                badgeStatus = '';
            } else if (statusConexao === 'sem_resposta') {
                icone = '‚ö†Ô∏è';
                corFundo = 'rgba(244, 67, 54, 0.15)';
                opacidade = '0.7';
                textoStatus = ' (sem conex√£o)';
                badgeStatus = '';
            } else if (statusVivo && statusVivo.status === 'focando') {
                icone = 'üå±';
                corFundo = 'rgba(76, 175, 80, 0.15)';
                opacidade = '1';
                textoStatus = '';
                const tempoStr = formatarTempoDecorrido(statusVivo.tempoInicio);
                badgeStatus = `<span style="font-size: 9px; background: var(--primary); color: white; padding: 1px 5px; border-radius: 8px; margin-left: auto;">üî• Focando ${tempoStr}</span>`;
            } else if (statusVivo && statusVivo.status === 'voltou') {
                icone = 'üëã';
                corFundo = 'rgba(33, 150, 243, 0.1)';
                opacidade = '1';
                textoStatus = '';
                badgeStatus = `<span style="font-size: 9px; background: #2196f3; color: white; padding: 1px 5px; border-radius: 8px; margin-left: auto;">Voltou!</span>`;
            } else {
                icone = 'üå±';
                corFundo = 'rgba(76, 175, 80, 0.1)';
                opacidade = '1';
                textoStatus = '';
                badgeStatus = '';
            }
            
            item.style.cssText = `background: ${corFundo}; padding: 4px 10px; border-radius: 12px; font-size: 12px; display: flex; align-items: center; gap: 4px; opacity: ${opacidade}; transition: all 0.3s; flex-wrap: wrap;`;
            
            // Bot√µes de a√ß√£o do host (expulsar e transferir)
            let botoesHost = '';
            if (souHostPJ && !isInativo) {
                botoesHost = `
                    <div style="display: flex; gap: 4px; margin-left: auto;">
                        <button onclick="event.stopPropagation(); transferirHostPJ('${peerId}')" style="background: #9c27b0; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center;" title="Transferir host">üëë</button>
                        <button onclick="event.stopPropagation(); expulsarParticipantePJ('${peerId}')" style="background: #f44336; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center;" title="Expulsar">üö™</button>
                    </div>
                `;
            }
            
            item.innerHTML = `<span>${icone}</span><span>${info.nome}${textoStatus}</span>${badgeStatus}${botoesHost}`;
            participantesContainer.appendChild(item);
            totalParticipantes++;
        });
    }
    
    // Atualizar contador
    if (contadorEl) {
        contadorEl.textContent = totalParticipantes;
    }
    
    // Atualizar √≠cone de status
    if (statusIcone) {
        if (participantesPJ.size > 0) {
            statusIcone.innerHTML = '<span style="color: #4caf50;">üü¢ Conectado</span>';
        } else if (conexaoPJ && conexaoPJ.open) {
            statusIcone.innerHTML = '<span style="color: #ff9800;">üü° Aguardando</span>';
        } else if (peerPJ && !peerPJ.destroyed) {
            statusIcone.innerHTML = '<span style="color: #2196f3;">üîµ Pronto</span>';
        } else {
            statusIcone.innerHTML = '<span style="color: #888;">‚ö™ Offline</span>';
        }
    }
    
    // Chat sempre vis√≠vel
    
    // Atualizar tamb√©m a visualiza√ß√£o das plantas dos amigos
    if (typeof atualizarPlantasAmigos === 'function') {
        atualizarPlantasAmigos();
    }
}

// Fun√ß√£o para alternar entre as abas do Plantar Juntos
function trocarAbaPJ(aba) {
    // Esconder todas as se√ß√µes
    document.getElementById('secaoJardimPJ').style.display = 'none';
    document.getElementById('secaoConexaoPJ').style.display = 'none';
    document.getElementById('secaoChatPJ').style.display = 'none';
    
    // Resetar estilos dos bot√µes
    document.getElementById('btnTabJardim').classList.remove('tab-active');
    document.getElementById('btnTabConexao').classList.remove('tab-active');
    document.getElementById('btnTabChat').classList.remove('tab-active');
    
    document.getElementById('btnTabJardim').style.background = 'rgba(76, 175, 80, 0.2)';
    document.getElementById('btnTabJardim').style.color = 'var(--text-main)';
    document.getElementById('btnTabJardim').style.border = '2px solid rgba(76, 175, 80, 0.3)';
    
    document.getElementById('btnTabConexao').style.background = 'rgba(76, 175, 80, 0.2)';
    document.getElementById('btnTabConexao').style.color = 'var(--text-main)';
    document.getElementById('btnTabConexao').style.border = '2px solid rgba(76, 175, 80, 0.3)';
    
    document.getElementById('btnTabChat').style.background = 'rgba(76, 175, 80, 0.2)';
    document.getElementById('btnTabChat').style.color = 'var(--text-main)';
    document.getElementById('btnTabChat').style.border = '2px solid rgba(76, 175, 80, 0.3)';
    
    // Mostrar a aba selecionada
    if (aba === 'jardim') {
        document.getElementById('secaoJardimPJ').style.display = 'block';
        document.getElementById('btnTabJardim').classList.add('tab-active');
        document.getElementById('btnTabJardim').style.background = 'var(--primary)';
        document.getElementById('btnTabJardim').style.color = 'white';
        document.getElementById('btnTabJardim').style.border = '2px solid var(--primary)';
    } else if (aba === 'conexao') {
        document.getElementById('secaoConexaoPJ').style.display = 'block';
        document.getElementById('btnTabConexao').classList.add('tab-active');
        document.getElementById('btnTabConexao').style.background = 'var(--primary)';
        document.getElementById('btnTabConexao').style.color = 'white';
        document.getElementById('btnTabConexao').style.border = '2px solid var(--primary)';
    } else if (aba === 'chat') {
        document.getElementById('secaoChatPJ').style.display = 'block';
        document.getElementById('btnTabChat').classList.add('tab-active');
        document.getElementById('btnTabChat').style.background = 'var(--primary)';
        document.getElementById('btnTabChat').style.color = 'white';
        document.getElementById('btnTabChat').style.border = '2px solid var(--primary)';
        
        // Esconder notifica√ß√£o do chat
        const notification = document.getElementById('chatTabNotification');
        if (notification) notification.style.display = 'none';
        
        // Limpar badge interno do chat
        const badge = document.getElementById('chatBadgePJ');
        if (badge) {
            badge.style.display = 'none';
            badge.textContent = '0';
        }
        
        // Scroll para √∫ltima mensagem
        const container = document.getElementById('chatMensagensPJ');
        if (container) {
            container.scrollTop = container.scrollHeight;
        }
    }
}

// Atualizar status da conex√£o
function atualizarStatusConexao(texto) {
    const status = document.getElementById('statusConexaoPJ');
    if (status) {
        status.innerHTML = `<span style="color: var(--primary);">${texto}</span>`;
    }
}

// Copiar c√≥digo para clipboard
function copiarCodigoSala() {
    const codigo = codigoSalaPJ;
    if (!codigo || codigo === '----') return;
    
    navigator.clipboard.writeText(codigo).then(() => {
        showToast('üìã', 'C√≥digo copiado!', `C√≥digo ${codigo} copiado para a √°rea de transfer√™ncia`);
        
        const el = document.getElementById('codigoSalaPJ');
        if (el) {
            el.style.transform = 'scale(1.1)';
            el.style.background = 'rgba(76, 175, 80, 0.3)';
            setTimeout(() => {
                el.style.transform = 'scale(1)';
                el.style.background = 'rgba(255,255,255,0.9)';
            }, 200);
        }
    }).catch(() => {
        showToast('‚ö†Ô∏è', 'Erro', 'N√£o foi poss√≠vel copiar o c√≥digo');
    });
}

// Gerar novo c√≥digo de sala
function gerarNovoCodigo() {
    console.log('Gerando novo c√≥digo...');
    
    // Abrir o modal de confirma√ß√£o customizado em vez do confirm nativo
    abrirModal('confirmacaoResetCodigoOverlay');
}

// Gerar c√≥digo e mostrar a se√ß√£o (primeira vez)
function gerarEMostrarCodigo() {
    // Gerar c√≥digo se n√£o existir
    if (!codigoSalaPJ || codigoSalaPJ === '----') {
        codigoSalaPJ = gerarCodigoSala();
        inicializarPeerPJ(codigoSalaPJ);
    }
    
    // Eu sou o host da sala
    souHostPJ = true;
    
    // Atualizar display
    const displayCodigo = document.getElementById('codigoSalaPJ');
    if (displayCodigo) {
        displayCodigo.textContent = codigoSalaPJ;
    }
    
    // Mostrar se√ß√£o do c√≥digo e ocultar bot√£o de criar
    const secaoCodigo = document.getElementById('secaoCodigoSalaPJ');
    const btnGerar = document.getElementById('btnGerarCodigoContainer');
    
    if (secaoCodigo) secaoCodigo.style.display = 'block';
    if (btnGerar) btnGerar.style.display = 'none';
    
    // Mostrar toggles de permiss√µes (s√≥ para host)
    const toggleBulldoze = document.getElementById('togglePermissaoBulldozePJ');
    const toggleChat = document.getElementById('toggleChatMutadoPJ');
    const toggleAprovar = document.getElementById('toggleAprovarEntradaPJ');
    if (toggleBulldoze) toggleBulldoze.style.display = 'flex';
    if (toggleChat) toggleChat.style.display = 'flex';
    if (toggleAprovar) toggleAprovar.style.display = 'flex';
    
    // Definir meu peerId como host atual
    hostAtualPJ = peerPJ ? peerPJ.id : null;
    
    // Limpar o grid para nova sala (come√ßa vazio)
    plantarJuntosData = new Array(25).fill(null);
    StorageSeguro.set('plantarJuntosData', plantarJuntosData);
    renderGridPlantarJuntos();
    
    showToast('üè†', 'Sala Criada!', `C√≥digo: ${codigoSalaPJ} - Compartilhe com amigos!`);
    
    // Copiar automaticamente
    copiarCodigoSala();
}

// Executar o reset real do c√≥digo ap√≥s confirma√ß√£o no modal
function fecharEGerarNovoCodigo() {
    fecharModal('confirmacaoResetCodigoOverlay');
    
    // Limpar timer de reconex√£o
    if (intervalReconexaoPJ) {
        clearInterval(intervalReconexaoPJ);
        intervalReconexaoPJ = null;
    }
    
    // Desconectar todos
    try {
        if (conexaoPJ) {
            conexaoPJ.close();
            conexaoPJ = null;
        }
        
        if (Array.isArray(conectadosAoMeuPeer)) {
            conectadosAoMeuPeer.forEach(conn => {
                if (conn && conn.close) conn.close();
            });
        }
        conectadosAoMeuPeer = [];
        
        if (participantesPJ instanceof Map) participantesPJ.clear();
        // Sistema de progress√£o e previews desabilitados; n√£o h√° limpeza necess√°ria.
        
        // Destruir peer atual
        if (peerPJ) {
            peerPJ.destroy();
            peerPJ = null;
        }
    } catch (err) {
        console.error('Erro ao limpar conex√µes:', err);
    }
    
    // Gerar novo c√≥digo e reinicializar
    codigoSalaPJ = gerarCodigoSala();
    inicializarPeerPJ(codigoSalaPJ);
    
    // Atualizar display
    const displayCodigo = document.getElementById('codigoSalaPJ');
    if (displayCodigo) {
        displayCodigo.textContent = codigoSalaPJ;
    }
    
    salaConectadaPJ = null;
    
    // Limpar o grid para nova sala (come√ßa vazio)
    plantarJuntosData = new Array(25).fill(null);
    StorageSeguro.set('plantarJuntosData', plantarJuntosData);
    
    atualizarListaParticipantes();
    renderGridPlantarJuntos();
    iniciarReconexaoAutomatica();
    
    showToast('üîÑ', 'Novo C√≥digo!', `Voc√™ criou uma nova sala: ${codigoSalaPJ}`);
}

// Conectar a uma sala
function conectarSalaPJ(codigoTentado = null) {
    const input = document.getElementById('inputCodigoAmigo');
    const codigo = codigoTentado || input.value.trim().toUpperCase();
    
    if (!codigo || codigo.length !== 4) {
        atualizarStatusConexao('‚ùå Digite um c√≥digo de 4 caracteres');
        return;
    }
    
    if (codigo === codigoSalaPJ) {
        atualizarStatusConexao('‚ö†Ô∏è Este √© o seu pr√≥prio c√≥digo!');
        return;
    }

    if (typeof Peer === 'undefined') {
        console.error('PeerJS n√£o carregado!');
        atualizarStatusConexao('‚ùå Biblioteca PeerJS n√£o carregada');
        showToast('‚ùå', 'Erro', 'Biblioteca PeerJS n√£o est√° dispon√≠vel. Verifique sua conex√£o com a internet.');
        return;
    }
    
    // Se n√£o houver peer local, inicializar um tempor√°rio (convidado)
    if (!peerPJ) {
        atualizarStatusConexao('üîÑ Iniciando conex√£o local...');
        peerPJ = new Peer(undefined, {
            debug: 0,
            config: {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:global.stun.twilio.com:3478' }
                ]
            }
        });

        peerPJ.on('open', (id) => {
            console.log('Peer local criado:', id);
            // Ap√≥s criar o peer local, tentar conectar de novo
            conectarSalaPJ();
        });

        peerPJ.on('error', (err) => {
            console.error('Erro ao inicializar peer local:', err);
            atualizarStatusConexao('‚ùå Erro ao inicializar conex√£o local');
            showToast('‚ùå', 'Erro', 'N√£o foi poss√≠vel inicializar a conex√£o local. Verifique sua internet.');
            peerPJ = null;
        });

        return;
    }
    
    // Conectar ao peer do amigo
    atualizarStatusConexao('üîÑ Conectando...');
    
    // Fechar conex√£o anterior se existir e estiver aberta
    if (conexaoPJ && conexaoPJ.open) {
        try { conexaoPJ.close(); } catch(e) { console.warn('Erro fechando conex√£o anterior:', e); }
    }

    conexaoPJ = peerPJ.connect('PJ-' + codigo, {
        reliable: true
    });
    
    conexaoPJ.on('open', () => {
        salaConectadaPJ = codigo;
        souHostPJ = false; // Eu sou convidado, n√£o host
        permissaoBulldozePJ = false; // Reseta at√© receber do host
        atualizarStatusConexao(`‚úÖ Conectado √† sala ${codigo}`);
        atualizarBotaoReconectar();
        showToast('ü§ù', 'Conectado!', `Voc√™ est√° agora na sala ${codigo}`);
        
        // Resetar contador de retry em sucesso
        conexaoPJ.retryCount = 0;
        
        // Enviar minha apresenta√ß√£o
        enviarMensagemP2P({
            tipo: 'apresentacao',
            nome: obterNomeJogador(),
            peerId: peerPJ.id,
            planta: plantaPJSelecionada,
            tempoFocado: tempoTotalFocoPJHoje
        }, conexaoPJ);
        
        // Configurar eventos da conex√£o
        configurarConexao(conexaoPJ);
        input.value = '';
    });
    
    conexaoPJ.on('error', (err) => {
        console.error('Erro na conex√£o:', err);
        const hint = (err && err.type === 'peer-unavailable') ? 'C√≥digo inv√°lido ou sala fechada.' : 'Verifique o c√≥digo (pode ter sido alterado pelo host).';
        atualizarStatusConexao('‚ùå N√£o foi poss√≠vel conectar. ' + hint);
        showToast('‚ùå', 'Erro ao conectar', 'N√£o foi poss√≠vel conectar. ' + hint);
        conexaoPJ = null;
        salaConectadaPJ = null;
        atualizarBotaoReconectar();
        
        // Retry autom√°tico com backoff exponencial
        if (!conexaoPJ.retryCount) conexaoPJ.retryCount = 0;
        conexaoPJ.retryCount++;
        if (conexaoPJ.retryCount <= 3) {
            const delay = 1000 * Math.pow(2, conexaoPJ.retryCount - 1); // 1s, 2s, 4s
            console.log(`Tentando reconectar em ${delay}ms (tentativa ${conexaoPJ.retryCount}/3)`);
            setTimeout(() => conectarSalaPJ(codigo), delay);
        } else {
            showToast('‚ùå', 'Falha na conex√£o', 'N√£o foi poss√≠vel conectar ap√≥s 3 tentativas.');
            conexaoPJ.retryCount = 0;
        }
    });
}

// Desconectar da sala
function desconectarSalaPJ() {
    if (conexaoPJ) {
        conexaoPJ.close();
        conexaoPJ = null;
    }
    
    conectadosAoMeuPeer.forEach(conn => conn.close());
    conectadosAoMeuPeer = [];
    participantesPJ.clear();
    solicitacoesPendentes.clear();
    // Sistema de progress√£o desabilitado; nenhuma a√ß√£o necess√°ria aqui.
    temposParticipantesPJ.clear();
    ordemEntradaPJ = [];
    
    salaConectadaPJ = null;
    atualizarListaParticipantes();
    atualizarStatusConexao('üü¢ Sala aberta - aguardando conex√µes...');
    atualizarBotaoReconectar();
    showToast('üëã', 'Desconectado', 'Voc√™ saiu da sala compartilhada');
}

// Reconex√£o manual para convidado
function reconectarManualPJ() {
    if (!salaConectadaPJ) {
        showToast('‚ö†Ô∏è', 'Sem sala', 'Voc√™ n√£o est√° conectado a nenhuma sala');
        return;
    }
    
    showToast('üîÑ', 'Reconectando...', `Tentando reconectar √† sala ${salaConectadaPJ}`);
    atualizarStatusConexao('üîÑ Reconectando...');
    
    // Fechar conex√£o antiga se existir
    if (conexaoPJ) {
        try { conexaoPJ.close(); } catch(e) {}
    }
    
    // Tentar reconectar
    conexaoPJ = peerPJ.connect('PJ-' + salaConectadaPJ, {
        reliable: true
    });
    
    conexaoPJ.on('open', () => {
        atualizarStatusConexao(`‚úÖ Reconectado √† sala ${salaConectadaPJ}`);
        showToast('üîó', 'Reconectado!', `Conex√£o restabelecida com a sala ${salaConectadaPJ}`);
        
        // Reenviar apresenta√ß√£o
        enviarMensagemP2P({
            tipo: 'apresentacao',
            nome: obterNomeJogador(),
            peerId: peerPJ.id,
            planta: plantaPJSelecionada,
            tempoFocado: tempoTotalFocoPJHoje
        }, conexaoPJ);
        
        configurarConexao(conexaoPJ);
        atualizarListaParticipantes();
    });
    
    conexaoPJ.on('error', (err) => {
        console.error('Erro ao reconectar:', err);
        atualizarStatusConexao('‚ùå Falha na reconex√£o. Tente novamente.');
        showToast('‚ùå', 'Erro', 'N√£o foi poss√≠vel reconectar. Tente novamente.');
    });
}

// Atualizar visibilidade do bot√£o de reconectar
function atualizarBotaoReconectar() {
    const container = document.getElementById('btnReconectarContainer');
    if (!container) return;
    
    // Mostrar bot√£o apenas se estiver conectado a uma sala externa
    container.style.display = salaConectadaPJ ? 'block' : 'none';
}

// Sistema de reconex√£o autom√°tica
function iniciarReconexaoAutomatica() {
    // Limpar intervalo anterior se existir
    if (intervalReconexaoPJ) {
        clearInterval(intervalReconexaoPJ);
    }
    
    // Verificar conex√µes a cada 5 segundos
    intervalReconexaoPJ = setInterval(() => {
        verificarReconexaoPJ();
    }, 5000);
    
    // Iniciar heartbeat
    iniciarHeartbeatPJ();
}

// Sistema de heartbeat para monitorar conex√µes
function iniciarHeartbeatPJ() {
    if (intervalHeartbeatPJ) {
        clearInterval(intervalHeartbeatPJ);
    }
    
    intervalHeartbeatPJ = setInterval(() => {
        enviarHeartbeatPJ();
        verificarHeartbeatsPJ();
    }, HEARTBEAT_INTERVAL);
}

function enviarHeartbeatPJ() {
    // Enviar ping para todas as conex√µes
    const mensagemPing = JSON.stringify({
        tipo: 'heartbeat',
        peerId: peerPJ ? peerPJ.id : null,
        timestamp: Date.now()
    });
    
    // Conex√µes de entrada (quem conectou comigo)
    conectadosAoMeuPeer.forEach(conn => {
        if (conn && conn.open) {
            try {
                conn.send(mensagemPing);
            } catch (e) {
                console.warn('Erro ao enviar heartbeat:', e);
            }
        }
    });
    
    // Conex√£o de sa√≠da (se estou conectado em outra sala)
    if (conexaoPJ && conexaoPJ.open) {
        try {
            conexaoPJ.send(mensagemPing);
        } catch (e) {
            console.warn('Erro ao enviar heartbeat de sa√≠da:', e);
        }
    }
}

function verificarHeartbeatsPJ() {
    const agora = Date.now();
    let mudou = false;
    
    participantesPJ.forEach((info, peerId) => {
        if (info.inativo) return; // Ignorar j√° inativos
        
        const ultimoHeartbeat = info.ultimoHeartbeat || info.conectadoEm || agora;
        const tempoSemResposta = agora - ultimoHeartbeat;
        
        if (tempoSemResposta > HEARTBEAT_TIMEOUT) {
            // Sem resposta por muito tempo
            if (info.statusConexao !== 'sem_resposta') {
                info.statusConexao = 'sem_resposta';
                participantesPJ.set(peerId, info);
                mudou = true;
                console.log(`Participante ${info.nome} sem resposta`);
            }
        } else if (tempoSemResposta > HEARTBEAT_INTERVAL * 1.5) {
            // Poss√≠vel problema de conex√£o
            if (info.statusConexao !== 'reconectando') {
                info.statusConexao = 'reconectando';
                participantesPJ.set(peerId, info);
                mudou = true;
            }
        }
    });
    
    if (mudou) {
        atualizarListaParticipantes();
    }
}

function verificarReconexaoPJ() {
    console.log('Verificando reconex√£o P2P...');
    
    // Verificar se o peer principal est√° OK
    if (!peerPJ || peerPJ.destroyed) {
        console.log('Peer destru√≠do, tentando reinicializar...');
        atualizarStatusConexao('üîÑ Reinicializando peer...');
        if (codigoSalaPJ) {
            inicializarPeerPJ(codigoSalaPJ);
        }
        return;
    }
    
    // Verificar conex√£o de sa√≠da (quando conectei em alguma sala)
    if (salaConectadaPJ && conexaoPJ) {
        if (!conexaoPJ.open) {
            console.log('Conex√£o de sa√≠da fechada, tentando reconectar...');
            atualizarStatusConexao('üîÑ Reconectando...');
            
            // Tentar reconectar
            conexaoPJ = peerPJ.connect('PJ-' + salaConectadaPJ, {
                reliable: true
            });
            
            conexaoPJ.on('open', () => {
                atualizarStatusConexao(`‚úÖ Reconectado √† sala ${salaConectadaPJ}`);
                console.log('Reconectado com sucesso!');
                showToast('üîó', 'Reconectado!', `Conex√£o restabelecida com a sala ${salaConectadaPJ}`);
                
                // Reenviar apresenta√ß√£o
                enviarMensagemP2P({
                    tipo: 'apresentacao',
                    nome: obterNomeJogador(),
                    peerId: peerPJ.id,
                    planta: plantaPJSelecionada,
                    tempoFocado: tempoTotalFocoPJHoje
                }, conexaoPJ);
                
                configurarConexao(conexaoPJ);
                atualizarListaParticipantes();
            });
            
            conexaoPJ.on('error', (err) => {
                console.error('Erro ao reconectar:', err);
                atualizarStatusConexao('‚ùå Falha na reconex√£o. Tentando novamente...');
            });
        } else {
            // Conex√£o est√° ok, enviar ping para verificar
            enviarMensagemP2P({ tipo: 'ping' }, conexaoPJ);
        }
    }
    
    // Verificar conex√µes de entrada (quem conectou na minha sala)
    conectadosAoMeuPeer = conectadosAoMeuPeer.filter(conn => {
        if (!conn.open) {
            console.log('Conex√£o de entrada fechada, removendo:', conn.peer);
            // Remover da lista de participantes
            participantesPJ.delete(conn.peer);
            atualizarListaParticipantes();
            return false; // Remove da lista
        } else {
            // Enviar ping para verificar se ainda responde
            enviarMensagemP2P({ tipo: 'ping' }, conn);
        }
        return true; // Mant√©m na lista
    });
    
    // Se sou host, enviar broadcast para todos verificarem
    if (souHostPJ && conectadosAoMeuPeer.length > 0) {
        conectadosAoMeuPeer.forEach(conn => {
            enviarMensagemP2P({ tipo: 'verificar_conexao' }, conn);
        });
    }
}

function abrirAvisoPlantarJuntos() {
    // Verificar se j√° mostrou o aviso antes
    const jaViuAviso = StorageSeguro.get('avisoPlantarJuntosVisto', false);
    
    if (jaViuAviso) {
        // J√° viu o aviso, abrir direto
        abrirPlantarJuntos();
    } else {
        // Primeira vez, mostrar o aviso
        abrirModal('avisoPlantarJuntosOverlay');
        StorageSeguro.set('avisoPlantarJuntosVisto', true);
    }
}

// Popular tempos do Plantar Juntos com os mesmos do modo offline
function popularTemposPlantarJuntos() {
    const selectTempo = document.getElementById('tempoPlantarJuntos');
    if (!selectTempo) return;
    
    selectTempo.innerHTML = '';
    tempos.sort((a,b) => a - b).forEach(t => {
        const option = document.createElement('option');
        option.value = t;
        option.textContent = t + ' min';
        if (t === 25) option.selected = true; // 25 min como padr√£o
        selectTempo.appendChild(option);
    });
    
    // Se n√£o tiver 25 na lista, selecionar o primeiro
    if (!tempos.includes(25) && tempos.length > 0) {
        selectTempo.value = tempos[0];
    }
}

function abrirPlantarJuntos() {
    console.log('Abrindo Plantar Juntos...');
    try {
        abrirModal('plantarJuntosOverlay');
        
        // Definir aba padr√£o como Jardim
        trocarAbaPJ('jardim');
        
        // Mostrar bot√£o flutuante do timer
        const btnFlutuante = document.getElementById('btnTimerFlutuantePJ');
        if (btnFlutuante) btnFlutuante.style.display = 'flex';
        
        // Popular tempos com os mesmos do modo offline
        popularTemposPlantarJuntos();
        
        // Verificar se j√° tem c√≥digo gerado para mostrar/ocultar se√ß√µes
        const secaoCodigo = document.getElementById('secaoCodigoSalaPJ');
        const btnGerar = document.getElementById('btnGerarCodigoContainer');
        
        if (codigoSalaPJ && codigoSalaPJ !== '----') {
            // J√° tem c√≥digo, mostrar se√ß√£o
            if (secaoCodigo) secaoCodigo.style.display = 'block';
            if (btnGerar) btnGerar.style.display = 'none';
            
            // Atualizar display do c√≥digo
            const displayCodigo = document.getElementById('codigoSalaPJ');
            if (displayCodigo) {
                displayCodigo.textContent = codigoSalaPJ;
            }
        } else {
            // N√£o tem c√≥digo, mostrar bot√£o de criar
            if (secaoCodigo) secaoCodigo.style.display = 'none';
            if (btnGerar) btnGerar.style.display = 'block';
        }
        
        // Atualizar status de conex√£o se estiver conectado
        const status = document.getElementById('statusConexaoPJ');
        if (status && salaConectadaPJ) {
            status.innerHTML = `<span style="color: var(--primary);">‚úÖ Conectado √† sala ${salaConectadaPJ}</span>`;
        }
        
        // Iniciar sistema de reconex√£o autom√°tica apenas se j√° tiver c√≥digo
        if (codigoSalaPJ && typeof iniciarReconexaoAutomatica === 'function') {
            iniciarReconexaoAutomatica();
        }
        
        // Manter tela ativa enquanto estiver no Plantar Juntos
        if (typeof gerenciarTelaAtiva === 'function') {
            gerenciarTelaAtiva(true);
        }
        
        if (typeof inicializarGridPlantarJuntos === 'function') inicializarGridPlantarJuntos();
        if (typeof renderGridPlantarJuntos === 'function') renderGridPlantarJuntos();
        if (typeof atualizarPlantaPJSelecionada === 'function') atualizarPlantaPJSelecionada();
        if (typeof atualizarTimerPJDisplay === 'function') atualizarTimerPJDisplay();
        if (typeof atualizarListaParticipantes === 'function') atualizarListaParticipantes();
        if (typeof carregarTempoTotalPJ === 'function') carregarTempoTotalPJ();
        
        console.log('Plantar Juntos aberto com sucesso.');
    } catch (err) {
        console.error('Erro ao abrir Plantar Juntos:', err);
        alert('Erro ao abrir o sistema Plantar Juntos. Verifique o console.');
    }
}

function inicializarGridPlantarJuntos() {
    // Carregar dados salvos ou criar novo array
    plantarJuntosData = StorageSeguro.get('plantarJuntosData', []);
    if (plantarJuntosData.length === 0) {
        plantarJuntosData = new Array(25).fill(null);
        StorageSeguro.set('plantarJuntosData', plantarJuntosData);
    }
}

function renderGridPlantarJuntos() {
    const grid = document.getElementById('gridPlantarJuntos3D');
    if (!grid) return;
    
    grid.innerHTML = '';
    
    // Helper para criar elemento de sprite/emoji no grid 3D
    function criarSpriteNoGrid(planta) {
        const container = document.createElement('div');
        container.className = 'emoji-3d';
        container.style.fontSize = '30px';
        container.style.position = 'absolute';
        container.style.left = '50%';
        container.style.top = '30%';
        container.style.transform = 'translate(-50%, -60%) rotateZ(-45deg) rotateX(-90deg)';
        container.style.pointerEvents = 'none';
        container.style.zIndex = '10';
        container.style.width = '40px';
        container.style.height = '40px';
        container.style.display = 'flex';
        container.style.alignItems = 'center';
        container.style.justifyContent = 'center';
        
        // Verificar tipo de planta e renderizar corretamente
        const arvoresEspeciais = ['arvore-rosa','arvore-roxa','arvore-amarela','arvore-branca','arvore-colmeia','arvore-frutifera'];
        const tamanho = '36px';
        
        if (arvoresEspeciais.includes(planta) && typeof gerarSpriteArvore === 'function') {
            const svgThumb = gerarSpriteArvore(planta);
            container.innerHTML = `<img src="${svgThumb}" alt="${planta}" style="width:${tamanho};height:${tamanho};display:block;">`;
        } else if (planta === 'poste-luz' && typeof gerarSpritePosteLuz === 'function') {
            const svgThumb = gerarSpritePosteLuz(planta);
            container.innerHTML = `<img src="${svgThumb}" alt="${planta}" style="width:${tamanho};height:${tamanho};display:block;">`;
        } else if (planta === 'banco-praca' && typeof gerarSpriteBancoPraca === 'function') {
            const svgThumb = gerarSpriteBancoPraca(planta);
            container.innerHTML = `<img src="${svgThumb}" alt="${planta}" style="width:${tamanho};height:${tamanho};display:block;">`;
        } else if (planta === 'piquenique' && typeof gerarSpritePiquenique === 'function') {
            const svgThumb = gerarSpritePiquenique(planta);
            container.innerHTML = `<img src="${svgThumb}" alt="${planta}" style="width:${tamanho};height:${tamanho};display:block;">`;
        } else if (planta === 'gazebo' && typeof gerarSpriteGazebo === 'function') {
            const svgThumb = gerarSpriteGazebo(planta);
            container.innerHTML = `<img src="${svgThumb}" alt="${planta}" style="width:${tamanho};height:${tamanho};display:block;">`;
        } else if (planta === 'lago' && typeof gerarSpriteLago === 'function') {
            const svgThumb = gerarSpriteLago(planta);
            container.innerHTML = `<img src="${svgThumb}" alt="${planta}" style="width:${tamanho};height:${tamanho};display:block;">`;
        } else if (typeof ehCaminhoEmoji === 'function' && ehCaminhoEmoji(planta)) {
            const imgSrc = gerarTexturaCaminho({norte:false,sul:false,oeste:false,leste:false}, planta);
            container.innerHTML = `<img src="${imgSrc}" alt="${planta}" style="width:${tamanho};height:${tamanho};display:block;">`;
        } else {
            container.textContent = planta;
        }
        
        return container;
    }
    
    // Criar 25 c√©lulas (5x5)
    for (let i = 0; i < 25; i++) {
        const cell = document.createElement('div');
        cell.className = 'cell-3d';
        cell.style.width = '50px';
        cell.style.height = '50px';
        cell.style.backgroundColor = 'var(--grid-color)';
        cell.style.display = 'flex';
        cell.style.alignItems = 'center';
        cell.style.justifyContent = 'center';
        cell.style.cursor = 'pointer';
        cell.style.position = 'relative';
        cell.style.transformStyle = 'preserve-3d';
        cell.dataset.index = i;
        
        // Se √© a c√©lula alvo, destacar
        if (celulaAlvoPJ === i) {
            cell.classList.add('alvo');
        }
        
        // Mostrar planta plantada se existir, ou pr√©-visualiza√ß√£o local da planta selecionada
        if (plantarJuntosData[i]) {
            const spriteElement = criarSpriteNoGrid(plantarJuntosData[i].icone || plantarJuntosData[i].emojiFinal || plantarJuntosData[i].planta, false);
            cell.appendChild(spriteElement);
        } else if (celulaAlvoPJ === i) {
            const spriteElement = criarSpriteNoGrid(plantaPJSelecionada, false);
            cell.appendChild(spriteElement);
        }
        
        cell.onclick = function() {
            selecionarCelulaPJ(i);
        };
        
        grid.appendChild(cell);
    }
}

function selecionarCelulaPJ(index) {
    // Se timer est√° rodando, n√£o permitir sele√ß√£o
    if (timerPJInterval) {
        showToast('‚ö†Ô∏è', 'Aguarde', 'Termine o foco atual primeiro');
        return;
    }
    
    // Sistema de progress√£o desabilitado ‚Äî sele√ß√£o liberada (n√£o h√° bloqueio por foco de amigos)
    
    // Se clicou na mesma c√©lula, remove sele√ß√£o
    if (celulaAlvoPJ === index) {
        enviarMensagemP2P({
            tipo: 'celula_deselecionada',
            index: index,
            nome: obterNomeJogador()
        });
        celulaAlvoPJ = null;
    } else {
        // Se havia outra sele√ß√£o, deselecionar primeiro
        if (celulaAlvoPJ !== null) {
            enviarMensagemP2P({
                tipo: 'celula_deselecionada',
                index: celulaAlvoPJ,
                nome: obterNomeJogador()
            });
        }
        enviarMensagemP2P({
            tipo: 'celula_selecionada',
            index: index,
            planta: plantaPJSelecionada,
            nome: obterNomeJogador()
        });
        celulaAlvoPJ = index;
    }
    
    renderGridPlantarJuntos();
}

function abrirMenuPlantasPJ() {
    const gridPlantas = document.getElementById('gridPlantasPJ');
    if (!gridPlantas) return;
    
    gridPlantas.innerHTML = '';
    
    // Usar ITENS_PADRAO para consist√™ncia com o modo offline
    const plantas = ITENS_PADRAO;
    
    // √Årvores especiais que precisam de sprite SVG
    const arvoresEspeciais = ['arvore-rosa','arvore-roxa','arvore-amarela','arvore-branca','arvore-colmeia','arvore-frutifera'];
    
    plantas.forEach(planta => {
        const item = document.createElement('div');
        item.style.cssText = 'cursor: pointer; padding: 10px; background: rgba(76, 175, 80, 0.1); border-radius: 15px; text-align: center; transition: all 0.2s; display: flex; align-items: center; justify-content: center; min-height: 60px;';
        
        // Renderizar sprite ou emoji conforme o tipo
        if (arvoresEspeciais.includes(planta)) {
            const svgThumb = gerarSpriteArvore(planta);
            item.innerHTML = `<img src="${svgThumb}" alt="${planta}" style="width:48px;height:48px;display:block;">`;
        } else if (planta === 'poste-luz' && typeof gerarSpritePosteLuz === 'function') {
            const svgThumb = gerarSpritePosteLuz(planta);
            item.innerHTML = `<img src="${svgThumb}" alt="${planta}" style="width:48px;height:48px;display:block;">`;
        } else if (planta === 'banco-praca' && typeof gerarSpriteBancoPraca === 'function') {
            const svgThumb = gerarSpriteBancoPraca(planta);
            item.innerHTML = `<img src="${svgThumb}" alt="${planta}" style="width:48px;height:48px;display:block;">`;
        } else if (planta === 'piquenique' && typeof gerarSpritePiquenique === 'function') {
            const svgThumb = gerarSpritePiquenique(planta);
            item.innerHTML = `<img src="${svgThumb}" alt="${planta}" style="width:48px;height:48px;display:block;">`;
        } else if (planta === 'gazebo' && typeof gerarSpriteGazebo === 'function') {
            const svgThumb = gerarSpriteGazebo(planta);
            item.innerHTML = `<img src="${svgThumb}" alt="${planta}" style="width:48px;height:48px;display:block;">`;
        } else if (planta === 'lago' && typeof gerarSpriteLago === 'function') {
            const svgThumb = gerarSpriteLago(planta);
            item.innerHTML = `<img src="${svgThumb}" alt="${planta}" style="width:48px;height:48px;display:block;">`;
        } else if (typeof ehCaminhoEmoji === 'function' && ehCaminhoEmoji(planta)) {
            const imgSrc = gerarTexturaCaminho({norte:false,sul:false,oeste:false,leste:false}, planta);
            item.innerHTML = `<img src="${imgSrc}" alt="${planta}" style="width:48px;height:48px;display:block;">`;
        } else {
            // Emoji padr√£o
            item.style.fontSize = '48px';
            item.textContent = planta;
        }
        
        item.onmouseenter = function() {
            this.style.transform = 'scale(1.1)';
            this.style.background = 'rgba(76, 175, 80, 0.2)';
        };
        item.onmouseleave = function() {
            this.style.transform = 'scale(1)';
            this.style.background = 'rgba(76, 175, 80, 0.1)';
        };
        
        item.onclick = function() {
            plantaPJSelecionada = planta;
            atualizarPlantaPJSelecionada();
            // Sincronizar planta selecionada com peers
            enviarMensagemP2P({
                tipo: 'planta_selecionada',
                planta: planta,
                nome: obterNomeJogador()
            });
            fecharModal('menuPlantasPJOverlay');
            renderGridPlantarJuntos(); // Atualizar preview no grid
        };
        
        gridPlantas.appendChild(item);
    });
    
    abrirModal('menuPlantasPJOverlay');
}

function atualizarPlantaPJSelecionada() {
    const display = document.getElementById('plantaPJSelecionada');
    if (!display) return;
    
    const planta = plantaPJSelecionada;
    const arvoresEspeciais = ['arvore-rosa','arvore-roxa','arvore-amarela','arvore-branca','arvore-colmeia','arvore-frutifera'];
    
    // Renderizar sprite ou emoji conforme o tipo
    if (arvoresEspeciais.includes(planta)) {
        const svgThumb = gerarSpriteArvore(planta);
        display.innerHTML = `<img src="${svgThumb}" alt="${planta}" style="width:48px;height:48px;display:block;">`;
    } else if (planta === 'poste-luz' && typeof gerarSpritePosteLuz === 'function') {
        const svgThumb = gerarSpritePosteLuz(planta);
        display.innerHTML = `<img src="${svgThumb}" alt="${planta}" style="width:48px;height:48px;display:block;">`;
    } else if (planta === 'banco-praca' && typeof gerarSpriteBancoPraca === 'function') {
        const svgThumb = gerarSpriteBancoPraca(planta);
        display.innerHTML = `<img src="${svgThumb}" alt="${planta}" style="width:48px;height:48px;display:block;">`;
    } else if (planta === 'piquenique' && typeof gerarSpritePiquenique === 'function') {
        const svgThumb = gerarSpritePiquenique(planta);
        display.innerHTML = `<img src="${svgThumb}" alt="${planta}" style="width:48px;height:48px;display:block;">`;
    } else if (planta === 'gazebo' && typeof gerarSpriteGazebo === 'function') {
        const svgThumb = gerarSpriteGazebo(planta);
        display.innerHTML = `<img src="${svgThumb}" alt="${planta}" style="width:48px;height:48px;display:block;">`;
    } else if (planta === 'lago' && typeof gerarSpriteLago === 'function') {
        const svgThumb = gerarSpriteLago(planta);
        display.innerHTML = `<img src="${svgThumb}" alt="${planta}" style="width:48px;height:48px;display:block;">`;
    } else if (typeof ehCaminhoEmoji === 'function' && ehCaminhoEmoji(planta)) {
        const imgSrc = gerarTexturaCaminho({norte:false,sul:false,oeste:false,leste:false}, planta);
        display.innerHTML = `<img src="${imgSrc}" alt="${planta}" style="width:48px;height:48px;display:block;">`;
    } else {
        // Emoji padr√£o
        display.textContent = planta;
    }
}

// Renderizar planta em um elemento (helper)
function renderizarPlantaEmElemento(elemento, planta) {
    if (!elemento || !planta) return;
    
    const arvoresEspeciais = ['arvore-rosa','arvore-roxa','arvore-amarela','arvore-branca','arvore-colmeia','arvore-frutifera'];
    const tamanho = '36px';
    
    if (arvoresEspeciais.includes(planta)) {
        const svgThumb = gerarSpriteArvore(planta);
        elemento.innerHTML = `<img src="${svgThumb}" alt="${planta}" style="width:${tamanho};height:${tamanho};display:block;">`;
    } else if (planta === 'poste-luz' && typeof gerarSpritePosteLuz === 'function') {
        const svgThumb = gerarSpritePosteLuz(planta);
        elemento.innerHTML = `<img src="${svgThumb}" alt="${planta}" style="width:${tamanho};height:${tamanho};display:block;">`;
    } else if (planta === 'banco-praca' && typeof gerarSpriteBancoPraca === 'function') {
        const svgThumb = gerarSpriteBancoPraca(planta);
        elemento.innerHTML = `<img src="${svgThumb}" alt="${planta}" style="width:${tamanho};height:${tamanho};display:block;">`;
    } else if (planta === 'piquenique' && typeof gerarSpritePiquenique === 'function') {
        const svgThumb = gerarSpritePiquenique(planta);
        elemento.innerHTML = `<img src="${svgThumb}" alt="${planta}" style="width:${tamanho};height:${tamanho};display:block;">`;
    } else if (planta === 'gazebo' && typeof gerarSpriteGazebo === 'function') {
        const svgThumb = gerarSpriteGazebo(planta);
        elemento.innerHTML = `<img src="${svgThumb}" alt="${planta}" style="width:${tamanho};height:${tamanho};display:block;">`;
    } else if (planta === 'lago' && typeof gerarSpriteLago === 'function') {
        const svgThumb = gerarSpriteLago(planta);
        elemento.innerHTML = `<img src="${svgThumb}" alt="${planta}" style="width:${tamanho};height:${tamanho};display:block;">`;
    } else if (typeof ehCaminhoEmoji === 'function' && ehCaminhoEmoji(planta)) {
        const imgSrc = gerarTexturaCaminho({norte:false,sul:false,oeste:false,leste:false}, planta);
        elemento.innerHTML = `<img src="${imgSrc}" alt="${planta}" style="width:${tamanho};height:${tamanho};display:block;">`;
    } else {
        elemento.textContent = planta;
    }
}

// Atualizar visualiza√ß√£o das plantas dos amigos
let plantasAmigosAnterior = {}; // Cache para evitar re-render desnecess√°rio

function atualizarPlantasAmigos() {
    // Esconder todos os slots primeiro
    for (let i = 1; i <= 4; i++) {
        const slot = document.getElementById(`slotAmigo${i}`);
        if (slot) slot.style.display = 'none';
    }
    
    // Controlar visibilidade do container de amigos
    const amigosContainer = document.getElementById('amigosPlantasContainer');
    const temAmigos = participantesPJ.size > 0;
    if (amigosContainer) {
        amigosContainer.style.display = temAmigos ? 'flex' : 'none';
    }
    
    // Mostrar slots conforme amigos conectados
    let slotIndex = 1;
    participantesPJ.forEach((info, peerId) => {
        if (slotIndex > 4) return; // M√°ximo 4 amigos
        
        const slot = document.getElementById(`slotAmigo${slotIndex}`);
        const plantaEl = document.getElementById(`plantaAmigo${slotIndex}`);
        const nomeEl = document.getElementById(`nomeAmigo${slotIndex}`);
        
        if (slot && plantaEl && nomeEl) {
            slot.style.display = 'block';
            
            // Aplicar opacidade se inativo
            const isInativo = info.inativo === true;
            slot.style.opacity = isInativo ? '0.5' : '1';
            slot.style.transition = 'opacity 0.3s';
            
            const novoNome = (info.nome || 'Amigo') + (isInativo ? ' üí§' : '');
            if (nomeEl.textContent !== novoNome) {
                nomeEl.textContent = novoNome;
            }
            
            const planta = info.plantaSelecionada || 'üå±';
            const cacheKey = `${slotIndex}_${peerId}`;
            
            // S√≥ re-renderiza se a planta mudou
            if (plantasAmigosAnterior[cacheKey] !== planta) {
                plantasAmigosAnterior[cacheKey] = planta;
                renderizarPlantaEmElemento(plantaEl, planta);
            }
        }
        
        slotIndex++;
    });
}

function iniciarTimerPlantarJuntos() {
    // Valida√ß√µes
    if (timerPJInterval) {
        showToast('‚ö†Ô∏è', 'Timer j√° em execu√ß√£o', 'Aguarde o foco atual terminar');
        return;
    }
    
    if (celulaAlvoPJ === null) {
        showToast('‚ö†Ô∏è', 'Selecione uma c√©lula', 'Clique no grid para escolher onde plantar');
        return;
    }
    
    if (plantarJuntosData[celulaAlvoPJ] && plantarJuntosData[celulaAlvoPJ].icone) {
        showToast('‚ö†Ô∏è', 'C√©lula ocupada', 'Escolha uma c√©lula vazia');
        return;
    }
    
    // Sistema de progress√£o desabilitado ‚Äî n√£o h√° bloqueios por foco de amigos
    
    // Obter tempo selecionado
    const tempoMinutos = parseInt(document.getElementById('tempoPlantarJuntos').value);
    tempoPJRestante = tempoMinutos * 60;
    
    // Colocar emoji inicial na c√©lula (progress√£o removida ‚Äî o estado final ser√° aplicado ao concluir)
    plantarJuntosData[celulaAlvoPJ] = { 
        icone: 'üå±', 
        emojiFinal: plantaPJSelecionada
    };
    
    // Ativar modo background global para funcionar minimizado
    iniciarBackgroundMode();
    
    // Iniciar timer no Worker global (funciona em background)
    if (workerGlobal) {
        workerGlobal.postMessage({ comando: 'iniciar_timer', id: 'plantarJuntos', tempo: tempoPJRestante });
    }
    
    // Sincronizar com peers - notificar in√≠cio do foco com a planta escolhida
    enviarMensagemP2P({
        tipo: 'iniciar_foco',
        tempo: tempoMinutos,
        index: celulaAlvoPJ,
        planta: plantaPJSelecionada,
        nome: obterNomeJogador()
    });
    
    // Atualizar UI
    document.getElementById('btnIniciarPlantarJuntos').style.display = 'none';
    document.getElementById('btnPararPlantarJuntos').style.display = 'block';
    
    // Notificar que estou focando
    atualizarMeuStatusPJ('focando');
    atualizarListaParticipantes();
    
    // Iniciar timer principal
    timerPJInterval = setInterval(() => {
        tempoPJRestante--;
        
        if (tempoPJRestante <= 0) {
            finalizarFocoPJ();
        }
        
        atualizarTimerPJDisplay();
    }, 1000);
    
    // Se modo background ativo, sincronizar Worker
    if (mediaSessionAtivoPJ && workerPJ) {
        iniciarWorkerTimerPJ(tempoPJRestante);
    }
    
    renderGridPlantarJuntos();
}

function finalizarFocoPJ() {
    if (timerPJInterval) {
        clearInterval(timerPJInterval);
        timerPJInterval = null;
    }
    
    // Parar Worker tamb√©m
    pararWorkerTimerPJ();
    
    // Plantar a planta final (progress√£o removida)
    const plantaFinal = plantarJuntosData[celulaAlvoPJ] ? {
        icone: plantarJuntosData[celulaAlvoPJ].emojiFinal
    } : null;
    
    if (celulaAlvoPJ !== null && plantaFinal) {
        plantarJuntosData[celulaAlvoPJ] = plantaFinal;
        
        // Sincronizar com peers - enviar planta plantada
        enviarMensagemP2P({
            tipo: 'plantar',
            index: celulaAlvoPJ,
            planta: plantaFinal,
            nome: obterNomeJogador()
        });
        
        enviarMensagemP2P({
            tipo: 'finalizar_foco',
            index: celulaAlvoPJ,
            nome: obterNomeJogador()
        });
    }
    
    // Salvar dados
    StorageSeguro.set('plantarJuntosData', plantarJuntosData);
    
    // Resetar UI
    document.getElementById('btnIniciarPlantarJuntos').style.display = 'block';
    document.getElementById('btnPararPlantarJuntos').style.display = 'none';

    const indexParaLimpar = celulaAlvoPJ;
    celulaAlvoPJ = null;
    tempoPJRestante = 0;
    
    // Parar background mode global
    pararBackgroundMode();
    
    renderGridPlantarJuntos();
    atualizarTimerPJDisplay();
    
    // Notificar que voltei ao online
    atualizarMeuStatusPJ('online');
    atualizarListaParticipantes();
    
    // Feedback
    showToast('‚úÖ', 'Foco Conclu√≠do!', 'Planta cultivada com sucesso! üå±');
    vibrarPJ('sucesso');
    
    // Adicionar tempo focado ao total (pegar do timer original)
    const tempoFocado = parseInt(document.getElementById('tempoPlantarJuntos')?.value || 25);
    adicionarTempoFocoPJ(tempoFocado);
    
    if (typeof efeitosManager !== 'undefined') {
        efeitosManager.chuvaDeEfeitos('üå∏', 10);
    }
}

function cancelarTimerPlantarJuntos() {
    if (!timerPJInterval) return;
    
    showModal({
        text: '‚ö†Ô∏è Deseja realmente cancelar o foco?<br><br>O progresso ser√° perdido.',
        confirmText: 'Sim, cancelar',
        onConfirm: () => {
            if (timerPJInterval) {
                clearInterval(timerPJInterval);
                timerPJInterval = null;
            }
            
            // Parar Worker tamb√©m
            pararWorkerTimerPJ();
            
            // Parar background mode global
            pararBackgroundMode();
            
            // Limpar c√©lula em progresso
            const indexCancelado = celulaAlvoPJ;
            if (celulaAlvoPJ !== null) {
                plantarJuntosData[celulaAlvoPJ] = null;
                
                // Notificar peers sobre o cancelamento
                enviarMensagemP2P({
                    tipo: 'cancelar_foco',
                    index: indexCancelado,
                    nome: obterNomeJogador()
                });
            }
            
            // Resetar UI
            document.getElementById('btnIniciarPlantarJuntos').style.display = 'block';
            document.getElementById('btnPararPlantarJuntos').style.display = 'none';
            
            celulaAlvoPJ = null;
            tempoPJRestante = 0;
            
            const tempoMinutos = parseInt(document.getElementById('tempoPlantarJuntos').value);
            tempoPJRestante = tempoMinutos * 60;
            
            renderGridPlantarJuntos();
            atualizarTimerPJDisplay();
        }
    });
}

// Bulldoze para Plantar Juntos - Limpar todo o jardim compartilhado
function bulldozePJ() {
    // Verificar permiss√£o: Se n√£o sou host e n√£o tenho permiss√£o, bloquear
    if (!souHostPJ && !permissaoBulldozePJ) {
        showToast('üö´', 'Sem permiss√£o', 'Apenas o host pode limpar o jardim');
        return;
    }
    
    // Verificar se h√° algo para limpar
    const temAlgo = plantarJuntosData.some(cell => cell && cell.icone);
    
    if (!temAlgo) {
        showToast('‚ÑπÔ∏è', 'Jardim vazio', 'N√£o h√° nada para limpar');
        return;
    }
    
    showModal({
        text: 'üå™Ô∏è Limpar todo o jardim compartilhado?<br><br>Esta a√ß√£o remove todas as plantas de todos os participantes.',
        confirmText: 'Sim, limpar tudo',
        onConfirm: () => {
            // Animar tornado e depois limpar
            animarTornadoPJ().then(() => {
                // Salvar e renderizar
                StorageSeguro.set('plantarJuntosData', plantarJuntosData);
                renderGridPlantarJuntos();
                
                showToast('üå™Ô∏è', 'Jardim limpo!', 'Todas as plantas foram removidas');
            });
        }
    });
}

// Anima√ß√£o do tornado para Plantar Juntos
function animarTornadoPJ() {
    return new Promise((resolve) => {
        const grid = document.getElementById('gridPlantarJuntos3D');
        if (!grid) {
            resolve();
            return;
        }
        
        const cells = grid.querySelectorAll('.cell-3d');
        const indicesComPlanta = [];
        
        // Encontrar c√©lulas com plantas
        for (let i = 0; i < 25; i++) {
            if (plantarJuntosData[i] && plantarJuntosData[i].icone) {
                indicesComPlanta.push(i);
            }
        }
        
        if (indicesComPlanta.length === 0) {
            resolve();
            return;
        }
        
        let processados = 0;
        const delay = 80; // ms entre cada tornado
        
        function mostrarTornadoPJNoIndice(idx) {
            const cell = cells[idx];
            if (!cell) return;
            
            // Adicionar tornado
            const tornado = document.createElement('span');
            tornado.className = 'tornado-3d';
            tornado.textContent = 'üå™Ô∏è';
            tornado.style.position = 'absolute';
            tornado.style.fontSize = '28px';
            tornado.style.zIndex = '100';
            tornado.style.left = '50%';
            tornado.style.top = '50%';
            tornado.style.transform = 'translate(-50%, -50%) rotateZ(-45deg) rotateX(-90deg)';
            cell.appendChild(tornado);
            
            // Limpar c√©lula
            plantarJuntosData[idx] = null;
            
            // Notificar peers
            enviarMensagemP2P({
                tipo: 'limpar_celula',
                index: idx
            });
            
            // Remover tornado ap√≥s anima√ß√£o
            setTimeout(() => {
                if (cell.contains(tornado)) {
                    cell.removeChild(tornado);
                }
                
                // Remover sprite da c√©lula
                const sprite = cell.querySelector('.emoji-3d');
                if (sprite) cell.removeChild(sprite);
                
                processados++;
                if (processados >= indicesComPlanta.length) {
                    resolve();
                }
            }, 500);
        }
        
        // Animar em sequ√™ncia
        indicesComPlanta.forEach((idx, i) => {
            setTimeout(() => mostrarTornadoPJNoIndice(idx), i * delay);
        });
    });
}

// =====================================
// SISTEMA PIP - PLANTAR JUNTOS
// =====================================

let mediaSessionAtivoPJ = false;
let audioContextPJ = null;
let oscillatorPJ = null;

async function togglePipPJ() {
    // Verificar se √© mobile
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    
    if (isMobile) {
        // Mobile: usar Media Session API
        toggleMediaSessionPJ();
        return;
    }
    
    // Desktop: tentar Document PIP
    if (!('documentPictureInPicture' in window)) {
        // Fallback para Media Session no desktop tamb√©m
        toggleMediaSessionPJ();
        return;
    }
    
    // Se j√° est√° aberto, fechar
    if (pipWindowPJ && !pipWindowPJ.closed) {
        pipWindowPJ.close();
        pipWindowPJ = null;
        if (intervalPipUpdatePJ) {
            clearInterval(intervalPipUpdatePJ);
            intervalPipUpdatePJ = null;
        }
        atualizarBotaoPipPJ();
        return;
    }
    
    try {
        // Abrir janela PIP
        pipWindowPJ = await documentPictureInPicture.requestWindow({
            width: 300,
            height: 200
        });
        
        // Criar conte√∫do do PIP
        const pipDoc = pipWindowPJ.document;
        
        // Estilos
        const style = pipDoc.createElement('style');
        style.textContent = `
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                background: linear-gradient(135deg, #1a2a1a 0%, #0d1f0d 100%);
                color: #e8f5e9;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                height: 100vh;
                padding: 15px;
                text-align: center;
            }
            .timer {
                font-size: 48px;
                font-weight: bold;
                color: #4caf50;
                text-shadow: 0 0 20px rgba(76, 175, 80, 0.5);
                margin-bottom: 10px;
            }
            .planta {
                font-size: 40px;
                margin-bottom: 10px;
            }
            .info {
                font-size: 12px;
                opacity: 0.8;
                display: flex;
                gap: 15px;
                justify-content: center;
            }
            .status {
                display: flex;
                align-items: center;
                gap: 5px;
            }
            .badge {
                background: #4caf50;
                color: white;
                padding: 2px 8px;
                border-radius: 10px;
                font-size: 11px;
            }
            .titulo {
                font-size: 11px;
                opacity: 0.6;
                margin-bottom: 8px;
                letter-spacing: 1px;
            }
        `;
        pipDoc.head.appendChild(style);
        
        // Conte√∫do
        pipDoc.body.innerHTML = `
            <div class="titulo">üå± PLANTAR JUNTOS</div>
            <div class="planta" id="pipPlanta">üå±</div>
            <div class="timer" id="pipTimer">00:00</div>
            <div class="info">
                <div class="status">üë• <span id="pipAmigos">0</span></div>
                <div class="status">üìç <span id="pipSala">${codigoSalaPJ || '----'}</span></div>
            </div>
        `;
        
        // Atualizar imediatamente
        atualizarPipPJ();
        
        // Iniciar atualiza√ß√£o peri√≥dica
        intervalPipUpdatePJ = setInterval(atualizarPipPJ, 1000);
        
        // Limpar ao fechar
        pipWindowPJ.addEventListener('pagehide', () => {
            if (intervalPipUpdatePJ) {
                clearInterval(intervalPipUpdatePJ);
                intervalPipUpdatePJ = null;
            }
            pipWindowPJ = null;
            atualizarBotaoPipPJ();
        });
        
        atualizarBotaoPipPJ();
        showToast('üì∫', 'PIP Ativado', 'Janela flutuante criada!');
        
    } catch (err) {
        console.error('Erro ao abrir PIP:', err);
        // Fallback para Media Session
        toggleMediaSessionPJ();
    }
}

// Media Session API - Funciona em mobile para mostrar na tela de bloqueio
function toggleMediaSessionPJ() {
    if (mediaSessionAtivoPJ) {
        pararMediaSessionPJ();
        showToast('üì∫', 'Desativado', 'Timer removido da tela de bloqueio');
    } else {
        iniciarMediaSessionPJ();
        showToast('üì∫', 'Ativado!', 'Timer aparecer√° na tela de bloqueio');
    }
}

function iniciarMediaSessionPJ() {
    if (!('mediaSession' in navigator)) {
        showToast('‚ö†Ô∏è', 'N√£o suportado', 'Media Session n√£o dispon√≠vel');
        return;
    }
    
    try {
        // Criar contexto de √°udio silencioso para ativar media session
        audioContextPJ = new (window.AudioContext || window.webkitAudioContext)();
        
        // Criar um oscilador com ganho zero (silencioso)
        oscillatorPJ = audioContextPJ.createOscillator();
        const gainNode = audioContextPJ.createGain();
        gainNode.gain.value = 0.001; // Quase silencioso
        oscillatorPJ.connect(gainNode);
        gainNode.connect(audioContextPJ.destination);
        oscillatorPJ.start();
        
        mediaSessionAtivoPJ = true;
        atualizarMediaSessionPJ();
        
        // Iniciar Web Worker para manter timer e heartbeat em background
        criarWorkerBackgroundPJ();
        iniciarWorkerHeartbeatPJ();
        
        // Se timer j√° est√° rodando, sincronizar com Worker
        if (timerPJInterval && tempoPJRestante > 0) {
            iniciarWorkerTimerPJ(tempoPJRestante);
        }
        
        // Configurar handlers
        navigator.mediaSession.setActionHandler('play', () => {
            if (!timerPJInterval) iniciarTimerPlantarJuntos();
        });
        navigator.mediaSession.setActionHandler('pause', () => {
            if (timerPJInterval) cancelarTimerPlantarJuntos();
        });
        
        // Atualizar periodicamente
        if (!intervalPipUpdatePJ) {
            intervalPipUpdatePJ = setInterval(atualizarMediaSessionPJ, 1000);
        }
        
        atualizarBotaoPipPJ();
        
    } catch (err) {
        console.error('Erro ao iniciar Media Session:', err);
        showToast('‚ö†Ô∏è', 'Erro', 'N√£o foi poss√≠vel ativar');
    }
}

function atualizarMediaSessionPJ() {
    if (!('mediaSession' in navigator) || !mediaSessionAtivoPJ) return;
    
    let timerText = '00:00';
    if (timerPJInterval && tempoPJRestante > 0) {
        const minutos = Math.floor(tempoPJRestante / 60);
        const segundos = tempoPJRestante % 60;
        timerText = `${String(minutos).padStart(2, '0')}:${String(segundos).padStart(2, '0')}`;
    } else {
        const tempoMinutos = parseInt(document.getElementById('tempoPlantarJuntos')?.value || 25);
        timerText = `${String(tempoMinutos).padStart(2, '0')}:00`;
    }
    
    const totalAmigos = Array.from(participantesPJ.values()).filter(p => !p.inativo && p.statusConexao === 'conectado').length;
    const sala = salaConectadaPJ || codigoSalaPJ || '----';
    
    navigator.mediaSession.metadata = new MediaMetadata({
        title: `‚è±Ô∏è ${timerText}`,
        artist: `üå± Plantar Juntos`,
        album: `üë• ${totalAmigos} amigos ‚Ä¢ üìç ${sala}`,
        artwork: [
            { src: 'icons/icon-192x192.png', sizes: '192x192', type: 'image/png' },
            { src: 'icons/icon-512x512.png', sizes: '512x512', type: 'image/png' }
        ]
    });
    
    navigator.mediaSession.playbackState = timerPJInterval ? 'playing' : 'paused';
}

function pararMediaSessionPJ() {
    mediaSessionAtivoPJ = false;
    
    if (oscillatorPJ) {
        try { oscillatorPJ.stop(); } catch(e) {}
        oscillatorPJ = null;
    }
    
    if (audioContextPJ) {
        try { audioContextPJ.close(); } catch(e) {}
        audioContextPJ = null;
    }
    
    if (intervalPipUpdatePJ) {
        clearInterval(intervalPipUpdatePJ);
        intervalPipUpdatePJ = null;
    }
    
    // Parar Web Worker tamb√©m
    pararWorkerBackgroundPJ();
    
    atualizarBotaoPipPJ();
}

// =====================================
// WEB WORKER PARA BACKGROUND - PLANTAR JUNTOS
// =====================================

function criarWorkerBackgroundPJ() {
    if (workerPJ) return; // J√° existe
    
    // Criar Web Worker inline usando Blob
    const workerCode = `
        let timerInterval = null;
        let heartbeatInterval = null;
        let tempoRestante = 0;
        
        self.onmessage = function(e) {
            const { tipo, dados } = e.data;
            
            switch(tipo) {
                case 'iniciar_timer':
                    tempoRestante = dados.tempo;
                    if (timerInterval) clearInterval(timerInterval);
                    timerInterval = setInterval(() => {
                        if (tempoRestante > 0) {
                            tempoRestante--;
                            self.postMessage({ tipo: 'tick', tempo: tempoRestante });
                        } else {
                            clearInterval(timerInterval);
                            timerInterval = null;
                            self.postMessage({ tipo: 'timer_completo' });
                        }
                    }, 1000);
                    break;
                    
                case 'parar_timer':
                    if (timerInterval) {
                        clearInterval(timerInterval);
                        timerInterval = null;
                    }
                    tempoRestante = 0;
                    break;
                    
                case 'iniciar_heartbeat':
                    if (heartbeatInterval) clearInterval(heartbeatInterval);
                    heartbeatInterval = setInterval(() => {
                        self.postMessage({ tipo: 'heartbeat' });
                    }, dados.intervalo || 3000);
                    break;
                    
                case 'parar_heartbeat':
                    if (heartbeatInterval) {
                        clearInterval(heartbeatInterval);
                        heartbeatInterval = null;
                    }
                    break;
                    
                case 'parar_tudo':
                    if (timerInterval) clearInterval(timerInterval);
                    if (heartbeatInterval) clearInterval(heartbeatInterval);
                    timerInterval = null;
                    heartbeatInterval = null;
                    tempoRestante = 0;
                    break;
            }
        };
    `;
    
    try {
        const blob = new Blob([workerCode], { type: 'application/javascript' });
        const workerUrl = URL.createObjectURL(blob);
        workerPJ = new Worker(workerUrl);
        
        workerPJ.onmessage = function(e) {
            const { tipo, tempo } = e.data;
            
            switch(tipo) {
                case 'tick':
                    // Atualizar tempo local
                    tempoPJRestante = tempo;
                    atualizarTimerPJDisplay();
                    atualizarPipPJ();
                    break;
                    
                case 'timer_completo':
                    // Timer terminou em background - finalizar
                    finalizarTimerPJComWorker();
                    break;
                    
                case 'heartbeat':
                    // Enviar heartbeats mesmo em background
                    enviarHeartbeatPJ();
                    verificarHeartbeatsPJ();
                    break;
            }
        };
        
        workerPJ.onerror = function(err) {
            console.error('Erro no Worker:', err);
        };
        
        console.log('Worker de background criado com sucesso');
        
    } catch (err) {
        console.error('Erro ao criar Worker:', err);
        workerPJ = null;
    }
}

function iniciarWorkerTimerPJ(tempoSegundos) {
    if (!workerPJ) criarWorkerBackgroundPJ();
    if (!workerPJ) return false;
    
    workerPJ.postMessage({
        tipo: 'iniciar_timer',
        dados: { tempo: tempoSegundos }
    });
    
    return true;
}

function pararWorkerTimerPJ() {
    if (workerPJ) {
        workerPJ.postMessage({ tipo: 'parar_timer', dados: {} });
    }
}

function iniciarWorkerHeartbeatPJ() {
    if (!workerPJ) criarWorkerBackgroundPJ();
    if (!workerPJ) return;
    
    workerPJ.postMessage({
        tipo: 'iniciar_heartbeat',
        dados: { intervalo: HEARTBEAT_INTERVAL }
    });
}

function pararWorkerBackgroundPJ() {
    if (workerPJ) {
        workerPJ.postMessage({ tipo: 'parar_tudo', dados: {} });
    }
}

function finalizarTimerPJComWorker() {
    // Chamada pelo worker quando timer completa
    if (!plantarJuntosData[celulaAlvoPJ]) return;
    
    // Plantar a planta final (progress√£o removida)
    const plantaFinal = { icone: plantarJuntosData[celulaAlvoPJ].emojiFinal };
    plantarJuntosData[celulaAlvoPJ] = plantaFinal;
    
    // Salvar
    StorageSeguro.set('plantarJuntosData', plantarJuntosData);
    
    // Notificar peers sobre planta finalizada e renderizar
    enviarMensagemP2P({
        index: celulaAlvoPJ,
        planta: plantarJuntosData[celulaAlvoPJ],
        nome: obterNomeJogador()
    });
    
    // Limpar
    timerPJInterval = null;
    celulaAlvoPJ = null;
    
    // UI
    document.getElementById('btnIniciarPlantarJuntos').style.display = 'block';
    document.getElementById('btnPararPlantarJuntos').style.display = 'none';
    
    renderGridPlantarJuntos();
    atualizarTimerPJDisplay();
    
    // Notifica√ß√£o
    showToast('üå≥', 'Planta cresceu!', 'Voc√™ completou um foco colaborativo!');
    
    // Vibrar se dispon√≠vel
    if (navigator.vibrate) {
        navigator.vibrate([200, 100, 200]);
    }
}

function atualizarPipPJ() {
    // Atualizar Media Session se ativo
    if (mediaSessionAtivoPJ) {
        atualizarMediaSessionPJ();
    }
    
    // Atualizar janela PIP de desktop
    if (!pipWindowPJ || pipWindowPJ.closed) return;
    
    const pipDoc = pipWindowPJ.document;
    
    // Atualizar timer
    const timerEl = pipDoc.getElementById('pipTimer');
    if (timerEl) {
        if (timerPJInterval && tempoPJRestante > 0) {
            const minutos = Math.floor(tempoPJRestante / 60);
            const segundos = tempoPJRestante % 60;
            timerEl.textContent = `${String(minutos).padStart(2, '0')}:${String(segundos).padStart(2, '0')}`;
            timerEl.style.color = '#4caf50';
        } else {
            const tempoMinutos = parseInt(document.getElementById('tempoPlantarJuntos')?.value || 25);
            timerEl.textContent = `${String(tempoMinutos).padStart(2, '0')}:00`;
            timerEl.style.color = '#81c784';
        }
    }
    
    // Atualizar planta
    const plantaEl = pipDoc.getElementById('pipPlanta');
    if (plantaEl) {
        // Se √© emoji, mostrar direto
        if (!plantaPJSelecionada.includes('-')) {
            plantaEl.textContent = plantaPJSelecionada;
        } else {
            plantaEl.textContent = 'üå≥';
        }
    }
    
    // Atualizar amigos
    const amigosEl = pipDoc.getElementById('pipAmigos');
    if (amigosEl) {
        const totalAtivos = Array.from(participantesPJ.values()).filter(p => !p.inativo && p.statusConexao === 'conectado').length;
        amigosEl.textContent = totalAtivos;
    }
    
    // Atualizar sala
    const salaEl = pipDoc.getElementById('pipSala');
    if (salaEl) {
        salaEl.textContent = salaConectadaPJ || codigoSalaPJ || '----';
    }
}

function atualizarBotaoPipPJ() {
    const btn = document.getElementById('btnPipPJ');
    if (!btn) return;
    
    const ativo = (pipWindowPJ && !pipWindowPJ.closed) || mediaSessionAtivoPJ;
    
    if (ativo) {
        btn.style.background = '#4caf50';
        btn.title = 'Desativar modo background';
    } else {
        btn.style.background = '#9c27b0';
        btn.title = 'Ativar modo background (PIP/Tela de bloqueio)';
    }
}

function fecharPipPJ() {
    // Fechar janela PIP desktop
    if (pipWindowPJ && !pipWindowPJ.closed) {
        pipWindowPJ.close();
    }
    pipWindowPJ = null;
    
    // Parar Media Session
    pararMediaSessionPJ();
    
    if (intervalPipUpdatePJ) {
        clearInterval(intervalPipUpdatePJ);
        intervalPipUpdatePJ = null;
    }
}

// =====================================
// SISTEMA DE CHAT - PLANTAR JUNTOS
// =====================================

let mensagensChatPJ = [];

// Indicador de digitando
function mostrarIndicadorDigitando(nome) {
    let indicador = document.getElementById('indicadorDigitandoPJ');
    if (!indicador) {
        const container = document.getElementById('chatMensagensPJ');
        if (!container) return;
        
        indicador = document.createElement('div');
        indicador.id = 'indicadorDigitandoPJ';
        indicador.style.cssText = 'padding: 4px 8px; font-size: 10px; color: var(--text-secondary); font-style: italic; display: flex; align-items: center; gap: 4px;';
        container.appendChild(indicador);
    }
    
    indicador.innerHTML = `
        <span>${nome} est√° escrevendo</span>
        <span class="pontos-digitando" style="display: inline-flex; gap: 2px;">
            <span style="animation: pulsar 1s infinite 0s;">.</span>
            <span style="animation: pulsar 1s infinite 0.2s;">.</span>
            <span style="animation: pulsar 1s infinite 0.4s;">.</span>
        </span>
    `;
    indicador.style.display = 'flex';
    
    // Auto scroll
    const container = document.getElementById('chatMensagensPJ');
    if (container) container.scrollTop = container.scrollHeight;
    
    // Esconder ap√≥s 3s sem atividade
    if (digitandoPJTimeout) clearTimeout(digitandoPJTimeout);
    digitandoPJTimeout = setTimeout(() => {
        esconderIndicadorDigitando();
    }, 3000);
}

function esconderIndicadorDigitando() {
    const indicador = document.getElementById('indicadorDigitandoPJ');
    if (indicador) {
        indicador.style.display = 'none';
    }
}

// Enviar status de digitando
let ultimoEnvioDigitando = 0;
function notificarDigitando() {
    const agora = Date.now();
    // Enviar no m√°ximo a cada 1 segundo
    if (agora - ultimoEnvioDigitando > 1000) {
        ultimoEnvioDigitando = agora;
        enviarMensagemP2P({
            tipo: 'digitando',
            nome: obterNomeJogador()
        });
    }
}

// Atualizar status ao vivo (focando, pausado, etc)
function atualizarMeuStatusPJ(status) {
    enviarMensagemP2P({
        tipo: 'status_atualizado',
        status: status, // 'focando', 'pausado', 'online', 'voltou'
        tempoInicio: Date.now(),
        nome: obterNomeJogador(),
        peerId: peerPJ ? peerPJ.id : null
    });
}

// Formatar tempo decorrido
function formatarTempoDecorrido(tempoInicio) {
    const agora = Date.now();
    const diff = Math.floor((agora - tempoInicio) / 1000 / 60); // em minutos
    
    if (diff < 1) return 'agora';
    if (diff === 1) return 'h√° 1min';
    if (diff < 60) return `h√° ${diff}min`;
    
    const horas = Math.floor(diff / 60);
    if (horas === 1) return 'h√° 1h';
    return `h√° ${horas}h`;
}

function enviarMensagemChatPJ() {
    const input = document.getElementById('inputChatPJ');
    if (!input) return;
    
    const texto = input.value.trim();
    if (!texto) return;
    
    const mensagem = {
        nome: obterNomeJogador(),
        texto: texto,
        timestamp: Date.now(),
        minha: true
    };
    
    // Adicionar localmente
    adicionarMensagemChatPJ(mensagem);
    
    // Enviar para peers
    enviarMensagemP2P({
        tipo: 'chat',
        nome: mensagem.nome,
        texto: mensagem.texto,
        timestamp: mensagem.timestamp
    });
    
    // Limpar input
    input.value = '';
}

function adicionarMensagemChatPJ(mensagem) {
    mensagensChatPJ.push(mensagem);
    
    // Manter apenas √∫ltimas 50 mensagens
    if (mensagensChatPJ.length > 50) {
        mensagensChatPJ = mensagensChatPJ.slice(-50);
    }
    
    renderizarChatPJ();
    
    // Se o chat estiver oculto e n√£o for minha mensagem, incrementar badge
    const conteudo = document.getElementById('conteudoChatPJ');
    const badge = document.getElementById('chatBadgePJ');
    
    if (conteudo && badge && conteudo.style.display === 'none' && !mensagem.minha) {
        const count = parseInt(badge.textContent || '0') + 1;
        badge.textContent = count > 9 ? '9+' : count;
        badge.style.display = 'inline-block';
    }
    
    // Mostrar notifica√ß√£o na aba do chat se n√£o estiver ativa e n√£o for minha mensagem
    const secaoChat = document.getElementById('secaoChatPJ');
    const notification = document.getElementById('chatTabNotification');
    
    if (secaoChat && notification && secaoChat.style.display === 'none' && !mensagem.minha) {
        notification.style.display = 'block';
    }
}

function renderizarChatPJ() {
    const container = document.getElementById('chatMensagensPJ');
    const ultimaMsgEl = document.getElementById('ultimaMensagemPJ');
    
    if (!container) return;
    
    if (mensagensChatPJ.length === 0) {
        container.innerHTML = '<div style="color: var(--text-secondary); opacity: 0.6; text-align: center; padding: 30px 0;">Nenhuma mensagem ainda...</div>';
        if (ultimaMsgEl) {
            ultimaMsgEl.innerHTML = '<span style="opacity: 0.6;">Sem mensagens...</span>';
        }
        return;
    }
    
    container.innerHTML = mensagensChatPJ.map(msg => {
        const hora = new Date(msg.timestamp).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        const isMinha = msg.minha === true;
        const bgColor = isMinha ? 'rgba(76, 175, 80, 0.15)' : 'rgba(156, 39, 176, 0.1)';
        const align = isMinha ? 'flex-end' : 'flex-start';
        const borderRadius = isMinha ? '12px 12px 4px 12px' : '12px 12px 12px 4px';
        
        return `
            <div style="display: flex; flex-direction: column; align-items: ${align}; margin-bottom: 6px;">
                <div style="background: ${bgColor}; padding: 6px 10px; border-radius: ${borderRadius}; max-width: 85%;">
                    <div style="font-size: 10px; font-weight: bold; color: ${isMinha ? 'var(--primary)' : '#9c27b0'}; margin-bottom: 2px;">${msg.nome}</div>
                    <div style="word-wrap: break-word;">${escapeHtml(msg.texto)}</div>
                </div>
                <div style="font-size: 9px; opacity: 0.5; margin-top: 2px;">${hora}</div>
            </div>
        `;
    }).join('');
    
    // Atualizar √∫ltima mensagem
    if (ultimaMsgEl && mensagensChatPJ.length > 0) {
        const ultima = mensagensChatPJ[mensagensChatPJ.length - 1];
        const nome = ultima.minha ? 'Voc√™' : ultima.nome;
        ultimaMsgEl.innerHTML = `<strong style="color: ${ultima.minha ? 'var(--primary)' : '#9c27b0'};">${escapeHtml(nome)}:</strong> ${escapeHtml(ultima.texto)}`;
    }
    
    // Scroll para baixo
    container.scrollTop = container.scrollHeight;
}

// Toggle do chat
function toggleChatPJ() {
    const conteudo = document.getElementById('conteudoChatPJ');
    const seta = document.getElementById('setaChatPJ');
    const ultimaMsg = document.getElementById('ultimaMensagemPJ');
    const badge = document.getElementById('chatBadgePJ');
    
    if (!conteudo || !seta || !ultimaMsg) return;
    
    const estaAberto = conteudo.style.display !== 'none';
    
    if (estaAberto) {
        // Ocultar chat
        conteudo.style.display = 'none';
        ultimaMsg.style.display = 'block';
        seta.style.transform = 'rotate(-90deg)';
    } else {
        // Mostrar chat
        conteudo.style.display = 'block';
        ultimaMsg.style.display = 'none';
        seta.style.transform = 'rotate(0deg)';
        
        // Limpar badge ao abrir
        if (badge) {
            badge.style.display = 'none';
            badge.textContent = '0';
        }
        
        // Scroll para √∫ltima mensagem
        const container = document.getElementById('chatMensagensPJ');
        if (container) {
            container.scrollTop = container.scrollHeight;
        }
    }
}

// Fun√ß√£o `escapeHtml` definida mais abaixo (implementa√ß√£o consolidada).
function atualizarTimerPJDisplay() {
    const display = document.getElementById('timerPlantarJuntos');
    const btnFlutuante = document.getElementById('btnTimerFlutuantePJ');
    const icone = document.getElementById('timerFlutuanteIcone');
    const texto = document.getElementById('timerFlutuanteTexto');
    
    // Se n√£o h√° timer rodando, mostrar tempo selecionado
    if (!timerPJInterval) {
        const tempoMinutos = parseInt(document.getElementById('tempoPlantarJuntos')?.value || 25);
        const tempoFormatado = `${String(tempoMinutos).padStart(2, '0')}:00`;
        
        if (display) display.textContent = tempoFormatado;
        
        // Bot√£o flutuante mostra √≠cone quando n√£o est√° rodando
        if (icone) icone.style.display = 'block';
        if (texto) texto.style.display = 'none';
        if (btnFlutuante) {
            btnFlutuante.style.width = '60px';
            btnFlutuante.style.borderRadius = '50%';
        }
        return;
    }
    
    const minutos = Math.floor(tempoPJRestante / 60);
    const segundos = tempoPJRestante % 60;
    const tempoFormatado = `${String(minutos).padStart(2, '0')}:${String(segundos).padStart(2, '0')}`;
    
    if (display) display.textContent = tempoFormatado;
    
    // Bot√£o flutuante mostra o tempo quando est√° rodando
    if (icone) icone.style.display = 'none';
    if (texto) {
        texto.style.display = 'block';
        texto.textContent = tempoFormatado;
    }
    if (btnFlutuante) {
        btnFlutuante.style.width = '80px';
        btnFlutuante.style.borderRadius = '30px';
    }
}

// Toggle popup do timer
function togglePopupTimerPJ() {
    const popup = document.getElementById('popupTimerPJ');
    if (!popup) return;
    
    if (popup.style.display === 'none' || popup.style.display === '') {
        popup.style.display = 'block';
        // Anima√ß√£o de entrada (surgir de cima para baixo)
        popup.style.opacity = '0';
        popup.style.transform = 'translateY(-20px)';
        setTimeout(() => {
            popup.style.transition = 'opacity 0.25s cubic-bezier(.4,1.6,.6,1), transform 0.25s cubic-bezier(.4,1.6,.6,1)';
            popup.style.opacity = '1';
            popup.style.transform = 'translateY(0)';
        }, 10);
    } else {
        // Anima√ß√£o de sa√≠da (subir)
        popup.style.opacity = '0';
        popup.style.transform = 'translateY(-20px)';
        setTimeout(() => {
            popup.style.display = 'none';
        }, 250);
    }
}

// Fechar popup ao clicar fora
document.addEventListener('click', function(e) {
    const popup = document.getElementById('popupTimerPJ');
    const btn = document.getElementById('btnTimerFlutuantePJ');
    if (popup && btn && !popup.contains(e.target) && !btn.contains(e.target)) {
        if (popup.style.display === 'block') {
            popup.style.opacity = '0';
            popup.style.transform = 'translateY(-20px)';
            setTimeout(() => {
                popup.style.display = 'none';
            }, 250);
        }
    }
});

// Listener para atualizar display quando mudar o tempo
setTimeout(() => {
    const selectTempo = document.getElementById('tempoPlantarJuntos');
    if (selectTempo) {
        selectTempo.addEventListener('change', atualizarTimerPJDisplay);
    }
}, 1000);

function renderEstante() {
    const container = document.getElementById('listaLivros');
    if (!container) return;
    container.innerHTML = '';
    
    // Garantir que estante seja um array v√°lido
    if (!Array.isArray(estante)) {
        estante = [];
        StorageSeguro.set('estante_livros', []);
    }
    
    const LIVROS_POR_ANDAR = 12;
    // Sempre ter pelo menos 1 andar para o di√°rio
    const totalAndares = Math.max(1, Math.ceil(estante.length / LIVROS_POR_ANDAR));
    
    const estanteContainer = document.createElement('div');
    estanteContainer.style.display = 'flex';
    estanteContainer.style.flexDirection = 'column';
    estanteContainer.style.gap = '0';
    const isMobile = window.innerWidth <= 600;
    estanteContainer.style.width = '100%';
    estanteContainer.style.maxWidth = isMobile ? '100%' : '450px';
    estanteContainer.style.margin = '0 auto';
    
    for (let andar = 0; andar < totalAndares; andar++) {
        const inicio = andar * LIVROS_POR_ANDAR;
        const fim = inicio + LIVROS_POR_ANDAR;
        const livrosDoAndar = estante.slice(inicio, fim);
        
        const andarDiv = document.createElement('div');
        andarDiv.className = 'madeira-shelf';
        andarDiv.style.margin = '0 0 0 0';
        andarDiv.style.position = 'relative';
        
        const prateleiraDiv = document.createElement('div');
        prateleiraDiv.className = 'prateleira-interna';
        prateleiraDiv.style.minHeight = '80px';
        prateleiraDiv.style.padding = '8px 8px 0 8px';
        prateleiraDiv.style.position = 'relative';
        prateleiraDiv.style.overflow = 'hidden';

        // Adicionar Di√°rio na primeira prateleira
        if (andar === 0) {
            const diarioDiv = document.createElement('div');
            diarioDiv.className = 'livro';
            diarioDiv.style.backgroundColor = '#c2185b';
            diarioDiv.style.height = '75px';
            diarioDiv.style.width = isMobile ? '22px' : '38px';
            diarioDiv.style.marginRight = '10px';
            diarioDiv.style.boxShadow = '0 0 10px rgba(194, 24, 91, 0.5)';
            diarioDiv.style.cursor = 'pointer';
            diarioDiv.style.transform = 'rotate(-8deg)';
            diarioDiv.style.transformOrigin = 'bottom left';
            diarioDiv.style.marginLeft = '5px';
            diarioDiv.title = "Meu Di√°rio";
            
            const lombada = document.createElement('div');
            lombada.style.position = 'absolute';
            lombada.style.top = '0';
            lombada.style.left = '0';
            lombada.style.width = '5px';
            lombada.style.height = '100%';
            lombada.style.backgroundColor = 'rgba(0,0,0,0.3)';
            diarioDiv.appendChild(lombada);
            
            const tituloDiv = document.createElement('div');
            tituloDiv.className = 'livro-titulo';
            tituloDiv.textContent = 'DI√ÅRIO';
            tituloDiv.style.fontSize = isMobile ? '7px' : '10px';
            tituloDiv.style.color = 'white';
            tituloDiv.style.padding = '5px 0px';
            tituloDiv.style.fontWeight = 'bold';
            diarioDiv.appendChild(tituloDiv);
            
            diarioDiv.onclick = () => {
                fecharModal('estanteOverlay');
                abrirDiario();
            };
            
            prateleiraDiv.appendChild(diarioDiv);
        }
        
        livrosDoAndar.forEach((livro, indexNoAndar) => {
            const livroDiv = document.createElement('div');
            livroDiv.className = 'livro';
            livroDiv.style.backgroundColor = livro.cor;
            livroDiv.style.height = (60 + (indexNoAndar % 3) * 8) + 'px';
            const isMobile = window.innerWidth <= 600;
            livroDiv.style.width = isMobile ? '18px' : '32px';
            livroDiv.style.marginRight = '-1px';
            
            const lombada = document.createElement('div');
            lombada.style.position = 'absolute';
            lombada.style.top = '0';
            lombada.style.left = '0';
            lombada.style.width = '3px';
            lombada.style.height = '100%';
            lombada.style.backgroundColor = 'rgba(0,0,0,0.15)';
            livroDiv.appendChild(lombada);
            
            const tituloDiv = document.createElement('div');
            tituloDiv.className = 'livro-titulo';
            tituloDiv.textContent = livro.nome;
            tituloDiv.style.fontSize = isMobile ? '6px' : '8px';
            tituloDiv.style.padding = '3px 0px';
            tituloDiv.style.fontWeight = 'bold';
            
            livroDiv.appendChild(tituloDiv);
            
            livroDiv.onclick = () => {
                showModal({ 
                    text: `üìñ <strong>${livro.nome}</strong><br>Nota: ${livro.nota > 0 ? '‚≠ê'.repeat(livro.nota) : 'Sem nota'}${livro.notas ? `<br><br>Notas: ${livro.notas}` : ''}<br><br>Deseja excluir este livro?`, 
                    onConfirm: () => { 
                        const indexGlobal = inicio + indexNoAndar;
                        estante.splice(indexGlobal, 1); 
                        StorageSeguro.set('estante_livros', estante); 
                        renderEstante(); 
                        renderEstrelasNoCeu();
                    } 
                });
            };
            
            prateleiraDiv.appendChild(livroDiv);
        });
        
        andarDiv.appendChild(prateleiraDiv);
        estanteContainer.appendChild(andarDiv);
    }
    
    const contadorDiv = document.createElement('div');
    contadorDiv.style.textAlign = 'center';
    contadorDiv.style.marginTop = '15px';
    contadorDiv.style.fontSize = '12px';
    contadorDiv.style.color = 'var(--text-main)';
    contadorDiv.innerHTML = `üìö <strong>${estante.length}</strong> livro${estante.length !== 1 ? 's' : ''} + üìî <strong>Di√°rio</strong> em <strong>${totalAndares}</strong> andar${totalAndares !== 1 ? 'es' : ''}`;
    estanteContainer.appendChild(contadorDiv);
    
    container.appendChild(estanteContainer);
}

function prepararNovoLivro() { 
    notaTemp = 0; 
    corLivroTemp = CORES_LIVROS[0];
    document.getElementById('nomeLivroInput').value = ''; 
    document.getElementById('notasLivroInput').value = ''; 
    atualizarEstrelas(0); 
    renderCorPicker();
    abrirModal('modalLivroInput'); 
}

function renderCorPicker() {
    const container = document.getElementById('livroColorPicker');
    container.innerHTML = '';
    CORES_LIVROS.forEach(cor => {
        const swatch = document.createElement('div');
        swatch.className = 'color-swatch' + (cor === corLivroTemp ? ' active' : '');
        swatch.style.backgroundColor = cor;
        swatch.onclick = () => {
            corLivroTemp = cor;
            renderCorPicker();
        };
        container.appendChild(swatch);
    });
}

function setupEstrelasClick() { 
    document.querySelectorAll('#starsClickable .star').forEach(s => { 
        s.onclick = (e) => { 
            notaTemp = parseInt(e.target.dataset.v); 
            atualizarEstrelas(notaTemp); 
        }; 
    }); 
}

function atualizarEstrelas(v) { 
    document.querySelectorAll('#starsClickable .star').forEach(s => { 
        s.classList.toggle('active', parseInt(s.dataset.v) <= v); 
    }); 
}

function confirmarNovoLivro() {
    const nome = document.getElementById('nomeLivroInput').value; 
    const notas = document.getElementById('notasLivroInput').value;
    if(!nome.trim()) return;
    
    const LIVROS_POR_ANDAR = 12;
    const andarAtual = Math.ceil(estante.length / LIVROS_POR_ANDAR);
    const novoAndar = Math.ceil((estante.length + 1) / LIVROS_POR_ANDAR);
    
    estante.push({ nome: nome, nota: notaTemp, cor: corLivroTemp, notas: notas });
    StorageSeguro.set('estante_livros', estante); 
    
    if (novoAndar > andarAtual) {
        showModal({ 
            text: `üìö Novo livro adicionado!\n‚ú® Sua estante agora tem ${novoAndar} andar${novoAndar !== 1 ? 'es' : ''}! Continue lendo e crescendo sua cole√ß√£o!`, 
            onConfirm: () => {} 
        });
    }
    
    fecharModal('modalLivroInput');
    renderEstante(); 
    renderEstrelasNoCeu();
}

function abrirDashboard() { 
    abrirModal('dashboardOverlay');
    mostrarDashboardPeriodo('semanal');
}

function mostrarDashboardPeriodo(periodo) {
    document.getElementById('btnDashboardSemanal').classList.remove('active');
    document.getElementById('btnDashboardMensal').classList.remove('active');
    document.getElementById('btnDashboardAnual').classList.remove('active');
    document.getElementById('btnDashboardGrid3d').classList.remove('active');
    document.getElementById('btnDashboard' + periodo.charAt(0).toUpperCase() + periodo.slice(1)).classList.add('active');
    
    document.getElementById('dashboardContainerSemanal').style.display = 'none';
    document.getElementById('dashboardContainerMensal').style.display = 'none';
    document.getElementById('dashboardContainerAnual').style.display = 'none';
    document.getElementById('dashboardContainerGrid3d').style.display = 'none';
    
    const containerId = 'dashboardContainer' + periodo.charAt(0).toUpperCase() + periodo.slice(1);
    document.getElementById(containerId).style.display = 'block';
    
    if (periodo === 'semanal') {
        renderizarDashboardSemanal();
    } else if (periodo === 'mensal') {
        renderizarDashboardMensal();
    } else if (periodo === 'anual') {
        renderizarDashboardAnual();
    } else if (periodo === 'grid3d') {
        renderizarDashboardGrid3D();
    }
}

function renderizarDashboardGrid3D() {
    const container = document.getElementById('dashboardContainerGrid3d');
    container.innerHTML = '';

    // ============================================================
    // CORRE√á√ÉO DE PERSIST√äNCIA (O SEGREDO PARA N√ÉO SUMIR)
    // ============================================================
    // Busca os dados diretamente do cofre seguro, ignorando a vari√°vel global vazia
    const historicoSeguro = StorageSeguro.get('historico_foco', []);
    
    // Atualiza a vari√°vel global para garantir que novos focos n√£o apaguem o passado
    if (typeof historico !== 'undefined') {
        historico = historicoSeguro; 
    }
    // ============================================================

    const agora = new Date();
    const anoAtual = agora.getFullYear();

    // Filtra sess√µes do ano atual usando a lista segura
    const sessoesAno = historicoSeguro.filter(s => {
        if (s.status !== 'sucesso') return false;
        const dataSessao = new Date(s.data);
        return dataSessao.getFullYear() === anoAtual;
    });

    // C√°lculo din√¢mico do tamanho do grid
    const totalArvores = sessoesAno.length;
    const gridSize = Math.max(10, Math.ceil(Math.sqrt(totalArvores)));

    // Ajuste fino do tamanho da c√©lula
    let cellSize = 32;
    if (gridSize > 25) cellSize = 12;
    else if (gridSize > 20) cellSize = 16;
    else if (gridSize > 15) cellSize = 20;
    else if (gridSize > 12) cellSize = 25;

    // Estilos do grid isom√©trico
    const style = document.createElement('style');
    style.textContent = `
        .dashboard-scene-3d {
            perspective: 2000px;
            width: 100%;
            height: 450px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: var(--bg-body);
            position: relative;
            padding: 0;
            box-sizing: border-box;
            cursor: grab;
            user-select: none;
            border-radius: 20px;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.1);
        }
        .dashboard-scene-3d:active { cursor: grabbing; }
        
        .dashboard-grid-container-3d {
            display: grid;
            grid-template-columns: repeat(${gridSize}, ${cellSize}px);
            grid-template-rows: repeat(${gridSize}, ${cellSize}px);
            gap: 2px;
            transform: rotateX(60deg) rotateZ(45deg) translateZ(0);
            transform-style: preserve-3d;
            position: relative;
            background-color: var(--grid-border);
            padding: 2px;
            transition: transform 0.1s ease-out;
            flex-shrink: 0;
            will-change: transform;
        }
        
        .dashboard-grid-container-3d::before {
            content: ''; position: absolute; top: 100%; left: 0; 
            width: 100%; height: 15px; 
            background: var(--side-color); 
            transform-origin: top; transform: rotateX(-90deg);
        }
        .dashboard-grid-container-3d::after {
            content: ''; position: absolute; top: 0; left: 100%; 
            width: 15px; height: 100%; 
            background: var(--bottom-color); 
            transform-origin: left; transform: rotateY(90deg);
        }

        .dashboard-cell-3d {
            width: ${cellSize}px;
            height: ${cellSize}px;
            background-color: var(--grid-color);
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 40 40"><path d="M5 35 L10 30 L15 35 Z" fill="%237db336" opacity="0.7"/><path d="M25 15 L30 10 L35 15 Z" fill="%237db336" opacity="0.7"/></svg>');
            background-size: ${cellSize}px ${cellSize}px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transform-style: preserve-3d;
        }
        
        .dashboard-emoji-3d {
            font-size: ${Math.floor(cellSize * 0.75)}px;
            position: absolute;
            pointer-events: auto;
            cursor: pointer;
            z-index: 10;
            transition: all 0.3s ease;
            --sprite-scale: 1;
            --sprite-translate-y: -60%;
            --sprite-offset-x: 0%;
        }
        .dashboard-emoji-3d:hover {
            --sprite-scale: 1.3;
            --sprite-translate-y: -72%;
            z-index: 1000;
        }
    `;
    container.appendChild(style);

    const nota = document.createElement('div');
    nota.id = 'dashboardNotaDinamica';
    nota.style.cssText = 'background: var(--bg-panel); padding: 10px; border-radius: 15px; font-size: 13px; margin-bottom: 10px; border-left: 4px solid var(--primary); color: var(--text-main); text-align: left; width: 100%; box-sizing: border-box; transition: all 0.3s ease;';
    nota.innerHTML = `üí° <strong>Dica:</strong> Clique em uma planta para ver detalhes.`;
    container.appendChild(nota);

    const scene = document.createElement('div');
    scene.className = 'dashboard-scene-3d';

    const grid = document.createElement('div');
    grid.className = 'dashboard-grid-container-3d';

    // Loop de preenchimento
    const totalCells = gridSize * gridSize;
    
    for (let i = 0; i < totalCells; i++) {
        const cell = document.createElement('div');
        cell.className = 'dashboard-cell-3d';

        if (i < sessoesAno.length) {
            const sessao = sessoesAno[i];
            const icone = sessao.icone || 'üå≥';
            
            // Listas de verifica√ß√£o
            const caminhos = TIPOS_CAMINHO;
            const floresEspeciais = ['üåª', 'üåπ', 'üå∑'];
            const arvoresEspeciais = ['arvore-rosa','arvore-roxa','arvore-amarela','arvore-branca','arvore-colmeia','arvore-frutifera'];
            const isCaminho = caminhos.includes(icone);
            const isFlor = floresEspeciais.includes(icone);
            const isArvore = arvoresEspeciais.includes(iconKey(icone));

            // 1. SE FOR CAMINHO: Renderiza a textura do caminho
            if (isCaminho) {
                const x = i % gridSize;
                const y = Math.floor(i / gridSize);
                
                // Sistema simplificado de conex√µes para o Dashboard (conecta com vizinhos imediatos)
                const check = (dx, dy) => {
                    const nx = x + dx;
                    const ny = y + dy;
                    if (nx < 0 || nx >= gridSize || ny < 0 || ny >= gridSize) return false;
                    const ni = ny * gridSize + nx;
                    const nItem = sessoesAno[ni];
                    return nItem && caminhos.includes(nItem.icone || 'üå≥');
                };

                const conexoes = {
                    norte: check(0, -1),
                    sul:   check(0, 1),
                    oeste: check(-1, 0),
                    leste: check(1, 0)
                };

                const isBorda = {
                    norte: y === 0,
                    sul:   y === gridSize - 1,
                    oeste: x === 0,
                    leste: x === gridSize - 1
                };

                const svgBackground = gerarTexturaCaminho(conexoes, icone, isBorda);
                cell.style.backgroundImage = `url('${svgBackground}'), url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 40 40"><path d="M5 35 L10 30 L15 35 Z" fill="%237db336" opacity="0.7"/><path d="M25 15 L30 10 L35 15 Z" fill="%237db336" opacity="0.7"/></svg>')`;
                cell.style.backgroundSize = '100% 100%';
            } 
            // 2. SE FOR FLOR: Usa o novo sprite SVG rico
            else if (isFlor && typeof gerarSpriteFlor === 'function') {
                const svgSprite = gerarSpriteFlor(icone);
                const florElem = document.createElement('div');
                
                florElem.style.position = 'absolute';
                florElem.style.width = '100%';
                florElem.style.height = '100%';
                florElem.style.backgroundImage = `url('${svgSprite}')`;
                florElem.style.backgroundSize = 'contain';
                florElem.style.backgroundRepeat = 'no-repeat';
                florElem.style.backgroundPosition = 'center bottom';
                florElem.style.pointerEvents = 'auto';
                florElem.style.cursor = 'pointer';
                
                aplicarAlinhamentoSprite(florElem, { scale: 0.85 });
                
                florElem.onclick = () => {
                    const dataFormatada = new Date(sessao.data).toLocaleDateString('pt-BR');
                    if (document.getElementById('dashboardNotaDinamica')) {
                        document.getElementById('dashboardNotaDinamica').innerHTML = `üåº <strong>${sessao.motivo || 'Flor'}:</strong> ${sessao.minutos} min em ${dataFormatada}`;
                    }
                };
                
                cell.appendChild(florElem);
            }
            else if (isArvore && typeof gerarSpriteArvore === 'function') {
                const svgSprite = gerarSpriteArvore(icone);
                const treeElem = document.createElement('div');
                treeElem.style.position = 'absolute';
                treeElem.style.width = '100%';
                treeElem.style.height = '100%';
                treeElem.style.backgroundImage = `url('${svgSprite}')`;
                treeElem.style.backgroundSize = 'contain';
                treeElem.style.backgroundRepeat = 'no-repeat';
                treeElem.style.backgroundPosition = 'center bottom';
                treeElem.style.pointerEvents = 'auto';
                treeElem.style.cursor = 'pointer';
                
                aplicarAlinhamentoSprite(treeElem, { scale: 2.0, translateY: '-35%' });
                
                treeElem.onclick = () => {
                    const dataFormatada = new Date(sessao.data).toLocaleDateString('pt-BR');
                    if (document.getElementById('dashboardNotaDinamica')) {
                        document.getElementById('dashboardNotaDinamica').innerHTML = `üå≥ <strong>${sessao.motivo || '√Årvore'}:</strong> ${sessao.minutos} min em ${dataFormatada}`;
                    }
                };
                
                cell.appendChild(treeElem);
            }
            // 4. SE FOR OUTRO ITEM COM SPRITE (Lago, Postes, etc)
            else if (['lago', 'poste-luz', 'banco-praca', 'piquenique', 'gazebo', 'pote_ouro', 'escorrega_azul', 'baloi√ßo_madeira', 'baloi√ßo_pneus', 'baloi√ßo_mola'].includes(iconKey(icone))) {
                let svgSprite = '';
                let setup = { scale: 0.85 };
                let label = icone;
                const norm = iconKey(icone);

                if (norm === 'lago' && typeof gerarSpriteLago === 'function') {
                    svgSprite = gerarSpriteLago(norm); setup.scale = 0.7; label = 'Lago';
                } else if (norm === 'poste-luz' && typeof gerarSpritePosteLuz === 'function') {
                    svgSprite = gerarSpritePosteLuz(norm); setup.scale = 0.8; label = 'Poste de Luz';
                } else if (norm === 'banco-praca' && typeof gerarSpriteBancoPraca === 'function') {
                    svgSprite = gerarSpriteBancoPraca(norm); setup.scale = 0.85; label = 'Banco';
                } else if (norm === 'piquenique' && typeof gerarSpritePiquenique === 'function') {
                    svgSprite = gerarSpritePiquenique(norm); setup.scale = 0.85; label = 'Piquenique';
                } else if (norm === 'gazebo' && typeof gerarSpriteGazebo === 'function') {
                    svgSprite = gerarSpriteGazebo(norm); setup.scale = 0.85; label = 'Gazebo';
                } else if (norm === 'pote_ouro' && typeof gerarSpritePoteOuro === 'function') {
                    svgSprite = gerarSpritePoteOuro(); setup.scale = 0.85; label = 'Pote de Ouro';
                } else if (norm === 'escorrega_azul' && typeof gerarSpriteEscorrega === 'function') {
                    svgSprite = gerarSpriteEscorrega(); setup.scale = 0.9; label = 'Escorrega';
                } else if (norm === 'baloi√ßo_madeira' && typeof gerarSpriteBaloi√ßoMadeira === 'function') {
                    svgSprite = gerarSpriteBaloi√ßoMadeira(); setup.scale = 0.9; label = 'Baloi√ßo';
                } else if (norm === 'baloi√ßo_pneus' && typeof gerarSpriteBaloi√ßoPneus === 'function') {
                    svgSprite = gerarSpriteBaloi√ßoPneus(); setup.scale = 0.9; label = 'Baloi√ßo';
                } else if (norm === 'baloi√ßo_mola' && typeof gerarSpriteBaloi√ßoMola === 'function') {
                    svgSprite = gerarSpriteBaloi√ßoMola(); setup.scale = 0.9; label = 'Baloi√ßo';
                }

                if (svgSprite) {
                    const itemElem = document.createElement('div');
                    itemElem.style.position = 'absolute';
                    itemElem.style.width = '100%';
                    itemElem.style.height = '100%';
                    itemElem.style.backgroundImage = `url('${svgSprite}')`;
                    itemElem.style.backgroundSize = 'contain';
                    itemElem.style.backgroundRepeat = 'no-repeat';
                    itemElem.style.backgroundPosition = 'center bottom';
                    itemElem.style.pointerEvents = 'auto';
                    itemElem.style.cursor = 'pointer';
                    
                    aplicarAlinhamentoSprite(itemElem, setup);
                    
                    itemElem.onclick = () => {
                        const dataFormatada = new Date(sessao.data).toLocaleDateString('pt-BR');
                        if (document.getElementById('dashboardNotaDinamica')) {
                            document.getElementById('dashboardNotaDinamica').innerHTML = `‚ú® <strong>${sessao.motivo || label}:</strong> ${sessao.minutos} min em ${dataFormatada}`;
                        }
                    };
                    cell.appendChild(itemElem);
                }
            }
            // 5. SE FOR √ÅRVORE ANTIGA/ERRO OU EMOJI COMUM
            else {
                const norm = (typeof iconKey === 'function') ? iconKey(icone) : (''+icone).toLowerCase().replace(/\s+/g,'-');
                if (['arvore-rosa','arvore-roxa','arvore-amarela','arvore-branca'].includes(norm) && typeof gerarSpriteArvore === 'function') {
                    const tree = document.createElement('div');
                    tree.className = 'dashboard-emoji-3d';
                    tree.style.width = '100%';
                    tree.style.height = '100%';
                    tree.style.backgroundImage = `url('${gerarSpriteArvore(icone)}')`;
                    tree.style.backgroundSize = 'contain';
                    tree.style.backgroundRepeat = 'no-repeat';
                    tree.style.backgroundPosition = 'center bottom';
                    
                    aplicarAlinhamentoSprite(tree);
                    tree.onclick = () => {
                        const dataFormatada = new Date(sessao.data).toLocaleDateString('pt-BR');
                        if (document.getElementById('dashboardNotaDinamica')) {
                            document.getElementById('dashboardNotaDinamica').innerHTML = `üå≥ <strong>${sessao.motivo || 'Foco'}:</strong> ${sessao.minutos} min em ${dataFormatada}`;
                        }
                    };
                    
                    cell.appendChild(tree);
                } else {
                    const tree = document.createElement('div');
                    tree.className = 'dashboard-emoji-3d';
                    tree.innerHTML = `${icone}`;
                    
                    aplicarAlinhamentoSprite(tree);
                    tree.onclick = () => {
                        const dataFormatada = new Date(sessao.data).toLocaleDateString('pt-BR');
                        if (document.getElementById('dashboardNotaDinamica')) {
                            document.getElementById('dashboardNotaDinamica').innerHTML = `üå≥ <strong>${sessao.motivo || 'Foco'}:</strong> ${sessao.minutos} min em ${dataFormatada}`;
                        }
                    };
                    
                    cell.appendChild(tree);
                }
            }
        }

        grid.appendChild(cell);
    }

    scene.appendChild(grid);
    container.appendChild(scene);
    
    // --- CONTROLES DE ZOOM (PAN REMOVIDO) ---
    let scale = 1;

    const updateTransform = () => {
        grid.style.transform = `scale(${scale}) rotateX(60deg) rotateZ(45deg) translateZ(0)`;
    };

    // Zoom Wheel
    scene.onwheel = (e) => {
        e.preventDefault();
        const delta = e.deltaY > 0 ? 0.9 : 1.1;
        const newScale = scale * delta;
        if (newScale >= 0.5 && newScale <= 3) { scale = newScale; updateTransform(); }
    };

    // Bot√µes de Zoom e Vis√£o Panor√¢mica
    const zoomControls = document.createElement('div');
    zoomControls.style.cssText = 'position: absolute; bottom: 15px; right: 15px; display: flex; flex-direction: column; gap: 8px; z-index: 100;';
    
    const btnZoomIn = document.createElement('button');
    btnZoomIn.innerHTML = '‚ûï';
    btnZoomIn.style.cssText = 'width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--primary); background: var(--bg-panel); cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.2);';
    btnZoomIn.onclick = (e) => { e.stopPropagation(); if (scale <= 3) { scale *= 1.2; updateTransform(); } };

    const btnZoomOut = document.createElement('button');
    btnZoomOut.innerHTML = '‚ûñ';
    btnZoomOut.style.cssText = 'width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--primary); background: var(--bg-panel); cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.2);';
    btnZoomOut.onclick = (e) => { e.stopPropagation(); if (scale >= 0.5) { scale /= 1.2; updateTransform(); } };

    const btnFullView = document.createElement('button');
    btnFullView.innerHTML = 'üñºÔ∏è';
    btnFullView.style.cssText = 'width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--primary); background: var(--bg-panel); cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.2);';
    btnFullView.onclick = (e) => { e.stopPropagation(); scale = 0.7; updateTransform(); };

    zoomControls.appendChild(btnZoomIn);
    zoomControls.appendChild(btnZoomOut);

    // O bot√£o de plantar foi movido para os controles iniciais (#controlesZoom3D) para consist√™ncia com a interface do modo 3D.
    zoomControls.appendChild(btnFullView);
    scene.appendChild(zoomControls);

    const info = document.createElement('div');
    info.className = 'dashboard-grid-info';
    info.innerHTML = `üå≥ <strong>${sessoesAno.length}</strong> √°rvores em ${anoAtual}`;
    container.appendChild(info);
}



function calcularMaisUsado(sessoes) {
    // Priorizar por tempo total (minutos) gasto com cada emoji, pois reflete uso real
    if (sessoes.length === 0) {
        return { icone: "üìä", motivo: "Nenhum dado", minutos: 0 };
    }
    
    const contagemIcones = {};
    const minutosPorIcone = {};
    const contagemMotivos = {};
    
    sessoes.forEach(sessao => {
        const minutos = Number(sessao.minutos) || 0;

        if (sessao.icone) {
            contagemIcones[sessao.icone] = (contagemIcones[sessao.icone] || 0) + 1;
            minutosPorIcone[sessao.icone] = (minutosPorIcone[sessao.icone] || 0) + minutos;
        }
        
        if (sessao.motivo) {
            contagemMotivos[sessao.motivo] = (contagemMotivos[sessao.motivo] || 0) + 1;
        }
    });
    
    // Escolher √≠cone com mais minutos (quebra-empate por n√∫mero de sess√µes)
    let iconeMaisUsado = "üìä";
    let maxMinutos = 0;
    for (const [icone, minutos] of Object.entries(minutosPorIcone)) {
        if (minutos > maxMinutos) {
            maxMinutos = minutos;
            iconeMaisUsado = icone;
        } else if (minutos === maxMinutos) {
            // tie-breaker: escolher o que tem mais sess√µes
            if ((contagemIcones[icone] || 0) > (contagemIcones[iconeMaisUsado] || 0)) {
                iconeMaisUsado = icone;
            }
        }
    }
    
    // Se n√£o houver minutos (ex.: registros inv√°lidos), cair para contagem por sess√µes
    if (maxMinutos === 0 && Object.keys(contagemIcones).length > 0) {
        let maxIcones = 0;
        for (const [icone, contagem] of Object.entries(contagemIcones)) {
            if (contagem > maxIcones) {
                maxIcones = contagem;
                iconeMaisUsado = icone;
            }
        }
    }
    
    // Motivo mais frequente (por n√∫mero de sess√µes)
    let motivoMaisUsado = "Nenhum";
    let maxMotivos = 0;
    for (const [motivo, contagem] of Object.entries(contagemMotivos)) {
        if (contagem > maxMotivos) {
            maxMotivos = contagem;
            motivoMaisUsado = motivo;
        }
    }
    
    console.debug('calcularMaisUsado result', { icone: iconeMaisUsado, motivo: motivoMaisUsado, minutos: maxMinutos, sessoes: sessoes.length });
    return { icone: iconeMaisUsado, motivo: motivoMaisUsado, minutos: maxMinutos };
}

// Sanitiza o hist√≥rico: valida datas, normaliza campos e remove duplicados exatos
function sanitizeHistorico() {
    const arr = Array.isArray(historico) ? historico : [];
    const cleaned = [];
    const seen = new Set();

    arr.forEach(s => {
        if (!s || !s.data) {
            console.warn('historico: registro inv√°lido ignorado', s);
            return;
        }
        const d = new Date(s.data);
        if (isNaN(d.getTime())) {
            console.warn('historico: data inv√°lida ignorada', s);
            return;
        }

        const minutos = Number(s.minutos) || 0;
        const motivo = s.motivo || 'Geral';
        const icone = s.icone || '‚ùì';
        const status = s.status || 'falha';

        const key = `${d.toISOString()}|${icone}|${motivo}|${minutos}|${status}`;
        if (seen.has(key)) {
            console.debug('historico: duplicado encontrado e ignorado', key);
            return;
        }
        seen.add(key);

        cleaned.push({ data: d.toISOString(), minutos, motivo, icone, mes: d.getMonth(), ano: d.getFullYear(), status });
    });

    if (arr.length !== cleaned.length) console.debug('historico: sanitizado', { original: arr.length, cleaned: cleaned.length });
    return cleaned;
}

function renderizarDashboardSemanal() {
    const container = document.getElementById('dashboardContainerSemanal');
    container.innerHTML = '';
    
    const ultimos7dias = [];
    const hoje = new Date();
    hoje.setHours(0, 0, 0, 0);
    
    for (let i = 6; i >= 0; i--) {
        const dia = new Date(hoje);
        dia.setDate(hoje.getDate() - i);
        ultimos7dias.push(dia);
    }
    
    const historicoSanitizado = sanitizeHistorico();
    const minutosPorDia = ultimos7dias.map(dia => {
        const sessoesDoDia = historicoSanitizado.filter(s => {
            const sDate = new Date(s.data);
            sDate.setHours(0, 0, 0, 0);
            return sDate.getTime() === dia.getTime() && s.status === 'sucesso';
        });
        return sessoesDoDia.reduce((acc, sessao) => acc + Number(sessao.minutos || 0), 0);
    });
    
    const maxMinutos = Math.max(...minutosPorDia, 60);
    const metaDiaria = 60;
    
    ultimos7dias.forEach((dia, index) => {
        const minutos = minutosPorDia[index];
        const porcentagem = Math.min((minutos / maxMinutos) * 100, 100);
        const isHoje = index === 6;
        
        const diaElement = document.createElement('div');
        diaElement.className = 'dia-semana';
        
        const nomesDias = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
        const diaSemana = nomesDias[dia.getDay()];
        
        diaElement.innerHTML = `
            <div class="dia-label">${diaSemana}</div>
            <div class="dia-barra-container">
                <div class="dia-barra ${isHoje ? 'hoje' : ''}" style="width: ${porcentagem}%"></div>
                <div class="dia-meta" style="left: ${(metaDiaria / maxMinutos) * 100}%"></div>
                <div class="dia-valor">${minutos} min</div>
            </div>
        `;
        
        container.appendChild(diaElement);
    });
    
    const totalSemana = minutosPorDia.reduce((a, b) => a + b, 0);
    const diasComSessoes = minutosPorDia.filter(m => m > 0).length;
    const mediaDiaria = diasComSessoes > 0 ? Math.round(totalSemana / diasComSessoes) : 0;
    
    const resumoHTML = `
        <div class="dashboard-resumo">
            <div class="resumo-item">
                <div class="resumo-valor total">${totalSemana}</div>
                <div class="resumo-label">Minutos na semana</div>
            </div>
            <div class="resumo-item">
                <div class="resumo-valor">${diasComSessoes}</div>
                <div class="resumo-label">Dias ativos</div>
            </div>
            <div class="resumo-item">
                <div class="resumo-valor meta">${mediaDiaria}</div>
                <div class="resumo-label">M√©dia por dia</div>
            </div>
            <div class="resumo-item">
                <div class="resumo-valor streak">${streakDiasAtivos}</div>
                <div class="resumo-label">Dias consecutivos ‚òÄÔ∏è</div>
            </div>
        </div>
    `;
    
    container.innerHTML += resumoHTML;
    
    const sessoesSemana = historicoSanitizado.filter(s => {
        const sDate = new Date(s.data);
        sDate.setHours(0, 0, 0, 0);
        return ultimos7dias.some(dia => dia.getTime() === sDate.getTime()) && s.status === 'sucesso';
    });
    
    const maisUsado = calcularMaisUsado(sessoesSemana);
    
    const maisUsadoHTML = `
        <div class="mais-usado-section">
            <div class="mais-usado-header">
                <span>üìà</span>
                <span>Mais usado na semana</span>
            </div>
            <div class="mais-usado-content">
                <div class="mais-usado-item">
                    <span class="mais-usado-emoji">${getIconDisplayHTML(maisUsado.icone)}</span>
                    <div class="mais-usado-motivo">${maisUsado.motivo}</div>
                    <span class="mais-usado-label">Motivo mais frequente</span>
                </div>
                <div class="mais-usado-item">
                    <span class="mais-usado-emoji">${getIconDisplayHTML(maisUsado.icone)}</span>
                    <div class="mais-usado-motivo">${sessoesSemana.length} sess√µes ¬∑ ${maisUsado.minutos || 0} min</div>
                    <span class="mais-usado-label">Sess√µes / Tempo</span>
                </div>
            </div>
        </div>
    `;
    
    container.innerHTML += maisUsadoHTML;
    console.debug('renderizarDashboardSemanal resumo', { totalSemana, diasComSessoes, sessoesSemana: sessoesSemana.length, minutosSemana: totalSemana });
    
    setTimeout(() => {
        container.querySelectorAll('.dia-barra').forEach((barra, index) => {
            const minutos = minutosPorDia[index];
            const porcentagem = Math.min((minutos / maxMinutos) * 100, 100);
            barra.style.width = `${porcentagem}%`;
        });
    }, 100);
}

function renderizarDashboardMensal() {
    const container = document.getElementById('dashboardContainerMensal');
    container.innerHTML = '';
    
    const agora = new Date();
    const mesAtual = agora.getMonth();
    const anoAtual = agora.getFullYear();
    const diasNoMes = new Date(anoAtual, mesAtual + 1, 0).getDate();
    
    const minutosPorDia = Array(diasNoMes).fill(0);
    
    const historicoSanitizado = sanitizeHistorico();
    historicoSanitizado.forEach(sessao => {
        if (sessao.status === 'sucesso') {
            const dataSessao = new Date(sessao.data);
            if (dataSessao.getMonth() === mesAtual && dataSessao.getFullYear() === anoAtual) {
                const dia = dataSessao.getDate() - 1;
                minutosPorDia[dia] += Number(sessao.minutos || 0);
            }
        }
    });
    
    const maxMinutos = Math.max(...minutosPorDia, 100);
    
    for (let i = 0; i < diasNoMes; i += 7) {
        const semanaDias = minutosPorDia.slice(i, Math.min(i + 7, diasNoMes));
        const semanaContainer = document.createElement('div');
        semanaContainer.className = 'semana-card';
        semanaContainer.innerHTML = `<strong>Semana ${Math.floor(i/7) + 1} (dias ${i+1}-${Math.min(i+7, diasNoMes)})</strong><br>`;
        
        semanaDias.forEach((minutos, indexDia) => {
            const diaNum = i + indexDia + 1;
            const porcentagem = Math.min((minutos / maxMinutos) * 100, 100);
            semanaContainer.innerHTML += `
                <div style="display: flex; align-items: center; margin: 5px 0;">
                    <div style="width: 30px; font-size: 11px;">${diaNum}</div>
                    <div style="flex: 1; background: var(--bg-body); height: 12px; border-radius: 6px; overflow: hidden;">
                        <div style="height: 100%; background: ${diaNum === agora.getDate() ? 'var(--accent)' : 'var(--primary)'}; width: ${porcentagem}%; border-radius: 6px;"></div>
                    </div>
                    <div style="width: 40px; font-size: 11px; text-align: right;">${minutos}m</div>
                </div>
            `;
        });
        
        container.appendChild(semanaContainer);
    }
    
    const totalMes = minutosPorDia.reduce((a, b) => a + b, 0);
    const diasAtivos = minutosPorDia.filter(m => m > 0).length;
    const mediaDiaria = diasAtivos > 0 ? Math.round(totalMes / diasAtivos) : 0;
    
    const resumoHTML = `
        <div class="dashboard-resumo">
            <div class="resumo-item">
                <div class="resumo-valor total">${totalMes}</div>
                <div class="resumo-label">Minutos no m√™s</div>
            </div>
            <div class="resumo-item">
                <div class="resumo-valor">${diasAtivos}</div>
                <div class="resumo-label">Dias ativos</div>
            </div>
            <div class="resumo-item">
                <div class="resumo-valor meta">${mediaDiaria}</div>
                <div class="resumo-label">M√©dia por dia</div>
            </div>
            <div class="resumo-item">
                <div class="resumo-valor streak">${streakDiasAtivos}</div>
                <div class="resumo-label">Dias consecutivos ‚òÄÔ∏è</div>
            </div>
        </div>
    `;
    
    container.innerHTML += resumoHTML;
    
    const sessoesMes = historicoSanitizado.filter(s => {
        if (s.status !== 'sucesso') return false;
        const dataSessao = new Date(s.data);
        return dataSessao.getMonth() === mesAtual && dataSessao.getFullYear() === anoAtual;
    });
    
    const maisUsado = calcularMaisUsado(sessoesMes);
    
    const maisUsadoHTML = `
        <div class="mais-usado-section">
            <div class="mais-usado-header">
                <span>üìà</span>
                <span>Mais usado no m√™s</span>
            </div>
            <div class="mais-usado-content">
                <div class="mais-usado-item">
                    <span class="mais-usado-emoji">${getIconDisplayHTML(maisUsado.icone)}</span>
                    <div class="mais-usado-motivo">${maisUsado.motivo}</div>
                    <span class="mais-usado-label">Motivo mais frequente</span>
                </div>
                <div class="mais-usado-item">
                    <span class="mais-usado-emoji">${getIconDisplayHTML(maisUsado.icone)}</span>
                    <div class="mais-usado-motivo">${sessoesMes.length} sess√µes ¬∑ ${maisUsado.minutos || 0} min</div>
                    <span class="mais-usado-label">Sess√µes / Tempo</span>
                </div>
            </div>
        </div>
    `;
    
    container.innerHTML += maisUsadoHTML;
    console.debug('renderizarDashboardMensal resumo', { totalMes, diasAtivos, sessoesMes: sessoesMes.length, minutosMes: totalMes });
}

function renderizarDashboardAnual() {
    const container = document.getElementById('dashboardContainerAnual');
    container.innerHTML = '';
    
    const agora = new Date();
    const anoAtual = agora.getFullYear();
    
    const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
    const minutosPorMes = Array(12).fill(0);
    
    const historicoSanitizado = sanitizeHistorico();
    historicoSanitizado.forEach(sessao => {
        if (sessao.status === 'sucesso') {
            const dataSessao = new Date(sessao.data);
            if (dataSessao.getFullYear() === anoAtual) {
                const mes = dataSessao.getMonth();
                minutosPorMes[mes] += Number(sessao.minutos || 0);
            }
        }
    });
    
    const maxMinutos = Math.max(...minutosPorMes, 1000);
    
    // 1. Primeiro adicionar os meses (gr√°ficos)
    meses.forEach((mesNome, index) => {
        const minutos = minutosPorMes[index];
        const porcentagem = Math.min((minutos / maxMinutos) * 100, 100);
        const isMesAtual = index === agora.getMonth();
        
        const mesElement = document.createElement('div');
        mesElement.className = 'dia-semana';
        
        mesElement.innerHTML = `
            <div class="dia-label">${mesNome}</div>
            <div class="dia-barra-container">
                <div class="dia-barra ${isMesAtual ? 'hoje' : ''}" style="width: ${porcentagem}%"></div>
                <div class="dia-valor">${minutos} min</div>
            </div>
        `;
        
        container.appendChild(mesElement);
    });
    
    // 2. Depois adicionar o resumo
    const totalAno = minutosPorMes.reduce((a, b) => a + b, 0);
    const mesesAtivos = minutosPorMes.filter(m => m > 0).length;
    const mediaMensal = mesesAtivos > 0 ? Math.round(totalAno / mesesAtivos) : 0;
    
    const resumoHTML = `
        <div class="dashboard-resumo">
            <div class="resumo-item">
                <div class="resumo-valor total">${totalAno}</div>
                <div class="resumo-label">Minutos no ano</div>
            </div>
            <div class="resumo-item">
                <div class="resumo-valor">${mesesAtivos}</div>
                <div class="resumo-label">Meses ativos</div>
            </div>
            <div class="resumo-item">
                <div class="resumo-valor meta">${mediaMensal}</div>
                <div class="resumo-label">M√©dia por m√™s</div>
            </div>
        </div>
    `;
    
    container.innerHTML += resumoHTML;
    
    // 3. Por √∫ltimo a se√ß√£o "Mais usado"
    const sessoesAno = historicoSanitizado.filter(s => {
        if (s.status !== 'sucesso') return false;
        const dataSessao = new Date(s.data);
        return dataSessao.getFullYear() === anoAtual;
    });
    
    const maisUsado = calcularMaisUsado(sessoesAno);
    
    const maisUsadoHTML = `
        <div class="mais-usado-section">
            <div class="mais-usado-header">
                <span>üìà</span>
                <span>Mais usado no ano</span>
            </div>
            <div class="mais-usado-content">
                <div class="mais-usado-item">
                    <span class="mais-usado-emoji">${getIconDisplayHTML(maisUsado.icone)}</span>
                    <div class="mais-usado-motivo">${maisUsado.motivo}</div>
                    <span class="mais-usado-label">Motivo mais frequente</span>
                </div>
                <div class="mais-usado-item">
                    <span class="mais-usado-emoji">${getIconDisplayHTML(maisUsado.icone)}</span>
                    <div class="mais-usado-motivo">${sessoesAno.length} sess√µes ¬∑ ${maisUsado.minutos || 0} min</div>
                    <span class="mais-usado-label">Sess√µes / Tempo</span>
                </div>
            </div>
        </div>
    `;
    
    container.innerHTML += maisUsadoHTML;
    console.debug('renderizarDashboardAnual resumo', { totalAno, mesesAtivos, sessoesAno: sessoesAno.length, minutosAno: totalAno });
    
    // Animar as barras
    setTimeout(() => {
        container.querySelectorAll('.dia-barra').forEach((barra, index) => {
            const minutos = minutosPorMes[index];
            const porcentagem = Math.min((minutos / maxMinutos) * 100, 100);
            barra.style.width = `${porcentagem}%`;
        });
    }, 100);
}

function obterEmojiEstagio(emojiFinal) {
    // --- L√≥gica Espec√≠fica para Modo Fundo do Mar ---
    // Se o modo Fundo do Mar estiver ativo, a progress√£o √© sempre bolhas
    if (modoFundoMar) {
        return 'ü´ß';
    }

    // --- L√≥gica Padr√£o (Existente) ---
    // Mapeamento de progress√£o removido; usar heur√≠sticas padr√£o para est√°gio
    
    const emoji = emojiFinal;
    const plantas = ['üå≤','üå≥','üå¥','üåµ','üåæ','üåø','‚òòÔ∏è','üåª','üåπ','üå∑','üçÑ','üçÑ‚Äçüü´','ü™¥'];
    if (plantas.includes(emoji)) return 'üå±';
    
    const construcoes = ['üè†','üèØ','üè∞','‚õ™Ô∏è','‚õ©Ô∏è','üõñ','üïå','üõï','üóº'];
    if (construcoes.includes(emoji)) return 'üèóÔ∏è';
    
    const natal = ['üéÑ','üéÅ','üéÖ','ü§∂','‚õÑ','‚ùÑÔ∏è','ü¶å'];
    if (natal.includes(emoji)) return 'üå≤';
    
    return '‚è≥Ô∏è';
}

function evoluirEmoji(emojiFinal) {
    // Progress√£o removida ‚Äî retornar o emoji final diretamente
    return emojiFinal;
}

function startTimer() { 
    if(alvo === null) { 
        showModal({ 
            text: "Escolha primeiro um espa√ßo no jardim para sua planta crescer! üå±", 
            onConfirm: () => {} 
        }); 
        return; 
    }
    
    // Ativar manuten√ß√£o de tela se configurado
    if (manterTelaAtiva) {
        gerenciarTelaAtiva(true);
    }
    
    solicitarPermissaoNotificacao();
    
    document.getElementById('painelInteligencia').style.display = 'none'; 
    document.getElementById('btnStart').style.display = 'none';
    const btnManual = document.getElementById('btnAdicionarManual');
    if (btnManual) btnManual.style.display = 'none';
    document.getElementById('btnParar').style.display = 'block';
    atualizarBotoes();
    
    if (!mostrarAvisoInicio) {
        iniciarTimer();
    } else {
        openStartFocusModal();
    }
}

function toggleTelaAtiva() {
    manterTelaAtiva = !manterTelaAtiva;
    StorageSeguro.set('manterTelaAtiva', manterTelaAtiva);
    
    const btn = document.getElementById('btnTelaAtiva');
    if (btn) btn.classList.toggle('on', manterTelaAtiva);
    
    if (!manterTelaAtiva && wakeLock) {
        gerenciarTelaAtiva(false);
    }
}

function solicitarPermissaoNotificacao() {
    if ('Notification' in window) {
        if (Notification.permission === 'default') {
            Notification.requestPermission().then(function(permission) {
                console.log('Permiss√£o de notifica√ß√£o:', permission);
            });
        }
    }
}

function enviarNotificacaoPlantaCresceu() {
    if ('Notification' in window && Notification.permission === 'granted') {
        try {
            const notificacao = new Notification('üå± Garden Focus', {
                body: 'Sua planta cresceu! Parab√©ns pela sess√£o de foco! üéâ',
                icon: 'https://www.iconpacks.net/icons/2/free-tree-icon-1578-thumb.png',
                tag: 'planta-cresceu',
                requireInteraction: true,
                silent: false
            });
            
            notificacao.onclick = function() {
                window.focus();
                notificacao.close();
            };
        } catch (e) {
            if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                navigator.serviceWorker.ready.then(function(registration) {
                    registration.showNotification('üå± Garden Focus', {
                        body: 'Sua planta cresceu! Parab√©ns pela sess√£o de foco! üéâ',
                        icon: 'https://www.iconpacks.net/icons/2/free-tree-icon-1578-thumb.png',
                        tag: 'planta-cresceu',
                        requireInteraction: true
                    });
                });
            }
          }
    }
}

function toggleNatal() { 
    modoNatal = !modoNatal; 
    if(modoNatal) {
        if (modoFundoMar) {
            StorageSeguro.set('jardimAquatico', jardimData);
        }
        modoMedieval = false;
        modoCandyfornia = false;
        modoEurosummer = false;
        modoFundoMar = false;
    }
    StorageSeguro.set('modoNatal', modoNatal); 
    StorageSeguro.set('modoMedieval', modoMedieval);
    StorageSeguro.set('modoCandyfornia', modoCandyfornia);
    StorageSeguro.set('modoEurosummer', modoEurosummer);
    StorageSeguro.set('modoFundoMar', modoFundoMar);
    
    // Carrega grid de terra imediatamente
    initJardimData();
    
    criarParticulas(); 
    applyNatalUI(); 
    applyMedievalUI(); 
    applyCandyforniaUI();
    applyEurosummerUI();
    applyFundoMarUI();
    
    const btnNatal = document.getElementById('btnNatal');
    const btnMedieval = document.getElementById('btnMedievalLoja');
    const btnCandy = document.getElementById('btnCandyforniaLoja');
    const btnEuro = document.getElementById('btnEurosummerLoja');
    const btnFundoMar = document.getElementById('btnFundoMarLoja');

    if (btnNatal) btnNatal.classList.toggle('on', modoNatal);
    if (btnMedieval) btnMedieval.classList.toggle('on', modoMedieval);
    if (btnCandy) btnCandy.classList.toggle('on', modoCandyfornia);
    if (btnEuro) btnEuro.classList.toggle('on', modoEurosummer);
    if (btnFundoMar) btnFundoMar.classList.toggle('on', modoFundoMar);

    verificarBotoesPetsLoja();

    const pool = modoNatal ? ITENS_NATAL : ITENS_PADRAO;
    escolhido = pool[0];

    setLuckyPlant(); 
    renderJardim();
}


function toggleMedieval() {
    if (!medievalComprado) return;
    modoMedieval = !modoMedieval;
    if(modoMedieval) {
        if (modoFundoMar) {
            StorageSeguro.set('jardimAquatico', jardimData);
        }
        modoNatal = false;
        modoCandyfornia = false;
        modoEurosummer = false;
        modoFundoMar = false;
    }
    StorageSeguro.set('modoMedieval', modoMedieval);
    StorageSeguro.set('modoNatal', modoNatal);
    StorageSeguro.set('modoCandyfornia', modoCandyfornia);
    StorageSeguro.set('modoEurosummer', modoEurosummer);
    StorageSeguro.set('modoFundoMar', modoFundoMar);
    
    // Carrega grid de terra imediatamente
    initJardimData();
    
    criarParticulas(); 
    applyMedievalUI(); 
    applyNatalUI();
    applyCandyforniaUI();
    applyEurosummerUI();
    applyFundoMarUI();

    const btnNatal = document.getElementById('btnNatal');
    const btnMedieval = document.getElementById('btnMedievalLoja');
    const btnCandy = document.getElementById('btnCandyforniaLoja');
    const btnEuro = document.getElementById('btnEurosummerLoja');
    const btnFundoMar = document.getElementById('btnFundoMarLoja');

    if (btnNatal) btnNatal.classList.toggle('on', modoNatal);
    if (btnMedieval) btnMedieval.classList.toggle('on', modoMedieval);
    if (btnCandy) btnCandy.classList.toggle('on', modoCandyfornia);
    if (btnEuro) btnEuro.classList.toggle('on', modoEurosummer);
    if (btnFundoMar) btnFundoMar.classList.toggle('on', modoFundoMar);

    verificarBotoesPetsLoja();

    const pool = modoMedieval ? ITENS_MEDIEVAL : ITENS_PADRAO;
    escolhido = pool[0];

    setLuckyPlant(); 
    renderJardim();
}


function toggleCandyfornia() {
    if (!candyforniaComprado) return;
    
    modoCandyfornia = !modoCandyfornia;
    if(modoCandyfornia) {
        if (modoFundoMar) {
            StorageSeguro.set('jardimAquatico', jardimData);
        }
        modoNatal = false;
        modoMedieval = false;
        modoEurosummer = false;
        modoFundoMar = false;
    }
    StorageSeguro.set('modoCandyfornia', modoCandyfornia);
    StorageSeguro.set('modoNatal', modoNatal);
    StorageSeguro.set('modoMedieval', modoMedieval);
    StorageSeguro.set('modoEurosummer', modoEurosummer);
    StorageSeguro.set('modoFundoMar', modoFundoMar);
    
    // Carrega grid de terra imediatamente
    initJardimData();
    
    criarParticulas();
    applyCandyforniaUI();
    applyNatalUI();
    applyMedievalUI();
    applyEurosummerUI();
    applyFundoMarUI();

    const btnNatal = document.getElementById('btnNatal');
    const btnMedieval = document.getElementById('btnMedievalLoja');
    const btnCandy = document.getElementById('btnCandyforniaLoja');
    const btnEuro = document.getElementById('btnEurosummerLoja');
    const btnFundoMar = document.getElementById('btnFundoMarLoja');

    if (btnNatal) btnNatal.classList.toggle('on', modoNatal);
    if (btnMedieval) btnMedieval.classList.toggle('on', modoMedieval);
    if (btnCandy) btnCandy.classList.toggle('on', modoCandyfornia);
    if (btnEuro) btnEuro.classList.toggle('on', modoEurosummer);
    if (btnFundoMar) btnFundoMar.classList.toggle('on', modoFundoMar);

    verificarBotoesPetsLoja();

    const pool = modoCandyfornia ? ITENS_CANDYFORNIA : ITENS_PADRAO;
    escolhido = pool[0];

    setLuckyPlant(); 
    renderJardim();
}

function toggleEurosummer() {
    if (!eurosummerComprado) return;
    
    modoEurosummer = !modoEurosummer;
    if(modoEurosummer) {
        // Se estava no fundo do mar, salva antes de sair
        if (modoFundoMar) {
            StorageSeguro.set('jardimAquatico', jardimData);
        }

        modoNatal = false;
        modoMedieval = false;
        modoCandyfornia = false;
        modoFundoMar = false; // Garante sa√≠da do mar

        if (!vistoIntroEurosummer) {
            setTimeout(() => {
                showModal({
                    text: "üèõÔ∏è <b>Bem-vindo √† Riviera Italiana</b><br><br>O sol brilha sobre as ru√≠nas antigas...",
                    onConfirm: () => {
                        vistoIntroEurosummer = true;
                        StorageSeguro.set('vistoIntroEurosummer', true);
                    }
                });
            }, 500);
        }
    }
    
    StorageSeguro.set('modoEurosummer', modoEurosummer);
    StorageSeguro.set('modoNatal', modoNatal);
    StorageSeguro.set('modoMedieval', modoMedieval);
    StorageSeguro.set('modoCandyfornia', modoCandyfornia);
    StorageSeguro.set('modoFundoMar', modoFundoMar);
    
    // 4. ATUALIZAR DADOS IMEDIATAMENTE (Carrega grid de terra)
    initJardimData();
    
    criarParticulas();
    applyEurosummerUI();
    applyNatalUI();
    applyMedievalUI();
    applyCandyforniaUI();
    applyFundoMarUI();

    const btnNatal = document.getElementById('btnNatal');
    const btnMedieval = document.getElementById('btnMedievalLoja');
    const btnCandy = document.getElementById('btnCandyforniaLoja');
    const btnEuro = document.getElementById('btnEurosummerLoja');
    const btnFundoMar = document.getElementById('btnFundoMarLoja');
    
    if (btnNatal) btnNatal.classList.toggle('on', modoNatal);
    if (btnMedieval) btnMedieval.classList.toggle('on', modoMedieval);
    if (btnCandy) btnCandy.classList.toggle('on', modoCandyfornia);
    if (btnEuro) btnEuro.classList.toggle('on', modoEurosummer);
    if (btnFundoMar) btnFundoMar.classList.toggle('on', modoFundoMar);

    verificarBotoesPetsLoja();

    // Atualizar planta escolhida
    const pool = modoEurosummer ? (eurosummerEmojisDesbloqueados.length > 0 ? eurosummerEmojisDesbloqueados : ITENS_PADRAO) : ITENS_PADRAO;
    escolhido = pool[0];

    setLuckyPlant();
    renderJardim();
}

function abrirPopUpEscolhaGuia() {
    const overlay = document.createElement('div');
    overlay.id = 'escolhaGuiaOverlay';
    overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100000;
        animation: fadeIn 0.3s ease;
    `;
    
    const popup = document.createElement('div');
    popup.className = 'guia-escolha-popup';
    popup.style.cssText = `
        background: var(--bg-panel, #ffffff);
        border-radius: 20px;
        padding: 30px;
        max-width: 400px;
        width: 90%;
        text-align: center;
        box-shadow: 0 15px 45px rgba(0, 0, 0, 0.2);
    `;
    
    popup.innerHTML = `
        <h2 style="color: var(--primary, #4CAF50); margin-bottom: 20px;">üåä Escolha seu Guia</h2>
        <p style="color: var(--text-main, #333); margin-bottom: 20px;">
            Algu√©m te salvou... Quem est√° diante de voc√™ agora?
        </p>
        <div style="display: flex; justify-content: space-around; gap: 20px;">
            <div onclick="escolherSereia()" style="cursor: pointer; transition: transform 0.3s;">
                <div style="font-size: 60px; color: var(--primary, #4CAF50); margin-bottom: 10px;">üßú‚Äç‚ôÄÔ∏è</div>
                <p style="font-weight: bold; color: var(--text-main, #333);">Sereia</p>
            </div>
            <div onclick="escolherTritao()" style="cursor: pointer; transition: transform 0.3s;">
                <div style="font-size: 60px; color: var(--primary, #4CAF50); margin-bottom: 10px;">üßú‚Äç‚ôÇÔ∏è</div>
                <p style="font-weight: bold; color: var(--text-main, #333);">Trit√£o</p>
            </div>
        </div>
    `;
    
    overlay.appendChild(popup);
    document.body.appendChild(overlay);
    
    // Anima√ß√£o de fade-in
    const style = document.createElement('style');
    style.setAttribute('data-popup-type', 'escolha');
    style.textContent = `
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        #escolhaGuiaOverlay { animation: fadeIn 0.3s ease; }
    `;
    document.head.appendChild(style);
    
    // Fechar pop-up ao clicar fora
    overlay.onclick = (e) => {
        if (e.target === overlay) {
            document.body.removeChild(overlay);
            document.head.removeChild(style);
        }
    };
}

function escolherSereia() {
    guiaEscolhidoFundoMar = 'üßú‚Äç‚ôÄÔ∏è';
    vistoIntroFundoMar = true;
    StorageSeguro.set('guiaEscolhidoFundoMar', 'üßú‚Äç‚ôÄÔ∏è');
    StorageSeguro.set('vistoIntroFundoMar', true);
    
    // Fechar pop-up de escolha
    const overlay = document.getElementById('escolhaGuiaOverlay');
    if (overlay) {
        document.body.removeChild(overlay);
        const style = document.querySelector('style[data-popup-type="escolha"]');
        if (style) document.head.removeChild(style);
    }
    
    // Abrir pop-up de confirma√ß√£o
    abrirPopUpConfirmaSereia();
}

function escolherTritao() {
    guiaEscolhidoFundoMar = 'üßú‚Äç‚ôÇÔ∏è';
    vistoIntroFundoMar = true;
    StorageSeguro.set('guiaEscolhidoFundoMar', 'üßú‚Äç‚ôÇÔ∏è');
    StorageSeguro.set('vistoIntroFundoMar', true);
    
    // Fechar pop-up de escolha
    const overlay = document.getElementById('escolhaGuiaOverlay');
    if (overlay) {
        document.body.removeChild(overlay);
        const style = document.querySelector('style[data-popup-type="escolha"]');
        if (style) document.head.removeChild(style);
    }
    
    // Abrir pop-up de confirma√ß√£o
    abrirPopUpConfirmaTritao();
}

function abrirPopUpConfirmaSereia() {
    const overlay = document.createElement('div');
    overlay.id = 'confirmaSereiaOverlay';
    overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100001;
        animation: fadeIn 0.3s ease;
    `;
    
    const popup = document.createElement('div');
    popup.className = 'guia-confirma-popup';
    popup.style.cssText = `
        background: var(--bg-panel, #ffffff);
        border-radius: 20px;
        padding: 30px;
        max-width: 400px;
        width: 90%;
        text-align: center;
        box-shadow: 0 15px 45px rgba(0, 0, 0, 0.2);
    `;
    
    popup.innerHTML = `
        <h3 style="color: var(--primary, #4CAF50); margin-bottom: 20px;">üßú‚Äç‚ôÄÔ∏è Sereia</h3>
        <p style="color: var(--text-main, #333); margin-bottom: 30px;">
            "Bem-vindo. Este recife j√° foi o cora√ß√£o do oceano, mas agora est√° morrendo. Sinto que sua energia pode nos ajudar a traz√™-lo de volta. Vamos come√ßar?"
        </p>
        <button onclick="confirmarSereia()" style="background: var(--primary, #4CAF50); color: white; border: none; padding: 12px 35px; border-radius: 50px; font-weight: bold; cursor: pointer; transition: all 0.3s; ">
            Confirmar
        </button>
    `;
    
    overlay.appendChild(popup);
    document.body.appendChild(overlay);
    
    // Anima√ß√£o de fade-in
    const style = document.createElement('style');
    style.setAttribute('data-popup-type', 'confirma-sereia');
    style.textContent = `
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        #confirmaSereiaOverlay { animation: fadeIn 0.3s ease; }
    `;
    document.head.appendChild(style);
    
    // Fechar pop-up ao clicar fora
    overlay.onclick = (e) => {
        if (e.target === overlay) {
            document.body.removeChild(overlay);
            document.head.removeChild(style);
            // Reativar o pop-up de escolha se o usu√°rio cancelar
            abrirPopUpEscolhaGuia();
        }
    };
}

function abrirPopUpConfirmaTritao() {
    const overlay = document.createElement('div');
    overlay.id = 'confirmaTritaoOverlay';
    overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100001;
        animation: fadeIn 0.3s ease;
    `;
    
    const popup = document.createElement('div');
    popup.className = 'guia-confirma-popup';
    popup.style.cssText = `
        background: var(--bg-panel, #ffffff);
        border-radius: 20px;
        padding: 30px;
        max-width: 400px;
        width: 90%;
        text-align: center;
        box-shadow: 0 15px 45px rgba(0, 0, 0, 0.2);
    `;
    
    popup.innerHTML = `
        <h3 style="color: var(--primary, #4CAF50); margin-bottom: 20px;">üßú‚Äç‚ôÇÔ∏è Trit√£o</h3>
        <p style="color: var(--text-main, #333); margin-bottom: 30px;">
            "Voc√™ sobreviveu √† f√∫ria do mar. Este lugar est√° em ru√≠nas, mas h√° uma for√ßa em voc√™ que eu n√£o via h√° s√©culos. Ajude-me a restaurar este recife e eu te guiarei pelas profundezas."
        </p>
        <button onclick="confirmarTritao()" style="background: var(--primary, #4CAF50); color: white; border: none; padding: 12px 35px; border-radius: 50px; font-weight: bold; cursor: pointer; transition: all 0.3s; ">
            Confirmar
        </button>
    `;
    
    overlay.appendChild(popup);
    document.body.appendChild(overlay);
    
    // Anima√ß√£o de fade-in
    const style = document.createElement('style');
    style.setAttribute('data-popup-type', 'confirma-tritao');
    style.textContent = `
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        #confirmaTritaoOverlay { animation: fadeIn 0.3s ease; }
    `;
    document.head.appendChild(style);
    
    // Fechar pop-up ao clicar fora
    overlay.onclick = (e) => {
        if (e.target === overlay) {
            document.body.removeChild(overlay);
            document.head.removeChild(style);
            // Reativar o pop-up de escolha se o usu√°rio cancelar
            abrirPopUpEscolhaGuia();
        }
    };
}

function confirmarSereia() {
    // Salvar escolha
    guiaEscolhidoFundoMar = 'üßú‚Äç‚ôÄÔ∏è';
    vistoIntroFundoMar = true;
    StorageSeguro.set('guiaEscolhidoFundoMar', 'üßú‚Äç‚ôÄÔ∏è');
    StorageSeguro.set('vistoIntroFundoMar', true);
    
    // ATUALIZA√á√ÉO IMEDIATA DO ROMANCE MANAGER
    RomanceManager.setPartner('üßú‚Äç‚ôÄÔ∏è');

    // Fechar pop-up de confirma√ß√£o
    const overlay = document.getElementById('confirmaSereiaOverlay');
    if (overlay) {
        document.body.removeChild(overlay);
        const style = document.querySelector('style[data-popup-type="confirma-sereia"]');
        if (style) document.head.removeChild(style);
    }
    
    // Atualizar a UI
    renderJardim();
}
function confirmarTritao() {
    // Salvar escolha
    guiaEscolhidoFundoMar = 'üßú‚Äç‚ôÇÔ∏è';
    vistoIntroFundoMar = true;
    StorageSeguro.set('guiaEscolhidoFundoMar', 'üßú‚Äç‚ôÇÔ∏è');
    StorageSeguro.set('vistoIntroFundoMar', true);
    
    // ATUALIZA√á√ÉO IMEDIATA DO ROMANCE MANAGER
    RomanceManager.setPartner('üßú‚Äç‚ôÇÔ∏è');
    
    // Fechar pop-up de confirma√ß√£o
    const overlay = document.getElementById('confirmaTritaoOverlay');
    if (overlay) {
        document.body.removeChild(overlay);
        const style = document.querySelector('style[data-popup-type="confirma-tritao"]');
        if (style) document.head.removeChild(style);
    }
    
    // Atualizar a UI
    renderJardim();
}


function toggleFundoMar() {
    if (!fundoMarComprado) return;
    
    // 1. SALVAR O ESTADO ATUAL ANTES DE TROCAR
    if (modoFundoMar) {
        // Estamos saindo da √°gua: Salva o aqu√°tico atual
        StorageSeguro.set('jardimAquatico', jardimData);
    } else {
        // Estamos entrando na √°gua: Salva o normal (terrestre) atual
        StorageSeguro.set('jardim', jardimData);
    }

    // 2. INVERTER O MODO E DESLIGAR OUTROS
    modoFundoMar = !modoFundoMar;
    if (modoFundoMar) {
        modoNatal = false;
        modoMedieval = false;
        modoCandyfornia = false;
        modoEurosummer = false;
        
        // Adicionar novos motivos se necess√°rio
        const novosMotivos = ['Hidrata√ß√£o', 'Postura', 'Medita√ß√£o', 'Skincare', 'Desconex√£o'];
        let motivosAtualizados = false;
        novosMotivos.forEach(m => {
            if (!motivos.includes(m)) {
                motivos.push(m);
                motivosAtualizados = true;
            }
        });
        if (motivosAtualizados) {
            StorageSeguro.set('motivos', motivos);
            preencherSelectsMetas();
            renderSelects();
        }

        if (!vistoIntroFundoMar) {
            setTimeout(() => { abrirPopUpEscolhaGuia(); }, 500);
        }
    }

    // 3. PERSISTIR ESTADOS
    StorageSeguro.set('modoFundoMar', modoFundoMar);
    StorageSeguro.set('modoNatal', modoNatal);
    StorageSeguro.set('modoMedieval', modoMedieval);
    StorageSeguro.set('modoCandyfornia', modoCandyfornia);
    StorageSeguro.set('modoEurosummer', modoEurosummer);
    
    // 4. ATUALIZAR INTERFACE E DADOS IMEDIATAMENTE
    initJardimData(); // For√ßa carregamento do grid correto (Terra ou Mar)
    
    criarParticulas();
    applyFundoMarUI();
    applyEurosummerUI();
    applyNatalUI();
    applyMedievalUI();
    applyCandyforniaUI();

    // Atualizar bot√µes
    const btnNatal = document.getElementById('btnNatal');
    const btnMedieval = document.getElementById('btnMedievalLoja');
    const btnCandy = document.getElementById('btnCandyforniaLoja');
    const btnEuro = document.getElementById('btnEurosummerLoja');
    const btnFundoMar = document.getElementById('btnFundoMarLoja');
    
    if (btnNatal) btnNatal.classList.toggle('on', modoNatal);
    if (btnMedieval) btnMedieval.classList.toggle('on', modoMedieval);
    if (btnCandy) btnCandy.classList.toggle('on', modoCandyfornia);
    if (btnEuro) btnEuro.classList.toggle('on', modoEurosummer);
    if (btnFundoMar) btnFundoMar.classList.toggle('on', modoFundoMar);

    verificarBotoesPetsLoja();

    // Atualizar planta escolhida
    const pool = modoFundoMar ? (fundoMarEmojisDesbloqueados.length > 0 ? fundoMarEmojisDesbloqueados : ITENS_PADRAO) : ITENS_PADRAO;
    escolhido = pool[0];
    
    setLuckyPlant();
    
    // 5. RENDERIZA√á√ÉO IMEDIATA
    renderJardim();
}

function reiniciarFundoMar() {
    showModal({ 
        text: "‚ö†Ô∏è Desejas reiniciar a tua hist√≥ria no Fundo do Mar?<br><br>As tuas metas conclu√≠das do modo Fundo do Mar voltar√£o a zero e as mem√≥rias ser√£o guardadas novamente. Os emojis j√° plantados no jardim permanecer√£o.", 
        onConfirm: () => {
            fundoMarMetasConcluidas = [];
            fundoMarEmojisDesbloqueados = [];
            vistoIntroFundoMar = false;
            StorageSeguro.set('fundoMarMetasConcluidas', []);
            StorageSeguro.set('fundoMarEmojisDesbloqueados', []);
            StorageSeguro.set('vistoIntroFundoMar', false);
            
            // RESETAR O ROMANCE TAMB√âM
            RomanceManager.reset();
            guiaEscolhidoFundoMar = null;
            StorageSeguro.set('guiaEscolhidoFundoMar', null);

            // Abandonar animais marinhos
            const animaisMarinhos = ['üêã', 'üê†', 'üêü', 'üê°', 'üêô', 'ü¶≠', 'üê¢', 'ü¶¶', 'üßú‚Äç‚ôÇÔ∏è', 'üßú‚Äç‚ôÄÔ∏è'];
            petsComprados = petsComprados.filter(p => !animaisMarinhos.includes(p.icone));
            petsEmCena = petsEmCena.filter(p => !animaisMarinhos.includes(p.icone));
            StorageSeguro.set('petsComprados', petsComprados);

            // Se o modo estiver ativo, resetar a planta escolhida para o padr√£o e desativar o modo
            if (modoFundoMar) {
                escolhido = ITENS_PADRAO[0];
                StorageSeguro.set('plantaEscolhida', escolhido);
                if (typeof updatePlantButtonSprite === 'function') updatePlantButtonSprite();
                
                modoFundoMar = false;
                StorageSeguro.set('modoFundoMar', false);
                
                // CORRE√á√ÉO: For√ßar recarregamento do jardim terrestre ao resetar e sair
                jardimDataNormal = StorageSeguro.get('jardim', Array(getTotalCells()).fill(null));
                jardimData = jardimDataNormal;
                
                // Atualizar UI imediatamente
                applyFundoMarUI();
                const btnFundoMar = document.getElementById('btnFundoMarLoja');
                if (btnFundoMar) btnFundoMar.classList.remove('on');
                
                initJardimData();
                renderJardim();
            }
            
            setTimeout(() => {
                showModal({ 
                    text: "üåä Hist√≥ria reiniciada! As mem√≥rias do oceano aguardam por ti novamente.", 
                    onConfirm: () => {
                        renderMetasFundoMar();
                        if (modoFundoMar) applyFundoMarUI();
                    } 
                });
            }, 300);
        }
    });
}

function applyCandyforniaUI() {
    if(modoCandyfornia) {
        document.body.classList.add('candyfornia-mode');
    } else {
        document.body.classList.remove('candyfornia-mode');
    }
}

function applyEurosummerUI() {
    const btnCorreio = document.getElementById('btnCorreioEurosummer');
    if(modoEurosummer) {
        document.body.classList.add('eurosummer-mode');
        if (btnCorreio) btnCorreio.style.display = 'flex';
    } else {
        document.body.classList.remove('eurosummer-mode');
        if (btnCorreio) btnCorreio.style.display = 'none';
    }
}

function applyFundoMarUI() {
    const btnMetas = document.getElementById('btnMetasFundoMar');
    const btnCorreio = document.getElementById('btnCorreioFundoMar');
    const painelMetas = document.getElementById('painelMetasFundoMar');
    
    if(modoFundoMar) {
        document.body.classList.add('fundo-mar-mode');
        if (btnMetas) btnMetas.style.display = 'flex';
        if (btnCorreio) btnCorreio.style.display = 'flex';
        renderMetasFundoMar();
        // Garantir que as part√≠culas iniciem imediatamente ao ativar o modo
        if (typeof particulasManager !== 'undefined') {
            particulasManager.iniciar();
        }
    } else {
        document.body.classList.remove('fundo-mar-mode');
        if (btnMetas) btnMetas.style.display = 'none';
        if (btnCorreio) btnCorreio.style.display = 'none';
        if (painelMetas) painelMetas.style.display = 'none';
    }
}

/// Vari√°vel de controle do listener
let listenerFecharMetasFundoMar = null;

// Injeta o estilo de anima√ß√£o de sa√≠da (Slide Out) automaticamente
// Isto garante que o efeito funciona sem teres de editar o CSS manualmente
const styleSheetFundoMar = document.createElement("style");
styleSheetFundoMar.innerText = `
    @keyframes slideOutRight {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
`;
document.head.appendChild(styleSheetFundoMar);

function toggleMetasFundoMar() {
    const painel = document.getElementById('painelMetasFundoMar');
    const btn = document.getElementById('btnMetasFundoMar');
    
    if (!painel) return;

    // Verifica se est√° vis√≠vel
    const estaFechado = painel.style.display === 'none' || painel.style.display === '';

    if (estaFechado) {
        // === ABRIR ===
        renderMetasFundoMar();
        painel.style.display = 'block';
        // For√ßa a anima√ß√£o de entrada
        painel.style.animation = 'slideInRight 0.3s ease forwards';

        // L√≥gica do clique fora (igual √† anterior)
        if (listenerFecharMetasFundoMar) {
            document.removeEventListener('click', listenerFecharMetasFundoMar);
        }

        listenerFecharMetasFundoMar = function(event) {
            if (!painel.contains(event.target) && event.target !== btn && !btn.contains(event.target)) {
                toggleMetasFundoMar(); 
            }
        };

        setTimeout(() => {
            document.addEventListener('click', listenerFecharMetasFundoMar);
        }, 100);

    } else {
        // === FECHAR COM FADE OUT ===
        
        // 1. Aplica a anima√ß√£o de sa√≠da
        painel.style.animation = 'slideOutRight 0.3s ease forwards';

        // 2. Remove o listener imediatamente para evitar conflitos
        if (listenerFecharMetasFundoMar) {
            document.removeEventListener('click', listenerFecharMetasFundoMar);
            listenerFecharMetasFundoMar = null;
        }

        // 3. Aguarda o tempo da anima√ß√£o (300ms) antes de esconder o elemento
        setTimeout(() => {
            // S√≥ esconde se o utilizador n√£o tiver clicado para abrir novamente neste meio tempo
            if (painel.style.animationName === 'slideOutRight') {
                painel.style.display = 'none';
            }
        }, 280); // 280ms para garantir que n√£o pisca no final
    }
}


function renderMetasFundoMar() {
    const lista = document.getElementById('listaMetasFundoMar');
    if (!lista) return;
    
    lista.innerHTML = '';
    
    // Encontrar a pr√≥xima meta n√£o conclu√≠da
    let proximaMetaId = -1;
    for (let i = 0; i < METAS_FUNDO_MAR.length; i++) {
        if (!fundoMarMetasConcluidas.includes(METAS_FUNDO_MAR[i].id)) {
            proximaMetaId = METAS_FUNDO_MAR[i].id;
            break;
        }
    }
    
    METAS_FUNDO_MAR.forEach(meta => {
        const concluida = fundoMarMetasConcluidas.includes(meta.id);
        const isProxima = meta.id === proximaMetaId;
        const bloqueada = !concluida && !isProxima;
        
        const item = document.createElement('div');
        item.className = `meta-item-fundo ${concluida ? 'concluida' : ''} ${bloqueada ? 'bloqueada' : ''} ${isProxima ? 'proxima' : ''}`;        
        
        item.innerHTML = `
            <div class="meta-emoji">${concluida ? meta.emoji : (isProxima ? 'üéØ' : '‚ùì')}</div>
            <div class="meta-info">
                <strong>${bloqueada ? '???' : meta.motivo}</strong><br>
                <span>${bloqueada ? '???' : meta.tempo + ' minutos'}</span>
            </div>
            <div class="meta-status">${concluida ? '‚úÖ' : (isProxima ? 'üîì' : 'üîí')}</div>
        `;
        
        lista.appendChild(item);
    });
}

function abrirCorreioFundoMar() {
    if (fundoMarMetasConcluidas.length === 0) {
        showModal({ text: "üåä O teu correio do mar ainda est√° vazio. Completa as metas do oceano para receber a tua primeira mem√≥ria.", onConfirm: () => {} });
        return;
    }

    let html = `
        <div style="max-height: 400px; overflow-y: auto; padding-right: 10px; text-align: left;">
            <h3 style="color: #4cc9f0; text-align: center; margin-bottom: 20px;">üêö Mem√≥rias do Oceano</h3>
    `;

    // Ordenar metas conclu√≠das por ID
    const metasOrdenadas = [...METAS_FUNDO_MAR]
        .filter(m => fundoMarMetasConcluidas.includes(m.id))
        .sort((a, b) => a.id - b.id);

    metasOrdenadas.forEach(meta => {
        html += `
            <div style="background: rgba(0, 53, 102, 0.5); border: 1px solid #4cc9f0; border-radius: 12px; padding: 15px; margin-bottom: 15px;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <span style="font-size: 24px;">${meta.emoji}</span>
                    <strong style="color: #4cc9f0;">Mem√≥ria #${meta.id}</strong>
                </div>
                <p style="color: #ffffff; font-size: 14px; line-height: 1.6; margin: 0; font-style: italic;">
                    "${meta.texto}"
                </p>
                <div style="margin-top: 10px; font-size: 11px; color: #90e0ef; opacity: 0.8;">
                    üéØ Conquistada em: ${meta.motivo} (${meta.tempo} min)
                </div>
            </div>
        `;
    });

    html += `</div>`;

    showModal({
        text: html,
        onConfirm: () => {}
    });
}

function applyNatalUI() { 
    if(modoNatal) { document.body.classList.add('natal-mode'); } 
    else { document.body.classList.remove('natal-mode'); } 
}

function applyMedievalUI() {
    if(modoMedieval) { document.body.classList.add('medieval-mode'); }
    else { document.body.classList.remove('medieval-mode'); }
}

function toggleDarkMode() { 
    // 1. Ao clicar no bot√£o manual, DESATIVAMOS o modo autom√°tico obrigatoriamente
    temaAutomaticoAtivo = false;
    StorageSeguro.set('temaAutomaticoAtivo', false);
    
    // 2. Atualiza o visual do bot√£o switch do "Auto Tema" para desligado
    const btnTemaAuto = document.getElementById('btnTemaAuto');
    if (btnTemaAuto) {
        btnTemaAuto.classList.remove('on');
    }
    
    // 3. Alterna a classe no corpo do site
    const isDark = document.body.classList.toggle('dark-mode');
    
    // 4. Salva a prefer√™ncia do usu√°rio (true ou false)
    StorageSeguro.set('darkMode', isDark);
    
    // 5. Ajustes visuais extras
    renderEstrelasNoCeu();
    
    // 6. Atualiza o texto do bot√£o principal
    const btnTema = document.getElementById('btnTema');
    if (btnTema) {
        if (isDark) {
            btnTema.textContent = 'üåô';
            btnTema.title = 'Alternar para modo claro';
        } else {
            btnTema.textContent = '‚òÄÔ∏è';
            btnTema.title = 'Alternar para modo escuro';
        }
    }
}

function toggleTemaAuto() {
    const btn = document.getElementById('btnTemaAuto');
    
    // 1. Inverte o valor atual
    temaAutomaticoAtivo = !temaAutomaticoAtivo;
    
    // 2. Salva o novo valor
    StorageSeguro.set('temaAutomaticoAtivo', temaAutomaticoAtivo);
    
    // 3. Atualiza o visual do bot√£o switch
    if (btn) btn.classList.toggle('on', temaAutomaticoAtivo);
    
    if (temaAutomaticoAtivo) {
        // Se ativou, roda a verifica√ß√£o de hora imediatamente
        verificarTemaAutomatico();
        
        // Exibe um feedback visual r√°pido
        showModal({ 
            text: "üïí Modo Autom√°tico Ativado!<br><br>O tema mudar√° sozinho:<br>‚òÄÔ∏è Claro: 06:00 - 18:00<br>üåô Escuro: 18:00 - 06:00", 
            onConfirm: () => {} 
        });
    }
}


function toggleMenu() { document.getElementById('abaEsquerda').classList.toggle('aberto'); }

function fecharMenuSeAberto(event) {
    const menu = document.getElementById('abaEsquerda');
    const menuBtn = document.getElementById('abrirMenuBtn');
    if (menu.classList.contains('aberto') && !menu.contains(event.target) && event.target !== menuBtn) {
        menu.classList.remove('aberto');
    }
}





function renderJardim() {
    // Sempre renderiza em 3D - modo 2D removido
    jardimData = modoFundoMar ? jardimDataAquatico : jardimDataNormal;
    
    // Garantir que o jardim 3D esteja vis√≠vel
    const jardim3D = document.getElementById('jardim3D');
    if (jardim3D) jardim3D.style.display = 'block';
    
    renderJardim3D();
    atualizarVisibilidadeBtnExpand();
}

function abrirModalPlanta(index = null) {
    // Se foi passado um √≠ndice, bloqueia se for caminho
    if (index !== null && jardimData[index] && ehCaminhoEmoji(jardimData[index].icone)) {
        document.getElementById('painelMotivo').style.display = 'block';
        document.getElementById('textoMotivo').textContent = `Focado em: ${jardimData[index].motivo || 'Decora√ß√£o'}`;
        showToast('‚ö†Ô∏è', 'Imposs√≠vel plantar', 'Voc√™ n√£o pode plantar em cima de caminhos.');
        console.warn('abrirModalPlanta bloqueado: c√©lula com caminho no √≠ndice', index);
        return;
    }

    // Se o √≠ndice foi informado, atualiza alvo e renderiza; caso contr√°rio mant√©m alvo atual (pode ser null)
    if (index !== null) {
        setAlvo(index);
    }

    // Exibe mensagem de aviso quando n√£o h√° alvo selecionado
    const aviso = document.getElementById('avisoEscolhaLocal');
    if (aviso) {
        if (alvo === null) {
            aviso.style.display = 'block';
        } else {
            aviso.style.display = 'none';
        }
    }

    const p = document.getElementById('paletaModal');
    const pe = document.getElementById('paletaEspecialModal');
    
    p.innerHTML = ''; pe.innerHTML = '';
    
    // Se estiver no modo Fundo do Mar, a paleta padr√£o (terrestre) fica vazia
    if (!modoFundoMar) {
        // Adiciona os tipos de rio customizados √† paleta
        const itensComRios = [...ITENS_PADRAO, AGUA_RIO, AGUA_RIO_MARGEM];
        itensComRios.forEach(i => { 
            let d = document.createElement('div'); d.className = 'item' + (i === escolhido ? ' selecionado' : ''); 
            // Mostrar a textura (imagem) para QUALQUER item que seja caminho, mantendo emojis para os demais
            if (ehCaminhoEmoji(i)) {
                const imgSrc = gerarTexturaCaminho({norte:false,sul:false,oeste:false,leste:false}, i);
                d.innerHTML = `<img src="${imgSrc}" alt="${i}" style="width:28px;height:28px;display:block;margin:0 auto;">`;
            } else if (['arvore-rosa','arvore-roxa','arvore-amarela','arvore-branca','arvore-colmeia','arvore-frutifera'].includes(i)) {
                const svgThumb = gerarSpriteArvore(i);
                d.innerHTML = `<img src="${svgThumb}" alt="${i}" style="width:28px;height:28px;display:block;margin:0 auto;">`;
            } else if (i === 'poste-luz') {
                const svgThumb = gerarSpritePosteLuz(i);
                d.innerHTML = `<img src="${svgThumb}" alt="${i}" style="width:28px;height:28px;display:block;margin:0 auto;">`;
            } else if (i === 'banco-praca') {
                const svgThumb = gerarSpriteBancoPraca(i);
                d.innerHTML = `<img src="${svgThumb}" alt="${i}" style="width:28px;height:28px;display:block;margin:0 auto;">`;
            } else if (i === 'piquenique') {
                const svgThumb = gerarSpritePiquenique(i);
                d.innerHTML = `<img src="${svgThumb}" alt="${i}" style="width:28px;height:28px;display:block;margin:0 auto;">`;
            } else if (i === 'gazebo') {
                const svgThumb = gerarSpriteGazebo(i);
                d.innerHTML = `<img src="${svgThumb}" alt="${i}" style="width:28px;height:28px;display:block;margin:0 auto;">`;
            } else if (i === 'lago') {
                const svgThumb = gerarSpriteLago(i);
                d.innerHTML = `<img src="${svgThumb}" alt="${i}" style="width:28px;height:28px;display:block;margin:0 auto;">`;
            } else if (i === 'torre') {
                const svgThumb = gerarSpriteTorre(i);
                d.innerHTML = `<img src="${svgThumb}" alt="${i}" style="width:28px;height:28px;display:block;margin:0 auto;">`;
            } else if (i === 'casa') {
                const svgThumb = gerarSpriteCasa(i);
                d.innerHTML = `<img src="${svgThumb}" alt="${i}" style="width:28px;height:28px;display:block;margin:0 auto;">`;
            } else {
                d.textContent = i;
            }
            addTapHandler(d, (e) => { 
                if (e && e.stopPropagation) e.stopPropagation();
                escolhido = i; 
                StorageSeguro.set('plantaEscolhida', escolhido); // Salvar planta selecionada
                if (typeof updatePlantButtonSprite === 'function') updatePlantButtonSprite();
                fecharModal('modalPlantaOverlay'); 
                renderJardim(); 
                atualizarBotoes();
            });
            d.setAttribute('data-tap-bound', '1');
            p.appendChild(d); 
        });
    } else {
        p.innerHTML = '<small style="opacity:0.5; padding:15px;">Itens terrestres ocultos no modo aqu√°tico.</small>';
    }

    // Filtrar o pool especial para garantir que itens aqu√°ticos s√≥ apare√ßam no modo aqu√°tico
    let especialPool = [];
    if (modoFundoMar) {
        especialPool = [...ITENS_FUNDO_MAR_BASE, ...fundoMarEmojisDesbloqueados];
    } else {
        // Se N√ÉO for modo aqu√°tico, pegamos os itens dos outros modos (Eurosummer, Candy, Natal, Medieval)
        // mas EXCLU√çMOS qualquer item que possa ser considerado aqu√°tico se houver sobreposi√ß√£o
        especialPool = (modoEurosummer ? eurosummerEmojisDesbloqueados : (modoCandyfornia ? ITENS_CANDYFORNIA : (modoNatal ? ITENS_NATAL : (modoMedieval ? ITENS_MEDIEVAL : []))));
    }

    if(especialPool.length === 0) {
        pe.innerHTML = '<small style="opacity:0.5; padding:15px;">Nenhum modo especial ativo.</small>';
    } else {
        especialPool.forEach(i => {
            let d = document.createElement('div'); d.className = 'item' + (i === escolhido ? ' selecionado' : ''); 
            if (i === 'arvore-rosa') {
                const svgThumb = gerarSpriteArvore(i);
                d.innerHTML = `<img src="${svgThumb}" alt="${i}" style="width:28px;height:28px;display:block;margin:0 auto;">`;
            } else {
                d.textContent = i; 
            }
            addTapHandler(d, (e) => { 
                if (e && e.stopPropagation) e.stopPropagation();
                escolhido = i; 
                StorageSeguro.set('plantaEscolhida', escolhido); // Salvar planta selecionada
                if (typeof updatePlantButtonSprite === 'function') updatePlantButtonSprite();
                fecharModal('modalPlantaOverlay'); 
                renderJardim(); 
                atualizarBotoes();
            });
            d.setAttribute('data-tap-bound', '1');
            pe.appendChild(d); 
        });
    }
    
    abrirModal('modalPlantaOverlay');
}

function salvarTudo() { 
    if (modoFundoMar) {
        jardimDataAquatico = jardimData;
        StorageSeguro.set('jardimAquatico', jardimDataAquatico);
    } else {
        jardimDataNormal = jardimData;
        StorageSeguro.set('jardim', jardimDataNormal);
    }
    StorageSeguro.set('sessoesTotais', sessoesTotais); 
    StorageSeguro.set('historico_foco', historico); 
    StorageSeguro.set('moedasFoco', totalMoedas);
    StorageSeguro.set('streakDiasAtivos', streakDiasAtivos);
    renderJardim();
}

function renderSelects() { 
	    const st = document.getElementById('tempoEscolhido'), sm = document.getElementById('motivoEscolhido'); 
	    
	    // 1. Carregar valores salvos
	    const savedTempo = StorageSeguro.get('ultimoTempo', null);
	    const savedMotivo = StorageSeguro.get('ultimoMotivo', null);
	    
	    st.innerHTML = ''; 
	    tempos.sort((a,b)=>a-b).forEach(t => st.add(new Option(t + " min", t))); 
	    sm.innerHTML = ''; motivos.forEach(m => sm.add(new Option(m, m))); 
	    
	    // 2. Aplicar valores salvos ou o primeiro da lista
	    if(savedTempo) st.value = savedTempo; 
	    if(savedMotivo) sm.value = savedMotivo; 
	    
	    // 3. Adicionar listeners para salvar ao mudar
	    st.onchange = () => StorageSeguro.set('ultimoTempo', st.value);
	    sm.onchange = () => StorageSeguro.set('ultimoMotivo', sm.value);
	    
    atualizarTimerDisplay(); 
    renderGerenciamento();
}

function renderGerenciamento() {
    const listaTempos = document.getElementById('listaGerenciarTempos');
    const listaMotivos = document.getElementById('listaGerenciarMotivos');
    
    if (!listaTempos || !listaMotivos) return;

    // Renderizar Tempos
    listaTempos.innerHTML = '';
    
    // Bot√£o Adicionar Tempo
    const btnAddT = document.createElement('div');
    btnAddT.style.cssText = 'background: var(--primary); padding: 8px 15px; border-radius: 50px; border: 1px solid var(--primary); display: flex; align-items: center; gap: 5px; font-size: 14px; color: white; box-shadow: 0 2px 4px var(--shadow); cursor: pointer; font-weight: bold;';
    btnAddT.innerHTML = `<span>+ Adicionar</span>`;
    btnAddT.onclick = () => promptCustom('Novo tempo (min):', true, addTempo);
    listaTempos.appendChild(btnAddT);

    tempos.sort((a, b) => a - b).forEach(t => {
        const item = document.createElement('div');
        item.style.cssText = 'background: var(--bg-body); padding: 8px 15px; border-radius: 50px; border: 1px solid var(--primary); display: flex; align-items: center; gap: 10px; font-size: 14px; color: var(--text-main); box-shadow: 0 2px 4px var(--shadow);';
        item.innerHTML = `
            <span style="font-weight: 500;">${t} min</span>
            <span onclick="removerTempoEspecifico(${t})" style="color: #ff5252; cursor: pointer; font-weight: bold; font-size: 18px; padding: 0 5px;">√ó</span>
        `;
        listaTempos.appendChild(item);
    });

    // Renderizar Motivos
    listaMotivos.innerHTML = '';

    // Bot√£o Adicionar Motivo
    const btnAddM = document.createElement('div');
    btnAddM.style.cssText = 'background: var(--primary); padding: 8px 15px; border-radius: 50px; border: 1px solid var(--primary); display: flex; align-items: center; gap: 5px; font-size: 14px; color: white; box-shadow: 0 2px 4px var(--shadow); cursor: pointer; font-weight: bold;';
    btnAddM.innerHTML = `<span>+ Adicionar</span>`;
    btnAddM.onclick = () => promptCustom('Novo motivo:', false, addMotivo);
    listaMotivos.appendChild(btnAddM);

    motivos.forEach(m => {
        const item = document.createElement('div');
        item.style.cssText = 'background: var(--bg-body); padding: 8px 15px; border-radius: 50px; border: 1px solid var(--primary); display: flex; align-items: center; gap: 10px; font-size: 14px; color: var(--text-main); box-shadow: 0 2px 4px var(--shadow);';
        item.innerHTML = `
            <span style="font-weight: 500;">${m}</span>
            <span onclick="removerMotivoEspecifico('${m}')" style="color: #ff5252; cursor: pointer; font-weight: bold; font-size: 18px; padding: 0 5px;">√ó</span>
        `;
        listaMotivos.appendChild(item);
    });
}

function removerTempoEspecifico(v) {
    if (tempos.length <= 1) {
        showModal({ text: "Voc√™ precisa ter pelo menos um tempo configurado.", onConfirm: () => {} });
        return;
    }
    showModal({
        text: `Deseja excluir o tempo de ${v} min?`,
        onConfirm: () => {
            tempos = tempos.filter(t => t !== v);
            StorageSeguro.set('tempos', tempos);
            renderSelects();
        }
    });
}

function removerMotivoEspecifico(m) {
    if (motivos.length <= 1) {
        showModal({ text: "Voc√™ precisa ter pelo menos um motivo configurado.", onConfirm: () => {} });
        return;
    }
    showModal({
        text: `Deseja excluir o motivo "${m}"?`,
        onConfirm: () => {
            motivos = motivos.filter(mot => mot !== m);
            StorageSeguro.set('motivos', motivos);
            renderSelects();
        }
    });
}

function toggleTodoPopup() {
	    const popup = document.getElementById('todoPopup');
	    const btn = document.getElementById('btnTodoToggle');
	    const isAtivo = popup.classList.toggle('ativo');
	    btn.classList.toggle('ativo');
	    
	    // Salvar estado no localStorage
	    StorageSeguro.set('todoPopupAtivo', isAtivo);
	}

function renderTodos() { 
    const l = document.getElementById('listaTodo'); 
    if (!l) return;
    l.innerHTML = ''; 
    todos.forEach((t, i) => { 
        let d = document.createElement('div'); d.className = 'todo-item'; 
        d.innerHTML = `<input type="checkbox" ${t.done?'checked':''} onchange="todos[${i}].done=!todos[${i}].done; StorageSeguro.set('todos', todos); renderTodos()"> <span style="${t.done ? 'text-decoration: line-through; opacity: 0.6;' : ''}">${t.texto}</span> <button style="border-radius: 50px;" onclick="todos.splice(${i},1); StorageSeguro.set('todos', todos); renderTodos()">√ó</button>`; 
        l.appendChild(d); 
    }); 
}

function addTodo() { let i = document.getElementById('novoTodo'); if(i.value.trim()){ todos.push({texto:i.value, done:false}); i.value=''; renderTodos(); } }

function abrirConfig() { 
    // Garantir que os bot√µes estejam atualizados
    setTimeout(() => {
        atualizarBotoesConfig();
    }, 50);
    
    
    
    abrirModal('configOverlay'); 
}
// =========================
// SISTEMA DE METAS
// =========================
function toggleMetas() {
    const container = document.getElementById('metasContainer');
    const btn = document.getElementById('btnMetasToggle');
    const isAtivo = container.classList.toggle('ativo');
    btn.classList.toggle('ativo', isAtivo);
    StorageSeguro.set('metasPopupAtivo', isAtivo);
    
    if (isAtivo) {
        preencherSelectsMetas();
    }
}

function preencherSelectsMetas() {
    const selectMotivo = document.getElementById('metaMotivo');
    const selectTempo = document.getElementById('metaTempo');
    
    selectMotivo.innerHTML = '';
    selectTempo.innerHTML = '';
    
    motivos.forEach(motivo => {
        const option = document.createElement('option');
        option.value = motivo;
        option.textContent = motivo;
        selectMotivo.appendChild(option);
    });
    
    tempos.sort((a,b) => a-b).forEach(tempo => {
        const option = document.createElement('option');
        option.value = tempo;
        option.textContent = `${tempo} min`;
        selectTempo.appendChild(option);
    });
    
    if (motivos.length > 0) selectMotivo.value = motivos[0];
    if (tempos.length > 0) selectTempo.value = tempos[0];
}

function adicionarMeta() {
    const motivo = document.getElementById('metaMotivo').value;
    const tempo = document.getElementById('metaTempo').value;
    
    if (!motivo || !tempo) {
        showModal({ text: "Selecione um motivo e um tempo para criar uma meta.", onConfirm: () => {} });
        return;
    }
    
    const novaMeta = {
        id: Date.now(),
        motivo: motivo,
        tempo: parseInt(tempo),
        concluida: false,
        totalSessoes: 1,
        sessoesConcluidas: 0,
        dataCriacao: new Date().toISOString()
    };
    
    metas.push(novaMeta);
    StorageSeguro.set('metas', metas);
    renderMetas();
}

function renderMetas() {
    const container = document.getElementById('listaMetas');
    container.innerHTML = '';
    
    if (metas.length === 0) {
        container.innerHTML = '<div style="padding: 10px; text-align: center; color: var(--text-secondary); font-size: 11px;">Nenhuma meta definida ainda.</div>';
        return;
    }
    
    metas.forEach((meta, index) => {
        const metaElement = document.createElement('div');
        metaElement.className = 'todo-item';
        metaElement.style.borderLeft = `4px solid ${meta.concluida ? '#4caf50' : '#ff9800'}`;
        
        const progressoPercent = meta.totalSessoes > 0 ? Math.round((meta.sessoesConcluidas / meta.totalSessoes) * 100) : 0;
        
        metaElement.innerHTML = `
            <div style="flex: 1;">
                <div style="font-size: 11px; font-weight: bold; color: ${meta.concluida ? '#4caf50' : 'var(--text-main)'};">
                    ${meta.motivo} - ${meta.tempo} min
                </div>
                <div style="font-size: 10px; color: var(--text-secondary); margin-top: 2px;">
                    ${meta.sessoesConcluidas}/${meta.totalSessoes} sess√µes conclu√≠das
                </div>
                ${meta.totalSessoes > 0 ? `
                    <div style="margin-top: 3px; height: 4px; background: var(--bg-body); border-radius: 2px; overflow: hidden;">
                        <div style="height: 100%; width: ${progressoPercent}%; background: ${meta.concluida ? '#4caf50' : '#ff9800'};"></div>
                    </div>
                ` : ''}
            </div>
            <div style="display: flex; gap: 5px;">
                <button onclick="concluirMeta(${index})" style="min-width: 24px; min-height: 24px; padding: 0; background: ${meta.concluida ? '#4caf50' : '#666'}; font-size: 10px; border-radius: 50px; ">‚úì</button>
                <button onclick="removerMeta(${index})" style="min-width: 24px; min-height: 24px; padding: 0; background: #ff5252; font-size: 10px; border-radius: 50px; ">√ó</button>
            </div>
        `;
        
        container.appendChild(metaElement);
    });
}

function concluirMeta(index) {
    metas[index].concluida = !metas[index].concluida;
    StorageSeguro.set('metas', metas);
    renderMetas();
}

function removerMeta(index) {
    showModal({
        text: "Tem certeza que deseja excluir esta meta?",
        onConfirm: () => {
            metas.splice(index, 1);
            StorageSeguro.set('metas', metas);
            renderMetas();
        }
    });
}

function verificarMetasConcluidas(motivo, tempo) {
    metas.forEach((meta, index) => {
        if (!meta.concluida && meta.motivo === motivo && meta.tempo === tempo) {
            metas[index].sessoesConcluidas += 1;
            
            if (metas[index].sessoesConcluidas >= metas[index].totalSessoes) {
                metas[index].concluida = true;
                
                // Habilidade Macaco: +10 moedas ao concluir metas
                let bonusMeta = 0;
                if (petsComprados.some(p => p.icone === 'üêí')) {
                    bonusMeta = 10;
                    updateMoedas(bonusMeta);
                }
                
                const mensagemBonus = bonusMeta > 0 ? `<br><br>üêí Macaco te deu +${bonusMeta} moedas!` : '';
                showModal({
                    text: `üéâ Meta conclu√≠da!<br><br>Voc√™ completou ${meta.totalSessoes} sess√£o(√µes) de ${motivo} por ${tempo} minutos!${mensagemBonus}`,
                    onConfirm: () => {}
                });
            }
        }
    });
}

function verificarMetasFundoMar(motivo, tempo) {
    if (!modoFundoMar) return;
    // Normalizar strings para compara√ß√£o
    const motivoNormalizado = motivo.trim();
    const tempoNormalizado = parseInt(tempo);
    // Verificar se alguma meta foi cumprida
    METAS_FUNDO_MAR.forEach(meta => {
        // Se a meta j√° foi conclu√≠da, pular
        if (fundoMarMetasConcluidas.includes(meta.id)) return;
        // Verificar se o motivo e tempo correspondem √† meta
        if (meta.motivo === motivoNormalizado && meta.tempo === tempoNormalizado) {
            // Meta conclu√≠da!
            fundoMarMetasConcluidas.push(meta.id);
           
            mostrarCartaFundoMar(meta);
            // Atualizar painel de metas
            renderMetasFundoMar();
        }
    });
}
function melhorarAcessibilidade() {
    const botoes = document.querySelectorAll('button:not([aria-label])');
    botoes.forEach(botao => {
        const texto = botao.textContent || botao.innerHTML;
        if (texto.trim() && !botao.getAttribute('aria-label')) {
            botao.setAttribute('aria-label', texto.replace(/[^a-zA-Z√Ä-√ø0-9\s]/g, ' ').trim());
        }
    });
    
    document.getElementById('abrirMenuBtn').setAttribute('aria-label', 'Abrir menu');
    document.getElementById('btnTema').setAttribute('aria-label', 'Alternar tema claro/escuro');
    
    document.querySelectorAll('.plot').forEach((plot, i) => {
        if (!plot.getAttribute('aria-label')) {
            const item = jardimData[i];
            if (item) {
                plot.setAttribute('aria-label', `Planta: ${item.icone}, Motivo: ${item.motivo}`);
            } else {
                plot.setAttribute('aria-label', `Espa√ßo vazio ${i+1}, clique para plantar`);
            }
        }
    });
}

// Helper: touch/click "tap" listener ‚Äî aceita toque ou clique e ignora movimentos (drag)
function addTapHandler(el, handler, opts = {}) {
    const threshold = opts.moveThreshold || 10;
    let startX = 0, startY = 0, moved = false, lastTouch = 0;

    el.addEventListener('touchstart', (ev) => {
        if (ev.touches && ev.touches.length > 1) { moved = true; return; }
        moved = false;
        startX = ev.touches ? ev.touches[0].clientX : 0;
        startY = ev.touches ? ev.touches[0].clientY : 0;
    }, { passive: true });

    el.addEventListener('touchmove', (ev) => {
        if (!ev.touches || !ev.touches[0]) { moved = true; return; }
        const dx = Math.abs(ev.touches[0].clientX - startX);
        const dy = Math.abs(ev.touches[0].clientY - startY);
        if (dx > threshold || dy > threshold) moved = true;
    }, { passive: true });

    el.addEventListener('touchend', (ev) => {
        if (moved) return;
        lastTouch = Date.now();
        ev.preventDefault();
        handler.call(el, ev);
    });

    el.addEventListener('click', (ev) => {
        // Ignore click synthesized after touch
        if (Date.now() - lastTouch < 500) return;
        handler.call(el, ev);
    });
}

// ==========================================
// SISTEMA DE PETS 3D - VERS√ÉO FINAL COM NOMES
// ==========================================

function processarCompraPet(icone, preco, btnId) {
    const precoFinal = calcularPrecoFinal(preco, null, icone);
    const animaisMarinhos = ['üêã', 'üê†', 'üêü', 'üê°', 'üêô', 'ü¶≠', 'üê¢', 'ü¶¶', 'üßú‚Äç‚ôÇÔ∏è', 'üßú‚Äç‚ôÄÔ∏è'];
    
    // Bloqueio de Animais Aqu√°ticos por Metas
    const animaisBloqueadosPorMeta = ['üêü', 'üê†', 'üê°', 'üêô', 'üê¢', 'ü¶¶', 'üßú‚Äç‚ôÄÔ∏è', 'üßú‚Äç‚ôÇÔ∏è', 'ü¶≠', 'üêã'];
    if (animaisBloqueadosPorMeta.includes(icone)) {
        const metaRelacionada = METAS_FUNDO_MAR.find(m => m.petGratis === icone || (m.escolhaEspecial && (icone === 'üßú‚Äç‚ôÄÔ∏è' || icone === 'üßú‚Äç‚ôÇÔ∏è')));
        if (metaRelacionada && !fundoMarMetasConcluidas.includes(metaRelacionada.id)) {
            showModal({ text: "üîí <strong>Animal Bloqueado!</strong><br>Este animal s√≥ pode ser adotado ap√≥s cumprir a meta correspondente no Fundo do Mar.", onConfirm: () => {} });
            return;
        }
        // Bloqueio extra para o guia n√£o escolhido
        if (metaRelacionada && metaRelacionada.escolhaEspecial && icone !== guiaEscolhidoFundoMar) {
            showModal({ text: "üîí <strong>Acesso Negado!</strong><br>Voc√™ j√° escolheu outro guia para esta jornada.", onConfirm: () => {} });
            return;
        }
    }
    const isMarinho = animaisMarinhos.includes(icone);

    // O limite de 2 animais s√≥ se aplica a animais terrestres
    if (!isMarinho && petsComprados.filter(p => !animaisMarinhos.includes(p.icone)).length >= LIMITE_PETS) {
        showModal({ text: "üö® <strong>Limite atingido!</strong><br>Voc√™ s√≥ pode ter 2 animais terrestres.", onConfirm: () => {} });
        return;
    }
    if (petsComprados.some(p => p.icone === icone)) {
        showModal({ text: "Voc√™ j√° adotou um desse!", onConfirm: () => {} });
        return;
    }

    if (totalMoedas >= precoFinal) {
        // Criar o pop-up de nome manualmente
        const overlay = document.createElement('div');
        overlay.id = "petPopupOverlay";
        overlay.style = "position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:199999; display:flex; align-items:center; justify-content:center;";
        
        const popup = document.createElement('div');
        popup.className = "pet-name-popup";
        popup.innerHTML = `
            <div style="font-size:40px">${icone}</div>
            <h3>Nome do Pet</h3>
            <input type="text" id="tempPetName" placeholder="Ex: Tot√≥" maxlength="12">
            <button style="border-radius: 50px;" id="btnConfirmarPet">Adotar</button>
        `;
        
        overlay.appendChild(popup);
        document.body.appendChild(overlay);

        // Focar no input automaticamente
        const input = document.getElementById('tempPetName');
        input.focus();

        // L√≥gica ao clicar no bot√£o confirmar
        document.getElementById('btnConfirmarPet').onclick = () => {
            const nomeDigitado = input.value.trim();
            const nomeFinal = nomeDigitado !== "" ? nomeDigitado : "Bichinho";
            
            // Finalizar Compra - Verifica√ß√£o final de saldo
            if (totalMoedas >= precoFinal) {
                updateMoedas(-precoFinal);
                const novoPet = { icone: icone, nome: nomeFinal };
                petsComprados.push(novoPet);
                StorageSeguro.set('petsComprados', petsComprados);
                
                setLuckyPlant(); // Atualiza visibilidade da sorte (Girafa)
                adicionarPetNaCena(novoPet);
                verificarBotoesPetsLoja();
                
                // Fechar e avisar
                document.body.removeChild(overlay);
                showModal({ text: `üéâ <strong>${nomeFinal}</strong> foi adotado!`, onConfirm: () => {} });
            } else {
                document.body.removeChild(overlay);
                showModal({ text: "Moedas insuficientes!", onConfirm: () => {} });
            }
        };

        // Fechar ao clicar fora (opcional)
        overlay.onclick = (e) => {
            if(e.target === overlay) document.body.removeChild(overlay);
        };
    } else {
        showModal({ text: "Moedas insuficientes.", onConfirm: () => {} });
    }
}

function moverPetsLoop() {
    let mudouAlgo = false;
    const gridSize = getGridSize();
    const animaisMarinhos = ['üêã', 'üê†', 'üêü', 'üê°', 'üêô', 'ü¶≠', 'üê¢', 'ü¶¶', 'üßú‚Äç‚ôÇÔ∏è', 'üßú‚Äç‚ôÄÔ∏è'];
    
    petsEmCena.forEach(pet => {
        const isMarinho = animaisMarinhos.includes(pet.icone);

        // L√≥gica de permiss√£o de movimento: Pets e c√¥njuge se movem em qualquer modo
        // Removida a restri√ß√£o que impedia marinhos de se moverem na terra ou terrestres no mar

        if (pet.pausado) return;
        
        if (Math.random() > 0.3) {
            const vizinhos = [];
            const x = pet.index % gridSize;
            const y = Math.floor(pet.index / gridSize);

            if (y > 0) vizinhos.push(pet.index - gridSize);
            if (y < gridSize - 1) vizinhos.push(pet.index + gridSize);
            if (x > 0) vizinhos.push(pet.index - 1);
            if (x < gridSize - 1) vizinhos.push(pet.index + 1);

            const vizinhosLivres = vizinhos.filter(idx => {
                const item = jardimData[idx];
                // Se for um caminho (TIPOS_CAMINHO) mas N√ÉO for √°gua (rio/ mar / lago), permitir a passagem
                const isPathItem = item && TIPOS_CAMINHO.includes(item.icone);
                const isWaterPath = item && (item.icone === AGUA_RIO || item.icone === 'üåä' || item.icone === 'lago');

                // Se existir um 'item' que N√ÉO √© caminho permitido, bloquear (√°rvore, flor, constru√ß√£o, etc.)
                const temPlanta = item !== null && !isPathItem;
                const temOutroPet = petsEmCena.some(p => p.index === idx);
                const temTesouro = (typeof tesouroAtivoIndex !== 'undefined') && (idx === tesouroAtivoIndex);

                // Permitido apenas se n√£o houver planta verdadeira, n√£o houver outro pet, n√£o for tesouro e n√£o for caminho aqu√°tico
                return !temPlanta && !temOutroPet && !temTesouro && !isWaterPath;
            });

            if (vizinhosLivres.length > 0) {
                const novoIndex = vizinhosLivres[Math.floor(Math.random() * vizinhosLivres.length)];
                pet.index = novoIndex;
                mudouAlgo = true;
            }
        }
    });

    if (mudouAlgo) {
        renderJardim();
    }
}



// Habilidade Vaquinha: Produ√ß√£o passiva de moedas
function iniciarProducaoVaquinha() {
    // Limpar intervalo anterior se existir
    if (intervaloVaquinha) {
        clearInterval(intervaloVaquinha);
        intervaloVaquinha = null;
    }
    
    // Verificar se tem vaquinha
    if (petsComprados.some(p => p.icone === 'üêÑ')) {
        // Produz 5 moedas a cada hora (3600000 ms)
        intervaloVaquinha = setInterval(() => {
            if (petsComprados.some(p => p.icone === 'üêÑ')) {
                updateMoedas(5);
                showToast('üêÑ', 'Vaquinha produziu!', '+5 moedas');
            }
        }, 3600000); // 1 hora
    }
}

function inicializarPets() {
    // Limpa a cena antes de carregar (evita duplicados)
    petsEmCena = [];
    
    // Carrega do storage
    const salvos = StorageSeguro.get('petsComprados', []);
    petsComprados = salvos;

    petsComprados.forEach(petObj => {
        adicionarPetNaCena(petObj);
    });

    // Inicia o movimento se estiver no modo 3D
    if (!intervaloPets) {
        intervaloPets = setInterval(moverPetsLoop, 3000);
    }
    
    // Habilidade Vaquinha: Produz 5 moedas a cada hora
    iniciarProducaoVaquinha();
    
    verificarBotoesPetsLoja();
}

function adicionarPetNaCena(petObj) {
    const totalCells = getTotalCells();
    // Tenta achar um lugar vazio
    for(let i=0; i<30; i++) {
        const randIndex = Math.floor(Math.random() * totalCells);
        
        // Corre√ß√£o: Adicionado '&& randIndex !== tesouroAtivoIndex' para n√£o nascer no tesouro
        if (!jardimData[randIndex] && !petsEmCena.some(p => p.index === randIndex) && randIndex !== tesouroAtivoIndex && (typeof alvo === 'undefined' || randIndex !== alvo)) {
            // Insere o objeto com nome e √≠cone na cena
            petsEmCena.push({ ...petObj, index: randIndex });
            renderJardim3D();
            break;
        }
    }
}

function salvarNovoNomeAuto() {
    const input = document.getElementById('configNomeUsuario');
    const novoNome = input.value.trim();
    
    if (novoNome !== "") {
        StorageSeguro.set('jogadorNome', novoNome);
        
        // Atualiza a sauda√ß√£o na aba lateral instantaneamente
        const saudacao = document.getElementById('saudacaoUsuario');
        if (saudacao) saudacao.innerHTML = `Ol√°, ${novoNome}!`;
    }
}

function abandonarPet(icone) {
    const pet = petsComprados.find(p => p.icone === icone);
    if (!pet) return;

    showModal({
        text: `üò¢ Deseja realmente abandonar o(a) <strong>${pet.nome}</strong> (${pet.icone})?<br><br>Ele(a) sentir√° sua falta!`,
        onConfirm: () => {
            // Remove do array de comprados
            petsComprados = petsComprados.filter(p => p.icone !== icone);
            StorageSeguro.set('petsComprados', petsComprados);
            
            // Remove da cena (jardim)
            petsEmCena = petsEmCena.filter(p => p.icone !== icone);
            
            // Atualiza interface
            renderJardim3D();
            verificarBotoesPetsLoja();
            setLuckyPlant();
            
            showModal({ text: "O animal de estima√ß√£o foi embora. üçÉ", onConfirm: () => {} });
        }
    });
}function trocarAbaLoja(aba) {
    // Esconder todas as abas
    document.getElementById('conteudoTema').style.display = 'none';
    document.getElementById('conteudoPets').style.display = 'none';
    document.getElementById('conteudoJogos').style.display = 'none';
    
    // Resetar estilos dos bot√µes
    document.getElementById('abaTema').style.background = 'transparent';
    document.getElementById('abaTema').style.color = 'var(--text-main)';
    document.getElementById('abaPets').style.background = 'transparent';
    document.getElementById('abaPets').style.color = 'var(--text-main)';
    document.getElementById('abaJogos').style.background = 'transparent';
    document.getElementById('abaJogos').style.color = 'var(--text-main)';
    
    // Mostrar aba selecionada e destacar bot√£o
    if (aba === 'tema') {
        document.getElementById('conteudoTema').style.display = 'block';
        document.getElementById('abaTema').style.background = 'var(--primary)';
        document.getElementById('abaTema').style.color = 'white';
    } else if (aba === 'pets') {
        document.getElementById('conteudoPets').style.display = 'block';
        document.getElementById('abaPets').style.background = 'var(--primary)';
        document.getElementById('abaPets').style.color = 'white';
    } else if (aba === 'jogos') {
        document.getElementById('conteudoJogos').style.display = 'block';
        document.getElementById('abaJogos').style.background = 'var(--primary)';
        document.getElementById('abaJogos').style.color = 'white';
    }
}

function atualizarSaldoLoja() {
    document.getElementById('saldoLojaMoedasTopo').textContent = totalMoedas;
}

function verificarBotoesPetsLoja() {
    // Atualizar saldo na loja imediatamente
    const saldoLoja = document.getElementById('saldoLojaMoedas');
    if (saldoLoja) saldoLoja.textContent = totalMoedas;

    // IDs dos bot√µes da loja
    const ids = [
        { id: 'btnPetDuck1', preco: 50, icone: 'ü¶Ü' },
        { id: 'btnPetGoose', preco: 60, icone: 'ü™ø' },
        { id: 'btnPetDog1', preco: 80, icone: 'üêï' },
        { id: 'btnPetCat1', preco: 80, icone: 'üêà' },
        { id: 'btnPetPig', preco: 100, icone: 'üêñ' },
        { id: 'btnPetOwl', preco: 120, icone: 'ü¶â' },
        { id: 'btnPetBeaver', preco: 130, icone: 'ü¶´' },
        { id: 'btnPetMonkey', preco: 150, icone: 'üêí' },
        { id: 'btnPetLlama', preco: 160, icone: 'ü¶ô' },
        { id: 'btnPetCow', preco: 180, icone: 'üêÑ' },
        { id: 'btnPetPeacock', preco: 200, icone: 'ü¶ö' },
        { id: 'btnPetLeopard', preco: 220, icone: 'üêÜ' },
        { id: 'btnPetGiraffe', preco: 250, icone: 'ü¶í' },
        { id: 'btnPetReindeer', preco: 150, icone: 'ü¶å' },
        { id: 'btnPetWhale', preco: 200, icone: 'üêã' },
        { id: 'btnPetTropicalFish', preco: 60, icone: 'üê†' },
        { id: 'btnPetFish', preco: 40, icone: 'üêü' },
        { id: 'btnPetBlowfish', preco: 80, icone: 'üê°' },
        { id: 'btnPetOctopus', preco: 120, icone: 'üêô' },
        { id: 'btnPetSeal', preco: 150, icone: 'ü¶≠' },
        { id: 'btnPetTurtle', preco: 100, icone: 'üê¢' },
        { id: 'btnPetOtter', preco: 120, icone: 'ü¶¶' },
        { id: 'btnPetMermaid', preco: 200, icone: 'üßú‚Äç‚ôÄÔ∏è' },
        { id: 'btnPetMerman', preco: 200, icone: 'üßú‚Äç‚ôÇÔ∏è' }
    ];
    
    const iconesAdotados = petsComprados.map(p => p.icone);
    const temPorquinho = iconesAdotados.includes('üêñ');

    // Controle de visibilidade da Rena (S√≥ aparece no Modo Natal)
    const itemLojaRena = document.getElementById('itemLojaRena');
    if (itemLojaRena) {
        itemLojaRena.style.display = modoNatal ? 'block' : 'none';
    }

    // Mostrar/Ocultar se√ß√£o de pets do Fundo do Mar
    const secaoFundoMar = document.getElementById('secaoPetsFundoMar');
    const tituloSecao = document.getElementById('tituloSecaoPets');
    
    if (secaoFundoMar) {
        secaoFundoMar.style.display = fundoMarComprado ? 'contents' : 'none';
    }

    // Ajustar t√≠tulo da se√ß√£o conforme o modo
    if (tituloSecao) {
        if (modoFundoMar) {
            tituloSecao.innerHTML = "üåä Fauna Marinha (Sem Limite de Ado√ß√£o)";
        } else {
            tituloSecao.innerHTML = "üìè Licen√ßa de Ado√ß√£o (Terrestres M√°x: 2 | Aqu√°ticos: Sem Limite)";
        }
    }

    ids.forEach(item => {
        const btn = document.getElementById(item.id);
        if (!btn) return;

        const container = btn.parentElement;

        // NOVA REGRA: Animais terrestres N√ÉO aparecem na loja no modo Fundo do Mar
        const animaisMarinhos = ['üêã', 'üê†', 'üêü', 'üê°', 'üêô', 'ü¶≠', 'üê¢', 'ü¶¶', 'üßú‚Äç‚ôÇÔ∏è', 'üßú‚Äç‚ôÄÔ∏è'];
        const isMarinho = animaisMarinhos.includes(item.icone);
        
        if (modoFundoMar) {
            // No modo aqu√°tico: MOSTRA marinhos, OCULTA terrestres
            if (!isMarinho) {
                container.style.display = "none";
                return;
            }
        } else {
            // Em QUALQUER outro modo (Normal, Natal, Medieval, etc.): MOSTRA terrestres, OCULTA marinhos
            if (isMarinho) {
                container.style.display = "none";
                return;
            }
            
            // Regra espec√≠fica para a Rena: Apenas no modo Natal
            if (item.icone === 'ü¶å' && !modoNatal) {
                container.style.display = "none";
                return;
            }
        }
        
        // Garantir que o container esteja vis√≠vel se passou pelos filtros
        container.style.display = "block";

        // Regra de exclusividade Sereia/Trit√£o
        if (fundoMarMetasConcluidas.includes(7)) {
            if ((item.icone === 'üßú‚Äç‚ôÄÔ∏è' || item.icone === 'üßú‚Äç‚ôÇÔ∏è') && item.icone !== guiaEscolhidoFundoMar) {
                container.style.display = "none";
                return;
            }
        }

        // Se passou pelos filtros acima, garante que o container esteja vis√≠vel antes de checar se j√° foi adotado
        container.style.display = "block";

        const jaAdotado = iconesAdotados.includes(item.icone);

        if (jaAdotado) {
            btn.style.display = "none";
            // Remove bot√£o de abandonar anterior se existir para evitar duplicados
            const btnAbandonarAntigo = container.querySelector('.btn-abandonar-pet');
            if (btnAbandonarAntigo) btnAbandonarAntigo.remove();

            const btnAbandonar = document.createElement('button');
            btnAbandonar.textContent = "Abandonar";
            btnAbandonar.className = "btn-abandonar-pet";
            btnAbandonar.style.backgroundColor = "#e74c3c";
            btnAbandonar.style.marginTop = "10px";
            btnAbandonar.style.width = "100%";
            btnAbandonar.onclick = () => abandonarPet(item.icone);
            container.appendChild(btnAbandonar);
        } else {
            btn.style.display = "block";
            // Atualizar Pre√ßo com Desconto usando a fun√ß√£o unificada
            const precoFinal = calcularPrecoFinal(item.preco, null, item.icone);
            const animaisBloqueadosPorMeta = ['üêü', 'üê†', 'üê°', 'üêô', 'üê¢', 'ü¶¶', 'üßú‚Äç‚ôÄÔ∏è', 'üßú‚Äç‚ôÇÔ∏è', 'ü¶≠', 'üêã'];
            if (animaisBloqueadosPorMeta.includes(item.icone) && precoFinal > 0) {
                btn.innerHTML = `BLOQUEADO üîí`;
                btn.style.color = "#e74c3c";
                btn.style.fontWeight = "bold";
                btn.disabled = true;
                btn.style.opacity = "0.6";
                btn.style.cursor = "not-allowed";
            } else if (precoFinal === 0 && item.preco > 0) {
                btn.innerHTML = `RESGATAR üéÅ`;
                btn.style.color = "#4caf50";
                btn.style.fontWeight = "bold";
                btn.disabled = false;
                btn.style.opacity = "1";
                btn.style.cursor = "pointer";
            } else if (precoFinal < item.preco) {
                btn.innerHTML = `<span style="text-decoration: line-through; opacity: 0.6; font-size: 0.8em;">${item.preco}</span> ${precoFinal} üí∞`;
                btn.style.color = "#4caf50";
                btn.style.fontWeight = "bold";
            } else {
                btn.innerHTML = `${item.preco} üí∞`;
                btn.style.color = "";
                btn.style.fontWeight = "";
            }
            
            const btnAbandonarAntigo = container.querySelector('.btn-abandonar-pet');
            if (btnAbandonarAntigo) btnAbandonarAntigo.remove();
        }
    });

    // Atualizar Pre√ßos dos Temas (Medieval, Candyfornia, Eurosummer e Fundo do Mar)
    const temas = [
        { id: 'btnComprarMedieval', preco: 50, key: 'medieval', comprado: medievalComprado },
        { id: 'btnComprarCandyfornia', preco: 80, key: 'candyfornia', comprado: candyforniaComprado },
        { id: 'btnComprarEurosummer', preco: 100, key: 'eurosummer', comprado: eurosummerComprado },
        { id: 'btnComprarFundoMar', preco: 120, key: 'fundomar', comprado: fundoMarComprado }
    ];
    
    const temCastor = iconesAdotados.includes('ü¶´');
    
    temas.forEach(tema => {
        const btn = document.getElementById(tema.id);
        if (!btn) return;
        
        if (tema.comprado) {
            btn.textContent = "J√° Adquirido";
            btn.disabled = true;
            btn.style.color = "";
            btn.style.fontWeight = "";
            btn.style.opacity = "0.7";
        } else {
            btn.disabled = false;
            btn.style.opacity = "1";
            const precoFinal = calcularPrecoFinal(tema.preco, tema.key);
            
            if (precoFinal < tema.preco) {
                btn.innerHTML = `<span style="text-decoration: line-through; opacity: 0.6; font-size: 0.8em;">${tema.preco}</span> ${precoFinal} üí∞`;
                btn.style.color = "#4caf50";
                btn.style.fontWeight = "bold";
            } else {
                btn.innerHTML = `${tema.preco} üí∞`;
                btn.style.color = "";
                btn.style.fontWeight = "";
            }
        }
    });
}

function atualizarBotoesConfig() {
    const btnSino = document.getElementById('btnSino');
    if (btnSino) {
        btnSino.classList.toggle('on', sinoAtivo);
    }

    const btnTemaAuto = document.getElementById('btnTemaAuto');
    if (btnTemaAuto) {
        btnTemaAuto.classList.toggle('on', temaAutomaticoAtivo);
    }

    const btnNatal = document.getElementById('btnNatal');
    if (btnNatal) {
        btnNatal.classList.toggle('on', modoNatal);
    }

    const btnMedieval = document.getElementById('btnMedievalLoja');
    if (btnMedieval) {
        btnMedieval.classList.toggle('on', modoMedieval);
    }

    const btnCandyfornia = document.getElementById('btnCandyforniaLoja');
    if (btnCandyfornia) {
        btnCandyfornia.classList.toggle('on', modoCandyfornia);
    }

    const btnEstrelas = document.getElementById('btnEstrelas');
    if (btnEstrelas) {
        btnEstrelas.classList.toggle('on', exibirEstrelas);
    }

    const btnAnimFundo = document.getElementById('btnAnimFundo');
    if (btnAnimFundo) {
        btnAnimFundo.classList.toggle('on', animacaoFundoAtiva);
    }

    const btnPrevisao = document.getElementById('btnPrevisao');
    if (btnPrevisao) {
        btnPrevisao.classList.toggle('on', mostrarPrevisao);
    }



    // Bot√£o 3D removido - sempre 3D

    const btnGrid10x10 = document.getElementById('btnGrid10x10Toggle');
    if (btnGrid10x10) {
        btnGrid10x10.classList.toggle('on', grid10x10);
    }
}
// =========================
// M√ìDULO: ROMANCE MANAGER (ATUALIZADO COM DI√ÅLOGOS)
// =========================
const RomanceManager = {
    data: {
        ativo: false,
        parceiroIcone: null,
        pontos: 0,
        namorando: false,
        casado: false,
        ultimoCarinhoRomantico: 0,
        perolas: 0
    },

    // Banco de Falas
    quotes: {
        0: [ // Desconhecido (0-19 pts)
            "Gratid√£o por me ajudar a restaurar este lugar.",
            "Quem √© voc√™, viajante da superf√≠cie?",
            "Nunca vi ningu√©m como voc√™ por aqui antes.",
            "Como voc√™ se chama mesmo?",
            "Ainda estou me acostumando com sua presen√ßa."
        ],
        1: [ // Conhecido (20-39 pts)
            "Como √© o mundo l√° em cima? √â muito seco?",
            "Ouvi dizer que existe uma esp√©cie de peixe no c√©u... p√°ssaros?",
            "Voc√™ trabalha muito bem nesse jardim.",
            "Gosto quando voc√™ vem me visitar.",
            "As correntes mar√≠timas trazem boas not√≠cias sobre voc√™."
        ],
        2: [ // Colega/Amigo Distante (40-59 pts)
            "Estou come√ßando a entender seus costumes estranhos.",
            "Voc√™ √© diferente dos outros humanos das lendas.",
            "Sinto que posso confiar em voc√™.",
            "As flores do seu jardim s√£o coloridas como nossos corais?",
            "Hoje o mar parece mais brilhante com voc√™ aqui."
        ],
        3: [ // Amigo Pr√≥ximo (60-79 pts)
            "Voc√™ deve estar ansioso para voltar pro seu jardim...",
            "Sua companhia √© o melhor tesouro que encontrei nestas ru√≠nas.",
            "√Äs vezes, subo at√© a superf√≠cie s√≥ para ver se te encontro.",
            "Gostaria de te mostrar os recifes profundos um dia.",
            "Nossos mundos s√£o distantes, mas n√≥s estamos perto.",
            "J√° fugi de diversos predadores apenas com a for√ßa da minha mente... voc√™ tem isso?"
        ],
        4: [ // Namorado (80-99 pts)
            "Meu bem, quando acabarem suas obriga√ß√µes por aqui... como ficar√° nossa rela√ß√£o?",
            "Vou sentir sua falta a cada segundo que estiver em terra firme.",
            "Eu te amo mais do que todas as p√©rolas do oceano.",
            "N√£o v√° embora ainda... fique mais um pouco.",
            "O mar fica cinza e frio sem o seu sorriso."
        ],
        5: [ // Noivo (100 pts - Antes de casar)
            "Descobri que posso viver contigo na terra! Conversei com uma bruxa do mar que permitir√° isso!",
            "N√£o quero mais que o mar nos separe.",
            "Aceitaria unir nossos mundos para sempre?",
            "Tenho um segredo... encontrei uma forma de ficarmos juntos.",
            "Meu cora√ß√£o bate no ritmo das mar√©s por ti."
        ],
        married: [ // Casado
            "N√£o perdi a voz, mas n√£o ganhei pernas. Pelo menos gosto dessa bolha flutuante!",
            "Adoro ver as estrelas do seu jardim contigo, meu amor.",
            "A vida na terra √© estranha, mas perfeita ao seu lado.",
            "Sinto falta do mar, mas voc√™ √© meu lar agora.",
            "Olha! Aprendi a regar as plantas sem afog√°-las!",
            "Descobri que consigo mover plantas de lugar assim como eu fazia com tubar√µes"
        ]
    },

    init: function() {
        const savedData = StorageSeguro.get('romanceData', null);
        const guia = StorageSeguro.get('guiaEscolhidoFundoMar', null);

        if (savedData) {
            this.data = Object.assign({}, this.data, savedData);
            // Sincroniza o guia caso tenha mudado na hist√≥ria
            if (guia) this.data.parceiroIcone = guia;
        } else {
            this.data.ativo = !!guia;
            this.data.parceiroIcone = guia;
            this.save();
        }
        this.injectHtml();
    },

    // Define o parceiro e ativa imediatamente
    setPartner: function(icone) {
        this.data.parceiroIcone = icone;
        this.data.ativo = true;
        this.save();
    },

    reset: function() {
        this.data = {
            ativo: false,
            parceiroIcone: null,
            pontos: 0,
            namorando: false,
            casado: false,
            ultimoCarinhoRomantico: 0,
            perolas: 0,
            telepatiaDisponivel: false
        };
        this.save();
    },

    save: function() {
        StorageSeguro.set('romanceData', this.data);
    },

    injectHtml: function() {
        if (document.getElementById('romanceOverlay')) return;
        const overlay = document.createElement('div');
        overlay.id = 'romanceOverlay';
        overlay.innerHTML = `
            <div class="romance-card">
                <div class="romance-backpack" id="romanceBackpack">
                    üîÆ <span id="perolaCount">0</span>
                </div>
                <button onclick="RomanceManager.closeMenu()" class="close-btn" style="top:10px; right:10px; border-radius: 50px;">√ó</button>
                <div id="romanceAvatar" class="romance-avatar"></div>
                <h3 id="romanceTitle" style="color:#ff4757; margin:0; font-size: 22px; font-weight: bold;"></h3>
                <small id="romanceStatus" style="color:#666; font-weight:bold; display:block; margin-top:5px; font-size: 14px;"></small>
                
                <div class="romance-hearts" id="romanceHearts"></div>

                <div id="romanceDialogue" class="romance-dialogue-box">
                    "..."
                </div>

                <div class="romance-actions">
                    <button style="border-radius: 50px;" class="btn-romance" onclick="RomanceManager.darCarinho()">
                        üíô <span>Carinho</span><small style="font-size:9px">+5 pts (Di√°rio)</small>
                    </button>
                    <button style="border-radius: 50px;" class="btn-romance" onclick="RomanceManager.darPresente()">
                        üéÅ <span>Presentear</span><small style="font-size:9px">Usa 1 P√©rola</small>
                    </button>
                    <button id="btnTelepatia" class="btn-romance" onclick="RomanceManager.toggleTelepatia()" style="display:none; grid-column: span 2; background: #e0f7fa; border-color: #4cc9f0; border-radius: 50px; ">
                        üåÄ <span>Telepatia</span><small style="font-size:9px">Mover Plantas</small>
                    </button>
                    <button id="btnNamoro" class="btn-romance btn-namoro" onclick="RomanceManager.pedirEmNamoro()" style="display:none; grid-column: span 2; border-radius: 50px;">
                        üíñ Pedir em Namoro
                    </button>
                    <button id="btnCasar" class="btn-romance btn-casar" onclick="RomanceManager.proporCasamento()" style="display:none; border-radius: 50px;">
                        üíç Propor Casamento
                    </button>
                </div>
            </div>`;
        document.body.appendChild(overlay);
    },

    handlePetClick: function(pet) {
        if (!this.data.parceiroIcone || pet.icone !== this.data.parceiroIcone) return false;
        
        if (modoFundoMar || this.data.casado) {
            this.openMenu();
            return true;
        }
        return false;
    },

    shouldShowPartnerOnLand: function(petIcone) {
        return this.data.casado && petIcone === this.data.parceiroIcone;
    },

    // L√≥gica dos t√≠tulos evolutivos
    getRelationshipLevel: function() {
        if (this.data.casado) return 'married';
        // Se n√£o estiver namorando, o n√≠vel trava em 3 (Amigo)
        if (!this.data.namorando) return Math.min(Math.floor(this.data.pontos / 20), 3);
        // Mapeia pontos (0-100) para n√≠veis (0-5)
        return Math.min(Math.floor(this.data.pontos / 20), 5);
    },

    getRelationshipTitle: function(level, icone) {
        const isFemale = icone === 'üßú‚Äç‚ôÄÔ∏è';
        
        const titles = {
            0: isFemale ? "Desconhecida" : "Desconhecido",
            1: isFemale ? "Conhecida" : "Conhecido",
            2: "Colega",
            3: isFemale ? "Amiga" : "Amigo",
            4: isFemale ? "Namorada" : "Namorado",
            5: isFemale ? "Noiva" : "Noivo"
        };
        
        if (this.data.casado) {
            return isFemale ? "Esposa" : "Marido";
        }

        return titles[level] || (isFemale ? "Desconhecida" : "Desconhecido");
    },

    getRandomQuote: function(level) {
        const possibleQuotes = this.quotes[level] || this.quotes[0];
        const randomIndex = Math.floor(Math.random() * possibleQuotes.length);
        return `"${possibleQuotes[randomIndex]}"`;
    },

    openMenu: function() {
        const overlay = document.getElementById('romanceOverlay');
        const avatar = document.getElementById('romanceAvatar');
        const titulo = document.getElementById('romanceTitle');
        const status = document.getElementById('romanceStatus');
        const dialogue = document.getElementById('romanceDialogue');
        const heartsContainer = document.getElementById('romanceHearts');
        const btnCasar = document.getElementById('btnCasar');
        const btnNamoro = document.getElementById('btnNamoro');
        const perolaCount = document.getElementById('perolaCount');

        // Atualizar Invent√°rio
        if (perolaCount) perolaCount.textContent = this.data.perolas || 0;

        // Calcular N√≠vel
        const level = this.getRelationshipLevel();
        let coracoesCheios = this.data.casado ? 5 : Math.floor(this.data.pontos / 20);
        
        // Se n√£o estiver namorando, trava em 3 cora√ß√µes (Amigo)
        if (!this.data.namorando && !this.data.casado) {
            coracoesCheios = Math.min(coracoesCheios, 3);
        }

        // Configurar Avatar e Nome
        avatar.textContent = this.data.parceiroIcone;
        const petInfo = petsComprados.find(p => p.icone === this.data.parceiroIcone);
        const nomeReal = petInfo ? petInfo.nome : (this.data.parceiroIcone === 'üßú‚Äç‚ôÄÔ∏è' ? "Sereia" : "Trit√£o");
        titulo.textContent = nomeReal;
        
        // Configurar T√≠tulo da Rela√ß√£o
        status.textContent = this.getRelationshipTitle(this.data.casado ? 'married' : coracoesCheios, this.data.parceiroIcone);

        // Configurar Frase do Dia (Aleat√≥ria baseada no n√≠vel)
        dialogue.textContent = this.getRandomQuote(level);

        // Renderizar Cora√ß√µes
        heartsContainer.innerHTML = '';
        for(let i=0; i<5; i++) {
            const h = document.createElement('span');
            h.className = `heart-slot ${i < coracoesCheios ? 'filled' : ''}`;
            h.textContent = '‚ù§';
            heartsContainer.appendChild(h);
        }

        // Bot√£o Namoro (Aparece se tiver 79 pontos e n√£o estiver namorando)
        if (btnNamoro) {
            btnNamoro.style.display = (this.data.pontos >= 79 && !this.data.namorando && !this.data.casado) ? 'block' : 'none';
        }

        // Bot√£o Casar (Aparece se tiver 100 pontos e estiver namorando e n√£o for casado)
        if (btnCasar) {
            btnCasar.style.display = (this.data.pontos >= 100 && this.data.namorando && !this.data.casado) ? 'block' : 'none';
        }

        // Bot√£o Telepatia (Aparece apenas se for casado e dispon√≠vel)
        const btnTelepatia = document.getElementById('btnTelepatia');
        if (btnTelepatia) {
            btnTelepatia.style.display = this.data.casado ? 'flex' : 'none';
            
            if (!this.data.telepatiaDisponivel) {
                btnTelepatia.style.opacity = '0.5';
                btnTelepatia.style.filter = 'grayscale(1)';
                btnTelepatia.querySelector('small').textContent = 'Foque para carregar';
                btnTelepatia.onclick = () => showToast('‚è≥', 'Habilidade em recarga', 'Complete uma sess√£o de foco');
            } else {
                btnTelepatia.style.opacity = '1';
                btnTelepatia.style.filter = 'none';
                btnTelepatia.querySelector('small').textContent = 'Dispon√≠vel!';
                btnTelepatia.onclick = () => RomanceManager.toggleTelepatia();
            }

            if (this.telepatiaAtiva) {
                btnTelepatia.style.background = '#4cc9f0';
                btnTelepatia.style.color = 'white';
            } else {
                btnTelepatia.style.background = '#e0f7fa';
                btnTelepatia.style.color = '#003566';
            }
        }
        
        overlay.style.display = 'flex';
    },

    telepatiaAtiva: false,
    plantaSelecionadaIndex: null,

    toggleTelepatia: function() {
        if (!this.data.telepatiaDisponivel && !this.telepatiaAtiva) return;

        this.telepatiaAtiva = !this.telepatiaAtiva;
        this.plantaSelecionadaIndex = null;
        this.closeMenu();
        
        if (this.telepatiaAtiva) {
            this.manterToastTelepatia();
        } else {
            if (this.toastInterval) clearInterval(this.toastInterval);
            showToast('üåÄ', 'Telepatia Desativada', '');
        }
        renderJardim();
    },

    toastInterval: null,
    manterToastTelepatia: function() {
        if (this.toastInterval) clearInterval(this.toastInterval);
        
        const dispararToast = () => {
            if (!this.telepatiaAtiva) {
                clearInterval(this.toastInterval);
                return;
            }
            const msg = this.plantaSelecionadaIndex === null ? 'Clique em uma planta para mover' : 'Clique no destino vazio';
            showToast('üåÄ', 'Telepatia Ativada', msg);
        };

        dispararToast();
        this.toastInterval = setInterval(dispararToast, 5000); // Mant√©m o toast vivo a cada 5s
    },

    handleTelepatiaClick: function(index) {
        if (!this.telepatiaAtiva) return false;

        // Se j√° tem uma planta selecionada, tenta mover para o novo index
        if (this.plantaSelecionadaIndex !== null) {
            if (index === this.plantaSelecionadaIndex) {
                this.plantaSelecionadaIndex = null;
                showToast('üåÄ', 'Sele√ß√£o cancelada', '');
                renderJardim();
                return true;
            }

            // Verifica se o destino est√° vazio (sem planta e sem pet)
            const temPet = petsEmCena.some(p => p.index === index);
            if (!jardimData[index] && !temPet) {
                // Move a planta
                jardimData[index] = jardimData[this.plantaSelecionadaIndex];
                jardimData[this.plantaSelecionadaIndex] = null;
                this.plantaSelecionadaIndex = null;
                
                // Finaliza o modo
                this.telepatiaAtiva = false;
                this.data.telepatiaDisponivel = false;
                if (this.toastInterval) clearInterval(this.toastInterval);
                
                showToast('‚ú®', 'Planta movida!', 'Habilidade usada');
                this.save();
                salvarTudo();
                renderJardim();
                
                // Reabre o menu ap√≥s um pequeno delay
                setTimeout(() => this.openMenu(), 800);
            } else {
                showToast('‚ùå', 'Espa√ßo ocupado', 'Escolha um lugar vazio');
            }
            return true;
        } 
        
        // Se n√£o tem sele√ß√£o, tenta selecionar a planta no index clicado
        else {
            if (jardimData[index]) {
                // Verifica se √© planta (n√£o pet)
                const temPet = petsEmCena.some(p => p.index === index);
                if (!temPet) {
                    this.plantaSelecionadaIndex = index;
                    showToast('üåÄ', 'Planta selecionada', 'Agora clique no destino');
                    renderJardim();
                } else {
                    showToast('‚ùå', 'N√£o pode mover pets', 'Apenas plantas!');
                }
            }
            return true;
        }
    },

    closeMenu: function() {
        document.getElementById('romanceOverlay').style.display = 'none';
    },

    darCarinho: function() {
        const agora = Date.now();
        if (agora - this.data.ultimoCarinhoRomantico < 86400000) {
            showToast('‚è≥', 'Volte amanh√£', 'Carinho di√°rio j√° feito');
            return;
        }
        this.addPoints(5);
        this.data.ultimoCarinhoRomantico = agora;
        this.save();
        showToast('üíô', 'Sentiu-se amado!', '+5 Pontos');
        
        // Reabre o menu para atualizar a frase e os pontos
        this.openMenu(); 
        this.spawnHearts();
    },

    darPresente: function() {
        if (!this.data.perolas || this.data.perolas <= 0) {
            showToast('ü¶™', 'Sem P√©rolas', 'Compre na loja!');
            return;
        }
        this.data.perolas--;
        this.addPoints(10);
        this.save();
        showToast('üéÅ', 'Adorou o presente!', '+10 Pontos');
        
        // Reabre o menu para atualizar a frase e os pontos
        this.openMenu(); 
        this.spawnHearts();
    },

    addPoints: function(qtd) {
        // Se n√£o estiver namorando, os pontos travam em 79 (quase 4 cora√ß√µes - Amigo)
        if (!this.data.namorando && !this.data.casado) {
            this.data.pontos = Math.min(this.data.pontos + qtd, 79);
        } else {
            this.data.pontos = Math.min(this.data.pontos + qtd, 100);
        }
        this.save();
    },

    pedirEmNamoro: function() {
        if (!this.data.perolas || this.data.perolas <= 0) {
            this.closeMenu();
            showModal({ 
                text: "ü¶™ <strong>Falta algo...</strong><br><br>Voc√™ precisa de uma <b>P√©rola do Mar</b> para pedir em namoro. Compre uma na loja!", 
                onConfirm: () => { this.openMenu(); } 
            });
            return;
        }

        this.closeMenu();
        showModal({
            text: `üíñ <strong>O Pedido de Namoro</strong><br><br>Voc√™ oferece a P√©rola do Mar e abre seu cora√ß√£o...<br><br>"Eu aceito! Adoraria ser sua namorada(o)!"`,
            onConfirm: () => {
                this.data.perolas--;
                this.data.namorando = true;
                this.data.pontos = 80; // Desbloqueia o 4¬∫ cora√ß√£o (Namorado)
                this.save();
                this.openMenu();
                if (typeof efeitosManager !== 'undefined') efeitosManager.chuvaDeEfeitos('üíñ', 30);
            }
        });
    },

    proporCasamento: function() {
        if (!this.data.perolas || this.data.perolas <= 0) {
            this.closeMenu();
            showModal({ 
                text: "üîÆ <strong>Falta algo...</strong><br><br>Voc√™ precisa de uma <b>P√©rola do Mar</b> para propor casamento. Compre uma na loja!", 
                onConfirm: () => { this.openMenu(); } 
            });
            return;
        }

        this.closeMenu();
        showModal({
            text: `üíç <strong>O Pedido</strong><br><br>Voc√™ oferece a P√©rola do Compromisso...<br><br>"Sim! Eu irei contigo para onde fores, at√© para a superf√≠cie!"`,
            onConfirm: () => {
                this.data.perolas--;
                this.data.casado = true;
                this.save();
                this.openMenu(); // Mant√©m aberto para ver o status de casado
                if (typeof efeitosManager !== 'undefined') efeitosManager.chuvaDeEfeitos('üíç', 30);
                renderJardim();
            }
        });
    },

    spawnHearts: function() {
        const rect = document.querySelector('.romance-avatar').getBoundingClientRect();
        for(let i=0; i<5; i++) {
            const h = document.createElement('div');
            h.textContent = 'üíô';
            h.style.position = 'fixed';
            h.style.left = (rect.left + 20) + 'px';
            h.style.top = rect.top + 'px';
            h.style.zIndex = 20001;
            h.style.animation = 'fall 1.5s ease-out reverse';
            document.body.appendChild(h);
            setTimeout(() => h.remove(), 1500);
        }
    }
};



// Inicializador
window.addEventListener('load', () => RomanceManager.init());

// =========================
// SISTEMA DE TESOURO DI√ÅRIO (ü™é)
// =========================

// Fun√ß√£o `verificarSpawnTesouro` movida/atualizada mais abaixo para evitar duplica√ß√£o

// Fun√ß√£o `coletarTesouro` movida/atualizada mais abaixo para evitar duplica√ß√£o


function init() { 
    const vistoPrimeiroUso = StorageSeguro.get('vistoPrimeiroUso', false);
    let nome = StorageSeguro.get('jogadorNome');

    // Sincroniza o estado do tesouro a partir do storage (assegura consist√™ncia ap√≥s o banco carregar)
    tesouroAtivoIndex = StorageSeguro.get('tesouroAtivoIndex', null);
    ultimoTesouroData = StorageSeguro.get('ultimoTesouroData', null);
    console.log('Sincronizado: tesouroAtivoIndex=', tesouroAtivoIndex, 'ultimoTesouroData=', ultimoTesouroData);
    // Sanitizar e persistir hist√≥rico corrompido/duplicado (robustez)
    try {
        const historicoLimpo = sanitizeHistorico();
        if (historicoLimpo.length !== (historico || []).length) {
            console.info('historico: removendo registros inv√°lidos/duplicados', { antes: (historico || []).length, depois: historicoLimpo.length });
            historico = historicoLimpo;
            StorageSeguro.set('historico_foco', historico);
        }
    } catch (e) {
        console.error('Erro ao sanitizar hist√≥rico', e);
    }

    // Verifica√ß√£o r√°pida de persist√™ncia no boot (√∫til para confirma√ß√µes imediatas)
    try {
        console.debug('startup persistence check', verificarPersistencia());
    } catch (e) {
        console.warn('Erro ao executar verifica√ß√£o de persist√™ncia', e);
    }
    
    // 1. Primeiro Uso
    if (!vistoPrimeiroUso) {
        setTimeout(() => { mostrarPrimeiroUso(); }, 500);
        return;
    }
    
    verificarPrimeiroAcesso();
    // verificarSpawnTesouro(); // Movido para depois de initJardimData

    
    
    // 2. Nome do Jogador
    if(!nome) {
        showModal({
            text: "Bem-vindo ao Garden Focus! üå±\n\nQual √© o seu nome?",
            showInput: true,
            onConfirm: (nomeDigitado) => {
                if(nomeDigitado && nomeDigitado.trim()) {
                    StorageSeguro.set('jogadorNome', nomeDigitado.trim());
                    location.reload();
                }
            }
        });
        return;
    }
    
    // 3. Configura√ß√µes Iniciais de Interface
    const btnTelaAtiva = document.getElementById('btnTelaAtiva');
    if (btnTelaAtiva) btnTelaAtiva.classList.toggle('on', manterTelaAtiva);
    
    document.getElementById('saudacaoUsuario').innerHTML = `Ol√°, ${nome}!`;
    carregarFotoPerfil();
    
    // ============================================================
    // L√ìGICA DE TEMA CORRIGIDA
    // ============================================================
    // L√™ as vari√°veis globais j√° carregadas (agora usando .get corretamente)
    const btnTema = document.getElementById('btnTema');

    // For√ßa a leitura do storage para garantir (caso as vari√°veis globais tenham falhado)
    const darkModeSalvo = StorageSeguro.get('darkMode', false);
    
    if (temaAutomaticoAtivo) {
        // Se auto est√° ligado, verifica a hora
        verificarTemaAutomatico();
    } else {
        // Se auto est√° desligado, usa a prefer√™ncia manual
        // Verifica se √© true booleano ou string "true" para compatibilidade
        const deveSerEscuro = (darkModeSalvo === true || darkModeSalvo === 'true');

        if (deveSerEscuro) {
            document.body.classList.add('dark-mode');
            if(btnTema) {
                btnTema.textContent = 'üåô';
                btnTema.title = 'Alternar para modo claro';
            }
        } else {
            document.body.classList.remove('dark-mode');
            if(btnTema) {
                btnTema.textContent = '‚òÄÔ∏è ';
                btnTema.title = 'Alternar para modo escuro';
            }
        }
    }
    atualizarBotoesConfig();
    // ============================================================

    // Restante das inicializa√ß√µes
    document.getElementById('userMoedas').textContent = totalMoedas;
    particulasManager.iniciar();
    audioManager.init();
    
        initJardimData();
    
    RomanceManager.init();
    verificarSpawnTesouro();
    applyNatalUI(); 
    applyMedievalUI(); 
    applyCandyforniaUI();
    applyEurosummerUI();
    applyFundoMarUI();
    setLuckyPlant(); 
    renderSelects(); 
    
    if (grid10x10) {
        document.body.classList.add('grid-10x10');
    }
    
    renderJardim(); 
    renderTodos(); 
    
    // Popups e Containers
    const todoPopupAtivo = StorageSeguro.get('todoPopupAtivo', false);
    if (todoPopupAtivo) {
        document.getElementById('todoPopup').classList.add('ativo');
        document.getElementById('btnTodoToggle').classList.add('ativo');
    }
    
    renderEstante(); 
    // abrirModal('estanteOverlay'); // Removido para n√£o abrir ao iniciar
    renderEstrelasNoCeu(); 
    setupEstrelasClick();
    renderMetas();
    
    const metasPopupAtivo = StorageSeguro.get('metasPopupAtivo', false);
    if (metasPopupAtivo) {
        document.getElementById('metasContainer').classList.add('ativo');
        document.getElementById('btnMetasToggle').classList.add('ativo');
        preencherSelectsMetas();
    }
    
    if (modoFundoMar) {
        renderMetasFundoMar();
    }
    
    calcularPrevisao();
    atualizarStreak();
    atualizarBotoes();
    recriarTimerSeExistir();
    melhorarAcessibilidade();
    
    const tutorialVisto = StorageSeguro.get('tutorialVisto', false);
    if (!tutorialVisto) {
        setTimeout(() => { iniciarTutorial(); }, 800);
    }
    
    window.addEventListener('resize', () => {
        ajustarTamanho3D();
    });
    
        // Inicializar Pets salvos
    if (typeof inicializarPets === "function") {
        inicializarPets();
    }

    
    setTimeout(() => {
        ajustarTamanho3D();
    }, 500);
}


// Fun√ß√£o para mostrar as cartas do modo Eurosummer
function mostrarCartaEurosummer(ciclo) {
    const cartas = {
        1: { texto: "Lembras-te daquela vez que tent√°mos colher lim√µes e eu quase ca√≠ da escada? Tu riste tanto que at√© te esqueceste de me segurar! Hoje encontrei este lim√£o e, entre risos e saudades, senti o cheiro daquele dia. üçã‚ú®<br><br><small>‚Äî Ver√£o de 1994</small>", emoji: "üçã" },
        2: { texto: "Passei pelo nosso caf√©. O dono ainda pergunta por ti e eu, para disfar√ßar, disse que estavas a chegar. Pedi o teu caf√© favorito e deixei-o arrefecer, como se estivesses apenas a ler um livro ao meu lado. ‚òïüíï<br><br><small>‚Äî Outono de 1996</small>", emoji: "‚òï" },
        3: { texto: "A fonte da pra√ßa continua a espirrar √°gua para todo o lado. Lembras-te de quando tent√°mos tirar aquela foto 'est√©tica' e acab√°mos ensopados? As pessoas olhavam, mas n√≥s s√≥ consegu√≠amos rir. Que falta me fazes. ‚õ≤üíô<br><br><small>‚Äî Agosto de 1998</small>", emoji: "‚õ≤" },
        4: { texto: "Caminhei pelos campos de lavanda e o perfume trouxe-me aquela tua mania de espirrar sempre que pass√°vamos por aqui. Sorri sozinha, imaginando-te a reclamar do p√≥len enquanto seguravas a minha m√£o. ü™ªüíú<br><br><small>‚Äî Primavera de 2001</small>", emoji: "ü™ª" },
        5: { texto: "As uvas est√£o doces, mas n√£o tanto como aquele vinho barato que compr√°mos e bebemos no telhado. Lembras-te de como jur√°mos que √©ramos sommeliers? Acab√°mos com a l√≠ngua roxa e o cora√ß√£o cheio. üçáüç∑‚ú®<br><br><small>‚Äî Vindima de 2003</small>", emoji: "üçá" },
        6: { texto: "A casa na colina ainda tem aquela porta que range. Lembras-te de quando tent√°mos entrar em sil√™ncio √†s 3 da manh√£ e a porta acordou a vila inteira? Bons tempos de fugas e segredos. üè†üíõ<br><br><small>‚Äî Julho de 2005</small>", emoji: "üè†" },
        7: { texto: "Vi o barquinho azul passar. Lembras-te de quando decidiste que √≠amos ser marinheiros e quase fic√°mos √† deriva porque nenhum de n√≥s sabia remar direito? O p√¢nico nos teus olhos foi a coisa mais fofa. ‚õµüíô<br><br><small>‚Äî Ver√£o de 2007</small>", emoji: "‚õµ" },
        8: { texto: "Os girass√≥is est√£o enormes! Lembras-te de quando tentaste levar um para casa e ele era maior que tu? Acab√°mos por deix√°-lo no jardim, dizendo que ele era o nosso guardi√£o dourado. üåªüíõ<br><br><small>‚Äî Agosto de 2009</small>", emoji: "üåª" },
        9: { texto: "Abri aquela garrafa que guard√°vamos para uma ocasi√£o especial. A ocasi√£o √© apenas a saudade. Brindei ao nosso 'quase' e ao nosso 'sempre'. Onde quer que estejas, este gole √© por n√≥s. ü•Ç‚ú®üíï<br><br><small>‚Äî Dezembro de 2011</small>", emoji: "ü•Ç" },
        10: { texto: "Nas ru√≠nas, o tempo parece parado. Lembras-te de quando escrevemos os nossos nomes numa pedra escondida? Procurei-a hoje e ela ainda l√° est√°, firme, como a promessa que fizemos sob o luar. üèõÔ∏èüíû<br><br><small>‚Äî Setembro de 2013</small>", emoji: "üèõÔ∏è" },
        11: { texto: "Encontrei a chave daquela nossa casinha de sonho. Lembras-te de quando plane√°mos cada detalhe, desde a cor das cortinas at√© ao lugar onde o gato ia dormir? A chave ainda brilha, esperando por n√≥s. üè°üóùÔ∏è‚ú®<br><br><small>‚Äî Maio de 2015</small>", emoji: "üè°" },
        12: { texto: "O jardim est√° cheio de flores silvestres. Lembras-te de quando me fizeste um buqu√™ e eu tive uma crise de alergia? Tu entraste em p√¢nico e eu s√≥ conseguia rir entre espirros. Foi o buqu√™ mais lindo. üíêüíñ<br><br><small>‚Äî Primavera de 2017</small>", emoji: "üíê" },
        13: { texto: "As margaridas voltaram a florescer. Lembras-te de quando faz√≠amos 'bem-me-quer, mal-me-quer' e tu batoteavas sempre para dar 'bem-me-quer'? Eu sabia, mas deixava-te ganhar s√≥ para ver o teu sorriso. üåºüíõ‚ú®<br><br><small>‚Äî Ver√£o de 2018</small>", emoji: "üåº" }
    };

    const carta = cartas[ciclo];
    if (!carta) return;

    // Adicionar emoji aos desbloqueados se ainda n√£o estiver
    if (!eurosummerEmojisDesbloqueados.includes(carta.emoji)) {
        eurosummerEmojisDesbloqueados.push(carta.emoji);
        StorageSeguro.set('eurosummerEmojisDesbloqueados', eurosummerEmojisDesbloqueados);
    }

    // Criar modal personalizado para a carta
    const overlay = document.createElement('div');
    overlay.id = 'eurosummerCartaOverlay';
    overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100000;
        animation: fadeIn 0.3s ease;
    `;

    const cartaDiv = document.createElement('div');
    cartaDiv.style.cssText = `
        background: #ffffff;
        border: 1px solid #a2d2ff;
        border-radius: 20px;
        padding: 35px;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 15px 45px rgba(162, 210, 255, 0.2);
        text-align: center;
        animation: slideIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        font-family: 'Georgia', serif;
    `;

    cartaDiv.innerHTML = `
        <div style="font-size: 50px; margin-bottom: 20px; filter: drop-shadow(0 5px 15px rgba(0,0,0,0.1));">${carta.emoji}</div>
        <h3 style="color: #546e7a; font-size: 18px; margin-bottom: 15px; font-weight: normal; letter-spacing: 1px; text-transform: uppercase;">
            Mem√≥ria #${ciclo}
        </h3>
        <p style="color: #2c3e50; font-size: 15px; line-height: 1.8; font-style: italic; margin-bottom: 20px; padding: 0 10px;">
            "${carta.texto}"
        </p>
        <p style="color: #a2d2ff; font-size: 10px; letter-spacing: 1px; margin-bottom: 25px; font-family: sans-serif; text-transform: uppercase;">
            Novo item: ${carta.emoji}
        </p>
        <button id="eurosummerCartaBtn" style="
            background: #a2d2ff;
            color: #ffffff;
            border: none;
            padding: 12px 35px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            letter-spacing: 1px; ">GUARDAR</button>
    `;

    overlay.appendChild(cartaDiv);
    document.body.appendChild(overlay);

    // Adicionar estilos de anima√ß√£o
    const style = document.createElement('style');
    style.textContent = `
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideIn {
            from { transform: translateY(-50px) scale(0.9); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }
        #eurosummerCartaBtn:hover {
            background: #004488;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 51, 102, 0.4);
        }
    `;
    document.head.appendChild(style);

    // Fechar ao clicar no bot√£o
    document.getElementById('eurosummerCartaBtn').onclick = () => {
        overlay.style.animation = 'fadeOut 0.3s ease';
        setTimeout(() => {
            document.body.removeChild(overlay);
            document.head.removeChild(style);
        }, 300);
    };

    // Adicionar anima√ß√£o de fadeOut
    style.textContent += `
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
    `;
}

// Fun√ß√£o para mostrar as cartas do modo Fundo do Mar
function mostrarCartaFundoMar(meta) {
    if (!meta) return;

    // Criar modal personalizado para a carta
    const overlay = document.createElement('div');
    overlay.id = 'fundoMarCartaOverlay';
    overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 29, 61, 0.95);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100000;
        animation: fadeIn 0.3s ease;
    `;

    const cartaDiv = document.createElement('div');
    cartaDiv.style.cssText = `
        background: #003566;
        border: 2px solid #4cc9f0;
        border-radius: 20px;
        padding: 35px;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 15px 45px rgba(76, 201, 240, 0.3);
        text-align: center;
        animation: slideIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    `;

    // L√ìGICA DE CORRE√á√ÉO PARA O GUIA (META 7)
    let petReward = meta.petGratis;
    
    // Se for a Meta 7, usamos o guia que o utilizador escolheu no in√≠cio
    if (meta.id === 7) {
        // Se por algum motivo a vari√°vel n√£o existir, assume Sereia como fallback
        petReward = guiaEscolhidoFundoMar || 'üßú‚Äç‚ôÄÔ∏è'; 
    }

    const guiaIcone = guiaEscolhidoFundoMar || 'üßú‚Äç‚ôÄÔ∏è';
    const guiaNome = guiaIcone === 'üßú‚Äç‚ôÄÔ∏è' ? 'Sereia' : 'Trit√£o';

    cartaDiv.innerHTML = `
        <h3 style="color: #4cc9f0; font-size: 18px; margin-bottom: 15px; font-weight: normal; letter-spacing: 1px; text-transform: uppercase;">
            Mensagem de ${guiaNome}
        </h3>
        <p style="color: #90e0ef; font-size: 11px; margin-bottom: 10px; opacity: 0.8; text-transform: uppercase;">
            Recupera√ß√£o do Recife - Fase ${meta.id}
        </p>
        <p style="color: #ffffff; font-size: 15px; line-height: 1.8; margin-bottom: 20px; padding: 0 10px; font-style: italic;">
            "${meta.texto}"
        </p>
        <p style="color: #4cc9f0; font-size: 10px; letter-spacing: 1px; margin-bottom: 25px; font-family: sans-serif; text-transform: uppercase;">
            Novo pet desbloqueado: ${petReward}
        </p>
        <button id="fundoMarCartaBtn" style="
            background: #4cc9f0;
            color: #001d3d;
            border: none;
            padding: 12px 35px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            letter-spacing: 1px; ">GUARDAR</button>
    `;

    overlay.appendChild(cartaDiv);
    document.body.appendChild(overlay);

    // Adicionar estilos de anima√ß√£o
    const style = document.createElement('style');
    style.textContent = `
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideIn {
            from { transform: translateY(-50px) scale(0.9); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }
        #fundoMarCartaBtn:hover {
            background: #00b4d8;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 180, 216, 0.4);
        }
    `;
    document.head.appendChild(style);

    // Fechar ao clicar no bot√£o
    document.getElementById('fundoMarCartaBtn').onclick = () => {
        // Se houver recompensa (peixes normais ou o guia da meta 7)
        if (petReward) {
            showModal({ 
                text: `üêæ Um novo companheiro foi desbloqueado na loja gratuitamente: ${petReward}!`, 
                onConfirm: () => {} 
            });
        }
        
        // Removemos a chamada antiga "abrirEscolhaSereiaTritao" daqui

        overlay.style.animation = 'fadeOut 0.3s ease';
        setTimeout(() => {
            document.body.removeChild(overlay);
            document.head.removeChild(style);
        }, 300);
    };

    // Adicionar anima√ß√£o de fadeOut
    style.textContent += `
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
    `;
}



function abrirCorreioEurosummer() {
    const cartasDesbloqueadas = Math.floor(eurosummerSessoes / 3);
    if (cartasDesbloqueadas === 0) {
        showModal({ text: "üì¨ O teu correio ainda est√° vazio. Completa sess√µes de foco para receber a tua primeira carta da Riviera.", onConfirm: () => {} });
        return;
    }

    const cartas = {
        1: { texto: "Lembras-te daquela vez que tent√°mos colher lim√µes e eu quase ca√≠ da escada? Tu riste tanto que at√© te esqueceste de me segurar! Hoje encontrei este lim√£o e, entre risos e saudades, senti o cheiro daquele dia. üçã‚ú®<br><br><small>‚Äî Ver√£o de 1994</small>", emoji: "üçã" },
        2: { texto: "Passei pelo nosso caf√©. O dono ainda pergunta por ti e eu, para disfar√ßar, disse que estavas a chegar. Pedi o teu caf√© favorito e deixei-o arrefecer, como se estivesses apenas a ler um livro ao meu lado. ‚òïüíï<br><br><small>‚Äî Outono de 1996</small>", emoji: "‚òï" },
        3: { texto: "A fonte da pra√ßa continua a espirrar √°gua para todo o lado. Lembras-te de quando tent√°mos tirar aquela foto 'est√©tica' e acab√°mos ensopados? As pessoas olhavam, mas n√≥s s√≥ consegu√≠amos rir. Que falta me fazes. ‚õ≤üíô<br><br><small>‚Äî Agosto de 1998</small>", emoji: "‚õ≤" },
        4: { texto: "Caminhei pelos campos de lavanda e o perfume trouxe-me aquela tua mania de espirrar sempre que pass√°vamos por aqui. Sorri sozinha, imaginando-te a reclamar do p√≥len enquanto seguravas a minha m√£o. ü™ªüíú<br><br><small>‚Äî Primavera de 2001</small>", emoji: "ü™ª" },
        5: { texto: "As uvas est√£o doces, mas n√£o tanto como aquele vinho barato que compr√°mos e bebemos no telhado. Lembras-te de como jur√°mos que √©ramos sommeliers? Acab√°mos com a l√≠ngua roxa e o cora√ß√£o cheio. üçáüç∑‚ú®<br><br><small>‚Äî Vindima de 2003</small>", emoji: "üçá" },
        6: { texto: "A casa na colina ainda tem aquela porta que range. Lembras-te de quando tent√°mos entrar em sil√™ncio √†s 3 da manh√£ e a porta acordou a vila inteira? Bons tempos de fugas e segredos. üè†üíõ<br><br><small>‚Äî Julho de 2005</small>", emoji: "üè†" },
        7: { texto: "Vi o barquinho azul passar. Lembras-te de quando decidiste que √≠amos ser marinheiros e quase fic√°mos √† deriva porque nenhum de n√≥s sabia remar direito? O p√¢nico nos teus olhos foi a coisa mais fofa. ‚õµüíô<br><br><small>‚Äî Ver√£o de 2007</small>", emoji: "‚õµ" },
        8: { texto: "Os girass√≥is est√£o enormes! Lembras-te de quando tentaste levar um para casa e ele era maior que tu? Acab√°mos por deix√°-lo no jardim, dizendo que ele era o nosso guardi√£o dourado. üåªüíõ<br><br><small>‚Äî Agosto de 2009</small>", emoji: "üåª" },
        9: { texto: "Abri aquela garrafa que guard√°vamos para uma ocasi√£o especial. A ocasi√£o √© apenas a saudade. Brindei ao nosso 'quase' e ao nosso 'sempre'. Onde quer que estejas, este gole √© por n√≥s. ü•Ç‚ú®üíï<br><br><small>‚Äî Dezembro de 2011</small>", emoji: "ü•Ç" },
        10: { texto: "Nas ru√≠nas, o tempo parece parado. Lembras-te de quando escrevemos os nossos nomes numa pedra escondida? Procurei-a hoje e ela ainda l√° est√°, firme, como a promessa que fizemos sob o luar. üèõÔ∏èüíû<br><br><small>‚Äî Setembro de 2013</small>", emoji: "üèõÔ∏è" },
        11: { texto: "Encontrei a chave daquela nossa casinha de sonho. Lembras-te de quando plane√°mos cada detalhe, desde a cor das cortinas at√© ao lugar onde o gato ia dormir? A chave ainda brilha, esperando por n√≥s. üè°üóùÔ∏è‚ú®<br><br><small>‚Äî Maio de 2015</small>", emoji: "üè°" },
        12: { texto: "O jardim est√° cheio de flores silvestres. Lembras-te de quando me fizeste um buqu√™ e eu tive uma crise de alergia? Tu entraste em p√¢nico e eu s√≥ conseguia rir entre espirros. Foi o buqu√™ mais lindo. üíêüíñ<br><br><small>‚Äî Primavera de 2017</small>", emoji: "üíê" },
        13: { texto: "As margaridas voltaram a florescer. Lembras-te de quando faz√≠amos 'bem-me-quer, mal-me-quer' e tu batoteavas sempre para dar 'bem-me-quer'? Eu sabia, mas deixava-te ganhar s√≥ para ver o teu sorriso. üåºüíõ‚ú®<br><br><small>‚Äî Ver√£o de 2018</small>", emoji: "üåº" }
    };

    let htmlCartas = '';
    for (let i = 1; i <= Math.min(cartasDesbloqueadas, 13); i++) {
        htmlCartas += `
            <div style="background: #fef9f3; border: 1px solid #003366; border-radius: 10px; padding: 15px; margin-bottom: 15px; text-align: left; position: relative;">
                <div style="font-size: 24px; position: absolute; top: 10px; right: 10px;">${cartas[i].emoji}</div>
                <div style="color: #003366; font-weight: bold; font-size: 14px; margin-bottom: 8px; font-family: 'Georgia', serif;">Mem√≥ria #${i}</div>
                <div style="color: #5d4037; font-size: 13px; line-height: 1.5; font-style: italic; font-family: 'Georgia', serif;">"${cartas[i].texto}"</div>
            </div>
        `;
    }

    const overlay = document.createElement('div');
    overlay.style.cssText = `position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 100000; animation: fadeIn 0.3s ease;`;
    
    const container = document.createElement('div');
    container.style.cssText = `background: #ffffff; border: 1px solid #a2d2ff; border-radius: 20px; padding: 30px; max-width: 450px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 15px 45px rgba(162, 210, 255, 0.2); text-align: center;`;
    
    container.innerHTML = `
        <h2 style="color: #546e7a; margin-bottom: 25px; font-family: 'Georgia', serif; font-weight: normal; letter-spacing: 2px; text-transform: uppercase;">üì¨ Correio</h2>
        <div style="margin-bottom: 25px;">${htmlCartas}</div>
        <button id="fecharCorreioBtn" style="background: #a2d2ff; color: #ffffff; border: none; padding: 12px 35px; border-radius: 50px; font-weight: bold; cursor: pointer; letter-spacing: 1px; ">FECHAR</button>
    `;

    overlay.appendChild(container);
    document.body.appendChild(overlay);

    document.getElementById('fecharCorreioBtn').onclick = () => {
        document.body.removeChild(overlay);
    };
}

function reiniciarEurosummer() {
    showModal({ 
        text: "‚ö†Ô∏è Desejas reiniciar a tua hist√≥ria na Riviera?<br><br>As tuas sess√µes do modo Eurosummer voltar√£o a zero e as mem√≥rias ser√£o guardadas novamente. Os emojis j√° plantados no jardim permanecer√£o.", 
        onConfirm: () => {
            eurosummerSessoes = 0;
            eurosummerEmojisDesbloqueados = [];
            vistoIntroEurosummer = false;
            StorageSeguro.set('eurosummerSessoes', 0);
            StorageSeguro.set('eurosummerEmojisDesbloqueados', []);
            StorageSeguro.set('vistoIntroEurosummer', false);
            
            // Se o modo estiver ativo, resetar a planta escolhida para o padr√£o e desativar o modo
            if (modoEurosummer) {
                escolhido = ITENS_PADRAO[0];
                StorageSeguro.set('plantaEscolhida', escolhido);
                if (typeof updatePlantButtonSprite === 'function') updatePlantButtonSprite();
                
                modoEurosummer = false;
                StorageSeguro.set('modoEurosummer', false);
                
                // Atualizar UI imediatamente
                applyEurosummerUI();
                const btnEuro = document.getElementById('btnEurosummerLoja');
                if (btnEuro) btnEuro.classList.remove('on');
            }
            
            setTimeout(() => {
                showModal({ 
                    text: "üåä A brisa do mar limpou o teu di√°rio. Uma nova jornada come√ßa agora.", 
                    onConfirm: () => {
                        location.reload();
                    }
                });
            }, 300);
        } 
    });
}
function promptCustom(text, isNumber, onConfirm) {
    showModal({
        text: text,
        showInput: true,
        inputType: isNumber ? 'number' : 'text',
        onConfirm: (val) => {
            if (val) {
                if (isNumber) {
                    const n = parseInt(val);
                    if (!isNaN(n) && n > 0) onConfirm(n);
                } else {
                    onConfirm(val.trim());
                }
            }
        }
    });
}

function showModal({ text, showInput = false, onConfirm, onCancel = null, altText = null, confirmText = "Ok!", inputType = "text" }) {
    const overlay = document.getElementById('customAlertOverlay');
    const input = document.getElementById('customAlertInput');
    const cancelBtn = document.getElementById('alertCancelBtn');
    const altBtn = document.getElementById('alertAltBtn');
    const confirmBtn = document.getElementById('alertConfirmBtn');

    document.getElementById('customAlertText').innerHTML = text;

    input.style.display = showInput ? 'block' : 'none';

    if (showInput) {
        input.type = inputType;
        input.value = '';
        input.focus();
    } else {
        input.style.display = 'none';
    }

    confirmBtn.textContent = confirmText;
    cancelBtn.textContent = "Cancelar";

    // L√≥gica do bot√£o Alternativo (se houver)
    if (altText) {
        altBtn.style.display = 'block';
        altBtn.textContent = altText;
        altBtn.onclick = () => {
            fecharModal('customAlertOverlay');
            onConfirm(altText);
        };
        // Se tem bot√£o alternativo, geralmente escondemos o cancelar padr√£o, 
        // mas aqui mantemos se n√£o conflitarem visualmente, ou ajustamos conforme prefer√™ncia.
        // Pelo padr√£o do seu c√≥digo, vou ocultar o cancelar se tiver Alt, a menos que seja input.
        cancelBtn.style.display = 'none';
    } else {
        altBtn.style.display = 'none';
        // Bot√£o cancelar sempre vis√≠vel em perguntas ou inputs
        cancelBtn.style.display = 'block';
    }

    // ABRIR O MODAL
    abrirModal('customAlertOverlay');

    // CONFIGURAR A√á√ÉO DE CONFIRMAR
    confirmBtn.onclick = () => {
        if (inputType === 'number' && showInput) {
            const val = parseInt(input.value);
            if (isNaN(val) || val < 1) {
                input.style.borderColor = 'red';
                setTimeout(() => input.style.borderColor = '', 1000);
                return;
            }
        }
        fecharModal('customAlertOverlay');
        if (onConfirm) onConfirm(input.value);
    };

    // CONFIGURAR A√á√ÉO DE CANCELAR
    cancelBtn.onclick = () => {
        fecharModal('customAlertOverlay');
        if (onCancel) onCancel();
    };
}

function addTempo(v) { tempos.push(v); StorageSeguro.set('tempos', tempos); renderSelects(); }
function addMotivo(v) { motivos.push(v); StorageSeguro.set('motivos', motivos); renderSelects(); }

	function carregarFotoPerfil() {
	    const fotoSalva = StorageSeguro.get('profilePhoto', null);
	    if (fotoSalva) {
	        const imgElement = document.getElementById('profilePhoto');
	        const placeholder = document.getElementById('profilePhotoPlaceholder');
	        const bottomNavImg = document.getElementById('bottomNavPhoto');
	        const bottomNavPlaceholder = document.getElementById('bottomNavPhotoPlaceholder');
	        
	        // Fallback para caso a imagem esteja corrompida
    	    if (imgElement) imgElement.onerror = () => {
    	        if (imgElement) imgElement.style.display = 'none';
    	        if (placeholder) placeholder.style.display = 'flex';
    	        if (bottomNavImg) bottomNavImg.style.display = 'none';
    	        if (bottomNavPlaceholder) bottomNavPlaceholder.style.display = 'flex';
    	        StorageSeguro.set('profilePhoto', null);
    	    };
    	    
    	    if (imgElement) imgElement.src = fotoSalva;
    	    if (imgElement) imgElement.style.display = 'block';
    	    if (placeholder) placeholder.style.display = 'none';
    	    
    	    // Sincronizar com barra inferior apenas se existir
    	    if (bottomNavImg) {
    	        bottomNavImg.src = fotoSalva;
    	        bottomNavImg.style.display = 'block';
    	    }
    	    if (bottomNavPlaceholder) bottomNavPlaceholder.style.display = 'none';
	}
}



const profileInput = document.getElementById('profilePhotoInput');
if (profileInput) profileInput.addEventListener('change', function(e) {
    const file = e.target.files && e.target.files[0];
    if (file && file.type && file.type.startsWith && file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(event) {
            const imgElement = document.getElementById('profilePhoto');
            const placeholder = document.getElementById('profilePhotoPlaceholder');
            const bottomNavImg = document.getElementById('bottomNavPhoto');
            const bottomNavPlaceholder = document.getElementById('bottomNavPhotoPlaceholder');

            if (imgElement) { imgElement.src = event.target.result; imgElement.style.display = 'block'; }
            if (placeholder) placeholder.style.display = 'none';

            if (bottomNavImg) { bottomNavImg.src = event.target.result; bottomNavImg.style.display = 'block'; }
            if (bottomNavPlaceholder) bottomNavPlaceholder.style.display = 'none';

            StorageSeguro.set('profilePhoto', event.target.result);
        };
        reader.readAsDataURL(file);
    }
});

function toggleSino() {
    const btn = document.getElementById('btnSino');
    sinoAtivo = !sinoAtivo;
    StorageSeguro.set('sinoAtivo', sinoAtivo);
    
    if (btn) btn.classList.toggle('on', sinoAtivo);
}



function togglePrevisao() {
    const btn = document.getElementById('btnPrevisao');
    mostrarPrevisao = !mostrarPrevisao;
    StorageSeguro.set('mostrarPrevisao', mostrarPrevisao);
    
    if (btn) btn.classList.toggle('on', mostrarPrevisao);
    
    calcularPrevisao();
}



function verificarTemaAutomatico() {
    // S√ì aplicar se modo autom√°tico estiver ATIVADO
    if (!temaAutomaticoAtivo) {
        console.log("Modo autom√°tico DESATIVADO, n√£o alterando tema");
        return;
    }
    
    const agora = new Date();
    const hora = agora.getHours();
    const isNoite = hora >= 18 || hora < 6;
    
    console.log("Verificando tema autom√°tico. Hora:", hora, "√â noite?", isNoite);
    
    if (isNoite) {
        // Aplicar tema escuro
        document.body.classList.add('dark-mode');
        StorageSeguro.set('darkMode', 'true');
        console.log("Aplicando tema escuro (autom√°tico - noite)");
    } else {
        // Aplicar tema claro
        document.body.classList.remove('dark-mode');
        StorageSeguro.set('darkMode', 'false');
        console.log("Aplicando tema claro (autom√°tico - dia)");
    }
    
    renderEstrelasNoCeu();
}

document.getElementById('tempoEscolhido').addEventListener('change', () => { if(!intervalo) { atualizarTimerDisplay(); calcularPrevisao(); } });
document.getElementById('motivoEscolhido').addEventListener('change', calcularPrevisao);

window.addEventListener('beforeunload', () => {
    if (intervalo) {
        // Salvar o estado atual do timer antes de sair
        salvarTimerAtivo();
        clearInterval(intervalo);
        intervalo = null;
    }
    audioManager.parar();
    efeitosManager.limparTodos();
    particulasManager.parar();
});



// Por esta NOVA:
// Verificar tema autom√°tico periodicamente (a cada minuto)
setInterval(() => {
    if (temaAutomaticoAtivo) {
        verificarTemaAutomatico();
    }
}, 60000);

if ('serviceWorker' in navigator) {
window.addEventListener('load', () => {
navigator.serviceWorker.register('sw.js')
.then(reg => console.log('Service Worker registado com sucesso!'))
.catch(err => console.log('Erro ao registar Service Worker:', err));
});
}

// =========================
// SISTEMA DE BACKGROUND GLOBAL
// =========================
let workerGlobal = null;
let audioContextGlobal = null;
let oscillatorGlobal = null;
let backgroundModeAtivo = false;

// Criar Web Worker global para manter timers em background
function criarWorkerGlobal() {
    if (workerGlobal) return workerGlobal;
    
    const workerCode = `
        let timers = new Map();
        
        self.onmessage = function(e) {
            const { comando, id, tempo } = e.data;
            
            switch(comando) {
                case 'iniciar_timer':
                    if (timers.has(id)) {
                        clearInterval(timers.get(id).interval);
                    }
                    let tempoRestante = tempo;
                    const timerData = { interval: null, tempoRestante };
                    const interval = setInterval(() => {
                        timerData.tempoRestante--;
                        self.postMessage({ tipo: 'tick', id, tempoRestante: timerData.tempoRestante });
                        if (timerData.tempoRestante <= 0) {
                            clearInterval(interval);
                            timers.delete(id);
                            self.postMessage({ tipo: 'completo', id });
                        }
                    }, 1000);
                    timerData.interval = interval;
                    timers.set(id, timerData);
                    break;
                    
                case 'parar_timer':
                    if (timers.has(id)) {
                        clearInterval(timers.get(id).interval);
                        timers.delete(id);
                    }
                    break;
                    
                case 'pausar_timer':
                    if (timers.has(id)) {
                        clearInterval(timers.get(id).interval);
                        timers.get(id).interval = null; // Marcar como pausado
                    }
                    break;
                    
                case 'resumir_timer':
                    if (timers.has(id) && timers.get(id).interval === null) {
                        const timerData = timers.get(id);
                        timerData.interval = setInterval(() => {
                            timerData.tempoRestante--;
                            self.postMessage({ tipo: 'tick', id, tempoRestante: timerData.tempoRestante });
                            if (timerData.tempoRestante <= 0) {
                                clearInterval(timerData.interval);
                                timers.delete(id);
                                self.postMessage({ tipo: 'completo', id });
                            }
                        }, 1000);
                    }
                    break;
                    
                case 'obter_tempo':
                    if (timers.has(id)) {
                        self.postMessage({ tipo: 'tempo_atual', id, tempoRestante: timers.get(id).tempoRestante });
                    }
                    break;
                    
                case 'parar_tudo':
                    timers.forEach((t, id) => clearInterval(t.interval));
                    timers.clear();
                    break;
            }
        };
    `;
    
    const blob = new Blob([workerCode], { type: 'application/javascript' });
    workerGlobal = new Worker(URL.createObjectURL(blob));
    
    workerGlobal.onmessage = function(e) {
        const { tipo, id, tempoRestante } = e.data;
        
        if (tipo === 'tick') {
            // Atualizar display do timer correspondente
            if (id === 'principal' && document.getElementById('timer')) {
                let m = Math.floor(tempoRestante / 60);
                let s = tempoRestante % 60;
                document.getElementById('timer').textContent = (m < 10 ? "0" : "") + m + ":" + (s < 10 ? "0" : "") + s;
                
                // Atualizar barra de progresso no preview
                const tempoTotal = Number(document.getElementById('tempoEscolhido')?.value || 25) * 60;
                const progresso = Math.min(100, ((tempoTotal - tempoRestante) / tempoTotal) * 100);
                const fill = document.querySelector('.preview-temp .progress-fill');
                if (fill) fill.style.width = progresso + '%';
            } else if (id === 'plantarJuntos' && document.getElementById('timerPlantarJuntos')) {
                tempoPJRestante = tempoRestante;
                atualizarTimerPJDisplay();
            }
        } else if (tipo === 'completo') {
            if (id === 'principal') {
                finalizarFoco();
                pararBackgroundMode();
            } else if (id === 'plantarJuntos') {
                finalizarFocoPJ();
                pararBackgroundMode();
            }
            // Notifica√ß√£o se aba estiver invis√≠vel
            if (document.hidden && 'Notification' in window && Notification.permission === 'granted') {
                new Notification('Foco Conclu√≠do!', { 
                    body: `Seu foco ${id === 'plantarJuntos' ? 'de Plantar Juntos' : ''} terminou! Volte ao app.`, 
                    icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iOCIgZmlsbD0iIzRjYWY1MCIvPgo8dGV4dCB4PSIxNiIgeT0iMjAiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiPjüå±</dGV4dD4KPHN2Zz4=' 
                });
            }
        }
    };
    
    return workerGlobal;
}

// Iniciar modo background (√°udio silencioso + worker)
function iniciarBackgroundMode() {
    if (backgroundModeAtivo) return;
    backgroundModeAtivo = true;
    
    // Criar worker
    criarWorkerGlobal();
    
    // √Åudio silencioso para manter app vivo no mobile
    try {
        audioContextGlobal = new (window.AudioContext || window.webkitAudioContext)();
        oscillatorGlobal = audioContextGlobal.createOscillator();
        const gainNode = audioContextGlobal.createGain();
        
        oscillatorGlobal.connect(gainNode);
        gainNode.connect(audioContextGlobal.destination);
        gainNode.gain.value = 0.001; // Praticamente silencioso
        oscillatorGlobal.frequency.value = 1; // Frequ√™ncia muito baixa
        oscillatorGlobal.start();
        
        console.log('Background mode ativado');
    } catch (err) {
        console.log('N√£o foi poss√≠vel criar √°udio de background:', err);
    }
    
    // Wake Lock
    gerenciarTelaAtiva(true);
    
    // Media Session para controles na lock screen
    if ('mediaSession' in navigator) {
        navigator.mediaSession.metadata = new MediaMetadata({
            title: 'Focando...',
            artist: 'Jardim de Foco',
            album: 'Timer Ativo',
            artwork: [{ src: 'icons/icon-192x192.png', sizes: '192x192', type: 'image/png' }]
        });
    }
}

// Parar modo background
function pararBackgroundMode() {
    backgroundModeAtivo = false;
    
    // Parar √°udio
    if (oscillatorGlobal) {
        try { oscillatorGlobal.stop(); } catch(e) {}
        oscillatorGlobal = null;
    }
    if (audioContextGlobal) {
        try { audioContextGlobal.close(); } catch(e) {}
        audioContextGlobal = null;
    }
    
    // Parar worker
    if (workerGlobal) {
        workerGlobal.postMessage({ comando: 'parar_tudo' });
    }
    
    // Liberar wake lock
    gerenciarTelaAtiva(false);
    
    console.log('Background mode desativado');
}

// Re-adquirir wake lock quando app volta ao primeiro plano
document.addEventListener('visibilitychange', async () => {
    if (document.visibilityState === 'visible' && backgroundModeAtivo) {
        // Re-adquirir wake lock
        gerenciarTelaAtiva(true);
        console.log('Wake lock re-adquirido');
    }
});

async function gerenciarTelaAtiva(ativar) {
    if (!('wakeLock' in navigator)) {
        console.log("API Wake Lock n√£o suportada neste navegador");
        return;
    }
    
    try {
        if (ativar) {
            if (wakeLock) return; // J√° est√° ativo
            
            wakeLock = await navigator.wakeLock.request('screen');
            console.log("Tela bloqueada (Ativa)");
            
            // Lidar com libera√ß√£o inesperada
            wakeLock.addEventListener('release', () => {
                console.log("Wake Lock foi liberado");
                wakeLock = null;
            });
        } else if (wakeLock) {
            await wakeLock.release();
            wakeLock = null;
            console.log("Tela liberada");
        }
    } catch (err) {
        console.error(`${err.name}, ${err.message}`);
        
        // Feedback visual se houver erro
        if (err.name === 'NotAllowedError') {
            showModal({ 
                text: "Permiss√£o necess√°ria: Para manter a tela ativa durante o foco, permita que o navegador impe√ßa o bloqueio de tela.", 
                onConfirm: () => {} 
            });
        }
    }
}
// =========================
// FUN√á√ÉO BULLDOZE - REMOVER TODAS AS PLANTAS
// =========================
function bulldoze() {
    showModal({
        text: "Tem certeza que deseja remover todas as plantas do jardim?<br><br>Aten√ß√£o: Seus animais ficar√£o seguros.",
        onConfirm: () => {
            // --- C√ÅLCULO DE RECURSOS (Loot) ---
            let loot = { apples: 0, wood: 0, stone: 0 };
            let ganhouAlgo = false;

            // Apenas gera recursos se N√ÉO estiver no modo Fundo do Mar
            if (!modoFundoMar) {
                const totalCells = getTotalCells();
                
                // Percorre o jardim atual para ver o que ser√° destru√≠do
                for (let i = 0; i < totalCells; i++) {
                    // Verifica se existe planta (e ignora se for apenas um buraco vazio ou null)
                    // Tamb√©m garantimos que n√£o √© um pet (pets n√£o s√£o removidos no bulldoze visualmente, mas verificamos por seguran√ßa)
                    if (jardimData[i]) {
                        // L√≥gica de Drop Proporcional
                        // Madeira (ü™µ): Comum - 50% de chance por planta
                        if (Math.random() < 0.5) loot.wood++;
                        
                        // Pedra (ü™®): Incomum - 20% de chance por planta
                        if (Math.random() < 0.2) loot.stone++;
                        
                        // Ma√ß√£ (üçé): Rara - 5% de chance por planta
                        if (Math.random() < 0.05) loot.apples++;
                    }
                }

                // Salvar no Invent√°rio
                if (loot.wood > 0 || loot.stone > 0 || loot.apples > 0) {
                    ganhouAlgo = true;
                    let recursosAtuais = StorageSeguro.get('recursos', { apples: 0, wood: 0, stone: 0 });
                    
                    recursosAtuais.apples = (recursosAtuais.apples || 0) + loot.apples;
                    recursosAtuais.wood = (recursosAtuais.wood || 0) + loot.wood;
                    recursosAtuais.stone = (recursosAtuais.stone || 0) + loot.stone;
                    
                    StorageSeguro.set('recursos', recursosAtuais);
                }
            }

            // Iniciar anima√ß√£o do tornado
            animarTornado().then(() => {
                // O jardimData j√° foi atualizado (limpo) durante a anima√ß√£o na fun√ß√£o animarTornado
                setAlvo(null, { render: false }); // Apenas resetar o alvo
                salvarTudo(); // Salvar o estado vazio
                renderJardim(); // Renderizar para garantir que est√° limpo
                
                // Mensagem de Feedback
                let msg = "Jardim limpo! üå™<br><br>Todas as plantas foram removidas.";
                
                if (ganhouAlgo) {
                    msg += "<br><br><strong>Recursos Coletados:</strong><br>";
                    if (loot.wood > 0) msg += `${loot.wood} ü™µ Madeira<br>`;
                    if (loot.stone > 0) msg += `${loot.stone} ü™® Pedra<br>`;
                    if (loot.apples > 0) msg += `${loot.apples} üçé Ma√ß√£<br>`;
                    msg += "<small>(Verifique seu invent√°rio)</small>";
                } else if (!modoFundoMar) {
                    msg += "<br><br><small>Nenhum recurso encontrado desta vez.</small>";
                }
                
                showModal({ 
                    text: msg, 
                    onConfirm: () => {} 
                });
            });
        }
    });
}


function animarTornado() {
    return new Promise((resolve) => {
        const totalCells = getTotalCells();
        let currentIndex = 0;
        
        // Fun√ß√£o para mostrar tornado em uma c√©lula e remover a planta
        function mostrarTornadoNoIndice(index) {
            // REMOVER PLANTA IMEDIATAMENTE do jardimData
            jardimData[index] = null;
            
            // Modo 3D
            const cells = document.querySelectorAll('.cell-3d');
            if (cells[index]) {
                // Remover spans e layers relacionados a plantas/caminhos, mas preservar pets e bolhas
                cells[index].querySelectorAll('.emoji-3d, .plant-spawn, .path-layer').forEach(el => el.remove());

                    // Remover divs com backgroundImage (ex: sprites de flor, texturas) exceto bolhas m√°gicas
                    Array.from(cells[index].children).forEach(child => {
                        if (child.nodeType === 1 && child.tagName === 'DIV') {
                            try {
                                const bg = getComputedStyle(child).backgroundImage;
                                if (bg && bg !== 'none' && !child.classList.contains('bolha-magica')) {
                                    child.remove();
                                }
                            } catch(e) {}
                        }
                    });

                    // Adicionar tornado
                    const tornado = document.createElement('span');
                    tornado.className = 'tornado-3d';
                    tornado.textContent = 'üå™';
                    cells[index].appendChild(tornado);
                    
                    // Remover ap√≥s anima√ß√£o
                    setTimeout(() => {
                        if (cells[index].contains(tornado)) {
                            cells[index].removeChild(tornado);
                        }
                    }, 500);
            } else {
                // Modo 2D
                const plots = document.querySelectorAll('.plot');
                if (plots[index]) {
                    const hasPet = petsEmCena.some(p => p.index === index);

                    // Se n√£o houver pet, remove todos os spans (plantas/tesouro)
                    if (!hasPet) {
                        plots[index].querySelectorAll('span.plant-spawn, span').forEach(s => {
                            // Evita remover elementos espec√≠ficos de UI que n√£o s√£o plantas (checagens extra se necess√°rio)
                            s.remove();
                        });
                    } else {
                        // Se houver pet, remove apenas spans marcados como plantas
                        plots[index].querySelectorAll('span.plant-spawn').forEach(s => s.remove());
                    }

                    // Remover divs com backgroundImage (sprites de flor/decora√ß√£o)
                    Array.from(plots[index].children).forEach(child => {
                        if (child.nodeType === 1 && child.tagName === 'DIV') {
                            try {
                                const bg = getComputedStyle(child).backgroundImage;
                                if (bg && bg !== 'none') child.remove();
                            } catch(e) {}
                        }
                    });

                    // Adicionar tornado
                    const tornado = document.createElement('span');
                    tornado.className = 'tornado-2d';
                    tornado.textContent = 'üå™';
                    plots[index].appendChild(tornado);
                    
                    // Remover ap√≥s anima√ß√£o
                    setTimeout(() => {
                        if (plots[index].contains(tornado)) {
                            plots[index].removeChild(tornado);
                        }
                    }, 500);
                }
            }
        }
        
        // Tocar som leve de vento durante o tornado
        try { if (typeof audioManager !== 'undefined' && audioManager.playWindBurst) audioManager.playWindBurst(totalCells * 50 + 400); } catch (e) {}

        // Animar tornado passando por todas as c√©lulas
        const interval = setInterval(() => {
            if (currentIndex >= totalCells) {
                clearInterval(interval);
                setTimeout(resolve, 600); // Dar tempo para √∫ltima anima√ß√£o
                return;
            }
            
            mostrarTornadoNoIndice(currentIndex);
            currentIndex++;
        }, 50); // Velocidade do tornado (ms entre c√©lulas)
    });
}
// Verificar atualiza√ß√µes automaticamente quando a p√°gina carrega
window.addEventListener('load', () => {
    // Verifica a cada 1 hora se h√° atualiza√ß√µes
    setInterval(() => {
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.ready.then(registration => {
                registration.update();
            });
        }
    }, 3600000); // 1 hora em milissegundos
});

if ('serviceWorker' in navigator) {
  window.addEventListener('load', async () => {
    try {
      const registration = await navigator.serviceWorker.register('./sw.js');

      // For√ßa checagem de atualiza√ß√£o sempre que o app abrir
      registration.update();

      // Se um novo SW for encontrado
      registration.addEventListener('updatefound', () => {
        const newWorker = registration.installing;

        newWorker.addEventListener('statechange', () => {
          if (
            newWorker.state === 'installed' &&
            navigator.serviceWorker.controller
          ) {
            // Novo SW ativo ‚Üí F5 sem d√≥
            window.location.reload();
          }
        });
      });
    } catch (err) {
      console.error('Erro ao registrar SW:', err);
    }
  });
}

// =========================
// PAGE VISIBILITY API - REATIVAR AO RETORNAR √Ä ABA
// =========================
document.addEventListener('visibilitychange', function() {
    if (!document.hidden) {
        // Usu√°rio retornou √† aba - reativar tudo
        console.log('Aba reativada - reiniciando timers');
        
        // 1. Reativar movimento dos pets se existir (Limpando antes para evitar duplicatas)
        if (typeof intervaloPets !== 'undefined' && typeof moverPetsLoop === 'function') {
            clearInterval(intervaloPets);
            intervaloPets = setInterval(moverPetsLoop, 3000);
        }
        
        // 2. Reativar produ√ß√£o da vaquinha se existir
        if (typeof iniciarProducaoVaquinha === 'function') {
            iniciarProducaoVaquinha();
        }
        
        // 3. Verificar tema autom√°tico se ativo
        if (typeof temaAutomaticoAtivo !== 'undefined' && temaAutomaticoAtivo && typeof verificarTemaAutomatico === 'function') {
            verificarTemaAutomatico();
        }
        
        // 4. Atualizar o timer de foco se estiver rodando
        if (typeof intervalo !== 'undefined' && intervalo) {
            // O timer j√° est√° rodando, apenas garantir que o display est√° atualizado
            if (typeof atualizarTimerDisplay === 'function') {
                atualizarTimerDisplay();
            }
        }
        
        // 5. Reativar anima√ß√µes de fundo se estiverem ativas
        if (typeof animacaoFundoAtiva !== 'undefined' && animacaoFundoAtiva && typeof particulasManager !== 'undefined') {
            if (typeof particulasManager.iniciar === 'function') {
                particulasManager.iniciar();
            }
        }
        
        // 6. Renderizar jardim para garantir que est√° atualizado
        if (typeof renderJardim === 'function') {
            renderJardim();
        }
        
        console.log('Todos os sistemas reativados com sucesso!');
    } else {
        // Usu√°rio saiu da aba
        console.log('Aba em segundo plano');
    }
});

</script>
  <script src="https://cdn.jsdelivr.net/npm/@twemoji/api@latest/dist/twemoji.min.js" crossorigin="anonymous"></script>

<style>
  /* 1. O SEGREDO: Deixa o texto invis√≠vel onde tiver emoji nativo */
  /* Isso evita que o emoji "feio" apare√ßa antes da troca */
  body {
    text-rendering: optimizeLegibility;
  }

  /* 2. Garante o tamanho correto e fixo */
  img.emoji {
     display: inline-block;
     height: 1em;
     width: 1em;
     margin: 0 .1em;
     vertical-align: -0.1em;
  }

  /* Previews: imagens de preview devem usar a classe .preview-img; n√£o tocar em img.emoji do Twemoji */
  .preview-temp img.preview-img,
  .preview-img {
      width: 100% !important;
      height: 100% !important;
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      display: block;
  }
</style>

<script>
 
let emojisAtivos = true;

// Aplica Twemoji
function fixEmojis() {
    if (!emojisAtivos) return;

    twemoji.parse(document.body, {
        folder: 'svg',
        ext: '.svg'
    });
}

// Ativa / desativa pelo toggle
function toggleEmojis() {
    emojisAtivos = !emojisAtivos;

    const btn = document.getElementById('btnEmojis');
    if (btn) btn.classList.toggle('on', emojisAtivos);

    if (emojisAtivos) {
        fixEmojis();
    } else {
        removerTwemoji();
    }

    localStorage.setItem('emojisAtivos', emojisAtivos);
}

// Remove os emojis do Twemoji e volta ao nativo
function removerTwemoji() {
    document.querySelectorAll('img.emoji').forEach(img => {
        const span = document.createTextNode(img.alt);
        img.replaceWith(span);
    });
}

// Carrega prefer√™ncia salva
document.addEventListener('DOMContentLoaded', () => {
    const salvo = localStorage.getItem('emojisAtivos');

    if (salvo !== null) {
        emojisAtivos = salvo === 'true';
    }

    const btn = document.getElementById('btnEmojis');
    if (btn) btn.classList.toggle('on', emojisAtivos);

    if (emojisAtivos) {
        fixEmojis();
    }

    // Atualiza sprite do bot√£o de plantar ao carregar a interface
    if (typeof updatePlantButtonSprite === 'function') updatePlantButtonSprite();
    
    // Solicitar permiss√£o para notifica√ß√µes
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
    }
    
    // Listener para visibilidade da p√°gina (manter app rodando em background)
    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            console.log('Aba invis√≠vel - pausando timers e heartbeat P2P');
            // Pausar timers via worker
            if (workerGlobal) {
                workerGlobal.postMessage({ comando: 'pausar_timer', id: 'plantarJuntos' });
                workerGlobal.postMessage({ comando: 'pausar_timer', id: 'principal' });
            }
            // Pausar heartbeat P2P para economizar
            if (intervalHeartbeatPJ) {
                clearInterval(intervalHeartbeatPJ);
                intervalHeartbeatPJ = null;
            }
        } else {
            console.log('Aba vis√≠vel - resumindo timers e P2P');
            // Resumir timers via worker
            if (workerGlobal) {
                workerGlobal.postMessage({ comando: 'resumir_timer', id: 'plantarJuntos' });
                workerGlobal.postMessage({ comando: 'resumir_timer', id: 'principal' });
            }
            // Retomar heartbeat P2P e verificar reconex√µes
            iniciarHeartbeatPJ();
            verificarReconexaoPJ();
            
            // Verificar conex√µes periodicamente por alguns minutos ap√≥s voltar
            let tentativasReconexao = 0;
            const maxTentativas = 10; // 10 tentativas a cada 5 segundos = 50 segundos
            
            const intervaloReconexao = setInterval(() => {
                if (tentativasReconexao >= maxTentativas || document.hidden) {
                    clearInterval(intervaloReconexao);
                    return;
                }
                
                verificarReconexaoPJ();
                tentativasReconexao++;
            }, 5000); // A cada 5 segundos
        }
    });
});

// Observer s√≥ atua se estiver ligado
const observer = new MutationObserver(() => {
    if (!emojisAtivos) return;

    observer.disconnect();
    fixEmojis();
    observer.observe(document.body, { childList: true, subtree: true });
});

observer.observe(document.body, { childList: true, subtree: true });
// =========================
// SISTEMA DE TESOURO DI√ÅRIO (ü™é) - CORRIGIDO
// =========================

function verificarSpawnTesouro() {
    const hoje = new Date().toDateString();
    
    // Se j√° coletou hoje, n√£o faz nada
    if (ultimoTesouroData === hoje) return;

    // Se j√° existe um tesouro no mapa mas n√£o foi coletado, mant√©m ele l√°
    if (tesouroAtivoIndex !== null) return;

    // Tenta encontrar um lugar vazio
    const totalCells = getTotalCells();
    let tentativas = 0;
    let spawnou = false;

    while (tentativas < 50 && !spawnou) {
        const randIndex = Math.floor(Math.random() * totalCells);
        
        const temPlanta = jardimData[randIndex] !== null;
        const temPet = petsEmCena.some(p => p.index === randIndex);
        
        if (!temPlanta && !temPet) {
            tesouroAtivoIndex = randIndex;
            StorageSeguro.set('tesouroAtivoIndex', tesouroAtivoIndex);
            // Marca que o tesouro j√° foi gerado hoje para evitar m√∫ltiplos spawns no mesmo dia
            ultimoTesouroData = hoje;
            StorageSeguro.set('ultimoTesouroData', ultimoTesouroData);
            spawnou = true;
            console.log("Tesouro spawnado no index:", randIndex);
        }
        tentativas++;
    }
}

function coletarTesouro(index) {
    if (index !== tesouroAtivoIndex) return;

    // Evita coleta duplicada: limpa o √≠ndice imediatamente e persiste
    tesouroAtivoIndex = null;
    StorageSeguro.set('tesouroAtivoIndex', null);

    // 1. Calcular Recompensas
    const moedasGanhas = Math.floor(Math.random() * 10) + 1; // 1 a 10 moedas
    const ganhouPerola = Math.random() < 0.10; // 10% de chance

    // 2. Aplicar Recompensas
    updateMoedas(moedasGanhas);
    console.log('Tesouro coletado:', moedasGanhas, 'moedas. Saldo:', totalMoedas);
    
    let msgPerola = "";
    if (ganhouPerola) {
        if (!RomanceManager.data.perolas) RomanceManager.data.perolas = 0;
        RomanceManager.data.perolas++;
        RomanceManager.save();
        msgPerola = "<br>‚ú® <strong>Sorte Grande!</strong> Voc√™ encontrou uma ü¶™ P√©rola do Mar!";
    }

    // 3. Limpar o tesouro dos dados
    ultimoTesouroData = new Date().toDateString();
    
    StorageSeguro.set('ultimoTesouroData', ultimoTesouroData);

    // 4. Feedback e Atualiza√ß√£o Visual
    showModal({
        text: `ü™é <strong>Tesouro Antigo Aberto!</strong><br><br>Voc√™ encontrou <strong>${moedasGanhas} moedas</strong>!${msgPerola}`,
        onConfirm: () => {}
    });

    if (typeof efeitosManager !== 'undefined') efeitosManager.chuvaDeEfeitos('ü™é', 15);
    
    // FOR√áA A ATUALIZA√á√ÉO IMEDIATA DO JARDIM PARA SUMIR O √çCONE
    renderJardim();
}
// =========================
// SISTEMA DE INVENT√ÅRIO (C√ìDIGO COMPLETO)
// =========================

function abrirInventario() {
    renderInventario();
    abrirModal('inventarioOverlay');
}

// =========================
// RENDERIZAR INVENT√ÅRIO (CORRIGIDO)
// =========================
function renderInventario() {
    const container = document.getElementById('listaInventario');
    if (!container) return;
    
    container.innerHTML = '';
    let itensExibidos = 0;

    // Fun√ß√£o auxiliar para HTML do controle de venda
    const gerarControleVenda = (tipo, preco, quantidadeAtual) => {
        const inputId = `qtd_venda_${tipo}`;
        return `
            <div class="controle-venda-container">
                <input type="number" 
                       id="${inputId}" 
                       value="1" 
                       min="1" 
                       max="${quantidadeAtual}" 
                       style="width: 50px; padding: 5px; border-radius: 8px; border: 1px solid #ccc; text-align: center; font-weight: bold;"
                       oninput="validarInputVenda(this, ${quantidadeAtual})">
                
                <button onclick="venderItemInventario('${tipo}', ${preco}, ${quantidadeAtual}, '${inputId}')" 
                        style="flex: 1; padding: 8px; cursor: pointer; background: #ff4d4d; color: white; border: none; border-radius: 50px; font-weight: bold; font-size: 12px;">
                    Vender
                </button>
            </div>
            <div style="text-align: center; margin-top: 4px;">
                <small style="color: var(--text-secondary); font-size: 10px;">Valor un: ${preco} üí∞</small>
            </div>
        `;
    };

    // 1. P√©rolas (Romance)
    if (typeof RomanceManager !== 'undefined' && RomanceManager.data && RomanceManager.data.perolas > 0) {
        itensExibidos++;
        const qtd = RomanceManager.data.perolas;
        const controleHtml = gerarControleVenda('perolas', 500, qtd);
        const controlePersonalizado = controleHtml.replace('#ff4d4d', '#4cc9f0'); // Azul para p√©rolas

        container.innerHTML += `
            <div class="item-loja" style="border: 2px solid #4cc9f0; background: linear-gradient(135deg, var(--bg-panel), #f0f8ff);">
                <div style="padding: 10px; display: flex; flex-direction: column; align-items: center;">
                    <div style="font-size: 35px; filter: drop-shadow(0 0 5px #4cc9f0);">ü¶™</div>
                    <div style="font-weight: bold; color: #003566; margin-top: 5px;">P√©rola</div>
                    <div style="font-size: 14px; font-weight: 900; color: #4cc9f0;">x${qtd}</div>
                </div>
                ${controlePersonalizado}
            </div>
        `;
    }

    // 2. Recursos (Ma√ß√£, Madeira, Pedra)
    // FIX: Garante que o objeto tenha todas as chaves mesmo se o save for antigo
    const recursosRaw = StorageSeguro.get('recursos', {});
    const recursos = { apples: 0, wood: 0, stone: 0, ...recursosRaw };

    const itensComuns = [
        { tipo: 'apples', icone: 'üçé', nome: 'Ma√ß√£', preco: 50 },
        { tipo: 'wood', icone: 'ü™µ', nome: 'Madeira', preco: 20 },
        { tipo: 'stone', icone: 'ü™®', nome: 'Pedra', preco: 15 }
    ];

    itensComuns.forEach(item => {
        if (recursos[item.tipo] > 0) {
            itensExibidos++;
            const qtd = recursos[item.tipo];
            
            container.innerHTML += `
                <div class="item-loja">
                    <div style="padding: 10px; display: flex; flex-direction: column; align-items: center;">
                        <div style="font-size: 35px;">${item.icone}</div>
                        <div style="font-weight: bold; margin-top: 5px;">${item.nome}</div>
                        <div style="font-size: 14px; font-weight: 900; color: var(--text-main);">x${qtd}</div>
                    </div>
                    ${gerarControleVenda(item.tipo, item.preco, qtd)}
                </div>
            `;
        }
    });

    // 3. Estado Vazio
    if (itensExibidos === 0) {
        container.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 30px; color: var(--text-secondary); opacity: 0.7;">
                <div style="font-size: 60px; margin-bottom: 15px;">üéí</div>
                <p>Seu invent√°rio est√° vazio.</p>
                <small>Use o bot√£o "Tornado" üå™ no jardim (ao lado de Iniciar Foco) para tentar coletar recursos ao limpar plantas.</small>
            </div>
        `;
    }
}

// Fun√ß√£o auxiliar para validar input em tempo real
function validarInputVenda(input, max) {
    let val = parseInt(input.value);
    if (isNaN(val) || val < 1) input.value = 1;
    if (val > max) input.value = max;
}

// =========================
// FUN√á√ÉO PARA VENDER ITEM (CORRIGIDA)
// =========================
function venderItemInventario(tipo, precoUnitario, maxQuantidade, inputId) {
    const nomes = { apples: "üçé Ma√ß√£", wood: "ü™µ Madeira", stone: "ü™® Pedra", perolas: "ü¶™ P√©rola" };
    const nomeItem = nomes[tipo] || tipo;

    const input = document.getElementById(inputId);
    if (!input) return;
    
    const qtdSelecionada = parseInt(input.value);

    if (isNaN(qtdSelecionada) || qtdSelecionada <= 0) {
        showToast('‚ùå', 'Erro', 'Quantidade inv√°lida');
        return;
    }

    if (qtdSelecionada > maxQuantidade) {
        showToast('‚ùå', 'Erro', 'Voc√™ n√£o tem tantos itens');
        return;
    }

    const totalGanho = qtdSelecionada * precoUnitario;

    // Confirma√ß√£o estilizada
    // Injeta CSS tempor√°rio para o alerta ficar acima do invent√°rio
    const styleZ = document.createElement('style');
    styleZ.textContent = `#customAlertOverlay { z-index: 30000; }`;
    document.head.appendChild(styleZ);

    showModal({
        text: `Vender <strong>${qtdSelecionada}x ${nomeItem}</strong>?<br><br>Receber√°: <span style="color:var(--primary); font-weight:bold; font-size:18px;">${totalGanho} üí∞</span>`,
        confirmText: "VENDER",
        
        onConfirm: () => {
            // Executar Venda
            if (tipo === 'perolas') {
                if (RomanceManager.data.perolas >= qtdSelecionada) {
                    RomanceManager.data.perolas -= qtdSelecionada;
                    RomanceManager.save();
                    updateMoedas(totalGanho);
                }
            } else {
                let recursos = StorageSeguro.get('recursos', { apples: 0, wood: 0, stone: 0 });
                // Merge para garantir integridade
                recursos = { apples: 0, wood: 0, stone: 0, ...recursos };
                
                if (recursos[tipo] >= qtdSelecionada) {
                    recursos[tipo] -= qtdSelecionada;
                    updateMoedas(totalGanho);
                    StorageSeguro.set('recursos', recursos);
                }
            }

            salvarTudo();
            
            // Efeito visual
            if (typeof chuvaDeEfeitos === 'function') chuvaDeEfeitos('üí∞', 10);
            
            showToast('üí∞', 'Venda realizada!', `+${totalGanho} moedas`);

            // Atualiza UI
            renderInventario();

            // Limpeza
            if (document.head.contains(styleZ)) document.head.removeChild(styleZ);
        },
        onCancel: () => {
            if (document.head.contains(styleZ)) document.head.removeChild(styleZ);
        }
    });
}



// =========================
// FUN√á√ÉO DE DEBUG: P√âROLAS
// =========================
function debugGanharPerola() {
    // Garante que a estrutura de dados exista
    if (!RomanceManager.data.perolas) {
        RomanceManager.data.perolas = 0;
    }

    // Adiciona a p√©rola
    RomanceManager.data.perolas++;
    
    // Salva no localStorage
    RomanceManager.save();

    // Feedback visual r√°pido
    console.log("Debug: P√©rola adicionada! Total: " + RomanceManager.data.perolas);
    
    // Se o modal de invent√°rio estiver aberto, ele atualiza em tempo real
    if (document.getElementById('inventarioOverlay').style.display === 'flex') {
        renderInventario();
    }

    // Notifica√ß√£o simples na tela (opcional, usando o sistema do jogo se existir)
    if (typeof showModal === 'function') {
        // Apenas um log ou um pequeno alerta para confirmar
    }
}

function debugAdicionar100Arvores() {
    const agora = new Date();
    const anoAtual = agora.getFullYear();
    const icones = ['üå≥', 'üå≤', 'üå¥', 'üåµ', 'üåª', 'üå∏'];
    const motivos = ['Foco', 'Estudo', 'Trabalho', 'Leitura', 'Medita√ß√£o'];
    
    for (let i = 0; i < 100; i++) {
        const dataAleatoria = new Date(anoAtual, Math.floor(Math.random() * 12), Math.floor(Math.random() * 28));
        historico.push({
            data: dataAleatoria.toISOString(),
            minutos: Math.floor(Math.random() * 60) + 10,
            status: 'sucesso',
            icone: icones[Math.floor(Math.random() * icones.length)],
            motivo: motivos[Math.floor(Math.random() * motivos.length)]
        });
    }
    
    salvarDados();
    if (typeof mostrarToast === 'function') {
        mostrarToast("üå≥ 100 √°rvores adicionadas ao hist√≥rico!", "success");
    } else {
        alert("üå≥ 100 √°rvores adicionadas ao hist√≥rico!");
    }
    
    if (document.getElementById('dashboardOverlay').style.display === 'flex') {
        renderizarDashboardGrid3D();
    }
}

// CORRE√á√ÉO VISUAL: Bolha M√°gica atr√°s do Pet
const styleFix = document.createElement('style');
styleFix.innerHTML = `
    .bolha-magica {
        z-index: 14; /* Reduzido para ficar atr√°s do pet (que √© 15) */
        background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.4), rgba(135,206,250,0.2)); /* Mais transparente */
    }
    .pet-3d {
        z-index: 20; /* Garante que o pet fique na frente */
    }
`;
document.head.appendChild(styleFix);



// Fun√ß√µes do Di√°rio Integrado na Estante
let diarioPaginaAtual = 0; // 0 ser√° a p√°gina de escrita (√∫ltima p√°gina)
let diarioFiltroTexto = '';
let diarioFiltroData = '';
let diarioFiltroHumor = '';
let diarioBuscaExpandida = false;

function abrirDiario() {
    diarioPaginaAtual = 0;
    diarioFiltroTexto = '';
    diarioFiltroData = '';
    diarioFiltroHumor = '';
    abrirModal('diarioOverlay');
    renderizarEntradasDiario();
}

function aplicarBuscaDiario() {
    diarioFiltroTexto = document.getElementById('buscaDiarioTexto').value.toLowerCase();
    diarioFiltroData = document.getElementById('buscaDiarioData').value;
    diarioFiltroHumor = document.getElementById('buscaDiarioHumor').value;
    
    if (diarioFiltroTexto || diarioFiltroData || diarioFiltroHumor) {
        showToast('üîç', 'Busca aplicada', 'Mostrando apenas mem√≥rias filtradas.');
    }
    
    diarioPaginaAtual = 0; // Volta para a p√°gina de escrita para ver o resultado da busca ao navegar
    renderizarEntradasDiario();
}

function limparBuscaDiario() {
    diarioFiltroTexto = '';
    diarioFiltroData = '';
    diarioFiltroHumor = '';
    diarioPaginaAtual = 0;
    renderizarEntradasDiario();
}

function alternarBuscaDiario() {
    diarioBuscaExpandida = !diarioBuscaExpandida;
    renderizarEntradasDiario();
}

function iniciarEdicaoDiario(id) {
    const diario = StorageSeguro.get('diario_entradas', []);
    const entrada = diario.find(e => e.id === id);
    if (!entrada) return;

    const divConteudo = document.getElementById(`conteudoMemoria_${id}`);
    divConteudo.innerHTML = `
        <textarea id="editarTextoDiario_${id}" class="diary-textarea" style="width: 100%; height: 200px; margin-top: 10px; background: rgba(255,255,255,0.5); border: 1px solid #8b4513; border-radius: 5px; padding: 10px;">${entrada.texto}</textarea>
        <div style="display: flex; gap: 10px; margin-top: 10px;">
            <button onclick="salvarEdicaoDiario(${id})" style="flex: 1; padding: 10px; background: #4caf50; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">Salvar Altera√ß√µes</button>
            <button onclick="renderizarEntradasDiario()" style="padding: 10px; background: #f44336; color: white; border: none; border-radius: 5px; cursor: pointer;">Cancelar</button>
        </div>
    `;
}

function salvarEdicaoDiario(id) {
    const novoTexto = document.getElementById(`editarTextoDiario_${id}`).value.trim();
    if (!novoTexto) {
        showToast('‚ö†Ô∏è', 'Campo vazio', 'O texto n√£o pode estar vazio!');
        return;
    }

    let diario = StorageSeguro.get('diario_entradas', []);
    const index = diario.findIndex(e => e.id === id);
    
    if (index !== -1) {
        const agora = new Date();
        const dataEditada = agora.toLocaleString('pt-BR', { 
            day: '2-digit', 
            month: '2-digit', 
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        diario[index].texto = novoTexto;
        diario[index].editadaEm = dataEditada;
        
        StorageSeguro.set('diario_entradas', diario);
        showToast('‚úèÔ∏è', 'Mem√≥ria atualizada', 'Sua nota foi editada com sucesso.');
        renderizarEntradasDiario();
    }
}

function mudarPaginaDiario(direcao) {
    // Dire√ß√£o -1 vai para mem√≥rias antigas (aumenta o √≠ndice)
    // Dire√ß√£o +1 volta para a p√°gina de escrita (diminui o √≠ndice)
    diarioPaginaAtual -= direcao; 
    renderizarEntradasDiario();
}

function salvarEntradaDiario() {
    const texto = document.getElementById('diarioTexto').value.trim();
    const humor = document.getElementById('diarioHumor').value;
    
    if (!texto) {
        showToast('‚ö†Ô∏è', 'Campo vazio', 'Escreva algo antes de salvar!');
        return;
    }
    
    const agora = new Date();
    const data = agora.toLocaleString('pt-BR', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric', 
        hour: '2-digit', 
        minute: '2-digit' 
    });
    
    let diario = StorageSeguro.get('diario_entradas', []);
    diario.unshift({ 
        id: Date.now(),
        data: agora.toISOString(), 
        dataFormatada: data,
        humor: humor, 
        texto: texto 
    });
    
    StorageSeguro.set('diario_entradas', diario);
    
    // Limpar campos
    document.getElementById('diarioTexto').value = '';
    document.getElementById('diarioHumor').value = 'üòä';
    
    // Atualizar lista
    renderizarEntradasDiario();
    
    // Mostrar notifica√ß√£o
    showToast('üìî', 'Entrada salva!', 'Sua reflex√£o foi guardada no di√°rio.');
}

function renderizarEntradasDiario() {
    const container = document.getElementById('diarioPaginaConteudo');
    const paginacaoInfo = document.getElementById('diarioPaginaAtual');
    const btnAnterior = document.getElementById('btnDiarioAnterior');
    const btnProximo = document.getElementById('btnDiarioProximo');
    
    if (!container) return;
    
    let diarioOriginal = StorageSeguro.get('diario_entradas', []);
    let diario = [...diarioOriginal];
    
    // Aplicar filtros se existirem
    if (diarioFiltroTexto) {
        diario = diario.filter(e => e.texto.toLowerCase().includes(diarioFiltroTexto));
    }
    if (diarioFiltroData) {
        diario = diario.filter(e => e.data.startsWith(diarioFiltroData));
    }
    if (diarioFiltroHumor) {
        diario = diario.filter(e => e.humor === diarioFiltroHumor);
    }

    const totalMemorias = diario.length;
    const totalPaginas = totalMemorias + 1; // +1 para a p√°gina de escrita
    
    // Garantir limites
    if (diarioPaginaAtual < 0) diarioPaginaAtual = 0;
    if (diarioPaginaAtual >= totalPaginas) diarioPaginaAtual = totalPaginas - 1;
    
    // Atualizar controles de pagina√ß√£o
    if (paginacaoInfo) {
        if (diarioPaginaAtual === 0) {
            paginacaoInfo.textContent = `Nova Entrada (P√°g. ${totalPaginas})`;
        } else {
            paginacaoInfo.textContent = `Mem√≥ria ${diarioPaginaAtual} de ${totalMemorias} (P√°g. ${totalPaginas - diarioPaginaAtual})`;
        }
    }
    
    if (btnAnterior) {
        btnAnterior.disabled = diarioPaginaAtual >= totalPaginas - 1;
        btnAnterior.style.opacity = btnAnterior.disabled ? '0.3' : '1';
    }
    if (btnProximo) {
        btnProximo.disabled = diarioPaginaAtual <= 0;
        btnProximo.style.opacity = btnProximo.disabled ? '0.3' : '1';
    }
    
    if (diarioPaginaAtual === 0) {
        // Renderizar p√°gina de escrita
        container.innerHTML = `
            <div class="diary-input-area" style="flex: 1; display: flex; flex-direction: column;">
                <!-- Se√ß√£o de Busca Compacta -->
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <button onclick="alternarBuscaDiario()" style="flex: 1; padding: 8px; background: ${diarioBuscaExpandida ? '#5d4037' : 'rgba(139, 69, 19, 0.1)'}; color: ${diarioBuscaExpandida ? 'white' : '#8b4513'}; border: 1px solid #8b4513; border-radius: 50px; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; transition: all 0.3s;">
                            ${diarioBuscaExpandida ? '‚úï Fechar Busca' : 'üîç Pesquisar no Di√°rio'}
                        </button>
                        ${(diarioFiltroTexto || diarioFiltroData || diarioFiltroHumor) ? `
                            <button onclick="limparBuscaDiario()" style="padding: 8px 15px; background: #f44336; color: white; border: none; border-radius: 50px; font-size: 12px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">Limpar</button>
                        ` : ''}
                    </div>

                    <div id="painelBuscaDiario" style="display: ${diarioBuscaExpandida ? 'block' : 'none'}; background: rgba(139, 69, 19, 0.05); padding: 12px; border-radius: 15px; margin-top: 10px; border: 1px solid rgba(139, 69, 19, 0.1); animation: fadeIn 0.3s ease;">
                        <div style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 10px;">
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="buscaDiarioTexto" value="${diarioFiltroTexto}" placeholder="Palavras-chave..." style="flex: 2; padding: 8px; border-radius: 8px; border: 1px solid #8b4513; background: #fff9e6; font-size: 12px;">
                                <input type="date" id="buscaDiarioData" value="${diarioFiltroData}" style="flex: 1; padding: 8px; border-radius: 8px; border: 1px solid #8b4513; background: #fff9e6; font-size: 12px;">
                            </div>
                            <select id="buscaDiarioHumor" style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #8b4513; background: #fff9e6; font-size: 12px; color: #3e2723;">
                                <option value="">üé≠ Todas as emo√ß√µes</option>
                                <option value="üòä" ${diarioFiltroHumor === 'üòä' ? 'selected' : ''}>üòä Feliz</option>
                                <option value="üòå" ${diarioFiltroHumor === 'üòå' ? 'selected' : ''}>üòå Calmo</option>
                                <option value="üòê" ${diarioFiltroHumor === 'üòê' ? 'selected' : ''}>üòê Neutro</option>
                                <option value="üòî" ${diarioFiltroHumor === 'üòî' ? 'selected' : ''}>üòî Triste</option>
                                <option value="üò¥" ${diarioFiltroHumor === 'üò¥' ? 'selected' : ''}>üò¥ Cansado</option>
                                <option value="üò§" ${diarioFiltroHumor === 'üò§' ? 'selected' : ''}>üò§ Frustrado</option>
                                <option value="üôè" ${diarioFiltroHumor === 'üôè' ? 'selected' : ''}>üôè Grato</option>
                            </select>
                        </div>
                        <button onclick="aplicarBuscaDiario()" style="width: 100%; padding: 10px; background: #8b4513; color: white; border: none; border-radius: 50px; font-size: 12px; font-weight: bold; cursor: pointer; transition: background 0.2s;">
                            Aplicar Filtros
                        </button>
                    </div>
                </div>

                <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 15px;">
                    <label style="font-family: 'Georgia', serif; color: #5d4037; font-weight: bold;">Humor:</label>
                    <select id="diarioHumor" style="flex: 1; padding: 8px; border-radius: 5px; border: 1px solid #8b4513; background: #fff9e6; color: #3e2723;">
                        <option value="üòä">üòä Feliz</option>
                        <option value="üòå">üòå Calmo</option>
                        <option value="üòê">üòê Neutro</option>
                        <option value="üòî">üòî Triste</option>
                        <option value="üò¥">üò¥ Cansado</option>
                        <option value="üò§">üò§ Frustrado</option>
                        <option value="üôè">üôè Grato</option>
                    </select>
                </div>
                <textarea id="diarioTexto" class="diary-textarea" style="flex: 1; min-height: 150px;" placeholder="Querido di√°rio, hoje eu..."></textarea>
                <button onclick="salvarEntradaDiario()" style="width: 100%; padding: 12px; background: #8b4513; color: white; border: none; border-radius: 50px; font-weight: bold; cursor: pointer; margin-top: 15px; box-shadow: 0 4px 0 #5d4037;">‚úçÔ∏è Escrever no Di√°rio</button>
            </div>
        `;
    } else {
        // Renderizar uma mem√≥ria espec√≠fica (√≠ndice diarioPaginaAtual - 1)
        const entrada = diario[diarioPaginaAtual - 1];
        container.innerHTML = `
            <div class="diary-entry" style="flex: 1; display: flex; flex-direction: column; border: none; background: transparent; padding: 0;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; border-bottom: 1px solid rgba(139, 69, 19, 0.2); padding-bottom: 10px;">
                    <div>
                        <small style="color: #8b4513; font-weight: bold; font-family: 'Georgia', serif; font-size: 14px;">${entrada.dataFormatada}</small>
                        ${entrada.editadaEm ? `<br><small style="color: #d32f2f; font-style: italic; font-size: 11px;">editada em ${entrada.editadaEm}</small>` : ''}
                        <div style="font-size: 30px; margin-top: 10px;">${entrada.humor}</div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="iniciarEdicaoDiario(${entrada.id})" style="background: #8b4513; color: white; border: none; border-radius: 5px; padding: 5px 10px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 5px;">‚úèÔ∏è Editar</button>
                        <button onclick="deletarEntradaDiario(${entrada.id})" style="background: none; color: #8b4513; border: 1px solid #8b4513; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center;" title="Apagar mem√≥ria">‚úï</button>
                    </div>
                </div>
                <div id="conteudoMemoria_${entrada.id}" style="flex: 1;">
                    <p style="margin: 10px 0 0 0; color: #3e2723; line-height: 1.8; white-space: pre-wrap; word-wrap: break-word; font-style: italic; font-size: 18px; font-family: 'Courier New', Courier, monospace;">${escapeHtml(entrada.texto)}</p>
                </div>
            </div>
        `;
    }
}

function deletarEntradaDiario(id) {
    // Garantir que o alerta fique acima do di√°rio (z-index do di√°rio √© 45000)
    const styleZ = document.createElement('style');
    styleZ.id = 'tempStyleDiarioZ';
    styleZ.textContent = `#customAlertOverlay { z-index: 100000; }`;
    document.head.appendChild(styleZ);

    showModal({
        text: 'üóëÔ∏è <strong>Deletar entrada?</strong><br>Esta a√ß√£o n√£o pode ser desfeita.',
        onConfirm: () => {
            let diario = StorageSeguro.get('diario_entradas', []);
            diario = diario.filter(e => e.id !== id);
            StorageSeguro.set('diario_entradas', diario);
            renderizarEntradasDiario();
            showToast('üóëÔ∏è', 'Entrada deletada', 'A entrada foi removida do di√°rio.');
            if (document.getElementById('tempStyleDiarioZ')) document.getElementById('tempStyleDiarioZ').remove();
        },
        onCancel: () => {
            if (document.getElementById('tempStyleDiarioZ')) document.getElementById('tempStyleDiarioZ').remove();
        }
    });
}

// Fun√ß√£o auxiliar para escapar HTML
function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
}

// ==========================================
// üìî NOVO DI√ÅRIO (100% via StorageSeguro)
// ==========================================

async function salvarNoLivro() {
    const texto = document.getElementById('textoMsg').value;
    const humor = document.getElementById('humorSel').value;
    const data = new Date().toLocaleString();

    if(!texto) return alert("Escreve algo!");

    try {
        // 1. Pega os dados antigos do banco (await)
        let historico = (await StorageSeguro.get('meuDiario')) || [];
        
        // 2. Adiciona o novo
        historico.unshift({ data, humor, texto });
        
        // 3. Salva de volta no banco
        await StorageSeguro.set('meuDiario', historico);

        document.getElementById('textoMsg').value = '';
        alert("Gravado no Banco de Dados!");
        
        // Atualiza a visualiza√ß√£o se estiver aberta
        abrirLivro(); 
    } catch (e) {
        console.error(e);
        alert("Erro ao salvar no banco.");
    }
}

async function abrirLivro() {
    const lista = document.getElementById('listaEntradas');
    lista.innerHTML = "Carregando mem√≥rias...";

    try {
        // Busca do banco assincronamente
        let historico = (await StorageSeguro.get('meuDiario')) || [];
        
        if (historico.length === 0) {
            lista.innerHTML = "<p style='text-align:center; padding:20px'>O di√°rio est√° vazio.</p>";
            return;
        }

        lista.innerHTML = historico.map(e => `
            <div style="border-bottom:1px solid #ccc; padding: 10px 0;">
                <small style="color:#666">üìÖ ${e.data} | üé≠ ${e.humor}</small>
                <p style="margin-top:5px; font-size:1.1em">${escapeHtml(e.texto)}</p>
            </div>
        `).join('');
    } catch (e) {
        lista.innerHTML = "Erro ao ler o di√°rio.";
        console.error(e);
    }
}

/* ==========================================
   GERENCIADOR DE JARDINS (FIXED & NO-ROTATION)
   ========================================== */
const JardinsManager = {
    currentScale: 1, // Controle de zoom interno

    // Carrega com fallback para garantir persist√™ncia
    getSaved: function() {
        // Tenta pegar do sistema seguro primeiro
        let dados = StorageSeguro.get('meus_jardins_salvos', null);
        
        // Se falhar ou estiver vazio, tenta o backup f√≠sico do localStorage
        if (!dados || (Array.isArray(dados) && dados.length === 0)) {
            try {
                const backup = localStorage.getItem('meus_jardins_salvos_backup');
                if (backup) {
                    dados = JSON.parse(backup);
                    // Sincroniza de volta para o sistema seguro
                    StorageSeguro.set('meus_jardins_salvos', dados);
                }
            } catch(e) {
                console.error("Erro ao ler backup de jardins", e);
            }
        }
        
        // Migra√ß√£o para novos formatos
        if (Array.isArray(dados)) {
            dados = dados.map(jardim => {
                if (jardim.grid10x10 !== undefined && jardim.gridSize === undefined) {
                    jardim.gridSize = jardim.grid10x10 ? 10 : 5;
                    delete jardim.grid10x10; // Remove o campo antigo
                }
                return jardim;
            });
            // Salva a vers√£o migrada
            this.salvarDados(dados);
        }
        
        return Array.isArray(dados) ? dados : [];
    },

    salvarDados: function(dados) {
        // Salva em ambos os lugares para garantir
        StorageSeguro.set('meus_jardins_salvos', dados);
        localStorage.setItem('meus_jardins_salvos_backup', JSON.stringify(dados));
    },

    abrirMenu: function() {
        abrirModal('jardinsOverlay');
        this.renderizarLista();
        this.fecharVisualizador(); // Garante estado inicial
    },

    salvarAtual: function() {
        const salvos = [...this.getSaved()]; // Cria c√≥pia limpa do array
        if (salvos.length >= 5) {
            showModal({ text: "‚ö†Ô∏è Limite atingido (5/5)! Exclua um jardim antigo para salvar um novo.", onConfirm: () => {} });
            return;
        }

        const temPlantas = jardimData.some(item => item !== null);
        if (!temPlantas) {
            showModal({ text: "O jardim est√° vazio! Plante algo antes de salvar.", onConfirm: () => {} });
            return;
        }

        showModal({ 
            text: "Nome do Jardim (ex: Recanto de Paz):", 
            showInput: true,
            confirmText: "Salvar",
            onConfirm: (nome) => {
                if (!nome || !nome.trim()) nome = "Jardim sem nome";
                
                const novoJardim = {
                    id: Date.now(),
                    nome: nome.trim(),
                    dataCriacao: new Date().toLocaleDateString(),
                    gridSize: gridSize,
                    itens: JSON.parse(JSON.stringify(jardimData)), // Snapshot profundo
                    modoOrigem: modoFundoMar ? 'fundoMar' : (modoEurosummer ? 'euro' : 'terra')
                };

                salvos.push(novoJardim);
                this.salvarDados(salvos); // Salva com persist√™ncia dupla
                showToast('üíæ', 'Jardim Salvo!', 'Salvo com sucesso');
                this.renderizarLista();
            }
        });
    },

    excluir: function(id) {
        showModal({ 
            text: "Tem certeza que deseja excluir este jardim salvo?", 
            onConfirm: () => {
                let salvos = this.getSaved();
                salvos = salvos.filter(j => j.id !== id);
                this.salvarDados(salvos);
                this.renderizarLista();
            }
        });
    },

    renderizarLista: function() {
        const lista = document.getElementById('listaJardinsSalvos');
        if(!lista) return;
        
        const salvos = this.getSaved();
        lista.innerHTML = '';

        if (salvos.length === 0) {
            lista.innerHTML = '<div style="text-align:center; padding:20px; color:#999; font-style:italic; background:rgba(0,0,0,0.02); border-radius:10px;">Nenhum jardim salvo ainda.</div>';
            return;
        }

        salvos.forEach(jardim => {
            const item = document.createElement('div');
            item.style.cssText = `
                background: var(--bg-body);
                border: 1px solid rgba(0,0,0,0.1);
                border-radius: 12px;
                padding: 12px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            `;
            
            item.innerHTML = `
                <div style="text-align: left;">
                    <div style="font-weight: bold; color: var(--text-main); font-size:14px;">${jardim.nome}</div>
                    <div style="font-size: 10px; color: var(--text-secondary); margin-top:2px;">
                        üìê ${jardim.gridSize}x${jardim.gridSize} ‚Ä¢ üìÖ ${jardim.dataCriacao}
                    </div>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button onclick="JardinsManager.visualizar(${jardim.id})" style="padding: 6px 12px; font-size: 12px; background: var(--primary); color:white; border:none; border-radius: 50px; cursor:pointer;">üëÅÔ∏è Ver</button>
                    <button onclick="JardinsManager.excluir(${jardim.id})" style="padding: 6px 10px; font-size: 12px; background: #ff5252; color:white; border:none; border-radius: 50px; cursor:pointer;">üóëÔ∏è</button>
                </div>
            `;
            lista.appendChild(item);
        });
    },

    visualizar: function(id) {
        const salvos = this.getSaved();
        const jardim = salvos.find(j => j.id === id);
        if (!jardim) return;

        // Alterna visibilidade
        document.getElementById('listaJardinsSalvos').style.display = 'none';
        document.getElementById('btnSalvarJardim').style.display = 'none';
        document.getElementById('visualizadorJardimContainer').style.display = 'block';
        document.getElementById('tituloVisualizador').textContent = `üëÅÔ∏è ${jardim.nome}`;
        
        this.renderizarCena3D(jardim);
    },

    fecharVisualizador: function() {
        const container = document.getElementById('visualizadorJardimContainer');
        if(container) container.style.display = 'none';
        
        const lista = document.getElementById('listaJardinsSalvos');
        if(lista) lista.style.display = 'flex';
        
        const btn = document.getElementById('btnSalvarJardim');
        if(btn) btn.style.display = 'block';
        
        document.getElementById('cenaJardimEspectador').innerHTML = '';
        this.currentScale = 1; // Reseta zoom
    },

    zoom: function(delta) {
        const grid = document.querySelector('.spec-grid');
        if (!grid) return;
        
        let newScale = this.currentScale + delta;
        if (newScale >= 0.5 && newScale <= 2.5) {
            this.currentScale = newScale;
            // Mant√©m rota√ß√£o fixa, muda apenas a escala
            grid.style.transform = `scale(${this.currentScale}) rotateX(60deg) rotateZ(45deg)`;
        }
    },

    renderizarCena3D: function(jardim) {
        const container = document.getElementById('cenaJardimEspectador');
        container.innerHTML = '';
        
        const gridSize = jardim.gridSize || 5; // Fallback para compatibilidade com salvamentos antigos
        const totalCells = gridSize * gridSize;
        // Ajusta tamanho da c√©lula para caber no container sem overflow excessivo
        let cellSize = gridSize >= 8 ? 25 : 45;

        // CSS Espec√≠fico do Visualizador (Est√°tico)
        const style = document.createElement('style');
        style.textContent = `
            .spec-scene { perspective: 1500px; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; overflow: hidden; /* Cursor padr√£o pois n√£o h√° arraste */ cursor: default; }
            .spec-grid { display: grid; grid-template-columns: repeat(${gridSize}, ${cellSize}px); grid-template-rows: repeat(${gridSize}, ${cellSize}px); gap: 2px; transform-style: preserve-3d; background-color: var(--grid-border); padding: 2px; /* Rota√ß√£o Fixa Inicial */ transform: scale(1) rotateX(60deg) rotateZ(45deg); transition: transform 0.3s ease-out; /* Suaviza o zoom */ }
            .spec-grid::before { content: ''; position: absolute; top: 100%; left: 0; width: 100%; height: 15px; background: var(--side-color); transform-origin: top; transform: rotateX(-90deg); }
            .spec-grid::after { content: ''; position: absolute; top: 0; left: 100%; width: 15px; height: 100%; background: var(--bottom-color); transform-origin: left; transform: rotateY(90deg); }
            .spec-cell { width: ${cellSize}px; height: ${cellSize}px; background-color: var(--grid-color); background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 40 40"><path d="M5 35 L10 30 L15 35 Z" fill="%237db336" opacity="0.6"/><path d="M25 15 L30 10 L35 15 Z" fill="%237db336" opacity="0.6"/></svg>'); background-size: ${cellSize}px ${cellSize}px; display: flex; align-items: center; justify-content: center; transform-style: preserve-3d; position: relative; }
            .spec-path-layer { position: absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; }
            .spec-item { font-size: ${Math.floor(cellSize * 0.75)}px; position: absolute; /* Corre√ß√£o de posicionamento do emoji 3D */ }
            .spec-item-sprite { position: absolute; width: 100%; height: 100%; background-size: contain; background-repeat: no-repeat; background-position: center bottom; pointer-events: none; }
        `;
        container.appendChild(style);

        const scene = document.createElement('div');
        scene.className = 'spec-scene';
        const grid = document.createElement('div');
        grid.className = 'spec-grid';
        // Este visualizador n√£o deve mostrar previews por padr√£o
        grid.dataset.previewEnabled = 'true';

        // Arrays de tipos especiais
        const caminhos = TIPOS_CAMINHO;
        const floresEspeciais = ['üåª', 'üåπ', 'üå∑'];
        const arvoresEspeciais = ['arvore-rosa','arvore-roxa','arvore-amarela','arvore-branca','arvore-colmeia','arvore-frutifera'];

        // Renderiza c√©lulas
        for (let i = 0; i < totalCells; i++) {
            const cell = document.createElement('div');
            cell.className = 'spec-cell';
            const itemData = jardim.itens[i];

            if (itemData && itemData.icone) {
                const isCaminho = caminhos.includes(itemData.icone);
                const isFlor = floresEspeciais.includes(itemData.icone);
                const isArvore = arvoresEspeciais.includes(iconKey(itemData.icone));

                if (isCaminho) {
                    // --- L√ìGICA DE CONEX√ïES PARA O GRID SALVO ---
                    const x = i % gridSize;
                    const y = Math.floor(i / gridSize);
                    
                    const check = (dx, dy) => {
                        const nx = x + dx;
                        const ny = y + dy;
                        if (nx < 0 || nx >= gridSize || ny < 0 || ny >= gridSize) return false;
                        const ni = ny * gridSize + nx;
                        const nItem = jardim.itens[ni];
                        return nItem && caminhos.includes(nItem.icone);
                    };

                    const conexoes = {
                        norte: check(0, -1),
                        sul: check(0, 1),
                        leste: check(1, 0),
                        oeste: check(-1, 0)
                    };
                    // Detecta se est√° na borda do grid
                    const isBorda = {
                        norte: y === 0,
                        sul: y === gridSize - 1,
                        oeste: x === 0,
                        leste: x === gridSize - 1
                    };
                    // Gera textura e aplica como camada
                    const svgBackground = gerarTexturaCaminho(conexoes, itemData.icone, isBorda);
                    const layer = document.createElement('div');
                    layer.style.cssText = `position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-size: cover; background-repeat: no-repeat; pointer-events: none; transform-style: preserve-3d; background-image: url('${svgBackground}');`;
                    
                    // Remove borda da c√©lula base para ficar cont√≠nuo
                    cell.style.borderColor = 'rgba(0,0,0,0.05)';
                    cell.appendChild(layer);

                } else if (isFlor && typeof gerarSpriteFlor === 'function') {
                    // --- L√ìGICA DE FLORES ESPECIAIS ---
                    const svgSprite = gerarSpriteFlor(itemData.icone);
                    const florElem = document.createElement('div');
                    florElem.classList.add('spec-item-sprite');
                    florElem.style.backgroundImage = `url('${svgSprite}')`;
                    
                    // Alinhamento 3D correto
                    florElem.style.left = '50%';
                    florElem.style.top = '50%';
                    florElem.style.width = '120%';
                    florElem.style.height = '120%';
                    florElem.style.transform = `translate(-50%, -50%) rotateZ(-45deg) rotateX(-90deg) translateY(-8px) scale(0.85)`;
                    florElem.style.transformOrigin = 'center bottom';
                    
                    cell.appendChild(florElem);

                } else if (isArvore && typeof gerarSpriteArvore === 'function') {
                    // --- L√ìGICA DE √ÅRVORES ESPECIAIS ---
                    const svgSprite = gerarSpriteArvore(itemData.icone);
                    const treeElem = document.createElement('div');
                    treeElem.classList.add('spec-item-sprite');
                    treeElem.style.backgroundImage = `url('${svgSprite}')`;
                    
                    // Alinhamento 3D correto para √°rvores (maiores)
                    treeElem.style.left = '50%';
                    treeElem.style.top = '50%';
                    treeElem.style.width = '200%';
                    treeElem.style.height = '200%';
                    treeElem.style.transform = `translate(-50%, -50%) rotateZ(-45deg) rotateX(-90deg) translateY(-15px) scale(1)`;
                    treeElem.style.transformOrigin = 'center bottom';
                    
                    cell.appendChild(treeElem);

                } else if (['lago', 'poste-luz', 'banco-praca', 'piquenique', 'gazebo', 'pote_ouro', 'escorrega_azul', 'baloi√ßo_madeira', 'baloi√ßo_pneus', 'baloi√ßo_mola'].includes(iconKey(itemData.icone))) {
                    // --- L√ìGICA DE ITENS DECORATIVOS E LAGO ---
                    let svgSprite = '';
                    let scale = 0.85;
                    let translateY = -10;
                    const icone = iconKey(itemData.icone);
                    
                    if (icone === 'lago' && typeof gerarSpriteLago === 'function') {
                        svgSprite = gerarSpriteLago(icone); scale = 0.7; translateY = -5;
                    } else if (icone === 'poste-luz' && typeof gerarSpritePosteLuz === 'function') {
                        svgSprite = gerarSpritePosteLuz(icone); scale = 0.8; translateY = -20;
                    } else if (icone === 'banco-praca' && typeof gerarSpriteBancoPraca === 'function') {
                        svgSprite = gerarSpriteBancoPraca(icone); scale = 0.85; translateY = -10;
                    } else if (icone === 'piquenique' && typeof gerarSpritePiquenique === 'function') {
                        svgSprite = gerarSpritePiquenique(icone); scale = 0.85; translateY = -8;
                    } else if (icone === 'gazebo' && typeof gerarSpriteGazebo === 'function') {
                        svgSprite = gerarSpriteGazebo(icone); scale = 0.85; translateY = -15;
                    } else if (icone === 'pote_ouro' && typeof gerarSpritePoteOuro === 'function') {
                        svgSprite = gerarSpritePoteOuro(); scale = 0.85; translateY = -10;
                    } else if (icone === 'escorrega_azul' && typeof gerarSpriteEscorrega === 'function') {
                        svgSprite = gerarSpriteEscorrega(); scale = 0.9; translateY = -15;
                    } else if (icone === 'baloi√ßo_madeira' && typeof gerarSpriteBaloi√ßoMadeira === 'function') {
                        svgSprite = gerarSpriteBaloi√ßoMadeira(); scale = 0.9; translateY = -15;
                    } else if (icone === 'baloi√ßo_pneus' && typeof gerarSpriteBaloi√ßoPneus === 'function') {
                        svgSprite = gerarSpriteBaloi√ßoPneus(); scale = 0.9; translateY = -15;
                    } else if (icone === 'baloi√ßo_mola' && typeof gerarSpriteBaloi√ßoMola === 'function') {
                        svgSprite = gerarSpriteBaloi√ßoMola(); scale = 0.9; translateY = -15;
                    }

                    if (svgSprite) {
                        const decorElem = document.createElement('div');
                        decorElem.classList.add('spec-item-sprite');
                        decorElem.style.backgroundImage = `url('${svgSprite}')`;
                        decorElem.style.left = '50%';
                        decorElem.style.top = '50%';
                        decorElem.style.width = '120%';
                        decorElem.style.height = '120%';
                        decorElem.style.transform = `translate(-50%, -50%) rotateZ(-45deg) rotateX(-90deg) translateY(${translateY}px) scale(${scale})`;
                        decorElem.style.transformOrigin = 'center bottom';
                        cell.appendChild(decorElem);
                    } else {
                        // Fallback emoji se a fun√ß√£o do sprite n√£o existir
                        const item = document.createElement('div');
                        item.className = 'spec-item';
                        item.textContent = itemData.icone;
                        item.style.left = '50%';
                        item.style.top = '50%';
                        const offset = Math.floor(cellSize * 0.45);
                        item.style.transform = `translate(-50%, -50%) rotateZ(-45deg) rotateX(-90deg) translateY(-${offset}px)`;
                        cell.appendChild(item);
                    }

                } else {
                    // --- RENDERIZA√á√ÉO PADR√ÉO (Emoji) ---
                    const item = document.createElement('div');
                    item.className = 'spec-item';
                    item.textContent = itemData.icone;
                    
                    // Alinhamento centralizado para emojis comuns
                    item.style.left = '50%';
                    item.style.top = '50%';
                    const offset = Math.floor(cellSize * 0.45);
                    item.style.transform = `translate(-50%, -50%) rotateZ(-45deg) rotateX(-90deg) translateY(-${offset}px)`;
                    
                    cell.appendChild(item);
                }

                // Tooltip simples ao clicar/tecar (touch) na planta
                addTapHandler(cell, (e) => {
                    if (e && e.stopPropagation) e.stopPropagation();
                    const motivo = itemData.motivo || 'Planta';
                    const icone = itemData.icone;
                    if(typeof showToast === 'function') {
                        showToast(icone, motivo, 'Detalhes do item salvo');
                    }
                });
                cell.setAttribute('data-tap-bound', '1');
                cell.style.cursor = 'help';
            }
            grid.appendChild(cell);
        }
        scene.appendChild(grid);
        container.appendChild(scene);

        // Suporte apenas para Zoom com Scroll (sem rota√ß√£o)
        scene.onwheel = (e) => {
            e.preventDefault();
            const delta = e.deltaY > 0 ? -0.1 : 0.1;
            this.zoom(delta);
        };
        
        // Aplica corre√ß√£o de emojis se dispon√≠vel
        if (typeof fixEmojis === 'function') fixEmojis();
    }
};


// Fun√ß√£o global de acesso ao menu
function abrirMenuJardins() {
    JardinsManager.abrirMenu();
}
// ==========================================
// SISTEMA DE CAMINHOS INTELIGENTES (AUTO-TILE)
// ==========================================

/**
 * Gera o SVG do caminho baseado nas conex√µes
 */
function gerarTexturaCaminho(conexoes, tipoIcone, isBorda) {
    // Defini√ß√£o de cores e flags

    let corEstrada, corBorda, corDetalhe;
    let isAsfalto = false;
    let isPedra = false;
    let isAgua = false;
    let defsPattern = "";
    const aguaDefs = `
            <defs>
                <pattern id="patAgua" x="0" y="0" width="20" height="20" patternUnits="userSpaceOnUse">
                    <path d="M0 10 Q 5 15 10 10 T 20 10 V20 H0Z" fill="#90e0ef" opacity="0.5"/>
                </pattern>
            </defs>`;

    // 1. ASFALTO
    if (tipoIcone.includes('üõ£')) { 
        isAsfalto = true;
        corEstrada = '#34495e'; // Cinza Escuro
        corBorda = '#ecf0f1';   // Branco (Faixas laterais)
        corDetalhe = '#f1c40f'; // Amarelo (Faixa central)
    } 
    // 2. PEDRA / TIJOLO
    else if (tipoIcone.includes('üß±')) { 
        isPedra = true;
        corEstrada = '#7f8c8d'; // Cinza M√©dio (Fundo)
        corBorda = '#2c3e50';   // Cinza Escuro (Borda)
        // Define o padr√£o de "poucas pedrinhas"
        defsPattern = `
            <defs>
                <pattern id="patPedra" x="0" y="0" width="20" height="20" patternUnits="userSpaceOnUse">
                    <circle cx="10" cy="10" r="2" fill="#bdc3c7" opacity="0.5"/>
                </pattern>
            </defs>`;
    }
    // 3. √ÅGUA / RIO
    else if (tipoIcone === 'agua-rio' || tipoIcone === 'üåä') {
        isAgua = 'cheio';
        corEstrada = '#4cc9f0'; // Azul claro
        corBorda = '#1976d2';   // Azul escuro
        // Padr√£o de onda (reusar defini√ß√£o global para evitar duplicatas)
        defsPattern = aguaDefs;
    }
    else if (tipoIcone === 'agua-rio-margem') {
        isAgua = 'margem';
        corEstrada = '#4cc9f0'; // Azul claro
        corBorda = '#1976d2';   // Azul escuro
        // Reusar defini√ß√£o global
        defsPattern = aguaDefs;
    }
    // 3.5 LAGO (RIO BONITO)
    else if (tipoIcone === 'lago') {
        isAgua = 'lago';
        corEstrada = '#4FA3E0'; 
        corBorda = '#1A5691';
        defsPattern = `
            <defs>
                <linearGradient id="gLago" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" stop-color="#4FA3E0"/>
                    <stop offset="100%" stop-color="#1A5691"/>
                </linearGradient>
                <filter id="fLagoNoise"><feTurbulence type="fractalNoise" baseFrequency="0.5" numOctaves="2" result="noise"/><feColorMatrix in="noise" type="matrix" values="0 0 0 0 0  0 0 0 0 0  0 0 0 0 0  0 0 0 0.15 0"/></filter>
                <radialGradient id="gLagoRef" cx="50%" cy="50%" r="50%">
                    <stop offset="0%" stop-color="white" stop-opacity="0.3"/>
                    <stop offset="100%" stop-color="white" stop-opacity="0"/>
                </radialGradient>
            </defs>`;
    }
    // 4. TERRA
    else { 
        corEstrada = '#dcc096'; // Marrom Claro
        corBorda = '#a1887f';   // Marrom Escuro
    }

    const largura = 40;
    const centro = 30;
    const meio = 50; // Centro exato da c√©lula (30 + 40/2)
    
    // In√≠cio do SVG
    let svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">`;
    
    // Adiciona a defini√ß√£o do pattern se houver
    if (isPedra || isAgua) svg += defsPattern;

    // Helper para desenhar a textura de pedra por cima do fundo
    const addTexture = (x, y, w, h) => {
        if (isPedra) {
            return `<rect x="${x}" y="${y}" width="${w}" height="${h}" fill="url(#patPedra)" />`;
        }
        if (isAgua) {
            if (isAgua === 'lago') {
                return `<rect x="${x}" y="${y}" width="${w}" height="${h}" fill="url(#gLago)" />` +
                       `<rect x="${x}" y="${y}" width="${w}" height="${h}" filter="url(#fLagoNoise)" />` +
                       `<rect x="${x}" y="${y}" width="${w}" height="${h}" fill="url(#gLagoRef)" opacity="0.4" />`;
            }
            return `<rect x="${x}" y="${y}" width="${w}" height="${h}" fill="url(#patAgua)" />`;
        }
        return "";
    };

    // Helper para desenhar linha amarela
    const addYellowLine = (x1, y1, x2, y2) => {
        if (isAsfalto) {
            return `<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" stroke="${corDetalhe}" stroke-width="2" stroke-dasharray="5,5" />`;
        }
        return "";
    };
    
    // 1. FUNDO DO CAMINHO (Centro)
    if (isAgua) {
        if (isAgua === 'margem') {
            const margem = 28; // margem maior para deixar o rio mais estreito
            svg += `<rect x="${margem}" y="${margem}" width="${100 - 2 * margem}" height="${100 - 2 * margem}" fill="${corEstrada}" />`;
            svg += addTexture(margem, margem, 100 - 2 * margem, 100 - 2 * margem);
            // Conex√µes visuais para margens
            if (conexoes.norte) {
                svg += `<rect x="${margem}" y="0" width="${100 - 2 * margem}" height="${margem}" fill="${corEstrada}" />`;
                svg += addTexture(margem, 0, 100 - 2 * margem, margem);
            }
            if (conexoes.sul) {
                svg += `<rect x="${margem}" y="${100 - margem}" width="${100 - 2 * margem}" height="${margem}" fill="${corEstrada}" />`;
                svg += addTexture(margem, 100 - margem, 100 - 2 * margem, margem);
            }
            if (conexoes.oeste) {
                svg += `<rect x="0" y="${margem}" width="${margem}" height="${100 - 2 * margem}" fill="${corEstrada}" />`;
                svg += addTexture(0, margem, margem, 100 - 2 * margem);
            }
            if (conexoes.leste) {
                svg += `<rect x="${100 - margem}" y="${margem}" width="${margem}" height="${100 - 2 * margem}" fill="${corEstrada}" />`;
                svg += addTexture(100 - margem, margem, margem, 100 - 2 * margem);
            }
        } else if (isAgua === 'cheio') {
            svg += `<rect x="0" y="0" width="100" height="100" fill="${corEstrada}" />`;
            svg += addTexture(0, 0, 100, 100);
        } else if (isAgua === 'lago') {
            // LAGO ORG√ÇNICO FOFO (ESTILO TWEMOJI)
            const clrAgua = '#4FA3E0';
            const clrAguaBrilho = '#BDE3FF';

            // 1. FORMATO ORG√ÇNICO "CHUBBY" (Irregular e fofo, nada redondo perfeito)
            const pathAgua = "M28,30 Q50,18 72,32 Q85,55 70,75 Q45,88 22,70 Q12,45 28,30 Z";
            svg += `<path d="${pathAgua}" fill="${clrAgua}" />`;
            
            // Reflexo fofo (uma mancha de cor mais clara acompanhando a borda)
            svg += `<path d="M35,35 Q50,28 65,38" fill="none" stroke="${clrAguaBrilho}" stroke-width="4" stroke-linecap="round" opacity="0.4" />`;

            // 2. PEDRINHAS UNIDAS E MINIMALISTAS
            const clusterPedras = [
                {d: "M42,22 Q48,16 54,20 Q52,26 44,24 Z", c: "#99AAB5"},
                {d: "M58,18 Q66,14 72,21 Q68,28 61,25 Z", c: "#66757F"},
                {d: "M78,48 Q86,45 90,56 Q84,65 77,59 Z", c: "#99AAB5"},
                {d: "M75,72 Q82,76 77,84 Q70,86 67,77 Z", c: "#5D7275"},
                {d: "M45,84 Q52,91 62,86 Q63,80 55,78 Z", c: "#99AAB5"},
                {d: "M28,80 Q34,87 22,90 Q15,85 20,78 Z", c: "#66757F"},
                {d: "M10,48 Q6,56 13,62 Q21,59 16,51 Z", c: "#5D7275"},
                {d: "M14,35 Q20,31 27,39 Q23,46 15,42 Z", c: "#99AAB5"}
            ];

            clusterPedras.forEach(p => {
                svg += `<path d="${p.d}" fill="${p.c}" />`;
            });

            // 3. DETALHES DE BRILHO (Pontos brancos fofos)
            svg += `<circle cx="35" cy="50" r="2" fill="white" opacity="0.3" />`;
            svg += `<circle cx="65" cy="45" r="1.5" fill="white" opacity="0.2" />`;
            
            // Vit√≥ria-r√©gia estilo Twemoji (Fofinha e s√≥lida)
            svg += `<g transform="translate(42,48) scale(0.6)">
                <circle cx="0" cy="0" r="12" fill="#77B255" />
                <path d="M0,0 L12,0 A12,12 0 0 0 0,-12 Z" fill="${clrAgua}" /> 
                <circle cx="0" cy="0" r="3" fill="#FFCC4D" />
            </g>`;
        }
    } else {
        svg += `<rect x="${centro}" y="${centro}" width="${largura}" height="${largura}" fill="${corEstrada}" />`;
        svg += addTexture(centro, centro, largura, largura);
    }

    // 2. DESENHAR CONEX√ïES
    if (!isAgua) {
        // NORTE
        if (conexoes.norte) {
            svg += `<rect x="${centro}" y="0" width="${largura}" height="${centro + 5}" fill="${corEstrada}" />`;
            svg += addTexture(centro, 0, largura, centro + 5);
            svg += `<line x1="${centro}" y1="0" x2="${centro}" y2="${centro}" stroke="${corBorda}" stroke-width="4" />`;
            svg += `<line x1="${centro+largura}" y1="0" x2="${centro+largura}" y2="${centro}" stroke="${corBorda}" stroke-width="4" />`;
            svg += addYellowLine(meio, 0, meio, centro);
        } else {
            svg += `<line x1="${centro}" y1="${centro}" x2="${centro+largura}" y2="${centro}" stroke="${corBorda}" stroke-width="4" />`;
        }
        // SUL
        if (conexoes.sul) {
            svg += `<rect x="${centro}" y="${centro + largura - 5}" width="${largura}" height="${centro + 5}" fill="${corEstrada}" />`;
            svg += addTexture(centro, centro + largura - 5, largura, centro + 5);
            svg += `<line x1="${centro}" y1="${centro+largura}" x2="${centro}" y2="100" stroke="${corBorda}" stroke-width="4" />`;
            svg += `<line x1="${centro+largura}" y1="${centro+largura}" x2="${centro+largura}" y2="100" stroke="${corBorda}" stroke-width="4" />`;
            svg += addYellowLine(meio, centro + largura, meio, 100);
        } else {
            svg += `<line x1="${centro}" y1="${centro+largura}" x2="${centro+largura}" y2="${centro+largura}" stroke="${corBorda}" stroke-width="4" />`;
        }
        // OESTE
        if (conexoes.oeste) {
            svg += `<rect x="0" y="${centro}" width="${centro + 5}" height="${largura}" fill="${corEstrada}" />`;
            svg += addTexture(0, centro, centro + 5, largura);
            svg += `<line x1="0" y1="${centro}" x2="${centro}" y2="${centro}" stroke="${corBorda}" stroke-width="4" />`;
            svg += `<line x1="0" y1="${centro+largura}" x2="${centro}" y2="${centro+largura}" stroke="${corBorda}" stroke-width="4" />`;
            svg += addYellowLine(0, meio, centro, meio);
        } else {
            svg += `<line x1="${centro}" y1="${centro}" x2="${centro}" y2="${centro+largura}" stroke="${corBorda}" stroke-width="4" />`;
        }
        // LESTE
        if (conexoes.leste) {
            svg += `<rect x="${centro + largura - 5}" y="${centro}" width="${centro + 5}" height="${largura}" fill="${corEstrada}" />`;
            svg += addTexture(centro + largura - 5, centro, centro + 5, largura);
            svg += `<line x1="${centro+largura}" y1="${centro}" x2="100" y2="${centro}" stroke="${corBorda}" stroke-width="4" />`;
            svg += `<line x1="${centro+largura}" y1="${centro+largura}" x2="100" y2="${centro+largura}" stroke="${corBorda}" stroke-width="4" />`;
            svg += addYellowLine(centro + largura, meio, 100, meio);
        } else {
            svg += `<line x1="${centro+largura}" y1="${centro}" x2="${centro+largura}" y2="${centro+largura}" stroke="${corBorda}" stroke-width="4" />`;
        }
    }

    // Cruzamento central amarelo (opcional, para conectar as linhas)
    if (isAsfalto) {
        if (conexoes.norte) svg += addYellowLine(meio, centro, meio, meio);
        if (conexoes.sul) svg += addYellowLine(meio, meio, meio, centro + largura);
        if (conexoes.oeste) svg += addYellowLine(centro, meio, meio, meio);
        if (conexoes.leste) svg += addYellowLine(meio, meio, centro + largura, meio);
    }

    // N√£o desenhar onda central para √°gua, apenas padr√£o de fundo
    svg += `</svg>`;
    
    return "data:image/svg+xml;base64," + btoa(unescape(encodeURIComponent(svg)));
}


/**
 * Verifica vizinhos para conectar o caminho
 */
function obterConexoesCaminho(index) {
    const gridSize = getGridSize();
    const total = getTotalCells();
    
    // Coordenadas X, Y
    const x = index % gridSize;
    const y = Math.floor(index / gridSize);

    // Tipos que contam como caminho (usamos TIPOS_CAMINHO global)
    const CONSTRUCOES = ['üè†','üèØ','üè∞','‚õ©Ô∏è','üõñ','üïå','üõï'];
    // Detecta tipo do centro
    const itemCentral = jardimData[index];
    // Helpers para verificar vizinho
    const isPath = (i) => {
        if (i < 0 || i >= total) return false;
        const item = jardimData[i];
        if (!item) return false;

        // O lago √© isolado e n√£o se junta a nenhum outro caminho ou rio
        if (itemCentral && itemCentral.icone === 'lago') return false;
        if (item && item.icone === 'lago') return false;

        // Se o centro √© √°gua (rio, margem ou normal), conecta com qualquer tipo de √°gua
        if (itemCentral && (itemCentral.icone === 'agua-rio' || itemCentral.icone === 'agua-rio-margem' || itemCentral.icone === 'üåä')) {
            return item.icone === 'agua-rio' || item.icone === 'agua-rio-margem' || item.icone === 'üåä';
        }
        // Se o centro √© caminho (mas n√£o √°gua), s√≥ conecta com outros caminhos (exceto √°gua)
        if (itemCentral && TIPOS_CAMINHO.includes(itemCentral.icone) && itemCentral.icone !== 'agua-rio' && itemCentral.icone !== 'üåä') {
            return TIPOS_CAMINHO.includes(item.icone) && item.icone !== 'agua-rio' && item.icone !== 'üåä';
        }
        // Construcao
        return CONSTRUCOES.includes(item.icone);
    };
    return {
        norte: (y > 0) && isPath(index - gridSize),
        sul:   (y < gridSize - 1) && isPath(index + gridSize),
        oeste: (x > 0) && isPath(index - 1),
        leste: (x < gridSize - 1) && isPath(index + 1)
    };
}
function gerarSpriteFlor(icone) {
    let svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">`;

    // --- HELPER DE DESENHO DETALHADO ---
    const drawCozyFlower = (x, y, h, s, r, tipo) => {
        let el = `<g transform="translate(${x}, ${y}) scale(${s}) rotate(${r})">`;
        
        // Sombra suave
        el += `<ellipse cx="0" cy="0" rx="7" ry="3" fill="#000" opacity="0.2" />`;

        if (tipo === 'üåª') { 
            // GIRASSOL
            el += `<path d="M0,0 Q-5,${-h/2} 0,${-h}" stroke="#558b2f" stroke-width="4" stroke-linecap="round" />`;
            el += `<path d="M0,-5 Q-12,-8 -10,-15 Q-5,-18 0,-10" fill="#689f38" />`;
            el += `<path d="M0,-5 Q12,-8 10,-15 Q5,-18 0,-10" fill="#689f38" />`;
            el += `<g transform="translate(0, ${-h})">`;
                for(let i=0; i<10; i++) 
                    el += `<ellipse cx="0" cy="0" rx="3.5" ry="12" fill="#fbc02d" transform="rotate(${18 + i*36})"/>`;
                for(let i=0; i<10; i++) 
                    el += `<ellipse cx="0" cy="0" rx="3.5" ry="11" fill="#fdd835" transform="rotate(${i*36})"/>`;
                el += `<circle cx="0" cy="0" r="9" fill="#4e342e" />`;
                el += `<circle cx="0" cy="0" r="7" fill="none" stroke="#5d4037" stroke-width="1" stroke-dasharray="2,2"/>`;
            el += `</g>`;
        }
        else if (tipo === 'üåπ') { 
            // ROSA
            el += `<path d="M0,0 Q3,${-h/2} 0,${-h}" stroke="#2e7d32" stroke-width="3" fill="none" />`;
            el += `<path d="M0,-10 L-7,-12 L-4,-16 Z" fill="#388e3c" />`;
            el += `<path d="M0,-8 L7,-10 L4,-14 Z" fill="#388e3c" />`;
            el += `<g transform="translate(0, ${-h})">`;
                el += `<circle cx="0" cy="2" r="9" fill="#c62828" />`;
                el += `<ellipse cx="-2" cy="-1" rx="7" ry="5" fill="#d32f2f" transform="rotate(-10)" />`;
                el += `<ellipse cx="2" cy="-3" rx="6" ry="4" fill="#e53935" transform="rotate(10)" />`;
                el += `<ellipse cx="0" cy="-4" rx="4" ry="2.5" fill="#ffcdd2" opacity="0.4" />`;
            el += `</g>`;
        }
        else if (tipo === 'üå∑') { 
            // TULIPA
            el += `<path d="M0,0 Q-10,${-h/2} -6,${-h+5}" stroke="#4caf50" stroke-width="4" fill="none" />`;
            el += `<path d="M0,0 Q10,${-h/2} 6,${-h+5}" stroke="#4caf50" stroke-width="4" fill="none" />`;
            el += `<line x1="0" y1="0" x2="0" y2="${-h}" stroke="#66bb6a" stroke-width="3" />`;
            el += `<g transform="translate(0, ${-h})">`;
                el += `<path d="M-6,2 Q-8,12 0,14 Q8,12 6,2 L6,-5 Q0,0 -6,-5 Z" fill="#ef6c00" />`;
                el += `<path d="M-4,3 Q-5,10 0,12 Q5,10 4,3 L0,-6 Z" fill="#ff9800" />`;
                el += `<path d="M0,-6 L0,5" stroke="#ffe0b2" stroke-width="1" opacity="0.5"/>`;
            el += `</g>`;
        }
        else if (tipo === 'arvore-rosa') { // √Årvore rosa (vers√£o comum) - forma mais natural
            // Tronco principal (mais fino e mais alto)
            el += `<g transform="translate(0,0)">`;
                el += `<rect x="-4" y="0" width="8" height="${-h+40}" fill="#6f3b22" rx="3"/>`;
                el += `<path d="M-3,${-h+12} C -1,${-h+18} 1,${-h+20} 3,${-h+24}" stroke="#5a2e1a" stroke-width="0.8" fill="none" opacity="0.7" stroke-linecap="round"/>`;
                el += `<path d="M2,${-h+8} C 8,${-h+2} 14,${-h+0} 22,${-h-2}" stroke="#57301c" stroke-width="0.9" fill="none" opacity="0.6" stroke-linecap="round"/>`;
            el += `</g>`;

            // Pequenos galhos (simples arcos) saindo do tronco
            el += `<g stroke="#5a2e1a" stroke-width="0.9" stroke-linecap="round" fill="none">`;
                el += `<path d="M0,${-h+22} C -8,${-h+12} -18,${-h+8} -26,${-h+6}" opacity="0.9"/>`;
                el += `<path d="M0,${-h+18} C 8,${-h+10} 18,${-h+6} 26,${-h+4}" opacity="0.9"/>`;
            el += `</g>`;

            // Sombra de solo sob a copa
            el += `<ellipse cx="0" cy="${-h+48}" rx="28" ry="8" fill="#000" opacity="0.10"/>`;

            // Copa arredondada em camadas (tons de rosa)
            el += `<g transform="translate(0,${-h+18})">`;
                el += `<ellipse cx="0" cy="-6" rx="34" ry="22" fill="#f48fb1"/>`;
                el += `<ellipse cx="-12" cy="-12" rx="20" ry="16" fill="#f06292" opacity="0.95"/>`;
                el += `<ellipse cx="14" cy="-14" rx="18" ry="14" fill="#f06292" opacity="0.9"/>`;

                // Folhas verdes sutis por baixo para dar volume
                el += `<g fill="#66bb6a" opacity="0.9">`;
                    el += `<ellipse cx="-10" cy="0" rx="9" ry="6" />`;
                    el += `<ellipse cx="10" cy="-2" rx="7" ry="5" />`;
                el += `</g>`;

                // Cachos de flores (pequenas bolinhas agrupadas)
                const pts = [-6,-6, 4,-4, 12,-8, -14,-10, -2,-12, 8,-14, 16,-6];
                for (let p = 0; p < pts.length; p += 2) {
                    const px = pts[p];
                    const py = pts[p+1];
                    el += `<g transform="translate(${px},${py})">`;
                        el += `<circle cx="0" cy="0" r="3.2" fill="#fff7fb" opacity="0.95"/>`;
                        el += `<circle cx="0" cy="0.6" r="1.9" fill="#f06292"/>`;
                    el += `</g>`;
                }

                // Centro denso
                el += `<ellipse cx="0" cy="-4" rx="8" ry="6" fill="#c2185b" opacity="0.85"/>`;
            el += `</g>`;
        }

        el += `</g>`;
        return el;
    };

    // --- DISTRIBUI√á√ÉO "W" DISTORCIDO ---
    // (x, y, altura, escala, rota√ß√£o)

    // 1. Fundo Esquerda (Bem recuada)
    svg += drawCozyFlower(20, 55, 20, 0.8, -15, icone); 

    // 2. Fundo Direita (Mas mais perto que a esquerda)
    svg += drawCozyFlower(85, 65, 23, 0.85, 10, icone); 

    // 3. Meio (Deslocado do centro)
    svg += drawCozyFlower(45, 75, 25, 0.9, -5, icone); 

    // 4. Frente Esquerda (Bem na ponta)
    svg += drawCozyFlower(25, 95, 28, 1.0, -20, icone); 

    // 5. Frente Direita (Recuada em rela√ß√£o √† 4)
    svg += drawCozyFlower(70, 88, 26, 0.95, 15, icone); 

    svg += `</svg>`;
    return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
}

// √ÅRVORE COM COLM√âIA
function gerarSpriteArvoreColmeia(tipo) {
    let svg = `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">`;
    svg += `<defs>`;
    svg += `<radialGradient id="gCanopyColmeia" cx="50%" cy="35%" r="60%">`;
    svg += `<stop offset="0%" stop-color="#ffcce5" opacity="1"/>`;
    svg += `<stop offset="70%" stop-color="#ffb3d9" opacity="0.95"/>`;
    svg += `<stop offset="100%" stop-color="#ff99cc" opacity="0.7"/>`;
    svg += `</radialGradient>`;
    svg += `</defs>`;

    svg += `<rect width="100" height="100" fill="none"/>`;

    // Sombra suave
    svg += `<ellipse cx="50" cy="90" rx="22" ry="4" fill="rgba(0,0,0,0.1)"/>`;

    // Copa em camadas: fundo (atr√°s do tronco)
    svg += `<ellipse cx="50" cy="35" rx="35" ry="24" fill="#ffb3d9" opacity="0.75"/>`;

    // COLM√âIA - pequena, marrom, do lado oposto do galho (esquerda), embaixo da copa
    const colmeiaX = 35;
    const colmeiaY = 60;
    
    // Fundo da colm√©ia (forma c√¥nica/redonda pequena) - MARROM
    svg += `<ellipse cx="${colmeiaX}" cy="${colmeiaY}" rx="7" ry="8" fill="#8b6f47" opacity="0.9"/>`;
    
    // Listras horizontais (branco e marrom escuro)
    const stripeHeight = 1.2;
    for (let i = 0; i < 6; i++) {
        const yPos = colmeiaY - 3.5 + (i * stripeHeight);
        const color = i % 2 === 0 ? '#f5e6d3' : '#5c4a2f';
        svg += `<rect x="${colmeiaX - 6}" y="${yPos}" width="12" height="${stripeHeight * 0.9}" fill="${color}" opacity="0.9" rx="0.5"/>`;
    }
    
    // Pequenas listras verticais para textura
    for (let i = 0; i < 4; i++) {
        const xPos = colmeiaX - 5 + (i * 3);
        svg += `<line x1="${xPos}" y1="${colmeiaY - 3.5}" x2="${xPos}" y2="${colmeiaY + 3.5}" stroke="#3d2f1f" stroke-width="0.4" opacity="0.5"/>`;
    }
    
    // Entrada da colm√©ia (pequeno c√≠rculo)
    svg += `<circle cx="${colmeiaX}" cy="${colmeiaY + 4}" r="1.2" fill="#3d2f1f" opacity="0.9"/>`;

    // Tronco c√¥nico (fino em cima, grosso embaixo)
    svg += `<path d="M 46 56 L 44 88 Q 44 90 46 90 L 54 90 Q 56 90 56 88 L 54 56 Z" fill="#8b5a3c" opacity="0.9"/>`;

    // Galho diagonal √∫nico saindo do tronco at√© a copa
    svg += `<path d="M 54 62 Q 75 45 75 25" stroke="#8b5a3c" stroke-width="4" fill="none" stroke-linecap="round" opacity="0.85"/>`;

    // Copa aumentada: forma org√¢nica maior (frente)
    svg += `<ellipse cx="50" cy="30" rx="36" ry="25" fill="url(#gCanopyColmeia)" />`;
    svg += `<ellipse cx="33" cy="27" rx="20" ry="17" fill="#ffb3d9" opacity="0.7"/>`;
    svg += `<ellipse cx="67" cy="27" rx="20" ry="17" fill="#ffb3d9" opacity="0.7"/>`;

    // Flores distribu√≠das elegantemente
    const flowers = [
        {x: 32, y: 18, s: 1.1},  {x: 50, y: 12, s: 1.0},  {x: 68, y: 16, s: 1.05},
        {x: 28, y: 32, s: 0.95}, {x: 50, y: 26, s: 1.2},  {x: 72, y: 30, s: 0.9},
        {x: 38, y: 40, s: 1.0},  {x: 62, y: 38, s: 0.95},
        {x: 44, y: 45, s: 0.85}, {x: 56, y: 44, s: 0.9}
    ];

    for (let fl of flowers) {
        const colors = ['#fff8fd', '#ffe5f0', '#ffccdb'];
        const color = colors[Math.floor(Math.random() * colors.length)];
        
        svg += `<g transform="translate(${fl.x}, ${fl.y}) scale(${fl.s})">`;
        for (let p = 0; p < 5; p++) {
            svg += `<ellipse cx="0" cy="-2.2" rx="1.6" ry="3.0" fill="${color}" transform="rotate(${p * 72})" />`;
        }
        svg += `<circle cx="0" cy="0" r="0.8" fill="#ffb3d9"/>`;
        svg += `</g>`;
    }

    svg += `</svg>`;
    return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
}

// --- Gerador separado de sprites de √°rvore (sakura elegante) ---
function gerarSpriteArvore(tipo) {
    // Detecta qual tipo de √°rvore renderizar
    const tipoNorm = (typeof iconKey === 'function') ? iconKey(tipo) : (''+tipo).toLowerCase().replace(/\s+/g,'-');
    
    if (tipoNorm === 'arvore-roxa') {
        return gerarSpriteArvoreRoxa(tipo);
    } else if (tipoNorm === 'arvore-amarela') {
        return gerarSpriteArvoreAmarela(tipo);
    } else if (tipoNorm === 'arvore-branca') {
        return gerarSpriteArvorebranca(tipo);
    } else if (tipoNorm === 'arvore-colmeia') {
        return gerarSpriteArvoreColmeia(tipo);
    } else if (tipoNorm === 'arvore-frutifera') {
        return gerarSpriteArvoreFrut√≠fera(tipo);
    }
    
    // Padr√£o: arvore-rosa
    // Sakura elegante e minimalista
    let svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">`;
    svg += `<defs>`;
        // Gradiente suave para copa
        svg += `<radialGradient id="gCanopy" cx="50%" cy="35%" r="60%">`;
            svg += `<stop offset="0%" stop-color="#ffcce5" opacity="1"/>`;
            svg += `<stop offset="70%" stop-color="#ffb3d9" opacity="0.95"/>`;
            svg += `<stop offset="100%" stop-color="#ff99cc" opacity="0.7"/>`;
        svg += `</radialGradient>`;
    svg += `</defs>`;

    svg += `<rect width="100" height="100" fill="none"/>`;

    // Sombra suave
    svg += `<ellipse cx="50" cy="90" rx="22" ry="4" fill="rgba(0,0,0,0.1)"/>`;

    // Copa em camadas: fundo (atr√°s do tronco)
    svg += `<ellipse cx="50" cy="35" rx="35" ry="24" fill="#ffb3d9" opacity="0.75"/>`;

    // Tronco c√¥nico (fino em cima, grosso embaixo) - descido um pouco
    svg += `<path d="M 46 56 L 44 88 Q 44 90 46 90 L 54 90 Q 56 90 56 88 L 54 56 Z" fill="#8b5a3c" opacity="0.9"/>`;

    // Galho diagonal √∫nico saindo do tronco at√© a copa
    svg += `<path d="M 54 62 Q 75 45 75 25" stroke="#8b5a3c" stroke-width="4" fill="none" stroke-linecap="round" opacity="0.85"/>`;

    // Copa aumentada: forma org√¢nica maior (frente)
    svg += `<ellipse cx="50" cy="30" rx="36" ry="25" fill="url(#gCanopy)" />`;
    svg += `<ellipse cx="33" cy="27" rx="20" ry="17" fill="#ffb3d9" opacity="0.7"/>`;
    svg += `<ellipse cx="67" cy="27" rx="20" ry="17" fill="#ffb3d9" opacity="0.7"/>`;

    // Flores distribu√≠das elegantemente (mantidas)
    const flowers = [
        {x: 32, y: 18, s: 1.1},  {x: 50, y: 12, s: 1.0},  {x: 68, y: 16, s: 1.05},
        {x: 28, y: 32, s: 0.95}, {x: 50, y: 26, s: 1.2},  {x: 72, y: 30, s: 0.9},
        {x: 38, y: 40, s: 1.0},  {x: 62, y: 38, s: 0.95},
        {x: 44, y: 45, s: 0.85}, {x: 56, y: 44, s: 0.9}
    ];

    for (let fl of flowers) {
        const colors = ['#fff8fd', '#ffe5f0', '#ffccdb'];
        const color = colors[Math.floor(Math.random() * colors.length)];
        
        svg += `<g transform="translate(${fl.x}, ${fl.y}) scale(${fl.s})">`;
            // 5 p√©talas simples
            for (let p = 0; p < 5; p++) {
                svg += `<ellipse cx="0" cy="-2.2" rx="1.6" ry="3.0" fill="${color}" transform="rotate(${p * 72})" />`;
            }
            // Miolo
            svg += `<circle cx="0" cy="0" r="0.8" fill="#ffb3d9"/>`;
        svg += `</g>`;
    }

    svg += `</svg>`;
    return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
}

// √ÅRVORE ROXA
function gerarSpriteArvoreRoxa(tipo) {
    let svg = `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">`;
    svg += `<defs>`;
    svg += `<radialGradient id="gCanopyRoxa" cx="45%" cy="30%" r="70%">`;
    svg += `<stop offset="0%" style="stop-color:#e6ccf0;stop-opacity:1"/>`;
    svg += `<stop offset="70%" style="stop-color:#d9b3e5;stop-opacity:1"/>`;
    svg += `<stop offset="100%" style="stop-color:#cc99dd;stop-opacity:1"/>`;
    svg += `</radialGradient>`;
    svg += `</defs>`;

    svg += `<rect width="100" height="100" fill="none"/>`;
    svg += `<ellipse cx="50" cy="90" rx="22" ry="4" fill="rgba(0,0,0,0.1)"/>`;
    svg += `<ellipse cx="50" cy="35" rx="35" ry="24" fill="#d9b3e5" opacity="0.75"/>`;
    svg += `<path d="M 46 56 L 44 88 Q 44 90 46 90 L 54 90 Q 56 90 56 88 L 54 56 Z" fill="#8b5a3c" opacity="0.9"/>`;

    // Galho diagonal √∫nico saindo do tronco at√© a copa
    svg += `<path d="M 54 62 Q 75 45 75 25" stroke="#8b5a3c" stroke-width="4" fill="none" stroke-linecap="round" opacity="0.85"/>`;

    svg += `<ellipse cx="50" cy="30" rx="36" ry="25" fill="url(#gCanopyRoxa)" />`;
    svg += `<ellipse cx="33" cy="27" rx="20" ry="17" fill="#d9b3e5" opacity="0.7"/>`;
    svg += `<ellipse cx="67" cy="27" rx="20" ry="17" fill="#d9b3e5" opacity="0.7"/>`;

    const flowerRoxa = [
        {x: 32, y: 18, s: 1.1},  {x: 50, y: 12, s: 1.0},  {x: 68, y: 16, s: 1.05},
        {x: 28, y: 32, s: 0.95}, {x: 50, y: 26, s: 1.2},  {x: 72, y: 30, s: 0.9},
        {x: 38, y: 40, s: 1.0},  {x: 62, y: 38, s: 0.95},
        {x: 44, y: 45, s: 0.85}, {x: 56, y: 44, s: 0.9}
    ];

    for (let fl of flowerRoxa) {
        const colors = ['#d9b3e5', '#cc99dd', '#bb88cc'];
        const color = colors[Math.floor(Math.random() * colors.length)];
        svg += `<g transform="translate(${fl.x}, ${fl.y}) scale(${fl.s})">`;
        for (let p = 0; p < 5; p++) {
            svg += `<ellipse cx="0" cy="-2.2" rx="1.6" ry="3.0" fill="${color}" transform="rotate(${p * 72})" />`;
        }
        svg += `<circle cx="0" cy="0" r="0.8" fill="#d9b3e5"/>`;
        svg += `</g>`;
    }

    svg += `</svg>`;
    return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
}

// √ÅRVORE AMARELA
function gerarSpriteArvoreAmarela(tipo) {
    let svg = `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">`;
    svg += `<defs>`;
    svg += `<radialGradient id="gCanopyAmarela" cx="45%" cy="30%" r="70%">`;
    svg += `<stop offset="0%" style="stop-color:#ffffcc;stop-opacity:1"/>`;
    svg += `<stop offset="70%" style="stop-color:#ffff99;stop-opacity:1"/>`;
    svg += `<stop offset="100%" style="stop-color:#ffff66;stop-opacity:1"/>`;
    svg += `</radialGradient>`;
    svg += `</defs>`;

    svg += `<rect width="100" height="100" fill="none"/>`;
    svg += `<ellipse cx="50" cy="90" rx="22" ry="4" fill="rgba(0,0,0,0.1)"/>`;
    svg += `<ellipse cx="50" cy="35" rx="35" ry="24" fill="#ffff99" opacity="0.75"/>`;
    svg += `<path d="M 46 56 L 44 88 Q 44 90 46 90 L 54 90 Q 56 90 56 88 L 54 56 Z" fill="#8b5a3c" opacity="0.9"/>`;

    // Galho diagonal √∫nico saindo do tronco at√© a copa
    svg += `<path d="M 54 62 Q 75 45 75 25" stroke="#8b5a3c" stroke-width="4" fill="none" stroke-linecap="round" opacity="0.85"/>`;

    svg += `<ellipse cx="50" cy="30" rx="36" ry="25" fill="url(#gCanopyAmarela)" />`;
    svg += `<ellipse cx="33" cy="27" rx="20" ry="17" fill="#ffff99" opacity="0.7"/>`;
    svg += `<ellipse cx="67" cy="27" rx="20" ry="17" fill="#ffff99" opacity="0.7"/>`;

    const flowerAmarela = [
        {x: 32, y: 18, s: 1.1},  {x: 50, y: 12, s: 1.0},  {x: 68, y: 16, s: 1.05},
        {x: 28, y: 32, s: 0.95}, {x: 50, y: 26, s: 1.2},  {x: 72, y: 30, s: 0.9},
        {x: 38, y: 40, s: 1.0},  {x: 62, y: 38, s: 0.95},
        {x: 44, y: 45, s: 0.85}, {x: 56, y: 44, s: 0.9}
    ];

    for (let fl of flowerAmarela) {
        const colors = ['#ffdd33', '#ffee55', '#ffdd00'];
        const color = colors[Math.floor(Math.random() * colors.length)];
        svg += `<g transform="translate(${fl.x}, ${fl.y}) scale(${fl.s})">`;
        for (let p = 0; p < 5; p++) {
            svg += `<ellipse cx="0" cy="-2.2" rx="1.6" ry="3.0" fill="${color}" transform="rotate(${p * 72})" />`;
        }
        svg += `<circle cx="0" cy="0" r="0.8" fill="#ffff99"/>`;
        svg += `</g>`;
    }

    svg += `</svg>`;
    return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
}

// √ÅRVORE BRANCA
function gerarSpriteArvorebranca(tipo) {
    let svg = `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">`;
    svg += `<defs>`;
    svg += `<radialGradient id="gCanopyBranca" cx="45%" cy="30%" r="70%">`;
    svg += `<stop offset="0%" style="stop-color:#ffffff;stop-opacity:1"/>`;
    svg += `<stop offset="70%" style="stop-color:#f0f0f0;stop-opacity:1"/>`;
    svg += `<stop offset="100%" style="stop-color:#e0e0e0;stop-opacity:1"/>`;
    svg += `</radialGradient>`;
    svg += `</defs>`;

    svg += `<rect width="100" height="100" fill="none"/>`;
    svg += `<ellipse cx="50" cy="90" rx="22" ry="4" fill="rgba(0,0,0,0.1)"/>`;
    svg += `<ellipse cx="50" cy="35" rx="35" ry="24" fill="#f0f0f0" opacity="0.75"/>`;
    svg += `<path d="M 46 56 L 44 88 Q 44 90 46 90 L 54 90 Q 56 90 56 88 L 54 56 Z" fill="#8b5a3c" opacity="0.9"/>`;

    // Galho diagonal √∫nico saindo do tronco at√© a copa
    svg += `<path d="M 54 62 Q 75 45 75 25" stroke="#8b5a3c" stroke-width="4" fill="none" stroke-linecap="round" opacity="0.85"/>`;

    svg += `<ellipse cx="50" cy="30" rx="36" ry="25" fill="url(#gCanopyBranca)" />`;
    svg += `<ellipse cx="33" cy="27" rx="20" ry="17" fill="#f0f0f0" opacity="0.7"/>`;
    svg += `<ellipse cx="67" cy="27" rx="20" ry="17" fill="#f0f0f0" opacity="0.7"/>`;

    const flowerBranca = [
        {x: 32, y: 18, s: 1.1},  {x: 50, y: 12, s: 1.0},  {x: 68, y: 16, s: 1.05},
        {x: 28, y: 32, s: 0.95}, {x: 50, y: 26, s: 1.2},  {x: 72, y: 30, s: 0.9},
        {x: 38, y: 40, s: 1.0},  {x: 62, y: 38, s: 0.95},
        {x: 44, y: 45, s: 0.85}, {x: 56, y: 44, s: 0.9}
    ];

    for (let fl of flowerBranca) {
        const colors = ['#e8e8e8', '#d0d0d0', '#c0c0c0'];
        const color = colors[Math.floor(Math.random() * colors.length)];
        svg += `<g transform="translate(${fl.x}, ${fl.y}) scale(${fl.s})">`;
        for (let p = 0; p < 5; p++) {
            svg += `<ellipse cx="0" cy="-2.2" rx="1.6" ry="3.0" fill="${color}" transform="rotate(${p * 72})" />`;
        }
        svg += `<circle cx="0" cy="0" r="0.8" fill="#e8e8e8"/>`;
        svg += `</g>`;
    }

    svg += `</svg>`;
    return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
}

// --- √Årvore Frut√≠fera (ma√ß√£s vermelhas) ---
function gerarSpriteArvoreFrut√≠fera(tipo) {
    let svg = `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">`;
    svg += `<defs>`;
    svg += `</defs>`;

    svg += `<rect width="100" height="100" fill="none"/>`;

    // Sombra suave
    svg += `<ellipse cx="50" cy="90" rx="22" ry="4" fill="rgba(0,0,0,0.15)"/>`;

    // CAMADA DE COPA ATR√ÅS (atr√°s do tronco, mais acima)
    svg += `<ellipse cx="50" cy="38" rx="42" ry="28" fill="#4fa436" opacity="0.85"/>`;
    svg += `<ellipse cx="32" cy="32" rx="20" ry="18" fill="#4fa436" opacity="0.78"/>`;
    svg += `<ellipse cx="68" cy="34" rx="22" ry="19" fill="#4fa436" opacity="0.80"/>`;
    svg += `<ellipse cx="18" cy="38" rx="14" ry="16" fill="#4fa436" opacity="0.75"/>`;
    svg += `<ellipse cx="82" cy="40" rx="15" ry="17" fill="#4fa436" opacity="0.75"/>`;

    // Tronco c√¥nico mais escuro
    svg += `<path d="M 46 56 L 44 88 Q 44 90 46 90 L 54 90 Q 56 90 56 88 L 54 56 Z" fill="#5c3d2a" opacity="0.95"/>`;

    // Galho diagonal √∫nico saindo do tronco at√© a copa
    svg += `<path d="M 54 62 Q 75 45 75 25" stroke="#5c3d2a" stroke-width="4" fill="none" stroke-linecap="round" opacity="0.9"/>`;

    // Copa em forma de arbusto/nuvem - FORMATO ORG√ÇNICO (totalmente s√≥lido, cor √∫nica)
    // Formato de nuvem org√¢nica com elipses irregulares
    // Formas principais assim√©tricas
    svg += `<ellipse cx="50" cy="32" rx="36" ry="30" fill="#5fb546" opacity="1"/>`;
    svg += `<ellipse cx="32" cy="26" rx="18" ry="22" fill="#5fb546" opacity="0.98"/>`;
    svg += `<ellipse cx="68" cy="24" rx="20" ry="24" fill="#5fb546" opacity="0.98"/>`;
    
    // Bumps org√¢nicos
    svg += `<ellipse cx="18" cy="32" rx="12" ry="18" fill="#5fb546" opacity="0.96"/>`;
    svg += `<ellipse cx="82" cy="34" rx="13" ry="19" fill="#5fb546" opacity="0.96"/>`;
    
    // Topos bem definidos
    svg += `<ellipse cx="45" cy="18" rx="14" ry="16" fill="#5fb546" opacity="0.97"/>`;
    svg += `<ellipse cx="55" cy="16" rx="15" ry="17" fill="#5fb546" opacity="0.98"/>`;
    svg += `<ellipse cx="35" cy="22" rx="10" ry="14" fill="#5fb546" opacity="0.96"/>`;
    svg += `<ellipse cx="65" cy="20" rx="11" ry="14" fill="#5fb546" opacity="0.97"/>`;
    
    // Base s√≥lida
    svg += `<ellipse cx="40" cy="48" rx="11" ry="14" fill="#5fb546" opacity="0.97"/>`;
    svg += `<ellipse cx="60" cy="49" rx="12" ry="15" fill="#5fb546" opacity="0.98"/>`;

    // Matinhos suaves e naturais na base do tronco
    svg += `<ellipse cx="32" cy="87" rx="8" ry="5" fill="#5fb546" opacity="0.8"/>`;
    svg += `<ellipse cx="50" cy="89" rx="9" ry="4.5" fill="#4fa436" opacity="0.82"/>`;
    svg += `<ellipse cx="68" cy="87" rx="8" ry="5" fill="#6fcc55" opacity="0.78"/>`;

    // Ma√ß√£s vermelhas grandes e s√≥lidas na copa (posi√ß√µes fixas)
    const laranjas = [
        {x: 30, y: 22, r: 4.8}, {x: 70, y: 28, r: 4.6}, {x: 50, y: 42, r: 4.7},
        {x: 22, y: 38, r: 4.5}, {x: 78, y: 35, r: 4.6}
    ];

    for (let maca of laranjas) {
        // Corpo da ma√ß√£ (c√≠rculo)
        svg += `<circle cx="${maca.x}" cy="${maca.y}" r="${maca.r}" fill="#ee2233" stroke="none"/>`;
        // Cabinho
        svg += `<line x1="${maca.x}" y1="${maca.y - maca.r}" x2="${maca.x}" y2="${maca.y - maca.r - 2.5}" stroke="#5c3d2a" stroke-width="0.8"/>`;
    }

    // Pequenas flores verdes/folhas na copa (detalhes com tons variados e posi√ß√µes aleat√≥rias)
    const folhas = [
        {x: 20, y: 20, cor: '#5fb546'}, {x: 55, y: 15, cor: '#6fcc55'}, {x: 78, y: 25, cor: '#4fa436'},
        {x: 12, y: 38, cor: '#7fdd66'}, {x: 45, y: 35, cor: '#3d8a2a'}, {x: 80, y: 48, cor: '#5fb546'},
        {x: 32, y: 50, cor: '#6fcc55'}, {x: 68, y: 22, cor: '#4fa436'}, {x: 25, y: 15, cor: '#7fdd66'},
        {x: 72, y: 38, cor: '#5fb546'}, {x: 38, y: 28, cor: '#6fcc55'}, {x: 58, y: 50, cor: '#3d8a2a'},
        {x: 15, y: 52, cor: '#4fa436'}, {x: 50, y: 52, cor: '#7fdd66'}, {x: 82, y: 35, cor: '#5fb546'}
    ];

    for (let folha of folhas) {
        svg += `<ellipse cx="${folha.x}" cy="${folha.y}" rx="2.2" ry="3.2" fill="${folha.cor}" opacity="0.72" transform="rotate(${Math.random() * 360} ${folha.x} ${folha.y})"/>`;
    }

    svg += `</svg>`;
    return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
}

// LAGO COM PEDRINHAS - Texturizado, mais largo (estilo rio/caminho) e com brilhos de √°gua
function gerarSpriteLago(tipo) {
    let svg = `<svg viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg">`;
    svg += `<defs>`;
    // Gradiente profundo para a √°gua
    svg += `<linearGradient id="gWaterOrganic" x1="0%" y1="0%" x2="100%" y2="100%">`;
    svg += `<stop offset="0%" stop-color="#4FA3E0"/>`;
    svg += `<stop offset="100%" stop-color="#1A5691"/>`;
    svg += `</linearGradient>`;
    // Brilho de superf√≠cie (reflexo)
    svg += `<radialGradient id="gSurfaceRef" cx="40%" cy="30%" r="60%">`;
    svg += `<stop offset="0%" stop-color="white" stop-opacity="0.4"/>`;
    svg += `<stop offset="100%" stop-color="white" stop-opacity="0"/>`;
    svg += `</radialGradient>`;
    // Filtro de textura leve para "ru√≠do" na √°gua
    svg += `<filter id="fWaterNoise"><feTurbulence type="fractalNoise" baseFrequency="0.6" numOctaves="2" result="noise"/><feColorMatrix in="noise" type="matrix" values="0 0 0 0 0  0 0 0 0 0  0 0 0 0 0  0 0 0 0.1 0"/></filter>`;
    svg += `</defs>`;

    // √ÅGUA: Formato mais preenchido nas laterais (para parecer um peda√ßo de rio se alinhado)
    svg += `<path d="M1,23 Q4,34 18,35 Q32,34 35,23 Q35,16 18,15 Q1,16 1,23 Z" fill="url(#gWaterOrganic)"/>`;
    
    // TEXTURA E BRILHOS (Espuma e Reflexos)
    svg += `<path d="M1,23 Q4,34 18,35 Q32,34 35,23" fill="none" stroke="white" stroke-width="0.3" opacity="0.2"/>`; // Borda de espuma
    svg += `<ellipse cx="18" cy="22" rx="15" ry="7" fill="url(#gSurfaceRef)"/>`; // Reflexo principal
    svg += `<rect x="0" y="15" width="36" height="21" filter="url(#fWaterNoise)" pointer-events="none"/>`; // Textura de ru√≠do
    
    // Pequenos "specular highlights" (pontos de luz)
    svg += `<circle cx="10" cy="19" r="0.6" fill="white" opacity="0.6"/>`;
    svg += `<circle cx="28" cy="25" r="0.4" fill="white" opacity="0.5"/>`;
    svg += `<circle cx="20" cy="30" r="0.3" fill="white" opacity="0.4"/>`;
    
    // Linhas de movimento da √°gua
    svg += `<path d="M6,22 Q18,20 30,23" stroke="white" stroke-width="0.5" stroke-linecap="round" opacity="0.3" fill="none"/>`;
    svg += `<path d="M10,28 Q18,27 26,29" stroke="white" stroke-width="0.4" stroke-linecap="round" opacity="0.2" fill="none"/>`;

    // PEDRAS UNIDAS (Visual molhado)
    // Pedra Musgo (Direita)
    svg += `<path d="M23,28 Q27,27 30,30 Q28,34 24,33 Z" fill="#5D7275"/>`;
    svg += `<circle cx="25.5" cy="29.5" r="0.4" fill="white" opacity="0.5"/>`; // Brilho
    svg += `<circle cx="27" cy="30" r="1.3" fill="#77B255" opacity="0.3"/>`; // Musgo
    
    // Pedra Cinza (Esquerda)
    svg += `<path d="M3,26 Q7,25 9,28 Q8,33 4,33 Q1,31 3,26 Z" fill="#99AAB5"/>`;
    svg += `<circle cx="5" cy="27.5" r="0.5" fill="white" opacity="0.4"/>`; 

    // Grupinho de seixos inferior
    svg += `<circle cx="15" cy="34" r="1.4" fill="#66757F"/>`;
    svg += `<circle cx="18" cy="33.5" r="1.1" fill="#99AAB5"/>`;
    svg += `<circle cx="21" cy="32.5" r="0.9" fill="#66757F"/>`;

    // VIT√ìRIA-R√âGIA (Centralizada e mais plana)
    svg += `<circle cx="18" cy="19" r="3.2" fill="#77B255"/>`;
    svg += `<path d="M18,19 L21.5,19 A3.2,3.2 0 0,0 18,15.8 Z" fill="#1A5691"/>`; 
    svg += `<circle cx="18" cy="19.5" r="1" fill="#FFCC4D" opacity="0.9"/>`;

    svg += `</svg>`;
    return "data:image/svg+xml;base64," + btoa(unescape(encodeURIComponent(svg)));
}

// POSTE DE LUZ BELLE √âPOQUE (Vertical reto e s√≥lido)
function gerarSpritePosteLuz(tipo) {
    let svg = `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">`;
    svg += `<defs>`;
    svg += `<radialGradient id="gLuzBrilho" cx="50%" cy="25%" r="85%">`;
    svg += `<stop offset="0%" stop-color="#fffacd" opacity="0.9"/>`;
    svg += `<stop offset="60%" stop-color="#ffff88" opacity="0.25"/>`;
    svg += `<stop offset="100%" stop-color="#ffff00" opacity="0"/>`;
    svg += `</radialGradient>`;
    svg += `</defs>`;

    svg += `<rect width="100" height="100" fill="none"/>`;

    // Sombra suave
    svg += `<ellipse cx="50" cy="91" rx="11" ry="1.8" fill="rgba(0,0,0,0.06)"/>`;

    // BASE SIMPLES E S√ìLIDA
    svg += `<rect x="44" y="86" width="12" height="2.5" fill="#a59d84" opacity="0.8"/>`;
    svg += `<ellipse cx="50" cy="86" rx="6.5" ry="1.8" fill="#8b8577" opacity="0.5"/>`;

    // POSTE PRINCIPAL (completamente reto e vertical)
    svg += `<rect x="48.5" y="35" width="3" height="51" fill="#8b8577" opacity="0.85"/>`;
    svg += `<rect x="49" y="35" width="2" height="51" fill="#6b6657" opacity="0.4"/>`;

    // DETALHES DE METAL no poste (an√©is delicados)
    svg += `<line x1="47.5" y1="48" x2="52.5" y2="48" stroke="#6b6657" stroke-width="0.5" opacity="0.6"/>`;
    svg += `<line x1="47.5" y1="62" x2="52.5" y2="62" stroke="#6b6657" stroke-width="0.5" opacity="0.6"/>`;

    // LANTERNA QUADRADA RETRO (mais geom√©trica e antiga)
    // Topo da lanterna
    svg += `<path d="M 46 33 L 54 33 L 53 30 L 47 30 Z" fill="#2a2620" opacity="0.8"/>`;
    
    // Corpo principal - QUADRADO (n√£o ovoide)
    svg += `<rect x="46" y="33" width="8" height="8" fill="#1a1410" opacity="0.8" stroke="#8b8577" stroke-width="0.6"/>`;

    // Pain√©is de vidro simples (4 lados)
    // Painel frontal
    svg += `<rect x="47" y="34" width="6" height="6" fill="none" stroke="#d4c4b0" stroke-width="0.4" opacity="0.7"/>`;
    svg += `<line x1="50" y1="34" x2="50" y2="40" stroke="#d4c4b0" stroke-width="0.3" opacity="0.5"/>`;
    svg += `<line x1="47" y1="37" x2="53" y2="37" stroke="#d4c4b0" stroke-width="0.3" opacity="0.5"/>`;

    // Moldura superior
    svg += `<line x1="46" y1="32.8" x2="54" y2="32.8" stroke="#6b6657" stroke-width="0.6" opacity="0.7"/>`;

    // Moldura inferior com pequeno ornato
    svg += `<line x1="46" y1="41" x2="54" y2="41" stroke="#6b6657" stroke-width="0.5" opacity="0.6"/>`;

    // HASTE GROSSA conectando lanterna ao poste
    svg += `<rect x="48" y="41" width="4" height="2.5" fill="#8b8577" opacity="0.7" stroke="#6b6657" stroke-width="0.5"/>`;
    svg += `<line x1="47.8" y1="42" x2="52.2" y2="42" stroke="#6b6657" stroke-width="0.3" opacity="0.5"/>`;

    // L√ÇMPADA (p√™ra cl√°ssica de g√°s)
    svg += `<path d="M 50 31.5 Q 48.5 32.5 48.5 34 Q 48.5 35.8 50 36.3 Q 51.5 35.8 51.5 34 Q 51.5 32.5 50 31.5" fill="#fffacd" opacity="0.85"/>`;
    svg += `<circle cx="50" cy="33" r="0.4" fill="#ffff99" opacity="0.95"/>`;

    // BRILHO RADIANTE (halo dourado)
    svg += `<circle cx="50" cy="33" r="10" fill="url(#gLuzBrilho)"/>`;

    svg += `</svg>`;
    return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
}

// BANCO DE PRA√áA (assento p√∫blico elegante - vista 3/4)
function gerarSpriteBancoPraca(tipo) {
    let svg = `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">`;
    svg += `<defs>`;
    svg += `<linearGradient id="gMadeiraAssento" x1="0%" y1="0%" x2="0%" y2="100%">`;
    svg += `<stop offset="0%" stop-color="#9b8b7e" opacity="0.9"/>`;
    svg += `<stop offset="100%" stop-color="#7a6a5f" opacity="0.95"/>`;
    svg += `</linearGradient>`;
    svg += `<linearGradient id="gMadeiraEncosto" x1="0%" y1="0%" x2="0%" y2="100%">`;
    svg += `<stop offset="0%" stop-color="#a59580" opacity="0.92"/>`;
    svg += `<stop offset="100%" stop-color="#8b7b70" opacity="0.95"/>`;
    svg += `</linearGradient>`;
    svg += `</defs>`;

    svg += `<rect width="100" height="100" fill="none"/>`;

    // Sombra elegante
    svg += `<ellipse cx="52" cy="88" rx="18" ry="2.5" fill="rgba(0,0,0,0.15)"/>`;

    // BANCO EM VISTA 3/4 (clara e realista)
    
    // PERNAS (4 pernas cil√≠ndricas simples)
    // Perna frontal esquerda
    svg += `<rect x="28" y="72" width="2.5" height="16" fill="#6b5b50" opacity="0.85"/>`;
    svg += `<rect x="28.2" y="72" width="0.8" height="16" fill="#8b7b70" opacity="0.4"/>`;
    
    // Perna frontal direita (mais para tr√°s)
    svg += `<rect x="60" y="74" width="2.5" height="14" fill="#6b5b50" opacity="0.8"/>`;
    svg += `<rect x="60.2" y="74" width="0.8" height="14" fill="#8b7b70" opacity="0.35"/>`;
    
    // Perna traseira esquerda (mais recuada, levemente mais fina)
    svg += `<rect x="32" y="72" width="2" height="16" fill="#6b5b50" opacity="0.75"/>`;
    
    // Perna traseira direita (mais recuada)
    svg += `<rect x="64" y="74" width="2" height="14" fill="#6b5b50" opacity="0.7"/>`;

    // ASSENTO (madeira principal - pe√ßa central)
    // Parte frontal do assento (bem vis√≠vel)
    svg += `<rect x="28" y="72" width="38" height="5" fill="url(#gMadeiraAssento)" stroke="#5b4b40" stroke-width="0.6" opacity="0.95"/>`;
    
    // Detalhe de profundidade - lado do assento (perspectiva)
    svg += `<polygon points="66,72 70,74 70,79 66,77" fill="#8a7a6f" opacity="0.7"/>`;
    
    // Parte traseira do assento (recuada)
    svg += `<polygon points="32,77 38,79 64,79 68,77" fill="#9b8b7e" opacity="0.6"/>`;

    // Vetas naturais de madeira no assento
    svg += `<line x1="28" y1="73.5" x2="66" y2="75" stroke="#c9b9aa" stroke-width="0.5" opacity="0.4"/>`;
    svg += `<line x1="28" y1="75" x2="66" y2="76.5" stroke="#6b5b50" stroke-width="0.3" opacity="0.3"/>`;

    // Detalhe de estrutura de suporte (travessas)
    svg += `<line x1="29" y1="77.5" x2="64" y2="79" stroke="#6b5b50" stroke-width="0.6" opacity="0.6"/>`;

    // Ornamentos finais (parafusos/rebites pequeninhos)
    svg += `<circle cx="32" cy="72.5" r="0.35" fill="#5a4a3f" opacity="0.7"/>`;
    svg += `<circle cx="48" cy="72.5" r="0.35" fill="#5a4a3f" opacity="0.7"/>`;
    svg += `<circle cx="64" cy="74.5" r="0.35" fill="#5a4a3f" opacity="0.65"/>`;

    svg += `</svg>`;
    return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
}

// √ÅREA DE PIQUENIQUE (toalha, cesto e frutas)
function gerarSpritePiquenique(tipo) {
    let svg = `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">`;
    svg += `<defs>`;
    svg += `<linearGradient id="gToalha" x1="0%" y1="0%" x2="100%" y2="100%">`;
    svg += `<stop offset="0%" stop-color="#ff9abf" opacity="0.95"/>`;
    svg += `<stop offset="45%" stop-color="#ff6b94" opacity="0.92"/>`;
    svg += `<stop offset="100%" stop-color="#d42d6c" opacity="0.9"/>`;
    svg += `</linearGradient>`;
    svg += `<radialGradient id="gLuzToalha" cx="0.5" cy="0.3" r="0.8">`;
    svg += `<stop offset="0%" stop-color="#ffe4eb" stop-opacity="0.95"/>`;
    svg += `<stop offset="100%" stop-color="transparent" stop-opacity="0"/>`;
    svg += `</radialGradient>`;
    svg += `<linearGradient id="gCesto" x1="0%" y1="0%" x2="0%" y2="100%">`;
    svg += `<stop offset="0%" stop-color="#d4a574" opacity="0.95"/>`;
    svg += `<stop offset="100%" stop-color="#a8845c" opacity="0.96"/>`;
    svg += `</linearGradient>`;
    svg += `<radialGradient id="gCup" cx="0.3" cy="0.3" r="0.6">`;
    svg += `<stop offset="0%" stop-color="#fce4ec" stop-opacity="1"/>`;
    svg += `<stop offset="100%" stop-color="#f06292" stop-opacity="0.9"/>`;
    svg += `</radialGradient>`;
    svg += `<linearGradient id="gFolha" x1="0%" y1="0%" x2="100%" y2="100%">`;
    svg += `<stop offset="0%" stop-color="#66bb6a" opacity="0.85"/>`;
    svg += `<stop offset="100%" stop-color="#2e7d32" opacity="0.9"/>`;
    svg += `</linearGradient>`;
    svg += `</defs>`;

    svg += `<rect width="100" height="100" fill="none"/>`;

    // Sombra suave
    svg += `<ellipse cx="50" cy="88" rx="22" ry="2.5" fill="rgba(0,0,0,0.14)"/>`;

    // ========== TOALHA ROM√ÇNTICA COM PERSPECTIVA 3/4 ==========
    svg += `<polygon points="20,65 70,67 74,83 16,83" fill="url(#gToalha)" stroke="#a01a24" stroke-width="0.8" opacity="0.98"/>`;
    svg += `<ellipse cx="48" cy="69" rx="25" ry="10" fill="url(#gLuzToalha)" opacity="0.55"/>`;

    // Padr√£o xadrez suave
    for (let x = 20; x < 70; x += 5) {
        for (let y = 65; y < 81; y += 3) {
            if (((Math.floor(x / 5) + Math.floor(y / 3)) % 2) === 0) {
                svg += `<rect x="${x}" y="${y}" width="5" height="3" fill="#ffffff" opacity="0.32"/>`;
            }
        }
    }

    svg += `<line x1="20" y1="65" x2="70" y2="67" stroke="#8b1520" stroke-width="0.7" opacity="0.8"/>`;
    svg += `<line x1="16" y1="83" x2="74" y2="83" stroke="#6b0f18" stroke-width="0.6" opacity="0.7"/>`;

    // CORA√á√ïES FLUTUANTES (fofura extra)
    svg += `<path d="M 30 57 C 30 53 34 53 34 57 C 34 62 30 66 30 66 C 30 66 26 62 26 57 C 26 53 30 53 30 57 Z" fill="#ffcfe2" opacity="0.92"/>`;
    svg += `<path d="M 36 57 C 36 53 40 53 40 57 C 40 62 36 66 36 66 C 36 66 32 62 32 57 C 32 53 36 53 36 57 Z" fill="#ffe4e1" opacity="0.85"/>`;
    svg += `<path d="M 64 54 C 64 51 67 51 67 54 C 67 57 64 61 64 61 C 64 61 61 57 61 54 C 61 51 64 51 64 54 Z" fill="#ffd1dc" opacity="0.8"/>`;

    const sparkles = [
        { x: 34, y: 52 },
        { x: 68, y: 54 },
        { x: 58, y: 50 }
    ];
    sparkles.forEach(spark => {
        svg += `<path d="M ${spark.x} ${spark.y - 1} L ${spark.x} ${spark.y + 1} M ${spark.x - 1} ${spark.y} L ${spark.x + 1} ${spark.y}" stroke="#fff7ef" stroke-width="0.4" stroke-linecap="round" opacity="0.75"/>`;
    });

    const tinyFlowers = [
        { cx: 24, cy: 71 },
        { cx: 74, cy: 71 },
        { cx: 62, cy: 64 }
    ];
    const petalOffsets = [
        { dx: 0, dy: -1.4 },
        { dx: 1.1, dy: 0 },
        { dx: 0, dy: 1.1 },
        { dx: -1.1, dy: 0 }
    ];
    tinyFlowers.forEach(flower => {
        petalOffsets.forEach(offset => {
            svg += `<circle cx="${flower.cx + offset.dx}" cy="${flower.cy + offset.dy}" r="0.7" fill="#fff3f6" opacity="0.95"/>`;
        });
        svg += `<circle cx="${flower.cx}" cy="${flower.cy}" r="0.95" fill="#ffd54f" opacity="0.95"/>`;
    });

    svg += `<path d="M 32 74 Q 30 70 34 69 Q 37 70 35 74 Z" fill="url(#gFolha)" opacity="0.9"/>`;
    svg += `<path d="M 70 74 Q 68 70 72 69 Q 75 70 73 74 Z" fill="url(#gFolha)" opacity="0.9"/>`;

    // ========== CESTA DE PIQUENIQUE - DETALHES ==========
    svg += `<ellipse cx="50" cy="70" rx="12" ry="4" fill="url(#gCesto)" stroke="#8b6f47" stroke-width="0.7" opacity="0.96"/>`;
    svg += `<path d="M 62 70 Q 66 71 68 68 L 68 72 Q 66 75 62 74 Z" fill="#9d8562" opacity="0.72"/>`;
    svg += `<path d="M 40 70 Q 50 50 60 70" stroke="#8b6f47" stroke-width="1.4" fill="none" opacity="0.93" stroke-linecap="round"/>`;
    svg += `<path d="M 41 71 Q 50 52 59 71" stroke="#c9a876" stroke-width="0.6" fill="none" opacity="0.35"/>`;
    svg += `<ellipse cx="50" cy="68.5" rx="11" ry="3.5" fill="#7a6542" opacity="0.5"/>`;
    svg += `<line x1="38" y1="71" x2="62" y2="72" stroke="#6b5830" stroke-width="0.35" opacity="0.5"/>`;
    svg += `<line x1="38" y1="73" x2="62" y2="74" stroke="#6b5830" stroke-width="0.35" opacity="0.5"/>`;

    // ========== X√çCARA DE CH√Å COM NUVENS DE CORA√á√ÉO ==========
    svg += `<path d="M 43 58 Q 55 52 57 58 L 57 62 Q 57 64 52 64 L 48 64 Q 44 64 43 60 Z" fill="url(#gCup)" stroke="#ef5350" stroke-width="0.6"/>`;
    svg += `<path d="M 57 58 Q 59 58 60 60 Q 60 62 58 63" stroke="#ef5350" stroke-width="0.6" fill="none"/>`;
    svg += `<path d="M 44 48 Q 52 44 60 48" stroke="#fff" stroke-width="0.5" fill="none" opacity="0.7"/>`;
    svg += `<path d="M 56 45 Q 57 43 59 45 Q 60 47 58 49 Q 57 47 56 45 Z" fill="#f48fb1" opacity="0.8"/>`;
    svg += `<path d="M 58 43 Q 60 41 62 43 Q 63 45 62 47 Q 61 45 60 45 Q 58 44 58 43 Z" fill="#ff80ab" opacity="0.7"/>`;
    svg += `<path d="M 58 46 Q 60 46 60 48 Q 60 50 58 51" stroke="#ef5350" stroke-width="0.5" fill="none" opacity="0.8" stroke-linecap="round"/>`;
    svg += `<rect x="41" y="66" width="9" height="6" rx="1" fill="#fff3e0" stroke="#ffb74d" stroke-width="0.4"/>`;
    svg += `<path d="M 41 66 Q 41 63 45 63 H 53 Q 57 63 57 66" stroke="#ffb74d" stroke-width="0.4" fill="none" opacity="0.8"/>`;

    // ========== FRUTAS ESPALHADAS ==========
    svg += `<circle cx="28" cy="78" r="3" fill="#d32f2f" opacity="0.92"/>`;
    svg += `<circle cx="29" cy="77" r="0.8" fill="#8b1f1f" opacity="0.7"/>`;
    svg += `<path d="M 29 76.5 L 29.5 75.5" stroke="#228b22" stroke-width="0.5" opacity="0.8"/>`;

    svg += `<circle cx="25" cy="80" r="2.5" fill="#ffb347" opacity="0.95"/>`;
    svg += `<circle cx="25.8" cy="79.3" r="0.5" fill="#ff6f00" opacity="0.7"/>`;

    svg += `<path d="M 48 50 Q 55 47 58 52" stroke="#ffd700" stroke-width="2" fill="none" opacity="0.94" stroke-linecap="round"/>`;
    svg += `<path d="M 48.5 51 Q 55 48.5 57.5 53" stroke="#fff59d" stroke-width="0.8" fill="none" opacity="0.4"/>`;

    svg += `<path d="M 70 65 L 73 62 L 75 63 L 74 66 Z" fill="#ff1744" opacity="0.93"/>`;
    svg += `<circle cx="71" cy="64" r="0.35" fill="#ffeb3b" opacity="0.7"/>`;
    svg += `<circle cx="73" cy="63.5" r="0.35" fill="#ffeb3b" opacity="0.7"/>`;

    svg += `<circle cx="72" cy="75" r="2" fill="#7b1fa2" opacity="0.92"/>`;
    svg += `<circle cx="74.5" cy="75" r="1.8" fill="#7b1fa2" opacity="0.9"/>`;
    svg += `<circle cx="73.2" cy="77.2" r="1.7" fill="#7b1fa2" opacity="0.88"/>`;

    svg += `<path d="M 60 82 L 67 80 L 69 85 L 62 87 Z" fill="#ff5252" opacity="0.93"/>`;
    svg += `<line x1="62" y1="83" x2="66" y2="85.5" stroke="#1a1a1a" stroke-width="0.3" opacity="0.6"/>`;
    svg += `<line x1="63" y1="82.5" x2="67.5" y2="85" stroke="#1a1a1a" stroke-width="0.3" opacity="0.6"/>`;
    svg += `<line x1="64" y1="82.5" x2="68" y2="85" stroke="#1a1a1a" stroke-width="0.3" opacity="0.6"/>`;
    svg += `<path d="M 68 79 Q 71 77 72.5 79.5" fill="#388e3c" opacity="0.75"/>`;

    svg += `</svg>`;
    return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
}

// Gazebo estilo Twemoji: compacto, cores vibrantes e formas fofas
function gerarSpriteGazebo(tipo) {
    let svg = `<svg viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg">`;
    // Sombra suave no ch√£o
    svg += `<ellipse cx="18" cy="33" rx="12" ry="2.5" fill="#CCD6DD" opacity="0.6"/>`;
    
    // Base (Palquinho)
    svg += `<path d="M5,31 L31,31 Q31,34 18,34 Q5,34 5,31 Z" fill="#D79E84"/>`; // Base madeira
    svg += `<rect x="6" y="29" width="24" height="2" rx="1" fill="#F5F8FA"/>`; // Piso marmorizado
    
    // Colunas (4 colunas com profundidade simples)
    svg += `<rect x="8" y="16" width="2" height="13" fill="#E1E8ED"/>`; 
    svg += `<rect x="26" y="16" width="2" height="13" fill="#E1E8ED"/>`;
    svg += `<rect x="13" y="18" width="1.5" height="11" fill="#CCD6DD"/>`;
    svg += `<rect x="21.5" y="18" width="1.5" height="11" fill="#CCD6DD"/>`;

    // Telhado Arredondado (Estilo Pagode/Gazebo fofo)
    // Camada de baixo do telhado
    svg += `<path d="M4,20 L32,20 Q32,24 18,24 Q4,24 4,20 Z" fill="#DD2E44"/>`;
    // Parte principal do telhado
    svg += `<path d="M3,20 Q18,4 33,20 Z" fill="#EA596E"/>`;
    
    // Detalhe no topo (Bolota dourada) - Ajustado para encaixar no telhado
    svg += `<circle cx="18" cy="11.5" r="3" fill="#FFCC4D"/>`;
    svg += `<circle cx="18" cy="11" r="1.5" fill="#FFAC33"/>`;

    svg += `</svg>`;
    return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
}

function gerarSpriteTorre(tipo) {
    let svg = `<svg width="300" height="450" viewBox="0 0 200 400" fill="none" xmlns="http://www.w3.org/2000/svg">
  <g id="tower">
    
    <g id="base">
      <path d="M70 190 L50 380 L100 380 L100 190 Z" fill="#E6C896"/>
      <path d="M100 190 L100 380 L150 380 L130 190 Z" fill="#D1A676"/>
      
      <path d="M60 340 H75 V348 H60 Z" fill="#D1A676" opacity="0.8"/>
      <path d="M85 300 H95 V308 H85 Z" fill="#D1A676" opacity="0.8"/>
      <path d="M55 280 H65 V286 H55 Z" fill="#D1A676" opacity="0.8"/>
      
      <path d="M110 360 H130 V368 H110 Z" fill="#B58B5E" opacity="0.8"/>
      <path d="M135 320 H145 V326 H135 Z" fill="#B58B5E" opacity="0.8"/>
      <path d="M105 280 H120 V288 H105 Z" fill="#B58B5E" opacity="0.8"/>
    </g>

    <g id="window" transform="translate(0, 20)">
      <path d="M85 220 V250 H115 V220 C115 210 108 205 100 205 C92 205 85 210 85 220 Z" fill="#4A2C22"/>
      <rect x="85" y="248" width="30" height="4" fill="#6B4232"/> <rect x="98" y="205" width="4" height="45" fill="#6B4232"/> <rect x="85" y="225" width="30" height="4" fill="#6B4232"/> </g>

    <g id="upper-section">
      <g fill="#B58B5E"> <rect x="65" y="190" width="10" height="10"/>
        <rect x="80" y="190" width="10" height="10"/>
        <rect x="95" y="190" width="10" height="10"/>
        <rect x="110" y="190" width="10" height="10"/>
        <rect x="125" y="190" width="10" height="10"/>
      </g>
      
      <path d="M55 160 L55 190 L145 190 L145 160 Z" fill="#D1A676"/> <path d="M55 160 L55 190 L100 190 L100 160 Z" fill="#E6C896"/> <rect x="55" y="160" width="90" height="10" fill="#A67C52"/>
      <rect x="65" y="165" width="10" height="10" fill="#4A2C22"/> <rect x="95" y="165" width="10" height="10" fill="#4A2C22"/> <rect x="125" y="165" width="10" height="10" fill="#4A2C22"/> </g>

    <g id="roof">
      <path d="M50 160 Q100 150 150 160 L100 90 Z" fill="#D94214"/>
      <path d="M50 160 Q75 155 100 155 L100 90 Z" fill="#E85D2E"/>
      <path d="M100 155 Q125 155 150 160 L100 90 Z" fill="#B02E0C"/>
    </g>

    <g id="flag-pole">
      <line x1="100" y1="90" x2="100" y2="40" stroke="#4A2C22" stroke-width="3" stroke-linecap="round"/>
      <circle cx="100" cy="40" r="3" fill="#4A2C22"/>
      
      <path d="M102 45 
               C 120 35, 140 55, 160 45 
               L 165 55 
               C 145 65, 125 45, 102 55 
               Z" fill="red"/>
      <path d="M130 50 C 140 55, 150 50, 160 45 L 165 55 C 150 60, 140 50, 130 50" fill="#CC0000"/>
    </g>
  </g>
</svg>`;
    return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
}

function gerarSpriteCasa(tipo) {
    let svg = `<svg width="256" height="256" viewBox="0 0 256 256" fill="none" xmlns="http://www.w3.org/2000/svg">
  <g id="side-structure">
    <path d="M165 170 H200 V230 H165 V170Z" fill="#A86273"/>
    
    <path d="M200 230 H225 V222.5 H220 V215 H215 V207.5 H210 V200 H205 V192.5 H200 V185 V230Z" fill="#A86273"/>
    <path d="M200 185 H205 V192.5 H200 V185Z" fill="#8C4A5A"/>
    <path d="M205 192.5 H210 V200 H205 V192.5Z" fill="#8C4A5A"/>
    <path d="M210 200 H215 V207.5 H210 V200Z" fill="#8C4A5A"/>
    <path d="M215 207.5 H220 V215 H215 V207.5Z" fill="#8C4A5A"/>
    <path d="M220 215 H225 V222.5 H220 V215Z" fill="#8C4A5A"/>
    
    <path d="M172.5 180 H190 V205 H172.5 V180 A 7.5 7.5 0 0 1 190 180" fill="none" stroke="#8C4A5A" stroke-width="2"/>
    <path d="M175 185 H187.5 V205 H175 V185 A 6 6 0 0 1 187.5 185" fill="#915263"/>

    <path d="M165 102.5 L200 120 L197.5 122.5 L165 107.5 Z" fill="#7B8FA1"/>
    
    <rect x="187.5" y="122.5" width="6" height="45" rx="1.5" fill="#FF4D6D"/>
    <rect x="186.5" y="165" width="8" height="5" rx="1" fill="#FF4D6D"/>
    
    <rect x="165" y="150" width="22.5" height="20" fill="none"/>
    <line x1="167.5" y1="150" x2="167.5" y2="170" stroke="#DDD" stroke-width="1.5"/>
    <line x1="172.5" y1="150" x2="172.5" y2="170" stroke="#DDD" stroke-width="1.5"/>
    <line x1="177.5" y1="150" x2="177.5" y2="170" stroke="#DDD" stroke-width="1.5"/>
    <line x1="182.5" y1="150" x2="182.5" y2="170" stroke="#DDD" stroke-width="1.5"/>
    <rect x="165" y="150" width="20" height="2" fill="#DDD"/>
  </g>

  <g id="main-house">
    <path d="M50 60 L107.5 15 L165 60 V215 H50 V60Z" fill="#FF4D6D"/>
    <path d="M50 155 H165" stroke="#D90429" stroke-width="1"/>

    <rect x="55" y="70" width="12.5" height="5" rx="1" fill="#D90429"/>
    <rect x="65" y="62.5" width="10" height="4" rx="1" fill="#D90429"/>
    <rect x="140" y="75" width="12.5" height="5" rx="1" fill="#D90429"/>
    <rect x="85" y="82.5" width="12.5" height="4" rx="1" fill="#D90429"/>
    <rect x="75" y="110" width="10" height="4" rx="1" fill="#D90429"/>
    <rect x="157.5" y="160" width="7.5" height="5" rx="1" fill="#D90429"/>
    <rect x="142.5" y="205" width="12.5" height="4" rx="1" fill="#D90429"/>
    
    <path d="M45 62.5 L107.5 10 L170 62.5 L167.5 65 L107.5 15 L47.5 65 Z" fill="#7B8FA1"/>

    <circle cx="107.5" cy="52.5" r="11" fill="#3F3763" stroke="#D90429" stroke-width="2"/>
    <line x1="107.5" y1="41.5" x2="107.5" y2="63.5" stroke="#2A2442" stroke-width="1.5"/>
    <line x1="96.5" y1="52.5" x2="118.5" y2="52.5" stroke="#2A2442" stroke-width="1.5"/>

    <path d="M97.5 95 A 10 10 0 0 1 117.5 95 V145 H97.5 Z" fill="#3F3763"/>
    <path d="M92.5 95 A 15 15 0 0 1 122.5 95 V150" fill="none" stroke="#D90429" stroke-width="1.5"/>
    <line x1="107.5" y1="85" x2="107.5" y2="145" stroke="#2A2442" stroke-width="1.5"/>
    <line x1="97.5" y1="105" x2="117.5" y2="105" stroke="#2A2442" stroke-width="1.5"/>
    <line x1="97.5" y1="120" x2="117.5" y2="120" stroke="#2A2442" stroke-width="1.5"/>
    <line x1="97.5" y1="135" x2="117.5" y2="135" stroke="#2A2442" stroke-width="1.5"/>

    <rect x="60" y="115" width="8" height="32.5" rx="4" fill="#3F3763"/>
    <line x1="60" y1="125" x2="68" y2="125" stroke="#2A2442" stroke-width="1"/>
    <line x1="60" y1="137.5" x2="68" y2="137.5" stroke="#2A2442" stroke-width="1"/>

    <rect x="145" y="115" width="8" height="32.5" rx="4" fill="#3F3763"/>
    <line x1="145" y1="125" x2="153" y2="125" stroke="#2A2442" stroke-width="1"/>
    <line x1="145" y1="137.5" x2="153" y2="137.5" stroke="#2A2442" stroke-width="1"/>

    <path d="M62.5 195 A 17.5 17.5 0 0 1 97.5 195 Z" fill="#3F3763"/>
    <path d="M57.5 195 A 22.5 22.5 0 0 1 102.5 195 H102.5 V200 H57.5 V195 Z" fill="none" stroke="#FF2A50" stroke-width="2"/>
    <line x1="80" y1="177.5" x2="80" y2="195" stroke="#2A2442" stroke-width="1.5"/>
    <path d="M67.5 195 L80 177.5 L92.5 195" fill="none" stroke="#2A2442" stroke-width="1.5"/>

    <path d="M115 195 A 17.5 17.5 0 0 1 150 195 Z" fill="#3F3763"/>
    <path d="M110 195 A 22.5 22.5 0 0 1 155 195 H155 V200 H110 V195 Z" fill="none" stroke="#FF2A50" stroke-width="2"/>
    <line x1="132.5" y1="177.5" x2="132.5" y2="195" stroke="#2A2442" stroke-width="1.5"/>
    <path d="M120 195 L132.5 177.5 L145 195" fill="none" stroke="#2A2442" stroke-width="1.5"/>
    
    <rect x="101.5" y="171" width="14" height="4" rx="1" fill="#FF2A50"/>
  </g>

  <g id="foundation">
    <path d="M45 215 H170 L172.5 232.5 H42.5 L45 215Z" fill="#A68A99"/>
    <path d="M65 215 L65 232.5" stroke="#8A7080" stroke-width="1"/>
    <path d="M90 215 L92.5 225 L87.5 232.5" stroke="#8A7080" stroke-width="1"/>
    <path d="M110 215 L110 225 L120 225 L120 232.5" stroke="#8A7080" stroke-width="1"/>
    <path d="M140 215 L137.5 232.5" stroke="#8A7080" stroke-width="1"/>
    <path d="M155 222.5 L171 222.5" stroke="#8A7080" stroke-width="1"/>
    <path d="M45 225 L60 225" stroke="#8A7080" stroke-width="1"/>
  </g>
</svg>`;
    return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
}

function abrirLoja() {
    // 0. Garante que o menu lateral esteja fechado
    const abaEsquerda = document.getElementById('abaEsquerda');
    if (abaEsquerda) {
        abaEsquerda.classList.remove('aberto');
    }

    // 1. Atualiza quais pets j√° foram comprados e ajusta os pre√ßos
    if (typeof verificarBotoesPetsLoja === 'function') {
        verificarBotoesPetsLoja(); 
    }

    // 2. Atualiza os bot√µes de ativar/desativar temas (Natal, Medieval, etc)
    if (typeof atualizarTogglesTemasLoja === 'function') {
        atualizarTogglesTemasLoja();
    }

    // 3. Garante que o saldo de moedas mostrado na loja est√° atualizado
    if (document.getElementById('saldoLojaMoedas')) {
        document.getElementById('saldoLojaMoedas').textContent = totalMoedas;
    }

    // 4. Atualiza o saldo no cabe√ßalho da loja
    atualizarSaldoLoja();

    // 5. Define a aba padr√£o (temas) ao abrir a loja
    trocarAbaLoja('tema');

    // 6. Abre a janela (Modal) da loja
    abrirModal('lojaOverlay');
}

// ==========================================
// CA√áA-N√çQUEL
// ==========================================

const SIMBOLOS_CACA_NIQUEL = ['üçí', 'üçã', 'üçä', '‚≠ê', 'üíé'];
const VALORES_CACA_NIQUEL = { 'üçí': 8, 'üçã': 12, 'üçä': 18, '‚≠ê': 35, 'üíé': 75 };
const CUSTO_JOGADA = 5;

function abrirCacaNiquel() {
    // Atualiza saldo mostrado
    if (document.getElementById('saldoCacaNiquel')) {
        document.getElementById('saldoCacaNiquel').textContent = totalMoedas;
    }
    
    // Inicializa os rolos com s√≠mbolos aleat√≥rios
    for (let i = 1; i <= 3; i++) {
        const reel = document.getElementById('reel' + i);
        if (reel) {
            const simbolo = SIMBOLOS_CACA_NIQUEL[Math.floor(Math.random() * SIMBOLOS_CACA_NIQUEL.length)];
            const windowDiv = reel.querySelector('.reel-window');
            if (windowDiv) {
                windowDiv.textContent = simbolo;
            }
        }
    }
    
    // Limpa resultado anterior
    const resultadoDiv = document.getElementById('resultadoCacaNiquel');
    if (resultadoDiv) {
        resultadoDiv.textContent = '';
        resultadoDiv.style.color = 'var(--text-main)';
    }
    
    // Remove efeitos de vit√≥ria anteriores
    document.querySelectorAll('.reel-window').forEach(window => {
        window.classList.remove('winning');
    });
    
    // Fecha loja e abre ca√ßa-n√≠quel
    fecharModal('lojaOverlay');
    abrirModal('cacaNiquelOverlay');
}

function girarCacaNiquel() {
    const lever = document.getElementById('slotLever');
    const resultadoDiv = document.getElementById('resultadoCacaNiquel');
    
    // Verifica se tem moedas suficientes
    if (totalMoedas < CUSTO_JOGADA) {
        if (resultadoDiv) {
            resultadoDiv.textContent = 'üí∞ Moedas insuficientes!';
            resultadoDiv.style.color = '#e74c3c';
        }
        return;
    }
    
    // Anima√ß√£o da alavanca sendo puxada
    if (lever) {
        const leverArm = lever.querySelector('#leverArm');
        if (leverArm) {
            leverArm.style.transform = 'translateX(-50%) rotate(-15deg)';
            setTimeout(() => {
                leverArm.style.transform = 'translateX(-50%) rotate(0deg)';
            }, 300);
        }
    }
    
    // Cobre o custo da jogada
    updateMoedas(-CUSTO_JOGADA);
    
    // Limpa resultado anterior
    if (resultadoDiv) {
        resultadoDiv.textContent = 'üé∞ Girando...';
        resultadoDiv.style.color = 'var(--text-secondary)';
    }
    
    // Remove efeitos de vit√≥ria anteriores
    document.querySelectorAll('.reel-window').forEach(window => {
        window.classList.remove('winning');
    });
    
    // Anima√ß√£o de giro vertical realista com delays diferentes
    const resultados = [];
    
    // Fun√ß√£o para animar um rolo espec√≠fico
    function animarRolo(roloIndex, delay) {
        setTimeout(() => {
            const reel = document.getElementById('reel' + (roloIndex + 1));
            if (!reel) return;
            
            const windowDiv = reel.querySelector('.reel-window');
            if (!windowDiv) return;
            
            // Adiciona classe de spinning
            reel.classList.add('spinning');
            
            // Simula v√°rios s√≠mbolos passando rapidamente
            let spinCount = 0;
            const maxSpins = 8 + Math.random() * 4; // 8-12 spins
            
            const spinInterval = setInterval(() => {
                const simboloAleatorio = SIMBOLOS_CACA_NIQUEL[Math.floor(Math.random() * SIMBOLOS_CACA_NIQUEL.length)];
                windowDiv.textContent = simboloAleatorio;
                spinCount++;
                
                // Diminui velocidade gradualmente
                if (spinCount > maxSpins * 0.7) {
                    clearInterval(spinInterval);
                    
// Para o rolo com o s√≠mbolo final - sistema mais dif√≠cil
                        setTimeout(() => {
                            let simboloFinal;

                            // Sistema de probabilidade mais rigoroso
                            const rand = Math.random();

                            // 85% chance de perder completamente
                            if (rand < 0.85) {
                                // Garante que n√£o forme combina√ß√£o vencedora
                                const outrosSimbolos = resultados.slice();
                                outrosSimbolos.push(null); // placeholder para este rolo

                                // Evita combina√ß√µes de 3 iguais
                                do {
                                    simboloFinal = SIMBOLOS_CACA_NIQUEL[Math.floor(Math.random() * SIMBOLOS_CACA_NIQUEL.length)];
                                } while (
                                    (roloIndex === 2 && resultados[0] === resultados[1] && simboloFinal === resultados[0]) || // Evita 3 iguais
                                    (roloIndex === 2 && resultados[0] === simboloFinal && resultados[1] !== simboloFinal) || // Evita 2+1
                                    (roloIndex === 2 && resultados[1] === simboloFinal && resultados[0] !== simboloFinal)    // Evita 1+2
                                );

                            // 12% chance de vit√≥ria pequena (2 s√≠mbolos iguais)
                            } else if (rand < 0.97) {
                                // Tenta formar 2 s√≠mbolos iguais
                                if (roloIndex === 1 && resultados[0] !== null) {
                                    // Segundo rolo: 50% chance de combinar com o primeiro
                                    simboloFinal = Math.random() < 0.5 ? resultados[0] : SIMBOLOS_CACA_NIQUEL[Math.floor(Math.random() * SIMBOLOS_CACA_NIQUEL.length)];
                                } else if (roloIndex === 2) {
                                    // Terceiro rolo: tenta completar par ou formar novo
                                    if (resultados[0] === resultados[1] && Math.random() < 0.3) {
                                        simboloFinal = resultados[0]; // Completa trinca (raro)
                                    } else if (Math.random() < 0.4) {
                                        simboloFinal = resultados[1]; // Forma par com segundo
                                    } else if (Math.random() < 0.3) {
                                        simboloFinal = resultados[0]; // Forma par com primeiro
                                    } else {
                                        simboloFinal = SIMBOLOS_CACA_NIQUEL[Math.floor(Math.random() * SIMBOLOS_CACA_NIQUEL.length)];
                                    }
                                } else {
                                    simboloFinal = SIMBOLOS_CACA_NIQUEL[Math.floor(Math.random() * SIMBOLOS_CACA_NIQUEL.length)];
                                }

                            // 3% chance de jackpot (muito raro)
                            } else {
                                // Apenas diamantes ou estrelas para jackpot
                                simboloFinal = Math.random() < 0.5 ? 'üíé' : '‚≠ê';

                                // Para jackpot real, precisa que os outros tamb√©m sejam iguais
                                if (roloIndex === 2) {
                                    if (resultados[0] === resultados[1] && resultados[0] === simboloFinal) {
                                        // Jackpot! Mant√©m o s√≠mbolo
                                    } else {
                                        // N√£o √© jackpot, muda para algo comum
                                        simboloFinal = SIMBOLOS_CACA_NIQUEL[Math.floor(Math.random() * 3)]; // Apenas frutas comuns
                                    }
                                }
                            }

                            windowDiv.textContent = simboloFinal;
                            resultados.push(simboloFinal);
                            reel.classList.remove('spinning');

                        // Quando todos os rolos pararam, calcula resultado
                        if (resultados.length === 3) {
                            calcularResultadoCacaNiquel(resultados);
                        }
                    }, 100 + Math.random() * 200); // Pequeno delay aleat√≥rio para naturalidade
                    
                } else if (spinCount > maxSpins * 0.5) {
                    // Diminui frequ√™ncia
                    clearInterval(spinInterval);
                    setTimeout(() => {
                        const simboloAleatorio = SIMBOLOS_CACA_NIQUEL[Math.floor(Math.random() * SIMBOLOS_CACA_NIQUEL.length)];
                        windowDiv.textContent = simboloAleatorio;
                        spinCount++;
                        
                        const slowerInterval = setInterval(() => {
                            const simboloAleatorio = SIMBOLOS_CACA_NIQUEL[Math.floor(Math.random() * SIMBOLOS_CACA_NIQUEL.length)];
                            windowDiv.textContent = simboloAleatorio;
                            spinCount++;
                            
                            if (spinCount >= maxSpins) {
                                clearInterval(slowerInterval);
                                
                                setTimeout(() => {
                                    const simboloFinal = SIMBOLOS_CACA_NIQUEL[Math.floor(Math.random() * SIMBOLOS_CACA_NIQUEL.length)];
                                    windowDiv.textContent = simboloFinal;
                                    resultados.push(simboloFinal);
                                    reel.classList.remove('spinning');
                                    
                                    if (resultados.length === 3) {
                                        calcularResultadoCacaNiquel(resultados);
                                    }
                                }, 150 + Math.random() * 200);
                            }
                        }, 150);
                    }, 100);
                }
            }, 80); // Velocidade inicial
            
        }, delay);
    }
    
    // Anima os tr√™s rolos com delays progressivos
    animarRolo(0, 200);  // Primeiro rolo come√ßa ap√≥s 200ms
    animarRolo(1, 600);  // Segundo rolo come√ßa ap√≥s 600ms  
    animarRolo(2, 1000); // Terceiro rolo come√ßa ap√≥s 1000ms
}

function calcularResultadoCacaNiquel(resultado) {
    const resultadoDiv = document.getElementById('resultadoCacaNiquel');

    // Calcula ganho com probabilidades muito mais dif√≠ceis
    let ganho = 0;
    let winningReels = [];
    const [simbolo1, simbolo2, simbolo3] = resultado;

    // JACKPOT ULTRA RARO: Apenas 3 diamantes (probabilidade ~0.008%)
    if (simbolo1 === 'üíé' && simbolo2 === 'üíé' && simbolo3 === 'üíé') {
        ganho = VALORES_CACA_NIQUEL['üíé'] * 10; // 10x o valor = 750 moedas
        winningReels = [0, 1, 2];

        setTimeout(() => {
            showToast('üíé', 'MEGA JACKPOT!', `3 üíé = ${ganho} moedas!`);
        }, 500);

    // VIT√ìRIA RARA: 3 estrelas (probabilidade ~0.008%)
    } else if (simbolo1 === '‚≠ê' && simbolo2 === '‚≠ê' && simbolo3 === '‚≠ê') {
        ganho = VALORES_CACA_NIQUEL['‚≠ê'] * 8; // 8x o valor = 280 moedas
        winningReels = [0, 1, 2];

        setTimeout(() => {
            showToast('‚≠ê', 'GRANDE VIT√ìRIA!', `3 ‚≠ê = ${ganho} moedas!`);
        }, 500);

    // VIT√ìRIA DIF√çCIL: 3 frutas iguais (exceto diamante e estrela)
    } else if (simbolo1 === simbolo2 && simbolo2 === simbolo3 && simbolo1 !== 'üíé' && simbolo1 !== '‚≠ê') {
        ganho = VALORES_CACA_NIQUEL[simbolo1] * 3; // 3x o valor
        winningReels = [0, 1, 2];

    // VIT√ìRIA M√âDIA: 2 frutas iguais (qualquer combina√ß√£o)
    } else if (simbolo1 === simbolo2 || simbolo2 === simbolo3 || simbolo1 === simbolo3) {
        const simboloIgual = simbolo1 === simbolo2 ? simbolo1 : (simbolo2 === simbolo3 ? simbolo2 : simbolo1);
        ganho = Math.floor(VALORES_CACA_NIQUEL[simboloIgual] * 0.6); // 60% do valor

        // Identifica quais rolos t√™m o s√≠mbolo vencedor
        if (simbolo1 === simbolo2) winningReels = [0, 1];
        else if (simbolo2 === simbolo3) winningReels = [1, 2];
        else winningReels = [0, 2];
    }

    // Aplica efeito visual nos rolos vencedores
    if (winningReels.length > 0) {
        winningReels.forEach(index => {
            const reel = document.getElementById('reel' + (index + 1));
            if (reel) {
                const windowDiv = reel.querySelector('.reel-window');
                if (windowDiv) {
                    windowDiv.classList.add('winning');
                }
            }
        });

        // Remove efeito ap√≥s alguns segundos
        setTimeout(() => {
            document.querySelectorAll('.reel-window.winning').forEach(window => {
                window.classList.remove('winning');
            });
        }, 3000);
    }

    // Aplica ganho e mostra resultado
    setTimeout(() => {
        if (ganho > 0) {
            updateMoedas(ganho);
            if (resultadoDiv) {
                resultadoDiv.textContent = `üéâ Voc√™ ganhou ${ganho} moedas!`;
                resultadoDiv.style.color = '#4CAF50';
            }
        } else {
            if (resultadoDiv) {
                resultadoDiv.textContent = 'üòî Tente novamente!';
                resultadoDiv.style.color = '#e74c3c';
            }
        }

        // Atualiza saldo mostrado
        if (document.getElementById('saldoCacaNiquel')) {
            document.getElementById('saldoCacaNiquel').textContent = totalMoedas;
        }
    }, 500);
}

// ==========================================




// --- Funcionalidade de Pan (Arraste) e Pinch (Zoom) para o Grid 3D ---
function initPan3D() {
    const container = document.getElementById('jardim3D');
    const grid3D = document.getElementById('grid3D');
    if (!container || !grid3D) return;

    // Mouse Events - iniciar arraste apenas se o mousedown ocorrer dentro do grid3D
    grid3D.addEventListener('mousedown', (ev) => {
        // apenas bot√£o esquerdo
        if (ev.button !== 0) return;
        // n√£o iniciar pan ao interagir com controles dentro do grid
        if (ev.target && ev.target.closest && ev.target.closest('button, a, input, textarea, select, .no-pan')) return;
        startDragging3D(ev);
    });
    window.addEventListener('mousemove', drag3D);
    window.addEventListener('mouseup', stopDragging3D);

    // Touch Events - iniciar arraste apenas se o touchstart ocorrer no grid3D
    grid3D.addEventListener('touchstart', (e) => {
        if (e.touches.length === 1) {
            // ignorar toques em controles
            if (e.target && e.target.closest && e.target.closest('button, a, input, textarea, select, .no-pan')) return;
            // passar um objeto similar ao MouseEvent para startDragging3D
            startDragging3D({ clientX: e.touches[0].clientX, clientY: e.touches[0].clientY, target: e.target });
        } else if (e.touches.length === 2) {
            isPinching3D = true;
            isDragging3D = false; // Desabilita pan enquanto pin√ßa
            startPinchDistance = Math.hypot(
                e.touches[0].clientX - e.touches[1].clientX,
                e.touches[0].clientY - e.touches[1].clientY
            );
            startZoom3D = zoom3DManual;
        }
    }, { passive: false });

    window.addEventListener('touchmove', (e) => {
        if (e.touches.length === 1 && isDragging3D) {
            drag3D({ clientX: e.touches[0].clientX, clientY: e.touches[0].clientY });
        } else if (e.touches.length === 2 && isPinching3D) {
            e.preventDefault();
            const currentDistance = Math.hypot(
                e.touches[0].clientX - e.touches[1].clientX,
                e.touches[0].clientY - e.touches[1].clientY
            );
            
            if (startPinchDistance > 0) {
                const ratio = currentDistance / startPinchDistance;
                // Sensibilidade do pinch (ajust√°vel)
                zoom3DManual = Math.max(0.5, Math.min(2.0, startZoom3D * ratio));
                StorageSeguro.set('zoom3DManual', zoom3DManual);
                ajustarTamanho3D();
            }
        }
    }, { passive: false });

    window.addEventListener('touchend', (e) => {
        if (e.touches.length < 2) isPinching3D = false;
        stopDragging3D();
    });
    
    grid3D.style.cursor = 'grab';
}

function startDragging3D(e) {
    // Prote√ß√µes: garantir coordenadas e ignorar elementos interativos
    if (!e || typeof e.clientX === 'undefined' || typeof e.clientY === 'undefined') return;
    if (e.button !== undefined && e.button !== 0) return; // apenas bot√£o esquerdo
    if (e.target && e.target.closest && e.target.closest('button, a, input, textarea, select, .no-pan')) return;

    isDragging3D = true;
    startX3D = e.clientX;
    startY3D = e.clientY;
    lastPanX3D = panX3D;
    lastPanY3D = panY3D;
    
    const grid3D = document.getElementById('grid3D');
    if (grid3D) {
        grid3D.style.transition = 'none'; // Remove transi√ß√£o durante o arraste para ser instant√¢neo
        grid3D.style.cursor = 'grabbing';
    }
}

function drag3D(e) {
    if (!isDragging3D) return;
    
    const dx = e.clientX - startX3D;
    const dy = e.clientY - startY3D;
    
    // Sensibilidade do pan (ajustada para o √¢ngulo 3D)
    panX3D = lastPanX3D + dx;
    panY3D = lastPanY3D + dy;
    
    ajustarTamanho3D();
}

function stopDragging3D() {
    if (!isDragging3D) return;
    isDragging3D = false;
    
    // Salvar posi√ß√£o do pan
    StorageSeguro.set('panX3D', panX3D);
    StorageSeguro.set('panY3D', panY3D);
    
    const grid3D = document.getElementById('grid3D');
    if (grid3D) {
        grid3D.style.cursor = 'grab';
        // Adiciona uma pequena suaviza√ß√£o ao soltar
        grid3D.style.transition = 'transform 0.3s ease-out';
    }
}

// Inicializar quando o DOM estiver pronto
document.addEventListener('DOMContentLoaded', initPan3D);

</script>
<!-- O sistema de di√°rio antigo foi removido e substitu√≠do pela nova integra√ß√£o. -->

<!-- MODAIS DO SISTEMA PLANTAR JUNTOS -->
<div id="avisoPlantarJuntosOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 34000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(10px);">
    <div id="avisoPlantarJuntosContent" style="background: var(--bg-panel); width: 90%; max-width: 450px; border-radius: 28px; padding: 35px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1);">
        <div style="font-size: 60px; margin-bottom: 20px;">üåø</div>
        <h2 style="color: var(--primary); margin-bottom: 15px;">Plantar Juntos</h2>
        <p style="color: var(--text-secondary); line-height: 1.6; margin-bottom: 25px;">
            Bem-vindo ao sistema de <strong>Jardim Compartilhado</strong>! <br><br>
            Este √© um recurso experimental onde voc√™ pode focar junto com seus amigos em tempo real usando tecnologia <strong>Peer-to-Peer</strong>.
        </p>
        <div style="background: rgba(76, 175, 80, 0.1); padding: 15px; border-radius: 15px; text-align: left; margin-bottom: 25px; font-size: 13px;">
            <div style="margin-bottom: 8px;">‚úÖ Sincroniza√ß√£o em tempo real</div>
            <div style="margin-bottom: 8px;">‚úÖ Compartilhe um jardim 3D de 5x5</div>
            <div>‚úÖ Gere c√≥digos e convide quem quiser</div>
        </div>
        <button onclick="fecharModal('avisoPlantarJuntosOverlay'); abrirPlantarJuntos();" style="width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 50px; font-weight: bold; font-size: 16px; cursor: pointer; transition: all 0.3s; box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);">
            Entrar no Jardim üåø
        </button>
        <button onclick="fecharModal('avisoPlantarJuntosOverlay')" style="width: 100%; margin-top: 15px; padding: 12px; background: transparent; color: var(--text-secondary); border: none; font-size: 14px; cursor: pointer;">
            Talvez depois
        </button>
    </div>
</div>

<div id="plantarJuntosOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 35000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(8px);">
    <div id="plantarJuntosContent" style="background: var(--bg-panel); width: 95%; max-width: 600px; max-height: 90vh; border-radius: 28px; padding: 30px; overflow-y: auto; position: relative; box-shadow: 0 20px 50px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1);">
        <span class="btn-fechar-modal" onclick="fecharModal('plantarJuntosOverlay')">‚úñ</span>
        <h2 style="color: var(--primary); margin-top: 0;">üåø Plantar Juntos</h2>
        <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 20px;">Escolha uma planta, selecione onde plantar e inicie o foco!</p>
        
        <!-- Abas para alternar entre Jardim, Conex√£o e Chat -->
        <div style="display: flex; gap: 10px; margin-bottom: 20px; justify-content: center;">
            <button id="btnTabJardim" onclick="trocarAbaPJ('jardim')" class="tab-active" style="flex: 1; padding: 10px; background: var(--primary); color: white; border: none; border-radius: 20px; font-weight: bold; cursor: pointer; transition: all 0.3s;">üå± Jardim</button>
            <button id="btnTabConexao" onclick="trocarAbaPJ('conexao')" style="flex: 1; padding: 10px; background: rgba(76, 175, 80, 0.2); color: var(--text-main); border: 2px solid rgba(76, 175, 80, 0.3); border-radius: 20px; font-weight: bold; cursor: pointer; transition: all 0.3s;">üîó Conex√£o</button>
            <button id="btnTabChat" onclick="trocarAbaPJ('chat')" style="flex: 1; padding: 10px; background: rgba(76, 175, 80, 0.2); color: var(--text-main); border: 2px solid rgba(76, 175, 80, 0.3); border-radius: 20px; font-weight: bold; cursor: pointer; transition: all 0.3s; position: relative;">üí¨ Chat <span id="chatTabNotification" style="display: none; position: absolute; top: -5px; right: -5px; width: 12px; height: 12px; background: #ff4444; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 4px rgba(255, 68, 68, 0.5);"></span></button>
        </div>
        
        <!-- Se√ß√£o Jardim -->
        <div id="secaoJardimPJ" style="display: block;">
            <!-- Widget Sua Planta + Amigos -->
            <div style="background: var(--bg-panel); border-radius: 16px; padding: 12px 16px; margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid rgba(76, 175, 80, 0.2);">
                <div style="display: flex; justify-content: flex-start; align-items: center; gap: 12px; flex-wrap: wrap;">
                    <!-- Sua Planta (clic√°vel) -->
                    <div style="text-align: center;">
                        <div style="font-size: 8px; opacity: 0.6; margin-bottom: 3px; text-transform: uppercase; letter-spacing: 0.5px;">Sua Planta</div>
                        <div id="plantaPJSelecionada" style="font-size: 28px; cursor: pointer; padding: 8px; background: linear-gradient(135deg, rgba(76, 175, 80, 0.2), rgba(76, 175, 80, 0.1)); border-radius: 12px; display: flex; align-items: center; justify-content: center; width: 48px; height: 48px; border: 2px solid var(--primary); transition: all 0.2s; box-shadow: 0 2px 8px rgba(76, 175, 80, 0.2);" onclick="abrirMenuPlantasPJ()" title="Clique para trocar" onmouseover="this.style.transform='scale(1.1)'; this.style.boxShadow='0 4px 12px rgba(76, 175, 80, 0.4)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(76, 175, 80, 0.2)'">üå±</div>
                        <div style="font-size: 9px; margin-top: 3px; font-weight: 600; color: var(--primary);">Voc√™</div>
                    </div>
                    <!-- Divisor + Amigos -->
                    <div id="amigosPlantasContainer" style="display: none; align-items: center; gap: 8px;">
                    <!-- Divisor vertical -->
                    <div style="width: 1px; height: 50px; background: linear-gradient(to bottom, transparent, var(--text-secondary), transparent); opacity: 0.4;"></div>
                    <!-- Amigos -->
                    <div style="text-align: center;">
                        <div style="font-size: 8px; opacity: 0.6; margin-bottom: 3px;">AMIGOS</div>
                        <div style="display: flex; gap: 6px;">
                            <div id="slotAmigo1" style="text-align: center; display: none;">
                                <div id="plantaAmigo1" style="font-size: 24px; padding: 6px; background: rgba(156, 39, 176, 0.1); border-radius: 10px; display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; border: 2px dashed rgba(156, 39, 176, 0.3); opacity: 0.8;">üå±</div>
                                <div id="nomeAmigo1" style="font-size: 9px; margin-top: 2px; max-width: 45px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; opacity: 0.7;">Amigo</div>
                            </div>
                            <div id="slotAmigo2" style="text-align: center; display: none;">
                                <div id="plantaAmigo2" style="font-size: 24px; padding: 6px; background: rgba(33, 150, 243, 0.1); border-radius: 10px; display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; border: 2px dashed rgba(33, 150, 243, 0.3); opacity: 0.8;">üå±</div>
                                <div id="nomeAmigo2" style="font-size: 9px; margin-top: 2px; max-width: 45px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; opacity: 0.7;">Amigo</div>
                            </div>
                            <div id="slotAmigo3" style="text-align: center; display: none;">
                                <div id="plantaAmigo3" style="font-size: 24px; padding: 6px; background: rgba(255, 152, 0, 0.1); border-radius: 10px; display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; border: 2px dashed rgba(255, 152, 0, 0.3); opacity: 0.8;">üå±</div>
                                <div id="nomeAmigo3" style="font-size: 9px; margin-top: 2px; max-width: 45px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; opacity: 0.7;">Amigo</div>
                            </div>
                            <div id="slotAmigo4" style="text-align: center; display: none;">
                                <div id="plantaAmigo4" style="font-size: 24px; padding: 6px; background: rgba(244, 67, 54, 0.1); border-radius: 10px; display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; border: 2px dashed rgba(244, 67, 54, 0.3); opacity: 0.8;">üå±</div>
                                <div id="nomeAmigo4" style="font-size: 9px; margin-top: 2px; max-width: 45px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; opacity: 0.7;">Amigo</div>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
            </div>
            
            <!-- Bot√£o do Timer (canto esquerdo, alinhado ao widget) -->
            <div id="btnTimerFlutuantePJ" onclick="togglePopupTimerPJ()" style="margin-top: 8px; margin-left: 0; width: 60px; height: 60px; background: linear-gradient(135deg, var(--primary), #2e7d32); border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4); z-index: 35500; transition: all 0.3s; font-size: 24px; position: relative;" tabindex="0">
                <span id="timerFlutuanteIcone">‚è±Ô∏è</span>
                <span id="timerFlutuanteTexto" style="display: none; font-size: 14px; font-weight: bold; color: white; font-family: 'Courier New', monospace;">25:00</span>

                <!-- Popup do Timer (p√≠lula, visual modal customizado) -->
                <div id="popupTimerPJ" style="position: absolute; left: 0; top: calc(100% + 2px); background: var(--bg-panel); border-radius: 50px; padding: 36px 36px 36px 36px; box-shadow: 0 20px 60px rgba(0,0,0,0.18); z-index: 40000; display: none; min-width: 220px; max-width: 420px; border: 2px solid rgba(76, 175, 80, 0.18); opacity: 0; transform: translateY(-20px); transition: opacity 0.25s cubic-bezier(.4,1.6,.6,1), transform 0.25s cubic-bezier(.4,1.6,.6,1);">
                    <!-- Seta apontando para baixo -->
                    <div style="position: absolute; bottom: -10px; right: 25px; width: 0; height: 0; border-left: 10px solid transparent; border-right: 10px solid transparent; border-top: 10px solid var(--bg-panel);"></div>

                    <div style="text-align: center;">
                        <div style="font-size: 12px; font-weight: 600; opacity: 0.7; margin-bottom: 10px;">‚è±Ô∏è Timer de Foco</div>

                        <!-- Seletor de Tempo -->
                        <select id="tempoPlantarJuntos" onclick="event.stopPropagation()" style="width: 100%; padding: 8px 12px; border-radius: 10px; border: 2px solid var(--primary); background: var(--bg-panel); font-size: 14px; font-weight: bold; margin-bottom: 12px;">
                        </select>

                        <!-- Timer Display -->
                        <div id="timerPlantarJuntos" style="font-size: 40px; font-weight: bold; font-family: 'Courier New', monospace; color: var(--primary); margin-bottom: 15px;">25:00</div>

                        <!-- Bot√µes -->
                        <div style="display: flex; gap: 8px; justify-content: center; flex-wrap: wrap;">
                            <button id="btnIniciarPlantarJuntos" onclick="event.stopPropagation(); iniciarTimerPlantarJuntos()" style="flex: 1; border-radius: 50px; background: var(--primary); color: white; font-weight: bold; padding: 10px 16px; font-size: 13px; min-width: 80px;">‚ñ∂Ô∏è Iniciar</button>
                            <button id="btnPararPlantarJuntos" onclick="event.stopPropagation(); cancelarTimerPlantarJuntos()" style="flex: 1; border-radius: 50px; background: #f44336; color: white; font-weight: bold; padding: 10px 16px; font-size: 13px; display: none; min-width: 80px;">‚èπÔ∏è Parar</button>
                        </div>

                        <!-- Bot√µes secund√°rios -->
                        <div style="display: flex; gap: 8px; justify-content: center; margin-top: 10px;">
                            <button onclick="event.stopPropagation(); bulldozePJ()" style="border-radius: 50px; background: #ff9800; color: white; font-weight: bold; padding: 8px 14px; font-size: 12px;" title="Limpar jardim">üå™Ô∏è Limpar</button>
                            <button id="btnPipPJ" onclick="togglePipPJ()" style="border-radius: 50px; background: #9c27b0; color: white; font-weight: bold; padding: 8px 14px; font-size: 12px; display: none;" title="Modo PIP">üì∫ PIP</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Grid 3D -->
            <div id="jardimPlantarJuntos3D" style="position: relative; width: 100%; height: 400px; margin: 20px 0; overflow: visible;">
                <div class="scene-3d" style="perspective: 1200px; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
                    <div id="gridPlantarJuntos3D" class="grid-container-3d" style="display: grid; grid-template-columns: repeat(5, 50px); grid-template-rows: repeat(5, 50px); gap: 2px; transform: rotateX(60deg) rotateZ(45deg); transform-style: preserve-3d; background-color: var(--grid-border); padding: 2px;">
                    </div>
                </div>
            </div>
            
            <!-- P√≠lula de Tempo Total do Grupo -->
            <div style="display: flex; justify-content: center; margin-bottom: 15px;">
                <div id="tempoTotalPJPilula" style="background: linear-gradient(135deg, rgba(76, 175, 80, 0.15), rgba(76, 175, 80, 0.05)); border: 1px solid rgba(76, 175, 80, 0.3); border-radius: 20px; padding: 8px 16px; display: inline-flex; align-items: center; gap: 8px;">
                    <span style="font-size: 14px;">üë•</span>
                    <span style="font-size: 12px; opacity: 0.7;">Grupo focou:</span>
                    <span id="tempoTotalPJValor" style="font-size: 14px; font-weight: bold; color: var(--primary); font-family: 'Courier New', monospace;">0min</span>
                </div>
            </div>
        </div>
        
        <!-- Se√ß√£o Conex√£o -->
        <div id="secaoConexaoPJ" style="display: none;">
            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                <!-- Configura√ß√µes -->
                <div style="flex: 1; min-width: 250px;">
                    <h3 style="color: var(--primary); margin-bottom: 15px;">‚öôÔ∏è Configura√ß√µes</h3>
                    <!-- Widget de Conex√£o (expandido) -->
                    <div id="widgetConexaoPJ" style="background: linear-gradient(135deg, rgba(76, 175, 80, 0.1), rgba(76, 175, 80, 0.05)); border: 2px solid rgba(76, 175, 80, 0.3); border-radius: 15px; padding: 12px;">
                        <!-- Header clic√°vel -->
                        <div id="headerWidgetConexao" onclick="toggleWidgetConexaoPJ()" style="display: flex; align-items: center; justify-content: space-between; cursor: pointer; user-select: none;">
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <span style="font-size: 14px;">üîó</span>
                                <span style="font-weight: 600; font-size: 11px;">Conex√£o</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 4px;">
                                <span id="contadorParticipantes" style="background: rgba(76, 175, 80, 0.2); padding: 2px 6px; border-radius: 8px; font-size: 10px; font-weight: bold;">1</span>
                                <span id="setaWidgetConexao" style="transition: transform 0.3s; font-size: 10px;">‚ñº</span>
                            </div>
                        </div>
                        
                        <!-- Status -->
                        <div id="statusConexaoIcone" style="font-size: 9px; color: #888; margin-top: 6px; text-align: center;">‚ö™ Offline</div>
                        
                        <!-- Conte√∫do expand√≠vel -->
                        <div id="conteudoWidgetConexao" style="display: none; margin-top: 10px; padding-top: 10px; border-top: 1px dashed rgba(76, 175, 80, 0.3);">
                            <!-- Se√ß√£o Criar Sala (oculta at√© clicar em gerar) -->
                            <div id="secaoCodigoSalaPJ" style="text-align: center; margin-bottom: 10px; display: none;">
                                <div style="font-size: 10px; opacity: 0.8; margin-bottom: 5px; font-weight: 600;">üîó Seu C√≥digo</div>
                                <div id="codigoSalaPJ" onclick="copiarCodigoSala(); event.stopPropagation();" style="font-size: 20px; font-weight: bold; font-family: 'Courier New', monospace; background: rgba(255,255,255,0.9); padding: 8px 12px; border-radius: 10px; display: inline-block; cursor: pointer; letter-spacing: 3px; color: #2e7d32; box-shadow: 0 2px 6px rgba(0,0,0,0.1); transition: all 0.2s;" title="Clique para copiar">----</div>
                                <div style="font-size: 9px; opacity: 0.6; margin-top: 4px;">Clique para copiar!</div>
                                <button onclick="gerarNovoCodigo(); event.stopPropagation();" style="margin-top: 8px; padding: 6px 12px; background: #ff9800; color: white; border: none; border-radius: 8px; font-size: 10px; font-weight: bold; cursor: pointer;">üîÑ Gerar Novo C√≥digo</button>
                            </div>
                            
                            <!-- Toggle de permiss√£o de bulldoze (s√≥ para host) -->
                            <div id="togglePermissaoBulldozePJ" style="display: none; align-items: center; justify-content: space-between; padding: 8px; background: rgba(255, 152, 0, 0.1); border-radius: 10px; margin-bottom: 6px; font-size: 10px;" onclick="event.stopPropagation();">
                                <span style="display: flex; align-items: center; gap: 4px;">
                                    <span>üå™Ô∏è</span>
                                    <span>Convidados podem limpar</span>
                                </span>
                                <label style="position: relative; display: inline-block; width: 36px; height: 20px; cursor: pointer;">
                                    <input type="checkbox" id="checkPermissaoBulldozePJ" onchange="togglePermissaoBulldozePJ()" style="opacity: 0; width: 0; height: 0;">
                                    <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: 0.3s; border-radius: 20px;"></span>
                                    <span id="sliderBulldozePJ" style="position: absolute; content: ''; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: 0.3s; border-radius: 50%;"></span>
                                </label>
                            </div>
                            
                            <!-- Toggle de chat mutado (s√≥ para host) -->
                            <div id="toggleChatMutadoPJ" style="display: none; align-items: center; justify-content: space-between; padding: 8px; background: rgba(244, 67, 54, 0.1); border-radius: 10px; margin-bottom: 6px; font-size: 10px;" onclick="event.stopPropagation();">
                                <span style="display: flex; align-items: center; gap: 4px;">
                                    <span>üîá</span>
                                    <span>Silenciar chat</span>
                                </span>
                                <label style="position: relative; display: inline-block; width: 36px; height: 20px; cursor: pointer;">
                                    <input type="checkbox" id="checkChatMutadoPJ" onchange="toggleChatMutadoPJ()" style="opacity: 0; width: 0; height: 0;">
                                    <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: 0.3s; border-radius: 20px;"></span>
                                    <span id="sliderChatMutadoPJ" style="position: absolute; content: ''; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: 0.3s; border-radius: 50%;"></span>
                                </label>
                            </div>
                            
                            <!-- Toggle de aprovar entrada (s√≥ para host) -->
                            <div id="toggleAprovarEntradaPJ" style="display: none; align-items: center; justify-content: space-between; padding: 8px; background: rgba(33, 150, 243, 0.1); border-radius: 10px; margin-bottom: 6px; font-size: 10px;" onclick="event.stopPropagation();">
                                <span style="display: flex; align-items: center; gap: 4px;">
                                    <span>üö™</span>
                                    <span>Aprovar entradas</span>
                                </span>
                                <label style="position: relative; display: inline-block; width: 36px; height: 20px; cursor: pointer;">
                                    <input type="checkbox" id="checkAprovarEntradaPJ" onchange="toggleAprovarEntradaPJ()" style="opacity: 0; width: 0; height: 0;">
                                    <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: 0.3s; border-radius: 20px;"></span>
                                    <span id="sliderAprovarEntradaPJ" style="position: absolute; content: ''; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: 0.3s; border-radius: 50%;"></span>
                                </label>
                            </div>
                            
                            <!-- Container de solicita√ß√µes pendentes -->
                            <div id="solicitacoesPendentesPJ" style="display: none; background: rgba(255, 193, 7, 0.15); border-radius: 10px; padding: 8px; margin-bottom: 10px; font-size: 10px;" onclick="event.stopPropagation();">
                                <div style="display: flex; align-items: center; gap: 4px; margin-bottom: 6px; font-weight: 600;">
                                    <span>‚è≥</span>
                                    <span>Aguardando aprova√ß√£o</span>
                                </div>
                                <div id="listaSolicitacoesPJ" style="display: flex; flex-direction: column; gap: 4px;"></div>
                            </div>
                            
                            <!-- Bot√£o para gerar c√≥digo (vis√≠vel quando n√£o tem c√≥digo) -->
                            <div id="btnGerarCodigoContainer" style="text-align: center; margin-bottom: 10px;">
                                <div style="font-size: 10px; opacity: 0.7; margin-bottom: 8px;">Crie uma sala para convidar amigos</div>
                                <button onclick="gerarEMostrarCodigo(); event.stopPropagation();" style="padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 10px; font-size: 12px; font-weight: bold; cursor: pointer;">üè† Criar Sala</button>
                            </div>
                            
                            <div style="border-top: 1px dashed rgba(76, 175, 80, 0.3); padding-top: 10px; margin-top: 10px;">
                                <div style="font-size: 10px; opacity: 0.8; margin-bottom: 6px; font-weight: 600; text-align: center;">ü§ù Entrar</div>
                                <input type="text" id="inputCodigoAmigo" placeholder="ABCD" maxlength="4" style="width: 100%; padding: 8px; border-radius: 10px; border: 2px solid rgba(76, 175, 80, 0.3); background: var(--bg-panel); font-size: 14px; font-weight: bold; font-family: 'Courier New', monospace; text-align: center; letter-spacing: 2px; text-transform: uppercase; box-sizing: border-box;" oninput="this.value = this.value.toUpperCase()" onclick="event.stopPropagation()">
                                <button onclick="conectarSalaPJ(); event.stopPropagation();" style="width: 100%; margin-top: 6px; padding: 8px; background: var(--primary); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 11px;">Conectar</button>
                                <div id="statusConexaoPJ" style="font-size: 10px; margin-top: 6px; text-align: center; min-height: 14px;"></div>
                                <div id="btnReconectarContainer" style="display: none; margin-top: 8px; text-align: center;">
                                    <button onclick="reconectarManualPJ(); event.stopPropagation();" style="padding: 6px 12px; background: #ff9800; color: white; border: none; border-radius: 8px; font-size: 10px; font-weight: bold; cursor: pointer;">üîÑ Reconectar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Bot√£o de reconex√£o manual sempre vis√≠vel -->
                    <div style="margin-top: 15px; text-align: center;">
                        <button onclick="verificarReconexaoPJ(); atualizarStatusConexao('üîç Verificando conex√µes...'); event.stopPropagation();" style="padding: 8px 16px; background: #2196f3; color: white; border: none; border-radius: 10px; font-size: 11px; font-weight: bold; cursor: pointer;">üîç Verificar Conex√£o</button>
                    </div>
                </div>
                
                <!-- Lista de Amigos -->
                <div style="flex: 1; min-width: 250px;">
                    <h3 style="color: var(--primary); margin-bottom: 15px;">üë• Lista de Amigos</h3>
                    <!-- Lista de Participantes -->
                    <div id="listaParticipantesPJ" style="background: linear-gradient(135deg, rgba(76, 175, 80, 0.1), rgba(76, 175, 80, 0.05)); border: 2px solid rgba(76, 175, 80, 0.3); border-radius: 15px; padding: 12px;">
                        <div id="participantesContainer" style="display: flex; flex-wrap: wrap; gap: 4px; justify-content: center;">
                            <div style="background: rgba(76, 175, 80, 0.15); padding: 3px 8px; border-radius: 10px; font-size: 10px; display: flex; align-items: center; gap: 3px;">
                                <span>üë§</span>
                                <span>Voc√™</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Se√ß√£o Chat -->
        <div id="secaoChatPJ" style="display: none;">
            <!-- Chat (2/3) -->
            <div id="chatContainerPJ" style="flex: 2; min-width: 200px; background: rgba(76, 175, 80, 0.05); border: 1px solid rgba(76, 175, 80, 0.2); border-radius: 15px; padding: 12px; display: flex; flex-direction: column;">
                <!-- Header do Chat com toggle -->
                <div onclick="toggleChatPJ()" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; cursor: pointer;">
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <span style="font-size: 11px; font-weight: 600; opacity: 0.7;">üí¨ Chat</span>
                        <span id="chatBadgePJ" style="background: var(--primary); color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; display: none;">0</span>
                    </div>
                    <span id="setaChatPJ" style="font-size: 10px; transition: transform 0.3s;">‚ñº</span>
                </div>
                
                <!-- √öltima mensagem (vis√≠vel quando chat est√° oculto) -->
                <div id="ultimaMensagemPJ" style="display: none; background: var(--bg-panel); border-radius: 10px; padding: 8px; font-size: 10px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; opacity: 0.8; cursor: pointer;" onclick="toggleChatPJ()">
                    <span style="opacity: 0.6;">Sem mensagens...</span>
                </div>
                
                <!-- Conte√∫do do chat -->
                <div id="conteudoChatPJ">
                    <div id="chatMensagensPJ" style="flex: 1; min-height: 80px; max-height: 120px; overflow-y: auto; background: var(--bg-panel); border-radius: 10px; padding: 8px; margin-bottom: 8px; font-size: 11px;">
                        <div style="color: var(--text-secondary); opacity: 0.6; text-align: center; padding: 20px 0; font-size: 10px;">Sem mensagens...</div>
                    </div>
                    <div style="display: flex; gap: 6px;">
                        <input type="text" id="inputChatPJ" placeholder="Mensagem..." maxlength="200" style="flex: 1; padding: 6px 10px; border-radius: 15px; border: 1px solid rgba(76, 175, 80, 0.3); background: var(--bg-panel); font-size: 11px;" onkeypress="if(event.key==='Enter') enviarMensagemChatPJ()" oninput="notificarDigitando()">
                        <button onclick="enviarMensagemChatPJ()" style="border-radius: 50%; width: 30px; height: 30px; background: var(--primary); color: white; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px;">üì§</button>
                    </div>
                </div>
            </div>
        </div>
        
        <button onclick="fecharModal('plantarJuntosOverlay')" class="secundario" style="width:100%; margin-top:15px; border-radius: 50px;">Fechar</button>
    </div>
</div>

<!-- Modal de Sele√ß√£o de Plantas Plantar Juntos -->
<div id="menuPlantasPJOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 36000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(10px);">
    <div style="background: var(--bg-panel); width: 95%; max-width: 500px; max-height: 80vh; border-radius: 28px; padding: 30px; overflow-y: auto; position: relative; box-shadow: 0 20px 50px rgba(0,0,0,0.5);">
        <span class="btn-fechar-modal" onclick="fecharModal('menuPlantasPJOverlay')">‚úñ</span>
        <h2 style="color: var(--primary); margin-top: 0;">üå± Escolha sua Planta</h2>
        <div id="gridPlantasPJ" class="loja-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 10px; margin-top: 20px;">
        </div>
        <button onclick="fecharModal('menuPlantasPJOverlay')" class="secundario" style="width:100%; margin-top:20px; border-radius: 50px;">Fechar</button>
    </div>
</div>

<!-- Modal de Confirma√ß√£o para Novo C√≥digo -->
<div id="confirmacaoResetCodigoOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 37000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(10px);">
    <div id="confirmacaoResetCodigoContent" style="background: var(--bg-panel); width: 90%; max-width: 400px; border-radius: 28px; padding: 30px; text-align: center; border: 1px solid rgba(255,152,0,0.3); box-shadow: 0 10px 40px rgba(0,0,0,0.5);">
        <div style="font-size: 50px; margin-bottom: 15px;">üîÑ</div>
        <h3 style="color: #ff9800; margin-bottom: 15px;">Gerar Novo C√≥digo?</h3>
        <p style="color: var(--text-secondary); margin-bottom: 25px; line-height: 1.5;">
            Isso ir√° desconectar todos os seus amigos atuais e criar uma sala nova com um c√≥digo diferente.
        </p>
        <div style="display: flex; gap: 10px;">
            <button onclick="fecharEGerarNovoCodigo()" style="flex: 1; padding: 12px; background: #ff9800; color: white; border: none; border-radius: 12px; font-weight: bold; cursor: pointer;">
                Sim, Gerar
            </button>
            <button onclick="fecharModal('confirmacaoResetCodigoOverlay')" style="flex: 1; padding: 12px; background: rgba(0,0,0,0.2); color: var(--text-main); border: none; border-radius: 12px; font-weight: bold; cursor: pointer;">
                Cancelar
            </button>
        </div>
    </div>
</div>

</body>
</html>

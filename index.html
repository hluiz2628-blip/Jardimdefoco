<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Garden Focus üå±</title>
    
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#4caf50">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="https://www.iconpacks.net/icons/2/free-tree-icon-1578-thumb.png">
<style>
    /* Estilo para o status de atualiza√ß√£o */
#atualizacaoStatus button:hover {
    background: #388e3c !important;
    transform: translateY(-1px);
}

#atualizacaoStatus button:active {
    transform: translateY(0);
}
    /* Estilo do bot√£o bulldoze */
#btnBulldoze {
    background: #ff9800 !important;
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 20px;
    padding: 10px;
    cursor: pointer;
    transition: all 0.2s;
}

#btnBulldoze:hover {
    background: #f57c00 !important;
    transform: translateY(-2px);
}

#btnBulldoze:active {
    transform: translateY(0);
}

/* Anima√ß√£o do tornado 2D */
.tornado-2d {
    position: absolute;
    font-size: 30px;
    z-index: 10;
    pointer-events: none;
    animation: tornadoMove 0.5s linear forwards;
}

@keyframes tornadoMove {
    0% { transform: translateY(0) rotate(0deg); opacity: 0.5; }
    50% { transform: translateY(-20px) rotate(180deg); opacity: 1; }
    100% { transform: translateY(-40px) rotate(360deg); opacity: 0; }
}

/* Anima√ß√£o do tornado 3D */
.tornado-3d {
    position: absolute;
    font-size: calc(var(--cell-3d-size) * 0.6);
    z-index: 20;
    pointer-events: none;
    transform: rotateZ(-45deg) rotateX(-90deg) translateY(calc(var(--cell-3d-size) * -0.46)) scaleY(1);
    animation: tornadoMove3D 0.5s linear forwards;
}

@keyframes tornadoMove3D {
    0% { transform: rotateZ(-45deg) translateY(calc(var(--cell-3d-size) * -0.46)) scaleY(1) rotate(0deg); opacity: 0.5; }
    50% { transform: rotateZ(-45deg) rotateX(-90deg) translateY(calc(var(--cell-3d-size) * -0.56)) scaleY(1.2); opacity: 1; }
    100% { transform: rotateZ(-45deg) rotateX(-90deg) translateY(calc(var(--cell-3d-size) * -0.66)) scaleY(1.4); opacity: 0; }
}
    /* Estilos para Metas */
#btnMetasToggle.ativo {
    border-radius: 18px 18px 0 0;
    box-shadow: none;
    background: #ff9800 !important;
}

#metasContainer {
    background: var(--bg-panel);
    border-radius: 0 0 18px 18px;
    border: 1px solid #ff9800;
    border-top: none;
    padding: 12px;
    display: none;
    flex-direction: column;
    margin-top: -12px;
    max-height: 400px;
    overflow-y: auto;
    box-shadow: 0 10px 20px rgba(0,0,0,0.1);
}

#metasContainer.ativo {
    display: flex;
    animation: expandDown 0.3s ease-out;
}

#metaMotivo, #metaTempo {
    border-radius: 8px;
    border: 1px solid rgba(0,0,0,0.1);
    background: var(--bg-panel);
    color: var(--text-main);
    padding: 5px;
    font-size: 11px;
}
/* =========================
   VARI√ÅVEIS E TEMAS
   ========================= */
:root {
    --bg-body: #f0f7f2;
    --bg-panel: white;
    --text-main: #333;
    --text-secondary: #666;
    --primary: #4caf50;
    --accent: #ffd54f;
    --plot-empty: #daeedb;
    --shadow: rgba(0,0,0,0.05);
    /* VARI√ÅVEIS 3D */
    --grid-color: #8cc63f;
    --grid-border: #7db336;
    --side-color: #8d6e63;
    --bottom-color: #5d4037;
    --cell-3d-size: 75px;
    --scale-3d: 1; /* Nova vari√°vel para escala */
}

body.natal-mode {
    --bg-body: #fdfdfd;
    --bg-panel: #ffffff;
    --text-main: #2c3e50;
    --primary: #c62828;
    --accent: #ffd700;
    --plot-empty: #f5f5f5;
    /* 3D NATAL */
    --grid-color: #e8f5e9;
    --grid-border: #c8e6c9;
    --side-color: #d7ccc8;
    --bottom-color: #bcaaa4;
}

body.medieval-mode {
    --bg-body: #3e2723;
    --bg-panel: #5d4037;
    --text-main: #fff8e1;
    --text-secondary: #ffccbc;
    --primary: #8d6e63;
    --accent: #ffb74d;
    --plot-empty: #4e342e;
    --shadow: rgba(0,0,0,0.4);
    /* 3D MEDIEVAL */
    --grid-color: #5d4037;
    --grid-border: #4e342e;
    --side-color: #3e2723;
    --bottom-color: #2d1a1a;
    background-image: url('https://www.transparenttextures.com/patterns/wood-pattern.png');
}

body.dark-mode {
    --bg-body: #1a1d1a;
    --bg-panel: #2d322d;
    --text-main: #e0e0e0;
    --text-secondary: #aaa;
    --primary: #81c784;
    --accent: #ffd54f;
    --plot-empty: #3d453d;
    --shadow: rgba(0,0,0,0.3);
    /* 3D DARK MODE - mant√©m cores do modo claro */
    --grid-color: #8cc63f;
    --grid-border: #7db336;
    --side-color: #8d6e63;
    --bottom-color: #5d4037;
}

body.dark-mode.natal-mode {
    --bg-body: #1a0f0f;
    --bg-panel: #2d1a1a;
    --text-main: #f8f8f8;
    --primary: #e53935;
    --accent: #ffb300;
    --plot-empty: #3d2525;
    /* 3D DARK NATAL - mant√©m cores do modo claro natal */
    --grid-color: #e8f5e9;
    --grid-border: #c8e6c9;
    --side-color: #d7ccc8;
    --bottom-color: #bcaaa4;
}

body.dark-mode.medieval-mode {
    --bg-body: #1a0f0a;
    --bg-panel: #2d1a15;
    --text-main: #f8f8f8;
    --text-secondary: #ffccbc;
    --primary: #8d6e63;
    --accent: #ffb74d;
    --plot-empty: #3d2520;
    --shadow: rgba(0,0,0,0.5);
    /* 3D MEDIEVAL NOTURNO - mant√©m cores do modo medieval claro */
    --grid-color: #5d4037;
    --grid-border: #4e342e;
    --side-color: #3e2723;
    --bottom-color: #2d1a1a;
    background-image: url('https://www.transparenttextures.com/patterns/wood-pattern.png');
}

/* NOVO: Modo Candyfornia - Mundo de Doces Fofo */
body.candyfornia-mode {
    --bg-body: #fff5f7; /* Rosa muito clarinho */
    --bg-panel: #ffffff; /* Branco puro */
    --text-main: #8a4b76; /* Roxo rosado suave */
    --text-secondary: #c97aa0; /* Rosa m√©dio */
    --primary: #ff85a2; /* Rosa fofo */
    --accent: #ffd166; /* Amarelo pastel */
    --plot-empty: #ffe8f0; /* Rosa muito clarinho */
    --shadow: rgba(255, 133, 162, 0.1);
    /* 3D CANDYFORNIA */
    --grid-color: #ffccd5; /* Rosa beb√™ */
    --grid-border: #ffb3c6; /* Rosa mais forte */
    --side-color: #ffafcc; /* Rosa algod√£o doce */
    --bottom-color: #ff8fab; /* Rosa m√©dio */
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="10" cy="10" r="3" fill="%23ffafcc" opacity="0.6"/><circle cx="30" cy="25" r="4" fill="%23ffd166" opacity="0.6"/><circle cx="70" cy="15" r="3" fill="%23ff8fab" opacity="0.6"/><circle cx="85" cy="40" r="3" fill="%23ffafcc" opacity="0.6"/><circle cx="20" cy="60" r="4" fill="%23ffd166" opacity="0.6"/><circle cx="50" cy="80" r="3" fill="%23ff8fab" opacity="0.6"/></svg>');
}

body.dark-mode.candyfornia-mode {
    --bg-body: #3a2432; /* Roxo escuro rosado */
    --bg-panel: #4a2e3f; /* Roxo m√©dio */
    --text-main: #ffcce0; /* Rosa claro */
    --text-secondary: #ff99c8; /* Rosa m√©dio */
    --primary: #ff85a2; /* Rosa fofo (mesmo do modo claro) */
    --accent: #ffd166; /* Amarelo pastel (mesmo) */
    --plot-empty: #5a3a4a; /* Roxo escuro */
    --shadow: rgba(255, 133, 162, 0.2);
    /* 3D CANDYFORNIA NOTURNO */
    --grid-color: #ff8fab; /* Rosa */
    --grid-border: #ff7096; /* Rosa mais forte */
    --side-color: #ffafcc; /* Rosa claro */
    --bottom-color: #e75480; /* Rosa escuro */
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="10" cy="10" r="3" fill="%23ff7096" opacity="0.3"/><circle cx="30" cy="25" r="4" fill="%23ffd166" opacity="0.3"/><circle cx="70" cy="15" r="3" fill="%23ff85a2" opacity="0.3"/><circle cx="85" cy="40" r="3" fill="%23ff7096" opacity="0.3"/><circle cx="20" cy="60" r="4" fill="%23ffd166" opacity="0.3"/><circle cx="50" cy="80" r="3" fill="%23ff85a2" opacity="0.3"/></svg>');
}

/* CORRE√á√ÉO: Estilo espec√≠fico para modo Candyfornia 3D */
body.candyfornia-mode .cell-3d {
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 40 40"><path d="M5 35 L10 30 L15 35 Z" fill="%23ffb3c6" opacity="0.7"/><path d="M25 15 L30 10 L35 15 Z" fill="%23ffb3c6" opacity="0.7"/><circle cx="20" cy="20" r="4" fill="%23ffd166" opacity="0.5"/></svg>');
}

/* BOT√ïES LATERAIS ESPECIAIS PARA MODO CANDYFORNIA */
body.candyfornia-mode #abaEsquerda button {
    background: linear-gradient(135deg, #ff9ebb, #ff85a2);
    color: white;
    border: none;
    box-shadow: 0 3px 10px rgba(255, 133, 162, 0.3);
    transition: all 0.3s ease;
}

body.candyfornia-mode #abaEsquerda button:hover {
    background: linear-gradient(135deg, #ff85a2, #ff6b8b);
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(255, 133, 162, 0.4);
}

body.candyfornia-mode #abaEsquerda button:active {
    transform: translateY(0);
    box-shadow: 0 2px 5px rgba(255, 133, 162, 0.3);
}

/* BOT√ïES ESPEC√çFICOS DO MENU */
body.candyfornia-mode #btnTodoToggle {
    background: linear-gradient(135deg, #a2e1db, #8bd3cc) !important;
    color: #333 !important;
}

body.candyfornia-mode #btnMetasToggle {
    background: linear-gradient(135deg, #ffd166, #ffc145) !important;
    color: #333 !important;
}

body.candyfornia-mode #btnTrocarSom {
    background: linear-gradient(135deg, #c97aa0, #b5698f) !important;
    color: white !important;
}

/* BOT√ïES DE CONFIGURA√á√ÉO (OPCIONAL - se quiser mais consistente) */
body.candyfornia-mode .config-card h4 {
    color: #8a4b76;
}

body.candyfornia-mode .ios-switch.on {
    background-color: #ff85a2 !important;
}

/* BOT√ïES DO PAINEL DE CONTROLE (TIMER) */
body.candyfornia-mode .painel-controle button {
    background: linear-gradient(135deg, #ff85a2, #ff6b8b);
    color: white;
}

body.candyfornia-mode .painel-controle button.secundario {
    background: #ffe8f0 !important;
    color: #8a4b76 !important;
    border: 1px solid #ffb3c6 !important;
}

body.candyfornia-mode .painel-controle button.cancelar {
    background: linear-gradient(135deg, #ff6b6b, #ff5252) !important;
    color: white !important;
}

/* BOT√ïES DE MODAL */
body.candyfornia-mode .modal-prateleira .item {
    background: #ffe8f0;
    border: 2px solid #ffccd5;
}

body.candyfornia-mode .modal-prateleira .item:hover {
    background: #ffccd5;
    border-color: #ff85a2;
}

body.candyfornia-mode .modal-prateleira .item.selecionado {
    background: #ffccd5;
    border-color: #ff85a2;
    box-shadow: 0 0 10px rgba(255, 133, 162, 0.5);
}

/* BOT√ïES DA LOJA */
body.candyfornia-mode .item-loja button {
    background: linear-gradient(135deg, #ffd166, #ffc145) !important;
    color: #333 !important;
    font-weight: bold;
}

/* BOT√ïES DO DASHBOARD */
body.candyfornia-mode .dashboard-periodo button {
    background: #ffe8f0;
    color: #8a4b76;
    border: 1px solid #ffb3c6;
}

body.candyfornia-mode .dashboard-periodo button.active {
    background: linear-gradient(135deg, #ff85a2, #ff6b8b);
    color: white;
    border: none;
}

/* BOT√ïES ESPECIAIS */
body.candyfornia-mode #streakBadge {
    background: linear-gradient(135deg, #ffd166, #ffc145);
    color: #333;
    box-shadow: 0 3px 8px rgba(255, 209, 102, 0.3);
}

body.candyfornia-mode #luckyPlantTag {
    background: linear-gradient(135deg, #a2e1db, #8bd3cc);
    color: #333;
}

/* BOT√ïES SUPERIORES (MENU E TEMA) */
body.candyfornia-mode #abrirMenuBtn {
    background: linear-gradient(135deg, #ff85a2, #ff6b8b);
    color: white;
    box-shadow: 0 3px 8px rgba(255, 133, 162, 0.3);
}

body.candyfornia-mode #btnTema {
    background: #ffffff;
    color: #8a4b76;
    border: 1px solid #ffb3c6;
    box-shadow: 0 3px 8px rgba(255, 133, 162, 0.2);
}

body.candyfornia-mode #btnTema:hover {
    background: #ffe8f0;
}

/* BOT√ïES DO DEEP FOCUS */
body.candyfornia-mode .deep-focus-controls button {
    background: rgba(255, 133, 162, 0.2);
    color: #8a4b76;
    border: 1px solid #ffb3c6;
}

body.candyfornia-mode .deep-focus-controls button:hover {
    background: rgba(255, 133, 162, 0.3);
}

/* TODO LIST E METAS */
body.candyfornia-mode .todo-item {
    background: #ffe8f0;
    border-color: #ffccd5;
}

body.candyfornia-mode .todo-item input[type="checkbox"]:checked + span {
    color: #ff85a2;
}

/* PLOTS NO JARDIM */
body.candyfornia-mode .plot {
    background: #ffe8f0;
    border: 1px solid #ffccd5;
}

body.candyfornia-mode .plot:hover {
    background: #ffccd5;
    border-color: #ff85a2;
}

body.candyfornia-mode .plot.alvo {
    outline-color: #ff85a2;
}

/* C√âLULAS 3D */
body.candyfornia-mode .cell-3d {
    border: 1px solid #ffb3c6;
}

body.candyfornia-mode .cell-3d:hover {
    background-color: #ffccd5;
    border-color: #ff85a2;
}

/* BOT√ïES LATERAIS ROSINHAS - VERS√ÉO SIMPLES */
body.candyfornia-mode #abaEsquerda button {
    background: #ff9ebb;
    color: white;
    border: none;
    box-shadow: 0 3px 8px rgba(255, 158, 187, 0.3);
}

body.candyfornia-mode #abaEsquerda button:hover {
    background: #ff85a2;
    transform: translateY(-2px);
    box-shadow: 0 5px 12px rgba(255, 133, 162, 0.4);
}

/* BOT√ïES ESPECIAIS DO MENU */
body.candyfornia-mode #btnTodoToggle {
    background: #a2e1db !important;
    color: #333 !important;
}

body.candyfornia-mode #btnMetasToggle {
    background: #ffd166 !important;
    color: #333 !important;
}

body.candyfornia-mode #btnTrocarSom {
    background: #c97aa0 !important;
    color: white !important;
}

/* CORRE√á√ÉO ESPEC√çFICA PARA BOT√ïES LATERAIS NO MODO CANDYFORNIA */

/* 1. BOT√ïES DO MENU LATERAL - SOBRESCREVER TODOS OS ESTILOS */
body.candyfornia-mode #abaEsquerda button:not(#btnTodoToggle):not(#btnMetasToggle):not(#btnTrocarSom) {
    background: linear-gradient(135deg, #ff9ebb, #ff85a2) !important;
    color: white !important;
    border: none !important;
    box-shadow: 0 3px 10px rgba(255, 133, 162, 0.3) !important;
}

body.candyfornia-mode #abaEsquerda button:not(#btnTodoToggle):not(#btnMetasToggle):not(#btnTrocarSom):hover {
    background: linear-gradient(135deg, #ff85a2, #ff6b8b) !important;
    transform: translateY(-3px) !important;
    box-shadow: 0 5px 15px rgba(255, 133, 162, 0.4) !important;
}

/* 2. BOT√ïES ESPEC√çFICOS COM CORES DIFERENTES */
body.candyfornia-mode #btnTodoToggle {
    background: linear-gradient(135deg, #a2e1db, #8bd3cc) !important;
    color: #333 !important;
    border: none !important;
}

body.candyfornia-mode #btnMetasToggle {
    background: linear-gradient(135deg, #ffd166, #ffc145) !important;
    color: #333 !important;
    border: none !important;
}

body.candyfornia-mode #btnTrocarSom {
    background: linear-gradient(135deg, #c97aa0, #b5698f) !important;
    color: white !important;
    border: none !important;
}

/* 3. REMOVER BORDAS E FUNDOS HERDADOS */
body.candyfornia-mode #abaEsquerda button.secundario {
    background: linear-gradient(135deg, #ff9ebb, #ff85a2) !important;
    color: white !important;
    border: none !important;
}

/* 4. SE OS BOT√ïES AINDA N√ÉO FICAREM ROSAS, ADICIONE ESTE BLOCO MAIS ESPEC√çFICO */
body.candyfornia-mode #abaEsquerda button[onclick*="abrirLoja"],
body.candyfornia-mode #abaEsquerda button[onclick*="abrirDashboard"],
body.candyfornia-mode #abaEsquerda button[onclick*="abrirEstante"],
body.candyfornia-mode #abaEsquerda button[onclick*="abrirConfig"] {
    background: linear-gradient(135deg, #ff9ebb, #ff85a2) !important;
    color: white !important;
    border: none !important;
    box-shadow: 0 3px 10px rgba(255, 133, 162, 0.3) !important;
}

/* 5. BOT√ïES QUANDO ATIVOS/EXPANDIDOS */
body.candyfornia-mode #btnTodoToggle.ativo {
    background: linear-gradient(135deg, #8bd3cc, #74c5be) !important;
}

body.candyfornia-mode #btnMetasToggle.ativo {
    background: linear-gradient(135deg, #ffc145, #ffb52d) !important;
}


/* =========================
   PAINEL DE INTELIG√äNCIA NO MODO CANDYFORNIA
   ========================= */

/* Cor de fundo e borda azul para o painel */
body.candyfornia-mode #painelInteligencia {
    background: linear-gradient(135deg, rgba(162, 225, 219, 0.25), rgba(135, 206, 250, 0.2)) !important;
    border: 1px solid #a2e1db !important;
    color: #2c5282 !important;
    box-shadow: 0 3px 10px rgba(162, 225, 219, 0.25);
    transition: all 0.3s ease;
}

/* Efeito hover suave */
body.candyfornia-mode #painelInteligencia:hover {
    background: linear-gradient(135deg, rgba(162, 225, 219, 0.35), rgba(135, 206, 250, 0.3)) !important;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(162, 225, 219, 0.35);
}

/* Cores din√¢micas baseadas na probabilidade - ALTA (acima de 70%) */
body.candyfornia-mode #painelInteligencia[style*="border-color:#4caf50"],
body.candyfornia-mode #painelInteligencia[style*="color:#4caf50"] {
    background: linear-gradient(135deg, rgba(102, 204, 255, 0.25), rgba(102, 255, 204, 0.2)) !important;
    border: 1px solid #66ccff !important;
    color: #0066cc !important;
    box-shadow: 0 3px 10px rgba(102, 204, 255, 0.25);
}

/* Cores din√¢micas - M√âDIA (40-70%) */
body.candyfornia-mode #painelInteligencia[style*="border-color:#ffb74d"],
body.candyfornia-mode #painelInteligencia[style*="color:#ffb74d"] {
    background: linear-gradient(135deg, rgba(255, 204, 102, 0.25), rgba(255, 229, 153, 0.2)) !important;
    border: 1px solid #ffcc66 !important;
    color: #cc9900 !important;
    box-shadow: 0 3px 10px rgba(255, 204, 102, 0.25);
}

/* Cores din√¢micas - BAIXA (abaixo de 40%) */
body.candyfornia-mode #painelInteligencia[style*="border-color:#e57373"],
body.candyfornia-mode #painelInteligencia[style*="color:#e57373"] {
    background: linear-gradient(135deg, rgba(255, 153, 153, 0.25), rgba(255, 204, 204, 0.2)) !important;
    border: 1px solid #ff9999 !important;
    color: #cc6666 !important;
    box-shadow: 0 3px 10px rgba(255, 153, 153, 0.25);
}

/* Estilo do texto dentro do painel */
body.candyfornia-mode #painelInteligencia strong {
    color: #2c5282;
    font-weight: 700;
}

body.candyfornia-mode #painelInteligencia small {
    color: #4a5568;
    opacity: 0.9;
}

/* Cor espec√≠fica para a tag de probabilidade */
body.candyfornia-mode #painelInteligencia .probabilidade-alta {
    color: #0066cc !important;
}

body.candyfornia-mode #painelInteligencia .probabilidade-media {
    color: #cc9900 !important;
}

body.candyfornia-mode #painelInteligencia .probabilidade-baixa {
    color: #cc6666 !important;
}

/* Anima√ß√£o sutil para quando o painel √© atualizado */
@keyframes candyfornia-painel-pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.02); }
    100% { transform: scale(1); }
}

body.candyfornia-mode #painelInteligencia.atualizado {
    animation: candyfornia-painel-pulse 0.5s ease;
}

/* Responsividade para mobile no modo Candyfornia */
@media (max-width: 899px) {
    body.candyfornia-mode #painelInteligencia {
        margin: 8px auto;
        padding: 10px;
        font-size: 10px;
        border-radius: 12px;
    }
    
    body.candyfornia-mode #painelInteligencia strong {
        font-size: 11px;
    }
}

/* Efeito de brilho para destaque */
body.candyfornia-mode #painelInteligencia.destaque {
    position: relative;
    overflow: hidden;
}

body.candyfornia-mode #painelInteligencia.destaque::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(
        45deg,
        transparent,
        rgba(255, 255, 255, 0.1),
        transparent
    );
    transform: rotate(45deg);
    animation: candyfornia-brilho 3s infinite;
}

@keyframes candyfornia-brilho {
    0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
    100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
}



/* NOVO: Estilos para modo 10x10 */
body.grid-10x10 #jardim {
    grid-template-columns: repeat(10, 35px) !important;
    gap: 5px !important;
}

body.grid-10x10 .plot {
    width: 35px !important;
    height: 35px !important;
    border-radius: 8px !important;
    font-size: 18px !important;
}


/* Ajustes para 3D 10x10 */
body.grid-10x10 .cell-3d {
    width: 40px !important;
    height: 40px !important;
}

/* Ajuste de altura para 3D 10x10 */
body.grid-10x10 #jardim3D {
    height: 500px !important;
}

/* Ajustes responsivos para mobile 10x10 */
@media (max-width: 899px) {
    body.grid-10x10 #jardim {
        grid-template-columns: repeat(10, 28px) !important;
        gap: 3px !important;
    }
    
    body.grid-10x10 .plot {
        width: 28px !important;
        height: 28px !important;
        font-size: 14px !important;
    }
    
    body.grid-10x10 #jardim3D {
        height: 400px !important;
    }
    
    body.grid-10x10 .cell-3d {
        width: 32px !important;
        height: 32px !important;
    }
    
    body.grid-10x10 .emoji-3d {
        transform: rotateZ(-45deg) rotateX(-90deg) translateY(calc(var(--cell-3d-size) * -0.46)) scaleY(1) !important;
    }
}

/* Desktop 10x10 */
@media (min-width: 900px) {
    body.grid-10x10 #jardim {
        grid-template-columns: repeat(10, 40px) !important;
        gap: 8px !important;
    }
    
    body.grid-10x10 .plot {
        width: 40px !important;
        height: 40px !important;
        font-size: 20px !important;
    }
    
    body.grid-10x10 #jardim3D {
        height: 550px !important;
    }
    
    body.grid-10x10 .cell-3d {
        width: 45px !important;
        height: 45px !important;
    }
    
    body.grid-10x10 .emoji-3d {
        transform: rotateZ(-45deg) rotateX(-90deg) translateY(calc(var(--cell-3d-size) * -0.46)) scaleY(1) !important;
    }
}





body { 
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
    background: var(--bg-body); 
    margin: 0; 
    color: var(--text-main); 
    transition: all 0.3s; 
    overflow-x: hidden; 
    -webkit-tap-highlight-color: transparent; 
}

/* =========================
   PADRONIZA√á√ÉO VISUAL (Bot√µes, Modais, Hovers)
   ========================= */
button, select, input[type="checkbox"], input[type="text"], input[type="number"] {
    min-height: 44px;
    min-width: 44px;
    border-radius: 12px;
    border: 1px solid rgba(0,0,0,0.1);
    font-family: inherit;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

button {
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 10px 20px;
    font-weight: 600;
    letter-spacing: 0.3px;
    background: var(--primary);
    color: white;
    border: none;
    box-shadow: 0 2px 4px var(--shadow);
}

button:hover {
    filter: brightness(1.1);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px var(--shadow);
}

button:active {
    transform: translateY(0);
    filter: brightness(0.95);
}

button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none !important;
    box-shadow: none !important;
}

button.cancelar, button[style*="background:#e57373"], button[style*="background:#c62828"] {
    background: #ff5252 !important;
    color: white !important;
}

button.secundario, button[style*="background:#999"], button[style*="background:#eee"] {
    background: rgba(0,0,0,0.05) !important;
    color: var(--text-main) !important;
    border: 1px solid rgba(0,0,0,0.1) !important;
}

body.dark-mode button.secundario, 
body.dark-mode button[style*="background:#999"], 
body.dark-mode button[style*="background:#eee"] {
    background: rgba(255,255,255,0.1) !important;
    color: #eee !important;
}

button:focus, 
select:focus, 
input:focus {
    outline: 3px solid rgba(76, 175, 80, 0.4);
    outline-offset: 1px;
}

@media (prefers-reduced-motion: reduce) {
    * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
}

body.deep-focus-active #abaEsquerda, 
body.deep-focus-active #abrirMenuBtn, 
body.deep-focus-active #btnTema, 
body.deep-focus-active #paleta-container, 
body.deep-focus-active h1, 
body.deep-focus-active .xp-container, 
body.deep-focus-active .painel-controle > div:not(#timer):not(.deep-focus-controls), 
body.deep-focus-active #jardim,
body.deep-focus-active #jardim3D,
body.deep-focus-active #painelMotivo,
body.deep-focus-active #streakBadge,
body.deep-focus-active #btnToggle3D {
    display: none !important;
}
body.deep-focus-active #conteudo { margin: 0; padding: 0; height: 100vh; display: flex; align-items: center; justify-content: center; }
body.deep-focus-active .painel-controle { background: transparent; box-shadow: none; border: none; width: 100%; max-width: none; padding: 0; }
body.deep-focus-active #timer { font-size: 25vw; margin: 0; line-height: 1; }
body.deep-focus-active #plantaFocoProfundo { font-size: 35vw; margin-bottom: 5vh; }

#bgCanvas { 
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%; 
    pointer-events: none; 
    z-index: 1; 
    display: block;
}

.presente-fall {
    position: fixed; top: -50px; font-size: 32px; z-index: 9999;
    pointer-events: none; animation: fall linear forwards;
}
@keyframes fall { to { transform: translateY(110vh) rotate(360deg); } }

.estrela-conquista {
    position: fixed;
    color: var(--accent);
    text-shadow: 0 0 8px var(--accent);
    z-index: 5;
    pointer-events: none;
    animation: brilharEstrela 3s infinite ease-in-out;
}
@keyframes brilharEstrela { 0%, 100% { opacity: 0.3; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.1); } }

@keyframes zoomInModal {
    from { opacity: 0; transform: scale(0.8); }
    to { opacity: 1; transform: scale(1); }
}

@keyframes zoomOutModal {
    from { opacity: 1; transform: scale(1); }
    to { opacity: 0; transform: scale(0.8); }
}

.modal-anim-in { animation: zoomInModal 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
.modal-anim-out { animation: zoomOutModal 0.2s ease-in forwards; }

#estanteOverlay, #configOverlay, #debugOverlay, #lojaOverlay, #modalPlantaOverlay, #modalLivroInput, #customAlertOverlay, #dashboardOverlay, #firstTimeOverlay, #manualFocusOverlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.6); z-index: 3000; display: none;
    align-items: center; justify-content: center; backdrop-filter: blur(8px);
    transition: all 0.3s ease;
}

#estanteContent, #configContent, #debugContent, #lojaContent, #modalPlantaContent, #modalLivroInput > div, #customAlertBox, #dashboardContent, #firstTimeContent, #manualFocusContent {
    background: var(--bg-panel); width: 95%; max-width: 500px; max-height: 85vh;
    border-radius: 28px; padding: 30px; overflow-y: auto; position: relative;
    box-shadow: 0 20px 50px rgba(0,0,0,0.3);
    border: 1px solid rgba(255,255,255,0.1);
}

.close-btn {
    position: absolute;
    top: 15px;
    right: 15px;
    background: none;
    border: none;
    font-size: 28px; /* Um pouco maior para melhor toque */
    color: var(--text-secondary);
    cursor: pointer;
    line-height: 1;
    padding: 5px;
    transition: color 0.2s;
    z-index: 3001;
}
.close-btn:hover {
    color: var(--primary);
}

@media (max-width: 600px) {
    #estanteContent {
        max-width: 270px; /* Aumentado para 270px para evitar sobreposi√ß√£o (12 * 18px + 2 * 15px padding + margens) */
        padding: 15px;
    }
}

.dashboard-container {
    margin-top: 15px;
}

.dia-semana {
    display: flex;
    align-items: center;
    margin-bottom: 12px;
    gap: 12px;
}

.dia-label {
    width: 20px;
    font-weight: bold;
    font-size: 13px;
    color: var(--text-secondary);
}

.dia-barra-container {
    flex: 1;
    background: var(--bg-body);
    border-radius: 8px;
    height: 20px;
    overflow: hidden;
    position: relative;
}

.dia-barra {
    height: 100%;
    background: linear-gradient(90deg, var(--primary), #66bb6a);
    border-radius: 8px 0 0 8px;
    min-width: 8px;
    transition: width 1s ease-out;
    position: relative;
}

.dia-barra.hoje {
    background: linear-gradient(90deg, var(--accent), #ffca28);
}

.dia-valor {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 12px;
    font-weight: bold;
    color: var(--text-main);
    z-index: 2;
}

.dia-meta {
    position: absolute;
    top: 0;
    width: 2px;
    height: 100%;
    background: rgba(255, 0, 0, 0.3);
}

.dashboard-resumo {
    display: flex;
    justify-content: space-between;
    background: var(--bg-body);
    padding: 15px;
    border-radius: 15px;
    margin-top: 20px;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 10px;
}

.resumo-item {
    text-align: center;
    flex: 1;
    min-width: 80px;
}

.resumo-valor {
    font-size: 24px;
    font-weight: bold;
    color: var(--primary);
}

.resumo-label {
    font-size: 11px;
    color: var(--text-secondary);
    margin-top: 5px;
}

.resumo-valor.meta {
    color: var(--accent);
}

.resumo-valor.total {
    color: #2196f3;
}

.resumo-valor.streak {
    color: #ff5722;
}

.moedas-display-loja {
    background: var(--plot-empty);
    padding: 15px;
    border-radius: 15px;
    font-size: 20px;
    font-weight: bold;
    color: #b8860b;
    margin-bottom: 20px;
}
.loja-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
}
.item-loja {
    background: var(--bg-body);
    padding: 15px;
    border-radius: 15px;
    border: 1px solid var(--shadow);
    text-align: center;
}
.item-loja button { width: 100%; margin-top: 10px; background: #daa520; }

.madeira-shelf {
    background: #795548; 
    padding: 10px; 
    border-radius: 0;
    box-shadow: inset 0 0 15px rgba(0,0,0,0.3); 
    margin: 0; 
    position: relative;
}

#listaLivros .madeira-shelf:last-child {
    border-radius: 0 0 8px 8px;
}

.prateleira-interna {
    background: #5d4037; 
    min-height: 80px; 
    display: flex; 
    align-items: flex-end;
    gap: 0; 
    padding: 0 8px; 
    border-bottom: 8px solid #3e2723;
    flex-wrap: wrap;
    justify-content: flex-start;
    width: 100%;
    box-sizing: border-box;
}

.livro {
    width: 24px; 
    border-radius: 2px 2px 0 0; 
    cursor: pointer;
    transition: transform 0.2s; 
    border-left: 2px solid rgba(255,255,255,0.1);
    box-shadow: 1px 0 3px rgba(0,0,0,0.2); 
    display: flex; 
    justify-content: center;
    position: relative;
    flex-shrink: 0;
    margin-right: -1px;
}
.livro:hover { transform: translateY(-5px); filter: brightness(1.1); }
.livro-titulo { 
    writing-mode: vertical-rl; 
    font-size: 7px; 
    color: white; 
    padding: 3px 0px;
    overflow: hidden; 
    text-overflow: ellipsis; 
    white-space: nowrap; 
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.star-rating { font-size: 28px; margin: 10px 0; display: flex; justify-content: center; gap: 5px; cursor: pointer; }
.star-rating .star { color: #ccc; }
.star-rating .star.active { color: var(--accent); }

.modal-prateleira {
    display: flex !important;
    flex-wrap: wrap !important;
    justify-content: center;
    gap: 8px;
    padding: 15px 5px;
    background: rgba(0,0,0,0.05);
    border-radius: 15px;
    border-bottom: 4px solid #8d6e63;
    margin-bottom: 15px;
}

.item {
    font-size: 24px;
    width: 42px;
    height: 42px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg-panel);
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s;
    border: 2px solid transparent;
    box-shadow: 0 2px 5px var(--shadow);
    flex-shrink: 0;
}

.item:hover { transform: translateY(-3px); }

@keyframes aproximarSuave {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

.item.selecionado {
    border-color: var(--primary);
    background: var(--plot-empty);
    animation: aproximarSuave 1.5s infinite ease-in-out;
    z-index: 5;
}

#abaEsquerda { 
    position: fixed; top:0; left:-210px; width:210px; height:100vh; 
    background: var(--bg-panel); box-shadow:4px 0 15px var(--shadow); 
    padding:0px 20px 200px 20px; /* Removido padding superior para subir o conte√∫do ao m√°ximo; mantido o inferior */
    box-sizing:border-box; 
    overflow-y: auto; /* Rolagem aplicada diretamente ao menu */
    -webkit-overflow-scrolling: touch; /* Adicionado para melhor rolagem em iOS */
    transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 1000; 
}
#abaEsquerda.aberto { left: 0; }

/* Lista de Tarefas Integrada ao Bot√£o */
.todo-container {
    background: var(--bg-panel);
    border-radius: 0 0 18px 18px;
    border: 1px solid var(--primary);
    border-top: none;
    padding: 12px;
    display: none;
    flex-direction: column;
    margin-top: -12px; /* Encaixa no bot√£o */
    max-height: 400px;
    overflow-y: auto;
    box-shadow: 0 10px 20px rgba(0,0,0,0.1);
}

.todo-container.ativo {
    display: flex;
    animation: expandDown 0.3s ease-out;
}

@keyframes expandDown {
    from { transform: translateY(-10px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.todo-item {
    display: flex;
    align-items: flex-start; /* Alinha ao topo para quando o texto quebrar linha */
    gap: 8px;
    padding: 8px 0;
    border-bottom: 1px solid rgba(0,0,0,0.05);
}

.todo-item span {
    flex: 1;
    font-size: 11px;
    line-height: 1.4;
    word-break: break-word; /* Quebra palavras longas se necess√°rio */
    white-space: normal;    /* Permite quebra de linha normal */
    padding-top: 2px;       /* Ajuste fino para alinhar com o checkbox */
}

.todo-item input[type="checkbox"] {
    min-width: 16px;
    min-height: 16px;
}

.todo-item button {
    min-width: 24px;
    min-height: 24px;
    padding: 0;
    background: #ff5252;
    font-size: 10px;
    border-radius: 6px;
}

#btnTodoToggle.ativo {
    border-radius: 18px 18px 0 0;
    box-shadow: none;
}
#abrirMenuBtn, #btnTema { 
    position: fixed; top: 15px; z-index: 900; 
    background: var(--accent); color: #333; border-radius: 50px; 
    border: none; padding: 10px 15px; cursor: pointer; font-weight: bold; 
}
#abrirMenuBtn { left: 15px; }
#btnTema { right: 15px; background: var(--bg-panel); color: var(--text-main); border: 1px solid var(--primary); }




#conteudo { 
    margin-left:0; 
    padding:40px 20px; 
    text-align:center; 
    transition: margin-left 0.3s; 
    position: relative; 
    z-index: 20; 
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    background: transparent;
}

/* DESKTOP: MAIOR GRID E PLOTS GRUDADOS */
@media(min-width: 900px) {
    /* Removido: #abaEsquerda { left: 0; } para manter o menu oculto */
    /* Removido: #conteudo { margin-left: 210px; } para manter o conte√∫do centralizado */
    /* Removido: #abrirMenuBtn { display: none; } para manter o bot√£o vis√≠vel */
    
    .painel-controle { order: 3; } /* Bot√µes para baixo */
    #jardim { 
        order: 2; /* Mapa para cima */
        margin-top: 5px;
    }
    #jardim3D { 
        order: 2; /* Mapa 3D para cima */
        max-width: 480px; /* Limitar a largura √† altura fixa (480px) para evitar achatamento */
        margin: 20px auto; /* Centralizar */
    }
    #painelMotivo { order: 5; }
    
    /* DESKTOP: HOVER EFFECT PARA SELE√á√ÉO */
    .plot:hover {
        transform: scale(1.05);
        transition: transform 0.2s;
        outline: 2px solid var(--primary);
        outline-offset: 2px;
    }
    
    
}

@media(max-width: 899px) {
    #conteudo { padding-top: 60px; }
    #jardim, #jardim3D { order: 2; margin-bottom: 45px; }
    .painel-controle { order: 3; }
    
    
    
    /* MOBILE: HOVER SIMPLIFICADO */
    .plot:active {
        transform: scale(0.95);
    }
}

/* NOVO: HOVER PARA GRID 2D EM TODOS OS DISPOSITIVOS */
.plot:hover {
    transform: scale(1.03);
    transition: transform 0.2s;
    outline: 2px solid var(--primary);
    outline-offset: 2px;
}

.painel-controle { 
    background: var(--bg-panel); 
    display: inline-block; 
    padding: 20px; 
    border-radius: 25px; 
    box-shadow: 0 10px 30px var(--shadow); 
    margin-bottom: 10px; 
    width: 95%; 
    max-width: 450px; 
    box-sizing: border-box;
    position: relative;
    z-index: 2;
}

body.dark-mode .painel-controle,
body.medieval-mode .painel-controle {
    border: 1px solid rgba(255, 255, 255, 0.1);
}

#painelInteligencia {
    background: rgba(0,0,0,0.03);
    margin: 10px auto;
    padding: 12px;
    border-radius: 15px;
    font-size: 11px;
    max-width: 300px;
    border: 1px solid var(--primary);
    display: block;
    transition: all 0.3s;
}

#timer { font-size: 60px; margin: 10px 0; font-weight: bold; font-family: 'Courier New', monospace; color: var(--text-main); text-align: center; }

/* Estilos de bot√µes legados removidos para usar a nova padroniza√ß√£o */

#jardim { 
    display:grid; 
    grid-template-columns:repeat(5, 55px); 
    gap:10px; 
    justify-content:center; 
    margin-top:20px; 
    transition: transform 1.2s ease-in-out;
    position: relative;
    z-index: 2;
margin-bottom: 20px;
}
.plot { 
    width:55px; 
    height:55px; 
    background: var(--plot-empty); 
    border-radius: 14px; 
    font-size: 28px; 
    display:flex; 
    align-items:center; 
    justify-content:center; 
    cursor:pointer; 
    position: relative; 
    z-index: 2;
    transition: transform 0.2s;
}
.plot.alvo { 
    outline:3px dashed var(--primary); 
    animation: pulsar 1.5s infinite, aproximarSuave 1.5s infinite ease-in-out; 
}

/* NOVO: Estilo para fantasma da planta pr√©-selecionada */
.plot-emoji-fantasma {
    opacity: 0.5;
    filter: grayscale(1);
}

@keyframes spawn {
    0% { transform: scale(0); }
    70% { transform: scale(1.2); }
    100% { transform: scale(1); }
}
.plant-spawn { animation: spawn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

@keyframes crescer {
    0% { transform: scale(0.5); opacity: 0.7; }
    50% { transform: scale(1.1); opacity: 1; }
    100% { transform: scale(1); opacity: 1; }
}
.crescendo { animation: crescer 0.5s ease-out forwards; }

@keyframes gardenZoomOut {
    0% { transform: scale(1); opacity: 1; }
    40% { transform: scale(0.6); opacity: 0.7; }
    80% { transform: scale(0); opacity: 0; }
    100% { transform: scale(1); opacity: 1; }
}
.zoom-out-effect { animation: gardenZoomOut 2.5s ease-in-out forwards; }

.lucky-plant-tag { 
    font-size: 11px; 
    background: var(--accent); 
    padding: 2px 8px; 
    border-radius: 20px; 
    display: inline-block; 
    margin-bottom: 10px; 
    font-weight: bold; 
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    position: relative;
    z-index: 2;
}
.lucky-glow { filter: drop-shadow(0 0 5px var(--accent)); animation: glowPulse 2s infinite ease-in-out; }

@keyframes glowPulse { 0%, 100% { filter: drop-shadow(0 0 2px var(--accent)); } 50% { filter: drop-shadow(0 0 8px var(--accent)); } }

#modalPlantaContent h3 { margin-top: 0; }
.btn-fechar-modal { position: absolute; top: 15px; right: 15px; font-size: 20px; cursor: pointer; color: var(--text-secondary); }

.color-picker { display: flex; justify-content: center; gap: 8px; margin: 15px 0; }
.color-swatch { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: 0.2s; }
.color-swatch.active { border-color: var(--text-main); transform: scale(1.1); }

.todo-item { display: flex; align-items: center; justify-content: space-between; margin-bottom: 5px; background: rgba(0,0,0,0.03); padding: 5px 10px; border-radius: 8px; font-size: 13px; }
.semana-card { background: var(--bg-body); padding: 15px; border-radius: 15px; margin-bottom: 12px; border-left: 5px solid var(--primary); text-align: left; box-shadow: 0 4px 6px var(--shadow); }
.mini-grind { display: block; margin: 8px 0; font-size: 18px; line-height: 1.4; word-break: break-all; }

.toggle-container { display: flex; align-items: center; justify-content: space-between; background: rgba(0,0,0,0.03); padding: 10px 15px; border-radius: 15px; margin-bottom: 10px; font-size: 14px; }

.secao-estilo {
    background: rgba(0,0,0,0.05);
    border: 1px solid var(--shadow);
    padding: 15px;
    border-radius: 20px;
    margin-bottom: 15px;
    text-align: left;
}
.secao-estilo h4 { margin: 0 0 10px 5px; font-size: 14px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; }

/* Dashboard Unificado */
.dashboard-periodo {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-bottom: 20px;
}

.dashboard-periodo button {
    background: var(--bg-body);
    color: var(--text-main);
    border: 1px solid var(--primary);
}

.dashboard-periodo button.active {
    background: var(--primary);
    color: white;
}

.dashboard-periodo-content {
    display: none;
}

.dashboard-periodo-content.active {
    display: block;
}

/* NOVO: Estilos para a se√ß√£o "Mais usado" no dashboard */
.mais-usado-section {
    background: var(--bg-panel);
    padding: 20px;
    border-radius: 20px;
    margin-top: 25px;
    border-left: 5px solid var(--accent);
    box-shadow: 0 4px 12px var(--shadow);
}

.mais-usado-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 15px;
    color: var(--primary);
    font-size: 16px;
    font-weight: bold;
}

.mais-usado-content {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    justify-content: space-between;
}

.mais-usado-item {
    flex: 1;
    min-width: 140px;
    text-align: center;
    padding: 15px;
    background: var(--bg-body);
    border-radius: 15px;
    border: 1px solid var(--shadow);
}

.mais-usado-emoji {
    font-size: 36px;
    margin-bottom: 10px;
    display: block;
}

.mais-usado-motivo {
    font-size: 13px;
    color: var(--text-main);
    line-height: 1.4;
    word-break: break-word;
}

.mais-usado-label {
    font-size: 11px;
    color: var(--text-secondary);
    margin-top: 5px;
    display: block;
}

/* NOVO ESTILO: CONFIGURA√á√ïES EM GRID */
.config-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin-bottom: 20px;
}

.config-card {
    background: var(--bg-body);
    border-radius: 16px;
    padding: 18px;
    text-align: center;
    border: 1px solid var(--shadow);
    transition: all 0.2s;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100px;
}

.config-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 15px var(--shadow);
}

.config-card h4 {
    margin: 0 0 10px 0;
    font-size: 14px;
    color: var(--text-main);
}

/* NOVO: Estilo de Switch Arredondado (iOS-style) */
.ios-switch-container {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%; /* Para centralizar no config-card */
    margin-top: 10px; /* Espa√ßamento */
}

.ios-switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 30px;
    background-color: var(--text-secondary); /* Cor de fundo para OFF */
    border-radius: 15px;
    cursor: pointer;
    transition: background-color 0.3s;
}

.ios-switch.on {
    background-color: var(--primary); /* Cor de fundo para ON */
}

.ios-switch-thumb {
    position: absolute;
    top: 2px;
    left: 2px;
    width: 26px;
    height: 26px;
    background-color: white;
    border-radius: 50%;
    transition: transform 0.3s;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
}

.ios-switch.on .ios-switch-thumb {
    transform: translateX(20px);
}

/* Removendo estilos de bot√£o que n√£o ser√£o mais usados */
.config-card button {
    display: none;
}



/* ESTILO DO T√çTULO */
h1 {
    font-family: 'Georgia', 'Times New Roman', serif;
    font-weight: 700;
    font-size: 2.5rem;
    margin-bottom: 5px;
    color: var(--primary);
    letter-spacing: 0.5px;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    cursor: pointer;
    position: relative;
    z-index: 2;
}

/* ESTILO DO BADGE DE STREAK */
#streakBadge {
    background: linear-gradient(90deg, #ff5722, #ff9800);
    color: white;
    padding: 6px 14px;
    border-radius: 30px;
    font-size: 13px;
    font-weight: bold;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 15px;
    box-shadow: 0 3px 8px rgba(255, 87, 34, 0.3);
    cursor: pointer;
    transition: transform 0.2s;
    position: relative;
    z-index: 2;
}
#streakBadge:hover {
    transform: scale(1.05);
}

/* ESTILOS PARA FOTO DE PERFIL */
#profilePhotoContainer {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    overflow: hidden;
    margin: 0 auto 10px;
    background: var(--bg-panel);
    border: 3px solid var(--primary);
    cursor: pointer;
    transition: all 0.3s;
    position: relative;
    box-shadow: 0 4px 12px var(--shadow);
}

#profilePhotoContainer:hover {
    transform: scale(1.05);
    border-color: var(--accent);
}

#profilePhoto {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: none;
}

#profilePhotoPlaceholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 35px;
    background: linear-gradient(135deg, var(--primary), var(--accent));
    color: white;
}

#profilePhotoLabel {
    text-align: center;
    font-size: 11px;
    color: var(--text-secondary);
    margin-bottom: 15px;
    cursor: pointer;
    transition: color 0.3s;
}

#profilePhotoLabel:hover {
    color: var(--primary);
}

#profilePhotoInput {
    display: none;
}

/* NOVO: Estilos para estante com m√∫ltiplos andares */
.prateleira-interna {
    display: flex;
    align-items: flex-end;
    justify-content: flex-start;
    flex-wrap: wrap;
    gap: 0;
}

.livro {
    position: relative;
    flex-shrink: 0;
    transition: all 0.3s ease;
    border-radius: 2px 2px 0 0;
    cursor: pointer;
    overflow: hidden;
    margin-right: -1px;
}

.livro:hover {
    transform: translateY(-5px);
    filter: brightness(1.1);
}

.livro-titulo {
    writing-mode: vertical-rl;
    text-orientation: mixed;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 3px 0px;
}

@media (max-width: 600px) {
    .livro {
        width: 18px !important;
    }
    
    .livro-titulo {
        font-size: 6px !important;
    }
}

/* NOVO: Bot√£o de ajuda na estante */
.help-btn {
    position: absolute;
    top: 15px;
    right: 15px;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--primary);
    color: white;
    border: none;
    font-size: 18px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
}

.help-btn:hover {
    background: var(--accent);
    color: #333;
    transform: scale(1.1);
}



/* Estilos para o popup de primeiro uso */
.first-time-step {
    text-align: center;
}

.first-time-step h3 {
    color: var(--primary);
    margin-bottom: 15px;
}

.first-time-step p {
    margin-bottom: 15px;
    line-height: 1.6;
}

.first-time-step ul {
    text-align: left;
    margin: 15px 0;
    padding-left: 20px;
}

.first-time-step li {
    margin-bottom: 8px;
    line-height: 1.5;
}

.first-time-emoji {
    font-size: 40px;
    margin: 15px 0;
    display: block;
}

.first-time-buttons {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-top: 10px;
}

/* =========================
   TUTORIAL INTERATIVO (SIMPLIFICADO)
   ========================= */
#tutorialOverlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 9999;
    display: none;
    justify-content: center;
    align-items: center;
    background: rgba(0, 0, 0, 0.85);
}

#tutorialOverlay.active {
    display: flex;
}

.tutorial-card {
    background: var(--bg-panel);
    border-radius: 24px;
    padding: 30px;
    max-width: 380px;
    width: 90%;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
    animation: tutorialSlideIn 0.4s ease-out;
    text-align: center;
}

@keyframes tutorialSlideIn {
    from { opacity: 0; transform: scale(0.9) translateY(20px); }
    to { opacity: 1; transform: scale(1) translateY(0); }
}

.tutorial-icon {
    font-size: 50px;
    margin-bottom: 15px;
}

.tutorial-title {
    font-size: 20px;
    font-weight: bold;
    color: var(--primary);
    margin-bottom: 15px;
}

.tutorial-text {
    font-size: 15px;
    color: var(--text-main);
    line-height: 1.6;
    margin-bottom: 20px;
}

.tutorial-location {
    background: var(--plot-empty);
    border-radius: 12px;
    padding: 12px 15px;
    margin-bottom: 20px;
    font-size: 13px;
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.tutorial-location strong {
    color: var(--primary);
}

.tutorial-progress {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin-bottom: 20px;
}

.tutorial-progress-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: var(--plot-empty);
    transition: all 0.3s;
}

.tutorial-progress-dot.active {
    background: var(--primary);
    transform: scale(1.3);
}

.tutorial-progress-dot.completed {
    background: var(--accent);
}

.tutorial-buttons {
    display: flex;
    gap: 12px;
    justify-content: center;
    margin-bottom: 15px;
}

.tutorial-btn {
    padding: 12px 24px;
    border-radius: 12px;
    border: none;
    font-size: 14px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.2s;
    min-width: 100px;
}

.tutorial-btn-primary {
    background: var(--primary);
    color: white;
}

.tutorial-btn-primary:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
}

.tutorial-btn-secondary {
    background: var(--bg-body);
    color: var(--text-main);
    border: 1px solid var(--shadow);
}

.tutorial-btn-secondary:hover {
    background: var(--plot-empty);
}

.tutorial-btn-skip {
    background: transparent;
    color: var(--text-secondary);
    font-size: 12px;
    padding: 8px 15px;
    width: 100%;
}

.tutorial-btn-skip:hover {
    color: var(--text-main);
}

.tutorial-step-counter {
    font-size: 12px;
    color: var(--text-secondary);
}

/* Estilos para o modal de in√≠cio de foco */
#startFocusModalOverlay {
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%;
    background: rgba(0,0,0,0.8); 
    z-index: 4000; 
    display: none;
    align-items: center; 
    justify-content: center; 
    backdrop-filter: blur(5px);
}

#startFocusModalContent {
    background: var(--bg-panel); 
    width: 95%; 
    max-width: 400px;
    border-radius: 25px; 
    padding: 25px; 
    text-align: center;
    position: relative;
}

.dont-show-again {
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 15px 0;
    gap: 8px;
    font-size: 14px;
    color: var(--text-secondary);
}

.dont-show-again input[type="checkbox"] {
    min-height: 20px;
    min-width: 20px;
    height: 20px;
    width: 20px;
    margin: 0;
    cursor: pointer;
}

.dont-show-again label {
    font-size: 14px;
    cursor: pointer;
    user-select: none;
}

/* =========================
   ESTILOS 3D ISOM√âTRICO - RESPONSIVO
   ========================= */
#jardim3D {
    display: none;
    position: relative;
    margin-top: 10px;
    width: 100%;
    height: auto; /* Alterado para auto */
    min-height: 500px; /* Altura m√≠nima */
    max-height: 80vh; /* Limite m√°ximo baseado na viewport */
    overflow: hidden; /* Garante que nada escape */
}

.scene-3d {
    perspective: 1200px;
    perspective-origin: 50% 50%;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    transform-origin: center center;
}

.grid-container-3d {
    display: grid;
    grid-template-columns: repeat(5, var(--cell-3d-size));
    grid-template-rows: repeat(5, var(--cell-3d-size));
    gap: 2px;
    transform: rotateX(60deg) rotateZ(45deg) scale(var(--scale-3d, 1)); /* Adicionado scale para ajuste */
    transform-style: preserve-3d;
    position: relative;
    background-color: var(--grid-border);
    padding: 2px;
    transition: all 0.5s ease;
    transform-origin: center center; /* Origem da transforma√ß√£o no centro */
    will-change: transform; /* Otimiza√ß√£o para performance */
}

.cell-3d {
    width: var(--cell-3d-size);
    height: var(--cell-3d-size);
    background-color: var(--grid-color);
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 40 40"><path d="M5 35 L10 30 L15 35 Z" fill="%237db336" opacity="0.7"/><path d="M25 15 L30 10 L35 15 Z" fill="%237db336" opacity="0.7"/></svg>');
    background-size: 40px 40px;
    background-repeat: repeat;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background 0.2s, transform 0.2s;
    position: relative;
    user-select: none;
    transform-style: preserve-3d;
}

.cell-3d:hover {
    background-color: color-mix(in srgb, var(--grid-color) 80%, white);
    transform: translateZ(10px);
}

.cell-3d.alvo {
    outline: 3px dashed var(--primary);
    outline-offset: -3px;
    animation: pulsar 1.5s infinite, aproximarSuave 1.5s infinite ease-in-out;
    z-index: 5;
}

/* Profundidade do bloco (terra) */
.grid-container-3d::before {
    content: '';
    position: absolute;
    top: 100%;
    left: 0;
    width: 100%;
    height: 20px;
    background: var(--side-color);
    transform-origin: top;
    transform: rotateX(-90deg);
}

.grid-container-3d::after {
    content: '';
    position: absolute;
    top: 0;
    left: 100%;
    width: 20px;
    height: 100%;
    background: var(--bottom-color);
    transform-origin: left;
    transform: rotateY(90deg);
}

/* Emojis 3D - TAMANHO AJUSTADO PROPORCIONALMENTE */
.emoji-3d {
    font-size: calc(var(--cell-3d-size) * 0.79); /* Tamanho responsivo e proporcional */
    pointer-events: none;
    display: block;
    user-select: none;
    position: absolute;
    transform: rotateZ(-45deg) rotateX(-90deg) translateY(calc(var(--cell-3d-size) * -0.46)) scaleY(1);
    filter: none;
    z-index: 10;
    transition: all 0.3s ease;
}

.emoji-3d.plant-spawn {
    animation: spawn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.emoji-3d.lucky-glow {
    filter: drop-shadow(0 0 5px var(--accent));
    animation: glowPulse 2s infinite ease-in-out;
}

.emoji-3d.crescendo {
    animation: crescer 0.5s ease-out forwards;
}

.emoji-3d.fantasma {
    opacity: 0.3;
    filter: grayscale(1) drop-shadow(0 1px 1px rgba(0,0,0,0.2));
}

/* CORRE√á√ÉO: Estilo espec√≠fico para modo Natal - apenas altera background-image */
body.natal-mode .cell-3d {
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 40 40"><path d="M5 35 L10 30 L15 35 Z" fill="%23cccccc" opacity="0.7"/><path d="M25 15 L30 10 L35 15 Z" fill="%23cccccc" opacity="0.7"/></svg>');
}

/* Ajustes para grid 10x10 no 3D */
body.grid-10x10 #jardim3D {
    min-height: 400px;
    max-height: 85vh;
}

body.grid-10x10 .grid-container-3d {
    grid-template-columns: repeat(10, var(--cell-3d-size));
    grid-template-rows: repeat(10, var(--cell-3d-size));
    transform: rotateX(60deg) rotateZ(45deg) scale(calc(var(--scale-3d, 1) * 0.9)); /* Escala menor para 10x10 */
}

/* Responsividade 3D - MOBILE PRIORITY */
@media (max-width: 899px) {
    :root {
        --cell-3d-size: 12vw; /* Usando viewport width para ser responsivo */
    }
    
    #jardim3D {
        height: 70vw; /* Altura proporcional √† largura */
        max-height: 70vh;
        min-height: 250px;
    }
    
    .grid-container-3d {
        transform: rotateX(60deg) rotateZ(45deg) scale(0.9); /* Escala menor em mobile */
    }
    
    /* Grid 10x10 em mobile */
    body.grid-10x10 #jardim3D {
        height: 85vw;
        max-height: 80vh;
    }
    
    body.grid-10x10 .grid-container-3d {
        transform: rotateX(60deg) rotateZ(45deg) scale(0.8) !important;
    }
}

/* Responsividade 3D - TABLET */
@media (min-width: 600px) and (max-width: 899px) {
    :root {
        --cell-3d-size: 14vw;
    }
    
    #jardim3D {
        height: 65vw;
        max-height: 65vh;
    }
    
    .grid-container-3d {
        transform: rotateX(60deg) rotateZ(45deg) scale(1);
    }
    
    body.grid-10x10 #jardim3D {
        height: 80vw;
    }
}

/* Responsividade 3D - DESKTOP */
@media (min-width: 900px) {
    :root {
        --cell-3d-size: 16vw; /* Ajustado para responsivo */
    }
    
    #jardim3D {
        height: 60vw;
        max-height: 620px;
        max-width: 800px;
        margin: 20px auto;
    }
    
    .grid-container-3d {
        transform: rotateX(60deg) rotateZ(45deg) scale(1.1);
    }
    
    /* Grid 10x10 em desktop */
    body.grid-10x10 #jardim3D {
        height: 65vw;
        max-height: 550px;
    }
    
    body.grid-10x10 .grid-container-3d {
        transform: rotateX(60deg) rotateZ(45deg) scale(1) !important;
    }
}

/* Ajustes para telas muito pequenas (celulares antigos) */
@media (max-width: 360px) {
    :root {
        --cell-3d-size: 14vw;
    }
    
    #jardim3D {
        height: 75vw;
        max-height: 75vh;
    }
    
    .grid-container-3d {
        transform: rotateX(60deg) rotateZ(45deg) scale(0.8);
    }
    
    body.grid-10x10 #jardim3D {
        height: 90vw;
    }
}

/* Ajustes para orienta√ß√£o paisagem (landscape) */
@media (max-height: 600px) and (orientation: landscape) {
    #jardim3D {
        height: 50vh !important;
        max-height: 50vh !important;
    }
    
    .grid-container-3d {
        transform: rotateX(60deg) rotateZ(45deg) scale(0.8) !important;
    }
    
    body.grid-10x10 #jardim3D {
        height: 60vh !important;
    }
}

/* Classe para for√ßar redimensionamento quando necess√°rio */
.grid-container-3d.ajustado {
    transform: rotateX(60deg) rotateZ(45deg) scale(var(--scale-3d, 1)) !important;
}

/* Bot√£o de altern√¢ncia 3D */
#btnToggle3D:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0,0,0,0.3);
}
/* Estilo para bot√µes desabilitados */
.ios-switch.disabled {
    opacity: 0.5;
    cursor: not-allowed;
    pointer-events: none;
}

.ios-switch.disabled .ios-switch-thumb {
    background-color: #cccccc;
}

.ios-switch.disabled.on {
    background-color: #cccccc;
}

</style>
</head>
<body id="mainBody">

<canvas id="bgCanvas"></canvas>
<div id="starsContainer"></div>



<!-- Novo overlay para primeiro uso -->
<div id="firstTimeOverlay" style="display: none;">
    <div id="firstTimeContent">
        <button class="close-btn" onclick="pularPrimeiroUso()">√ó</button>
        <div id="firstTimeStep2" class="first-time-step" style="display: block;">
            <div class="first-time-emoji">üë§</div>
            <h3>Como gostaria de ser chamado?</h3>
            <p>Digite seu nome abaixo para personalizar sua experi√™ncia:</p>
            
            <input type="text" id="firstTimeNameInput" placeholder="Seu nome..." style="width: 90%; padding: 12px; border-radius: 10px; border: 2px solid var(--primary); font-size: 16px; margin: 15px 0;">
            
            <div class="first-time-buttons">
                <button onclick="finalizarPrimeiroUso()">Come√ßar a focar!</button>
            </div>
        </div>
    </div>
</div>

<!-- TUTORIAL INTERATIVO (SIMPLIFICADO) -->
<div id="tutorialOverlay" style="display: none;">
    <div class="tutorial-card" id="tutorialCard">
        <div class="tutorial-icon" id="tutorialIcon">üå±</div>
        <div class="tutorial-title" id="tutorialTitle">Bem-vindo!</div>
        <div class="tutorial-text" id="tutorialText">Texto do tutorial</div>
        <div class="tutorial-location" id="tutorialLocation" style="display: none;">
            üìç <span id="tutorialLocationText">Localiza√ß√£o</span>
        </div>
        <div class="tutorial-progress" id="tutorialProgress"></div>
        <div class="tutorial-buttons">
            <button class="tutorial-btn tutorial-btn-secondary" id="tutorialPrevBtn" onclick="tutorialAnterior()">Anterior</button>
            <button class="tutorial-btn tutorial-btn-primary" id="tutorialNextBtn" onclick="tutorialProximo()">Pr√≥ximo</button>
        </div>
        <button class="tutorial-btn tutorial-btn-skip" id="tutorialSkipBtn" onclick="tutorialPular()">Pular Tutorial</button>
        <div class="tutorial-step-counter" id="tutorialStepCounter">Passo 1 de 5</div>
    </div>
</div>

<!-- Modal para in√≠cio de foco -->
<div id="startFocusModalOverlay">
    <div id="startFocusModalContent" class="modal-anim-in">
        <h3 style="color: var(--primary); margin-top:0;">Hora de focar! Boa sess√£o! ‚è±Ô∏è</h3>
        <div class="dont-show-again">
            <input type="checkbox" id="dontShowAgainCheckbox">
            <label for="dontShowAgainCheckbox">N√£o mostrar mais esse aviso</label>
        </div>
        <button onclick="closeStartFocusModal(true)" style="width:100%;">Iniciar agora</button>
    </div>
</div>

<!-- NOVO: Modal para adicionar foco manual -->
<div id="aviso3DOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 5000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px);">
    <div id="aviso3DContent" style="background: var(--bg-panel); width: 90%; max-width: 400px; border-radius: 25px; padding: 25px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
        <h3 style="color: var(--accent); margin-top: 0;">Aviso: Modo 3D Experimental</h3>
        <p>O modo 3D √© uma funcionalidade nova e pode apresentar instabilidades ou consumir mais recursos do seu dispositivo.</p>
        <p>Se notar lentid√£o ou erros, por favor, volte para o modo 2D.</p>
        <button onclick="fecharAviso3D()" style="margin-top: 15px;">Entendi, Continuar</button>
    </div>
</div>

<div id="manualFocusOverlay">
    <div id="manualFocusContent">
        <h3 style="color: var(--primary); margin-top:0;">Adicionar Foco Manual</h3>
        <p id="manualFocusText" style="margin: 20px 0;">Aviso: adicionar imediatamente um foco em <strong id="manualMotivo">[motivo]</strong> por <strong id="manualTempo">[tempo]</strong> min?</p>
        <div style="display: flex; justify-content: center; gap: 10px;">
            <button onclick="confirmarFocoManual()" style="flex:1;">Ok</button>
            <button onclick="fecharModal('manualFocusOverlay')" class="secundario" style="flex:1;">Cancelar</button>
        </div>
    </div>
</div>

<audio id="audioChuva" loop>
    <source src="data:audio/wav;base64,UklGRmSBAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YX6BAAA=" type="audio/wav">
</audio>
<audio id="audioVento" loop>
    <source src="data:audio/wav;base64,UklGRmSBAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YX6BAAA=" type="audio/wav">
</audio>

<div id="dashboardOverlay">
    <div id="dashboardContent">
        <h2 style="color: var(--primary)">üìä Painel de Foco</h2>
        <div class="dashboard-periodo">
            <button onclick="mostrarDashboardPeriodo('semanal')" id="btnDashboardSemanal" class="active">Semanal</button>
            <button onclick="mostrarDashboardPeriodo('mensal')" id="btnDashboardMensal">Mensal</button>
            <button onclick="mostrarDashboardPeriodo('anual')" id="btnDashboardAnual">Anual</button>
        </div>
        <div class="dashboard-container" id="dashboardContainerSemanal"></div>
        <div class="dashboard-container" id="dashboardContainerMensal" style="display: none;"></div>
        <div class="dashboard-container" id="dashboardContainerAnual" style="display: none;"></div>
        <button onclick="fecharModal('dashboardOverlay')" class="secundario" style="width:100%; margin-top:20px;">Fechar Painel</button>
    </div>
</div>

<div id="debugOverlay">
    <div id="debugContent">
        <h2 style="color: var(--primary)">üõ†Ô∏è Painel de Testes (Debug)</h2>
        <div style="display: flex; flex-direction: column; gap: 10px;">
            <button onclick="fillGridTest()" style="background: #2196f3;">Preencher Todo o Grid (Ciclo Final)</button>
            <button onclick="addMaxStarsTest()" style="background: var(--accent); color: #333;">Adicionar 5 Estrelas no C√©u</button>
            <button onclick="simularSucessosTest()" style="background: var(--primary);">Gerar Hist√≥rico (Ativar Relat√≥rio)</button>
            
            <!-- NOVO: Bot√£o para alternar entre 5x5 e 10x10 -->
            <button onclick="toggleGrid10x10()" style="background: #9c27b0; color: white;" id="btnGrid10x10">
                Grid 10x10 (Modo Debug)
            </button>
            <button onclick="ganharMoedasDebug()" style="background: #daa520; color: #333; font-weight: bold;">üí∞ Ganhar 200 Moedas (Debug)</button>
            <button onclick="fecharModal('debugOverlay')" class="secundario">Fechar Debug</button>
        </div>
    </div>
</div>

<div id="estanteOverlay">
    <div id="estanteContent">
        <button class="help-btn" onclick="mostrarInfoEstante()">?</button>
        <h2 style="color: var(--primary)">üìö Minha Estante</h2>
        <div id="listaLivros" style="min-height: 200px;"></div>
        <button onclick="prepararNovoLivro()" style="width:100%; margin-top: 20px;">+ Novo Livro</button>
        <button onclick="fecharModal('estanteOverlay')" class="secundario" style="width:100%; margin-top:10px;">Fechar</button>
    </div>
</div>

<div id="lojaOverlay">
    <div id="lojaContent">
        <h2 style="color: #daa520;">üõí Loja do Jardim</h2>
        <div class="moedas-display-loja">Minhas Moedas: <span id="saldoLojaMoedas">0</span> üí∞</div>
        
        
        <div class="loja-grid">
            
            <div class="item-loja">
                <div>üè∞ Reino Medieval</div>
                <small>Um reino tranquilo</small>
                <button id="btnComprarMedieval" onclick="comprarItemLoja('medieval', 100)">100 üí∞</button>
            </div>
            <div class="item-loja">
    <div>üç≠ Candyfornia</div>
    <small>Mundo de Doces</small>
    <button id="btnComprarCandyfornia" onclick="comprarItemLoja('candyfornia', 150)">150 üí∞</button>
</div>
        </div>
        <button onclick="fecharModal('lojaOverlay')" class="secundario" style="width:100%; margin-top:20px;">Sair da Loja</button>
</div>
</div>

<div id="modalPlantaOverlay">
    <div id="modalPlantaContent">
        <span class="btn-fechar-modal" onclick="fecharModal('modalPlantaOverlay')">‚úñ</span>
        <h3 style="color: var(--primary)">Selecione sua semente üå±</h3>
        <p style="font-size: 11px; margin: 5px 0; color: var(--text-secondary)">PRATELEIRA: COMUNS</p>
        <div id="paletaModal" class="modal-prateleira"></div>
        <p style="font-size: 11px; margin: 5px 0; color: var(--text-secondary)">PRATELEIRA: ESPECIAL (MODOS)</p>
        <div id="paletaEspecialModal" class="modal-prateleira"></div>
    </div>
</div>

<div id="configOverlay">
    <div id="configContent">
        <span class="btn-fechar-modal" onclick="fecharModal('configOverlay')">‚úñ</span>
        <h2 style="color: var(--primary)">‚öôÔ∏è Configura√ß√µes</h2>
        
        <div class="config-grid">
            <div class="config-card">
                <h4>üîî Sino</h4>
                <div class="ios-switch-container">
                    <div id="btnSino" class="ios-switch" onclick="toggleSino()">
                        <div class="ios-switch-thumb"></div>
                    </div>
                </div>
            </div>
            
            <div class="config-card">
                <h4>üåô Auto Tema</h4>
                <div class="ios-switch-container">
                    <div id="btnTemaAuto" class="ios-switch" onclick="toggleTemaAuto()">
                        <div class="ios-switch-thumb"></div>
                    </div>
                </div>
                
                 <div style="text-align: center; margin-top: 8px; padding: 6px; border-radius: 8px;">
        <small style="color: var(--text-secondary); font-size: 10px; line-height: 1.3; display: block;">
            <span style="color: var(--primary);"></span> 
            Desative para alternar entre modo claro ou escuro manualmente.
        </small>
            </div>
            </div>
            
            
            <div class="config-card">
                <h4>‚ú® Estrelas</h4>
                <div class="ios-switch-container">
                    <div id="btnEstrelas" class="ios-switch on" onclick="toggleEstrelas()">
                        <div class="ios-switch-thumb"></div>
                    </div>
                </div>
                 <div style="text-align: center; margin-top: 8px; padding: 6px; border-radius: 8px;">
        <small style="color: var(--text-secondary); font-size: 10px; line-height: 1.3; display: block;">
            <span style="color: var(--primary);"></span> 
            Uma estrela aparece no modo noturno sempre que um livro 5 estrelas √© colocado na estante.
        </small>
            </div>
            </div>
            <!-- No configOverlay, dentro da grid de configura√ß√µes -->
<div class="config-card">
    <h4>üì± Tela Sempre Ativa Durante Foco</h4>
    <div class="ios-switch-container">
        <div id="btnTelaAtiva" class="ios-switch" onclick="toggleTelaAtiva()">
            <div class="ios-switch-thumb"></div>
        </div>
    </div>
    <div style="text-align: center; margin-top: 8px; padding: 6px; border-radius: 8px;">
        <small style="color: var(--text-secondary); font-size: 10px; line-height: 1.3; display: block;">
            <span style="color: var(--primary);"></span> 
            Mant√©m sua tela ativa automaticamente durante o foco. N√£o saia do app para que funcione corretamente.
        </small>
    </div>
</div>
            
            <div class="config-card">
                <h4>üé® Anima√ß√£o do Fundo</h4>
                <div class="ios-switch-container">
                    <div id="btnAnimFundo" class="ios-switch on" onclick="toggleAnimacaoFundo()">
                        <div class="ios-switch-thumb"></div>
                    </div>
                </div>
            </div>
            
            <!-- NOVO: Configura√ß√£o para previs√£o -->
            <div class="config-card">
                <h4>üîÆ Previs√£o</h4>
                <div class="ios-switch-container">
                    <div id="btnPrevisao" class="ios-switch" onclick="togglePrevisao()">
                        <div class="ios-switch-thumb"></div>
                    </div>
                </div>
                 <div style="text-align: center; margin-top: 8px; padding: 6px; border-radius: 8px;">
        <small style="color: var(--text-secondary); font-size: 10px; line-height: 1.3; display: block;">
            <span style="color: var(--primary);"></span> 
            Fun√ß√£o baseada em estat√≠sticas que prev√™ sua taxa de sucesso nas sess√µes de foco.
        </small>
            </div>
            </div>
            </div>
        
        
        <!-- NOVA CAIXA DE MODOS -->
<h3 style="margin-top: 20px; margin-bottom: 10px; color: var(--text-main);">MODOS</h3>
<div class="config-grid">
    <div class="config-card">
        <h4>üéÑ Natal</h4>
        <div class="ios-switch-container">
            <div id="btnNatal" class="ios-switch" onclick="toggleNatal()">
                <div class="ios-switch-thumb"></div>
            </div>
        </div>
    </div>
    
    <div class="config-card">
        <h4>üè∞ Medieval</h4>
        <div class="ios-switch-container">
            <div id="btnMedievalConfig" class="ios-switch" onclick="toggleMedieval()">
                <div class="ios-switch-thumb"></div>
            </div>
        </div>
    </div>
    
    <!-- AGORA DENTRO DA GRID: -->
    <div class="config-card">
        <h4>üç≠ Candyfornia</h4>
        <div class="ios-switch-container">
            <div id="btnCandyforniaConfig" class="ios-switch" onclick="toggleCandyfornia()">
                <div class="ios-switch-thumb"></div>
            </div>
        </div>
    </div>
</div>
        
        <!-- NOVA SE√á√ÉO: VISUALIZA√á√ÉO -->
        <h3 style="margin-top: 20px; margin-bottom: 10px; color: var(--text-main);">VISUALIZA√á√ÉO</h3>
        <div class="config-grid">
            <div class="config-card">
                <h4>üåê 3D/2D</h4>
                <div class="ios-switch-container">
                    <div id="btn3DToggle" class="ios-switch" onclick="toggleModo3D()">
                        <div class="ios-switch-thumb"></div>
                    </div>
                </div>
            </div>
            
            <div class="config-card">
                <h4>‚ñ† Diminuir/Aumentar Grid</h4>
                <div class="ios-switch-container">
                    <div id="btnGrid10x10Toggle" class="ios-switch" onclick="toggleGrid10x10()">
                        <div class="ios-switch-thumb"></div>
                    </div>
                    </div>
                     <div style="text-align: center; margin-top: 8px; padding: 6px; border-radius: 8px;">
        <small style="color: var(--text-secondary); font-size: 10px; line-height: 1.3; display: block;">
            <span style="color: var(--primary);"></span> 
            Alterna o tamanho do seu jardim entre 5x5 e 10x10. As plantas s√£o reposicionadas. Algumas podem sumir.
        </small>
                </div>
            </div>
        </div>
        <!-- NOVO: SE√á√ÉO DE ATUALIZA√á√ïES DO PWA -->
<h3 style="margin-top: 20px; margin-bottom: 10px; color: var(--text-main);">ATUALIZA√á√ïES</h3>
<div class="config-grid">
    <div class="config-card">
        <h4>üîÑ Atualiza√ß√µes do App</h4>
        <div style="text-align: center; margin-top: 10px;">
            <button onclick="verificarAtualizacoes()" style="width: 100%; background: #9c27b0; color: white; margin-bottom: 8px;">
                üîç Verificar Atualiza√ß√µes
            </button>
            <div id="atualizacaoStatus" style="font-size: 10px; color: var(--text-secondary); line-height: 1.4; margin-top: 5px; min-height: 30px;">
                Vers√£o atual: 2.3.2
            </div>
        </div>
    </div>
</div>
        <!-- BOT√ÉO DE TUTORIAL -->
        <button onclick="iniciarTutorial()" style="width:100%; background: #9c27b0; color: white; margin-bottom: 15px; border-radius: 14px; font-weight: bold; padding: 12px;">üìñ Repetir Tutorial</button>
        
        <!-- SE√á√ÉO DE BACKUP DE DADOS -->
        <h3 style="margin-top: 20px; margin-bottom: 10px; color: var(--text-main); display: flex; align-items: center; gap: 8px;">
            üíæ BACKUP DE DADOS
            <span onclick="mostrarAjudaBackup()" style="cursor: pointer; background: var(--primary); color: white; width: 22px; height: 22px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold;">?</span>
        </h3>
        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <button onclick="exportarDados()" style="flex: 1; background: #2196f3; color: white; border-radius: 14px; font-weight: bold; padding: 12px;">üì§ Exportar</button>
            <button onclick="document.getElementById('importarArquivo').click()" style="flex: 1; background: #4caf50; color: white; border-radius: 14px; font-weight: bold; padding: 12px;">üì• Importar</button>
            <input type="file" id="importarArquivo" accept=".json" style="display: none;" onchange="importarDados(event)">
        </div>
        
        <button onclick="resetAbsoluto()" style="width:100%; background:#c62828; color: white; margin-bottom:10px; border-radius: 14px; font-weight: bold;">‚ö†Ô∏è Reset Absoluto (Zerar Tudo)</button>
        <div style="text-align: center; font-size: 10px; color: var(--text-secondary); margin-top: 15px;">Vers√£o: 2.3.2</div>
        <button onclick="fecharModal('configOverlay')" class="secundario" style="width:100%; margin-top:10px;">Fechar</button>
    </div>
</div>

<div id="modalLivroInput">
    <div style="background:var(--bg-panel); padding:20px; border-radius:20px; width:280px; text-align:center;">
        <h3>Adicionar Livro</h3>
        <input type="text" id="nomeLivroInput" placeholder="T√≠tulo..." style="width:90%; border:1px solid #ddd; margin-bottom:10px; padding: 8px; border-radius: 8px;">
        <textarea id="notasLivroInput" placeholder="Notas..." style="width:90%; height: 60px; border:1px solid #ddd; margin-bottom:10px; font-family: inherit; padding: 8px; border-radius: 8px;"></textarea>
        
        <div class="color-picker" id="livroColorPicker">
            </div>

        <div class="star-rating" id="starsClickable">
            <span class="star" data-v="1">‚òÖ</span><span class="star" data-v="2">‚òÖ</span><span class="star" data-v="3">‚òÖ</span><span class="star" data-v="4">‚òÖ</span><span class="star" data-v="5">‚òÖ</span>
        </div>
        <button onclick="confirmarNovoLivro()" style="width:100%;">Salvar</button>
        <button onclick="fecharModal('modalLivroInput')" class="secundario" style="width:100%; margin-top:5px;">Cancelar</button>
    </div>
</div>

<div id="customAlertOverlay">
    <div id="customAlertBox">
        <div id="customAlertText" style="margin-bottom: 20px; font-weight: 500;">Mensagem</div>
        <input type="text" id="customAlertInput" style="display:none; width:90%; margin: 0 auto 15px; padding: 12px; border: 1px solid #ddd; border-radius: 12px;">
        <div class="alert-btns" style="display: flex; justify-content: center; gap: 10px;">
            <button id="alertConfirmBtn">Ok!</button>
            <button id="alertCancelBtn" class="cancelar">Cancelar</button>
            <button id="alertAltBtn" style="display:none; background: #2196f3;"></button>
        </div>
    </div>
</div>

<button id="abrirMenuBtn" onclick="toggleMenu()">‚ò∞ Menu</button>
<button id="btnTema" onclick="toggleDarkMode()">üåì Tema</button>


<div id="abaEsquerda">
    <h1 style="text-align: center; margin-bottom: 10px; color: var(--primary); cursor: pointer; margin-top: 10px" onclick="acessarDebugViaTitulo()">Garden Focus</h1>
    <h3 id="saudacaoUsuario" style="text-align: center; margin-bottom: 5px;">Ol√°!</h3>
    <input type="file" id="profilePhotoInput" accept="image/*" style="display:none">
    <div id="profilePhotoContainer" onclick="document.getElementById('profilePhotoInput').click()">
        <div id="profilePhotoPlaceholder">üë§</div>
        <img id="profilePhoto" alt="Foto de perfil">
    </div>
    <div id="profilePhotoLabel" onclick="document.getElementById('profilePhotoInput').click()">Clique acima para adicionar foto</div>
    
    <div id="containerMoedas" style="text-align: center; margin-bottom: 15px; font-weight: bold; color: var(--accent);">
        üí∞ Moedas: <span id="userMoedas">0</span>
    </div>
    
    <!-- BOT√ÉO 3D REMOVIDO DAQUI -->
    
    <button onclick="abrirLoja()" style="width:100%; background: #daa520; margin-bottom:10px;">üõí Loja do Jardim</button>
    <button onclick="abrirDashboard()" style="width:100%; background: #2196f3; margin-bottom:10px;">üìä Painel de Foco</button>
    <button onclick="abrirEstante()" style="width:100%; background: #8d6e63; margin-bottom:10px;">üìö Minha Estante</button>
    <button onclick="abrirConfig()" style="width:100%; background:#607d8b; margin-bottom:10px;">‚öôÔ∏è Configura√ß√µes</button>
    <div style="margin-top:30px;">
        <button id="btnTodoToggle" onclick="toggleTodoPopup()" style="width:100%; background: #4caf50; margin-bottom:10px; z-index: 1002; position: relative;">üìù Lista de Tarefas</button>
        
        <div id="todoPopup" class="todo-container">
            <div style="display:flex; gap: 5px; margin-bottom: 10px;">
                <input id="novoTodo" type="text" placeholder="Nova tarefa..." style="flex: 1; min-height: 30px; font-size: 11px; padding: 2px 8px; border-radius: 8px;">
                <button onclick="addTodo()" style="min-width: 30px; min-height: 30px; padding: 0; border-radius: 8px;">+</button>
            </div>
            <div id="listaTodo"></div>
        </div>
    </div>
    <!-- SISTEMA DE METAS -->
<div style="margin-top: 20px;">
    <button id="btnMetasToggle" onclick="toggleMetas()" style="width:100%; background: #ff9800; margin-bottom:10px; z-index: 1001; position: relative;">
        üéØ Minhas Metas
    </button>
    
    <div id="metasContainer" class="todo-container">
        <div style="display: flex; gap: 5px; margin-bottom: 10px;">
            <select id="metaMotivo" style="flex: 2; min-height: 35px; font-size: 11px;"></select>
            <select id="metaTempo" style="flex: 1; min-height: 35px; font-size: 11px;"></select>
            <button onclick="adicionarMeta()" style="min-width: 35px; min-height: 35px; padding: 0; border-radius: 8px;">+</button>
        </div>
        <div id="listaMetas">
            <!-- Metas ser√£o renderizadas aqui -->
        </div>
    </div>
</div>
    <div style="margin-top: 20px; text-align: center;">
        <button id="btnTrocarSom" onclick="proximoSom()" style="width:100%; background: #607d8b;">üîá Mudo</button>
    </div>
</div>

<div id="conteudo" onclick="fecharMenuSeAberto(event)">
    <div id="streakBadge" onclick="abrirDashboard()">‚òÄÔ∏è Dias consecutivos: <span id="streakBadgeValue">0</span></div>
    
    <div id="luckyPlantTag" class="lucky-plant-tag">Sorte do dia: ...</div>

    <div class="painel-controle">
        <div style="display: flex; align-items: center; justify-content: center; gap: 4px; flex-wrap: wrap; margin-bottom: 5px;">
            <div style="display: flex; align-items: center; gap: 2px;">
                <select id="tempoEscolhido" style="min-width: 85px;"></select>
                <button onclick="promptCustom('Tempo:', true, addTempo)" style="min-width: auto; padding: 5px 15px;">+</button>
                <button onclick="confirmarExclusaoTempo()" style="min-width: auto; padding: 5px 15px;">-</button>
            </div>
            <span style="opacity: 0.2; margin: 0 2px;">|</span>
            <div style="display: flex; align-items: center; gap: 2px;">
                <select id="motivoEscolhido" style="min-width: 110px;"></select>
                <button onclick="promptCustom('Novo motivo:', false, addMotivo)" style="min-width: auto; padding: 5px 15px;">+</button>
                <button onclick="confirmarExclusaoMotivo()" style="min-width: auto; padding: 5px 15px;">-</button>
            </div>
        </div>
        <div id="painelInteligencia"></div>
        <div id="timer">25:00</div>
        
        <div class="deep-focus-controls" style="display: none; margin-bottom: 10px;">
            <div id="plantaFocoProfundo"></div>
            <button onclick="toggleDeepFocus(false)" style="background: rgba(0,0,0,0.2); border: 1px solid var(--primary); color: var(--text-main); font-size: 12px; padding: 8px 20px;">Sair do Foco Profundo</button>
        </div>

        <div style="display: flex; justify-content: center; gap: 5px;" id="mainButtons">
            <button id="btnStart" onclick="startTimer()" style="flex: 1;">Iniciar Foco</button>
            <!-- NOVO: Bot√£o de adicionar foco manual -->
            <button id="btnAdicionarManual" onclick="adicionarFocoManual()" style="display: none; background: #666; color: white; max-width: 50px;" disabled>+</button>
            <button id="btnDeepFocus" onclick="toggleDeepFocus(true)" style="display: none; background: #673ab7;">üñ•Ô∏è Foco Profundo</button>
            <button id="btnBulldoze" onclick="bulldoze()" style="flex: 1; max-width: 50px;" title="Remover todas as plantas">üå™</button>
            <button id="btnParar" class="cancelar" onclick="cancelTimer()" style="flex: 1; max-width: 100px; display: none;">Parar</button>
        </div>
    </div>

    <!-- JARDIM 2D (MODO ORIGINAL) -->
    <div id="jardim"></div>
    
    <!-- NOVO: JARDIM 3D ISOM√âTRICO -->
    <div id="jardim3D">
        <div class="scene-3d">
            <div class="grid-container-3d" id="grid3D"></div>
        </div>
    </div>
    
    <div id="painelMotivo" style="display:none; margin-top: 20px; padding: 15px; background: var(--bg-panel); border-radius: 10px; border-left: 5px solid var(--primary); max-width: 300px; margin: 20px auto;">
        <strong>Nota:</strong> <span id="textoMotivo"></span>
    </div>
</div>

<script>
// =========================
// SISTEMA DE STORAGE SEGURO
// =========================
const StorageSeguro = {
    get: function(key, defaultValue) {
        try {
            const item = localStorage.getItem(key);
            if (item === null || item === undefined) {
                return defaultValue;
            }
            return JSON.parse(item);
        } catch (error) {
            console.warn(`Erro ao ler ${key} do localStorage:`, error);
            return defaultValue;
        }
    },
    
    set: function(key, value) {
        try {
            localStorage.setItem(key, JSON.stringify(value));
            return true;
        } catch (error) {
            console.error(`Erro ao salvar ${key} no localStorage:`, error);
            if (error.name === 'QuotaExceededError') {
                this.limparCache();
                try {
                    localStorage.setItem(key, JSON.stringify(value));
                    return true;
                } catch (e2) {
                    console.error('Falha ap√≥s limpar cache:', e2);
                }
            }
            return false;
        }
    },
    
    limparCache: function() {
        const dadosEssenciais = {
            'jardim': localStorage.getItem('jardim'),
            'totalMoedas': localStorage.getItem('totalMoedas'),
            'jogadorNome': localStorage.getItem('jogadorNome'),
            'moedasFoco': localStorage.getItem('moedasFoco'),
            'historico_foco': localStorage.getItem('historico_foco'),
            'streakDiasAtivos': localStorage.getItem('streakDiasAtivos'),
            'modo3D': localStorage.getItem('modo3D'),
            'grid10x10': localStorage.getItem('grid10x10'),
            'timerAtivo': localStorage.getItem('timerAtivo')
        };
        
        localStorage.clear();
        
        Object.entries(dadosEssenciais).forEach(([key, value]) => {
            if (value !== null) {
                localStorage.setItem(key, value);
            }
        });
    }
};

// =========================
// FUN√á√ïES PARA PRIMEIRO USO
// =========================
function mostrarPrimeiroUso() {
    document.getElementById('firstTimeOverlay').style.display = 'flex';
    document.getElementById('firstTimeContent').classList.add('modal-anim-in');
}

function pularPrimeiroUso() {
    StorageSeguro.set('jogadorNome', 'Jardineiro');
    StorageSeguro.set('vistoPrimeiroUso', true);
    document.getElementById('firstTimeOverlay').style.display = 'none';
    document.getElementById('firstTimeContent').classList.remove('modal-anim-in');
    location.reload();
}

function finalizarPrimeiroUso() {
    const nome = document.getElementById('firstTimeNameInput').value.trim();
    
    if (nome === '') {
        alert('Por favor, digite seu nome para continuar!');
        return;
    }
    
    StorageSeguro.set('vistoPrimeiroUso', true);
    StorageSeguro.set('jogadorNome', nome);
    
    document.getElementById('firstTimeOverlay').style.display = 'none';
    document.getElementById('firstTimeContent').classList.remove('modal-anim-in');
    
    location.reload();
}

// =========================
// SISTEMA DE PART√çCULAS SIMPLIFICADO E FUNCIONAL
// =========================
class ParticulasManager {
    constructor() {
        this.particulas = [];
        this.canvas = document.getElementById('bgCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.animacaoAtiva = false;
        this.ultimoTempo = 0;
        this.contadorParticulas = 0;
        this.temaAtual = 'padrao';
        this.animationId = null;
    }
    
    iniciar() {
        if (!animacaoFundoAtiva) {
            this.parar();
            return;
        }
        this.redimensionarCanvas();
        this.criarParticulas();
        this.animacaoAtiva = true;
        this.animar();
        
        window.addEventListener('resize', () => {
            this.redimensionarCanvas();
        });
    }
    
    redimensionarCanvas() {
        this.canvas.width = window.innerWidth;
        this.canvas.height = window.innerHeight;
    }
    
    criarParticulas() {
        this.particulas = [];
        // CORRE√á√ÉO: Adicionado Candyfornia
        this.contadorParticulas = modoCandyfornia ? 40 : (modoNatal ? 60 : (modoMedieval ? 30 : 20));
        // CORRE√á√ÉO: Adicionado Candyfornia
        this.temaAtual = modoCandyfornia ? 'candyfornia' : (modoNatal ? 'natal' : (modoMedieval ? 'medieval' : 'padrao'));
        
        for (let i = 0; i < this.contadorParticulas; i++) {
            this.particulas.push(this.criarParticula());
        }
    }
    
    criarParticula() {
        let cor, tamanho, velocidade;
        
        if (this.temaAtual === 'natal') {
            cor = '#FFFFFF';
            tamanho = Math.random() * 3 + 1;
            velocidade = Math.random() * 0.8 + 0.3;
        } else if (this.temaAtual === 'medieval') {
            const coresRosa = ['#FFB7C5', '#FFC0CB', '#F08080', '#FF69B4', '#F8BBD0'];
            cor = coresRosa[Math.floor(Math.random() * coresRosa.length)];
            tamanho = Math.random() * 4 + 2;
            velocidade = Math.random() * 1 + 0.5;
        } else if (this.temaAtual === 'candyfornia') {
            // NOVO: Modo Candyfornia
            const coresDoces = ['#FFB6C1', '#FF69B4', '#FF1493', '#FFC0CB', '#DB7093', '#FFD700'];
            cor = coresDoces[Math.floor(Math.random() * coresDoces.length)];
            tamanho = Math.random() * 4 + 2;
            velocidade = Math.random() * 1 + 0.5;
        } else {
            const coresVerde = ['#81C784', '#AED581', '#66BB6A', '#4CAF50', '#388E3C'];
            cor = coresVerde[Math.floor(Math.random() * coresVerde.length)];
            tamanho = Math.random() * 5 + 3;
            velocidade = Math.random() * 1.2 + 0.5;
        }
        
        return {
            x: Math.random() * this.canvas.width,
            y: Math.random() * this.canvas.height,
            tamanho: tamanho,
            velocidade: velocidade,
            cor: cor,
            oscilacao: 0,
            oscilacaoVelocidade: 0,
            rotacao: Math.random() * Math.PI * 2,
            rotacaoVelocidade: (Math.random() - 0.5) * 0.01
        };
    }
    
    animar() {
        if (!this.animacaoAtiva || !animacaoFundoAtiva) {
            if (this.animationId) {
                cancelAnimationFrame(this.animationId);
                this.animationId = null;
            }
            return;
        }
        
        this.animationId = requestAnimationFrame(() => this.animar());
        
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        
        for (let i = 0; i < this.particulas.length; i++) {
            const p = this.particulas[i];
            
            p.y += p.velocidade;
            
            if (this.temaAtual === 'padrao') {
                p.rotacao += p.rotacaoVelocidade;
            }
            
            if (p.y > this.canvas.height || p.x < -10 || p.x > this.canvas.width + 10) {
                Object.assign(p, this.criarParticula());
                p.y = -10;
            }
            
            this.ctx.save();
            this.ctx.translate(p.x, p.y);
            
            if (this.temaAtual === 'padrao') {
                this.ctx.rotate(p.rotacao);
                this.ctx.fillStyle = p.cor;
                this.ctx.beginPath();
                this.ctx.ellipse(0, 0, p.tamanho, p.tamanho / 1.5, 0, 0, Math.PI * 2);
                this.ctx.fill();
            } else if (this.temaAtual === 'medieval') {
                this.ctx.fillStyle = p.cor;
                this.ctx.beginPath();
                this.ctx.arc(0, 0, p.tamanho, 0, Math.PI * 2);
                this.ctx.fill();
                
                this.ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                this.ctx.beginPath();
                this.ctx.arc(-p.tamanho/3, -p.tamanho/3, p.tamanho/2, 0, Math.PI * 2);
                this.ctx.fill();
            } else if (this.temaAtual === 'candyfornia') {
                // NOVO: Modo Candyfornia - formas de doces
                this.ctx.fillStyle = p.cor;
                this.ctx.beginPath();
                this.ctx.arc(0, 0, p.tamanho, 0, Math.PI * 2);
                this.ctx.fill();
                
                // Brilho no centro
                this.ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
                this.ctx.beginPath();
                this.ctx.arc(-p.tamanho/4, -p.tamanho/4, p.tamanho/3, 0, Math.PI * 2);
                this.ctx.fill();
                
                // Contorno brilhante
                this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.4)';
                this.ctx.lineWidth = 1;
                this.ctx.beginPath();
                this.ctx.arc(0, 0, p.tamanho, 0, Math.PI * 2);
                this.ctx.stroke();
            } else {
                this.ctx.fillStyle = p.cor;
                this.ctx.beginPath();
                this.ctx.arc(0, 0, p.tamanho, 0, Math.PI * 2);
                this.ctx.fill();
                
                this.ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                this.ctx.beginPath();
                this.ctx.arc(-p.tamanho/4, -p.tamanho/4, p.tamanho/3, 0, Math.PI * 2);
                this.ctx.fill();
            }
            
            this.ctx.restore();
        }
    }
    
    atualizarTema() {
        this.criarParticulas();
        if (!animacaoFundoAtiva) {
            this.parar();
        }
    }
    
    parar() {
        this.animacaoAtiva = false;
        if (this.animationId) {
            cancelAnimationFrame(this.animationId);
            this.animationId = null;
        }
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
    }
}
// =========================
// SISTEMA DE EFEITOS OTIMIZADO
// =========================
class EfeitosManager {
    constructor() {
        this.pool = [];
        this.activeElements = new Set();
        this.container = null;
        this.initContainer();
    }
    
    initContainer() {
        this.container = document.createElement('div');
        this.container.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
        `;
        document.body.appendChild(this.container);
    }
    
    criarElemento() {
        const div = document.createElement('div');
        div.style.cssText = `
            position: absolute;
            top: -50px;
            font-size: 24px;
            opacity: 0.8;
            will-change: transform, opacity;
        `;
        return div;
    }
    
    obterElemento() {
        if (this.pool.length > 0) {
            return this.pool.pop();
        }
        return this.criarElemento();
    }
    
    devolverElemento(element) {
        element.style.display = 'none';
        if (this.pool.length < 50) {
            this.pool.push(element);
        }
    }
    
    chuvaDeEfeitos(emoji = 'üéâ', quantidade = 35) {
        const emojiFinal = modoNatal ? 'üéÅ' : emoji;
        
        for(let i = 0; i < quantidade; i++) {
            setTimeout(() => {
                const elemento = this.obterElemento();
                elemento.textContent = emojiFinal;
                elemento.style.left = `${Math.random() * 100}vw`;
                elemento.style.animation = `fall ${Math.random() * 2 + 2}s linear forwards`;
                elemento.style.display = 'block';
                
                this.container.appendChild(elemento);
                this.activeElements.add(elemento);
                
                setTimeout(() => {
                    if (elemento.parentNode) {
                        elemento.parentNode.removeChild(elemento);
                    }
                    this.activeElements.delete(elemento);
                    this.devolverElemento(elemento);
                }, 4000);
            }, i * 150);
        }
    }
    
    limparTodos() {
        this.activeElements.forEach(elemento => {
            if (elemento.parentNode) {
                elemento.parentNode.removeChild(elemento);
            }
            this.devolverElemento(elemento);
        });
        this.activeElements.clear();
    }
}

// =========================
// SISTEMA DE √ÅUDIO OTIMIZADO
// =========================
class AudioManager {
    constructor() {
        this.audioCtx = null;
        this.noiseNode = null;
        this.currentSound = null;
        this.somAtualIdx = 0;
        this.sonsAmbiente = [
            { nome: "üîá Mudo", tipo: null },
            { nome: "üåßÔ∏è Chuva", tipo: "chuva" },
            { nome: "üå¨Ô∏è Vento", tipo: "vento" }
        ];
    }
    
    init() {
        this.somAtualIdx = parseInt(localStorage.getItem('somAtualIdx') || '0');
        document.getElementById('btnTrocarSom').textContent = this.sonsAmbiente[this.somAtualIdx].nome;
        this.tocarSomAtual();
    }
    
    fecharContexto() {
        if (this.audioCtx) {
            try {
                if (this.audioCtx.state !== 'closed') {
                    this.audioCtx.close();
                }
            } catch (e) {
                console.warn("Erro ao fechar audio context:", e);
            }
            this.audioCtx = null;
        }
        this.noiseNode = null;
        this.currentSound = null;
    }
    
    criarNoise(type) {
        this.fecharContexto();
        
        try {
            this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            
            if (type === null) {
                return;
            }
            
            const bufferSize = 2 * this.audioCtx.sampleRate;
            const noiseBuffer = this.audioCtx.createBuffer(1, bufferSize, this.audioCtx.sampleRate);
            const output = noiseBuffer.getChannelData(0);
            let lastOut = 0.0;
            
            for (let i = 0; i < bufferSize; i++) {
                const white = Math.random() * 2 - 1;
                output[i] = (lastOut + (0.02 * white)) / 1.02;
                lastOut = output[i];
                output[i] *= 3.5;
            }
            
            this.noiseNode = this.audioCtx.createBufferSource();
            this.noiseNode.buffer = noiseBuffer;
            this.noiseNode.loop = true;
            
            const filter = this.audioCtx.createBiquadFilter();
            filter.type = "lowpass";
            
            if (type === "chuva") {
                filter.frequency.value = 1000;
            } else if (type === "vento") {
                filter.frequency.value = 400;
                const lfo = this.audioCtx.createOscillator();
                const lfoGain = this.audioCtx.createGain();
                lfo.frequency.value = 0.2;
                lfoGain.gain.value = 200;
                lfo.connect(lfoGain);
                lfoGain.connect(filter.frequency);
                lfo.start();
            }
            
            this.noiseNode.connect(filter);
            filter.connect(this.audioCtx.destination);
            this.noiseNode.start();
            
            this.currentSound = type;
            
        } catch (e) {
            console.error("Erro ao criar √°udio:", e);
            this.fecharContexto();
        }
    }
    
    proximoSom() {
        this.somAtualIdx = (this.somAtualIdx + 1) % this.sonsAmbiente.length;
        StorageSeguro.set('somAtualIdx', this.somAtualIdx);
        
        const novoSom = this.sonsAmbiente[this.somAtualIdx].nome;
        document.getElementById('btnTrocarSom').textContent = novoSom;
        
        this.criarNoise(this.sonsAmbiente[this.somAtualIdx].tipo);
    }
    
    tocarSomAtual() {
        const tipoAtual = this.sonsAmbiente[this.somAtualIdx].tipo;
        this.criarNoise(tipoAtual);
    }
    
    parar() {
        this.fecharContexto();
    }
    
    tocarSino() {
        if (!sinoAtivo) return;
        
        try {
            const context = new (window.AudioContext || window.webkitAudioContext)();
            const osc = context.createOscillator();
            const gain = context.createGain();
            
            osc.type = "sine";
            osc.frequency.setValueAtTime(880, context.currentTime);
            osc.frequency.exponentialRampToValueAtTime(440, context.currentTime + 1);
            
            gain.gain.setValueAtTime(0.3, context.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, context.currentTime + 1);
            
            osc.connect(gain);
            gain.connect(context.destination);
            
            osc.start();
            
            setTimeout(() => {
                try {
                    if (context.state !== 'closed') {
                        context.close();
                    }
                } catch (e) {
                    // Ignorar erro ao fechar
                }
            }, 1500);
            
            osc.stop(context.currentTime + 1);
        } catch (e) {
            console.error("Erro ao tocar sino:", e);
        }
    }
}

const ITENS_PADRAO = ['üå≤','üå≥','üå¥','üåµ','üåæ','üåø','‚òòÔ∏è','üåª','üåπ','üå∑','üçÑ','üçÑ‚Äçüü´','‚õ∞Ô∏è','üè†','üèØ','üè∞','‚õ™Ô∏è','‚õ©Ô∏è','ü™¥','‚õ≤Ô∏è','ü™®','üïå','üõï','üóº','üåà','ü™ß','üóø'];
const ITENS_NATAL = ['üéÑ','üéÅ','üéÖ','ü§∂','‚õÑ','‚ùÑÔ∏è','ü¶å','üïØÔ∏è','üîî','üç™','ü•õ','üç¨','ü•ß','üß£','üß§'];
const ITENS_MEDIEVAL = ['üè∞','üèØ','‚öîÔ∏è','üõ°Ô∏è','üëë','üìú','üç∫','üçû','üçó','üïØÔ∏è','üõñ','‚õ∫','üèπ','üèá','üê≤','üî•'];
const ITENS_CANDYFORNIA = ['üç¨','üç≠','üç´','üç©','üç™','üéÇ','üç∞','üßÅ','ü•ß','üç®','üçß','üç¶','üçØ','üçÆ','‚òïÔ∏è','ü•§','üçπ','üßã','ü•ê','üçø'];
const CORES_LIVROS = ['#2e7d32', '#1565c0', '#c62828', '#ef6c00', '#6a1b9a', '#795548'];

const PROGRESSAO = {
    'üå≤': {estagio: 'üå±', final: 'üå≤'},
    'üå≥': {estagio: 'üå±', final: 'üå≥'},
    'üå¥': {estagio: 'üå±', final: 'üå¥'},
    'üåµ': {estagio: 'üå±', final: 'üåµ'},
    'üåæ': {estagio: 'üå±', final: 'üåæ'},
    'üåø': {estagio: 'üå±', final: 'üåø'},
    '‚òòÔ∏è': {estagio: 'üå±', final: '‚òòÔ∏è'},
    'üåª': {estagio: 'üå±', final: 'üåª'},
    'üåπ': {estagio: 'üå±', final: 'üåπ'},
    'üå∑': {estagio: 'üå±', final: 'üå∑'},
    'üçÑ': {estagio: 'ü´ò', final: 'üçÑ'},
    'üçÑ‚Äçüü´': {estagio: 'ü´ò', final: 'üçÑ‚Äçüü´'},
    'üè†': {estagio: 'üèóÔ∏è', final: 'üè†'},
    'üèØ': {estagio: 'üèóÔ∏è', final: 'üèØ'},
    'üè∞': {estagio: 'üèóÔ∏è', final: 'üè∞'},
    '‚õ™Ô∏è': {estagio: 'üèóÔ∏è', final: '‚õ™Ô∏è'},
    '‚õ©Ô∏è': {estagio: 'üèóÔ∏è', final: '‚õ©Ô∏è'},
    'ü™¥': {estagio: 'üå±', final: 'ü™¥'},
    '‚õ≤Ô∏è': {estagio: 'üèóÔ∏è', final: '‚õ≤Ô∏è'},
    'ü™®': {estagio: 'ü™®', final: 'ü™®'},
    'üïå': {estagio: 'üèóÔ∏è', final: 'üïå'},
    'üõï': {estagio: 'üèóÔ∏è', final: 'üõï'},
    'üóº': {estagio: 'üèóÔ∏è', final: 'üóº'},
    'üåà': {estagio: '‚òÅÔ∏è', final: 'üåà'},
    'ü™ß': {estagio: 'ü™ß', final: 'ü™ß'},
    'üóø': {estagio: 'ü™®', final: 'üóø'},
    'üéÑ': {estagio: 'üå≤', final: 'üéÑ'},
    'üéÅ': {estagio: 'üì¶', final: 'üéÅ'},
    'üéÖ': {estagio: 'üß¶', final: 'üéÖ'},
    '‚öîÔ∏è': {estagio: '‚öíÔ∏è', final: '‚öîÔ∏è'},
    'üõ°Ô∏è': {estagio: '‚öíÔ∏è', final: 'üõ°Ô∏è'},
    'üëë': {estagio: 'üíé', final: 'üëë'},
    'default': {estagio: '‚è≥Ô∏è', final: null}
};

// Inst√¢ncias dos sistemas otimizados
const particulasManager = new ParticulasManager();
const efeitosManager = new EfeitosManager();
const audioManager = new AudioManager();

// Dados do jogo
let tempos = StorageSeguro.get('tempos', [1, 5, 10, 15, 25, 45, 60, 90]);
let motivos = StorageSeguro.get('motivos', ["Estudo", "Trabalho", "Leitura", "Sa√∫de"]);
let modoNatal = StorageSeguro.get('modoNatal', false);
let modoMedieval = StorageSeguro.get('modoMedieval', false);
let medievalComprado = StorageSeguro.get('medievalComprado', false);
let modoCandyfornia = StorageSeguro.get('modoCandyfornia', false);
let candyforniaComprado = StorageSeguro.get('candyforniaComprado', false);
let exibirEstrelas = StorageSeguro.get('exibirEstrelas', true);
let animacaoFundoAtiva = StorageSeguro.get('animacaoFundoAtiva', true);
let escolhido = StorageSeguro.get('plantaEscolhida', (modoCandyfornia ? ITENS_CANDYFORNIA : (modoNatal ? ITENS_NATAL : (modoMedieval ? ITENS_MEDIEVAL : ITENS_PADRAO)))[0]);
let alvo = null, intervalo = null;
let jardimData = StorageSeguro.get('jardim', Array(25).fill(null));
let todos = StorageSeguro.get('todos', []);
let estante = StorageSeguro.get('estante_livros', []);
let sessoesTotais = StorageSeguro.get('sessoesTotais', 0);
let historico = StorageSeguro.get('historico_foco', []);
let totalMoedas = StorageSeguro.get('moedasFoco', 0);
let streakDiasAtivos = StorageSeguro.get('streakDiasAtivos', 0);
let luckyPlant = "";
let notaTemp = 0;
let corLivroTemp = CORES_LIVROS[0];
let sinoAtivo = StorageSeguro.get('sinoAtivo', true);
let temaAutomaticoAtivo = StorageSeguro.get('temaAutoAtivo', true);
let mostrarAvisoInicio = StorageSeguro.set('mostrarAvisoInicio', true);
let mostrarPrevisao = StorageSeguro.get('mostrarPrevisao', true);
let metas = StorageSeguro.get('metas', []);
let modo3D = StorageSeguro.set('modo3D', false);
let aviso3DJaVisto = StorageSeguro.set('aviso3DJaVisto', false);
// NOVO: Sistema para manter tela ativa
let wakeLock = null;
let manterTelaAtiva = StorageSeguro.get('manterTelaAtiva', true);
// NOVO: Modo grid 10x10
let grid10x10 = StorageSeguro.get('grid10x10', false);

// =========================
// FUN√á√ïES DE PERSIST√äNCIA DO TIMER - CORRIGIDAS
// =========================
function salvarTimerAtivo() {
    if (!intervalo) {
        StorageSeguro.set('timerAtivo', null);
        return;
    }
    
    const motivo = document.getElementById('motivoEscolhido').value;
    const tempoEscolhido = document.getElementById('tempoEscolhido').value;
    
    // Calcular o tempo restante do display
    const timerText = document.getElementById('timer').textContent;
    const [minutos, segundos] = timerText.split(':').map(Number);
    const tempoRestante = minutos * 60 + segundos;
    
    const timerData = {
        alvo: alvo,
        inicio: Date.now() - (tempoEscolhido * 60 - tempoRestante) * 1000, // Tempo de in√≠cio ajustado
        duracao: tempoEscolhido * 60, // em segundos
        motivo: motivo,
        escolhido: escolhido,
        tempoRestante: tempoRestante
    };
    
    StorageSeguro.set('timerAtivo', timerData);
}

function recriarTimerSeExistir() {
    const timerData = StorageSeguro.get('timerAtivo', null);
    
    if (!timerData) {
        return;
    }
    
    const agora = Date.now();
    const tempoPassado = Math.floor((agora - timerData.inicio) / 1000); // em segundos
    let tempoRestante = timerData.duracao - tempoPassado; // MUDAN√áA: usar let em vez de const
    
    if (tempoRestante <= 0) {
        // Timer j√° expirou, finalizar o foco
        StorageSeguro.set('timerAtivo', null);
        
        // Verificar se j√° foi registrado no hist√≥rico
        const hoje = new Date().toISOString().split('T')[0];
        const jaRegistrado = historico.some(s => {
            const sessaoData = new Date(s.data).toISOString().split('T')[0];
            return sessaoData === hoje && s.status === 'sucesso' && s.motivo === timerData.motivo;
        });
        
        if (!jaRegistrado) {
            // Finalizar como sucesso
            alvo = timerData.alvo;
            escolhido = timerData.escolhido;
            document.getElementById('motivoEscolhido').value = timerData.motivo;
            document.getElementById('tempoEscolhido').value = timerData.duracao / 60;
            
            const emojiFinal = evoluirEmoji(escolhido);
            const isLucky = escolhido === luckyPlant;
            
            jardimData[alvo] = { 
                icone: emojiFinal, 
                motivo: timerData.motivo, 
                lucky: isLucky,
                emProgresso: false 
            };
            
            sessoesTotais++;
            historico.push({ 
                data: new Date(timerData.inicio).toISOString(), 
                minutos: timerData.duracao / 60, 
                motivo: timerData.motivo, 
                icone: emojiFinal, 
                mes: new Date(timerData.inicio).getMonth(), 
                ano: new Date(timerData.inicio).getFullYear(), 
                status: 'sucesso' 
            });
            
            updateMoedas(isLucky ? 2 : 1);
            atualizarStreak();
            salvarTudo();
            renderSelects();
        }
        
        return;
    }
    
    // Recriar o timer
    alvo = timerData.alvo;
    escolhido = timerData.escolhido;
    document.getElementById('motivoEscolhido').value = timerData.motivo;
    document.getElementById('tempoEscolhido').value = timerData.duracao / 60;
    
    const emojiEstagio = obterEmojiEstagio(escolhido);
    jardimData[alvo] = { 
        icone: emojiEstagio, 
        motivo: timerData.motivo, 
        lucky: false,
        emProgresso: true,
        emojiFinal: escolhido
    };
    
    renderJardim();
    document.getElementById('painelInteligencia').style.display = 'none';
    document.getElementById('btnStart').style.display = 'none';
    document.getElementById('btnDeepFocus').style.display = 'block';
    document.getElementById('btnParar').style.display = 'block';
    
    // CORRE√á√ÉO: Usar closure para manter a refer√™ncia √† vari√°vel tempoRestante
    intervalo = setInterval(() => { 
        tempoRestante--; 
        let m = Math.floor(tempoRestante/60), s = tempoRestante%60; 
        document.getElementById('timer').textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; 
        if(tempoRestante <= 0) {
            finalizarFoco(); gerenciarTelaAtiva(false);
            limparTimerAtivo();
        } else {
            salvarTimerAtivo(); // Salvar periodicamente
        }
    }, 1000);
    
    // Atualizar display imediatamente
    let m = Math.floor(tempoRestante/60), s = tempoRestante%60; 
    document.getElementById('timer').textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    
    atualizarBotoes();
    
    // Salvar novamente para manter atualizado
    salvarTimerAtivo();
}

function limparTimerAtivo() {
    StorageSeguro.set('timerAtivo', null);
}

// =========================
// FUN√á√ïES EXISTENTES MODIFICADAS
// =========================
function iniciarTimer() {


    let tempo = document.getElementById('tempoEscolhido').value * 60; 
    
    const emojiEstagio = obterEmojiEstagio(escolhido);
    jardimData[alvo] = { 
        icone: emojiEstagio, 
        motivo: document.getElementById('motivoEscolhido').value, 
        lucky: false,
        emProgresso: true,
        emojiFinal: escolhido
    };
    
    renderJardim();
    
    // CORRE√á√ÉO: Usar let para a vari√°vel tempo que ser√° decrementada
    let tempoRestante = tempo; // Vari√°vel local que ser√° decrementada
    
    intervalo = setInterval(() => { 
        tempoRestante--; 
        let m = Math.floor(tempoRestante/60), s = tempoRestante%60; 
        document.getElementById('timer').textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; 
        if(tempoRestante <= 0) {
            finalizarFoco(); 
            limparTimerAtivo();
        } else {
            salvarTimerAtivo(); // Salvar periodicamente
        }
    }, 1000);
    
    // Salvar o timer ativo imediatamente
    salvarTimerAtivo();
    
    atualizarBotoes();
}

function finalizarFoco() { 
    // NOVO: Desativar manuten√ß√£o de tela
    if (wakeLock) {
        wakeLock.release();
        wakeLock = null;
    }
    enviarNotificacaoPlantaCresceu();
    
    const tempoMin = parseInt(document.getElementById('tempoEscolhido').value); 
    const motivo = document.getElementById('motivoEscolhido').value; 
    const agora = new Date(); clearInterval(intervalo); intervalo = null; 
    toggleDeepFocus(false);
    document.getElementById('btnDeepFocus').style.display = 'none';
    document.getElementById('btnStart').style.display = 'block';
    document.getElementById('btnParar').style.display = 'none';
    const isLucky = escolhido === luckyPlant;
    
    const emojiFinal = evoluirEmoji(escolhido);
    jardimData[alvo] = { 
        icone: emojiFinal, 
        motivo: motivo, 
        lucky: isLucky,
        emProgresso: false 
    }; 
    
    sessoesTotais++; 
    historico.push({ 
        data: agora.toISOString(), 
        minutos: tempoMin, 
        motivo: motivo, 
        icone: emojiFinal, 
        mes: agora.getMonth(), 
        ano: agora.getFullYear(), 
        status: 'sucesso' 
    }); 
    
    updateMoedas(isLucky ? 2 : 1); 
    // Verificar metas
verificarMetasConcluidas(motivo, tempoMin);
    
    showModal({ text: `Conseguimos! ${tempoMin} min de foco! üéØ`, onConfirm: () => {} });
    
    tocarSino(); 
    chuvaDeEfeitos(); 
    
    let plot;
    if (modo3D) {
        const cells = document.querySelectorAll('.cell-3d');
        plot = cells[alvo];
    } else {
        plot = document.querySelectorAll('.plot')[alvo];
    }
    
    const iconSpan = plot.querySelector('span');
    if (iconSpan) {
        iconSpan.textContent = emojiFinal;
        iconSpan.classList.add('crescendo');
        setTimeout(() => iconSpan.classList.remove('crescendo'), 500);
    }
    
    alvo = null; 
    atualizarStreak();
    
    // Limpar o timer ativo do storage
    limparTimerAtivo();
    
    salvarTudo(); 
    renderSelects();
    atualizarBotoes();
    
    const totalCells = getTotalCells();
    if(jardimData.filter(x => x !== null).length === totalCells) triggerFinalSequence();
}

function cancelTimer() { 
            
    
    if(intervalo) {
        showModal({ 
            text: "Desistir?", 
            onConfirm: () => { 
                // NOVO: Desativar manuten√ß√£o de tela
                if (wakeLock) {
                    wakeLock.release();
                    wakeLock = null;
                }
                clearInterval(intervalo); intervalo = null; 
                const failureEmoji = getFailureEmoji(escolhido);
                if(alvo !== null) jardimData[alvo] = { icone: failureEmoji, motivo: document.getElementById('motivoEscolhido').value + " (Falha)", lucky: false };
                historico.push({ data: new Date().toISOString(), minutos: 0, motivo: document.getElementById('motivoEscolhido').value, status: 'falha' });
                alvo = null; toggleDeepFocus(false);
                document.getElementById('btnDeepFocus').style.display = 'none';
                document.getElementById('btnStart').style.display = 'block';
                document.getElementById('btnParar').style.display = 'none';
                
                // Limpar o timer ativo do storage
                limparTimerAtivo();
                
                salvarTudo(); renderSelects();
                atualizarBotoes(); gerenciarTelaAtiva(false);
            }
        }); 
    }
}

function mostrarInfoEstante() {
    const LIVROS_POR_ANDAR = 12;
    const totalAndares = Math.ceil(estante.length / LIVROS_POR_ANDAR);
    const livrosComNotaMaxima = estante.filter(l => l.nota === 5).length;
    
    let mensagem = `<strong>üìä Estat√≠sticas da Estante</strong><br><br>`;
    mensagem += `üìö <strong>Livros totais:</strong> ${estante.length}<br>`;
    mensagem += `üèóÔ∏è <strong>Andares:</strong> ${totalAndares}<br>`;
    mensagem += `‚≠ê <strong>Livros com nota m√°xima (5):</strong> ${livrosComNotaMaxima}<br>`;
    mensagem += `üìà <strong>Capacidade atual:</strong> ${estante.length}/${totalAndares * LIVROS_POR_ANDAR} livros<br><br>`;
    mensagem += `üéØ <small>Cada andar suporta at√© ${LIVROS_POR_ANDAR} livros. Continue lendo para expandir sua biblioteca!</small>`;
    
    showModal({ 
        text: mensagem, 
        onConfirm: () => {} 
    });
}

// =========================
// TUTORIAL INTERATIVO (SIMPLIFICADO)
// =========================
const TUTORIAL_STEPS = [
    {
        icon: 'üå±',
        title: 'Bem-vindo ao Garden Focus!',
        text: 'Seu jardim est√° pronto para florecer! Vamos ver o essencial para come√ßar a focar.',
        location: null
    },
    {
        icon: 'ü™¥',
        title: 'Seu Jardim',
        text: '√â onde suas plantas e constru√ß√µes crescem. Clique em um espa√ßo vazio sempre que quiser focar.',
        location: 'jardim'
    },
    {
        icon: '‚è±Ô∏è',
        title: 'Timer e Motivo',
        text: 'Defina o tempo de foco e o motivo. Clique em "Iniciar Foco" para come√ßar.',
        location: 'timer'
    },
    {
        icon: '‚ò∞',
        title: 'Menu Principal',
        text: 'Acesse a Estante e Configura√ß√µes por aqui.',
        location: 'menu'
    },
    {
        icon: 'üöÄ',
        title: 'Pronto para Focar!',
        text: 'Foque, veja seu jardim crescer e divirta-se! Boa jornada!',
        location: null
    }
];

let tutorialAtual = 0;
let tutorialAtivo = false;

function iniciarTutorial() {
    fecharModal('configOverlay');
    fecharModal('firstTimeOverlay');
    
    tutorialAtual = 0;
    tutorialAtivo = true;
    
    const overlay = document.getElementById('tutorialOverlay');
    overlay.style.display = 'flex';
    
    renderizarProgressoTutorial();
    mostrarPassoTutorial();
}

function renderizarProgressoTutorial() {
    const progressContainer = document.getElementById('tutorialProgress');
    progressContainer.innerHTML = '';
    
    TUTORIAL_STEPS.forEach((_, index) => {
        const dot = document.createElement('div');
        dot.className = 'tutorial-progress-dot';
        if (index < tutorialAtual) dot.classList.add('completed');
        if (index === tutorialAtual) dot.classList.add('active');
        progressContainer.appendChild(dot);
    });
}

function mostrarPassoTutorial() {
    const step = TUTORIAL_STEPS[tutorialAtual];
    const icon = document.getElementById('tutorialIcon');
    const title = document.getElementById('tutorialTitle');
    const text = document.getElementById('tutorialText');
    const locationDiv = document.getElementById('tutorialLocation');
    const locationText = document.getElementById('tutorialLocationText');
    const prevBtn = document.getElementById('tutorialPrevBtn');
    const nextBtn = document.getElementById('tutorialNextBtn');
    const stepCounter = document.getElementById('tutorialStepCounter');
    
    icon.textContent = step.icon;
    title.textContent = step.title;
    text.innerHTML = step.text;
    stepCounter.textContent = `Passo ${tutorialAtual + 1} de ${TUTORIAL_STEPS.length}`;
    
    if (step.location) {
        locationDiv.style.display = 'flex';
        locationText.innerHTML = step.location;
    } else {
        locationDiv.style.display = 'none';
    }
    
    prevBtn.style.display = tutorialAtual === 0 ? 'none' : 'block';
    nextBtn.textContent = tutorialAtual === TUTORIAL_STEPS.length - 1 ? 'Concluir' : 'Pr√≥ximo';
    
    renderizarProgressoTutorial();
}

function tutorialProximo() {
    if (tutorialAtual < TUTORIAL_STEPS.length - 1) {
        tutorialAtual++;
        mostrarPassoTutorial();
    } else {
        finalizarTutorial();
    }
}

function tutorialAnterior() {
    if (tutorialAtual > 0) {
        tutorialAtual--;
        mostrarPassoTutorial();
    }
}

function tutorialPular() {
    finalizarTutorial();
}

function finalizarTutorial() {
    tutorialAtivo = false;
    const overlay = document.getElementById('tutorialOverlay');
    overlay.style.display = 'none';
    
    StorageSeguro.set('tutorialVisto', true);
}

function verificarPrimeiroAcesso() {
    const tutorialVisto = StorageSeguro.get('tutorialVisto', false);
    const nomeUsuario = StorageSeguro.get('jogadorNome', null);
    
    if (!tutorialVisto && nomeUsuario) {
        setTimeout(() => {
            iniciarTutorial();
        }, 500);
    }
}

// =========================
// FUN√á√ÉO PARA AJUSTE DIN√ÇMICO DO 3D
// =========================
function ajustarTamanho3D() {
    if (!modo3D) return;
    
    const jardim3D = document.getElementById('jardim3D');
    const grid3D = document.getElementById('grid3D');
    const gridSize = getGridSize();
    
    if (!jardim3D || !grid3D) return;
    
    // Calcular tamanho baseado na viewport
    const viewportWidth = window.innerWidth;
    const viewportHeight = window.innerHeight;
    const isMobile = viewportWidth <= 899;
    const isLandscape = viewportWidth > viewportHeight;
    
    let cellSize, scaleFactor = 1;
    
    if (isMobile) {
        if (grid10x10) {
            // Grid 10x10 em mobile
            if (isLandscape) {
                cellSize = Math.min(viewportHeight * 0.08, 35);
                scaleFactor = 0.7;
            } else {
                cellSize = Math.min(viewportWidth * 0.08, 32);
                scaleFactor = 0.8;
            }
        } else {
            // Grid 5x5 em mobile
            if (isLandscape) {
                cellSize = Math.min(viewportHeight * 0.12, 45);
                scaleFactor = 0.8;
            } else {
                cellSize = Math.min(viewportWidth * 0.15, 45);
                scaleFactor = 0.9;
            }
        }
    } else {
        // Desktop
        if (grid10x10) {
            cellSize = Math.min(viewportWidth * 0.045, 45);
            scaleFactor = 0.9;
        } else {
            cellSize = Math.min(viewportWidth * 0.07, 84);
            scaleFactor = 1;
        }
    }
    
    // Aplicar tamanho m√≠nimo
    cellSize = Math.max(cellSize, grid10x10 ? 25 : 30);
    
    // Aplicar as mudan√ßas
    document.documentElement.style.setProperty('--cell-3d-size', `${cellSize}px`);
    document.documentElement.style.setProperty('--scale-3d', scaleFactor.toString());
    
    // Adicionar classe de ajuste
    grid3D.classList.add('ajustado');
    
    // Ajustar altura do container
    const projectedHeight = cellSize * gridSize * 0.866; // sin(60) ‚âà 0.866
    jardim3D.style.height = `${projectedHeight}px`;
    
    // Ajustar emojis
    const emojis = document.querySelectorAll('.emoji-3d');
    emojis.forEach(emoji => {
        const translateY = -cellSize * 0.46;
        emoji.style.transform = `rotateZ(-45deg) rotateX(-90deg) translateY(${translateY}px) scaleY(1)`;
    });
}

function toggleModo3D() {
    if (!modo3D && !aviso3DJaVisto) {
        abrirAviso3D();
        return;
    }
    
    modo3D = !modo3D;
    StorageSeguro.set('modo3D', modo3D);
    atualizarVisibilidadeModo3D();
    renderJardim();
    
    const btn3DConfig = document.getElementById('btn3DToggle');
    if (btn3DConfig) {
        btn3DConfig.classList.toggle('on', modo3D);
    }
    
    // Ajustar tamanho ap√≥s ativar/desativar
    if (modo3D) {
        setTimeout(ajustarTamanho3D, 100);
    }
}

function abrirAviso3D() {
    document.getElementById('aviso3DOverlay').style.display = 'flex';
}

function fecharAviso3D() {
    document.getElementById('aviso3DOverlay').style.display = 'none';
    aviso3DJaVisto = true;
    StorageSeguro.set('aviso3DJaVisto', true);
    
    modo3D = true;
    StorageSeguro.set('modo3D', modo3D);
    atualizarVisibilidadeModo3D();
    renderJardim();
    
    const btn3DConfig = document.getElementById('btn3DToggle');
    if (btn3DConfig) {
        btn3DConfig.classList.toggle('on', modo3D);
    }
    
    // Ajustar tamanho ap√≥s ativar
    setTimeout(ajustarTamanho3D, 100);
}

function atualizarVisibilidadeModo3D() {
    const jardim2D = document.getElementById('jardim');
    const jardim3D = document.getElementById('jardim3D');
    
    if (modo3D) {
        jardim2D.style.display = 'none';
        jardim3D.style.display = 'block';
    } else {
        jardim2D.style.display = 'grid';
        jardim3D.style.display = 'none';
    }
}

function renderJardim3D() {
    const container = document.getElementById('grid3D');
    container.innerHTML = '';
    
    const gridSize = getGridSize();
    const jardim3D = document.getElementById('jardim3D');
    
    // Aplicar ajuste din√¢mico
    ajustarTamanho3D();
    
    // Configurar grid
    container.style.gridTemplateColumns = `repeat(${gridSize}, var(--cell-3d-size))`;
    container.style.gridTemplateRows = `repeat(${gridSize}, var(--cell-3d-size))`;
    
    
    jardimData.forEach((item, i) => {
        const cell = document.createElement('div');
        cell.className = 'cell-3d' + (i === alvo ? ' alvo' : '');
        
        if (intervalo && i !== alvo) {
            cell.style.pointerEvents = 'none';
            cell.style.opacity = '0.7';
        } else {
            cell.style.pointerEvents = 'auto';
            cell.style.opacity = '1';
        }
        
        if (item) {
            const emoji = document.createElement('span');
            emoji.className = 'emoji-3d';
            emoji.textContent = item.icone;
            
            if (item.emProgresso) {
                emoji.classList.add('plant-spawn');
                emoji.style.animation = 'pulsar 1.5s infinite';
            } else if (item.lucky) {
                emoji.classList.add('lucky-glow');
            }
            
            cell.appendChild(emoji);
        } else if (i === alvo && escolhido && !intervalo) {
            const ghost = document.createElement('span');
            ghost.className = 'emoji-3d fantasma';
            ghost.textContent = escolhido;
            cell.appendChild(ghost);
        }
        
        cell.onclick = () => {
            if (intervalo) return;
            
            if (item) {
                document.getElementById('painelMotivo').style.display = 'block';
                document.getElementById('textoMotivo').textContent = `Focado em: ${item.motivo}`;
            } else {
                abrirModalPlanta(i);
            }
        };
        
        container.appendChild(cell);
    });
}

function getFailureEmoji(emoji) {
    const plantas = ['üå≤','üå≥','üå¥','üåµ','üåæ','üåø','‚òòÔ∏è','üåª','üåπ','üå∑','üçÑ','üçÑ‚Äçüü´','ü™¥'];
    const construcoes = ['üè†','üèØ','üè∞','‚õ™Ô∏è','‚õ©Ô∏è','üõñ','üïå','üõï','üóº'];
    
    if (emoji === 'üåπ') return 'ü•Ä';
    if (emoji === 'üéÅ') return 'ü™§';
    if (construcoes.includes(emoji)) return 'üèö';
    if (plantas.includes(emoji)) return 'ü™æ';
    
    return 'ü™æ';
}

function calcularStreakDiasAtivos() {
    if (historico.length === 0) {
        streakDiasAtivos = 0;
        StorageSeguro.set('streakDiasAtivos', streakDiasAtivos);
        return;
    }
    
    const historicoOrdenado = [...historico].sort((a, b) => new Date(b.data) - new Date(a.data));
    const sucessos = historicoOrdenado.filter(s => s.status === 'sucesso');
    
    if (sucessos.length === 0) {
        streakDiasAtivos = 0;
        StorageSeguro.set('streakDiasAtivos', streakDiasAtivos);
        return;
    }
    
    const hoje = new Date();
    hoje.setHours(0, 0, 0, 0);
    
    const ontem = new Date(hoje);
    ontem.setDate(hoje.getDate() - 1);
    
    let streak = 0;
    let dataAtual = new Date(hoje);
    
    const temSessaoHoje = sucessos.some(s => {
        const dataSessao = new Date(s.data);
        dataSessao.setHours(0, 0, 0, 0);
        return dataSessao.getTime() === hoje.getTime();
    });
    
    if (!temSessaoHoje) {
        const temSessaoOntem = sucessos.some(s => {
            const dataSessao = new Date(s.data);
            dataSessao.setHours(0, 0, 0, 0);
            return dataSessao.getTime() === ontem.getTime();
        });
        
        if (temSessaoOntem) {
            streakDiasAtivos = StorageSeguro.get('streakDiasAtivos', 0);
            return;
        } else {
            streakDiasAtivos = 0;
            StorageSeguro.set('streakDiasAtivos', streakDiasAtivos);
            return;
        }
    }
    
    let diaContador = 0;
    let encontrouFalha = false;
    
    while (!encontrouFalha && diaContador < 365) {
        const dataVerificar = new Date(hoje);
        dataVerificar.setDate(hoje.getDate() - diaContador);
        dataVerificar.setHours(0, 0, 0, 0);
        
        const temSessaoNesseDia = sucessos.some(s => {
            const dataSessao = new Date(s.data);
            dataSessao.setHours(0, 0, 0, 0);
            return dataSessao.getTime() === dataVerificar.getTime();
        });
        
        if (temSessaoNesseDia) {
            streak++;
            diaContador++;
        } else {
            encontrouFalha = true;
        }
    }
    
    streakDiasAtivos = streak;
    StorageSeguro.set('streakDiasAtivos', streakDiasAtivos);
}

function atualizarStreak() {
    calcularStreakDiasAtivos();
    document.getElementById('streakBadgeValue').textContent = streakDiasAtivos;
}

function criarParticulas() {
    particulasManager.atualizarTema();
}

function toggleAnimacaoFundo() {
    animacaoFundoAtiva = !animacaoFundoAtiva;
    StorageSeguro.set('animacaoFundoAtiva', animacaoFundoAtiva);
    
    const btn = document.getElementById('btnAnimFundo');
    btn.classList.toggle('on', animacaoFundoAtiva);
    
    if (animacaoFundoAtiva) {
        particulasManager.iniciar();
    } else {
        particulasManager.parar();
    }
}

function chuvaDeEfeitos() {
    efeitosManager.chuvaDeEfeitos();
}

function proximoSom() {
    audioManager.proximoSom();
}

function tocarSino() {
    audioManager.tocarSino();
}

function abrirModal(id) {
    const el = document.getElementById(id);
    const content = el.querySelector('#' + id.replace('Overlay', 'Content')) || el.querySelector('div');
    el.style.display = 'flex';
    content.classList.remove('modal-anim-out');
    content.classList.add('modal-anim-in');
}

function fecharModal(id) {
    const el = document.getElementById(id);
    const content = el.querySelector('#' + id.replace('Overlay', 'Content')) || el.querySelector('div');
    content.classList.remove('modal-anim-in');
    content.classList.add('modal-anim-out');
    setTimeout(() => {
        el.style.display = 'none';
        content.classList.remove('modal-anim-out');
    }, 200);
}

function openStartFocusModal() {
    document.getElementById('startFocusModalOverlay').style.display = 'flex';
    document.getElementById('startFocusModalContent').classList.add('modal-anim-in');
    document.getElementById('dontShowAgainCheckbox').checked = !mostrarAvisoInicio;
}

function closeStartFocusModal(startTimer) {
    const dontShow = document.getElementById('dontShowAgainCheckbox').checked;
    mostrarAvisoInicio = !dontShow;
    StorageSeguro.set('mostrarAvisoInicio', mostrarAvisoInicio);
    
    document.getElementById('startFocusModalOverlay').style.display = 'none';
    document.getElementById('startFocusModalContent').classList.remove('modal-anim-in');
    
    if (startTimer) {
        iniciarTimer();
    }
}

function atualizarBotoes() {
    const btnStart = document.getElementById('btnStart');
    const btnAdicionarManual = document.getElementById('btnAdicionarManual');
    const btnDeepFocus = document.getElementById('btnDeepFocus');
    const btnBulldoze = document.getElementById('btnBulldoze');
    const btnParar = document.getElementById('btnParar');
    
    if (intervalo) {
        btnStart.style.display = 'none';
        btnAdicionarManual.style.display = 'none';
        btnDeepFocus.style.display = 'block';
        btnBulldoze.style.display = 'none';
        btnParar.style.display = 'block';
    } else {
        if (alvo !== null) {
            btnStart.style.display = 'block';
            btnAdicionarManual.style.display = 'block';
            btnAdicionarManual.disabled = false;
            btnDeepFocus.style.display = 'none';
            btnBulldoze.style.display = 'block';
            btnParar.style.display = 'none';
        } else {
            btnStart.style.display = 'block';
            btnAdicionarManual.style.display = 'none';
            btnDeepFocus.style.display = 'none';
            btnBulldoze.style.display = 'block';
            btnParar.style.display = 'none';
        }
    }
}
function adicionarFocoManual() {
    document.getElementById('manualMotivo').textContent = document.getElementById('motivoEscolhido').value;
    document.getElementById('manualTempo').textContent = document.getElementById('tempoEscolhido').value;
    abrirModal('manualFocusOverlay');
}

function confirmarFocoManual() {
    const motivo = document.getElementById('motivoEscolhido').value;
    const tempo = parseInt(document.getElementById('tempoEscolhido').value);
    const agora = new Date();
    const isLucky = escolhido === luckyPlant;
    
    const emojiFinal = evoluirEmoji(escolhido);
    
    jardimData[alvo] = { 
        icone: emojiFinal, 
        motivo: motivo, 
        lucky: isLucky,
        emProgresso: false 
    }; 
    
    sessoesTotais++; 
    historico.push({ 
        data: agora.toISOString(), 
        minutos: tempo, 
        motivo: motivo, 
        icone: emojiFinal, 
        mes: agora.getMonth(), 
        ano: agora.getFullYear(), 
        status: 'sucesso' 
    }); 
    
    updateMoedas(isLucky ? 2 : 1); 
    // Verificar metas
verificarMetasConcluidas(motivo, tempo);
    
    let plot;
    if (modo3D) {
        const cells = document.querySelectorAll('.cell-3d');
        plot = cells[alvo];
    } else {
        plot = document.querySelectorAll('.plot')[alvo];
    }
    
    const iconSpan = plot.querySelector('span');
    if (iconSpan) {
        iconSpan.textContent = emojiFinal;
        iconSpan.classList.add('crescendo');
        setTimeout(() => iconSpan.classList.remove('crescendo'), 500);
    }
    
    alvo = null;
    atualizarStreak();
    salvarTudo(); 
    renderSelects();
    atualizarBotoes();
    
    fecharModal('manualFocusOverlay');
    
    const totalCells = getTotalCells();
    if(jardimData.filter(x => x !== null).length === totalCells) triggerFinalSequence();
}

function exportarDados() {
    const dadosBackup = {
        versao: '2.3.2',
        dataExportacao: new Date().toISOString(),
        dados: {
            jardim: StorageSeguro.get('jardim', []),
            historico_foco: StorageSeguro.get('historico_foco', []),
            moedasFoco: StorageSeguro.get('moedasFoco', 0),
            estante_livros: StorageSeguro.get('estante_livros', []),
            sessoesTotais: StorageSeguro.get('sessoesTotais', 0),
            streakDiasAtivos: StorageSeguro.get('streakDiasAtivos', 0),
            tempos: StorageSeguro.get('tempos', []),
            motivos: StorageSeguro.get('motivos', []),
            todos: StorageSeguro.get('todos', []),
            metas: StorageSeguro.get('metas', []),
            darkMode: StorageSeguro.get('darkMode', false),
            modoNatal: StorageSeguro.get('modoNatal', false),
            modoMedieval: StorageSeguro.get('modoMedieval', false),
            medievalComprado: StorageSeguro.get('medievalComprado', false),
            candyforniaComprado: StorageSeguro.get('candyforniaComprado', false),
            exibirEstrelas: StorageSeguro.get('exibirEstrelas', true),
            animacaoFundoAtiva: StorageSeguro.get('animacaoFundoAtiva', true),
            sinoAtivo: StorageSeguro.get('sinoAtivo', true),
            temaAutoAtivo: StorageSeguro.set('temaAutoAtivo', true),
            mostrarAvisoInicio: StorageSeguro.get('mostrarAvisoInicio', true),
            mostrarPrevisao: StorageSeguro.get('mostrarPrevisao', true),
            modo3D: StorageSeguro.get('modo3D', false),
            aviso3DJaVisto: StorageSeguro.get('aviso3DJaVisto', false),
            somAtualIdx: StorageSeguro.get('somAtualIdx', 0),
            profilePhoto: StorageSeguro.get('profilePhoto', null),
            grid10x10: StorageSeguro.get('grid10x10', false)
        }
    };
    
    const jsonString = JSON.stringify(dadosBackup, null, 2);
    const blob = new Blob([jsonString], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const dataAtual = new Date().toISOString().split('T')[0];
    const nomeArquivo = `garden_focus_backup_${dataAtual}.json`;
    
    const link = document.createElement('a');
    link.href = url;
    link.download = nomeArquivo;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    
    showModal({ 
        text: `‚úÖ Backup exportado com sucesso!<br><br>üìÅ Arquivo: <strong>${nomeArquivo}</strong><br><br>üí° Guarde este arquivo em local seguro para restaurar seus dados em outro navegador.`, 
        onConfirm: () => {} 
    });
}

function importarDados(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const dadosImportados = JSON.parse(e.target.result);
            
            if (!dadosImportados.dados || !dadosImportados.versao) {
                showModal({ 
                    text: '‚ùå Arquivo inv√°lido! Este n√£o parece ser um backup do Garden Focus.', 
                    onConfirm: () => {} 
                });
                return;
            }
            
            showModal({ 
                text: `üì• <strong>Importar Backup</strong><br><br>üìÖ Data do backup: ${new Date(dadosImportados.dataExportacao).toLocaleDateString('pt-BR')}<br>üå± Vers√£o: ${dadosImportados.versao}<br><br>‚ö†Ô∏è <strong>Aten√ß√£o:</strong> Isso substituir√° TODOS os seus dados atuais.<br><br>Deseja continuar?`, 
                onConfirm: () => {
                    const dados = dadosImportados.dados;
                    
                    const chavesEssenciais = [
                        'jardim', 
                        'historico_foco', 
                        'moedasFoco', 
                        'estante_livros', 
                        'sessoesTotais', 
                        'streakDiasAtivos',
                        'profilePhoto',
                        'grid10x10',
                        'metas',
                        'candyforniaComprado'
                    ];
                    
                    chavesEssenciais.forEach(chave => {
                        if (dados[chave] !== null && dados[chave] !== undefined) {
                            StorageSeguro.set(chave, dados[chave]);
                        }
                    });
                    
                    if (dados.medievalComprado !== null && dados.medievalComprado !== undefined) {
                        StorageSeguro.set('medievalComprado', dados.medievalComprado);
                    }
                    if (dados.somAtualIdx !== null && dados.somAtualIdx !== undefined) {
                        StorageSeguro.set('somAtualIdx', dados.somAtualIdx);
                    }
                    
                    location.reload();
                }
            });
            
        } catch (error) {
            showModal({ 
                text: '‚ùå Erro ao ler o arquivo! Verifique se o arquivo n√£o est√° corrompido.', 
                onConfirm: () => {} 
            });
        }
    };
    reader.readAsText(file);
    
    event.target.value = '';
}

function mostrarAjudaBackup() {
    const mensagem = `
        <strong>üíæ Como funciona o Backup?</strong><br><br>
        
        <strong>üì§ EXPORTAR:</strong><br>
        Cria um arquivo JSON com todos os seus dados para download.<br><br>
        
        <strong>üì• IMPORTAR:</strong><br>
        Restaura seus dados a partir de um arquivo de backup.<br><br>
        
        <strong>üìã Dados salvos no backup:</strong><br>
        ‚Ä¢ üå± Jardim (plantas e posi√ß√µes)<br>
        ‚Ä¢ üìä Hist√≥rico completo de foco<br>
        ‚Ä¢ ü™ô Moedas acumuladas<br>
        ‚Ä¢ üìö Estante de livros<br>
        ‚Ä¢ ‚òÄÔ∏è Streak (sequ√™ncia de dias)<br>
        ‚Ä¢ ‚è±Ô∏è Tempos e motivos personalizados<br>
        ‚Ä¢ ‚öôÔ∏è Todas as configura√ß√µes<br>
        ‚Ä¢ üì∑ Foto de perfil<br><br>
        
        <strong>üí° Dica:</strong><br>
        Use esta fun√ß√£o para transferir seus dados entre navegadores ou dispositivos diferentes!
    `;
    
    showModal({ 
        text: mensagem, 
        onConfirm: () => {} 
    });
}

function resetAbsoluto() {
    showModal({ 
        text: "‚ö†Ô∏è ATEN√á√ÉO: Isso apagar√° absolutamente tudo (Moedas, Jardim, Fotos). Voc√™ tem certeza?", 
        onConfirm: () => {
            localStorage.clear();
            location.reload();
        } 
    });
}

function abrirLoja() {
    document.getElementById('saldoLojaMoedas').textContent = totalMoedas;
    const btnMed = document.getElementById('btnComprarMedieval');
    const btnCandy = document.getElementById('btnComprarCandyfornia');
    
    if(medievalComprado) {
        btnMed.textContent = "J√° Adquirido";
        btnMed.disabled = true;
    }
    
    if(candyforniaComprado && btnCandy) {
        btnCandy.textContent = "J√° Adquirido";
        btnCandy.disabled = true;
    }
    
    abrirModal('lojaOverlay');
}
function comprarItemLoja(tipo, preco) {
    if (totalMoedas >= preco) {
        if (tipo === 'medieval') {
            updateMoedas(-preco);
            medievalComprado = true;
            StorageSeguro.set('medievalComprado', true);
            
            // Atualizar bot√£o na loja
            const btnComprarMedieval = document.getElementById('btnComprarMedieval');
            if (btnComprarMedieval) {
                btnComprarMedieval.textContent = "J√° Adquirido";
                btnComprarMedieval.disabled = true;
            }
            
            // Atualizar o bot√£o de toggle imediatamente
            const btnMedieval = document.getElementById('btnMedievalConfig');
            if (btnMedieval) {
                // Remover desabilita√ß√£o visual
                btnMedieval.style.opacity = '1';
                btnMedieval.style.pointerEvents = 'auto';
                btnMedieval.style.cursor = 'pointer';
                btnMedieval.title = '';
                
                // Se houver mensagem "Dispon√≠vel na Loja", remover
                const medievalCard = encontrarCardPorTitulo('üè∞ Medieval');
                if (medievalCard) {
                    const switchContainer = medievalCard.querySelector('.ios-switch-container');
                    if (switchContainer && switchContainer.textContent.includes('Dispon√≠vel')) {
                        // Manter o switch, j√° est√° vis√≠vel
                    }
                }
            }
            
            showModal({ 
                text: "üè∞ Reino Medieval Desbloqueado!<br><br>O modo Medieval est√° agora dispon√≠vel nas configura√ß√µes.", 
                onConfirm: () => {} 
            });
        }
        
        if (tipo === 'candyfornia') {
            updateMoedas(-preco);
            candyforniaComprado = true;
            StorageSeguro.set('candyforniaComprado', true);
            
            // Atualizar bot√£o na loja
            const btnComprarCandy = document.getElementById('btnComprarCandyfornia');
            if (btnComprarCandy) {
                btnComprarCandy.textContent = "J√° Adquirido";
                btnComprarCandy.disabled = true;
            }
            
            // Atualizar o bot√£o de toggle imediatamente
            const btnCandyfornia = document.getElementById('btnCandyforniaConfig');
            if (btnCandyfornia) {
                // Remover desabilita√ß√£o visual
                btnCandyfornia.style.opacity = '1';
                btnCandyfornia.style.pointerEvents = 'auto';
                btnCandyfornia.style.cursor = 'pointer';
                btnCandyfornia.title = '';
                
                // Se houver mensagem "Dispon√≠vel na Loja", remover
                const candyCard = encontrarCardPorTitulo('üç≠ Candyfornia');
                if (candyCard) {
                    const switchContainer = candyCard.querySelector('.ios-switch-container');
                    if (switchContainer && switchContainer.textContent.includes('Dispon√≠vel')) {
                        // Manter o switch, j√° est√° vis√≠vel
                    }
                }
            }
            
            showModal({ 
                text: "üéâ Modo Candyfornia Desbloqueado!<br><br>O mundo de doces est√° agora dispon√≠vel nas configura√ß√µes!", 
                onConfirm: () => {} 
            });
        }
        
        document.getElementById('saldoLojaMoedas').textContent = totalMoedas;
        
        // Atualizar saldo no menu tamb√©m
        document.getElementById('userMoedas').textContent = totalMoedas;
        
    } else {
        showModal({ text: "Moedas insuficientes! Foque mais para ganhar.", onConfirm: () => {} });
    }
}

// Fun√ß√£o auxiliar para encontrar cards pelo t√≠tulo
function encontrarCardPorTitulo(titulo) {
    const cards = document.querySelectorAll('.config-card');
    for (let card of cards) {
        const h4 = card.querySelector('h4');
        if (h4 && h4.textContent.includes(titulo)) {
            return card;
        }
    }
    return null;
}

function atualizarTimerDisplay() { document.getElementById('timer').textContent = `${String(document.getElementById('tempoEscolhido').value).padStart(2,'0')}:00`; }

function acessarDebugViaTitulo() {
    promptCustom("Digite a senha de acesso:", false, (v) => {
        if(v === "Luiz") { 
            abrirModal('debugOverlay'); 
        } else { 
            showModal({ text: "Senha incorreta.", onConfirm: () => {} }); 
        }
    });
}

function abrirDebug() {
    promptCustom("Digite a senha de acesso:", false, (v) => {
        if(v === "Luiz") { abrirModal('debugOverlay'); }
        else { showModal({ text: "Senha incorreta.", onConfirm: () => {} }); }
    });
}

function toggleDeepFocus(active) {
    const body = document.body;
    const deepControls = document.querySelector('.deep-focus-controls');
    const startBtn = document.getElementById('btnStart');
    const deepBtn = document.getElementById('btnDeepFocus');
    const pararBtn = document.getElementById('btnParar');
    if (active) {
        body.classList.add('deep-focus-active');
        deepControls.style.display = 'block';
        document.getElementById('plantaFocoProfundo').textContent = escolhido;
        startBtn.style.display = 'none';
        deepBtn.style.display = 'none';
        pararBtn.style.display = intervalo ? 'block' : 'none';
    } else {
        body.classList.remove('deep-focus-active');
        deepControls.style.display = 'none';
        if (intervalo) { 
            deepBtn.style.display = 'block'; 
            startBtn.style.display = 'none'; 
            pararBtn.style.display = 'block';
        } else { 
            deepBtn.style.display = 'none'; 
            startBtn.style.display = 'block'; 
            pararBtn.style.display = 'none';
        }
    }
    atualizarBotoes();
}

function updateMoedas(amount) {
    totalMoedas += amount;
    StorageSeguro.set('moedasFoco', totalMoedas);
    document.getElementById('userMoedas').textContent = totalMoedas;
}

function setLuckyPlant() {
    const today = new Date().toDateString();
    let seed = 0;
    for(let i=0; i<today.length; i++) seed += today.charCodeAt(i);
    const pool = modoCandyfornia ? ITENS_CANDYFORNIA : (modoNatal ? ITENS_NATAL : (modoMedieval ? ITENS_MEDIEVAL : ITENS_PADRAO));
    luckyPlant = pool[seed % pool.length];
    document.getElementById('luckyPlantTag').textContent = `Sorte do dia: ${luckyPlant} (Moedas 2x)`;
}

// Fun√ß√£o para obter o tamanho atual do grid
function getGridSize() {
    return grid10x10 ? 10 : 5;
}

// Fun√ß√£o para obter o n√∫mero total de c√©lulas
function getTotalCells() {
    const size = getGridSize();
    return size * size;
}
// =========================
// FUN√á√ÉO PARA VERIFICAR ATUALIZA√á√ïES DO PWA
// =========================
let updateFound = false;
let newServiceWorker = null;

function verificarAtualizacoes() {
    const statusDiv = document.getElementById('atualizacaoStatus');
    
    if (!('serviceWorker' in navigator)) {
        statusDiv.innerHTML = '<span style="color:#e57373">‚ö†Ô∏è Service Worker n√£o suportado</span>';
        return;
    }
    
    statusDiv.innerHTML = 'üîç Procurando atualiza√ß√µes...';
    
    // For√ßa a atualiza√ß√£o do service worker
    navigator.serviceWorker.ready.then(registration => {
        registration.update().then(() => {
            // Verifica se h√° um novo service worker instalado
            if (registration.waiting) {
                // H√° uma atualiza√ß√£o pronta para instalar
                newServiceWorker = registration.waiting;
                mostrarAtualizacaoDisponivel();
            } else if (registration.installing) {
                // Est√° instalando uma nova vers√£o
                newServiceWorker = registration.installing;
                newServiceWorker.addEventListener('statechange', () => {
                    if (newServiceWorker.state === 'installed') {
                        mostrarAtualizacaoDisponivel();
                    }
                });
            } else {
                // Nenhuma atualiza√ß√£o encontrada
                setTimeout(() => {
                    statusDiv.innerHTML = '‚úÖ Voc√™ tem a vers√£o mais recente!<br><small>Vers√£o: 2.3.2</small>';
                }, 1000);
            }
        }).catch(error => {
            console.error('Erro ao verificar atualiza√ß√µes:', error);
            statusDiv.innerHTML = '<span style="color:#e57373">‚ö†Ô∏è Erro ao verificar atualiza√ß√µes</span>';
        });
    });
}

function mostrarAtualizacaoDisponivel() {
    const statusDiv = document.getElementById('atualizacaoStatus');
    statusDiv.innerHTML = `
        <span style="color:#4caf50">üéâ Nova vers√£o dispon√≠vel!</span><br>
        <button onclick="aplicarAtualizacao()" style="margin-top:5px; padding:5px 10px; font-size:10px; background:#4caf50; color:white; border:none; border-radius:6px; cursor:pointer;">
            üîÑ Atualizar Agora
        </button>
        <small style="display:block; margin-top:3px;">A p√°gina ser√° recarregada</small>
    `;
}

function aplicarAtualizacao() {
    if (newServiceWorker) {
        // Envia uma mensagem para o service worker ativar
        newServiceWorker.postMessage({ type: 'SKIP_WAITING' });
        
        // Recarrega a p√°gina
        setTimeout(() => {
            window.location.reload();
        }, 100);
    }
}

// Detecta quando uma nova vers√£o est√° dispon√≠vel
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.addEventListener('controllerchange', () => {
        // Quando um novo service worker assume o controle
        console.log('Novo Service Worker ativado!');
    });
    
    // Escuta mensagens do service worker
    navigator.serviceWorker.addEventListener('message', event => {
        if (event.data && event.data.type === 'UPDATE_AVAILABLE') {
            const statusDiv = document.getElementById('atualizacaoStatus');
            if (statusDiv) {
                statusDiv.innerHTML = `
                    <span style="color:#ff9800">‚ö†Ô∏è Atualiza√ß√£o encontrada!</span><br>
                    <small>Recarregue a p√°gina para aplicar</small>
                `;
            }
        }
    });
}
// Fun√ß√£o para inicializar o jardimData com o tamanho correto
function initJardimData() {
    const totalCells = getTotalCells();
    
    if (!jardimData || jardimData.length !== totalCells) {
        if (grid10x10 && jardimData && jardimData.length === 25) {
            const newJardimData = Array(totalCells).fill(null);
            
            for (let y = 0; y < 5; y++) {
                for (let x = 0; x < 5; x++) {
                    const oldIndex = y * 5 + x;
                    const newIndex = (y * 2) * 10 + (x * 2);
                    if (jardimData[oldIndex]) {
                        newJardimData[newIndex] = jardimData[oldIndex];
                    }
                }
            }
            
            jardimData = newJardimData;
        } 
        else if (!grid10x10 && jardimData && jardimData.length === 100) {
            const newJardimData = Array(25).fill(null);
            
            for (let y = 0; y < 10; y += 2) {
                for (let x = 0; x < 10; x += 2) {
                    const oldIndex = y * 10 + x;
                    const newIndex = (y / 2) * 5 + (x / 2);
                    if (jardimData[oldIndex]) {
                        newJardimData[newIndex] = jardimData[oldIndex];
                    }
                }
            }
            
            jardimData = newJardimData;
        } 
        else {
            jardimData = Array(totalCells).fill(null);
        }
        
        StorageSeguro.set('jardim', jardimData);
    }
}

// NOVO: Fun√ß√£o para alternar entre grid 5x5 e 10x10
function toggleGrid10x10() {
    grid10x10 = !grid10x10;
    StorageSeguro.set('grid10x10', grid10x10);
    
    if (grid10x10) {
        document.body.classList.add('grid-10x10');
    } else {
        document.body.classList.remove('grid-10x10');
    }
    
    const debugOverlay = document.getElementById('debugOverlay');
    if (debugOverlay.style.display === 'flex') {
        const btn = document.getElementById('btnGrid10x10');
        if (btn) {
            btn.textContent = `Grid ${grid10x10 ? '5x5' : '10x10'} (Modo Debug)`;
        }
    }
    
    const btnGrid10x10Config = document.getElementById('btnGrid10x10Toggle');
    if (btnGrid10x10Config) {
        btnGrid10x10Config.classList.toggle('on', grid10x10);
    }
    
    initJardimData();
    
    renderJardim();
    
    showModal({ 
        text: `Grid alterado para ${getGridSize()}x${getGridSize()}!<br><br>O jardim foi ${grid10x10 ? 'expandido' : 'reduzido'} e as plantas foram reposicionados.`, 
        onConfirm: () => {} 
    });
}
function ganharMoedasDebug() {
    // Adicionar 200 moedas
    const moedasAntigas = totalMoedas;
    totalMoedas += 200;
    
    // Atualizar storage
    StorageSeguro.set('moedasFoco', totalMoedas);
    
    // Atualizar display
    document.getElementById('userMoedas').textContent = totalMoedas;
    
    // Se a loja estiver aberta, atualizar l√° tamb√©m
    const saldoLoja = document.getElementById('saldoLojaMoedas');
    if (saldoLoja) {
        saldoLoja.textContent = totalMoedas;
    }
    
    // Mostrar confirma√ß√£o
    showModal({ 
        text: `üí∞ +200 Moedas Adicionadas!<br><br>Saldo anterior: ${moedasAntigas} üí∞<br>Novo saldo: ${totalMoedas} üí∞<br><br>Agora voc√™ pode comprar itens na loja!`, 
        onConfirm: () => {} 
    });
    
    // Efeito visual
    chuvaDeEfeitos('üí∞', 20);
    
    // Fechar modal de debug
    fecharModal('debugOverlay');
}

function fillGridTest() {
    const totalCells = getTotalCells();
    const testEmoji = grid10x10 ? 'ü™¥' : 'ü™¥';
    jardimData = Array(totalCells).fill({ icone: testEmoji, motivo: 'Teste Debug', lucky: false });
    salvarTudo();
    triggerFinalSequence();
}

function addMaxStarsTest() {
    for(let i=0; i<5; i++) { estante.push({ nome: `Livro ${i+1}`, nota: 5, cor: '#4caf50' }); }
    StorageSeguro.set('estante_livros', estante);
    renderEstante();
    renderEstrelasNoCeu();
}

function simularSucessosTest() {
    const agora = new Date();
    for(let i=0; i<10; i++) {
        const diaSimulado = new Date();
        diaSimulado.setDate(agora.getDate() - i);
        historico.push({
            data: diaSimulado.toISOString(), minutos: 25, motivo: motivos[0],
            icone: ITENS_PADRAO[0], mes: agora.getMonth(), ano: agora.getFullYear(), status: 'sucesso'
        });
    }
    sessoesTotais += 10;
    atualizarStreak();
    salvarTudo();
    showModal({ text: "10 sucessos inseridos no hist√≥rico!", onConfirm: () => {} });
}


   

function triggerFinalSequence() {
    const grid2D = document.getElementById('jardim');
    const grid3D = document.getElementById('grid3D');
    
    if (modo3D) {
        grid3D.classList.add('zoom-out-effect');
    } else {
        grid2D.classList.add('zoom-out-effect');
    }
    
    setTimeout(() => {
        showModal({ 
            text: `üåü PARAB√âNS! Voc√™ completou um ciclo de foco! Seu jardim ${grid10x10 ? '10x10' : '5x5'} floresceu lindamente e est√° pronto para novas sementes.`, 
            onConfirm: () => {
                const totalCells = getTotalCells();
                jardimData = Array(totalCells).fill(null);
                grid2D.classList.remove('zoom-out-effect');
                grid3D.classList.remove('zoom-out-effect');
                salvarTudo();
            }
        });
    }, 2000);
}

function calcularPrevisao() {
    const painel = document.getElementById('painelInteligencia');
    
    if (!mostrarPrevisao) {
        painel.style.display = 'none';
        return;
    }
    
    if(historico.length < 2) { 
        painel.innerHTML = `<strong>Probabilidade: 50%</strong><br><small>Sem dados suficientes.</small>`; 
        painel.style.display = 'block'; 
        return; 
    }
    
    const diaAtual = new Date().getDay();
    const motivoAtual = document.getElementById('motivoEscolhido').value;
    const historicoSimilar = historico.filter(s => { 
        const dS = new Date(s.data); 
        return dS.getDay() === diaAtual && s.motivo === motivoAtual; 
    });
    
    if(historicoSimilar.length === 0) { 
        painel.innerHTML = `<strong>Probabilidade: 50%</strong><br><small>Sem dados para este motivo/dia.</small>`; 
        painel.style.display = 'block'; 
        return; 
    }
    
    const sucessos = historicoSimilar.filter(s => s.status !== 'falha').length;
    const probabilidade = Math.round((sucessos / historicoSimilar.length) * 100);
    const cor = probabilidade > 70 ? '#4caf50' : (probabilidade < 40 ? '#e57373' : '#ffb74d');
    painel.style.display = 'block'; 
    painel.style.borderColor = cor; 
    painel.style.color = cor;
    painel.innerHTML = `<strong>Sucesso: ${probabilidade}%</strong><br><small>Baseado em ${historicoSimilar.length} sess√µes similares.</small>`;
}

function renderEstrelasNoCeu() {
    const container = document.getElementById('starsContainer');
    container.innerHTML = '';
    
    const isDarkMode = document.body.classList.contains('dark-mode');
    if(!exibirEstrelas || !isDarkMode) return;
    
    const livrosNotaMaxima = estante.filter(l => l.nota === 5);
    livrosNotaMaxima.forEach((l, i) => {
        const estrela = document.createElement('div');
        estrela.className = 'estrela-conquista'; estrela.textContent = '‚ú¶';
        estrela.style.left = (10 + (i * 137 % 80)) + 'vw'; estrela.style.top = (5 + (i * 97 % 30)) + 'vh';
        estrela.style.animationDelay = (i * 0.5) + 's'; estrela.style.fontSize = (12 + (i % 3) * 4) + 'px';
        container.appendChild(estrela);
    });
}

function toggleEstrelas() {
    exibirEstrelas = !exibirEstrelas;
    StorageSeguro.set('exibirEstrelas', exibirEstrelas);
    const btn = document.getElementById('btnEstrelas');
    btn.classList.toggle('on', exibirEstrelas);
    renderEstrelasNoCeu();
}

function abrirEstante() { 
    abrirModal('estanteOverlay'); 
    renderEstante(); 
}

function renderEstante() {
    const container = document.getElementById('listaLivros');
    container.innerHTML = '';
    
    if (estante.length === 0) {
        container.innerHTML = '<div style="padding: 20px; text-align: center; color: rgba(255,255,255,0.5);">Sua estante est√° vazia. Adicione seu primeiro livro!</div>';
        return;
    }
    
    const LIVROS_POR_ANDAR = 12;
    const totalAndares = Math.ceil(estante.length / LIVROS_POR_ANDAR);
    
    const estanteContainer = document.createElement('div');
    estanteContainer.style.display = 'flex';
    estanteContainer.style.flexDirection = 'column';
    estanteContainer.style.gap = '0';
    const isMobile = window.innerWidth <= 600;
    estanteContainer.style.width = '100%';
    estanteContainer.style.maxWidth = isMobile ? '100%' : '450px';
    estanteContainer.style.margin = '0 auto';
    
    for (let andar = 0; andar < totalAndares; andar++) {
        const inicio = andar * LIVROS_POR_ANDAR;
        const fim = inicio + LIVROS_POR_ANDAR;
        const livrosDoAndar = estante.slice(inicio, fim);
        
        const andarDiv = document.createElement('div');
        andarDiv.className = 'madeira-shelf';
        andarDiv.style.margin = '0 0 0 0';
        andarDiv.style.position = 'relative';
        
        const andarLabel = document.createElement('div');
        andarLabel.style.position = 'absolute';
        andarLabel.style.top = '-18px';
        andarLabel.style.left = '10px';
        andarLabel.style.fontSize = '10px';
        andarLabel.style.color = 'rgba(255,255,255,0.7)';
        andarLabel.style.fontWeight = 'bold';
        andarLabel.textContent = `Andar ${andar + 1}`;
        andarDiv.appendChild(andarLabel);
        
        const prateleiraDiv = document.createElement('div');
        prateleiraDiv.className = 'prateleira-interna';
        prateleiraDiv.style.minHeight = '80px';
        prateleiraDiv.style.padding = '8px 8px 0 8px';
        prateleiraDiv.style.position = 'relative';
        prateleiraDiv.style.overflow = 'hidden';
        
        livrosDoAndar.forEach((livro, indexNoAndar) => {
            const livroDiv = document.createElement('div');
            livroDiv.className = 'livro';
            livroDiv.style.backgroundColor = livro.cor;
            livroDiv.style.height = (60 + (indexNoAndar % 3) * 8) + 'px';
            const isMobile = window.innerWidth <= 600;
            livroDiv.style.width = isMobile ? '18px' : '32px';
            livroDiv.style.marginRight = '-1px';
            
            const lombada = document.createElement('div');
            lombada.style.position = 'absolute';
            lombada.style.top = '0';
            lombada.style.left = '0';
            lombada.style.width = '3px';
            lombada.style.height = '100%';
            lombada.style.backgroundColor = 'rgba(0,0,0,0.15)';
            livroDiv.appendChild(lombada);
            
            const tituloDiv = document.createElement('div');
            tituloDiv.className = 'livro-titulo';
            tituloDiv.textContent = livro.nome;
            tituloDiv.style.fontSize = isMobile ? '6px' : '8px';
            tituloDiv.style.padding = '3px 0px';
            tituloDiv.style.fontWeight = 'bold';
            
            livroDiv.appendChild(tituloDiv);
            
            livroDiv.onclick = () => {
                showModal({ 
                    text: `üìñ <strong>${livro.nome}</strong><br>Nota: ${livro.nota > 0 ? '‚≠ê'.repeat(livro.nota) : 'Sem nota'}${livro.notas ? `<br><br>Notas: ${livro.notas}` : ''}<br><br>Deseja excluir este livro?`, 
                    onConfirm: () => { 
                        const indexGlobal = inicio + indexNoAndar;
                        estante.splice(indexGlobal, 1); 
                        StorageSeguro.set('estante_livros', estante); 
                        renderEstante(); 
                        renderEstrelasNoCeu();
                    } 
                });
            };
            
            prateleiraDiv.appendChild(livroDiv);
        });
        
        andarDiv.appendChild(prateleiraDiv);
        estanteContainer.appendChild(andarDiv);
    }
    
    const contadorDiv = document.createElement('div');
    contadorDiv.style.textAlign = 'center';
    contadorDiv.style.marginTop = '15px';
    contadorDiv.style.fontSize = '12px';
    contadorDiv.style.color = 'var(--text-main)';
    contadorDiv.innerHTML = `üìö <strong>${estante.length}</strong> livro${estante.length !== 1 ? 's' : ''} em <strong>${totalAndares}</strong> andar${totalAndares !== 1 ? 'es' : ''}`;
    estanteContainer.appendChild(contadorDiv);
    
    container.appendChild(estanteContainer);
}

function prepararNovoLivro() { 
    notaTemp = 0; 
    corLivroTemp = CORES_LIVROS[0];
    document.getElementById('nomeLivroInput').value = ''; 
    document.getElementById('notasLivroInput').value = ''; 
    atualizarEstrelas(0); 
    renderCorPicker();
    abrirModal('modalLivroInput'); 
}

function renderCorPicker() {
    const container = document.getElementById('livroColorPicker');
    container.innerHTML = '';
    CORES_LIVROS.forEach(cor => {
        const swatch = document.createElement('div');
        swatch.className = 'color-swatch' + (cor === corLivroTemp ? ' active' : '');
        swatch.style.backgroundColor = cor;
        swatch.onclick = () => {
            corLivroTemp = cor;
            renderCorPicker();
        };
        container.appendChild(swatch);
    });
}

function setupEstrelasClick() { 
    document.querySelectorAll('#starsClickable .star').forEach(s => { 
        s.onclick = (e) => { 
            notaTemp = parseInt(e.target.dataset.v); 
            atualizarEstrelas(notaTemp); 
        }; 
    }); 
}

function atualizarEstrelas(v) { 
    document.querySelectorAll('#starsClickable .star').forEach(s => { 
        s.classList.toggle('active', parseInt(s.dataset.v) <= v); 
    }); 
}

function confirmarNovoLivro() {
    const nome = document.getElementById('nomeLivroInput').value; 
    const notas = document.getElementById('notasLivroInput').value;
    if(!nome.trim()) return;
    
    const LIVROS_POR_ANDAR = 12;
    const andarAtual = Math.ceil(estante.length / LIVROS_POR_ANDAR);
    const novoAndar = Math.ceil((estante.length + 1) / LIVROS_POR_ANDAR);
    
    estante.push({ nome: nome, nota: notaTemp, cor: corLivroTemp, notas: notas });
    StorageSeguro.set('estante_livros', estante); 
    
    if (novoAndar > andarAtual) {
        showModal({ 
            text: `üìö Novo livro adicionado!\n‚ú® Sua estante agora tem ${novoAndar} andar${novoAndar !== 1 ? 'es' : ''}! Continue lendo e crescendo sua cole√ß√£o!`, 
            onConfirm: () => {} 
        });
    }
    
    fecharModal('modalLivroInput');
    renderEstante(); 
    renderEstrelasNoCeu();
}

function abrirDashboard() { 
    abrirModal('dashboardOverlay');
    mostrarDashboardPeriodo('semanal');
}

function mostrarDashboardPeriodo(periodo) {
    document.getElementById('btnDashboardSemanal').classList.remove('active');
    document.getElementById('btnDashboardMensal').classList.remove('active');
    document.getElementById('btnDashboardAnual').classList.remove('active');
    document.getElementById('btnDashboard' + periodo.charAt(0).toUpperCase() + periodo.slice(1)).classList.add('active');
    
    document.getElementById('dashboardContainerSemanal').style.display = 'none';
    document.getElementById('dashboardContainerMensal').style.display = 'none';
    document.getElementById('dashboardContainerAnual').style.display = 'none';
    
    const containerId = 'dashboardContainer' + periodo.charAt(0).toUpperCase() + periodo.slice(1);
    document.getElementById(containerId).style.display = 'block';
    
    if (periodo === 'semanal') {
        renderizarDashboardSemanal();
    } else if (periodo === 'mensal') {
        renderizarDashboardMensal();
    } else if (periodo === 'anual') {
        renderizarDashboardAnual();
    }
}

function calcularMaisUsado(sessoes) {
    if (sessoes.length === 0) {
        return { icone: "üìä", motivo: "Nenhum dado" };
    }
    
    const contagemIcones = {};
    const contagemMotivos = {};
    
    sessoes.forEach(sessao => {
        if (sessao.icone) {
            contagemIcones[sessao.icone] = (contagemIcones[sessao.icone] || 0) + 1;
        }
        
        if (sessao.motivo) {
            contagemMotivos[sessao.motivo] = (contagemMotivos[sessao.motivo] || 0) + 1;
        }
    });
    
    let iconeMaisUsado = "üìä";
    let maxIcones = 0;
    for (const [icone, contagem] of Object.entries(contagemIcones)) {
        if (contagem > maxIcones) {
            maxIcones = contagem;
            iconeMaisUsado = icone;
        }
    }
    
    let motivoMaisUsado = "Nenhum";
    let maxMotivos = 0;
    for (const [motivo, contagem] of Object.entries(contagemMotivos)) {
        if (contagem > maxMotivos) {
            maxMotivos = contagem;
            motivoMaisUsado = motivo;
        }
    }
    
    return { icone: iconeMaisUsado, motivo: motivoMaisUsado };
}

function renderizarDashboardSemanal() {
    const container = document.getElementById('dashboardContainerSemanal');
    container.innerHTML = '';
    
    const ultimos7dias = [];
    const hoje = new Date();
    hoje.setHours(0, 0, 0, 0);
    
    for (let i = 6; i >= 0; i--) {
        const dia = new Date(hoje);
        dia.setDate(hoje.getDate() - i);
        ultimos7dias.push(dia);
    }
    
    const minutosPorDia = ultimos7dias.map(dia => {
        const sessoesDoDia = historico.filter(s => {
            const sDate = new Date(s.data);
            sDate.setHours(0, 0, 0, 0);
            return sDate.getTime() === dia.getTime() && s.status === 'sucesso';
        });
        return sessoesDoDia.reduce((acc, sessao) => acc + sessao.minutos, 0);
    });
    
    const maxMinutos = Math.max(...minutosPorDia, 60);
    const metaDiaria = 60;
    
    ultimos7dias.forEach((dia, index) => {
        const minutos = minutosPorDia[index];
        const porcentagem = Math.min((minutos / maxMinutos) * 100, 100);
        const isHoje = index === 6;
        
        const diaElement = document.createElement('div');
        diaElement.className = 'dia-semana';
        
        const nomesDias = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
        const diaSemana = nomesDias[dia.getDay()];
        
        diaElement.innerHTML = `
            <div class="dia-label">${diaSemana}</div>
            <div class="dia-barra-container">
                <div class="dia-barra ${isHoje ? 'hoje' : ''}" style="width: ${porcentagem}%"></div>
                <div class="dia-meta" style="left: ${(metaDiaria / maxMinutos) * 100}%"></div>
                <div class="dia-valor">${minutos} min</div>
            </div>
        `;
        
        container.appendChild(diaElement);
    });
    
    const totalSemana = minutosPorDia.reduce((a, b) => a + b, 0);
    const diasComSessoes = minutosPorDia.filter(m => m > 0).length;
    const mediaDiaria = diasComSessoes > 0 ? Math.round(totalSemana / diasComSessoes) : 0;
    
    const resumoHTML = `
        <div class="dashboard-resumo">
            <div class="resumo-item">
                <div class="resumo-valor total">${totalSemana}</div>
                <div class="resumo-label">Minutos na semana</div>
            </div>
            <div class="resumo-item">
                <div class="resumo-valor">${diasComSessoes}</div>
                <div class="resumo-label">Dias ativos</div>
            </div>
            <div class="resumo-item">
                <div class="resumo-valor meta">${mediaDiaria}</div>
                <div class="resumo-label">M√©dia por dia</div>
            </div>
            <div class="resumo-item">
                <div class="resumo-valor streak">${streakDiasAtivos}</div>
                <div class="resumo-label">Dias consecutivos ‚òÄÔ∏è</div>
            </div>
        </div>
    `;
    
    container.innerHTML += resumoHTML;
    
    const sessoesSemana = historico.filter(s => {
        const sDate = new Date(s.data);
        sDate.setHours(0, 0, 0, 0);
        return ultimos7dias.some(dia => dia.getTime() === sDate.getTime()) && s.status === 'sucesso';
    });
    
    const maisUsado = calcularMaisUsado(sessoesSemana);
    
    const maisUsadoHTML = `
        <div class="mais-usado-section">
            <div class="mais-usado-header">
                <span>üìà</span>
                <span>Mais usado na semana</span>
            </div>
            <div class="mais-usado-content">
                <div class="mais-usado-item">
                    <span class="mais-usado-emoji">${maisUsado.icone}</span>
                    <div class="mais-usado-motivo">${maisUsado.motivo}</div>
                    <span class="mais-usado-label">Motivo mais frequente</span>
                </div>
                <div class="mais-usado-item">
                    <span class="mais-usado-emoji">${maisUsado.icone}</span>
                    <div class="mais-usado-motivo">${sessoesSemana.length} sess√µes</div>
                    <span class="mais-usado-label">Sess√µes totais</span>
                </div>
            </div>
        </div>
    `;
    
    container.innerHTML += maisUsadoHTML;
    
    setTimeout(() => {
        container.querySelectorAll('.dia-barra').forEach((barra, index) => {
            const minutos = minutosPorDia[index];
            const porcentagem = Math.min((minutos / maxMinutos) * 100, 100);
            barra.style.width = `${porcentagem}%`;
        });
    }, 100);
}

function renderizarDashboardMensal() {
    const container = document.getElementById('dashboardContainerMensal');
    container.innerHTML = '';
    
    const agora = new Date();
    const mesAtual = agora.getMonth();
    const anoAtual = agora.getFullYear();
    const diasNoMes = new Date(anoAtual, mesAtual + 1, 0).getDate();
    
    const minutosPorDia = Array(diasNoMes).fill(0);
    
    historico.forEach(sessao => {
        if (sessao.status === 'sucesso') {
            const dataSessao = new Date(sessao.data);
            if (dataSessao.getMonth() === mesAtual && dataSessao.getFullYear() === anoAtual) {
                const dia = dataSessao.getDate() - 1;
                minutosPorDia[dia] += sessao.minutos;
            }
        }
    });
    
    const maxMinutos = Math.max(...minutosPorDia, 100);
    
    for (let i = 0; i < diasNoMes; i += 7) {
        const semanaDias = minutosPorDia.slice(i, Math.min(i + 7, diasNoMes));
        const semanaContainer = document.createElement('div');
        semanaContainer.className = 'semana-card';
        semanaContainer.innerHTML = `<strong>Semana ${Math.floor(i/7) + 1} (dias ${i+1}-${Math.min(i+7, diasNoMes)})</strong><br>`;
        
        semanaDias.forEach((minutos, indexDia) => {
            const diaNum = i + indexDia + 1;
            const porcentagem = Math.min((minutos / maxMinutos) * 100, 100);
            semanaContainer.innerHTML += `
                <div style="display: flex; align-items: center; margin: 5px 0;">
                    <div style="width: 30px; font-size: 11px;">${diaNum}</div>
                    <div style="flex: 1; background: var(--bg-body); height: 12px; border-radius: 6px; overflow: hidden;">
                        <div style="height: 100%; background: ${diaNum === agora.getDate() ? 'var(--accent)' : 'var(--primary)'}; width: ${porcentagem}%; border-radius: 6px;"></div>
                    </div>
                    <div style="width: 40px; font-size: 11px; text-align: right;">${minutos}m</div>
                </div>
            `;
        });
        
        container.appendChild(semanaContainer);
    }
    
    const totalMes = minutosPorDia.reduce((a, b) => a + b, 0);
    const diasAtivos = minutosPorDia.filter(m => m > 0).length;
    const mediaDiaria = diasAtivos > 0 ? Math.round(totalMes / diasAtivos) : 0;
    
    const resumoHTML = `
        <div class="dashboard-resumo">
            <div class="resumo-item">
                <div class="resumo-valor total">${totalMes}</div>
                <div class="resumo-label">Minutos no m√™s</div>
            </div>
            <div class="resumo-item">
                <div class="resumo-valor">${diasAtivos}</div>
                <div class="resumo-label">Dias ativos</div>
            </div>
            <div class="resumo-item">
                <div class="resumo-valor meta">${mediaDiaria}</div>
                <div class="resumo-label">M√©dia por dia</div>
            </div>
            <div class="resumo-item">
                <div class="resumo-valor streak">${streakDiasAtivos}</div>
                <div class="resumo-label">Dias consecutivos ‚òÄÔ∏è</div>
            </div>
        </div>
    `;
    
    container.innerHTML += resumoHTML;
    
    const sessoesMes = historico.filter(s => {
        if (s.status !== 'sucesso') return false;
        const dataSessao = new Date(s.data);
        return dataSessao.getMonth() === mesAtual && dataSessao.getFullYear() === anoAtual;
    });
    
    const maisUsado = calcularMaisUsado(sessoesMes);
    
    const maisUsadoHTML = `
        <div class="mais-usado-section">
            <div class="mais-usado-header">
                <span>üìà</span>
                <span>Mais usado no m√™s</span>
            </div>
            <div class="mais-usado-content">
                <div class="mais-usado-item">
                    <span class="mais-usado-emoji">${maisUsado.icone}</span>
                    <div class="mais-usado-motivo">${maisUsado.motivo}</div>
                    <span class="mais-usado-label">Motivo mais frequente</span>
                </div>
                <div class="mais-usado-item">
                    <span class="mais-usado-emoji">${maisUsado.icone}</span>
                    <div class="mais-usado-motivo">${sessoesMes.length} sess√µes</div>
                    <span class="mais-usado-label">Sess√µes totais</span>
                </div>
            </div>
        </div>
    `;
    
    container.innerHTML += maisUsadoHTML;
}

function renderizarDashboardAnual() {
    const container = document.getElementById('dashboardContainerAnual');
    container.innerHTML = '';
    
    const agora = new Date();
    const anoAtual = agora.getFullYear();
    
    const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
    const minutosPorMes = Array(12).fill(0);
    
    historico.forEach(sessao => {
        if (sessao.status === 'sucesso') {
            const dataSessao = new Date(sessao.data);
            if (dataSessao.getFullYear() === anoAtual) {
                const mes = dataSessao.getMonth();
                minutosPorMes[mes] += sessao.minutos;
            }
        }
    });
    
    const maxMinutos = Math.max(...minutosPorMes, 1000);
    
    // 1. Primeiro adicionar os meses (gr√°ficos)
    meses.forEach((mesNome, index) => {
        const minutos = minutosPorMes[index];
        const porcentagem = Math.min((minutos / maxMinutos) * 100, 100);
        const isMesAtual = index === agora.getMonth();
        
        const mesElement = document.createElement('div');
        mesElement.className = 'dia-semana';
        
        mesElement.innerHTML = `
            <div class="dia-label">${mesNome}</div>
            <div class="dia-barra-container">
                <div class="dia-barra ${isMesAtual ? 'hoje' : ''}" style="width: ${porcentagem}%"></div>
                <div class="dia-valor">${minutos} min</div>
            </div>
        `;
        
        container.appendChild(mesElement);
    });
    
    // 2. Depois adicionar o resumo
    const totalAno = minutosPorMes.reduce((a, b) => a + b, 0);
    const mesesAtivos = minutosPorMes.filter(m => m > 0).length;
    const mediaMensal = mesesAtivos > 0 ? Math.round(totalAno / mesesAtivos) : 0;
    
    const resumoHTML = `
        <div class="dashboard-resumo">
            <div class="resumo-item">
                <div class="resumo-valor total">${totalAno}</div>
                <div class="resumo-label">Minutos no ano</div>
            </div>
            <div class="resumo-item">
                <div class="resumo-valor">${mesesAtivos}</div>
                <div class="resumo-label">Meses ativos</div>
            </div>
            <div class="resumo-item">
                <div class="resumo-valor meta">${mediaMensal}</div>
                <div class="resumo-label">M√©dia por m√™s</div>
            </div>
        </div>
    `;
    
    container.innerHTML += resumoHTML;
    
    // 3. Por √∫ltimo a se√ß√£o "Mais usado"
    const sessoesAno = historico.filter(s => {
        if (s.status !== 'sucesso') return false;
        const dataSessao = new Date(s.data);
        return dataSessao.getFullYear() === anoAtual;
    });
    
    const maisUsado = calcularMaisUsado(sessoesAno);
    
    const maisUsadoHTML = `
        <div class="mais-usado-section">
            <div class="mais-usado-header">
                <span>üìà</span>
                <span>Mais usado no ano</span>
            </div>
            <div class="mais-usado-content">
                <div class="mais-usado-item">
                    <span class="mais-usado-emoji">${maisUsado.icone}</span>
                    <div class="mais-usado-motivo">${maisUsado.motivo}</div>
                    <span class="mais-usado-label">Motivo mais frequente</span>
                </div>
                <div class="mais-usado-item">
                    <span class="mais-usado-emoji">${maisUsado.icone}</span>
                    <div class="mais-usado-motivo">${sessoesAno.length} sess√µes</div>
                    <span class="mais-usado-label">Sess√µes totais</span>
                </div>
            </div>
        </div>
    `;
    
    container.innerHTML += maisUsadoHTML;
    
    // Animar as barras
    setTimeout(() => {
        container.querySelectorAll('.dia-barra').forEach((barra, index) => {
            const minutos = minutosPorMes[index];
            const porcentagem = Math.min((minutos / maxMinutos) * 100, 100);
            barra.style.width = `${porcentagem}%`;
        });
    }, 100);
}

function obterEmojiEstagio(emojiFinal) {
    if (PROGRESSAO[emojiFinal]) {
        return PROGRESSAO[emojiFinal].estagio;
    }
    
    const emoji = emojiFinal;
    const plantas = ['üå≤','üå≥','üå¥','üåµ','üåæ','üåø','‚òòÔ∏è','üåª','üåπ','üå∑','üçÑ','üçÑ‚Äçüü´','ü™¥'];
    if (plantas.includes(emoji)) return 'üå±';
    
    const construcoes = ['üè†','üèØ','üè∞','‚õ™Ô∏è','‚õ©Ô∏è','üõñ','üïå','üõï','üóº'];
    if (construcoes.includes(emoji)) return 'üèóÔ∏è';
    
    const natal = ['üéÑ','üéÅ','üéÖ','ü§∂','‚õÑ','‚ùÑÔ∏è','ü¶å'];
    if (natal.includes(emoji)) return 'üå≤';
    
    return '‚è≥Ô∏è';
}

function evoluirEmoji(emojiFinal) {
    if (PROGRESSAO[emojiFinal]) {
        return PROGRESSAO[emojiFinal].final || emojiFinal;
    }
    return emojiFinal;
}

function startTimer() { 
    if(alvo === null) { 
        showModal({ 
            text: "Escolha primeiro um espa√ßo no jardim para sua planta crescer! üå±", 
            onConfirm: () => {} 
        }); 
        return; 
    }
    
    // Ativar manuten√ß√£o de tela se configurado
    if (manterTelaAtiva) {
        gerenciarTelaAtiva(true);
    }
    
    solicitarPermissaoNotificacao();
    
    document.getElementById('painelInteligencia').style.display = 'none'; 
    document.getElementById('btnStart').style.display = 'none';
    document.getElementById('btnDeepFocus').style.display = 'block';
    document.getElementById('btnParar').style.display = 'block';
    atualizarBotoes();
    
    if (!mostrarAvisoInicio) {
        iniciarTimer();
    } else {
        openStartFocusModal();
    }
}

function toggleTelaAtiva() {
    manterTelaAtiva = !manterTelaAtiva;
    StorageSeguro.set('manterTelaAtiva', manterTelaAtiva);
    
    const btn = document.getElementById('btnTelaAtiva');
    btn.classList.toggle('on', manterTelaAtiva);
    
    if (!manterTelaAtiva && wakeLock) {
        gerenciarTelaAtiva(false);
    }
}

function solicitarPermissaoNotificacao() {
    if ('Notification' in window) {
        if (Notification.permission === 'default') {
            Notification.requestPermission().then(function(permission) {
                console.log('Permiss√£o de notifica√ß√£o:', permission);
            });
        }
    }
}

function enviarNotificacaoPlantaCresceu() {
    if ('Notification' in window && Notification.permission === 'granted') {
        try {
            const notificacao = new Notification('üå± Garden Focus', {
                body: 'Sua planta cresceu! Parab√©ns pela sess√£o de foco! üéâ',
                icon: 'https://www.iconpacks.net/icons/2/free-tree-icon-1578-thumb.png',
                tag: 'planta-cresceu',
                requireInteraction: true,
                silent: false
            });
            
            notificacao.onclick = function() {
                window.focus();
                notificacao.close();
            };
        } catch (e) {
            if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                navigator.serviceWorker.ready.then(function(registration) {
                    registration.showNotification('üå± Garden Focus', {
                        body: 'Sua planta cresceu! Parab√©ns pela sess√£o de foco! üéâ',
                        icon: 'https://www.iconpacks.net/icons/2/free-tree-icon-1578-thumb.png',
                        tag: 'planta-cresceu',
                        requireInteraction: true
                    });
                });
            }
          }
    }
}

    function toggleNatal() { 
    modoNatal = !modoNatal; 
    if(modoNatal) {
        modoMedieval = false;
        modoCandyfornia = false;
    }
    StorageSeguro.set('modoNatal', modoNatal); 
    StorageSeguro.set('modoMedieval', modoMedieval);
    StorageSeguro.set('modoCandyfornia', modoCandyfornia);
    criarParticulas(); 
    applyNatalUI(); 
    applyMedievalUI(); 
    applyCandyforniaUI();
    escolhido = (modoNatal ? ITENS_NATAL : (modoCandyfornia ? ITENS_CANDYFORNIA : (modoMedieval ? ITENS_MEDIEVAL : ITENS_PADRAO)))[0]; 
    setLuckyPlant(); 
    const btn = document.getElementById('btnNatal');
    if (btn) btn.classList.toggle('on', modoNatal);
}

function toggleMedieval() {
    modoMedieval = !modoMedieval;
    if(modoMedieval) modoNatal = false;
    StorageSeguro.set('modoMedieval', modoMedieval);
    StorageSeguro.set('modoNatal', modoNatal);
    criarParticulas(); applyMedievalUI(); applyNatalUI();
    escolhido = (modoMedieval ? ITENS_MEDIEVAL : (modoNatal ? ITENS_NATAL : ITENS_PADRAO))[0];
    setLuckyPlant(); 
    const btn = document.getElementById('btnMedievalConfig');
    btn.classList.toggle('on', modoMedieval);
}

function toggleCandyfornia() {
    // Verificar se foi comprado - n√£o faz nada se n√£o comprado (j√° est√° desabilitado)
    if (!candyforniaComprado) {
        return;
    }
    
    modoCandyfornia = !modoCandyfornia;
    if(modoCandyfornia) {
        modoNatal = false;
        modoMedieval = false;
    }
    StorageSeguro.set('modoCandyfornia', modoCandyfornia);
    StorageSeguro.set('modoNatal', modoNatal);
    StorageSeguro.set('modoMedieval', modoMedieval);
    criarParticulas();
    applyCandyforniaUI();
    applyNatalUI();
    applyMedievalUI();
    escolhido = (modoCandyfornia ? ITENS_CANDYFORNIA : (modoNatal ? ITENS_NATAL : (modoMedieval ? ITENS_MEDIEVAL : ITENS_PADRAO)))[0];
    setLuckyPlant();
    const btn = document.getElementById('btnCandyforniaConfig');
    if (btn) btn.classList.toggle('on', modoCandyfornia);
}

function applyCandyforniaUI() {
    if(modoCandyfornia) {
        document.body.classList.add('candyfornia-mode');
    } else {
        document.body.classList.remove('candyfornia-mode');
    }
}

function applyNatalUI() { 
    if(modoNatal) { document.body.classList.add('natal-mode'); } 
    else { document.body.classList.remove('natal-mode'); } 
}

function applyMedievalUI() {
    if(modoMedieval) { document.body.classList.add('medieval-mode'); }
    else { document.body.classList.remove('medieval-mode'); }
}

function toggleDarkMode() { 
    // 1. Ao clicar no bot√£o manual, DESATIVAMOS o modo autom√°tico obrigatoriamente
    temaAutomaticoAtivo = false;
    StorageSeguro.set('temaAutoAtivo', false);
    
    // 2. Atualiza o visual do bot√£o switch do "Auto Tema" para desligado
    const btnTemaAuto = document.getElementById('btnTemaAuto');
    if (btnTemaAuto) {
        btnTemaAuto.classList.remove('on');
    }
    
    // 3. Alterna a classe no corpo do site
    const isDark = document.body.classList.toggle('dark-mode');
    
    // 4. Salva a prefer√™ncia do usu√°rio (true ou false)
    StorageSeguro.set('darkMode', isDark);
    
    // 5. Ajustes visuais extras
    renderEstrelasNoCeu();
    
    // 6. Atualiza o texto do bot√£o principal
    const btnTema = document.getElementById('btnTema');
    if (btnTema) {
        if (isDark) {
            btnTema.textContent = '‚òÄÔ∏è Tema';
            btnTema.title = 'Alternar para modo claro';
        } else {
            btnTema.textContent = 'üåì Tema';
            btnTema.title = 'Alternar para modo escuro';
        }
    }
}

function toggleTemaAuto() {
    const btn = document.getElementById('btnTemaAuto');
    
    // 1. Inverte o valor atual
    temaAutomaticoAtivo = !temaAutomaticoAtivo;
    
    // 2. Salva o novo valor
    StorageSeguro.set('temaAutoAtivo', temaAutomaticoAtivo);
    
    // 3. Atualiza o visual do bot√£o switch
    if (btn) btn.classList.toggle('on', temaAutomaticoAtivo);
    
    if (temaAutomaticoAtivo) {
        // Se ativou, roda a verifica√ß√£o de hora imediatamente
        verificarTemaAutomatico();
        
        // Exibe um feedback visual r√°pido
        showModal({ 
            text: "üïí Modo Autom√°tico Ativado!<br><br>O tema mudar√° sozinho:<br>‚òÄÔ∏è Claro: 06:00 - 18:00<br>üåô Escuro: 18:00 - 06:00", 
            onConfirm: () => {} 
        });
    }
}


function toggleMenu() { document.getElementById('abaEsquerda').classList.toggle('aberto'); }

function fecharMenuSeAberto(event) {
    const menu = document.getElementById('abaEsquerda');
    const menuBtn = document.getElementById('abrirMenuBtn');
    if (menu.classList.contains('aberto') && !menu.contains(event.target) && event.target !== menuBtn) {
        menu.classList.remove('aberto');
    }
}

function renderJardim2D() {
    const c = document.getElementById('jardim');
    c.innerHTML = '';
    
    const gridSize = getGridSize();
    const cellSize = grid10x10 ? 35 : 55;
    const fontSize = grid10x10 ? 18 : 28;
    
   
    jardimData.forEach((item, i) => {
        let d = document.createElement('div');
        d.className = 'plot' + (i === alvo ? ' alvo' : '');
        d.style.width = `${cellSize}px`;
        d.style.height = `${cellSize}px`;
        d.style.fontSize = `${fontSize}px`;
        
        if (grid10x10) {
            d.style.borderRadius = '8px';
        }
        
        let temFantasma = false;
        
        if (intervalo && i !== alvo) {
            d.style.pointerEvents = 'none';
            d.style.opacity = '0.7';
        } else {
            d.style.pointerEvents = 'auto';
            d.style.opacity = '1';
        }
        
        if(item) {
            let span = document.createElement('span');
            span.textContent = item.icone;
            
            if (item.emProgresso) {
                span.className = 'plant-spawn';
                span.style.animation = 'pulsar 1.5s infinite';
            } else {
                span.className = 'plant-spawn' + (item.lucky ? ' lucky-glow' : '');
            }
            
            d.appendChild(span);
        } else if (i === alvo && escolhido && !intervalo) {
            let span = document.createElement('span');
            span.textContent = escolhido;
            span.classList.add('plot-emoji-fantasma');
            d.appendChild(span);
            temFantasma = true;
        }
        
        d.onclick = () => {
            if(intervalo) return;
            
            if(item) {
                document.getElementById('painelMotivo').style.display = 'block';
                document.getElementById('textoMotivo').textContent = `Focado em: ${item.motivo}`;
            } else {
                abrirModalPlanta(i);
            }
        };
        c.appendChild(d);
    });
}

function renderJardim() {
    if (modo3D) {
        renderJardim3D();
    } else {
        renderJardim2D();
    }
}

function abrirModalPlanta(index) {
    alvo = index;
    renderJardim();
    const p = document.getElementById('paletaModal');
    const pe = document.getElementById('paletaEspecialModal');
    
    p.innerHTML = ''; pe.innerHTML = '';
    
    ITENS_PADRAO.forEach(i => { 
        let d = document.createElement('div'); d.className = 'item' + (i === escolhido ? ' selecionado' : ''); 
        d.textContent = i; 
d.onclick = () => { 
	            escolhido = i; 
	            StorageSeguro.set('plantaEscolhida', escolhido); // Salvar planta selecionada
	            fecharModal('modalPlantaOverlay'); 
	            renderJardim(); 
	            atualizarBotoes();
	        }; 
        p.appendChild(d); 
    }); 

    const especialPool = modoCandyfornia ? ITENS_CANDYFORNIA : (modoNatal ? ITENS_NATAL : (modoMedieval ? ITENS_MEDIEVAL : []));
    if(especialPool.length === 0) {
        pe.innerHTML = '<small style="opacity:0.5; padding:15px;">Nenhum modo especial ativo.</small>';
    } else {
        especialPool.forEach(i => {
            let d = document.createElement('div'); d.className = 'item' + (i === escolhido ? ' selecionado' : ''); 
            d.textContent = i; 
d.onclick = () => {
	            escolhido = i; 
	            StorageSeguro.set('plantaEscolhida', escolhido); // Salvar planta selecionada
	            fecharModal('modalPlantaOverlay'); 
	            renderJardim(); 
	            atualizarBotoes();
	        };
            pe.appendChild(d);
        });
    }
    
    abrirModal('modalPlantaOverlay');
}

function salvarTudo() { 
    StorageSeguro.set('jardim', jardimData); 
    StorageSeguro.set('sessoesTotais', sessoesTotais); 
    StorageSeguro.set('historico_foco', historico); 
    StorageSeguro.set('modo3D', modo3D);
    renderJardim();
}

function renderSelects() { 
	    const st = document.getElementById('tempoEscolhido'), sm = document.getElementById('motivoEscolhido'); 
	    
	    // 1. Carregar valores salvos
	    const savedTempo = StorageSeguro.get('ultimoTempo', null);
	    const savedMotivo = StorageSeguro.get('ultimoMotivo', null);
	    
	    st.innerHTML = ''; 
	    tempos.sort((a,b)=>a-b).forEach(t => st.add(new Option(t + " min", t))); 
	    sm.innerHTML = ''; motivos.forEach(m => sm.add(new Option(m, m))); 
	    
	    // 2. Aplicar valores salvos ou o primeiro da lista
	    if(savedTempo) st.value = savedTempo; 
	    if(savedMotivo) sm.value = savedMotivo; 
	    
	    // 3. Adicionar listeners para salvar ao mudar
	    st.onchange = () => StorageSeguro.set('ultimoTempo', st.value);
	    sm.onchange = () => StorageSeguro.set('ultimoMotivo', sm.value);
	    
	    atualizarTimerDisplay(); 
	}

function toggleTodoPopup() {
	    const popup = document.getElementById('todoPopup');
	    const btn = document.getElementById('btnTodoToggle');
	    const isAtivo = popup.classList.toggle('ativo');
	    btn.classList.toggle('ativo');
	    
	    // Salvar estado no localStorage
	    StorageSeguro.set('todoPopupAtivo', isAtivo);
	}

function renderTodos() { 
    const l = document.getElementById('listaTodo'); 
    if (!l) return;
    l.innerHTML = ''; 
    todos.forEach((t, i) => { 
        let d = document.createElement('div'); d.className = 'todo-item'; 
        d.innerHTML = `<input type="checkbox" ${t.done?'checked':''} onchange="todos[${i}].done=!todos[${i}].done; StorageSeguro.set('todos', todos); renderTodos()"> <span style="${t.done ? 'text-decoration: line-through; opacity: 0.6;' : ''}">${t.texto}</span> <button onclick="todos.splice(${i},1); StorageSeguro.set('todos', todos); renderTodos()">√ó</button>`; 
        l.appendChild(d); 
    }); 
}

function addTodo() { let i = document.getElementById('novoTodo'); if(i.value.trim()){ todos.push({texto:i.value, done:false}); i.value=''; renderTodos(); } }

function abrirConfig() { 
    // Garantir que os bot√µes estejam atualizados
    setTimeout(() => {
        atualizarBotoesConfig();
    }, 50);
    
    
    
    abrirModal('configOverlay'); 
}
// =========================
// SISTEMA DE METAS
// =========================
function toggleMetas() {
    const container = document.getElementById('metasContainer');
    const btn = document.getElementById('btnMetasToggle');
    const isAtivo = container.classList.toggle('ativo');
    btn.classList.toggle('ativo', isAtivo);
    StorageSeguro.set('metasPopupAtivo', isAtivo);
    
    if (isAtivo) {
        preencherSelectsMetas();
    }
}

function preencherSelectsMetas() {
    const selectMotivo = document.getElementById('metaMotivo');
    const selectTempo = document.getElementById('metaTempo');
    
    selectMotivo.innerHTML = '';
    selectTempo.innerHTML = '';
    
    motivos.forEach(motivo => {
        const option = document.createElement('option');
        option.value = motivo;
        option.textContent = motivo;
        selectMotivo.appendChild(option);
    });
    
    tempos.sort((a,b) => a-b).forEach(tempo => {
        const option = document.createElement('option');
        option.value = tempo;
        option.textContent = `${tempo} min`;
        selectTempo.appendChild(option);
    });
    
    if (motivos.length > 0) selectMotivo.value = motivos[0];
    if (tempos.length > 0) selectTempo.value = tempos[0];
}

function adicionarMeta() {
    const motivo = document.getElementById('metaMotivo').value;
    const tempo = document.getElementById('metaTempo').value;
    
    if (!motivo || !tempo) {
        showModal({ text: "Selecione um motivo e um tempo para criar uma meta.", onConfirm: () => {} });
        return;
    }
    
    const novaMeta = {
        id: Date.now(),
        motivo: motivo,
        tempo: parseInt(tempo),
        concluida: false,
        totalSessoes: 1,
        sessoesConcluidas: 0,
        dataCriacao: new Date().toISOString()
    };
    
    metas.push(novaMeta);
    StorageSeguro.set('metas', metas);
    renderMetas();
}

function renderMetas() {
    const container = document.getElementById('listaMetas');
    container.innerHTML = '';
    
    if (metas.length === 0) {
        container.innerHTML = '<div style="padding: 10px; text-align: center; color: var(--text-secondary); font-size: 11px;">Nenhuma meta definida ainda.</div>';
        return;
    }
    
    metas.forEach((meta, index) => {
        const metaElement = document.createElement('div');
        metaElement.className = 'todo-item';
        metaElement.style.borderLeft = `4px solid ${meta.concluida ? '#4caf50' : '#ff9800'}`;
        
        const progressoPercent = meta.totalSessoes > 0 ? Math.round((meta.sessoesConcluidas / meta.totalSessoes) * 100) : 0;
        
        metaElement.innerHTML = `
            <div style="flex: 1;">
                <div style="font-size: 11px; font-weight: bold; color: ${meta.concluida ? '#4caf50' : 'var(--text-main)'};">
                    ${meta.motivo} - ${meta.tempo} min
                </div>
                <div style="font-size: 10px; color: var(--text-secondary); margin-top: 2px;">
                    ${meta.sessoesConcluidas}/${meta.totalSessoes} sess√µes conclu√≠das
                </div>
                ${meta.totalSessoes > 0 ? `
                    <div style="margin-top: 3px; height: 4px; background: var(--bg-body); border-radius: 2px; overflow: hidden;">
                        <div style="height: 100%; width: ${progressoPercent}%; background: ${meta.concluida ? '#4caf50' : '#ff9800'};"></div>
                    </div>
                ` : ''}
            </div>
            <div style="display: flex; gap: 5px;">
                <button onclick="concluirMeta(${index})" style="min-width: 24px; min-height: 24px; padding: 0; background: ${meta.concluida ? '#4caf50' : '#666'}; font-size: 10px; border-radius: 6px;">‚úì</button>
                <button onclick="removerMeta(${index})" style="min-width: 24px; min-height: 24px; padding: 0; background: #ff5252; font-size: 10px; border-radius: 6px;">√ó</button>
            </div>
        `;
        
        container.appendChild(metaElement);
    });
}

function concluirMeta(index) {
    metas[index].concluida = !metas[index].concluida;
    StorageSeguro.set('metas', metas);
    renderMetas();
}

function removerMeta(index) {
    showModal({
        text: "Tem certeza que deseja excluir esta meta?",
        onConfirm: () => {
            metas.splice(index, 1);
            StorageSeguro.set('metas', metas);
            renderMetas();
        }
    });
}

function verificarMetasConcluidas(motivo, tempo) {
    metas.forEach((meta, index) => {
        if (!meta.concluida && meta.motivo === motivo && meta.tempo === tempo) {
            metas[index].sessoesConcluidas += 1;
            
            if (metas[index].sessoesConcluidas >= metas[index].totalSessoes) {
                metas[index].concluida = true;
                showModal({
                    text: `üéâ Meta conclu√≠da!<br><br>Voc√™ completou ${meta.totalSessoes} sess√£o(√µes) de ${motivo} por ${tempo} minutos!`,
                    onConfirm: () => {}
                });
            }
            
            StorageSeguro.set('metas', metas);
            renderMetas();
        }
    });
}

function melhorarAcessibilidade() {
    const botoes = document.querySelectorAll('button:not([aria-label])');
    botoes.forEach(botao => {
        const texto = botao.textContent || botao.innerHTML;
        if (texto.trim() && !botao.getAttribute('aria-label')) {
            botao.setAttribute('aria-label', texto.replace(/[^a-zA-Z√Ä-√ø0-9\s]/g, ' ').trim());
        }
    });
    
    document.getElementById('abrirMenuBtn').setAttribute('aria-label', 'Abrir menu');
    document.getElementById('btnTema').setAttribute('aria-label', 'Alternar tema claro/escuro');
    
    document.querySelectorAll('.plot').forEach((plot, i) => {
        if (!plot.getAttribute('aria-label')) {
            const item = jardimData[i];
            if (item) {
                plot.setAttribute('aria-label', `Planta: ${item.icone}, Motivo: ${item.motivo}`);
            } else {
                plot.setAttribute('aria-label', `Espa√ßo vazio ${i+1}, clique para plantar`);
            }
        }
    });
}

function atualizarBotoesConfig() {
    const btnSino = document.getElementById('btnSino');
    if (btnSino) {
        btnSino.classList.toggle('on', sinoAtivo);
    }

    const btnTemaAuto = document.getElementById('btnTemaAuto');
    if (btnTemaAuto) {
        btnTemaAuto.classList.toggle('on', temaAutomaticoAtivo);
    }

    const btnNatal = document.getElementById('btnNatal');
    if (btnNatal) {
        btnNatal.classList.toggle('on', modoNatal);
    }

    const btnMedieval = document.getElementById('btnMedievalConfig');
    if (btnMedieval) {
        btnMedieval.classList.toggle('on', modoMedieval);
        
        // Limpar mensagem anterior se existir
        const medievalCard = btnMedieval.closest('.config-card');
        if (medievalCard) {
            const mensagemExistente = medievalCard.querySelector('.msg-disponivel');
            if (mensagemExistente) {
                mensagemExistente.remove();
            }
        }
        
        // Se n√£o comprado, adicionar mensagem UMA VEZ
        if (!medievalComprado) {
            btnMedieval.style.opacity = '0.5';
            btnMedieval.style.pointerEvents = 'none';
            btnMedieval.style.cursor = 'not-allowed';
            
            const medievalCard = btnMedieval.closest('.config-card');
            if (medievalCard && !medievalCard.querySelector('.msg-disponivel')) {
                const msg = document.createElement('div');
                msg.className = 'msg-disponivel';
                msg.style.cssText = 'color: var(--text-secondary); font-size: 11px; text-align: center; padding: 5px; line-height: 1.3; margin-top: 5px;';
                msg.innerHTML = 'Dispon√≠vel na Loja<br><small>100 moedas</small>';
                
                const container = medievalCard.querySelector('.ios-switch-container');
                if (container) {
                    container.appendChild(msg);
                }
            }
        } else {
            btnMedieval.style.opacity = '1';
            btnMedieval.style.pointerEvents = 'auto';
            btnMedieval.style.cursor = 'pointer';
        }
    }

    const btnCandyfornia = document.getElementById('btnCandyforniaConfig');
    if (btnCandyfornia) {
        btnCandyfornia.classList.toggle('on', modoCandyfornia);
        
        // Limpar mensagem anterior se existir
        const candyCard = btnCandyfornia.closest('.config-card');
        if (candyCard) {
            const mensagemExistente = candyCard.querySelector('.msg-disponivel');
            if (mensagemExistente) {
                mensagemExistente.remove();
            }
        }
        
        // Se n√£o comprado, adicionar mensagem UMA VEZ
        if (!candyforniaComprado) {
            btnCandyfornia.style.opacity = '0.5';
            btnCandyfornia.style.pointerEvents = 'none';
            btnCandyfornia.style.cursor = 'not-allowed';
            
            const candyCard = btnCandyfornia.closest('.config-card');
            if (candyCard && !candyCard.querySelector('.msg-disponivel')) {
                const msg = document.createElement('div');
                msg.className = 'msg-disponivel';
                msg.style.cssText = 'color: var(--text-secondary); font-size: 11px; text-align: center; padding: 5px; line-height: 1.3; margin-top: 5px;';
                msg.innerHTML = 'Dispon√≠vel na Loja<br><small>150 moedas</small>';
                
                const container = candyCard.querySelector('.ios-switch-container');
                if (container) {
                    container.appendChild(msg);
                }
            }
        } else {
            btnCandyfornia.style.opacity = '1';
            btnCandyfornia.style.pointerEvents = 'auto';
            btnCandyfornia.style.cursor = 'pointer';
        }
    }

    const btnEstrelas = document.getElementById('btnEstrelas');
    if (btnEstrelas) {
        btnEstrelas.classList.toggle('on', exibirEstrelas);
    }

    const btnAnimFundo = document.getElementById('btnAnimFundo');
    if (btnAnimFundo) {
        btnAnimFundo.classList.toggle('on', animacaoFundoAtiva);
    }

    const btnPrevisao = document.getElementById('btnPrevisao');
    if (btnPrevisao) {
        btnPrevisao.classList.toggle('on', mostrarPrevisao);
    }

    // Atualizar os bot√µes da se√ß√£o Visualiza√ß√£o
    const btn3D = document.getElementById('btn3DToggle');
    if (btn3D) {
        btn3D.classList.toggle('on', modo3D);
    }

    const btnGrid10x10 = document.getElementById('btnGrid10x10Toggle');
    if (btnGrid10x10) {
        btnGrid10x10.classList.toggle('on', grid10x10);
    }
}
function init() { 
    const vistoPrimeiroUso = StorageSeguro.get('vistoPrimeiroUso', false);
    let nome = StorageSeguro.get('jogadorNome');
    
    // 1. Primeiro Uso
    if (!vistoPrimeiroUso) {
        setTimeout(() => { mostrarPrimeiroUso(); }, 500);
        return;
    }
    
    verificarPrimeiroAcesso();
    
    // 2. Nome do Jogador
    if(!nome) {
        showModal({
            text: "Bem-vindo ao Garden Focus! üå±\n\nQual √© o seu nome?",
            showInput: true,
            onConfirm: (nomeDigitado) => {
                if(nomeDigitado && nomeDigitado.trim()) {
                    StorageSeguro.set('jogadorNome', nomeDigitado.trim());
                    location.reload();
                }
            }
        });
        return;
    }
    
    // 3. Configura√ß√µes Iniciais de Interface
    const btnTelaAtiva = document.getElementById('btnTelaAtiva');
    if (btnTelaAtiva) btnTelaAtiva.classList.toggle('on', manterTelaAtiva);
    
    document.getElementById('saudacaoUsuario').innerHTML = `Ol√°, ${nome}!`;
    carregarFotoPerfil();
    
    // ============================================================
    // L√ìGICA DE TEMA CORRIGIDA
    // ============================================================
    // L√™ as vari√°veis globais j√° carregadas (agora usando .get corretamente)
    const btnTema = document.getElementById('btnTema');

    // For√ßa a leitura do storage para garantir (caso as vari√°veis globais tenham falhado)
    const darkModeSalvo = StorageSeguro.get('darkMode', false);
    
    if (temaAutomaticoAtivo) {
        // Se auto est√° ligado, verifica a hora
        verificarTemaAutomatico();
    } else {
        // Se auto est√° desligado, usa a prefer√™ncia manual
        // Verifica se √© true booleano ou string "true" para compatibilidade
        const deveSerEscuro = (darkModeSalvo === true || darkModeSalvo === 'true');

        if (deveSerEscuro) {
            document.body.classList.add('dark-mode');
            if(btnTema) {
                btnTema.textContent = '‚òÄÔ∏è Tema';
                btnTema.title = 'Alternar para modo claro';
            }
        } else {
            document.body.classList.remove('dark-mode');
            if(btnTema) {
                btnTema.textContent = 'üåì Tema';
                btnTema.title = 'Alternar para modo escuro';
            }
        }
    }
    atualizarBotoesConfig();
    // ============================================================

    // Restante das inicializa√ß√µes
    document.getElementById('userMoedas').textContent = totalMoedas;
    atualizarVisibilidadeModo3D();
    particulasManager.iniciar();
    audioManager.init();
    
    applyNatalUI(); 
    applyMedievalUI(); 
    applyCandyforniaUI();
    setLuckyPlant(); 
    renderSelects(); 
    renderJardim(); 
    renderTodos(); 
    
    // Bot√µes de Modos (Medieval/Candyfornia)
    setTimeout(() => {
        const btnMedieval = document.getElementById('btnMedievalConfig');
        const btnCandy = document.getElementById('btnCandyforniaConfig');
        
        if (btnMedieval) {
            if (!medievalComprado) {
                btnMedieval.style.opacity = '0.5';
                btnMedieval.style.pointerEvents = 'none';
                btnMedieval.style.cursor = 'not-allowed';
            } else {
                btnMedieval.style.opacity = '1';
                btnMedieval.style.pointerEvents = 'auto';
                btnMedieval.style.cursor = 'pointer';
            }
        }
        if (btnCandy) {
            if (!candyforniaComprado) {
                btnCandy.style.opacity = '0.5';
                btnCandy.style.pointerEvents = 'none';
                btnCandy.style.cursor = 'not-allowed';
            } else {
                btnCandy.style.opacity = '1';
                btnCandy.style.pointerEvents = 'auto';
                btnCandy.style.cursor = 'pointer';
            }
        }
    }, 200);
    
    // Popups e Containers
    const todoPopupAtivo = StorageSeguro.get('todoPopupAtivo', false);
    if (todoPopupAtivo) {
        document.getElementById('todoPopup').classList.add('ativo');
        document.getElementById('btnTodoToggle').classList.add('ativo');
    }
    
    renderEstante(); 
    renderEstrelasNoCeu(); 
    setupEstrelasClick();
    renderMetas();
    
    const metasPopupAtivo = StorageSeguro.get('metasPopupAtivo', false);
    if (metasPopupAtivo) {
        document.getElementById('metasContainer').classList.add('ativo');
        document.getElementById('btnMetasToggle').classList.add('ativo');
        preencherSelectsMetas();
    }
    
    calcularPrevisao();
    atualizarStreak();
    atualizarBotoes();
    recriarTimerSeExistir();
    melhorarAcessibilidade();
    
    const tutorialVisto = StorageSeguro.get('tutorialVisto', false);
    if (!tutorialVisto) {
        setTimeout(() => { iniciarTutorial(); }, 800);
    }
    
    window.addEventListener('resize', () => {
        if (modo3D) ajustarTamanho3D();
    });
    
    setTimeout(() => {
        if (modo3D) ajustarTamanho3D();
    }, 500);
}


function showModal({ text, showInput = false, onConfirm, altText = null, confirmText = "Ok!" }) { 
    const overlay = document.getElementById('customAlertOverlay'); const input = document.getElementById('customAlertInput'); 
    const cancelBtn = document.getElementById('alertCancelBtn'); const altBtn = document.getElementById('alertAltBtn');
    const mainBtn = document.getElementById('alertConfirmBtn');
    document.getElementById('customAlertText').innerHTML = text; 
    input.style.display = showInput ? 'block' : 'none'; mainBtn.textContent = confirmText;
    if (altText) { altBtn.style.display = 'block'; altBtn.textContent = altText; altBtn.onclick = () => { fecharModal('customAlertOverlay'); onConfirm(altText); }; cancelBtn.style.display = 'none'; } 
    else { altBtn.style.display = 'none'; cancelBtn.style.display = (text.includes("?") || showInput) ? 'block' : 'none'; }
    abrirModal('customAlertOverlay'); 
    mainBtn.onclick = () => { fecharModal('customAlertOverlay'); onConfirm(altText ? confirmText : input.value); }; 
    cancelBtn.onclick = () => fecharModal('customAlertOverlay'); 
}

function promptCustom(msg, size, cb) { showModal({ text: msg, showInput: true, onConfirm: (v) => { if(v.trim()){ cb(typeof size === 'boolean' && size === true ? parseInt(v) : v.trim()); }} }); }
function addTempo(v) { tempos.push(v); StorageSeguro.set('tempos', tempos); renderSelects(); }
function addMotivo(v) { motivos.push(v); StorageSeguro.set('motivos', motivos); renderSelects(); }

function carregarFotoPerfil() {
    const fotoSalva = StorageSeguro.get('profilePhoto', null);
    if (fotoSalva) {
        const imgElement = document.getElementById('profilePhoto');
        const placeholder = document.getElementById('profilePhotoPlaceholder');
        imgElement.src = fotoSalva;
        imgElement.style.display = 'block';
        placeholder.style.display = 'none';
    }
}

document.getElementById('profilePhotoInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file && file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(event) {
            const imgElement = document.getElementById('profilePhoto');
            const placeholder = document.getElementById('profilePhotoPlaceholder');
            imgElement.src = event.target.result;
            imgElement.style.display = 'block';
            placeholder.style.display = 'none';
            StorageSeguro.set('profilePhoto', event.target.result);
        };
        reader.readAsDataURL(file);
    }
});

function confirmarExclusaoTempo() {
    let v = parseInt(document.getElementById('tempoEscolhido').value);
    showModal({
        text: `Deseja excluir o tempo de ${v} min?`,
        onConfirm: () => {
            if(tempos.length > 1) { 
                tempos = tempos.filter(t=>t!==v); 
                StorageSeguro.set('tempos', tempos); 
                renderSelects(); 
            }
        }
    });
}

function confirmarExclusaoMotivo() {
    let v = document.getElementById('motivoEscolhido').value;
    showModal({
        text: `Deseja excluir o motivo "${v}"?`,
        onConfirm: () => {
            if(motivos.length > 1) { 
                motivos = motivos.filter(m=>m!==v); 
                StorageSeguro.set('motivos', motivos); 
                renderSelects(); 
            }
        }
    });
}

function toggleSino() {
    const btn = document.getElementById('btnSino');
    sinoAtivo = !sinoAtivo;
    StorageSeguro.set('sinoAtivo', sinoAtivo);
    
    btn.classList.toggle('on', sinoAtivo);
}



function togglePrevisao() {
    const btn = document.getElementById('btnPrevisao');
    mostrarPrevisao = !mostrarPrevisao;
    StorageSeguro.set('mostrarPrevisao', mostrarPrevisao);
    
    btn.classList.toggle('on', mostrarPrevisao);
    
    calcularPrevisao();
}

function verificarTemaAutomatico() {
    // S√ì aplicar se modo autom√°tico estiver ATIVADO
    if (!temaAutomaticoAtivo) {
        console.log("Modo autom√°tico DESATIVADO, n√£o alterando tema");
        return;
    }
    
    const agora = new Date();
    const hora = agora.getHours();
    const isNoite = hora >= 18 || hora < 6;
    
    console.log("Verificando tema autom√°tico. Hora:", hora, "√â noite?", isNoite);
    
    if (isNoite) {
        // Aplicar tema escuro
        document.body.classList.add('dark-mode');
        StorageSeguro.set('darkMode', 'true');
        console.log("Aplicando tema escuro (autom√°tico - noite)");
    } else {
        // Aplicar tema claro
        document.body.classList.remove('dark-mode');
        StorageSeguro.set('darkMode', 'false');
        console.log("Aplicando tema claro (autom√°tico - dia)");
    }
    
    renderEstrelasNoCeu();
}

document.getElementById('tempoEscolhido').addEventListener('change', () => { if(!intervalo) { atualizarTimerDisplay(); calcularPrevisao(); } });
document.getElementById('motivoEscolhido').addEventListener('change', calcularPrevisao);

window.addEventListener('beforeunload', () => {
    if (intervalo) {
        // Salvar o estado atual do timer antes de sair
        salvarTimerAtivo();
        clearInterval(intervalo);
        intervalo = null;
    }
    audioManager.parar();
    efeitosManager.limparTodos();
    particulasManager.parar();
});

init();

// Por esta NOVA:
// Verificar tema autom√°tico periodicamente (a cada minuto)
setInterval(() => {
    if (temaAutomaticoAtivo) {
        verificarTemaAutomatico();
    }
}, 60000);

if ('serviceWorker' in navigator) {
window.addEventListener('load', () => {
navigator.serviceWorker.register('sw.js')
.then(reg => console.log('Service Worker registado com sucesso!'))
.catch(err => console.log('Erro ao registar Service Worker:', err));
});
}
async function gerenciarTelaAtiva(ativar) {
    if (!('wakeLock' in navigator)) {
        console.log("API Wake Lock n√£o suportada neste navegador");
        return;
    }
    
    try {
        if (ativar) {
            if (wakeLock) return; // J√° est√° ativo
            
            wakeLock = await navigator.wakeLock.request('screen');
            console.log("Tela bloqueada (Ativa)");
            
            // Lidar com libera√ß√£o inesperada
            wakeLock.addEventListener('release', () => {
                console.log("Wake Lock foi liberado");
                wakeLock = null;
            });
        } else if (wakeLock) {
            await wakeLock.release();
            wakeLock = null;
            console.log("Tela liberada");
        }
    } catch (err) {
        console.error(`${err.name}, ${err.message}`);
        
        // Feedback visual se houver erro
        if (err.name === 'NotAllowedError') {
            showModal({ 
                text: "Permiss√£o necess√°ria: Para manter a tela ativa durante o foco, permita que o navegador impe√ßa o bloqueio de tela.", 
                onConfirm: () => {} 
            });
        }
    }
}
// =========================
// FUN√á√ÉO BULLDOZE - REMOVER TODAS AS PLANTAS
// =========================
function bulldoze() {
    showModal({
        text: "Tem certeza que deseja remover todas as plantas do jardim?",
        onConfirm: () => {
            // Iniciar anima√ß√£o do tornado
            animarTornado().then(() => {
                // O jardimData j√° foi atualizado durante a anima√ß√£o
                alvo = null; // Apenas resetar o alvo
                salvarTudo(); // Salvar o estado vazio
                renderJardim(); // Renderizar para garantir que est√° limpo
                
                showModal({ 
                    text: "Jardim limpo! üå™<br><br>Todas as plantas e constru√ß√µes foram para al√©m do arco-√≠ris.", 
                    onConfirm: () => {} 
                });
            });
        }
    });
}

function animarTornado() {
    return new Promise((resolve) => {
        const totalCells = getTotalCells();
        let currentIndex = 0;
        
        // Fun√ß√£o para mostrar tornado em uma c√©lula e remover a planta
        function mostrarTornadoNoIndice(index) {
            // REMOVER PLANTA IMEDIATAMENTE do jardimData
            jardimData[index] = null;
            
            if (modo3D) {
                // Modo 3D
                const cells = document.querySelectorAll('.cell-3d');
                if (cells[index]) {
                    // Remover qualquer emoji existente na c√©lula
                    const existingEmoji = cells[index].querySelector('.emoji-3d');
                    if (existingEmoji) {
                        existingEmoji.remove();
                    }
                    
                    // Adicionar tornado
                    const tornado = document.createElement('span');
                    tornado.className = 'tornado-3d';
                    tornado.textContent = 'üå™';
                    cells[index].appendChild(tornado);
                    
                    // Remover ap√≥s anima√ß√£o
                    setTimeout(() => {
                        if (cells[index].contains(tornado)) {
                            cells[index].removeChild(tornado);
                        }
                    }, 500);
                }
            } else {
                // Modo 2D
                const plots = document.querySelectorAll('.plot');
                if (plots[index]) {
                    // Remover qualquer emoji existente na c√©lula
                    const existingEmoji = plots[index].querySelector('span');
                    if (existingEmoji) {
                        existingEmoji.remove();
                    }
                    
                    // Adicionar tornado
                    const tornado = document.createElement('span');
                    tornado.className = 'tornado-2d';
                    tornado.textContent = 'üå™';
                    plots[index].appendChild(tornado);
                    
                    // Remover ap√≥s anima√ß√£o
                    setTimeout(() => {
                        if (plots[index].contains(tornado)) {
                            plots[index].removeChild(tornado);
                        }
                    }, 500);
                }
            }
        }
        
        // Animar tornado passando por todas as c√©lulas
        const interval = setInterval(() => {
            if (currentIndex >= totalCells) {
                clearInterval(interval);
                setTimeout(resolve, 600); // Dar tempo para √∫ltima anima√ß√£o
                return;
            }
            
            mostrarTornadoNoIndice(currentIndex);
            currentIndex++;
        }, 50); // Velocidade do tornado (ms entre c√©lulas)
    });
}
// Verificar atualiza√ß√µes automaticamente quando a p√°gina carrega
window.addEventListener('load', () => {
    // Verifica a cada 1 hora se h√° atualiza√ß√µes
    setInterval(() => {
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.ready.then(registration => {
                registration.update();
            });
        }
    }, 3600000); // 1 hora em milissegundos
});
</script>
</body>
</html>
